# è·³èš¤å¸‚åœºè´­ä¹°åŠŸèƒ½ - åç«¯å®ç°æ€»ç»“

ç”Ÿæˆæ—¶é—´ï¼š2025å¹´1æœˆ

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. å–å®¶åŒæ„è®®ä»·API âœ… æ–°å¢

**ç«¯ç‚¹**ï¼š`POST /api/flea-market/purchase-requests/{request_id}/approve`

**åŠŸèƒ½**ï¼š
- å–å®¶å¯ä»¥ç›´æ¥åŒæ„ä¹°å®¶çš„è®®ä»·è¯·æ±‚ï¼ˆä¸éœ€è¦å†è®®ä»·ï¼‰
- åˆ›å»ºæ”¯ä»˜ä»»åŠ¡
- è¿”å›æ”¯ä»˜ä¿¡æ¯ï¼ˆç±»ä¼¼ç›´æ¥è´­ä¹°çš„å“åº”ï¼‰
- å‘é€æ¨é€é€šçŸ¥ç»™ä¹°å®¶

**å®ç°ä½ç½®**ï¼š
- `backend/app/flea_market_routes.py:1529-1800`

**å…³é”®é€»è¾‘**ï¼š
1. éªŒè¯æƒé™ï¼ˆåªæœ‰å•†å“æ‰€æœ‰è€…å¯ä»¥åŒæ„ï¼‰
2. éªŒè¯çŠ¶æ€ï¼ˆç”³è¯·å¿…é¡»æ˜¯pendingçŠ¶æ€ï¼‰
3. ç¡®å®šæœ€ç»ˆæˆäº¤ä»·ï¼ˆä½¿ç”¨ä¹°å®¶çš„è®®ä»·ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸä»·ï¼‰
4. åˆ›å»ºä»»åŠ¡ï¼ˆpending_paymentçŠ¶æ€ï¼‰
5. åˆ›å»ºPaymentIntent
6. å…³è”ä»»åŠ¡IDåˆ°å•†å“ï¼ˆä¸ç«‹å³æ›´æ–°çŠ¶æ€ä¸ºsoldï¼‰
7. æ›´æ–°ç”³è¯·çŠ¶æ€ä¸ºaccepted
8. è‡ªåŠ¨æ‹’ç»å…¶ä»–pendingçŠ¶æ€çš„ç”³è¯·
9. å‘é€æ¨é€é€šçŸ¥ç»™ä¹°å®¶

**å“åº”ç»“æ„**ï¼š
```json
{
    "success": true,
    "data": {
        "task_id": "123",
        "item_status": "reserved",
        "task_status": "pending_payment",
        "final_price": 100.00,
        "purchase_request_status": "accepted",
        "payment_intent_id": "pi_xxx",
        "client_secret": "pi_xxx_secret_xxx",
        "amount": 10000,
        "amount_display": "100.00",
        "currency": "GBP",
        "customer_id": "cus_xxx",
        "ephemeral_key_secret": "ek_xxx"
    },
    "message": "è®®ä»·å·²åŒæ„ï¼Œè¯·å®Œæˆæ”¯ä»˜ã€‚æ”¯ä»˜å®Œæˆåå•†å“å°†è‡ªåŠ¨ä¸‹æ¶ã€‚"
}
```

---

### 2. æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°ä¼˜åŒ– âœ… å·²ä¼˜åŒ–

**ä½ç½®**ï¼š`backend/app/routers.py:4615-4649`

**ä¼˜åŒ–å†…å®¹**ï¼š
1. **æ”¯æŒreservedçŠ¶æ€**ï¼šç°åœ¨æ”¯æŒ `active` å’Œ `reserved` ä¸¤ç§çŠ¶æ€çš„å•†å“æ›´æ–°
2. **ç«‹å³æäº¤**ï¼šä½¿ç”¨ `db.commit()` ç«‹å³æäº¤çŠ¶æ€æ›´æ–°ï¼Œç¡®ä¿åŠæ—¶æ€§
3. **æ¸…é™¤ç¼“å­˜**ï¼šè‡ªåŠ¨æ¸…é™¤å•†å“ç¼“å­˜ï¼ˆåˆ—è¡¨å’Œè¯¦æƒ…ï¼‰

**å…³é”®ä»£ç **ï¼š
```python
# æ›´æ–°å•†å“çŠ¶æ€ä¸º soldï¼ˆæ”¯ä»˜æˆåŠŸåï¼‰
# âš ï¸ ä¼˜åŒ–ï¼šæ”¯æŒ active æˆ– reserved çŠ¶æ€ï¼ˆreserved æ˜¯å·²å…³è”ä»»åŠ¡ä½†æœªæ”¯ä»˜çš„çŠ¶æ€ï¼‰
flea_item = db.query(FleaMarketItem).filter(
    and_(
        FleaMarketItem.id == db_item_id,
        FleaMarketItem.sold_task_id == task_id,
        FleaMarketItem.status.in_(["active", "reserved"])  # æ”¯æŒ active å’Œ reserved çŠ¶æ€
    )
).first()

if flea_item:
    flea_item.status = "sold"
    # ç¡®ä¿ sold_task_id å·²è®¾ç½®ï¼ˆåŒé‡ä¿é™©ï¼‰
    if flea_item.sold_task_id != task_id:
        flea_item.sold_task_id = task_id
    db.commit()  # ç«‹å³æäº¤ï¼Œç¡®ä¿çŠ¶æ€æ›´æ–°åŠæ—¶
    logger.info(f"âœ… [WEBHOOK] è·³èš¤å¸‚åœºå•†å“ {flea_market_item_id} æ”¯ä»˜æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°ä¸º sold (task_id: {task_id})")
    
    # æ¸…é™¤å•†å“ç¼“å­˜ï¼ˆinvalidate_item_cache ä¼šè‡ªåŠ¨æ¸…é™¤åˆ—è¡¨ç¼“å­˜å’Œè¯¦æƒ…ç¼“å­˜ï¼‰
    from app.flea_market_extensions import invalidate_item_cache
    invalidate_item_cache(flea_item.id)
    logger.info(f"âœ… [WEBHOOK] å·²æ¸…é™¤è·³èš¤å¸‚åœºå•†å“ç¼“å­˜ï¼ˆåŒ…æ‹¬åˆ—è¡¨å’Œè¯¦æƒ…ï¼‰")
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- çŠ¶æ€æ›´æ–°åœ¨webhookä¸­ç«‹å³å®Œæˆï¼ˆé€šå¸¸åœ¨1-2ç§’å†…ï¼‰
- è‡ªåŠ¨æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿å‰ç«¯è·å–æœ€æ–°çŠ¶æ€
- æ”¯æŒé‡è¯•æœºåˆ¶ï¼ˆå‰ç«¯ä¼šé‡è¯•5æ¬¡ï¼‰

---

### 3. æ¨é€é€šçŸ¥æ”¯æŒ âœ… å·²å®Œå–„

**å·²å®ç°çš„æ¨é€é€šçŸ¥ç±»å‹**ï¼š

1. **ä¹°å®¶å‘é€è®®ä»·è¯·æ±‚** â†’ é€šçŸ¥å–å®¶
   - ç±»å‹ï¼š`flea_market_purchase_request`
   - ä½ç½®ï¼š`backend/app/flea_market_extensions.py:49-110`
   - æ¨¡æ¿ï¼š`backend/app/push_notification_templates.py:194-203`

2. **å–å®¶åŒæ„è®®ä»·** â†’ é€šçŸ¥ä¹°å®¶
   - ç±»å‹ï¼š`flea_market_purchase_accepted`
   - ä½ç½®ï¼š`backend/app/flea_market_extensions.py:113-170`
   - æ¨¡æ¿ï¼š`backend/app/push_notification_templates.py:206-215`

3. **ç›´æ¥è´­ä¹°** â†’ é€šçŸ¥å–å®¶
   - ç±»å‹ï¼š`flea_market_direct_purchase`
   - ä½ç½®ï¼š`backend/app/flea_market_extensions.py:173-217`
   - æ¨¡æ¿ï¼š`backend/app/push_notification_templates.py:218-227`

4. **æ”¯ä»˜æé†’** â†’ é€šçŸ¥ä¹°å®¶ âœ… æ–°å¢
   - ç±»å‹ï¼š`flea_market_pending_payment`
   - æ¨¡æ¿ï¼š`backend/app/push_notification_templates.py:230-238`

**é€šçŸ¥æ•°æ®æ ¼å¼**ï¼š
```python
{
    "item_id": item.id,  # å•†å“ID
    "task_id": task_id   # ä»»åŠ¡IDï¼ˆå¦‚æœé€‚ç”¨ï¼‰
}
```

**å‰ç«¯å¤„ç†**ï¼š
- `flea_market_purchase_request` â†’ è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µ
- `flea_market_purchase_accepted` â†’ è·³è½¬åˆ°ä»»åŠ¡è¯¦æƒ…é¡µï¼ˆæ”¯ä»˜é¡µé¢ï¼‰
- `flea_market_direct_purchase` â†’ è·³è½¬åˆ°ä»»åŠ¡è¯¦æƒ…é¡µ
- `flea_market_pending_payment` â†’ è·³è½¬åˆ°ä»»åŠ¡è¯¦æƒ…é¡µæˆ–å•†å“è¯¦æƒ…é¡µ

---

## ğŸ“ APIç«¯ç‚¹æ¸…å•

### å·²å®ç°çš„ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| `/api/flea-market/items/{item_id}/direct-purchase` | POST | ç›´æ¥è´­ä¹° | âœ… |
| `/api/flea-market/items/{item_id}/purchase-request` | POST | åˆ›å»ºè®®ä»·è¯·æ±‚ | âœ… |
| `/api/flea-market/purchase-requests/{request_id}/approve` | POST | å–å®¶åŒæ„è®®ä»· | âœ… æ–°å¢ |
| `/api/flea-market/items/{item_id}/accept-purchase` | POST | ä¹°å®¶æ¥å—å–å®¶è®®ä»· | âœ… |
| `/api/flea-market/items/{item_id}/counter-offer` | POST | å–å®¶è®®ä»· | âœ… |
| `/api/flea-market/items/{item_id}/reject-purchase` | POST | æ‹’ç»è´­ä¹°ç”³è¯· | âœ… |
| `/api/flea-market/items/{item_id}` | GET | è·å–å•†å“è¯¦æƒ… | âœ… |

---

## ğŸ” å®ç°ç»†èŠ‚

### 1. å–å®¶åŒæ„è®®ä»·APIå®ç°

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ”¯æŒæ ¼å¼åŒ–IDå’Œæ•°å­—IDï¼ˆè‡ªåŠ¨è§£æï¼‰
- âœ… ä½¿ç”¨FOR UPDATEé”é˜²æ­¢å¹¶å‘
- âœ… éªŒè¯æƒé™å’ŒçŠ¶æ€
- âœ… åˆ›å»ºæ”¯ä»˜ä»»åŠ¡å’ŒPaymentIntent
- âœ… è‡ªåŠ¨æ‹’ç»å…¶ä»–pendingçŠ¶æ€çš„ç”³è¯·
- âœ… å‘é€æ¨é€é€šçŸ¥

**é”™è¯¯å¤„ç†**ï¼š
- æ— æ•ˆçš„è¯·æ±‚IDæ ¼å¼
- è´­ä¹°ç”³è¯·ä¸å­˜åœ¨
- å•†å“ä¸å­˜åœ¨
- æ— æƒé™æ“ä½œ
- ç”³è¯·å·²è¢«å¤„ç†
- å•†å“å·²å”®å‡ºæˆ–å·²ä¸‹æ¶
- å–å®¶æ²¡æœ‰Stripe Connectè´¦æˆ·
- åˆ›å»ºPaymentIntentå¤±è´¥

---

### 2. æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°

**ä¼˜åŒ–ç‚¹**ï¼š
1. **æ”¯æŒreservedçŠ¶æ€**ï¼šå•†å“åœ¨å…³è”ä»»åŠ¡åå¯èƒ½å¤„äºreservedçŠ¶æ€
2. **ç«‹å³æäº¤**ï¼šä½¿ç”¨ `db.commit()` ç«‹å³æäº¤ï¼Œç¡®ä¿çŠ¶æ€æ›´æ–°åŠæ—¶
3. **æ¸…é™¤ç¼“å­˜**ï¼šè‡ªåŠ¨æ¸…é™¤å•†å“ç¼“å­˜ï¼Œç¡®ä¿å‰ç«¯è·å–æœ€æ–°çŠ¶æ€
4. **é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**æ€§èƒ½**ï¼š
- çŠ¶æ€æ›´æ–°é€šå¸¸åœ¨1-2ç§’å†…å®Œæˆ
- å‰ç«¯ä¼šé‡è¯•5æ¬¡ï¼Œç¡®ä¿çŠ¶æ€æ­£ç¡®æ›´æ–°

---

### 3. æ¨é€é€šçŸ¥å®ç°

**é€šçŸ¥ç±»å‹**ï¼š
- âœ… `flea_market_purchase_request` - ä¹°å®¶å‘é€è®®ä»·è¯·æ±‚
- âœ… `flea_market_purchase_accepted` - å–å®¶åŒæ„è®®ä»·
- âœ… `flea_market_direct_purchase` - ç›´æ¥è´­ä¹°
- âœ… `flea_market_pending_payment` - æ”¯ä»˜æé†’ï¼ˆæ–°å¢ï¼‰

**é€šçŸ¥æ•°æ®**ï¼š
- åŒ…å« `item_id` å’Œ `task_id`ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
- å‰ç«¯å¯ä»¥æ ¹æ®è¿™äº›æ•°æ®æ­£ç¡®è·³è½¬

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“äº‹åŠ¡

**å–å®¶åŒæ„è®®ä»·API**ï¼š
- ä½¿ç”¨FOR UPDATEé”é˜²æ­¢å¹¶å‘
- åœ¨åˆ›å»ºPaymentIntentä¹‹å‰è·å–æ‰€æœ‰å¿…è¦æ•°æ®
- å¦‚æœPaymentIntentåˆ›å»ºå¤±è´¥ï¼Œå›æ»šæ•´ä¸ªäº‹åŠ¡

**æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°**ï¼š
- åœ¨webhookä¸­ç«‹å³æäº¤çŠ¶æ€æ›´æ–°
- ç¡®ä¿çŠ¶æ€æ›´æ–°å’Œç¼“å­˜æ¸…é™¤çš„åŸå­æ€§

---

### 2. é”™è¯¯å¤„ç†

**å–å®¶åŒæ„è®®ä»·API**ï¼š
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯
- è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯
- é€‚å½“çš„HTTPçŠ¶æ€ç 

**æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°**ï¼š
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- å¦‚æœçŠ¶æ€æ›´æ–°å¤±è´¥ï¼Œè®°å½•è­¦å‘Šä½†ä¸å½±å“ä¸»æµç¨‹

---

### 3. æ€§èƒ½ä¼˜åŒ–

**çŠ¶æ€æ›´æ–°**ï¼š
- ç«‹å³æäº¤ï¼Œç¡®ä¿åŠæ—¶æ€§
- è‡ªåŠ¨æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿å‰ç«¯è·å–æœ€æ–°çŠ¶æ€

**æ¨é€é€šçŸ¥**ï¼š
- å¼‚æ­¥å‘é€ï¼Œä¸å½±å“ä¸»æµç¨‹
- å¦‚æœæ¨é€å¤±è´¥ï¼Œè®°å½•è­¦å‘Šä½†ä¸å½±å“ä¸»æµç¨‹

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å–å®¶åŒæ„è®®ä»·APIæµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. å–å®¶åŒæ„ä¹°å®¶çš„è®®ä»·è¯·æ±‚
2. éªŒè¯ä»»åŠ¡æ˜¯å¦æ­£ç¡®åˆ›å»º
3. éªŒè¯PaymentIntentæ˜¯å¦æ­£ç¡®åˆ›å»º
4. éªŒè¯å•†å“æ˜¯å¦æ­£ç¡®å…³è”ä»»åŠ¡
5. éªŒè¯å…¶ä»–pendingçŠ¶æ€çš„ç”³è¯·æ˜¯å¦è¢«æ‹’ç»
6. éªŒè¯æ¨é€é€šçŸ¥æ˜¯å¦æ­£ç¡®å‘é€

**è¾¹ç•Œæƒ…å†µ**ï¼š
- æ— æ•ˆçš„è¯·æ±‚ID
- ç”³è¯·ä¸å­˜åœ¨
- æ— æƒé™æ“ä½œ
- ç”³è¯·å·²è¢«å¤„ç†
- å•†å“å·²å”®å‡ºæˆ–å·²ä¸‹æ¶
- å–å®¶æ²¡æœ‰Stripe Connectè´¦æˆ·

---

### 2. æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. å®Œæˆæ”¯ä»˜
2. éªŒè¯å•†å“çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°ä¸ºsold
3. éªŒè¯ç¼“å­˜æ˜¯å¦æ­£ç¡®æ¸…é™¤
4. éªŒè¯å‰ç«¯æ˜¯å¦èƒ½è·å–æœ€æ–°çŠ¶æ€

**æ€§èƒ½æµ‹è¯•**ï¼š
- éªŒè¯çŠ¶æ€æ›´æ–°æ˜¯å¦åœ¨2ç§’å†…å®Œæˆ
- éªŒè¯å‰ç«¯é‡è¯•æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

### 3. æ¨é€é€šçŸ¥æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. ä¹°å®¶å‘é€è®®ä»·è¯·æ±‚ â†’ éªŒè¯å–å®¶æ˜¯å¦æ”¶åˆ°é€šçŸ¥
2. å–å®¶åŒæ„è®®ä»· â†’ éªŒè¯ä¹°å®¶æ˜¯å¦æ”¶åˆ°é€šçŸ¥
3. ç›´æ¥è´­ä¹° â†’ éªŒè¯å–å®¶æ˜¯å¦æ”¶åˆ°é€šçŸ¥
4. æ”¯ä»˜æé†’ â†’ éªŒè¯ä¹°å®¶æ˜¯å¦æ”¶åˆ°é€šçŸ¥

**é€šçŸ¥æ•°æ®æµ‹è¯•**ï¼š
- éªŒè¯é€šçŸ¥æ•°æ®æ˜¯å¦åŒ…å«æ­£ç¡®çš„item_idå’Œtask_id
- éªŒè¯å‰ç«¯æ˜¯å¦èƒ½æ ¹æ®é€šçŸ¥æ•°æ®æ­£ç¡®è·³è½¬

---

## ğŸ“Š ä»£ç è´¨é‡

### 1. ä»£ç ç»“æ„

- âœ… æ¸…æ™°çš„å‡½æ•°åˆ†ç¦»
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… é€‚å½“çš„æ³¨é‡Š

### 2. å®‰å…¨æ€§

- âœ… æƒé™éªŒè¯
- âœ… çŠ¶æ€éªŒè¯
- âœ… å¹¶å‘æ§åˆ¶ï¼ˆFOR UPDATEé”ï¼‰
- âœ… äº‹åŠ¡ç®¡ç†

### 3. æ€§èƒ½

- âœ… ç«‹å³æäº¤çŠ¶æ€æ›´æ–°
- âœ… è‡ªåŠ¨æ¸…é™¤ç¼“å­˜
- âœ… å¼‚æ­¥æ¨é€é€šçŸ¥

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `backend/app/flea_market_routes.py` - è·³èš¤å¸‚åœºè·¯ç”±ï¼ˆåŒ…å«æ–°çš„å–å®¶åŒæ„è®®ä»·APIï¼‰
- `backend/app/routers.py` - Webhookå¤„ç†ï¼ˆåŒ…å«æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°ï¼‰
- `backend/app/flea_market_extensions.py` - è·³èš¤å¸‚åœºæ‰©å±•åŠŸèƒ½ï¼ˆé€šçŸ¥ã€ç¼“å­˜ç­‰ï¼‰
- `backend/app/push_notification_templates.py` - æ¨é€é€šçŸ¥æ¨¡æ¿

---

## ğŸ“ æ€»ç»“

### å®Œæˆæƒ…å†µ

**åç«¯åŠŸèƒ½**ï¼šâœ… 100% å®Œæˆ
- âœ… å–å®¶åŒæ„è®®ä»·APIå·²å®ç°
- âœ… æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°å·²ä¼˜åŒ–
- âœ… æ¨é€é€šçŸ¥æ”¯æŒå·²å®Œå–„

### å…³é”®æˆæœ

1. **å–å®¶åŒæ„è®®ä»·API**
   - å®Œæ•´çš„å®ç°
   - å®Œæ•´çš„é”™è¯¯å¤„ç†
   - å®Œæ•´çš„æ¨é€é€šçŸ¥

2. **æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°**
   - æ”¯æŒreservedçŠ¶æ€
   - ç«‹å³æäº¤ï¼Œç¡®ä¿åŠæ—¶æ€§
   - è‡ªåŠ¨æ¸…é™¤ç¼“å­˜

3. **æ¨é€é€šçŸ¥æ”¯æŒ**
   - æ‰€æœ‰é€šçŸ¥ç±»å‹å·²å®ç°
   - å®Œæ•´çš„é€šçŸ¥æ•°æ®
   - å‰ç«¯å¯ä»¥æ­£ç¡®è·³è½¬

### ä¸‹ä¸€æ­¥

1. **æµ‹è¯•éªŒè¯**ï¼š
   - å®Œæ•´æµ‹è¯•å–å®¶åŒæ„è®®ä»·API
   - æµ‹è¯•æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°
   - æµ‹è¯•æ¨é€é€šçŸ¥

2. **ä¼˜åŒ–å®Œå–„**ï¼š
   - æ ¹æ®æµ‹è¯•ç»“æœä¼˜åŒ–
   - æ·»åŠ æ›´å¤šé”™è¯¯å¤„ç†
   - ä¼˜åŒ–æ€§èƒ½

---

## ğŸ‰ å®Œæˆ

æ‰€æœ‰åç«¯åŠŸèƒ½å·²å®ç°å¹¶ä¼˜åŒ–å®Œæˆï¼âœ…
