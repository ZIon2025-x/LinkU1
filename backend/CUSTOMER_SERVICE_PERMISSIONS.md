# 客服权限说明文档

## 客服的权限范围

### ✅ 允许的操作

#### 1. **审核任务取消请求**（唯一管理权限）
- **端点**: `/api/customer-service/cancel-requests/{request_id}/review`
- **权限**: 可以审核通过（approved）或拒绝（rejected）任务取消请求
- **说明**: 这是客服的唯一管理权限，用于处理用户提交的任务取消申请

#### 2. **客服对话功能**（核心功能）
- 与用户进行实时对话
- 查看分配给自己的对话列表
- 发送和接收消息
- 标记消息为已读
- 结束对话
- 查看对话历史

#### 3. **向管理员请求帮助**
- **端点**: `/api/customer-service/admin-requests`
- **功能**: 提交管理请求，请求管理员处理需要更高权限的操作
- **请求类型**: 
  - `task_status`: 任务状态相关问题
  - `user_ban`: 用户封禁请求
  - `feedback`: 反馈和建议
  - `other`: 其他管理请求

#### 4. **与管理员沟通**
- **端点**: `/api/customer-service/admin-chat`
- **功能**: 通过聊天与管理员沟通，讨论需要处理的问题

#### 5. **查看员工通知**
- 查看系统发送给员工的提醒和通知
- 标记通知为已读

#### 6. **客服自身管理**
- 设置在线/离线状态
- 登出系统
- 查看自己的评分和统计
- 清理自己的旧对话记录

### ❌ 不允许的操作

客服**不能**执行以下操作（需要通过管理请求让管理员执行）：

1. **直接操作任务**
   - ❌ 删除任务
   - ❌ 修改任务信息
   - ❌ 更改任务状态（除了审核取消请求）

2. **操作用户账户**
   - ❌ 封禁用户（is_banned）
   - ❌ 暂停用户（is_suspended）
   - ❌ 修改用户等级（user_level）
   - ❌ 修改用户信息

3. **管理操作**
   - ❌ 创建或删除其他客服账号
   - ❌ 创建或删除管理员账号
   - ❌ 修改系统设置
   - ❌ 访问管理员后台

4. **直接执行管理员功能**
   - ❌ 所有以 `/admin/` 开头的端点都需要管理员权限
   - ❌ 客服无法绕过权限检查执行这些操作

## 权限设计原则

1. **最小权限原则**: 客服只被授予完成任务所需的最小权限
2. **审核分离**: 客服只能审核取消请求，不能直接操作任务或用户
3. **请求机制**: 需要更高权限的操作必须通过管理请求机制向管理员申请
4. **职责明确**: 客服负责用户支持和取消请求审核，管理员负责系统管理

## 如何请求管理员处理其他操作

当客服遇到需要管理员权限的操作时，应：

1. **提交管理请求**
   ```
   POST /api/customer-service/admin-requests
   {
     "type": "task_status" | "user_ban" | "feedback" | "other",
     "title": "请求标题",
     "description": "详细描述需要处理的问题",
     "priority": "low" | "medium" | "high"
   }
   ```

2. **或通过管理员聊天**
   ```
   POST /api/customer-service/admin-chat
   {
     "content": "需要管理员处理的问题..."
   }
   ```

3. **等待管理员处理**
   - 管理员会在后台查看请求
   - 管理员会处理并回复
   - 客服可以通过请求列表查看处理状态

## 安全说明

- 所有客服端点都使用 `get_current_service` 依赖进行认证
- 客服无法访问管理员专用端点（使用 `get_current_admin` 的端点）
- 客服的权限在代码层面被严格限制
- 即使客服尝试访问未授权的端点，也会收到 401 或 403 错误

