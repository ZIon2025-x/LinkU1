# 图片清理功能分析报告

## 现有清理功能 ✅

### 1. 临时图片清理
- **位置**: `cleanup_tasks.py::_cleanup_unused_temp_images()`
- **清理内容**: 
  - 任务临时图片（`temp_*` 文件夹，24小时）
  - 跳蚤市场临时图片（`temp_*` 文件夹，24小时）
  - 榜单封面临时图片（`temp_*` 文件夹，24小时）
- **频率**: 每小时执行
- **状态**: ✅ 正常

### 2. 孤立文件清理
- **位置**: `cleanup_tasks.py::_cleanup_orphan_files()`
- **清理内容**: 不在预期位置的文件（超过7天未使用）
- **频率**: 每周执行一次
- **状态**: ✅ 正常

### 3. 不存在实体的图片文件夹清理
- **位置**: `cleanup_tasks.py::_cleanup_orphan_entity_images()`
- **清理内容**: 
  - 不存在竞品的图片文件夹
  - 不存在商品的图片文件夹
  - 不存在任务的图片文件夹
- **频率**: 每周执行一次
- **状态**: ✅ 正常

### 4. 已完成/过期任务文件清理
- **位置**: `cleanup_tasks.py::_cleanup_completed_tasks_files()` / `_cleanup_expired_tasks_files()`
- **清理内容**: 已完成超过3天或过期超过3天的任务文件
- **频率**: 每天执行一次
- **状态**: ✅ 正常

### 5. 过期跳蚤市场商品清理
- **位置**: `cleanup_tasks.py::_cleanup_expired_flea_market_items()`
- **清理内容**: 超过10天未刷新的商品
- **频率**: 每天执行一次
- **状态**: ✅ 正常

## 缺失的清理功能 ❌

### 1. 用户头像清理
- **问题**: 
  - 用户更换头像时，旧头像文件可能残留
  - 用户被删除时，头像文件可能残留
- **影响**: 占用存储空间
- **建议**: 添加用户头像清理功能

### 2. 任务达人头像清理
- **问题**: 
  - 任务达人更换头像时，旧头像文件可能残留
  - 任务达人被删除时，头像文件可能残留
- **影响**: 占用存储空间
- **建议**: 添加任务达人头像清理功能

### 3. Banner图片清理
- **问题**: 
  - Banner被删除时，图片文件可能残留
  - Banner被禁用时，图片文件可能残留
- **影响**: 占用存储空间
- **建议**: 添加Banner图片清理功能

### 4. 旧格式图片清理
- **问题**: 
  - 旧版本可能直接在 `/uploads/images/` 下保存图片（不在子目录中）
  - 这些图片可能无法被现有清理逻辑识别
- **影响**: 占用存储空间
- **建议**: 添加旧格式图片清理功能

### 5. 消息附件图片清理
- **问题**: 
  - 消息被删除时，附件图片文件可能残留
  - 私密图片可能无法被正确清理
- **影响**: 占用存储空间
- **建议**: 检查消息删除时是否正确清理附件

### 6. 服务图片清理
- **问题**: 
  - 服务被删除时，服务图片可能残留
  - 服务图片更新时，旧图片可能残留
- **影响**: 占用存储空间
- **建议**: 添加服务图片清理功能

## 改进建议

### 优先级：高
1. **添加用户头像清理功能** - 检查数据库中不存在的用户头像文件
2. **添加任务达人头像清理功能** - 检查数据库中不存在的任务达人头像文件
3. **添加Banner图片清理功能** - 检查数据库中不存在的Banner图片文件

### 优先级：中
4. **添加旧格式图片清理功能** - 清理直接保存在 `/uploads/images/` 下的旧格式图片
5. **检查消息附件清理** - 确保消息删除时正确清理附件文件

### 优先级：低
6. **添加服务图片清理功能** - 检查数据库中不存在的服务图片文件

