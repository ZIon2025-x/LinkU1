# 自动迁移功能说明

## 功能概述

应用启动时会自动检查并运行数据库迁移，确保数据库结构始终是最新的。

## 配置方式

### 启用自动迁移（默认）

自动迁移功能默认启用，无需配置。

### 禁用自动迁移

如果需要禁用自动迁移（例如在生产环境中手动控制迁移），可以设置环境变量：

```bash
# 禁用自动迁移
export AUTO_MIGRATE=false
```

或者在 `.env` 文件中：
```
AUTO_MIGRATE=false
```

## 工作原理

1. **启动时检查**：应用启动时会检查当前数据库版本
2. **版本对比**：对比当前版本和最新版本（head）
3. **自动升级**：如果有待执行的迁移，自动运行 `alembic upgrade head`
4. **日志记录**：所有操作都会记录在日志中

## 日志输出示例

### 已是最新版本
```
✅ 数据库已是最新版本 (revision: task_chat_features_001)
```

### 发现待执行迁移
```
📦 发现待执行的迁移: make_task_history_nullable -> task_chat_features_001
正在运行数据库迁移...
✅ 数据库迁移完成！
```

### 迁移失败（非生产环境）
```
⚠️ 数据库迁移失败（非生产环境，继续运行）: ...
提示：可以手动运行 'alembic upgrade head' 来应用迁移
```

### 迁移失败（生产环境）
```
❌ 生产环境迁移失败，应用将不会启动: ...
```

## 环境行为

### 开发环境（ENVIRONMENT != "production"）
- 迁移失败时：记录警告日志，应用继续启动
- 允许手动运行迁移

### 生产环境（ENVIRONMENT == "production"）
- 迁移失败时：阻止应用启动，抛出异常
- 确保数据库结构一致性

## 禁用自动迁移后的操作

如果禁用了自动迁移，需要手动运行：

```bash
cd backend
alembic upgrade head
```

## 迁移完成后禁用自动迁移

迁移完成后，建议在生产环境中禁用自动迁移，改为手动控制：

1. **设置环境变量**：
   ```bash
   export AUTO_MIGRATE=false
   ```

2. **或者修改代码**（不推荐）：
   在 `main.py` 中修改默认值：
   ```python
   auto_migrate = os.getenv("AUTO_MIGRATE", "false").lower() == "true"
   ```

## 注意事项

1. **首次部署**：自动迁移功能非常方便，会自动应用所有迁移
2. **生产环境**：建议迁移完成后禁用自动迁移，改为手动控制
3. **迁移失败**：生产环境会阻止启动，确保数据一致性
4. **日志监控**：建议监控迁移日志，及时发现问题

## 故障排查

### 问题1：迁移失败但应用继续启动
**原因**：非生产环境，迁移失败不会阻止启动
**解决**：检查日志，手动运行迁移

### 问题2：生产环境迁移失败导致应用无法启动
**原因**：生产环境迁移失败会阻止启动
**解决**：
1. 检查迁移脚本是否有错误
2. 检查数据库连接
3. 修复问题后重新部署

### 问题3：Alembic 未安装
**原因**：缺少 alembic 依赖
**解决**：安装依赖 `pip install alembic`

## 相关文件

- `backend/app/main.py` - 自动迁移逻辑
- `backend/alembic/versions/` - 迁移脚本目录
- `backend/alembic.ini` - Alembic 配置文件

