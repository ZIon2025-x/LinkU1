# 新用户和新任务优先曝光优化

## 🎯 优化目标

1. **优化协同过滤算法** - 提升推荐质量和性能
2. **新用户发布的新任务优先曝光** - 让新用户快速体验平台价值
3. **新任务优先显示** - 确保新鲜内容优先展示

## ✅ 完成的优化

### 1. 协同过滤算法优化

**文件**: `backend/app/task_recommendation.py`

**改进**:
- ✅ 优化相似用户查找：只查询有交互记录的用户，避免全表扫描
- ✅ 动态调整相似度阈值：根据用户交互数量调整
- ✅ 批量查询优化：减少数据库查询次数

**代码示例**:
```python
def _find_similar_users(self, user_id: str, user_interactions: set, k: int = 10):
    # 只查询有交互记录的用户，避免查询所有用户
    active_user_ids = self.db.query(
        func.distinct(UserTaskInteraction.user_id)
    ).filter(
        UserTaskInteraction.user_id != user_id,
        UserTaskInteraction.task_id.in_(list(user_interactions))
    ).all()
    
    # 动态阈值：交互少的用户降低阈值
    min_similarity = 0.1 if len(user_interactions) >= 5 else 0.05
```

### 2. 新任务优先曝光机制

**文件**: `backend/app/task_recommendation.py`

**新增方法**:
- ✅ `_is_new_user()` - 判断是否为新用户（注册7天内）
- ✅ `_is_new_task()` - 判断是否为新任务（发布24小时内）
- ✅ `_is_new_user_task()` - 判断是否为新用户发布的新任务
- ✅ `_new_task_boost_recommend()` - 新任务优先推荐

**推荐权重调整**:
- 新用户时：降低内容推荐权重（30%），提高新任务权重（20%）
- 普通用户：内容推荐（35%），新任务推荐（15%）

**新任务加分机制**:
- 新任务（24小时内）：额外加0.1分
- 新用户发布的新任务：额外加0.15分（总共0.25分）

### 3. 混合推荐算法优化

**文件**: `backend/app/task_recommendation.py`

**权重分配**（新用户 vs 普通用户）:

| 推荐类型 | 新用户权重 | 普通用户权重 |
|---------|-----------|------------|
| 基于内容 | 30% | 35% |
| 协同过滤 | 20% | 25% |
| 新任务优先 | 20% | 15% |
| 地理位置 | 12% | 12% |
| 热门任务 | 8% | 8% |
| 时间匹配 | 5% | 5% |

### 4. 任务列表排序优化

**文件**: 
- `backend/app/crud.py` - 同步CRUD
- `backend/app/async_crud.py` - 异步CRUD

**改进**:
- ✅ 在数据库层面使用CASE语句给新任务加权
- ✅ 新任务（24小时内）权重=2，普通任务权重=1
- ✅ 应用层二次排序：新用户新任务 > 新任务 > 普通任务

**排序逻辑**:
```python
# 数据库层面：使用CASE语句加权
sort_weight = case(
    (Task.created_at >= recent_24h, 2),  # 新任务
    else_=1  # 普通任务
)
query = query.order_by(sort_weight.desc(), Task.created_at.desc())

# 应用层：二次排序确保新用户新任务最优先
tasks.sort(key=lambda t: (
    -1 if t.is_new_user_task else 0,  # 新用户新任务最优先
    -1 if t.is_new_task else 0,        # 新任务其次
    t.created_at                       # 最后按时间
), reverse=True)
```

### 5. 任务创建时缓存清除

**文件**: `backend/app/crud.py`

**改进**:
- ✅ 创建任务时清除推荐缓存
- ✅ 清除所有用户的推荐缓存（因为新任务可能对所有用户都有价值）
- ✅ 新用户发布任务时，异步更新热门任务列表

**代码**:
```python
# 清除推荐缓存，确保新任务能立即被推荐
recommendation_patterns = [
    "recommendations:*",  # 清除所有推荐缓存
    "popular_tasks:*",    # 清除热门任务缓存
]

# 如果是新用户发布的任务，触发异步推荐更新
if is_new_user:
    update_popular_tasks_async()  # 异步更新热门任务列表
```

### 6. 推荐理由优化

**文件**: `backend/app/task_recommendation.py`

**新增理由**:
- "新用户发布，优先推荐" - 新用户发布的新任务
- "新发布任务" - 普通新任务

**示例**:
```python
if self._is_new_user_task(task):
    reason = "新用户发布，优先推荐；" + reason
elif self._is_new_task(task):
    reason = "新发布任务；" + reason
```

## 📊 效果预期

### 新用户体验
- ✅ 新用户发布的任务在24小时内优先显示
- ✅ 新用户发布的任务在推荐中权重更高
- ✅ 新用户能快速看到自己的任务被推荐

### 推荐质量
- ✅ 协同过滤性能提升（减少全表扫描）
- ✅ 新任务及时出现在推荐中
- ✅ 推荐多样性保持（新任务占比15-20%）

### 平台活跃度
- ✅ 新用户留存率提升（快速看到价值）
- ✅ 任务曝光率提升（新任务优先）
- ✅ 用户发布积极性提升（快速反馈）

## 🔧 技术细节

### 新用户定义
- 注册时间 ≤ 7天

### 新任务定义
- 发布时间 ≤ 24小时

### 新用户新任务定义
- 任务发布时间 ≤ 24小时 AND 发布者注册时间 ≤ 7天

### 排序优先级
1. **最高优先级**: 新用户发布的新任务
2. **高优先级**: 新任务（24小时内）
3. **普通优先级**: 其他任务

## 📝 使用说明

### 1. 数据库迁移
无需额外迁移，使用现有字段（`created_at`）

### 2. 缓存策略
- 新任务创建时自动清除推荐缓存
- 推荐缓存TTL：30分钟
- 热门任务缓存TTL：30分钟

### 3. 监控指标
建议监控：
- 新任务曝光率
- 新用户任务接受率
- 推荐中新任务占比

## 🎉 总结

通过本次优化：

1. ✅ **协同过滤算法优化** - 性能提升，质量改善
2. ✅ **新任务优先曝光** - 确保新鲜内容优先展示
3. ✅ **新用户新任务特别优先** - 让新用户快速体验平台价值
4. ✅ **任务列表排序优化** - 数据库层和应用层双重保障
5. ✅ **缓存策略优化** - 新任务创建时及时清除缓存

系统现在能够：
- 快速识别新用户和新任务
- 优先推荐新用户发布的新任务
- 确保新任务及时出现在推荐和列表中
- 让新用户快速看到自己发布的任务被推荐

这将显著提升新用户体验和平台活跃度！
