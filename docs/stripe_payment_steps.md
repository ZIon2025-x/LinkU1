# Stripe 支付流程说明：哪些步骤需要支付

## 📋 支付概览

根据当前代码实现，**只有一个步骤需要支付**：

### ✅ 需要支付的步骤

#### 1. **任务平台服务费支付**（任务发布后）

**支付时机**：
- 任务发布后，在任务被接受之前
- 发布者需要支付平台服务费才能让任务进入"已支付"状态

**支付金额**：
- **平台服务费 = 任务金额 × 10%**（默认费率，可从系统设置 `application_fee_rate` 调整）
- 例如：任务金额 £100 → 平台服务费 £10

**支付方式**：
- ✅ **Stripe 支付**（银行卡）
- ✅ **积分支付**（可用积分抵扣）
- ✅ **优惠券抵扣**（可用优惠券减免）
- ✅ **混合支付**（积分 + Stripe）

**支付流程**：
```
1. 用户发布任务（免费）
   ↓
2. 任务创建成功，状态为 "open"（未支付）
   ↓
3. 发布者访问支付页面：/tasks/{task_id}/payment
   ↓
4. 选择支付方式：
   - 纯积分支付（如果积分足够）
   - 纯 Stripe 支付
   - 积分 + Stripe 混合支付
   ↓
5. 完成支付后：
   - task.is_paid = 1（标记为已支付）
   - task.escrow_amount = 任务金额（托管金额）
   - 任务可以正常进行
```

**代码位置**：
- API 端点：`POST /api/coupon-points/tasks/{task_id}/payment`
- 文件：`backend/app/coupon_points_routes.py` (第 316 行)

---

### ❌ 不需要支付的步骤

#### 1. **任务发布**（免费）
- 创建任务本身不需要支付
- 只需要填写任务信息即可

#### 2. **任务接受**（免费）
- 服务者接受任务不需要支付
- 这是免费的操作

#### 3. **任务完成**（不需要支付）
- 任务完成后，奖励金额已经托管在平台（escrow_amount）
- 不需要额外支付

#### 4. **奖励发放**（不需要支付）
- 任务确认后，奖励从托管账户发放给服务者
- 这是平台内部转账，不需要用户支付

---

## 💰 支付金额计算示例

### 示例 1：纯 Stripe 支付

**任务信息**：
- 任务金额：£100
- 平台服务费率：10%

**计算**：
- 平台服务费：£100 × 10% = £10
- 需要支付：£10（通过 Stripe）

**结果**：
- 用户支付：£10（平台服务费）
- 托管金额：£100（任务奖励，等任务完成后发放给服务者）

---

### 示例 2：积分抵扣

**任务信息**：
- 任务金额：£100
- 平台服务费：£10
- 用户积分余额：£5

**计算**：
- 平台服务费：£10
- 积分抵扣：£5
- 需要支付：£10 - £5 = £5（通过 Stripe）

**结果**：
- 积分消费：£5
- Stripe 支付：£5
- 托管金额：£100

---

### 示例 3：优惠券抵扣

**任务信息**：
- 任务金额：£100
- 平台服务费：£10
- 优惠券折扣：£3

**计算**：
- 平台服务费：£10
- 优惠券抵扣：£3
- 需要支付：£10 - £3 = £7（通过 Stripe）

**结果**：
- 优惠券使用：£3
- Stripe 支付：£7
- 托管金额：£100

---

### 示例 4：全额积分支付

**任务信息**：
- 任务金额：£100
- 平台服务费：£10
- 用户积分余额：£15

**计算**：
- 平台服务费：£10
- 积分抵扣：£10（全额抵扣）
- 需要支付：£0（不需要 Stripe 支付）

**结果**：
- 积分消费：£10
- Stripe 支付：£0
- 托管金额：£100
- 任务自动标记为已支付

---

## 🔄 完整任务生命周期

```
1. 发布任务（免费）
   ├─ 填写任务信息
   ├─ 设置任务金额：£100
   └─ 任务状态：open, is_paid=0

2. 支付平台服务费（需要支付）⭐
   ├─ 计算服务费：£100 × 10% = £10
   ├─ 选择支付方式：Stripe / 积分 / 混合
   ├─ 完成支付：£10
   └─ 任务状态：open, is_paid=1, escrow_amount=£100

3. 服务者接受任务（免费）
   ├─ 服务者申请/接受任务
   └─ 任务状态：accepted

4. 完成任务（免费）
   ├─ 服务者标记任务完成
   └─ 任务状态：completed

5. 确认任务（免费）
   ├─ 发布者确认任务完成
   └─ 任务状态：confirmed

6. 发放奖励（不需要支付）
   ├─ 平台从托管账户发放 £100 给服务者
   └─ 通过 Stripe Connect 转账（如果配置）
```

---

## 📝 重要说明

### 1. 支付的是平台服务费，不是任务奖励

- ✅ **需要支付**：平台服务费（任务金额的 10%）
- ❌ **不需要支付**：任务奖励本身（已托管在平台）

### 2. 任务奖励托管机制

- 任务奖励金额（£100）在支付平台服务费后自动托管
- 托管金额存储在 `task.escrow_amount` 字段
- 任务完成后，托管金额发放给服务者

### 3. 积分和优惠券只能抵扣平台服务费

- 积分和优惠券**不能**抵扣任务奖励本身
- 只能用于抵扣平台服务费
- 例如：任务 £100，服务费 £10，积分只能抵扣 £10，不能抵扣 £100

### 4. 支付时机

- **最佳时机**：任务发布后立即支付
- **最晚时机**：任务被接受之前必须支付
- 如果任务已支付（`is_paid=1`），不能重复支付

---

## 🎯 总结

**需要支付的步骤**：
- ✅ **任务平台服务费支付**（任务金额 × 10%）

**不需要支付的步骤**：
- ❌ 任务发布
- ❌ 任务接受
- ❌ 任务完成
- ❌ 奖励发放

**支付方式**：
- Stripe 银行卡支付
- 积分支付
- 优惠券抵扣
- 混合支付（积分 + Stripe）

---

**最后更新**：2024年


