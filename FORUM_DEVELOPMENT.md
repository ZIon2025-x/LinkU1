# è®ºå›åŠŸèƒ½å¼€å‘æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.4  
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-27  
> **æœ€åæ›´æ–°**: 2025-01-27  
> **è®¾è®¡åŸåˆ™**: å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€ç”¨æˆ·å‹å¥½ã€å®‰å…¨ä¼˜å…ˆ

---

## ğŸ“‹ ç›®å½•

1. [éœ€æ±‚æ¦‚è¿°](#éœ€æ±‚æ¦‚è¿°)
2. [åŠŸèƒ½è®¾è®¡](#åŠŸèƒ½è®¾è®¡)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [APIè®¾è®¡](#apiè®¾è®¡)
5. [å‰ç«¯è®¾è®¡](#å‰ç«¯è®¾è®¡)
6. [å¼€å‘æ­¥éª¤](#å¼€å‘æ­¥éª¤)
7. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
8. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)
9. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
10. [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
11. [é‡è¦å®ç°æ³¨æ„äº‹é¡¹](#é‡è¦å®ç°æ³¨æ„äº‹é¡¹)

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### æ ¸å¿ƒç›®æ ‡

å¼€å‘ä¸€ä¸ªå®Œæ•´çš„è®ºå›ç³»ç»Ÿï¼Œå…è®¸ç”¨æˆ·ï¼š
- åˆ›å»ºå’Œç®¡ç†è®ºå›æ¿å—ï¼ˆåˆ†ç±»ï¼‰
- å‘å¸ƒä¸»é¢˜å¸–
- å›å¤å’Œè¯„è®º
- ç‚¹èµ/æ”¶è—å¸–å­
- æœç´¢å’Œç­›é€‰å†…å®¹
- ç®¡ç†è‡ªå·±çš„å¸–å­

### ä¸šåŠ¡ä»·å€¼

- **å¢å¼ºç”¨æˆ·ç²˜æ€§**: æä¾›ç¤¾åŒºäº¤æµå¹³å°
- **å†…å®¹æ²‰æ·€**: ç§¯ç´¯ç”¨æˆ·ç”Ÿæˆå†…å®¹ï¼ˆUGCï¼‰
- **çŸ¥è¯†åˆ†äº«**: ä¿ƒè¿›ç”¨æˆ·ä¹‹é—´çš„ç»éªŒäº¤æµ
- **ç¤¾åŒºå»ºè®¾**: å½¢æˆæ´»è·ƒçš„ç”¨æˆ·ç¤¾åŒº

---

## ğŸ¯ åŠŸèƒ½è®¾è®¡

### 1. è®ºå›æ¿å—ï¼ˆForum Categoryï¼‰

#### åŠŸèƒ½ç‰¹æ€§
- åˆ›å»ºå’Œç®¡ç†è®ºå›æ¿å—ï¼ˆç®¡ç†å‘˜ï¼‰
- æ¿å—åˆ—è¡¨å±•ç¤º
- æ¿å—è¯¦æƒ…ï¼ˆåŒ…å«å¸–å­ç»Ÿè®¡ï¼‰
- æ¿å—å›¾æ ‡å’Œæè¿°
- æ¿å—æ’åºå’Œæ˜¾ç¤ºé¡ºåº

#### æ¿å—å±æ€§
- åç§°ï¼ˆå¿…å¡«ï¼‰
- æè¿°ï¼ˆå¯é€‰ï¼‰
- å›¾æ ‡ï¼ˆå¯é€‰ï¼‰
- æ’åºæƒé‡
- æ˜¯å¦æ˜¾ç¤º
- å¸–å­æ•°é‡ç»Ÿè®¡
- æœ€åæ›´æ–°æ—¶é—´

### 2. ä¸»é¢˜å¸–ï¼ˆPostï¼‰

#### åŠŸèƒ½ç‰¹æ€§
- å‘å¸ƒä¸»é¢˜å¸–
- ç¼–è¾‘è‡ªå·±çš„å¸–å­
- åˆ é™¤è‡ªå·±çš„å¸–å­
- å¸–å­è¯¦æƒ…æŸ¥çœ‹
- å¸–å­åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- å¸–å­æœç´¢
- å¸–å­ç­›é€‰ï¼ˆæŒ‰æ¿å—ã€æ—¶é—´ã€çƒ­åº¦ç­‰ï¼‰
- å¸–å­ç½®é¡¶ï¼ˆç®¡ç†å‘˜ï¼‰
- å¸–å­åŠ ç²¾ï¼ˆç®¡ç†å‘˜ï¼‰
- å¸–å­é”å®šï¼ˆç®¡ç†å‘˜ï¼‰

#### å¸–å­å±æ€§
- æ ‡é¢˜ï¼ˆå¿…å¡«ï¼Œæœ€å¤§200å­—ç¬¦ï¼‰
- å†…å®¹ï¼ˆå¿…å¡«ï¼Œæ”¯æŒMarkdownï¼‰
- æ‰€å±æ¿å—ï¼ˆå¿…å¡«ï¼‰
- å‘å¸ƒè€…ï¼ˆå¿…å¡«ï¼‰
- å‘å¸ƒæ—¶é—´
- æœ€åæ›´æ–°æ—¶é—´
- æµè§ˆæ¬¡æ•°
- å›å¤æ•°
- ç‚¹èµæ•°
- æ”¶è—æ•°
- æ˜¯å¦ç½®é¡¶
- æ˜¯å¦åŠ ç²¾
- æ˜¯å¦é”å®š
- æ˜¯å¦åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰

### 3. å›å¤ï¼ˆReplyï¼‰

#### åŠŸèƒ½ç‰¹æ€§
- å›å¤ä¸»é¢˜å¸–
- å›å¤å…¶ä»–å›å¤ï¼ˆåµŒå¥—å›å¤ï¼Œæœ€å¤š3å±‚ï¼‰
- ç¼–è¾‘è‡ªå·±çš„å›å¤
- åˆ é™¤è‡ªå·±çš„å›å¤
- å›å¤åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- å›å¤ç‚¹èµ

#### å›å¤å±æ€§
- å†…å®¹ï¼ˆå¿…å¡«ï¼Œæ”¯æŒMarkdownï¼‰
- æ‰€å±å¸–å­ï¼ˆå¿…å¡«ï¼‰
- çˆ¶å›å¤IDï¼ˆå¯é€‰ï¼Œç”¨äºåµŒå¥—å›å¤ï¼‰
- å›å¤å±‚çº§ï¼ˆ1-3å±‚ï¼‰
- å‘å¸ƒè€…ï¼ˆå¿…å¡«ï¼‰
- å‘å¸ƒæ—¶é—´
- æœ€åæ›´æ–°æ—¶é—´
- ç‚¹èµæ•°
- æ˜¯å¦åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰

### 4. ç‚¹èµï¼ˆLikeï¼‰

#### åŠŸèƒ½ç‰¹æ€§
- ç‚¹èµ/å–æ¶ˆç‚¹èµå¸–å­
- ç‚¹èµ/å–æ¶ˆç‚¹èµå›å¤
- æŸ¥çœ‹ç‚¹èµåˆ—è¡¨

#### ç‚¹èµå±æ€§
- ç›®æ ‡ç±»å‹ï¼ˆpost/replyï¼‰
- ç›®æ ‡ID
- ç”¨æˆ·ID
- åˆ›å»ºæ—¶é—´

### 5. æ”¶è—ï¼ˆFavoriteï¼‰

#### åŠŸèƒ½ç‰¹æ€§
- æ”¶è—/å–æ¶ˆæ”¶è—å¸–å­
- æŸ¥çœ‹æ”¶è—åˆ—è¡¨

#### æ”¶è—å±æ€§
- å¸–å­ID
- ç”¨æˆ·ID
- åˆ›å»ºæ—¶é—´

### 6. æœç´¢åŠŸèƒ½

#### åŠŸèƒ½ç‰¹æ€§
- å…¨æ–‡æœç´¢ï¼ˆæ ‡é¢˜å’Œå†…å®¹ï¼‰
- æŒ‰æ¿å—ç­›é€‰
- æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°ã€æœ€çƒ­ï¼‰
- æŒ‰å›å¤æ•°æ’åº
- æŒ‰ç‚¹èµæ•°æ’åº

### 7. é€šçŸ¥åŠŸèƒ½

#### åŠŸèƒ½ç‰¹æ€§
- å¸–å­è¢«å›å¤æ—¶é€šçŸ¥
- å›å¤è¢«å›å¤æ—¶é€šçŸ¥
- å¸–å­è¢«ç‚¹èµæ—¶é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
- å¸–å­è¢«åŠ ç²¾/ç½®é¡¶æ—¶é€šçŸ¥
- é€šçŸ¥å·²è¯»/æœªè¯»çŠ¶æ€ç®¡ç†
- é€šçŸ¥åˆ—è¡¨æŸ¥çœ‹

#### é€šçŸ¥å±æ€§
- é€šçŸ¥ç±»å‹ï¼ˆreply_post/reply_reply/like_post/feature_post/pin_postï¼‰
- ç›®æ ‡ç±»å‹ï¼ˆpost/replyï¼‰
- ç›®æ ‡ID
- å‘é€è€…ID
- æ¥æ”¶è€…ID
- æ˜¯å¦å·²è¯»
- åˆ›å»ºæ—¶é—´

**é€šçŸ¥ç±»å‹èŒƒå›´è¯´æ˜**:
- **ç›®å‰åªå¯¹å¸–å­ç‚¹èµå‘é€šçŸ¥**ï¼Œä¸åŒ…å«å›å¤ç‚¹èµï¼›å¦‚åç»­éœ€è¦å¯ä»¥å¢åŠ  `like_reply` ç±»å‹ï¼Œå¹¶æ‰©å±•è¡¨çº¦æŸ
- é€šçŸ¥ç±»å‹æšä¸¾ï¼š`reply_post`ï¼ˆå›å¤å¸–å­ï¼‰ã€`reply_reply`ï¼ˆå›å¤å›å¤ï¼‰ã€`like_post`ï¼ˆç‚¹èµå¸–å­ï¼‰ã€`feature_post`ï¼ˆåŠ ç²¾å¸–å­ï¼‰ã€`pin_post`ï¼ˆç½®é¡¶å¸–å­ï¼‰

### 8. ä¸¾æŠ¥/å®¡æ ¸åŠŸèƒ½

#### åŠŸèƒ½ç‰¹æ€§
- ç”¨æˆ·ä¸¾æŠ¥å¸–å­/å›å¤
- ç®¡ç†å‘˜å®¡æ ¸ä¸¾æŠ¥
- ä¸¾æŠ¥çŠ¶æ€ç®¡ç†ï¼ˆå¾…å¤„ç†/å·²å¤„ç†/å·²é©³å›ï¼‰
- ä¸¾æŠ¥åŸå› è®°å½•

#### ä¸¾æŠ¥å±æ€§
- ç›®æ ‡ç±»å‹ï¼ˆpost/replyï¼‰
- ç›®æ ‡ID
- ä¸¾æŠ¥äººID
- ä¸¾æŠ¥åŸå› 
- ä¸¾æŠ¥è¯´æ˜
- å¤„ç†çŠ¶æ€ï¼ˆpending/processed/rejectedï¼‰
- å¤„ç†äººIDï¼ˆç®¡ç†å‘˜ï¼‰
- å¤„ç†æ—¶é—´
- åˆ›å»ºæ—¶é—´

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. è®ºå›æ¿å—è¡¨ï¼ˆforum_categoriesï¼‰

```sql
CREATE TABLE forum_categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    icon VARCHAR(200),
    sort_order INTEGER DEFAULT 0,
    is_visible BOOLEAN DEFAULT TRUE,
    post_count INTEGER DEFAULT 0,
    last_post_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_forum_categories_visible ON forum_categories(is_visible, sort_order);
```

### 2. ä¸»é¢˜å¸–è¡¨ï¼ˆforum_postsï¼‰

```sql
CREATE TABLE forum_posts (
    id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    category_id INTEGER NOT NULL REFERENCES forum_categories(id) ON DELETE CASCADE,
    author_id VARCHAR(8) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    view_count INTEGER DEFAULT 0,
    reply_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    favorite_count INTEGER DEFAULT 0,
    is_pinned BOOLEAN DEFAULT FALSE,
    is_featured BOOLEAN DEFAULT FALSE,
    is_locked BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,
    is_visible BOOLEAN DEFAULT TRUE NOT NULL,  -- é£æ§éšè—å­—æ®µï¼ŒFALSE æ—¶å¯¹æ™®é€šç”¨æˆ·ä¸å¯è§
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_reply_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_forum_posts_category ON forum_posts(category_id, is_deleted, is_visible, created_at DESC);
CREATE INDEX idx_forum_posts_author ON forum_posts(author_id, is_deleted, is_visible);
CREATE INDEX idx_forum_posts_pinned ON forum_posts(is_pinned DESC, created_at DESC);
CREATE INDEX idx_forum_posts_last_reply ON forum_posts(is_deleted, is_visible, last_reply_at DESC NULLS LAST);

-- æ³¨æ„ï¼šç´¢å¼•ä¸­çš„ DESC æ’åºæ–¹å‘ä¸å¸¸ç”¨ ORDER BY åœºæ™¯å¯¹é½ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
-- å…¨æ–‡æœç´¢ç´¢å¼•ï¼šä½¿ç”¨ 'simple' é…ç½®ï¼ˆå¯¹ä¸­æ–‡åˆ†è¯æ•ˆæœè¾ƒå·®ï¼‰
-- âš ï¸ å»ºè®®ï¼šå°½å¿«æ¥å…¥ MeiliSearch / Elasticsearch æˆ–ä½¿ç”¨ pg_bigm æ‰©å±• + gin ç´¢å¼•ä»¥è·å¾—æ›´å¥½çš„ä¸­æ–‡æœç´¢ä½“éªŒ
CREATE INDEX idx_forum_posts_search ON forum_posts USING GIN(to_tsvector('simple', title || ' ' || content));

-- å¦‚æœä½¿ç”¨ pg_bigm æ‰©å±•ï¼ˆæ¨èç”¨äºä¸­æ–‡æœç´¢ï¼‰ï¼š
-- CREATE EXTENSION IF NOT EXISTS pg_bigm;
-- CREATE INDEX idx_forum_posts_search_bigm ON forum_posts USING gin(to_tsvector('public.bigm', title || ' ' || content));
```

### 3. å›å¤è¡¨ï¼ˆforum_repliesï¼‰

```sql
CREATE TABLE forum_replies (
    id SERIAL PRIMARY KEY,
    content TEXT NOT NULL,
    post_id INTEGER NOT NULL REFERENCES forum_posts(id) ON DELETE CASCADE,
    parent_reply_id INTEGER REFERENCES forum_replies(id) ON DELETE CASCADE,
    reply_level INTEGER DEFAULT 1 CHECK (reply_level BETWEEN 1 AND 3),
    author_id VARCHAR(8) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    like_count INTEGER DEFAULT 0,
    is_deleted BOOLEAN DEFAULT FALSE,
    is_visible BOOLEAN DEFAULT TRUE NOT NULL,  -- é£æ§éšè—å­—æ®µï¼ŒFALSE æ—¶å¯¹æ™®é€šç”¨æˆ·ä¸å¯è§
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_forum_replies_post ON forum_replies(post_id, created_at ASC);
CREATE INDEX idx_forum_replies_parent ON forum_replies(parent_reply_id);
CREATE INDEX idx_forum_replies_author ON forum_replies(author_id, is_deleted, is_visible);
```

### 4. ç‚¹èµè¡¨ï¼ˆforum_likesï¼‰

```sql
CREATE TABLE forum_likes (
    id SERIAL PRIMARY KEY,
    target_type VARCHAR(10) NOT NULL CHECK (target_type IN ('post', 'reply')),
    target_id INTEGER NOT NULL,
    user_id VARCHAR(8) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(target_type, target_id, user_id)
);

CREATE INDEX idx_forum_likes_target ON forum_likes(target_type, target_id);
CREATE INDEX idx_forum_likes_user ON forum_likes(user_id);
```

### 5. æ”¶è—è¡¨ï¼ˆforum_favoritesï¼‰

```sql
CREATE TABLE forum_favorites (
    id SERIAL PRIMARY KEY,
    post_id INTEGER NOT NULL REFERENCES forum_posts(id) ON DELETE CASCADE,
    user_id VARCHAR(8) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(post_id, user_id)
);

CREATE INDEX idx_forum_favorites_user ON forum_favorites(user_id, created_at DESC);
CREATE INDEX idx_forum_favorites_post ON forum_favorites(post_id);
```

### 6. é€šçŸ¥è¡¨ï¼ˆforum_notificationsï¼‰

```sql
CREATE TABLE forum_notifications (
    id SERIAL PRIMARY KEY,
    notification_type VARCHAR(20) NOT NULL CHECK (notification_type IN ('reply_post', 'reply_reply', 'like_post', 'feature_post', 'pin_post')),
    target_type VARCHAR(10) NOT NULL CHECK (target_type IN ('post', 'reply')),
    target_id INTEGER NOT NULL,
    from_user_id VARCHAR(8) REFERENCES users(id) ON DELETE SET NULL,
    to_user_id VARCHAR(8) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    is_read BOOLEAN DEFAULT FALSE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_forum_notifications_user ON forum_notifications(to_user_id, is_read, created_at DESC);
CREATE INDEX idx_forum_notifications_target ON forum_notifications(target_type, target_id);
```

**é€šçŸ¥ç±»å‹æ‰©å±•è¯´æ˜**:
- å½“å‰æšä¸¾ï¼š`reply_post`ã€`reply_reply`ã€`like_post`ã€`feature_post`ã€`pin_post`
- **å¦‚éœ€æ–°å¢ç±»å‹**ï¼ˆä¾‹å¦‚ `like_reply`ï¼‰ï¼Œéœ€è¦åŒæ—¶ï¼š
  1. æ›´æ–°æ•°æ®åº“ CheckConstraintï¼š`CHECK (notification_type IN ('reply_post', 'reply_reply', 'like_post', 'feature_post', 'pin_post', 'like_reply'))`
  2. æ›´æ–° Alembic è¿ç§»æ–‡ä»¶ä¸­çš„çº¦æŸå®šä¹‰
  3. æ›´æ–°åç«¯æšä¸¾å’Œå‘é€é€»è¾‘
  4. æ›´æ–°å‰ç«¯æ–‡æ¡ˆå’Œé€šçŸ¥å¤„ç†é€»è¾‘

### 7. ä¸¾æŠ¥è¡¨ï¼ˆforum_reportsï¼‰

```sql
CREATE TABLE forum_reports (
    id SERIAL PRIMARY KEY,
    target_type VARCHAR(10) NOT NULL CHECK (target_type IN ('post', 'reply')),
    target_id INTEGER NOT NULL,
    reporter_id VARCHAR(8) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    reason VARCHAR(50) NOT NULL,  -- ä¸¾æŠ¥åŸå› ï¼šspam/abuse/inappropriate/copyright/otherï¼ˆç”±ä¸šåŠ¡å±‚æ ¡éªŒï¼ŒDBä¸åšæšä¸¾çº¦æŸï¼‰
    description TEXT,
    status VARCHAR(20) DEFAULT 'pending' NOT NULL CHECK (status IN ('pending', 'processed', 'rejected')),
    processor_id VARCHAR(8) REFERENCES users(id) ON DELETE SET NULL,
    processed_at TIMESTAMP WITH TIME ZONE,
    action VARCHAR(50),  -- å¤„ç†åŠ¨ä½œï¼šdelete_post, delete_reply, no_action, warn_user ç­‰ï¼ˆç”¨äºå®¡è®¡è¿½æº¯ï¼‰
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_forum_reports_status ON forum_reports(status, created_at DESC);
CREATE INDEX idx_forum_reports_target ON forum_reports(target_type, target_id);
CREATE INDEX idx_forum_reports_reporter ON forum_reports(reporter_id);

-- é˜²æ­¢åŒä¸€ç”¨æˆ·å¯¹åŒä¸€ç›®æ ‡é‡å¤ä¸¾æŠ¥ï¼ˆä»…é™ pending çŠ¶æ€ï¼‰
-- æ³¨æ„ï¼šPostgreSQL ä¸æ”¯æŒåœ¨è¡¨çº§ UNIQUE çº¦æŸååŠ  WHEREï¼Œå¿…é¡»ä½¿ç”¨éƒ¨åˆ†å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_forum_reports_unique_pending 
ON forum_reports(target_type, target_id, reporter_id) 
WHERE status = 'pending';
```

### 8. æ•°æ®åº“è¿ç§»æ–‡ä»¶

åˆ›å»ºæ–‡ä»¶ï¼š`backend/alembic/versions/xxx_add_forum_tables.py`

```python
"""add forum tables

Revision ID: xxxxx
Revises: previous_revision
Create Date: 2025-01-27
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = 'xxxxx'
down_revision = 'previous_revision'
branch_labels = None
depends_on = None

def upgrade():
    # åˆ›å»ºè®ºå›æ¿å—è¡¨
    op.create_table(
        'forum_categories',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(length=100), nullable=False),
        sa.Column('description', sa.Text(), nullable=True),
        sa.Column('icon', sa.String(length=200), nullable=True),
        sa.Column('sort_order', sa.Integer(), nullable=False, server_default='0'),
        sa.Column('is_visible', sa.Boolean(), nullable=False, server_default=sa.text('true')),
        sa.Column('post_count', sa.Integer(), nullable=False, server_default='0'),
        sa.Column('last_post_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('name')
    )
    op.create_index('idx_forum_categories_visible', 'forum_categories', ['is_visible', 'sort_order'])
    
    # åˆ›å»ºä¸»é¢˜å¸–è¡¨
    op.create_table(
        'forum_posts',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('title', sa.String(length=200), nullable=False),
        sa.Column('content', sa.Text(), nullable=False),
        sa.Column('category_id', sa.Integer(), nullable=False),
        sa.Column('author_id', sa.String(length=8), nullable=False),
        sa.Column('view_count', sa.Integer(), nullable=False, server_default='0'),
        sa.Column('reply_count', sa.Integer(), nullable=False, server_default='0'),
        sa.Column('like_count', sa.Integer(), nullable=False, server_default='0'),
        sa.Column('favorite_count', sa.Integer(), nullable=False, server_default='0'),
        sa.Column('is_pinned', sa.Boolean(), nullable=False, server_default=sa.text('false')),
        sa.Column('is_featured', sa.Boolean(), nullable=False, server_default=sa.text('false')),
        sa.Column('is_locked', sa.Boolean(), nullable=False, server_default=sa.text('false')),
        sa.Column('is_deleted', sa.Boolean(), nullable=False, server_default=sa.text('false')),
        sa.Column('is_visible', sa.Boolean(), nullable=False, server_default=sa.text('true')),  -- é£æ§éšè—å­—æ®µ
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.Column('last_reply_at', sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(['category_id'], ['forum_categories.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['author_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id')
    )
    # æ³¨æ„ï¼šPostgreSQL ç´¢å¼•æ”¯æŒ DESC æ’åºï¼Œä½¿ç”¨ op.execute åˆ›å»ºå¸¦æ’åºçš„ç´¢å¼•ä»¥ä¸å¸¸ç”¨æŸ¥è¯¢å¯¹é½
    # æ³¨æ„ï¼šç´¢å¼•ä¸­åŒ…å« is_visible ä»¥åŒ¹é…æŸ¥è¯¢çº¦å®šï¼ˆWHERE is_deleted = FALSE AND is_visible = TRUEï¼‰
    op.execute("CREATE INDEX idx_forum_posts_author ON forum_posts(author_id, is_deleted, is_visible)")
    op.execute("CREATE INDEX idx_forum_posts_category ON forum_posts(category_id, is_deleted, is_visible, created_at DESC)")
    op.execute("CREATE INDEX idx_forum_posts_pinned ON forum_posts(is_pinned DESC, created_at DESC)")
    op.execute("CREATE INDEX idx_forum_posts_last_reply ON forum_posts(is_deleted, is_visible, last_reply_at DESC NULLS LAST)")
    
    # åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆPostgreSQLï¼‰
    # âš ï¸ æ³¨æ„ï¼š'simple' é…ç½®å¯¹ä¸­æ–‡åˆ†è¯æ•ˆæœè¾ƒå·®
    # æ¨èæ–¹æ¡ˆ1ï¼šä½¿ç”¨ pg_bigm æ‰©å±•ï¼ˆéœ€è¦å…ˆå®‰è£…æ‰©å±•ï¼‰
    # op.execute("CREATE EXTENSION IF NOT EXISTS pg_bigm")
    # op.execute("""
    #     CREATE INDEX idx_forum_posts_search ON forum_posts 
    #     USING GIN(to_tsvector('public.bigm', title || ' ' || content))
    # """)
    # æ¨èæ–¹æ¡ˆ2ï¼šæ¥å…¥ MeiliSearch / Elasticsearchï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
    # å½“å‰ä½¿ç”¨ simple é…ç½®ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆ
    op.execute("""
        CREATE INDEX idx_forum_posts_search ON forum_posts 
        USING GIN(to_tsvector('simple', title || ' ' || content))
    """)
    
    # åˆ›å»ºå›å¤è¡¨
    op.create_table(
        'forum_replies',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('content', sa.Text(), nullable=False),
        sa.Column('post_id', sa.Integer(), nullable=False),
        sa.Column('parent_reply_id', sa.Integer(), nullable=True),
        sa.Column('reply_level', sa.Integer(), nullable=False, server_default='1'),
        sa.Column('author_id', sa.String(length=8), nullable=False),
        sa.Column('like_count', sa.Integer(), nullable=False, server_default='0'),
        sa.Column('is_deleted', sa.Boolean(), nullable=False, server_default=sa.text('false')),
        sa.Column('is_visible', sa.Boolean(), nullable=False, server_default=sa.text('true')),  -- é£æ§éšè—å­—æ®µ
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.ForeignKeyConstraint(['post_id'], ['forum_posts.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['parent_reply_id'], ['forum_replies.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['author_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.CheckConstraint('reply_level BETWEEN 1 AND 3', name='check_reply_level')
    )
    op.create_index('idx_forum_replies_post', 'forum_replies', ['post_id', 'created_at'], postgresql_ops={'created_at': 'ASC'})
    op.create_index('idx_forum_replies_parent', 'forum_replies', ['parent_reply_id'])
    # æ³¨æ„ï¼šç´¢å¼•ä¸­åŒ…å« is_visible ä»¥åŒ¹é…æŸ¥è¯¢çº¦å®šï¼ˆWHERE is_deleted = FALSE AND is_visible = TRUEï¼‰
    op.execute("CREATE INDEX idx_forum_replies_author ON forum_replies(author_id, is_deleted, is_visible)")
    
    # åˆ›å»ºç‚¹èµè¡¨
    # æ³¨æ„ï¼štarget_id æ²¡æœ‰å¤–é”®çº¦æŸï¼ˆå› ä¸ºæ˜¯å¤šæ€å…³è”ï¼‰ï¼Œéœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ä¸­å¤„ç†çº§è”åˆ é™¤
    # åˆ é™¤å¸–å­/å›å¤æ—¶ï¼Œå¿…é¡»åŒæ—¶åˆ é™¤å¯¹åº”çš„ç‚¹èµè®°å½•
    op.create_table(
        'forum_likes',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('target_type', sa.String(length=10), nullable=False),
        sa.Column('target_id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.String(length=8), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('target_type', 'target_id', 'user_id'),
        sa.CheckConstraint("target_type IN ('post', 'reply')", name='check_target_type')
    )
    op.create_index('idx_forum_likes_target', 'forum_likes', ['target_type', 'target_id'])
    op.create_index('idx_forum_likes_user', 'forum_likes', ['user_id'])
    
    # åˆ›å»ºæ”¶è—è¡¨
    op.create_table(
        'forum_favorites',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('post_id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.String(length=8), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.ForeignKeyConstraint(['post_id'], ['forum_posts.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('post_id', 'user_id')
    )
    op.execute("CREATE INDEX idx_forum_favorites_user ON forum_favorites(user_id, created_at DESC)")
    op.create_index('idx_forum_favorites_post', 'forum_favorites', ['post_id'])
    
    # åˆ›å»ºé€šçŸ¥è¡¨
    op.create_table(
        'forum_notifications',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('notification_type', sa.String(length=20), nullable=False),
        sa.Column('target_type', sa.String(length=10), nullable=False),
        sa.Column('target_id', sa.Integer(), nullable=False),
        sa.Column('from_user_id', sa.String(length=8), nullable=True),
        sa.Column('to_user_id', sa.String(length=8), nullable=False),
        sa.Column('is_read', sa.Boolean(), nullable=False, server_default=sa.text('false')),
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.ForeignKeyConstraint(['from_user_id'], ['users.id'], ondelete='SET NULL'),
        sa.ForeignKeyConstraint(['to_user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.CheckConstraint("notification_type IN ('reply_post', 'reply_reply', 'like_post', 'feature_post', 'pin_post')", name='check_notification_type'),
        sa.CheckConstraint("target_type IN ('post', 'reply')", name='check_notification_target_type')
    )
    op.execute("CREATE INDEX idx_forum_notifications_user ON forum_notifications(to_user_id, is_read, created_at DESC)")
    op.create_index('idx_forum_notifications_target', 'forum_notifications', ['target_type', 'target_id'])
    
    # åˆ›å»ºä¸¾æŠ¥è¡¨
    op.create_table(
        'forum_reports',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('target_type', sa.String(length=10), nullable=False),
        sa.Column('target_id', sa.Integer(), nullable=False),
        sa.Column('reporter_id', sa.String(length=8), nullable=False),
        sa.Column('reason', sa.String(length=50), nullable=False),
        sa.Column('description', sa.Text(), nullable=True),
        sa.Column('status', sa.String(length=20), nullable=False, server_default='pending'),
        sa.Column('processor_id', sa.String(length=8), nullable=True),
        sa.Column('processed_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('action', sa.String(length=50), nullable=True),  # å¤„ç†åŠ¨ä½œï¼šç”¨äºå®¡è®¡è¿½æº¯
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.ForeignKeyConstraint(['reporter_id'], ['users.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['processor_id'], ['users.id'], ondelete='SET NULL'),
        sa.PrimaryKeyConstraint('id'),
        sa.CheckConstraint("target_type IN ('post', 'reply')", name='check_report_target_type'),
        sa.CheckConstraint("status IN ('pending', 'processed', 'rejected')", name='check_report_status')
    )
    # åˆ›å»ºéƒ¨åˆ†å”¯ä¸€ç´¢å¼•ï¼šé˜²æ­¢åŒä¸€ç”¨æˆ·å¯¹åŒä¸€ç›®æ ‡çš„ pending ä¸¾æŠ¥é‡å¤
    op.execute("""
        CREATE UNIQUE INDEX idx_forum_reports_unique_pending 
        ON forum_reports(target_type, target_id, reporter_id) 
        WHERE status = 'pending'
    """)
    op.execute("CREATE INDEX idx_forum_reports_status ON forum_reports(status, created_at DESC)")
    op.create_index('idx_forum_reports_target', 'forum_reports', ['target_type', 'target_id'])
    op.create_index('idx_forum_reports_reporter', 'forum_reports', ['reporter_id'])
    
    # åˆ›å»ºè§¦å‘å™¨ï¼šè‡ªåŠ¨æ¸…ç†è½¯åˆ é™¤å¸–å­/å›å¤çš„ç‚¹èµè®°å½•
    op.execute("""
        CREATE OR REPLACE FUNCTION cleanup_post_likes()
        RETURNS TRIGGER AS $$
        BEGIN
            DELETE FROM forum_likes 
            WHERE target_type = 'post' AND target_id = OLD.id;
            RETURN OLD;
        END;
        $$ LANGUAGE plpgsql;
    """)
    
    op.execute("""
        CREATE TRIGGER trigger_cleanup_post_likes
        AFTER UPDATE ON forum_posts
        FOR EACH ROW
        WHEN (OLD.is_deleted = FALSE AND NEW.is_deleted = TRUE)
        EXECUTE FUNCTION cleanup_post_likes();
    """)
    
    op.execute("""
        CREATE OR REPLACE FUNCTION cleanup_reply_likes()
        RETURNS TRIGGER AS $$
        BEGIN
            DELETE FROM forum_likes 
            WHERE target_type = 'reply' AND target_id = OLD.id;
            RETURN OLD;
        END;
        $$ LANGUAGE plpgsql;
    """)
    
    op.execute("""
        CREATE TRIGGER trigger_cleanup_reply_likes
        AFTER UPDATE ON forum_replies
        FOR EACH ROW
        WHEN (OLD.is_deleted = FALSE AND NEW.is_deleted = TRUE)
        EXECUTE FUNCTION cleanup_reply_likes();
    """)

def downgrade():
    # åˆ é™¤è§¦å‘å™¨
    op.execute("DROP TRIGGER IF EXISTS trigger_cleanup_reply_likes ON forum_replies")
    op.execute("DROP FUNCTION IF EXISTS cleanup_reply_likes()")
    op.execute("DROP TRIGGER IF EXISTS trigger_cleanup_post_likes ON forum_posts")
    op.execute("DROP FUNCTION IF EXISTS cleanup_post_likes()")
    
    op.drop_index('idx_forum_reports_reporter', table_name='forum_reports')
    op.drop_index('idx_forum_reports_target', table_name='forum_reports')
    op.drop_index('idx_forum_reports_status', table_name='forum_reports')
    op.drop_index('idx_forum_reports_unique_pending', table_name='forum_reports')
    op.drop_table('forum_reports')
    op.drop_index('idx_forum_notifications_target', table_name='forum_notifications')
    op.drop_index('idx_forum_notifications_user', table_name='forum_notifications')
    op.drop_table('forum_notifications')
    op.drop_index('idx_forum_favorites_post', table_name='forum_favorites')
    op.drop_index('idx_forum_favorites_user', table_name='forum_favorites')
    op.drop_table('forum_favorites')
    op.drop_index('idx_forum_likes_user', table_name='forum_likes')
    op.drop_index('idx_forum_likes_target', table_name='forum_likes')
    op.drop_table('forum_likes')
    op.drop_index('idx_forum_replies_author', table_name='forum_replies')
    op.drop_index('idx_forum_replies_parent', table_name='forum_replies')
    op.drop_index('idx_forum_replies_post', table_name='forum_replies')
    op.drop_table('forum_replies')
    op.drop_index('idx_forum_posts_search', table_name='forum_posts')
    op.drop_index('idx_forum_posts_last_reply', table_name='forum_posts')
    op.drop_index('idx_forum_posts_pinned', table_name='forum_posts')
    op.drop_index('idx_forum_posts_author', table_name='forum_posts')
    op.drop_index('idx_forum_posts_category', table_name='forum_posts')
    op.drop_table('forum_posts')
    op.drop_index('idx_forum_categories_visible', table_name='forum_categories')
    op.drop_table('forum_categories')
```

---

## ğŸ”Œ APIè®¾è®¡

### 1. è®ºå›æ¿å—API

#### è·å–æ¿å—åˆ—è¡¨
```
GET /api/forum/categories
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "categories": [
    {
      "id": 1,
      "name": "æŠ€æœ¯äº¤æµ",
      "description": "åˆ†äº«æŠ€æœ¯ç»éªŒå’Œé—®é¢˜",
      "icon": "https://example.com/icon.png",
      "post_count": 150,
      "last_post_at": "2025-01-27T10:00:00Z"
    }
  ]
}
```

#### è·å–æ¿å—è¯¦æƒ…
```
GET /api/forum/categories/{category_id}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "name": "æŠ€æœ¯äº¤æµ",
  "description": "åˆ†äº«æŠ€æœ¯ç»éªŒå’Œé—®é¢˜",
  "icon": "https://example.com/icon.png",
  "sort_order": 1,
  "is_visible": true,
  "post_count": 150,
  "last_post_at": "2025-01-27T10:00:00Z",
  "created_at": "2025-01-20T00:00:00Z",
  "updated_at": "2025-01-27T10:00:00Z"
}
```

#### åˆ›å»ºæ¿å—ï¼ˆç®¡ç†å‘˜ï¼‰
```
POST /api/forum/categories
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "name": "æŠ€æœ¯äº¤æµ",
  "description": "åˆ†äº«æŠ€æœ¯ç»éªŒå’Œé—®é¢˜",
  "icon": "https://example.com/icon.png",
  "sort_order": 1
}
```

#### æ›´æ–°æ¿å—ï¼ˆç®¡ç†å‘˜ï¼‰
```
PUT /api/forum/categories/{category_id}
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "name": "æŠ€æœ¯äº¤æµï¼ˆæ›´æ–°ï¼‰",
  "description": "æ›´æ–°åçš„æè¿°",
  "icon": "https://example.com/new-icon.png",
  "sort_order": 2,
  "is_visible": true
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "name": "æŠ€æœ¯äº¤æµï¼ˆæ›´æ–°ï¼‰",
  "description": "æ›´æ–°åçš„æè¿°",
  "icon": "https://example.com/new-icon.png",
  "sort_order": 2,
  "is_visible": true,
  "post_count": 150,
  "last_post_at": "2025-01-27T10:00:00Z",
  "updated_at": "2025-01-27T15:00:00Z"
}
```

#### åˆ é™¤æ¿å—ï¼ˆç®¡ç†å‘˜ï¼‰
```
DELETE /api/forum/categories/{category_id}
Authorization: Bearer {admin_token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "message": "æ¿å—åˆ é™¤æˆåŠŸ"
}
```

### 2. ä¸»é¢˜å¸–API

#### è·å–å¸–å­åˆ—è¡¨
```
GET /api/forum/posts?category_id=1&page=1&page_size=20&sort=latest&q=å…³é”®è¯
```

**æŸ¥è¯¢å‚æ•°**:
- `category_id`: æ¿å—IDï¼ˆå¯é€‰ï¼‰
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰
- `sort`: æ’åºæ–¹å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ `last_reply`ï¼Œè¯¦è§ä¸‹æ–¹æ’åºå­—æ®µæ˜ å°„è¡¨ï¼‰
- `q`: æœç´¢å…³é”®è¯ï¼ˆå¯é€‰ï¼Œä½¿ç”¨ç®€å• LIKE æŸ¥è¯¢ï¼Œé€‚ç”¨äºè½»é‡æœç´¢ï¼‰

**æ³¨æ„**: 
- æ­¤æ¥å£çš„ `q` å‚æ•°ä½¿ç”¨ç®€å•çš„ LIKE æŸ¥è¯¢ï¼Œé€‚ç”¨äºè½»é‡çº§æœç´¢åœºæ™¯
- å¦‚éœ€å…¨æ–‡æœç´¢ï¼Œè¯·ä½¿ç”¨ `/api/forum/search` æ¥å£ï¼ˆåŸºäºå…¨æ–‡ç´¢å¼•ï¼Œæ€§èƒ½æ›´å¥½ï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "posts": [
    {
      "id": 1,
      "title": "å¦‚ä½•ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼Ÿ",
      "content_preview": "å†…å®¹é¢„è§ˆï¼ˆå‰200å­—ï¼Œå·²å»é™¤Markdownæ ‡è®°ï¼‰...",
      "category": {
        "id": 1,
        "name": "æŠ€æœ¯äº¤æµ"
      },
      "author": {
        "id": "12345678",
        "name": "å¼ ä¸‰",
        "avatar": "https://example.com/avatar.png"
      },
      "view_count": 100,
      "reply_count": 15,
      "like_count": 25,
      "is_pinned": false,
      "is_featured": true,
      "is_locked": false,
      "created_at": "2025-01-27T10:00:00Z",
      "last_reply_at": "2025-01-27T12:00:00Z"
    }
  ],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

**æ³¨æ„**:
- `content_preview`: åˆ—è¡¨æ¥å£è¿”å›çš„æ˜¯æˆªæ–­åçš„å†…å®¹é¢„è§ˆï¼ˆå‰200å­—ç¬¦ï¼Œå·²å»é™¤Markdownæ ‡è®°ï¼‰ï¼Œä¸è¿”å›å®Œæ•´å†…å®¹ä»¥èŠ‚çœæµé‡å’Œæå‡æ€§èƒ½
- å®Œæ•´å†…å®¹ä»…åœ¨å¸–å­è¯¦æƒ…æ¥å£ä¸­è¿”å›

#### è·å–å¸–å­è¯¦æƒ…
```
GET /api/forum/posts/{post_id}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "title": "å¦‚ä½•ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼Ÿ",
  "content": "å®Œæ•´å†…å®¹...",
  "category": {
    "id": 1,
    "name": "æŠ€æœ¯äº¤æµ"
  },
  "author": {
    "id": "12345678",
    "name": "å¼ ä¸‰",
    "avatar": "https://example.com/avatar.png"
  },
  "view_count": 100,
  "reply_count": 15,
  "like_count": 25,
  "favorite_count": 10,
  "is_pinned": false,
  "is_featured": true,
  "is_locked": false,
  "is_liked": true,
  "is_favorited": false,
  "created_at": "2025-01-27T10:00:00Z",
  "updated_at": "2025-01-27T10:00:00Z",
  "last_reply_at": "2025-01-27T12:00:00Z"
}
```

**æ³¨æ„**:
- `is_liked`: å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµè¯¥å¸–å­ï¼ˆæœªç™»å½•ç”¨æˆ·è¿”å› `false` æˆ–çœç•¥è¯¥å­—æ®µï¼‰
- `is_favorited`: å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²æ”¶è—è¯¥å¸–å­ï¼ˆæœªç™»å½•ç”¨æˆ·è¿”å› `false` æˆ–çœç•¥è¯¥å­—æ®µï¼‰
- è¿™ä¸¤ä¸ªå­—æ®µä¸æ˜¯æ•°æ®åº“å­—æ®µï¼Œè€Œæ˜¯åç«¯æ ¹æ®å½“å‰ç”¨æˆ·åŠ¨æ€è®¡ç®—å¡«å……çš„

#### åˆ›å»ºå¸–å­
```
POST /api/forum/posts
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "å¦‚ä½•ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼Ÿ",
  "content": "å®Œæ•´å†…å®¹...",
  "category_id": 1
}
```

#### æ›´æ–°å¸–å­
```
PUT /api/forum/posts/{post_id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "æ›´æ–°åçš„æ ‡é¢˜",
  "content": "æ›´æ–°åçš„å†…å®¹...",
  "category_id": 1
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "title": "æ›´æ–°åçš„æ ‡é¢˜",
  "content": "æ›´æ–°åçš„å†…å®¹...",
  "category": {
    "id": 1,
    "name": "æŠ€æœ¯äº¤æµ"
  },
  "author": {
    "id": "12345678",
    "name": "å¼ ä¸‰",
    "avatar": "https://example.com/avatar.png"
  },
  "updated_at": "2025-01-27T15:00:00Z"
}
```

#### åˆ é™¤å¸–å­
```
DELETE /api/forum/posts/{post_id}
Authorization: Bearer {token}
```

**è¯´æ˜**:
- å®é™…å®ç°ä¸º**è½¯åˆ é™¤**ï¼šå°† `is_deleted = true`ï¼Œå¹¶è§¦å‘ç‚¹èµæ¸…ç†è§¦å‘å™¨
- è½¯åˆ é™¤çš„å¸–å­åœ¨åˆ—è¡¨ä¸­ä¸å†æ˜¾ç¤ºï¼Œè¯¦æƒ…é¡µè¿”å› 404 æˆ–"è¯¥å¸–å­å·²è¢«åˆ é™¤"æç¤º
- åªæœ‰ä½œè€…æˆ–ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å¸–å­

**å“åº”ç¤ºä¾‹**:
```json
{
  "message": "å¸–å­åˆ é™¤æˆåŠŸ"
}
```

#### ç½®é¡¶å¸–å­ï¼ˆç®¡ç†å‘˜ï¼‰
```
POST /api/forum/posts/{post_id}/pin
Authorization: Bearer {admin_token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "is_pinned": true,
  "message": "å¸–å­å·²ç½®é¡¶"
}
```

#### å–æ¶ˆç½®é¡¶ï¼ˆç®¡ç†å‘˜ï¼‰
```
DELETE /api/forum/posts/{post_id}/pin
Authorization: Bearer {admin_token}
```

#### åŠ ç²¾å¸–å­ï¼ˆç®¡ç†å‘˜ï¼‰
```
POST /api/forum/posts/{post_id}/feature
Authorization: Bearer {admin_token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "is_featured": true,
  "message": "å¸–å­å·²åŠ ç²¾"
}
```

#### å–æ¶ˆåŠ ç²¾ï¼ˆç®¡ç†å‘˜ï¼‰
```
DELETE /api/forum/posts/{post_id}/feature
Authorization: Bearer {admin_token}
```

#### é”å®šå¸–å­ï¼ˆç®¡ç†å‘˜ï¼‰
```
POST /api/forum/posts/{post_id}/lock
Authorization: Bearer {admin_token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "is_locked": true,
  "message": "å¸–å­å·²é”å®š"
}
```

#### è§£é”å¸–å­ï¼ˆç®¡ç†å‘˜ï¼‰
```
DELETE /api/forum/posts/{post_id}/lock
Authorization: Bearer {admin_token}
```

### 3. å›å¤API

#### è·å–å›å¤åˆ—è¡¨
```
GET /api/forum/posts/{post_id}/replies?page=1&page_size=20
```

**åˆ†é¡µè¯´æ˜**:
- âš ï¸ **é‡è¦**: `page` å’Œ `page_size` å‚æ•°**ä»…é’ˆå¯¹ä¸€çº§å›å¤**è¿›è¡Œåˆ†é¡µ
- æ¯ä¸ªä¸€çº§å›å¤ä¼šé™„å¸¦**å®Œæ•´çš„å­å›å¤æ ‘**ï¼ˆæœ€å¤š3å±‚åµŒå¥—ï¼‰
- ä¾‹å¦‚ï¼šå¦‚æœ `page_size=20`ï¼Œè¿”å›20ä¸ªä¸€çº§å›å¤ï¼Œæ¯ä¸ªä¸€çº§å›å¤çš„æ‰€æœ‰å­å›å¤éƒ½ä¼šåŒ…å«åœ¨å†…
- `total` å­—æ®µè¡¨ç¤ºä¸€çº§å›å¤çš„æ€»æ•°ï¼ˆä¸åŒ…æ‹¬å­å›å¤ï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "replies": [
    {
      "id": 1,
      "content": "å›å¤å†…å®¹...",
      "author": {
        "id": "12345678",
        "name": "æå››",
        "avatar": "https://example.com/avatar.png"
      },
      "parent_reply_id": null,
      "reply_level": 1,
      "like_count": 5,
      "is_liked": false,
      "created_at": "2025-01-27T11:00:00Z",
      "replies": [
        {
          "id": 2,
          "content": "åµŒå¥—å›å¤...",
          "author": {
            "id": "87654321",
            "name": "ç‹äº”",
            "avatar": "https://example.com/avatar.png"
          },
          "parent_reply_id": 1,
          "reply_level": 2,
          "like_count": 2,
          "is_liked": false,
          "created_at": "2025-01-27T11:30:00Z"
        }
      ]
    }
  ],
  "total": 15,
  "page": 1,
  "page_size": 20
}
```

#### åˆ›å»ºå›å¤
```
POST /api/forum/posts/{post_id}/replies
Authorization: Bearer {token}
Content-Type: application/json

{
  "content": "å›å¤å†…å®¹...",
  "parent_reply_id": null
}
```

**ä¸šåŠ¡å±‚æ ¡éªŒ**:
- âš ï¸ **å¿…é¡»æ ¡éªŒå›å¤å±‚çº§**: å¦‚æœ `parent_reply_id` ä¸ä¸ºç©ºï¼Œå¿…é¡»æ£€æŸ¥çˆ¶å›å¤çš„ `reply_level < 3`
- å¦‚æœçˆ¶å›å¤çš„ `reply_level >= 3`ï¼Œè¿”å› 403 é”™è¯¯ï¼š
  ```json
  {
    "error": "å›å¤å±‚çº§æœ€å¤šä¸‰å±‚",
    "code": "REPLY_LEVEL_LIMIT"
  }
  ```
- è¿™æ ·å¯ä»¥é¿å…æ•°æ®åº“çº¦æŸé”™è¯¯ï¼Œè¿”å›å‹å¥½çš„ä¸šåŠ¡æç¤º

**å®ç°ç¤ºä¾‹**:
```python
from sqlalchemy import select
from fastapi import HTTPException

async def create_reply(post_id: int, content: str, parent_reply_id: int = None, db: AsyncSession = None):
    # å¦‚æœæ˜¯æŒ‡å®šçˆ¶å›å¤ï¼Œæ£€æŸ¥å±‚çº§
    if parent_reply_id:
        result = await db.execute(
            select(ForumReply).where(ForumReply.id == parent_reply_id)
        )
        parent_reply = result.scalar_one_or_none()
        if not parent_reply:
            raise HTTPException(404, "çˆ¶å›å¤ä¸å­˜åœ¨")
        if parent_reply.reply_level >= 3:
            raise HTTPException(
                status_code=403,
                detail="å›å¤å±‚çº§æœ€å¤šä¸‰å±‚"
            )
        reply_level = parent_reply.reply_level + 1
    else:
        reply_level = 1
    
    # åˆ›å»ºå›å¤
    reply = ForumReply(
        post_id=post_id,
        content=content,
        parent_reply_id=parent_reply_id,
        reply_level=reply_level,
        author_id=current_user.id
    )
    db.add(reply)
    await db.commit()
    return reply
```

#### æ›´æ–°å›å¤
```
PUT /api/forum/replies/{reply_id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "content": "æ›´æ–°åçš„å›å¤å†…å®¹..."
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "content": "æ›´æ–°åçš„å›å¤å†…å®¹...",
  "post_id": 123,
  "author": {
    "id": "12345678",
    "name": "æå››",
    "avatar": "https://example.com/avatar.png"
  },
  "updated_at": "2025-01-27T15:00:00Z"
}
```

#### åˆ é™¤å›å¤
```
DELETE /api/forum/replies/{reply_id}
Authorization: Bearer {token}
```

**è¯´æ˜**:
- å®é™…å®ç°ä¸º**è½¯åˆ é™¤**ï¼šå°† `is_deleted = true`ï¼Œå¹¶è§¦å‘ç‚¹èµæ¸…ç†è§¦å‘å™¨
- è½¯åˆ é™¤çš„å›å¤åœ¨åˆ—è¡¨ä¸­ä¿ç•™ä¸€è¡Œ"è¯¥å›å¤å·²è¢«åˆ é™¤"å ä½ï¼ˆæ–¹ä¾¿ç†è§£æ¥¼å±‚ç»“æ„ï¼‰ï¼Œä½†å†…å®¹ä¸å±•ç¤º
- åªæœ‰ä½œè€…æˆ–ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å›å¤

**å“åº”ç¤ºä¾‹**:
```json
{
  "message": "å›å¤åˆ é™¤æˆåŠŸ"
}
```

### 4. ç‚¹èµAPI

#### ç‚¹èµ/å–æ¶ˆç‚¹èµ
```
POST /api/forum/likes
Authorization: Bearer {token}
Content-Type: application/json

{
  "target_type": "post",
  "target_id": 1
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "liked": true,
  "like_count": 26
}
```

#### è·å–ç‚¹èµåˆ—è¡¨
```
GET /api/forum/posts/{post_id}/likes?page=1&page_size=20
GET /api/forum/replies/{reply_id}/likes?page=1&page_size=20
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "likes": [
    {
      "user": {
        "id": "12345678",
        "name": "å¼ ä¸‰",
        "avatar": "https://example.com/avatar.png"
      },
      "created_at": "2025-01-27T10:00:00Z"
    }
  ],
  "total": 25,
  "page": 1,
  "page_size": 20
}
```

#### è·å–æˆ‘èµè¿‡çš„å†…å®¹
```
GET /api/forum/my/likes?target_type=post&page=1&page_size=20
Authorization: Bearer {token}
```

**æŸ¥è¯¢å‚æ•°**:
- `target_type`: ç›®æ ‡ç±»å‹ï¼ˆ`post` æˆ– `reply`ï¼Œå¯é€‰ï¼Œä¸ä¼ åˆ™è¿”å›æ‰€æœ‰ï¼‰
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "likes": [
    {
      "target_type": "post",
      "post": {
        "id": 123,
        "title": "è¢«ç‚¹èµçš„å¸–å­",
        "content_preview": "å†…å®¹é¢„è§ˆ...",
        "category": {
          "id": 1,
          "name": "æŠ€æœ¯äº¤æµ"
        },
        "author": {
          "id": "87654321",
          "name": "ä½œè€…å",
          "avatar": "https://example.com/avatar.png"
        },
        "view_count": 200,
        "reply_count": 30,
        "like_count": 50,
        "created_at": "2025-01-26T10:00:00Z",
        "last_reply_at": "2025-01-27T12:00:00Z"
      },
      "created_at": "2025-01-27T10:00:00Z"
    },
    {
      "target_type": "reply",
      "reply": {
        "id": 456,
        "content": "è¢«ç‚¹èµçš„å›å¤å†…å®¹...",
        "post": {
          "id": 123,
          "title": "åŸå¸–å­æ ‡é¢˜"
        },
        "author": {
          "id": "11111111",
          "name": "å›å¤ä½œè€…",
          "avatar": "https://example.com/avatar.png"
        },
        "like_count": 10,
        "created_at": "2025-01-27T09:00:00Z"
      },
      "created_at": "2025-01-27T11:00:00Z"
    }
  ],
  "total": 20,
  "page": 1,
  "page_size": 20
}
```

**æ³¨æ„**: 
- å½“ `target_type` ä¸º `post` æ—¶ï¼Œè¿”å› `post` å­—æ®µ
- å½“ `target_type` ä¸º `reply` æ—¶ï¼Œè¿”å› `reply` å­—æ®µ
- å½“ä¸æŒ‡å®š `target_type` æ—¶ï¼Œå¯èƒ½åŒæ—¶åŒ…å« `post` å’Œ `reply` ä¸¤ç§ç±»å‹

### 5. æ”¶è—API

#### æ”¶è—/å–æ¶ˆæ”¶è—
```
POST /api/forum/favorites
Authorization: Bearer {token}
Content-Type: application/json

{
  "post_id": 1
}
```

#### è·å–æ”¶è—åˆ—è¡¨
```
GET /api/forum/favorites?page=1&page_size=20
Authorization: Bearer {token}
```

### 6. æœç´¢API

#### æœç´¢å¸–å­ï¼ˆå…¨æ–‡æœç´¢ï¼‰
```
GET /api/forum/search?q=å…³é”®è¯&category_id=1&sort=latest&page=1&page_size=20
```

**æŸ¥è¯¢å‚æ•°**:
- `q`: æœç´¢å…³é”®è¯ï¼ˆå¿…å¡«ï¼Œç”¨äºå…¨æ–‡æœç´¢ï¼‰
- `category_id`: æ¿å—IDï¼ˆå¯é€‰ï¼‰
- `sort`: æ’åºæ–¹å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ `last_reply`ï¼Œè¯¦è§ä¸‹æ–¹æ’åºå­—æ®µæ˜ å°„è¡¨ï¼‰
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰

**å®ç°è¯´æ˜**:
- **å½“å‰å®ç°**: ä½¿ç”¨ PostgreSQL çš„ `pg_trgm` æ‰©å±•è¿›è¡Œç›¸ä¼¼åº¦æœç´¢
- **æœç´¢æ–¹å¼**: 
  - ä½¿ç”¨ `similarity(title, q) > 0.2` å’Œ `similarity(content, q) > 0.2` è¿›è¡Œç›¸ä¼¼åº¦åŒ¹é…
  - åŒæ—¶ä¿ç•™ `ILIKE` ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œç¡®ä¿èƒ½åŒ¹é…åˆ°ç»“æœ
  - æŒ‰ç›¸ä¼¼åº¦æ’åºï¼ˆæ ‡é¢˜ç›¸ä¼¼åº¦ä¼˜å…ˆï¼Œç„¶åæ˜¯å†…å®¹ç›¸ä¼¼åº¦ï¼‰
- **pg_trgm ä¼˜åŠ¿**:
  - âœ… å¯¹ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—éƒ½æœ‰è‰¯å¥½çš„æ”¯æŒ
  - âœ… æ”¯æŒå®¹é”™æœç´¢ï¼ˆæ‹¼å†™é”™è¯¯ã€éƒ¨åˆ†åŒ¹é…ï¼‰
  - âœ… ä½¿ç”¨ä¸‰å…ƒç»„ï¼ˆtrigramï¼‰è¿›è¡Œç›¸ä¼¼åº¦åŒ¹é…ï¼Œæ•ˆæœä¼˜äº simple é…ç½®
  - âœ… æ€§èƒ½è‰¯å¥½ï¼Œé€‚åˆä¸­å°è§„æ¨¡æ•°æ®
- **é…ç½®è¦æ±‚**:
  - éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡ `USE_PG_TRGM=true` å¯ç”¨ pg_trgm
  - éœ€è¦æ‰§è¡Œè¿ç§»æ–‡ä»¶ `023_add_pg_trgm_for_forum_search.sql` åˆ›å»ºæ‰©å±•å’Œç´¢å¼•
- **é™çº§æ–¹æ¡ˆ**: å¦‚æœæœªå¯ç”¨ `USE_PG_TRGM`ï¼Œå°†ä½¿ç”¨ `ILIKE` æ¨¡ç³Šæœç´¢
- **ä¸ `/api/forum/posts` çš„åŒºåˆ«**:
  - `/api/forum/posts?q=...`: ä½¿ç”¨ç®€å• LIKE æŸ¥è¯¢ï¼Œè½»é‡çº§ï¼Œé€‚åˆç®€å•æœç´¢
  - `/api/forum/search?q=...`: ä½¿ç”¨ pg_trgm ç›¸ä¼¼åº¦æœç´¢ï¼Œæ€§èƒ½æ›´å¥½ï¼Œæ”¯æŒä¸­æ–‡ï¼Œé€‚åˆå¤æ‚æœç´¢åœºæ™¯

**æœªæ¥æ‰©å±•æ–¹æ¡ˆ**:
- **å¤§è§„æ¨¡é˜¶æ®µ**ï¼ˆæ•°æ®é‡ > 100ä¸‡ï¼‰:
  - å¯è€ƒè™‘å¼•å…¥ç‹¬ç«‹æœç´¢æœåŠ¡ï¼ˆMeiliSearch/Elasticsearchï¼‰
  - å†™æ•°æ®æ—¶åŒæ­¥æ¨é€ï¼Œ`/api/forum/search` åˆ‡åˆ°å¤–éƒ¨æœç´¢å¼•æ“
  - pg_trgm ç´¢å¼•ä½œä¸º fallback

### 6.1 æ’åºå­—æ®µæ˜ å°„è¡¨

**ç»Ÿä¸€çš„æ’åºå‚æ•°ä¸æ•°æ®åº“å­—æ®µæ˜ å°„å…³ç³»**:

| sort å‚æ•° | æ’åºå­—æ®µ | è¯´æ˜ |
|-----------|---------|------|
| `latest` | `created_at DESC` | æŒ‰åˆ›å»ºæ—¶é—´é™åºï¼ˆæœ€æ–°å‘å¸ƒï¼‰ |
| `last_reply` | `last_reply_at DESC NULLS LAST` | æŒ‰æœ€åå›å¤æ—¶é—´é™åºï¼ˆæœ€æ–°å›å¤ï¼Œ**é»˜è®¤å€¼**ï¼‰ |
| `hot` | ç»¼åˆè¯„åˆ†ï¼ˆè§ä¸‹æ–¹å…¬å¼ï¼‰ | æŒ‰çƒ­åº¦æ’åº |
| `replies` | `reply_count DESC` | æŒ‰å›å¤æ•°é™åº |
| `likes` | `like_count DESC` | æŒ‰ç‚¹èµæ•°é™åº |

**çƒ­åº¦æ’åºå…¬å¼ï¼ˆsort=hotï¼‰**:

çƒ­åº¦æ’åºä½¿ç”¨ç»¼åˆè¯„åˆ†å…¬å¼ï¼Œåœ¨æ•°æ®åº“æŸ¥è¯¢æ—¶å®æ—¶è®¡ç®—ï¼š

```sql
-- çƒ­åº¦è¯„åˆ†è®¡ç®—å…¬å¼ï¼ˆPostgreSQLï¼‰
SELECT 
    *,
    (
        like_count * 3.0 + 
        reply_count * 2.0 + 
        view_count * 0.1 - 
        EXTRACT(EPOCH FROM (NOW() - created_at)) / 86400.0 * 0.5
    ) AS hot_score
FROM forum_posts
WHERE is_deleted = FALSE AND is_visible = TRUE
ORDER BY hot_score DESC
```

**å…¬å¼è¯´æ˜**:
- `like_count * 3.0`: ç‚¹èµæƒé‡æœ€é«˜
- `reply_count * 2.0`: å›å¤æ•°æƒé‡æ¬¡ä¹‹
- `view_count * 0.1`: æµè§ˆæ•°æƒé‡è¾ƒä½
- `æ—¶é—´è¡°å‡`: æ¯è¿‡ä¸€å¤©çƒ­åº¦è¡°å‡ 0.5 åˆ†

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**:
- å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘åˆ›å»ºç‰©åŒ–è§†å›¾ï¼ˆMaterialized Viewï¼‰å®šæœŸåˆ·æ–°
- æˆ–ä½¿ç”¨ Redis ç¼“å­˜çƒ­é—¨å¸–å­åˆ—è¡¨ï¼Œå®šæ—¶æ›´æ–°

**å®Œæ•´å®ç°æ–¹æ¡ˆï¼ˆæ¨èï¼‰**:

**æ–¹æ¡ˆä¸€ï¼šMaterialized Viewï¼ˆç‰©åŒ–è§†å›¾ï¼‰**

åˆ›å»ºç‰©åŒ–è§†å›¾å­˜å‚¨çƒ­åº¦è¯„åˆ†ï¼Œå®šæœŸåˆ·æ–°ï¼š

```sql
-- 1. åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW forum_posts_hot_score AS
SELECT 
    id,
    category_id,
    author_id,
    title,
    content,
    is_pinned,
    is_featured,
    is_locked,
    is_deleted,
    view_count,
    reply_count,
    like_count,
    favorite_count,
    created_at,
    last_reply_at,
    -- çƒ­åº¦è¯„åˆ†è®¡ç®—ï¼ˆä½¿ç”¨æ”¹è¿›çš„å…¬å¼ï¼‰
    (
        (like_count * 5.0 + 
         reply_count * 3.0 + 
         view_count * 0.1) / 
        POW(EXTRACT(EPOCH FROM (NOW() - created_at)) / 3600.0 + 2.0, 1.5)
    ) AS hot_score
FROM forum_posts
WHERE is_deleted = FALSE AND is_visible = TRUE;

-- 2. åˆ›å»ºç´¢å¼•ä»¥åŠ é€Ÿæ’åºæŸ¥è¯¢
CREATE INDEX idx_forum_posts_hot_score ON forum_posts_hot_score(hot_score DESC);
CREATE INDEX idx_forum_posts_hot_category ON forum_posts_hot_score(category_id, hot_score DESC);

-- 3. åˆ›å»ºåˆ·æ–°å‡½æ•°ï¼ˆå¯è¢« Celery å®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰
CREATE OR REPLACE FUNCTION refresh_forum_posts_hot_score()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY forum_posts_hot_score;
END;
$$ LANGUAGE plpgsql;

-- 4. ä½¿ç”¨ç‰©åŒ–è§†å›¾æŸ¥è¯¢ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
SELECT * FROM forum_posts_hot_score
WHERE category_id = 1  -- å¯é€‰ï¼šæŒ‰æ¿å—ç­›é€‰
ORDER BY hot_score DESC
LIMIT 20;
```

**åˆ·æ–°ç­–ç•¥**:
- ä½¿ç”¨ Celery å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 5-10 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ç‰©åŒ–è§†å›¾
- ä½¿ç”¨ `REFRESH MATERIALIZED VIEW CONCURRENTLY` é¿å…é”è¡¨
- åœ¨å¸–å­è¢«ç‚¹èµ/å›å¤/æµè§ˆåï¼Œå¯ä»¥è§¦å‘å¢é‡æ›´æ–°ï¼ˆå¯é€‰ï¼‰

**æ–¹æ¡ˆäºŒï¼šå®æ—¶è®¡ç®—ï¼ˆé€‚åˆä¸­å°è§„æ¨¡ï¼‰**

å¦‚æœæ•°æ®é‡ä¸å¤§ï¼ˆ< 10ä¸‡å¸–å­ï¼‰ï¼Œå¯ä»¥ç›´æ¥åœ¨æŸ¥è¯¢æ—¶è®¡ç®—ï¼š

```sql
-- å®æ—¶è®¡ç®—çƒ­åº¦è¯„åˆ†ï¼ˆé€‚åˆä¸­å°è§„æ¨¡ï¼‰
SELECT 
    *,
    (
        (like_count * 5.0 + 
         reply_count * 3.0 + 
         view_count * 0.1) / 
        POW(EXTRACT(EPOCH FROM (NOW() - created_at)) / 3600.0 + 2.0, 1.5)
    ) AS hot_score
FROM forum_posts
WHERE is_deleted = FALSE AND is_visible = TRUE
ORDER BY hot_score DESC
LIMIT 20;
```

**æ–¹æ¡ˆä¸‰ï¼šRedis ç¼“å­˜ï¼ˆæ¨èé…åˆæ–¹æ¡ˆä¸€ï¼‰**

å°†çƒ­é—¨å¸–å­åˆ—è¡¨ç¼“å­˜åˆ° Redisï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼š

```python
# ä¼ªä»£ç ç¤ºä¾‹
def get_hot_posts(category_id=None, limit=20):
    cache_key = f"forum:hot_posts:{category_id or 'all'}"
    cached = redis.get(cache_key)
    if cached:
        return json.loads(cached)
    
    # ä»ç‰©åŒ–è§†å›¾æŸ¥è¯¢
    posts = db.execute(
        select(ForumPostHotScore)
        .where(ForumPostHotScore.category_id == category_id if category_id else True)
        .order_by(ForumPostHotScore.hot_score.desc())
        .limit(limit)
    ).scalars().all()
    
    # ç¼“å­˜ 5 åˆ†é’Ÿ
    redis.setex(cache_key, 300, json.dumps([post.to_dict() for post in posts]))
    return posts
```

**å…¬å¼è¯´æ˜**:
- `like_count * 5.0`: ç‚¹èµæƒé‡æœ€é«˜ï¼ˆ5å€ï¼‰
- `reply_count * 3.0`: å›å¤æ•°æƒé‡æ¬¡ä¹‹ï¼ˆ3å€ï¼‰
- `view_count * 0.1`: æµè§ˆæ•°æƒé‡è¾ƒä½ï¼ˆ0.1å€ï¼‰
- `æ—¶é—´è¡°å‡`: ä½¿ç”¨ `POW((å°æ—¶æ•° + 2), 1.5)` è¿›è¡Œæ—¶é—´è¡°å‡ï¼Œæ–°å¸–å­æœ‰åˆå§‹ä¼˜åŠ¿ï¼Œè€å¸–å­é€æ¸è¡°å‡

**æ³¨æ„**: æ‰€æœ‰æ’åºéƒ½åªç»Ÿè®¡ `is_deleted = FALSE AND is_visible = TRUE` çš„å¸–å­

### 7. é€šçŸ¥API

#### è·å–é€šçŸ¥åˆ—è¡¨
```
GET /api/forum/notifications?page=1&page_size=20&unread_only=false
Authorization: Bearer {token}
```

**æŸ¥è¯¢å‚æ•°**:
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰
- `unread_only`: æ˜¯å¦åªè·å–æœªè¯»é€šçŸ¥ï¼ˆé»˜è®¤falseï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "notifications": [
    {
      "id": 1,
      "notification_type": "reply_post",
      "target_type": "post",
      "target_id": 1,
      "from_user": {
        "id": "12345678",
        "name": "æå››",
        "avatar": "https://example.com/avatar.png"
      },
      "is_read": false,
      "created_at": "2025-01-27T11:00:00Z"
    }
  ],
  "total": 10,
  "unread_count": 5,
  "page": 1,
  "page_size": 20
}
```

**å­—æ®µè¯´æ˜**:
- `unread_count`: **è¯¥ç”¨æˆ·æ‰€æœ‰æœªè¯»é€šçŸ¥çš„æ€»æ•°**ï¼ˆä¸æ˜¯å½“å‰é¡µçš„æœªè¯»æ•°ï¼‰ï¼Œç”¨äºå‰ç«¯æ˜¾ç¤ºçº¢ç‚¹æç¤º
- `from_user`: å¯èƒ½ä¸º `null`ï¼ˆä¾‹å¦‚ç³»ç»Ÿé€šçŸ¥ã€å‘é€è€…è´¦å·è¢«åˆ é™¤ç­‰æƒ…å†µï¼‰ï¼Œå‰ç«¯éœ€è¦åšç©ºå€¼å¤„ç†

#### æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
```
PUT /api/forum/notifications/{notification_id}/read
Authorization: Bearer {token}
```

#### æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
```
PUT /api/forum/notifications/read-all
Authorization: Bearer {token}
```

### 8. ä¸¾æŠ¥API

#### ä¸¾æŠ¥å¸–å­/å›å¤
```
POST /api/forum/reports
Authorization: Bearer {token}
Content-Type: application/json

{
  "target_type": "post",
  "target_id": 1,
  "reason": "spam",
  "description": "è¿™æ˜¯åƒåœ¾å†…å®¹"
}
```

**ä¸¾æŠ¥åŸå› ï¼ˆreasonï¼‰**:
- `spam`: åƒåœ¾ä¿¡æ¯
- `abuse`: è¾±éª‚/äººèº«æ”»å‡»
- `inappropriate`: ä¸å½“å†…å®¹
- `copyright`: ç‰ˆæƒé—®é¢˜
- `other`: å…¶ä»–

#### è·å–ä¸¾æŠ¥åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰
```
GET /api/forum/reports?status=pending&page=1&page_size=20
Authorization: Bearer {admin_token}
```

#### å¤„ç†ä¸¾æŠ¥ï¼ˆç®¡ç†å‘˜ï¼‰
```
PUT /api/forum/reports/{report_id}/process
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "status": "processed",
  "action": "delete_post"
}
```

**è¯·æ±‚å‚æ•°**:
- `status`: å¤„ç†çŠ¶æ€ï¼ˆ`processed` æˆ– `rejected`ï¼‰
- `action`: å¤„ç†åŠ¨ä½œï¼ˆå¯é€‰ï¼‰
  - `delete_post`: åˆ é™¤å¸–å­
  - `delete_reply`: åˆ é™¤å›å¤
  - `warn_user`: è­¦å‘Šç”¨æˆ·
  - `no_action`: æ— æ“ä½œ
  - å…¶ä»–è‡ªå®šä¹‰åŠ¨ä½œ

**æ³¨æ„**:
- `action` å­—æ®µä¼šä¿å­˜åˆ°æ•°æ®åº“çš„ `forum_reports.action` å­—æ®µï¼Œç”¨äºå®¡è®¡è¿½æº¯
- å¤„ç†å®Œæˆåï¼Œ`processor_id`ã€`processed_at` ä¼šè‡ªåŠ¨æ›´æ–°

### 9. æˆ‘çš„å†…å®¹API

#### è·å–æˆ‘çš„å¸–å­
```
GET /api/forum/my/posts?page=1&page_size=20
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "posts": [
    {
      "id": 1,
      "title": "æˆ‘çš„å¸–å­æ ‡é¢˜",
      "content_preview": "å†…å®¹é¢„è§ˆ...",
      "category": {
        "id": 1,
        "name": "æŠ€æœ¯äº¤æµ"
      },
      "view_count": 100,
      "reply_count": 15,
      "like_count": 25,
      "created_at": "2025-01-27T10:00:00Z",
      "last_reply_at": "2025-01-27T12:00:00Z"
    }
  ],
  "total": 20,
  "page": 1,
  "page_size": 20
}
```

#### è·å–æˆ‘çš„å›å¤
```
GET /api/forum/my/replies?page=1&page_size=20
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "replies": [
    {
      "id": 1,
      "content": "æˆ‘çš„å›å¤å†…å®¹...",
      "post": {
        "id": 123,
        "title": "åŸå¸–å­æ ‡é¢˜",
        "category": {
          "id": 1,
          "name": "æŠ€æœ¯äº¤æµ"
        }
      },
      "parent_reply_id": null,
      "reply_level": 1,
      "like_count": 5,
      "created_at": "2025-01-27T11:00:00Z"
    }
  ],
  "total": 15,
  "page": 1,
  "page_size": 20
}
```

#### è·å–æˆ‘çš„æ”¶è—
```
GET /api/forum/favorites?page=1&page_size=20
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "favorites": [
    {
      "id": 1,
      "post": {
        "id": 123,
        "title": "æ”¶è—çš„å¸–å­æ ‡é¢˜",
        "content_preview": "å†…å®¹é¢„è§ˆ...",
        "category": {
          "id": 1,
          "name": "æŠ€æœ¯äº¤æµ"
        },
        "author": {
          "id": "87654321",
          "name": "ä½œè€…å",
          "avatar": "https://example.com/avatar.png"
        },
        "view_count": 200,
        "reply_count": 30,
        "like_count": 50,
        "created_at": "2025-01-26T10:00:00Z",
        "last_reply_at": "2025-01-27T12:00:00Z"
      },
      "created_at": "2025-01-27T09:00:00Z"
    }
  ],
  "total": 10,
  "page": 1,
  "page_size": 20
}
```

---

## ğŸ¨ å‰ç«¯è®¾è®¡

### 1. é¡µé¢ç»“æ„

```
/forum
  â”œâ”€â”€ /forum                    # è®ºå›é¦–é¡µï¼ˆæ¿å—åˆ—è¡¨ï¼‰
  â”œâ”€â”€ /forum/category/:id       # æ¿å—è¯¦æƒ…é¡µï¼ˆå¸–å­åˆ—è¡¨ï¼‰
  â”œâ”€â”€ /forum/post/:id           # å¸–å­è¯¦æƒ…é¡µ
  â”œâ”€â”€ /forum/post/new           # å‘å¸ƒæ–°å¸–
  â”œâ”€â”€ /forum/post/:id/edit      # ç¼–è¾‘å¸–å­
  â”œâ”€â”€ /forum/search              # æœç´¢ç»“æœé¡µ
  â”œâ”€â”€ /forum/notifications       # é€šçŸ¥åˆ—è¡¨é¡µ
  â””â”€â”€ /forum/my                  # æˆ‘çš„å¸–å­/å›å¤/æ”¶è—
```

### 2. ç»„ä»¶è®¾è®¡

#### ForumHomePageï¼ˆè®ºå›é¦–é¡µï¼‰
- æ¿å—åˆ—è¡¨å±•ç¤º
- çƒ­é—¨å¸–å­æ¨è
- æœ€æ–°å¸–å­åˆ—è¡¨

#### CategoryPageï¼ˆæ¿å—é¡µï¼‰
- æ¿å—ä¿¡æ¯
- å¸–å­åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰å’Œæ’åºï¼‰
- å‘å¸ƒæ–°å¸–æŒ‰é’®

#### PostDetailPageï¼ˆå¸–å­è¯¦æƒ…é¡µï¼‰
- å¸–å­å†…å®¹å±•ç¤º
- å›å¤åˆ—è¡¨ï¼ˆæ”¯æŒåµŒå¥—æ˜¾ç¤ºï¼‰
- å›å¤è¾“å…¥æ¡†
- ç‚¹èµ/æ”¶è—æŒ‰é’®
- ç¼–è¾‘/åˆ é™¤æŒ‰é’®ï¼ˆä»…ä½œè€…å¯è§ï¼‰

#### PostEditorï¼ˆå¸–å­ç¼–è¾‘å™¨ï¼‰
- æ ‡é¢˜è¾“å…¥
- å†…å®¹ç¼–è¾‘å™¨ï¼ˆæ”¯æŒMarkdownï¼‰
- æ¿å—é€‰æ‹©
- å‘å¸ƒ/ä¿å­˜æŒ‰é’®

#### ReplyListï¼ˆå›å¤åˆ—è¡¨ï¼‰
- å›å¤é¡¹ç»„ä»¶
- åµŒå¥—å›å¤å±•ç¤º
- åˆ†é¡µåŠ è½½

#### ReplyEditorï¼ˆå›å¤ç¼–è¾‘å™¨ï¼‰
- å›å¤è¾“å…¥æ¡†
- æ”¯æŒå¼•ç”¨å›å¤
- æäº¤æŒ‰é’®

#### ForumSearchPageï¼ˆæœç´¢ç»“æœé¡µï¼‰
- æœç´¢è¾“å…¥æ¡†
- æœç´¢ç»“æœåˆ—è¡¨
- ç­›é€‰å’Œæ’åºé€‰é¡¹

#### NotificationListPageï¼ˆé€šçŸ¥åˆ—è¡¨é¡µï¼‰
- é€šçŸ¥åˆ—è¡¨å±•ç¤º
- æœªè¯»/å·²è¯»ç­›é€‰
- æ ‡è®°å·²è¯»åŠŸèƒ½

### 3. çŠ¶æ€ç®¡ç†

ä½¿ç”¨ React Query ç®¡ç†æ•°æ®ï¼š
- å¸–å­åˆ—è¡¨ç¼“å­˜
- å¸–å­è¯¦æƒ…ç¼“å­˜
- å›å¤åˆ—è¡¨ç¼“å­˜
- ç‚¹èµ/æ”¶è—çŠ¶æ€

### 4. UI/UX è®¾è®¡è¦ç‚¹

- **å“åº”å¼è®¾è®¡**: æ”¯æŒç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
- **åŠ è½½çŠ¶æ€**: æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
- **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯æç¤º
- **åˆ†é¡µåŠ è½½**: æ”¯æŒæ— é™æ»šåŠ¨æˆ–åˆ†é¡µ
- **å®æ—¶æ›´æ–°**: æ–°å›å¤å®æ—¶æ˜¾ç¤º
- **Markdownæ¸²æŸ“**: æ”¯æŒMarkdownæ ¼å¼å†…å®¹
  - **å®‰å…¨æ¸²æŸ“**: å¿…é¡»ä½¿ç”¨å®‰å…¨æ¨¡å¼ï¼Œå¯¹HTMLæ ‡ç­¾åšç™½åå•è¿‡æ»¤ï¼Œé˜²æ­¢XSSæ”»å‡»
  - æ¨èä½¿ç”¨ `DOMPurify` æˆ–ç±»ä¼¼åº“è¿›è¡Œå†…å®¹æ¸…ç†

### 4.1 å¸–å­çŠ¶æ€çŸ©é˜µè¡¨ï¼ˆå‰ç«¯å‚è€ƒï¼‰

**ç”¨æˆ·è§’è‰² Ã— å¸–å­çŠ¶æ€ Ã— å¯è§æ€§è§„åˆ™**:

| ç”¨æˆ·è§’è‰² | å¸–å­çŠ¶æ€ | åˆ—è¡¨ä¸­æ˜¾ç¤º | è¯¦æƒ…é¡µå¯è§ | å¯å›å¤ | å¯ç¼–è¾‘ | å¯åˆ é™¤ |
|---------|---------|-----------|-----------|--------|--------|--------|
| æ™®é€šç”¨æˆ· | æ­£å¸¸ï¼ˆ`is_deleted=FALSE, is_visible=TRUE, is_locked=FALSE`ï¼‰ | âœ… | âœ… | âœ… | âŒ | âŒ |
| æ™®é€šç”¨æˆ· | å·²é”å®šï¼ˆ`is_locked=TRUE`ï¼‰ | âœ… | âœ… | âŒ | âŒ | âŒ |
| æ™®é€šç”¨æˆ· | å·²éšè—ï¼ˆ`is_visible=FALSE`ï¼‰ | âŒ | âŒ | âŒ | âŒ | âŒ |
| æ™®é€šç”¨æˆ· | å·²åˆ é™¤ï¼ˆ`is_deleted=TRUE`ï¼‰ | âŒ | âŒï¼ˆ404ï¼‰ | âŒ | âŒ | âŒ |
| å¸–å­ä½œè€… | æ­£å¸¸ | âœ… | âœ… | âœ… | âœ… | âœ… |
| å¸–å­ä½œè€… | å·²é”å®š | âœ… | âœ… | âŒ | âœ… | âœ… |
| å¸–å­ä½œè€… | å·²éšè— | âœ… | âœ…ï¼ˆæ˜¾ç¤º"ä»…è‡ªå·±å¯è§"ï¼‰ | âŒ | âœ… | âœ… |
| å¸–å­ä½œè€… | å·²åˆ é™¤ | âŒ | âŒï¼ˆ404ï¼‰ | âŒ | âŒ | âŒ |
| ç®¡ç†å‘˜ | æ­£å¸¸ | âœ… | âœ… | âœ… | âœ… | âœ… |
| ç®¡ç†å‘˜ | å·²é”å®š | âœ… | âœ… | âŒ | âœ… | âœ… |
| ç®¡ç†å‘˜ | å·²éšè— | âœ… | âœ…ï¼ˆæ˜¾ç¤º"å·²éšè—"æ ‡è®°ï¼‰ | âŒ | âœ… | âœ… |
| ç®¡ç†å‘˜ | å·²åˆ é™¤ | âŒ | âœ…ï¼ˆæ˜¾ç¤º"å·²åˆ é™¤"æ ‡è®°ï¼‰ | âŒ | âœ… | âœ… |

**è¯´æ˜**:
- **åˆ—è¡¨ä¸­æ˜¾ç¤º**: æ˜¯å¦åœ¨å¸–å­åˆ—è¡¨ä¸­å‡ºç°
- **è¯¦æƒ…é¡µå¯è§**: æ˜¯å¦å¯ä»¥è®¿é—®å¸–å­è¯¦æƒ…é¡µï¼ˆæ™®é€šç”¨æˆ·è®¿é—®éšè—/åˆ é™¤å†…å®¹è¿”å› 404ï¼‰
- **å¯å›å¤**: æ˜¯å¦å¯ä»¥åˆ›å»ºæ–°å›å¤ï¼ˆé”å®šåç¦æ­¢ï¼‰
- **å¯ç¼–è¾‘**: æ˜¯å¦å¯ä»¥ç¼–è¾‘å¸–å­å†…å®¹ï¼ˆåªæœ‰ä½œè€…å’Œç®¡ç†å‘˜ï¼‰
- **å¯åˆ é™¤**: æ˜¯å¦å¯ä»¥åˆ é™¤å¸–å­ï¼ˆåªæœ‰ä½œè€…å’Œç®¡ç†å‘˜ï¼‰

### 5. åµŒå¥—å›å¤å®ç°

**å®ç°æ–¹å¼**:
- APIè¿”å›æ—¶ï¼Œåç«¯ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰å›å¤ï¼Œåœ¨ä»£ç ä¸­ç»„è£…æˆæ ‘å½¢ç»“æ„
- é¿å…åœ¨åç«¯åšå¤§é‡é€’å½’æŸ¥è¯¢ï¼Œä½¿ç”¨å•æ¬¡æŸ¥è¯¢ + å†…å­˜ç»„è£…çš„æ–¹å¼
- å‰ç«¯æ¥æ”¶åˆ°åµŒå¥—å¥½çš„ `replies: []` æ•°ç»„ï¼Œç›´æ¥æ¸²æŸ“å³å¯

**ç¤ºä¾‹æ•°æ®ç»“æ„**:
```json
{
  "replies": [
    {
      "id": 1,
      "content": "ä¸€çº§å›å¤",
      "replies": [
        {
          "id": 2,
          "content": "äºŒçº§å›å¤",
          "replies": [
            {
              "id": 3,
              "content": "ä¸‰çº§å›å¤",
              "replies": []  // æœ€å¤š3å±‚
            }
          ]
        }
      ]
    }
  ]
}
```

---

## ğŸ› ï¸ å¼€å‘æ­¥éª¤

### é˜¶æ®µä¸€ï¼šæ•°æ®åº“å’Œæ¨¡å‹ï¼ˆ1-2å¤©ï¼‰

1. **åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶**
   - åˆ›å»ºæ‰€æœ‰è®ºå›ç›¸å…³è¡¨
   - æ·»åŠ ç´¢å¼•å’Œçº¦æŸ
   - æµ‹è¯•è¿ç§»è„šæœ¬

2. **åˆ›å»ºSQLAlchemyæ¨¡å‹**
   - `ForumCategory` æ¨¡å‹
   - `ForumPost` æ¨¡å‹
   - `ForumReply` æ¨¡å‹
   - `ForumLike` æ¨¡å‹
   - `ForumFavorite` æ¨¡å‹
   - `ForumNotification` æ¨¡å‹
   - `ForumReport` æ¨¡å‹

3. **åˆ›å»ºPydantic Schemas**
   - è¯·æ±‚schemas
   - å“åº”schemas
   - éªŒè¯è§„åˆ™

### é˜¶æ®µäºŒï¼šåç«¯APIå¼€å‘ï¼ˆ3-4å¤©ï¼‰

1. **åˆ›å»ºè·¯ç”±æ–‡ä»¶**
   - `backend/app/forum_routes.py`

2. **å®ç°CRUDæ“ä½œ**
   - æ¿å—CRUD
   - å¸–å­CRUD
   - å›å¤CRUD
   - ç‚¹èµ/æ”¶è—æ“ä½œ

3. **å®ç°ä¸šåŠ¡é€»è¾‘**
   - å¸–å­ç»Ÿè®¡æ›´æ–°ï¼ˆå›å¤æ•°ã€ç‚¹èµæ•°ç­‰ï¼‰
   - æœç´¢åŠŸèƒ½
   - æƒé™æ£€æŸ¥
   - è½¯åˆ é™¤é€»è¾‘

4. **é›†æˆåˆ°ä¸»åº”ç”¨**
   - åœ¨ `main.py` ä¸­æ³¨å†Œè·¯ç”±
   - æ·»åŠ æƒé™ä¾èµ–

### é˜¶æ®µä¸‰ï¼šå‰ç«¯å¼€å‘ï¼ˆ4-5å¤©ï¼‰

1. **åˆ›å»ºé¡µé¢ç»„ä»¶**
   - è®ºå›é¦–é¡µ
   - æ¿å—é¡µ
   - å¸–å­è¯¦æƒ…é¡µ
   - å¸–å­ç¼–è¾‘é¡µ

2. **åˆ›å»ºé€šç”¨ç»„ä»¶**
   - å¸–å­å¡ç‰‡
   - å›å¤é¡¹
   - ç¼–è¾‘å™¨
   - ç‚¹èµ/æ”¶è—æŒ‰é’®

3. **å®ç°APIè°ƒç”¨**
   - åˆ›å»ºAPIæœåŠ¡æ–‡ä»¶
   - ä½¿ç”¨React Queryç®¡ç†æ•°æ®

4. **å®ç°è·¯ç”±**
   - é…ç½®React Router
   - æ·»åŠ å¯¼èˆªé“¾æ¥

### é˜¶æ®µå››ï¼šåŠŸèƒ½å®Œå–„ï¼ˆ2-3å¤©ï¼‰

1. **æœç´¢åŠŸèƒ½**
   - å…¨æ–‡æœç´¢
   - ç­›é€‰å’Œæ’åº

2. **é€šçŸ¥åŠŸèƒ½**
   - å›å¤é€šçŸ¥
   - ç‚¹èµé€šçŸ¥ï¼ˆé€šè¿‡é…ç½®å¼€å…³æ§åˆ¶æ˜¯å¦å¯ç”¨ï¼‰

3. **ç®¡ç†åŠŸèƒ½**
   - å¸–å­ç½®é¡¶/åŠ ç²¾/é”å®š
   - æ¿å—ç®¡ç†

### é˜¶æ®µäº”ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰

1. **å•å…ƒæµ‹è¯•**
   - APIæµ‹è¯•
   - ä¸šåŠ¡é€»è¾‘æµ‹è¯•

2. **é›†æˆæµ‹è¯•**
   - ç«¯åˆ°ç«¯æµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

3. **ä¼˜åŒ–**
   - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥
   - å‰ç«¯æ€§èƒ½ä¼˜åŒ–

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

#### åç«¯æµ‹è¯•
- æ¨¡å‹éªŒè¯æµ‹è¯•
- APIç«¯ç‚¹æµ‹è¯•
- ä¸šåŠ¡é€»è¾‘æµ‹è¯•
- æƒé™æ£€æŸ¥æµ‹è¯•

#### å‰ç«¯æµ‹è¯•
- ç»„ä»¶æ¸²æŸ“æµ‹è¯•
- ç”¨æˆ·äº¤äº’æµ‹è¯•
- APIè°ƒç”¨æµ‹è¯•

### 2. é›†æˆæµ‹è¯•

- å®Œæ•´çš„ç”¨æˆ·æµç¨‹æµ‹è¯•
- å¹¶å‘æ“ä½œæµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•

### 3. æ€§èƒ½æµ‹è¯•

- å¤§é‡æ•°æ®åŠ è½½æµ‹è¯•
- æœç´¢æ€§èƒ½æµ‹è¯•
- å¹¶å‘è¯·æ±‚æµ‹è¯•

### 4. å®‰å…¨æµ‹è¯•

- SQLæ³¨å…¥æµ‹è¯•
- XSSæ”»å‡»æµ‹è¯•
- CSRFä¿æŠ¤æµ‹è¯•
- æƒé™ç»•è¿‡æµ‹è¯•

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. æ•°æ®åº“è¿ç§»

```bash
# åœ¨Railwayæˆ–æœ¬åœ°ç¯å¢ƒè¿è¡Œè¿ç§»
cd backend
alembic upgrade head
```

**å¯ç”¨ pg_trgm æœç´¢**ï¼ˆæ¨èï¼‰:
```bash
# æ‰§è¡Œ pg_trgm æ‰©å±•è¿ç§»
psql $DATABASE_URL -f migrations/023_add_pg_trgm_for_forum_search.sql

# æˆ–è€…å¦‚æœä½¿ç”¨è‡ªåŠ¨è¿ç§»ï¼Œç¡®ä¿è¿ç§»æ–‡ä»¶å·²æ‰§è¡Œ
# è¿ç§»æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»º pg_trgm æ‰©å±•å’Œç´¢å¼•
```

**éªŒè¯ pg_trgm æ‰©å±•**:
```sql
-- æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²å®‰è£…
SELECT * FROM pg_extension WHERE extname = 'pg_trgm';

-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦å·²åˆ›å»º
SELECT indexname FROM pg_indexes 
WHERE tablename = 'forum_posts' 
AND indexname LIKE '%trgm%';
```

### 2. ç¯å¢ƒå˜é‡

**å¿…éœ€çš„ç¯å¢ƒå˜é‡**:
- `REDIS_URL`: Redis è¿æ¥åœ°å€ï¼ˆç”¨äºç¼“å­˜ã€è®¡æ•°å’Œ Celery æ¶ˆæ¯é˜Ÿåˆ—/ç»“æœå­˜å‚¨ï¼‰

**å¯é€‰çš„ç¯å¢ƒå˜é‡**:
- `USE_PG_TRGM`: æ˜¯å¦å¯ç”¨ pg_trgm æ‰©å±•è¿›è¡Œç›¸ä¼¼åº¦æœç´¢ï¼ˆé»˜è®¤ `false`ï¼Œå»ºè®®è®¾ç½®ä¸º `true`ï¼‰
  - è®¾ç½®ä¸º `true` æ—¶ï¼Œæœç´¢APIå°†ä½¿ç”¨ pg_trgm ç›¸ä¼¼åº¦æœç´¢ï¼Œå¯¹ä¸­æ–‡æ”¯æŒæ›´å¥½
  - è®¾ç½®ä¸º `false` æ—¶ï¼Œå°†ä½¿ç”¨ `ILIKE` æ¨¡ç³Šæœç´¢ä½œä¸ºé™çº§æ–¹æ¡ˆ

**è¯´æ˜**:
- Redis ç”¨äºç¼“å­˜æ¿å—åˆ—è¡¨ã€çƒ­é—¨å¸–å­ã€å¸–å­è¯¦æƒ…ç­‰ï¼Œä»¥åŠæµè§ˆæ•°è®¡æ•°
- Celery ä½¿ç”¨ `REDIS_URL` ä½œä¸º broker å’Œ backendï¼ˆé¡¹ç›®å·²æœ‰ Celery é…ç½®ï¼Œæ— éœ€é¢å¤–ç¯å¢ƒå˜é‡ï¼‰
- Celery ç”¨äºå¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼Œå¦‚æµè§ˆæ•°æ‰¹é‡è½åº“ã€é€šçŸ¥å‘é€ç­‰
- **pg_trgm æ‰©å±•**: å¦‚æœå¯ç”¨ `USE_PG_TRGM=true`ï¼Œéœ€è¦æ‰§è¡Œè¿ç§»æ–‡ä»¶ `023_add_pg_trgm_for_forum_search.sql` åˆ›å»ºæ‰©å±•å’Œç´¢å¼•

### 3. åˆå§‹åŒ–æ•°æ®

åˆ›å»ºåˆå§‹æ¿å—æ•°æ®ï¼ˆå¯é€‰ï¼‰ï¼š

```python
# backend/scripts/init_forum_categories.py
from app.database import get_async_db
from app.models import ForumCategory

async def init_categories():
    async for db in get_async_db():
        categories = [
            ForumCategory(name="æŠ€æœ¯äº¤æµ", description="åˆ†äº«æŠ€æœ¯ç»éªŒå’Œé—®é¢˜", sort_order=1),
            ForumCategory(name="ç”Ÿæ´»åˆ†äº«", description="åˆ†äº«ç”Ÿæ´»ç‚¹æ»´", sort_order=2),
            ForumCategory(name="é—®ç­”æ±‚åŠ©", description="æœ‰é—®é¢˜ï¼Ÿæ¥è¿™é‡Œæ±‚åŠ©", sort_order=3),
        ]
        db.add_all(categories)
        await db.commit()
```

### 4. éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] APIç«¯ç‚¹æ­£å¸¸å“åº”
- [ ] å‰ç«¯é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] æƒé™æ£€æŸ¥æ­£å¸¸
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

- **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- **åˆ†é¡µæŸ¥è¯¢**: ä½¿ç”¨LIMITå’ŒOFFSETè¿›è¡Œåˆ†é¡µï¼ˆè¯¦è§ä¸‹æ–¹åˆ†é¡µç­–ç•¥è¯´æ˜ï¼‰
- **å…¨æ–‡æœç´¢**: ä½¿ç”¨PostgreSQLçš„å…¨æ–‡æœç´¢åŠŸèƒ½
- **ç»Ÿè®¡å­—æ®µ**: ä½¿ç”¨å†—ä½™å­—æ®µå­˜å‚¨ç»Ÿè®¡æ•°æ®ï¼Œé¿å…å®æ—¶è®¡ç®—

**åˆ†é¡µç­–ç•¥æ¨èä½¿ç”¨åœºæ™¯**:
- **åˆ—è¡¨é¡µï¼ˆç”¨æˆ·æŒ‰æ—¶é—´/æ¿å—æµè§ˆï¼‰**: æ•°æ®é‡å¤§æ—¶æ¨èä½¿ç”¨ **Keyset Paginationï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰**
- **æœç´¢ç»“æœ**: ä¸ºå…¼å®¹è·³è½¬åˆ°ä»»æ„é¡µï¼Œå¯ä»¥æš‚æ—¶ä¿ç•™ **LIMIT/OFFSET**
- **"æˆ‘çš„å¸–å­/å›å¤/æ”¶è—"**: ä¸€èˆ¬æ•°æ®é‡ä¸ä¼šç‰¹åˆ«å¤§ï¼Œç”¨ **OFFSET** è¶³å¤Ÿ

### 2. ç¼“å­˜ç­–ç•¥

- **æ¿å—åˆ—è¡¨ç¼“å­˜**: Redisç¼“å­˜æ¿å—åˆ—è¡¨ï¼ˆTTL: 1å°æ—¶ï¼‰
- **çƒ­é—¨å¸–å­ç¼“å­˜**: Redisç¼“å­˜çƒ­é—¨å¸–å­ï¼ˆTTL: 30åˆ†é’Ÿï¼‰
- **å¸–å­è¯¦æƒ…ç¼“å­˜**: Redisç¼“å­˜å¸–å­è¯¦æƒ…ï¼ˆTTL: 10åˆ†é’Ÿï¼‰

### 2.1 è®¡æ•°å­—æ®µçš„å†™å…¥çƒ­ç‚¹ä¼˜åŒ–

**é—®é¢˜**: `view_count`ã€`reply_count`ã€`like_count`ã€`favorite_count` ç­‰è®¡æ•°å­—æ®µåœ¨é«˜å¹¶å‘ä¸‹å®¹æ˜“å½¢æˆ"çƒ­ç‚¹è¡Œ"ã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. **æµè§ˆæ•°ï¼ˆview_countï¼‰**:
   - åœ¨ Redis ä¸­ç´¯åŠ æµè§ˆæ•°ï¼Œä½¿ç”¨ `INCR` å‘½ä»¤
   - å®šæ—¶æ‰¹é‡è½åº“ï¼ˆä¾‹å¦‚æ¯5åˆ†é’Ÿæˆ–æ¯100æ¬¡æµè§ˆï¼‰
   - ä½¿ç”¨ Celery å¼‚æ­¥ä»»åŠ¡å®šæœŸåŒæ­¥åˆ°æ•°æ®åº“

2. **ç‚¹èµæ•°/æ”¶è—æ•°ï¼ˆlike_count/favorite_countï¼‰**:
   - ä½¿ç”¨ Redis è®¡æ•°å™¨ç´¯åŠ ï¼Œä½¿ç”¨ `INCR` å‘½ä»¤
   - å®šæ—¶æ‰¹é‡è½åº“ï¼ˆä¾‹å¦‚æ¯5åˆ†é’Ÿæˆ–æ¯100æ¬¡æ“ä½œï¼‰
   - ä½¿ç”¨ Celery å¼‚æ­¥ä»»åŠ¡å®šæœŸåŒæ­¥åˆ°æ•°æ®åº“
   - é…åˆä¹è§‚é”ç­–ç•¥ï¼Œé¿å…å¹¶å‘å†²çª

3. **å›å¤æ•°ï¼ˆreply_countï¼‰**:
   - åœ¨åˆ›å»º/åˆ é™¤å›å¤æ—¶ç›´æ¥æ›´æ–°ï¼ˆå› ä¸ºé¢‘ç‡ç›¸å¯¹è¾ƒä½ï¼‰
   - ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§
   - å®šæœŸæ ¡éªŒå’Œä¿®å¤ï¼ˆé˜²æ­¢æ•°æ®ä¸ä¸€è‡´ï¼‰

### 3. å‰ç«¯ä¼˜åŒ–

- **è™šæ‹Ÿæ»šåŠ¨**: é•¿åˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
- **æ‡’åŠ è½½**: å›¾ç‰‡å’Œå†…å®¹æ‡’åŠ è½½
- **ä»£ç åˆ†å‰²**: è·¯ç”±çº§åˆ«çš„ä»£ç åˆ†å‰²
- **é˜²æŠ–èŠ‚æµ**: æœç´¢å’Œæ»šåŠ¨äº‹ä»¶ä½¿ç”¨é˜²æŠ–èŠ‚æµ

### 4. æŸ¥è¯¢ä¼˜åŒ–

- **N+1æŸ¥è¯¢é—®é¢˜**: ä½¿ç”¨JOINæˆ–æ‰¹é‡æŸ¥è¯¢é¿å…N+1é—®é¢˜
- **åªæŸ¥è¯¢å¿…è¦å­—æ®µ**: åˆ—è¡¨æŸ¥è¯¢ä¸åŒ…å«å®Œæ•´å†…å®¹ï¼ˆè¿”å› `content_preview` è€Œéå®Œæ•´ `content`ï¼‰
- **ä½¿ç”¨é¢„åŠ è½½**: SQLAlchemyçš„joinedloadæˆ–selectinload
- **åµŒå¥—å›å¤ä¼˜åŒ–**: ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰å›å¤ï¼Œåœ¨ä»£ç ä¸­ç»„è£…æ ‘å½¢ç»“æ„ï¼Œé¿å…é€’å½’æŸ¥è¯¢

### 5. ç‚¹èµè®°å½•çš„çº§è”åˆ é™¤

è¯¦è§ã€Œé‡è¦å®ç°æ³¨æ„äº‹é¡¹ - 5. ç‚¹èµè®°å½•çš„çº§è”åˆ é™¤ã€ç« èŠ‚ã€‚

**æ¸…ç†ä»»åŠ¡**:
- å®šæœŸè¿è¡Œæ¸…ç†ä»»åŠ¡ï¼Œåˆ é™¤æ— æ•ˆçš„ç‚¹èµè®°å½•ï¼ˆä½¿ç”¨ Celery å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼‰

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯

- **å†…å®¹è¿‡æ»¤**: è¿‡æ»¤XSSæ”»å‡»ä»£ç 
- **é•¿åº¦é™åˆ¶**: æ ‡é¢˜å’Œå†…å®¹é•¿åº¦é™åˆ¶
- **Markdownå®‰å…¨**: å®‰å…¨æ¸²æŸ“Markdownå†…å®¹
  - **å¿…é¡»ä½¿ç”¨å®‰å…¨æ¨¡å¼**: å¯¹HTMLæ ‡ç­¾åšç™½åå•è¿‡æ»¤
  - æ¨èä½¿ç”¨ `DOMPurify` æˆ– `bleach` ç­‰åº“è¿›è¡Œå†…å®¹æ¸…ç†
  - ç¦æ­¢æ‰§è¡ŒJavaScriptä»£ç 
  - åªå…è®¸å®‰å…¨çš„HTMLæ ‡ç­¾å’Œå±æ€§ï¼ˆå¦‚ `<p>`, `<strong>`, `<em>`, `<code>`, `<pre>` ç­‰ï¼‰

### 2. æƒé™æ§åˆ¶

- **åˆ›å»ºæƒé™**: åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥åˆ›å»ºå¸–å­
- **ç¼–è¾‘æƒé™**: åªæœ‰ä½œè€…å¯ä»¥ç¼–è¾‘è‡ªå·±çš„å¸–å­
- **åˆ é™¤æƒé™**: åªæœ‰ä½œè€…æˆ–ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å¸–å­
- **ç®¡ç†æƒé™**: åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç½®é¡¶/åŠ ç²¾/é”å®šå¸–å­

**å®ç°å»ºè®®**:
- åç«¯ç»Ÿä¸€ä½¿ç”¨å·²æœ‰çš„è®¤è¯ä¸­é—´ä»¶ï¼ˆæ¯”å¦‚ FastAPI `Depends`ï¼‰ï¼Œåœ¨è®ºå›è·¯ç”±ä¸ŠæŒ‚ä¸€ä¸ª `get_current_user` ä¾èµ–
- æƒé™æ£€æŸ¥åœ¨è·¯ç”±å±‚ç»Ÿä¸€å¤„ç†ï¼Œé¿å…åœ¨ä¸šåŠ¡é€»è¾‘ä¸­é‡å¤æ£€æŸ¥

### 3. é€Ÿç‡é™åˆ¶

- **å‘å¸–é™åˆ¶**: é™åˆ¶ç”¨æˆ·å‘å¸–é¢‘ç‡ï¼ˆé˜²æ­¢åˆ·å±ï¼‰
- **å›å¤é™åˆ¶**: é™åˆ¶ç”¨æˆ·å›å¤é¢‘ç‡
- **æœç´¢é™åˆ¶**: é™åˆ¶æœç´¢è¯·æ±‚é¢‘ç‡

**å®ç°å»ºè®®**:
- **ç½‘å…³å±‚é™æµ**: å¯ä»¥åœ¨ç½‘å…³ï¼ˆNginx / API Gatewayï¼‰å±‚åš IP çº§é™æµ
- **ä¸šåŠ¡çº§é™æµ**: ä¸šåŠ¡çº§é™æµï¼ˆæ¯”å¦‚"å•ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤šå‘å¸– 2 æ¡"ï¼‰ç”¨ Redis + Lua å®ç°
- **Redis Key è§„èŒƒ**: `forum:rate:user:{user_id}:create_post`ã€`forum:rate:user:{user_id}:create_reply` ç­‰

### 4. å†…å®¹å®¡æ ¸

- **æ•æ„Ÿè¯è¿‡æ»¤**: è‡ªåŠ¨è¿‡æ»¤æ•æ„Ÿè¯
- **ä¸¾æŠ¥åŠŸèƒ½**: ç”¨æˆ·å¯ä»¥ä¸¾æŠ¥ä¸å½“å†…å®¹
- **ç®¡ç†å‘˜å®¡æ ¸**: ç®¡ç†å‘˜å¯ä»¥å®¡æ ¸å’Œåˆ é™¤å†…å®¹

---

## ğŸ“ åç»­æ‰©å±•åŠŸèƒ½

### 1. é«˜çº§åŠŸèƒ½

- **æ ‡ç­¾ç³»ç»Ÿ**: å¸–å­æ”¯æŒæ ‡ç­¾åˆ†ç±»
- **é™„ä»¶ä¸Šä¼ **: æ”¯æŒå›¾ç‰‡å’Œæ–‡ä»¶ä¸Šä¼ 
- **@æåŠåŠŸèƒ½**: å›å¤æ—¶å¯ä»¥@å…¶ä»–ç”¨æˆ·
- **ç§ä¿¡åŠŸèƒ½**: ç”¨æˆ·ä¹‹é—´å¯ä»¥ç§ä¿¡

### 2. ç¤¾åŒºåŠŸèƒ½

- **ç”¨æˆ·ç­‰çº§**: æ ¹æ®å‘å¸–å’Œå›å¤æ•°è®¾ç½®ç”¨æˆ·ç­‰çº§
- **å¾½ç« ç³»ç»Ÿ**: ç”¨æˆ·å¯ä»¥è·å¾—å„ç§å¾½ç« 
- **ç§¯åˆ†ç³»ç»Ÿ**: å‘å¸–å’Œå›å¤å¯ä»¥è·å¾—ç§¯åˆ†

### 3. ç®¡ç†åŠŸèƒ½

- **å†…å®¹å®¡æ ¸**: ç®¡ç†å‘˜å®¡æ ¸æ–°å¸–å­
- **ç”¨æˆ·ç®¡ç†**: ç¦è¨€ã€å°ç¦ç”¨æˆ·
- **æ•°æ®ç»Ÿè®¡**: è®ºå›æ•°æ®ç»Ÿè®¡å’Œåˆ†æ
- **é£æ§ç­–ç•¥**: è‡ªåŠ¨å¤„ç†å¤šæ¬¡ä¸¾æŠ¥çš„å†…å®¹ï¼ˆè¯¦è§ä¸‹æ–¹è¯¦ç»†è®¾è®¡ï¼‰
- **æ“ä½œæ—¥å¿—**: ç®¡ç†å‘˜æ“ä½œå®¡è®¡æ—¥å¿—ï¼ˆè¯¦è§ä¸‹æ–¹è¯¦ç»†è®¾è®¡ï¼‰

### 4. å®æ—¶é€šä¿¡

- **WebSocket å®æ—¶æ¨é€**: æ–°å›å¤ã€æ–°é€šçŸ¥å®æ—¶æ¨é€ç»™ç”¨æˆ·
- **Server-Sent Events (SSE)**: å•å‘å®æ—¶æ¨é€æ–¹æ¡ˆ
- **æ¶ˆæ¯é˜Ÿåˆ—**: ä½¿ç”¨ Celery + Redis å¤„ç†å¼‚æ­¥é€šçŸ¥ä»»åŠ¡

### 5. åˆ†é¡µä¼˜åŒ–

- **Keyset Pagination**: å¤§æ•°æ®é‡åœºæ™¯ä¸‹çš„æ¸¸æ ‡åˆ†é¡µæ–¹æ¡ˆ
- **è™šæ‹Ÿæ»šåŠ¨**: å‰ç«¯è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–é•¿åˆ—è¡¨æ€§èƒ½

### 6. é£æ§ç­–ç•¥ï¼šè‡ªåŠ¨å¤„ç†å¤šæ¬¡ä¸¾æŠ¥å†…å®¹

**åŠŸèƒ½è¯´æ˜**: å½“å¸–å­æˆ–å›å¤è¢«ä¸¾æŠ¥è¾¾åˆ°ä¸€å®šé˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œé¢„è®¾çš„é£æ§åŠ¨ä½œï¼ˆéšè—ã€é”å®šã€åˆ é™¤ç­‰ï¼‰ï¼Œæ— éœ€ç®¡ç†å‘˜æ‰‹åŠ¨å¤„ç†ã€‚

**æ•°æ®åº“è®¾è®¡**:

```sql
-- é£æ§è§„åˆ™é…ç½®è¡¨
CREATE TABLE forum_risk_control_rules (
    id SERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,
    target_type VARCHAR(10) NOT NULL CHECK (target_type IN ('post', 'reply')),
    trigger_count INTEGER NOT NULL DEFAULT 3,  -- è§¦å‘é˜ˆå€¼ï¼ˆä¸¾æŠ¥æ¬¡æ•°ï¼‰
    trigger_time_window INTEGER NOT NULL DEFAULT 24,  -- æ—¶é—´çª—å£ï¼ˆå°æ—¶ï¼‰
    action_type VARCHAR(20) NOT NULL CHECK (action_type IN ('hide', 'lock', 'soft_delete', 'notify_admin')),
    is_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- é£æ§æ‰§è¡Œè®°å½•è¡¨
CREATE TABLE forum_risk_control_logs (
    id SERIAL PRIMARY KEY,
    target_type VARCHAR(10) NOT NULL CHECK (target_type IN ('post', 'reply')),
    target_id INTEGER NOT NULL,
    rule_id INTEGER REFERENCES forum_risk_control_rules(id),
    trigger_count INTEGER NOT NULL,  -- è§¦å‘æ—¶çš„ä¸¾æŠ¥æ•°
    action_type VARCHAR(20) NOT NULL,
    action_result VARCHAR(50),  -- æ‰§è¡Œç»“æœï¼ˆsuccess/failed/revertedï¼‰
    executed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    executed_by VARCHAR(8) REFERENCES users(id),  -- NULL è¡¨ç¤ºç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ
    reverted_at TIMESTAMP WITH TIME ZONE,  -- å¦‚æœè¢«ç®¡ç†å‘˜æ’¤é”€
    reverted_by VARCHAR(8) REFERENCES users(id)
);

-- ç´¢å¼•
CREATE INDEX idx_risk_control_logs_target ON forum_risk_control_logs(target_type, target_id);
CREATE INDEX idx_risk_control_logs_executed ON forum_risk_control_logs(executed_at DESC);
```

**ä¸šåŠ¡é€»è¾‘**:

1. **è§¦å‘æ¡ä»¶æ£€æŸ¥**:
   - å½“æœ‰æ–°çš„ä¸¾æŠ¥è¢«åˆ›å»ºæ—¶ï¼Œæ£€æŸ¥è¯¥ç›®æ ‡ï¼ˆå¸–å­/å›å¤ï¼‰åœ¨æ—¶é—´çª—å£å†…çš„ä¸¾æŠ¥æ€»æ•°
   - å¦‚æœè¾¾åˆ°è§„åˆ™é˜ˆå€¼ï¼Œè§¦å‘é£æ§åŠ¨ä½œ

2. **é£æ§åŠ¨ä½œç±»å‹**:
   - `hide`: è‡ªåŠ¨è®¾ç½® `is_visible = FALSE`ï¼Œå†…å®¹å¯¹æ™®é€šç”¨æˆ·ä¸å¯è§
   - `lock`: è‡ªåŠ¨è®¾ç½® `is_locked = TRUE`ï¼Œç¦æ­¢æ–°å›å¤
   - `soft_delete`: è‡ªåŠ¨è½¯åˆ é™¤å†…å®¹
   - `notify_admin`: ä»…é€šçŸ¥ç®¡ç†å‘˜ï¼Œä¸è‡ªåŠ¨å¤„ç†

3. **å®ç°ç¤ºä¾‹**:

```python
# ä¼ªä»£ç ï¼šæ£€æŸ¥å¹¶æ‰§è¡Œé£æ§
async def check_and_trigger_risk_control(target_type: str, target_id: int, db: AsyncSession):
    # 1. è·å–è¯¥ç›®æ ‡åœ¨æ—¶é—´çª—å£å†…çš„ä¸¾æŠ¥æ•°
    # æ³¨æ„ï¼šä½¿ç”¨ rule.trigger_time_window è€Œä¸æ˜¯ç¡¬ç¼–ç  24 å°æ—¶
    # å…ˆæŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™ä»¥è·å–æ—¶é—´çª—å£é…ç½®
    rule = await db.execute(
        select(ForumRiskControlRule)
        .where(
            ForumRiskControlRule.target_type == target_type,
            ForumRiskControlRule.is_enabled == True
        )
        .order_by(ForumRiskControlRule.trigger_count.desc())
        .limit(1)
    ).scalar_one_or_none()
    
    if not rule:
        return
    
    # ä½¿ç”¨è§„åˆ™ä¸­é…ç½®çš„æ—¶é—´çª—å£ï¼ˆå°æ—¶ï¼‰
    time_window = timedelta(hours=rule.trigger_time_window)
    cutoff_time = datetime.now(timezone.utc) - time_window
    
    report_count = await db.execute(
        select(func.count(ForumReport.id))
        .where(
            ForumReport.target_type == target_type,
            ForumReport.target_id == target_id,
            ForumReport.status == 'pending',
            ForumReport.created_at >= cutoff_time
        )
    ).scalar()
    
    # 2. æ£€æŸ¥æ˜¯å¦è¾¾åˆ°è§„åˆ™é˜ˆå€¼
    if report_count < rule.trigger_count:
        return  # æœªè¾¾åˆ°è§¦å‘é˜ˆå€¼
    
    # 3. æ‰§è¡Œé£æ§åŠ¨ä½œ
    if rule.action_type == 'hide':
        if target_type == 'post':
            await db.execute(
                update(ForumPost)
                .where(ForumPost.id == target_id)
                .values(is_visible=False)
            )
        else:
            await db.execute(
                update(ForumReply)
                .where(ForumReply.id == target_id)
                .values(is_visible=False)
            )
    
    elif rule.action_type == 'lock':
        await db.execute(
            update(ForumPost)
            .where(ForumPost.id == target_id)
            .values(is_locked=True)
        )
    
    elif rule.action_type == 'soft_delete':
        if target_type == 'post':
            await db.execute(
                update(ForumPost)
                .where(ForumPost.id == target_id)
                .values(is_deleted=True)
            )
        else:
            await db.execute(
                update(ForumReply)
                .where(ForumReply.id == target_id)
                .values(is_deleted=True)
            )
    
    # 4. è®°å½•æ‰§è¡Œæ—¥å¿—
    log = ForumRiskControlLog(
        target_type=target_type,
        target_id=target_id,
        rule_id=rule.id,
        trigger_count=report_count,
        action_type=rule.action_type,
        action_result='success',
        executed_by=None  # ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ
    )
    db.add(log)
    await db.commit()
```

**é»˜è®¤è§„åˆ™é…ç½®**:

```sql
-- æ’å…¥é»˜è®¤é£æ§è§„åˆ™
INSERT INTO forum_risk_control_rules (rule_name, target_type, trigger_count, trigger_time_window, action_type) VALUES
('å¸–å­è¢«ä¸¾æŠ¥3æ¬¡è‡ªåŠ¨éšè—', 'post', 3, 24, 'hide'),
('å¸–å­è¢«ä¸¾æŠ¥5æ¬¡è‡ªåŠ¨é”å®š', 'post', 5, 24, 'lock'),
('å›å¤è¢«ä¸¾æŠ¥3æ¬¡è‡ªåŠ¨éšè—', 'reply', 3, 24, 'hide'),
('å›å¤è¢«ä¸¾æŠ¥5æ¬¡è‡ªåŠ¨åˆ é™¤', 'reply', 5, 24, 'soft_delete');
```

### 7. ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨

**åŠŸèƒ½è¯´æ˜**: è®°å½•æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œï¼ˆç½®é¡¶ã€åŠ ç²¾ã€é”å®šã€åˆ é™¤ã€å°ç¦ç­‰ï¼‰ï¼Œç”¨äºå®¡è®¡å’Œåˆè§„è¦æ±‚ã€‚

**æ•°æ®åº“è®¾è®¡**:

```sql
-- ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE forum_admin_operation_logs (
    id SERIAL PRIMARY KEY,
    operator_id VARCHAR(8) NOT NULL REFERENCES users(id),  -- æ“ä½œè€…ï¼ˆç®¡ç†å‘˜ï¼‰
    operation_type VARCHAR(50) NOT NULL,  -- æ“ä½œç±»å‹ï¼špin_post, unpin_post, feature_post, unfeature_post, lock_post, unlock_post, delete_post, delete_reply, ban_user, unban_user ç­‰
    target_type VARCHAR(20) NOT NULL,  -- ç›®æ ‡ç±»å‹ï¼špost, reply, user, category ç­‰
    target_id INTEGER NOT NULL,  -- ç›®æ ‡ID
    target_title VARCHAR(500),  -- ç›®æ ‡æ ‡é¢˜ï¼ˆå†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
    action VARCHAR(50) NOT NULL,  -- å…·ä½“åŠ¨ä½œï¼špin, unpin, feature, delete, ban ç­‰
    reason TEXT,  -- æ“ä½œåŸå› 
    ip_address VARCHAR(45),  -- æ“ä½œè€…IPåœ°å€
    user_agent TEXT,  -- æ“ä½œè€…User-Agent
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_admin_logs_operator ON forum_admin_operation_logs(operator_id, created_at DESC);
CREATE INDEX idx_admin_logs_target ON forum_admin_operation_logs(target_type, target_id);
CREATE INDEX idx_admin_logs_operation ON forum_admin_operation_logs(operation_type, created_at DESC);
CREATE INDEX idx_admin_logs_created ON forum_admin_operation_logs(created_at DESC);
```

**æ“ä½œç±»å‹æšä¸¾**:

| æ“ä½œç±»å‹ | ç›®æ ‡ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `pin_post` | `post` | ç½®é¡¶å¸–å­ |
| `unpin_post` | `post` | å–æ¶ˆç½®é¡¶ |
| `feature_post` | `post` | åŠ ç²¾å¸–å­ |
| `unfeature_post` | `post` | å–æ¶ˆåŠ ç²¾ |
| `lock_post` | `post` | é”å®šå¸–å­ |
| `unlock_post` | `post` | è§£é”å¸–å­ |
| `delete_post` | `post` | åˆ é™¤å¸–å­ï¼ˆè½¯åˆ é™¤ï¼‰ |
| `restore_post` | `post` | æ¢å¤å¸–å­ |
| `delete_reply` | `reply` | åˆ é™¤å›å¤ï¼ˆè½¯åˆ é™¤ï¼‰ |
| `restore_reply` | `reply` | æ¢å¤å›å¤ |
| `ban_user` | `user` | å°ç¦ç”¨æˆ· |
| `unban_user` | `user` | è§£å°ç”¨æˆ· |
| `process_report` | `report` | å¤„ç†ä¸¾æŠ¥ |
| `create_category` | `category` | åˆ›å»ºæ¿å— |
| `update_category` | `category` | æ›´æ–°æ¿å— |
| `delete_category` | `category` | åˆ é™¤æ¿å— |

**å®ç°ç¤ºä¾‹**:

```python
# ä¼ªä»£ç ï¼šè®°å½•ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
async def log_admin_operation(
    operator_id: str,  # æ³¨æ„ï¼šusers.id æ˜¯ VARCHAR(8)ï¼Œä¸æ˜¯ INTEGER
    operation_type: str,
    target_type: str,
    target_id: int,
    action: str,
    reason: str = None,
    request: Request = None,
    db: AsyncSession = None
):
    # è·å–ç›®æ ‡æ ‡é¢˜ï¼ˆç”¨äºæ—¥å¿—æŸ¥è¯¢ï¼‰
    target_title = None
    if target_type == 'post':
        post = await db.execute(
            select(ForumPost).where(ForumPost.id == target_id)
        ).scalar_one_or_none()
        target_title = post.title if post else None
    elif target_type == 'reply':
        reply = await db.execute(
            select(ForumReply).where(ForumReply.id == target_id)
        ).scalar_one_or_none()
        target_title = reply.content[:100] if reply else None  # æˆªå–å‰100å­—ç¬¦
    
    # è·å–IPå’ŒUser-Agent
    ip_address = request.client.host if request else None
    user_agent = request.headers.get('user-agent') if request else None
    
    # åˆ›å»ºæ—¥å¿—è®°å½•
    log = ForumAdminOperationLog(
        operator_id=operator_id,
        operation_type=operation_type,
        target_type=target_type,
        target_id=target_id,
        target_title=target_title,
        action=action,
        reason=reason,
        ip_address=ip_address,
        user_agent=user_agent
    )
    db.add(log)
    await db.commit()

# ä½¿ç”¨ç¤ºä¾‹ï¼šç½®é¡¶å¸–å­
async def pin_post(post_id: int, operator_id: str, reason: str, request: Request, db: AsyncSession):  # æ³¨æ„ï¼šoperator_id æ˜¯ VARCHAR(8)
    # æ‰§è¡Œç½®é¡¶æ“ä½œ
    await db.execute(
        update(ForumPost)
        .where(ForumPost.id == post_id)
        .values(is_pinned=True)
    )
    
    # è®°å½•æ“ä½œæ—¥å¿—
    await log_admin_operation(
        operator_id=operator_id,
        operation_type='pin_post',
        target_type='post',
        target_id=post_id,
        action='pin',
        reason=reason,
        request=request,
        db=db
    )
    
    await db.commit()
```

**æŸ¥è¯¢ç¤ºä¾‹**:

```sql
-- æŸ¥è¯¢æŸä¸ªç®¡ç†å‘˜çš„æ‰€æœ‰æ“ä½œï¼ˆæ³¨æ„ï¼šoperator_id æ˜¯ VARCHAR(8)ï¼‰
SELECT * FROM forum_admin_operation_logs
WHERE operator_id = '12345678'  -- ç¤ºä¾‹ï¼šç”¨æˆ· ID æ˜¯å­—ç¬¦ä¸²æ ¼å¼
ORDER BY created_at DESC
LIMIT 50;

-- æŸ¥è¯¢æŸä¸ªå¸–å­çš„æ‰€æœ‰ç®¡ç†æ“ä½œå†å²
SELECT * FROM forum_admin_operation_logs
WHERE target_type = 'post' AND target_id = 123
ORDER BY created_at DESC;

-- æŸ¥è¯¢æœ€è¿‘ä¸€å‘¨çš„åˆ é™¤æ“ä½œ
SELECT * FROM forum_admin_operation_logs
WHERE operation_type IN ('delete_post', 'delete_reply')
  AND created_at >= NOW() - INTERVAL '7 days'
ORDER BY created_at DESC;
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemyæ–‡æ¡£](https://docs.sqlalchemy.org/)
- [React Queryæ–‡æ¡£](https://tanstack.com/query/latest)
- [PostgreSQLå…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£
2. æ£€æŸ¥ä»£ç æ³¨é‡Š
3. æŸ¥çœ‹ç›¸å…³æ—¥å¿—
4. è”ç³»å¼€å‘å›¢é˜Ÿ

---

---

## ğŸ“Œ é‡è¦å®ç°æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“çº¦æŸä¸€è‡´æ€§

- âœ… æ‰€æœ‰å­—æ®µçš„é»˜è®¤å€¼å’Œ NOT NULL çº¦æŸå·²åœ¨ Alembic è¿ç§»ä¸­æ­£ç¡®è®¾ç½®
- âœ… ä½¿ç”¨ `server_default` ç¡®ä¿æ•°æ®åº“å±‚é¢çš„é»˜è®¤å€¼
- âœ… è®¡æ•°å­—æ®µï¼ˆ`view_count`ã€`reply_count` ç­‰ï¼‰éƒ½æœ‰é»˜è®¤å€¼ 0
- âœ… ç´¢å¼•æ’åºæ–¹å‘å·²ä¸å¸¸ç”¨ ORDER BY åœºæ™¯å¯¹é½

### 2. ç»Ÿè®¡å­—æ®µæ›´æ–°ç­–ç•¥

**é‡è¦çº¦å®š**: 
- æ‰€æœ‰ç»Ÿè®¡å­—æ®µ**åªç»Ÿè®¡ `is_deleted = FALSE AND is_visible = TRUE` çš„æ•°æ®**
- è½¯åˆ é™¤çš„æ•°æ®ï¼ˆ`is_deleted = TRUE`ï¼‰ä¸å‚ä¸ç»Ÿè®¡
- éšè—çš„æ•°æ®ï¼ˆ`is_visible = FALSE`ï¼‰ä¸å‚ä¸å…¬å¼€ç»Ÿè®¡
- **ç»Ÿè®¡å­—æ®µä»£è¡¨"å…¬å¼€å¯è§çš„æ•°é‡"**ï¼Œç”¨äºå±•ç¤ºç»™æ™®é€šç”¨æˆ·

#### 2.1 æ¿å—ç»Ÿè®¡å­—æ®µæ›´æ–°

**`forum_categories.post_count`**:
- âœ… åˆ›å»ºå¸–å­æ—¶ï¼š`category.post_count += 1`ï¼ˆä»…å½“ `is_deleted = FALSE AND is_visible = TRUE`ï¼‰
- âœ… åˆ é™¤å¸–å­æ—¶ï¼ˆç¡¬åˆ é™¤æˆ–è½¯åˆ é™¤ï¼‰ï¼š`category.post_count -= 1`ï¼ˆä»…å½“åŸ `is_deleted = FALSE AND is_visible = TRUE` æ—¶ï¼‰
- âœ… æ¢å¤è½¯åˆ é™¤å¸–å­æ—¶ï¼š`category.post_count += 1`ï¼ˆä»…å½“æ¢å¤å `is_deleted = FALSE AND is_visible = TRUE`ï¼‰
- âœ… éšè—å¸–å­æ—¶ï¼š`category.post_count -= 1`ï¼ˆä»…å½“åŸ `is_visible = TRUE` æ—¶ï¼‰
- âœ… å–æ¶ˆéšè—å¸–å­æ—¶ï¼š`category.post_count += 1`ï¼ˆä»…å½“ `is_deleted = FALSE` ä¸”åŸ `is_visible = FALSE` æ—¶ï¼‰

**`forum_categories.last_post_at`**:
- âœ… åˆ›å»ºæ–°å¸–å­æ—¶ï¼šæ›´æ–°ä¸ºå½“å‰æ—¶é—´
- âœ… åˆ é™¤å¸–å­æ—¶ï¼šå¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€æ¡å¸–å­ï¼Œéœ€è¦é‡æ–°æŸ¥è¯¢è¯¥æ¿å—çš„æœ€æ–°å¸–å­æ—¶é—´

#### 2.2 å¸–å­ç»Ÿè®¡å­—æ®µæ›´æ–°

**`forum_posts.reply_count`**:
- âœ… åˆ›å»ºå›å¤æ—¶ï¼š`post.reply_count += 1`ï¼ˆä»…å½“å›å¤ `is_deleted = FALSE AND is_visible = TRUE`ï¼‰
- âœ… åˆ é™¤å›å¤æ—¶ï¼ˆç¡¬åˆ é™¤æˆ–è½¯åˆ é™¤ï¼‰ï¼š`post.reply_count -= 1`ï¼ˆä»…å½“åŸ `is_deleted = FALSE AND is_visible = TRUE` æ—¶ï¼‰
- âœ… æ¢å¤è½¯åˆ é™¤å›å¤æ—¶ï¼š`post.reply_count += 1`ï¼ˆä»…å½“æ¢å¤å `is_deleted = FALSE AND is_visible = TRUE`ï¼‰
- âœ… éšè—å›å¤æ—¶ï¼š`post.reply_count -= 1`ï¼ˆä»…å½“åŸ `is_visible = TRUE` æ—¶ï¼‰
- âœ… å–æ¶ˆéšè—å›å¤æ—¶ï¼š`post.reply_count += 1`ï¼ˆä»…å½“ `is_deleted = FALSE` ä¸”åŸ `is_visible = FALSE` æ—¶ï¼‰

**`forum_posts.last_reply_at`**:
- âœ… åˆ›å»ºæ–°å›å¤æ—¶ï¼šæ›´æ–°ä¸ºå½“å‰æ—¶é—´
- âœ… åˆ é™¤å›å¤æ—¶ï¼šå¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€æ¡å›å¤ï¼Œéœ€è¦é‡æ–°æŸ¥è¯¢è¯¥å¸–å­çš„æœ€æ–°å›å¤æ—¶é—´

**`forum_posts.like_count` / `favorite_count`**:
- âœ… ç‚¹èµ/æ”¶è—æ—¶ï¼š`post.like_count += 1`
- âœ… å–æ¶ˆç‚¹èµ/æ”¶è—æ—¶ï¼š`post.like_count -= 1`
- âš ï¸ åˆ é™¤å¸–å­æ—¶ï¼šçº§è”åˆ é™¤æ‰€æœ‰ç‚¹èµ/æ”¶è—è®°å½•ï¼Œè®¡æ•°è‡ªåŠ¨å½’é›¶

**`forum_posts.view_count`**:
- âœ… ä½¿ç”¨ Redis ç´¯åŠ ï¼Œå®šæ—¶æ‰¹é‡è½åº“ï¼ˆè¯¦è§æ€§èƒ½ä¼˜åŒ–ç« èŠ‚ï¼‰

#### 2.3 å›å¤ç»Ÿè®¡å­—æ®µæ›´æ–°

**`forum_replies.like_count`**:
- âœ… ç‚¹èµå›å¤æ—¶ï¼š`reply.like_count += 1`
- âœ… å–æ¶ˆç‚¹èµæ—¶ï¼š`reply.like_count -= 1`
- âš ï¸ åˆ é™¤å›å¤æ—¶ï¼šçº§è”åˆ é™¤æ‰€æœ‰ç‚¹èµè®°å½•ï¼Œè®¡æ•°è‡ªåŠ¨å½’é›¶

### 3. è½¯åˆ é™¤å’Œé£æ§éšè—çš„ä¸šåŠ¡è¯­ä¹‰

**ç»Ÿä¸€çº¦å®š**:
- âœ… **æ‰€æœ‰å¯¹å¤–æŸ¥è¯¢é»˜è®¤ `WHERE is_deleted = FALSE AND is_visible = TRUE`**
- âœ… **ç»Ÿè®¡å­—æ®µåªç»Ÿè®¡ `is_deleted = FALSE AND is_visible = TRUE` çš„æ•°æ®**ï¼ˆä»£è¡¨å…¬å¼€å¯è§çš„æ•°é‡ï¼‰
- âœ… **è½¯åˆ é™¤çš„å¸–å­/å›å¤åœ¨åˆ—è¡¨ä¸­ä¸æ˜¾ç¤º**
- âœ… **è¢«éšè—ï¼ˆ`is_visible = FALSE`ï¼‰çš„å¸–å­/å›å¤å¯¹æ™®é€šç”¨æˆ·ä¸å¯è§ï¼Œä½†ä½œè€…å’Œç®¡ç†å‘˜ä»å¯è§**
- âœ… **è®¿é—®è½¯åˆ é™¤å†…å®¹çš„è¯¦æƒ…é¡µæ—¶ï¼Œè¿”å› 404 æˆ–"è¯¥å¸–å­å·²è¢«åˆ é™¤"æç¤º**
- âœ… **è®¿é—®è¢«éšè—å†…å®¹çš„è¯¦æƒ…é¡µæ—¶ï¼Œæ™®é€šç”¨æˆ·è¿”å› 404ï¼Œä½œè€…å’Œç®¡ç†å‘˜å¯æ­£å¸¸æŸ¥çœ‹ï¼ˆæ˜¾ç¤º"ä»…è‡ªå·±å¯è§"æ ·å¼ï¼‰**
- âœ… **ä¸¾æŠ¥/å®¡æ ¸/é€šçŸ¥ä¸­çš„ target æŒ‡å‘è½¯åˆ é™¤å†…å®¹æ—¶**:
  - æ¥å£è¿”å›å ä½ä¿¡æ¯ï¼š"å†…å®¹å·²åˆ é™¤"
  - æˆ–éšè—è¯¥æ¡è®°å½•ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šï¼‰

**å­—æ®µè¯­ä¹‰åŒºåˆ†**:
- `is_deleted = TRUE`: è½¯åˆ é™¤ï¼Œå†…å®¹å¯¹æ‰€æœ‰äººä¸å¯è§ï¼ˆåŒ…æ‹¬ä½œè€…ï¼‰ï¼Œç”¨äºç”¨æˆ·ä¸»åŠ¨åˆ é™¤æˆ–ç®¡ç†å‘˜åˆ é™¤
- `is_visible = FALSE`: é£æ§éšè—ï¼Œå†…å®¹å¯¹æ™®é€šç”¨æˆ·ä¸å¯è§ï¼Œä½†ä½œè€…å’Œç®¡ç†å‘˜ä»å¯è§ï¼Œç”¨äºé£æ§è‡ªåŠ¨å¤„ç†

**å®ç°å»ºè®®**:
```python
# ä¼ªä»£ç ç¤ºä¾‹
from sqlalchemy import select
from fastapi import HTTPException

async def get_post(post_id, current_user, db: AsyncSession, is_admin: bool = False):
    result = await db.execute(
        select(ForumPost).where(
            ForumPost.id == post_id,
            ForumPost.is_deleted == False  # è½¯åˆ é™¤çš„å†…å®¹å¯¹æ‰€æœ‰äººä¸å¯è§
        )
    )
    post = result.scalar_one_or_none()
    if not post:
        raise HTTPException(404, "å¸–å­ä¸å­˜åœ¨æˆ–å·²åˆ é™¤")
    
    # æ£€æŸ¥é£æ§éšè—ï¼šæ™®é€šç”¨æˆ·ä¸å¯è§ï¼Œä½†ä½œè€…å’Œç®¡ç†å‘˜å¯è§
    if not post.is_visible:
        if not is_admin and (not current_user or post.author_id != current_user.id):
            raise HTTPException(404, "å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«éšè—")
    
    return post

# åˆ—è¡¨æŸ¥è¯¢ç¤ºä¾‹
async def get_posts_list(category_id: int, current_user, db: AsyncSession, is_admin: bool = False):
    query = select(ForumPost).where(
        ForumPost.category_id == category_id,
        ForumPost.is_deleted == False,
        ForumPost.is_visible == True  # é»˜è®¤åªæ˜¾ç¤ºå¯è§å†…å®¹
    )
    
    # å¦‚æœæ˜¯ç®¡ç†å‘˜æˆ–ä½œè€…ï¼Œå¯ä»¥æ˜¾ç¤ºè¢«éšè—çš„å†…å®¹ï¼ˆå¯é€‰ï¼‰
    # if is_admin:
    #     query = query.where(or_(ForumPost.is_visible == True, ForumPost.author_id == current_user.id))
    
    result = await db.execute(query)
    return result.scalars().all()
```

### 4. é”å®šå¸–å­çš„è¡Œä¸ºè§„åˆ™

**å½“ `is_locked = TRUE` æ—¶**:

- âœ… **ç¦æ­¢æ–°å›å¤**: åˆ›å»ºå›å¤æ¥å£å¿…é¡»æ£€æŸ¥ `post.is_locked`ï¼Œå¦‚æœä¸º `TRUE`ï¼Œè¿”å›é”™è¯¯ï¼š
  ```json
  {
    "error": "å¸–å­å·²é”å®šï¼Œæ— æ³•å›å¤",
    "code": "POST_LOCKED"
  }
  ```
- âœ… **ä½œè€…ä»å¯ç¼–è¾‘**: å¸–å­ä½œè€…å¯ä»¥ç¼–è¾‘è‡ªå·±çš„å¸–å­ï¼ˆå³ä½¿å·²é”å®šï¼‰
- âœ… **ç®¡ç†å‘˜å¯æ“ä½œ**: ç®¡ç†å‘˜å¯ä»¥è§£é”ã€åˆ é™¤ã€ç½®é¡¶ç­‰æ“ä½œ
- âš ï¸ **åˆ é™¤æƒé™**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šï¼Œä¸€èˆ¬ä½œè€…ä»å¯åˆ é™¤è‡ªå·±çš„å¸–å­

**å‰åç«¯è”åŠ¨çº¦å®š**:

1. **åç«¯ç»Ÿä¸€é”™è¯¯ç **:
   - è¯¦è§ä¸‹æ–¹ã€Œè®ºå›ä¸šåŠ¡é”™è¯¯ç é€ŸæŸ¥è¡¨ã€

2. **å‰ç«¯äº¤äº’**:
   - é”å¸–æ—¶éšè—å›å¤è¾“å…¥æ¡†ï¼Œæ˜¾ç¤º"è¯¥å¸–å­å·²é”å®šï¼Œæ— æ³•ç»§ç»­å›å¤"çš„æç¤º
   - é¿å…ç”¨æˆ·æ‰“äº†ä¸€å¤§æ®µå­—ï¼Œæäº¤æ‰å‘ç°é”å¸–ï¼Œä½“éªŒä¼šå¾ˆå·®

**è®ºå›ä¸šåŠ¡é”™è¯¯ç é€ŸæŸ¥è¡¨**:

| é”™è¯¯ç  | HTTP çŠ¶æ€ç  | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------------|------|---------|
| `POST_LOCKED` | 403 | å¸–å­å·²é”å®šï¼Œæ— æ³•å›å¤ | å°è¯•å›å¤å·²é”å®šçš„å¸–å­ |
| `POST_DELETED` | 404 | è¯¥å¸–å­å·²è¢«åˆ é™¤ | è®¿é—®å·²åˆ é™¤çš„å¸–å­è¯¦æƒ… |
| `POST_HIDDEN` | 404 | è¯¥å¸–å­å·²è¢«éšè— | æ™®é€šç”¨æˆ·è®¿é—®å·²éšè—çš„å¸–å­ |
| `REPLY_LEVEL_LIMIT` | 403 | å›å¤å±‚çº§æœ€å¤šä¸‰å±‚ | å°è¯•åˆ›å»ºè¶…è¿‡3å±‚çš„åµŒå¥—å›å¤ |
| `REPLY_DELETED` | 404 | è¯¥å›å¤å·²è¢«åˆ é™¤ | è®¿é—®å·²åˆ é™¤çš„å›å¤ |
| `REPLY_HIDDEN` | 404 | è¯¥å›å¤å·²è¢«éšè— | æ™®é€šç”¨æˆ·è®¿é—®å·²éšè—çš„å›å¤ |

**é”™è¯¯ç ä½¿ç”¨è¯´æ˜**:
- æ‰€æœ‰é”™è¯¯ç åº”åœ¨åç«¯ç»Ÿä¸€ç®¡ç†ï¼Œå»ºè®®åˆ›å»º `ForumErrorCode` æšä¸¾ç±»
- å‰ç«¯æ ¹æ®é”™è¯¯ç æ˜¾ç¤ºå¯¹åº”çš„æç¤ºæ–‡æ¡ˆ
- é”™è¯¯ç é€šè¿‡å“åº”ä½“ä¸­çš„ `code` å­—æ®µä¼ é€’ï¼Œæˆ–é€šè¿‡å“åº”å¤´ `X-Error-Code` ä¼ é€’

**å®ç°å»ºè®®**:
```python
# ä¼ªä»£ç ç¤ºä¾‹
async def create_reply(post_id, content, user):
    post = await get_post(post_id)
    if post.is_locked:
        raise HTTPException(
            status_code=403,
            detail="å¸–å­å·²é”å®šï¼Œæ— æ³•å›å¤",
            headers={"X-Error-Code": "POST_LOCKED"}  # å¯é€‰ï¼šåœ¨å“åº”å¤´ä¸­ä¼ é€’é”™è¯¯ç 
        )
    # ... åˆ›å»ºå›å¤é€»è¾‘
```

### 5. ç‚¹èµè®°å½•çš„çº§è”åˆ é™¤

- âš ï¸ `forum_likes` è¡¨çš„ `target_id` æ²¡æœ‰å¤–é”®çº¦æŸï¼ˆå¤šæ€å…³è”ï¼‰
- âœ… å¿…é¡»åœ¨ä¸šåŠ¡é€»è¾‘ä¸­å¤„ç†çº§è”åˆ é™¤
- âœ… åˆ é™¤å¸–å­/å›å¤æ—¶ï¼ŒåŒæ—¶åˆ é™¤å¯¹åº”çš„ç‚¹èµè®°å½•

**æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨ï¼ˆPostgreSQLï¼‰**:

ä¸ºäº†å½»åº•æœç»å­¤å„¿ç‚¹èµè®°å½•ï¼Œå»ºè®®åœ¨æ•°æ®åº“å±‚é¢æ·»åŠ è§¦å‘å™¨ï¼š

```sql
-- åˆ é™¤å¸–å­æ—¶è‡ªåŠ¨æ¸…ç†ç‚¹èµè®°å½•
CREATE OR REPLACE FUNCTION cleanup_post_likes()
RETURNS TRIGGER AS $$
BEGIN
    DELETE FROM forum_likes 
    WHERE target_type = 'post' AND target_id = OLD.id;
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_cleanup_post_likes
AFTER UPDATE ON forum_posts
FOR EACH ROW
WHEN (OLD.is_deleted = FALSE AND NEW.is_deleted = TRUE)
EXECUTE FUNCTION cleanup_post_likes();

-- åˆ é™¤å›å¤æ—¶è‡ªåŠ¨æ¸…ç†ç‚¹èµè®°å½•
CREATE OR REPLACE FUNCTION cleanup_reply_likes()
RETURNS TRIGGER AS $$
BEGIN
    DELETE FROM forum_likes 
    WHERE target_type = 'reply' AND target_id = OLD.id;
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_cleanup_reply_likes
AFTER UPDATE ON forum_replies
FOR EACH ROW
WHEN (OLD.is_deleted = FALSE AND NEW.is_deleted = TRUE)
EXECUTE FUNCTION cleanup_reply_likes();
```

**å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ SQLAlchemy Mapper äº‹ä»¶**:

å¦‚æœä¸æƒ³ä½¿ç”¨è§¦å‘å™¨ï¼Œå¯ä»¥åœ¨æ¨¡å‹å±‚é¢ä½¿ç”¨ SQLAlchemy çš„ `after_delete` äº‹ä»¶ï¼š

```python
from sqlalchemy import event
from sqlalchemy.orm import Session

@event.listens_for(ForumPost, 'after_delete')
def cleanup_post_likes(mapper, connection, target):
    connection.execute(
        delete(ForumLike).where(
            ForumLike.target_type == 'post',
            ForumLike.target_id == target.id
        )
    )

@event.listens_for(ForumReply, 'after_delete')
def cleanup_reply_likes(mapper, connection, target):
    connection.execute(
        delete(ForumLike).where(
            ForumLike.target_type == 'reply',
            ForumLike.target_id == target.id
        )
    )
```

**æ³¨æ„**: è§¦å‘å™¨æ–¹æ¡ˆæ›´å¯é ï¼Œå› ä¸ºå³ä½¿ä¸šåŠ¡å±‚ä»£ç æœ‰é—æ¼ï¼Œæ•°æ®åº“å±‚é¢ä¹Ÿä¼šè‡ªåŠ¨æ¸…ç†ã€‚

**ä¸šåŠ¡å±‚å®ç°ç¤ºä¾‹**ï¼ˆä½œä¸ºåŒé‡ä¿éšœï¼‰:
```python
from sqlalchemy import delete, update
from sqlalchemy.ext.asyncio import AsyncSession

async def delete_post(post_id: int, hard_delete: bool = False, db: AsyncSession = None):
    async with db.begin():
        # åˆ é™¤ç‚¹èµè®°å½•ï¼ˆå¤šæ€å…³è”ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤ï¼‰
        await db.execute(
            delete(ForumLike).where(
                ForumLike.target_type == 'post',
                ForumLike.target_id == post_id
            )
        )
        
        if hard_delete:
            # ç¡¬åˆ é™¤ï¼šç‰©ç†åˆ é™¤è®°å½•ï¼Œå¤–é”®çº§è”ä¼šè‡ªåŠ¨åˆ é™¤æ”¶è—å’Œå›å¤
            await db.execute(
                delete(ForumPost).where(ForumPost.id == post_id)
            )
        else:
            # è½¯åˆ é™¤ï¼šåªæ›´æ–° is_deleted æ ‡å¿—
            # æ³¨æ„ï¼šè½¯åˆ é™¤ä¸ä¼šè§¦å‘å¤–é”®çº§è”ï¼Œæ”¶è—å’Œå›å¤è®°å½•ä»ç„¶å­˜åœ¨
            await db.execute(
                update(ForumPost)
                .where(ForumPost.id == post_id)
                .values(is_deleted=True)
            )
            # è½¯åˆ é™¤æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡å­—æ®µ
            # æ”¶è—å’Œå›å¤è™½ç„¶è®°å½•è¿˜åœ¨ï¼Œä½†æŸ¥è¯¢æ—¶ä¼šè¿‡æ»¤æ‰ is_deleted=True çš„
```

**é‡è¦è¯´æ˜**:
- **è½¯åˆ é™¤ï¼ˆä¸šåŠ¡å±‚ï¼‰**: ä½¿ç”¨ `UPDATE is_deleted = TRUE`ï¼Œ**ä¸ä¼šè§¦å‘å¤–é”®çº§è”**
  - æ”¶è—ã€å›å¤è®°å½•ä»ç„¶å­˜åœ¨ï¼Œä½†æŸ¥è¯¢æ—¶ä¼šè¢«è¿‡æ»¤
  - éœ€è¦æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡å­—æ®µï¼ˆ`reply_count`ã€`post_count` ç­‰ï¼‰
- **ç¡¬åˆ é™¤ï¼ˆæ•°æ®æ¸…ç†ï¼‰**: ä½¿ç”¨ `DELETE`ï¼Œ**ä¼šè§¦å‘å¤–é”®çº§è”**
  - å¤–é”®ä¸Šçš„ `ON DELETE CASCADE` ä¼šè‡ªåŠ¨åˆ é™¤ç›¸å…³è®°å½•
  - ä¸»è¦ç”¨äºæ•°æ®æ¸…ç†è„šæœ¬ã€ç®¡ç†å‘˜å¼ºåˆ¶åˆ é™¤ç­‰åœºæ™¯
- **ä¸šåŠ¡å±‚é»˜è®¤ä½¿ç”¨è½¯åˆ é™¤**ï¼Œç¡¬åˆ é™¤ä»…åœ¨ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ï¼ˆå¦‚ç®¡ç†å‘˜å¼ºåˆ¶åˆ é™¤ã€æ•°æ®æ¸…ç†ç­‰ï¼‰

### 6. å¹¶å‘å”¯ä¸€çº¦æŸå†²çªå¤„ç†

**é—®é¢˜**: æ•°æ®åº“å”¯ä¸€çº¦æŸåœ¨å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½äº§ç”Ÿå†²çªï¼Œéœ€è¦ä¼˜é›…å¤„ç†ã€‚

#### 6.1 ä¸¾æŠ¥å”¯ä¸€çº¦æŸå†²çª

**åœºæ™¯**: `forum_reports` è¡¨æœ‰éƒ¨åˆ†å”¯ä¸€ç´¢å¼• `(target_type, target_id, reporter_id) WHERE status = 'pending'`

**é—®é¢˜**: å¹¶å‘æƒ…å†µä¸‹ï¼ŒåŒä¸€ç”¨æˆ·å¿«é€Ÿç‚¹å‡»ä¸¤æ¬¡ä¸¾æŠ¥ï¼Œç¬¬äºŒæ¬¡ insert ä¼šè¢« DB æ‹’ç»ï¼ˆå”¯ä¸€çº¦æŸé”™è¯¯ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```python
# ä¼ªä»£ç ç¤ºä¾‹
from sqlalchemy import select
from sqlalchemy.exc import IntegrityError
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi import HTTPException

async def create_report(target_type: str, target_id: int, reporter_id: str, reason: str, db: AsyncSession):
    try:
        report = ForumReport(
            target_type=target_type,
            target_id=target_id,
            reporter_id=reporter_id,
            reason=reason,
            status='pending'
        )
        db.add(report)
        await db.commit()
        return {"message": "ä¸¾æŠ¥æˆåŠŸ"}
    except IntegrityError as e:
        # æ•è·å”¯ä¸€çº¦æŸå†²çª
        await db.rollback()
        # æ£€æŸ¥æ˜¯å¦æ˜¯å› ä¸ºé‡å¤ä¸¾æŠ¥
        result = await db.execute(
            select(ForumReport).where(
                ForumReport.target_type == target_type,
                ForumReport.target_id == target_id,
                ForumReport.reporter_id == reporter_id,
                ForumReport.status == 'pending'
            )
        )
        existing = result.scalar_one_or_none()
        if existing:
            raise HTTPException(
                status_code=400,
                detail="æ‚¨å·²ä¸¾æŠ¥è¿‡è¯¥å†…å®¹ï¼Œæ­£åœ¨å¤„ç†ä¸­"
            )
        raise  # å…¶ä»–é”™è¯¯ç»§ç»­æŠ›å‡º
```

#### 6.2 ç‚¹èµå”¯ä¸€çº¦æŸå†²çª

**åœºæ™¯**: `forum_likes` è¡¨æœ‰å”¯ä¸€çº¦æŸ `UNIQUE(target_type, target_id, user_id)`

**é—®é¢˜**: å¹¶å‘æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¿«é€Ÿç‚¹å‡»ä¸¤æ¬¡ç‚¹èµï¼Œç¬¬äºŒæ¬¡ insert ä¼šè¢« DB æ‹’ç»

**è§£å†³æ–¹æ¡ˆ**:
```python
# ä¼ªä»£ç ç¤ºä¾‹
from sqlalchemy import select, delete
from sqlalchemy.exc import IntegrityError
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi import HTTPException

async def toggle_like(target_type: str, target_id: int, user_id: str, db: AsyncSession):
    # å…ˆæ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
    result = await db.execute(
        select(ForumLike).where(
            ForumLike.target_type == target_type,
            ForumLike.target_id == target_id,
            ForumLike.user_id == user_id
        )
    )
    existing = result.scalar_one_or_none()
    
    if existing:
        # å–æ¶ˆç‚¹èµ
        await db.execute(
            delete(ForumLike).where(ForumLike.id == existing.id)
        )
        await db.commit()
        return {"liked": False, "like_count": await get_like_count(target_type, target_id, db)}
    else:
        # ç‚¹èµ
        try:
            like = ForumLike(
                target_type=target_type,
                target_id=target_id,
                user_id=user_id
            )
            db.add(like)
            await db.commit()
            return {"liked": True, "like_count": await get_like_count(target_type, target_id, db)}
        except IntegrityError:
            # å¹¶å‘å†²çªï¼šå¯èƒ½å…¶ä»–è¯·æ±‚å·²ç»ç‚¹èµäº†
            await db.rollback()
            # é‡æ–°æŸ¥è¯¢ç¡®è®¤çŠ¶æ€
            result = await db.execute(
                select(ForumLike).where(
                    ForumLike.target_type == target_type,
                    ForumLike.target_id == target_id,
                    ForumLike.user_id == user_id
                )
            )
            existing = result.scalar_one_or_none()
            if existing:
                return {"liked": True, "like_count": await get_like_count(target_type, target_id, db)}
            raise HTTPException(500, "æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•")
```

**é‡è¦æç¤º**:
- âœ… æ‰€æœ‰æ¶‰åŠå”¯ä¸€çº¦æŸçš„æ“ä½œéƒ½è¦æ•è· `IntegrityError`
- âœ… è¿”å›å‹å¥½çš„ä¸šåŠ¡æç¤ºï¼Œè€Œä¸æ˜¯ 500 é”™è¯¯
- âœ… ä½¿ç”¨ä¹è§‚é”æˆ–åˆ†å¸ƒå¼é”å¤„ç†é«˜å¹¶å‘åœºæ™¯

### 7. é€šçŸ¥è§¦å‘ç­–ç•¥

**é€šçŸ¥è§¦å‘è§„åˆ™è¡¨**:

| åœºæ™¯ | è§¦å‘é€šçŸ¥ç±»å‹ | æ¥æ”¶è€… | è¯´æ˜ |
|------|------------|--------|------|
| A å›å¤å¸–å­ Pï¼ˆæ¥¼ä¸»ä¸º Bï¼‰ | `reply_post` | Bï¼ˆæ¥¼ä¸»ï¼‰ | é€šçŸ¥æ¥¼ä¸»æœ‰æ–°å›å¤ |
| A å›å¤å›å¤ Rï¼ˆä½œè€…ä¸º Cï¼‰ | `reply_reply` | Cï¼ˆè¢«å›å¤è€…ï¼‰ | é€šçŸ¥è¢«å›å¤è€… |
| A å›å¤å›å¤ R2ï¼ˆR2 çš„çˆ¶å›å¤æ˜¯ R1ï¼Œä½œè€…ä¸º Cï¼‰ | `reply_reply` | Cï¼ˆçˆ¶å›å¤é“¾ä¸Šçš„æ‰€æœ‰ä½œè€…ï¼‰ | **é“¾å¼é€šçŸ¥**ï¼šé€šçŸ¥å›å¤é“¾ä¸Šçš„æ‰€æœ‰ç›¸å…³ç”¨æˆ· |
| A ç‚¹èµå¸–å­ Pï¼ˆæ¥¼ä¸»ä¸º Bï¼‰ | `like_post` | Bï¼ˆæ¥¼ä¸»ï¼‰ | æ ¹æ®é…ç½®å¼€å…³å†³å®šæ˜¯å¦é€šçŸ¥ |
| ç®¡ç†å‘˜å¯¹å¸–å­ P åŠ ç²¾ï¼ˆæ¥¼ä¸»ä¸º Bï¼‰ | `feature_post` | Bï¼ˆæ¥¼ä¸»ï¼‰ | é€šçŸ¥æ¥¼ä¸»å¸–å­è¢«åŠ ç²¾ |
| ç®¡ç†å‘˜å¯¹å¸–å­ P ç½®é¡¶ï¼ˆæ¥¼ä¸»ä¸º Bï¼‰ | `pin_post` | Bï¼ˆæ¥¼ä¸»ï¼‰ | é€šçŸ¥æ¥¼ä¸»å¸–å­è¢«ç½®é¡¶ |

**é“¾å¼é€šçŸ¥å®ç°**:

å½“ç”¨æˆ·å›å¤ä¸€ä¸ªåµŒå¥—å›å¤æ—¶ï¼Œéœ€è¦é€šçŸ¥æ•´ä¸ªå›å¤é“¾ä¸Šçš„æ‰€æœ‰ç›¸å…³ç”¨æˆ·ï¼ˆé¿å…æ¥¼ä¸­æ¥¼é‡Œæ¼æ‰é€šçŸ¥ï¼‰ï¼š

```python
from sqlalchemy import select

async def create_reply_with_notifications(
    post_id: int, 
    content: str, 
    parent_reply_id: int = None, 
    author_id: str = None, 
    db: AsyncSession = None
):
    # åˆ›å»ºå›å¤
    reply = ForumReply(
        post_id=post_id,
        content=content,
        parent_reply_id=parent_reply_id,
        reply_level=reply_level,  # ç”±ä¸šåŠ¡å±‚è®¡ç®—
        author_id=author_id
    )
    db.add(reply)
    await db.commit()
    
    # å‘é€é€šçŸ¥
    if parent_reply_id:
        # è·å–æ•´ä¸ªå›å¤é“¾ï¼ˆå‘ä¸Šè¿½æº¯æ‰€æœ‰çˆ¶å›å¤ï¼‰
        reply_chain = []
        current_reply_id = parent_reply_id
        while current_reply_id:
            result = await db.execute(
                select(ForumReply).where(ForumReply.id == current_reply_id)
            )
            parent = result.scalar_one_or_none()
            if not parent:
                break
            reply_chain.append(parent)
            current_reply_id = parent.parent_reply_id
        
        # é€šçŸ¥å›å¤é“¾ä¸Šçš„æ‰€æœ‰ä½œè€…ï¼ˆæ’é™¤å½“å‰ç”¨æˆ·è‡ªå·±ï¼‰
        notified_users = set()
        for chain_reply in reply_chain:
            if chain_reply.author_id != author_id and chain_reply.author_id not in notified_users:
                notification = ForumNotification(
                    notification_type='reply_reply',
                    target_type='reply',
                    target_id=reply.id,
                    from_user_id=author_id,
                    to_user_id=chain_reply.author_id
                )
                db.add(notification)
                notified_users.add(chain_reply.author_id)
    else:
        # ç›´æ¥å›å¤å¸–å­ï¼Œé€šçŸ¥æ¥¼ä¸»
        # è·å–å¸–å­ä½œè€…
        result = await db.execute(
            select(ForumPost).where(ForumPost.id == post_id)
        )
        post = result.scalar_one_or_none()
        if post and post.author_id != author_id:
            notification = ForumNotification(
                notification_type='reply_post',
                target_type='post',
                target_id=post_id,
                from_user_id=author_id,
                to_user_id=post.author_id
            )
            db.add(notification)
    
    await db.commit()
```

**å®ç°è¦æ±‚**:
- å›å¤é€šçŸ¥ï¼šå¿…é¡»è§¦å‘ï¼ˆåŒ…æ‹¬é“¾å¼é€šçŸ¥ï¼Œé€šçŸ¥å›å¤é“¾ä¸Šçš„æ‰€æœ‰ç›¸å…³ç”¨æˆ·ï¼‰
- ç‚¹èµé€šçŸ¥ï¼šé€šè¿‡é…ç½®å¼€å…³æ§åˆ¶ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- åŠ ç²¾/ç½®é¡¶é€šçŸ¥ï¼šå¿…é¡»è§¦å‘

### 8. å…¨æ–‡æœç´¢é…ç½®

- âœ… **å½“å‰ä½¿ç”¨ `pg_trgm` æ‰©å±•è¿›è¡Œç›¸ä¼¼åº¦æœç´¢**
- **é…ç½®æ–¹å¼**:
  1. è®¾ç½®ç¯å¢ƒå˜é‡ `USE_PG_TRGM=true` å¯ç”¨ pg_trgm
  2. æ‰§è¡Œè¿ç§»æ–‡ä»¶ `023_add_pg_trgm_for_forum_search.sql` åˆ›å»ºæ‰©å±•å’Œç´¢å¼•
- **pg_trgm ä¼˜åŠ¿**:
  - âœ… å¯¹ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—éƒ½æœ‰è‰¯å¥½çš„æ”¯æŒ
  - âœ… æ”¯æŒå®¹é”™æœç´¢å’Œéƒ¨åˆ†åŒ¹é…
  - âœ… æ€§èƒ½è‰¯å¥½ï¼Œé€‚åˆä¸­å°è§„æ¨¡æ•°æ®
- **é™çº§æ–¹æ¡ˆ**: å¦‚æœæœªå¯ç”¨ `USE_PG_TRGM`ï¼Œå°†ä½¿ç”¨ `ILIKE` æ¨¡ç³Šæœç´¢
- **æœªæ¥æ‰©å±•**ï¼ˆå¤§è§„æ¨¡æ•°æ®ï¼‰:
  - å¯è€ƒè™‘æ¥å…¥ MeiliSearch / Elasticsearch ä½œä¸ºç‹¬ç«‹æœç´¢æœåŠ¡
  - pg_trgm ä½œä¸º fallback æ–¹æ¡ˆ

### 9. ç”¨æˆ·æ€å­—æ®µè¯´æ˜

- `is_liked` å’Œ `is_favorited` ä¸æ˜¯æ•°æ®åº“å­—æ®µ
- ç”±åç«¯æ ¹æ®å½“å‰ç™»å½•ç”¨æˆ·åŠ¨æ€è®¡ç®—
- æœªç™»å½•ç”¨æˆ·è¿”å› `false` æˆ–çœç•¥å­—æ®µ

### 10. å†…å®¹é¢„è§ˆå­—æ®µ

- åˆ—è¡¨æ¥å£è¿”å› `content_preview`ï¼ˆæˆªæ–­åï¼Œå‰200å­—ç¬¦ï¼‰
- è¯¦æƒ…æ¥å£è¿”å›å®Œæ•´ `content`
- å·²å»é™¤ Markdown æ ‡è®°ä»¥æå‡å¯è¯»æ€§

### 11. åµŒå¥—å›å¤å®ç°

- åç«¯ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰å›å¤ï¼Œåœ¨ä»£ç ä¸­ç»„è£…æ ‘å½¢ç»“æ„
- é¿å…é€’å½’æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½
- å‰ç«¯ç›´æ¥æ¸²æŸ“åµŒå¥—å¥½çš„æ•°æ®ç»“æ„
- **åˆ†é¡µä»…é’ˆå¯¹ä¸€çº§å›å¤**ï¼Œæ¯ä¸ªä¸€çº§å›å¤é™„å¸¦å®Œæ•´çš„å­å›å¤æ ‘

### 12. å®æ—¶æ›´æ–°æ–¹æ¡ˆ

**å½“å‰å®ç°**:
- ä½¿ç”¨ **React Query è½®è¯¢**æœºåˆ¶
- å¸–å­è¯¦æƒ…é¡µï¼šæ¯ 30 ç§’è½®è¯¢ä¸€æ¬¡æ–°å›å¤
- å›å¤åˆ—è¡¨ï¼šä½¿ç”¨ React Query çš„ `refetchInterval` é…ç½®

**æœªæ¥æ‰©å±•**:
- å¯è€ƒè™‘ä½¿ç”¨ **WebSocket** å®ç°çœŸæ­£çš„å®æ—¶æ¨é€
- æˆ–ä½¿ç”¨ **Server-Sent Events (SSE)** å®ç°å•å‘å®æ—¶æ¨é€
- å…·ä½“å®ç°æ–¹æ¡ˆè§"åç»­æ‰©å±•åŠŸèƒ½"ç« èŠ‚

### 13. å¤§æ•°æ®é‡åˆ†é¡µä¼˜åŒ–

**å½“å‰æ–¹æ¡ˆ**:
- ä½¿ç”¨ `OFFSET` + `LIMIT` è¿›è¡Œåˆ†é¡µ
- é€‚åˆåˆæœŸå’Œä¸­å°æ•°æ®é‡åœºæ™¯

**æœªæ¥ä¼˜åŒ–**:
- å¯¹äºçƒ­é—¨æ¿å—ï¼Œå¯è€ƒè™‘ä½¿ç”¨ **Keyset Paginationï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰**
- åŸºäº `created_at` æˆ– `id` çš„æ¸¸æ ‡ï¼Œé¿å… `OFFSET` åœ¨å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½é—®é¢˜
- ç¤ºä¾‹ï¼š`WHERE created_at < :cursor ORDER BY created_at DESC LIMIT :limit`

### 14. å·²åˆ é™¤/éšè—å†…å®¹çš„å±•ç¤ºè§„åˆ™ï¼ˆå‰ç«¯éœ€è¦ï¼‰

**å¸–å­è¢«åˆ é™¤ï¼ˆ`is_deleted = TRUE`ï¼‰æ—¶**:
- åˆ—è¡¨ä¸­ä¸å†å±•ç¤º
- å¦‚æœç”¨æˆ·æ‰“å¼€æ—§ URLï¼Œå¯ä»¥è¿”å›"è¯¥å¸–å­å·²è¢«åˆ é™¤"çš„å ä½é¡µï¼ˆHTTP 200 + ç‰¹å®šé”™è¯¯ç ï¼‰ï¼Œè€Œä¸æ˜¯ 404ï¼Œæ–¹ä¾¿è§£é‡Š
- åç«¯è¿”å›ç¤ºä¾‹ï¼š
  ```json
  {
    "error": "è¯¥å¸–å­å·²è¢«åˆ é™¤",
    "code": "POST_DELETED"
  }
  ```

**å›å¤è¢«åˆ é™¤æ—¶**:
- åˆ—è¡¨ä¸­ä¿ç•™ä¸€è¡Œ"è¯¥å›å¤å·²è¢«åˆ é™¤"å ä½ï¼ˆæ–¹ä¾¿ç†è§£æ¥¼å±‚ç»“æ„ï¼‰
- `content` å‰ç«¯ä¸å±•ç¤ºï¼Œåç«¯å¯é€‰è¿”å› `null` æˆ–ç©ºå­—ç¬¦ä¸²
- åç«¯è¿”å›ç¤ºä¾‹ï¼š
  ```json
  {
    "id": 123,
    "content": null,  // æˆ–ç©ºå­—ç¬¦ä¸²
    "is_deleted": true,
    "author": {
      "id": "12345678",
      "name": "å·²åˆ é™¤ç”¨æˆ·"
    }
  }
  ```

**è¢«éšè—ï¼ˆ`is_visible = FALSE`ï¼‰æ—¶**:
- å¯¹æ™®é€šç”¨æˆ·ä¸å¯è§ï¼ˆåˆ—è¡¨ä¸­ä¸æ˜¾ç¤ºï¼Œè¯¦æƒ…é¡µè¿”å› 404ï¼‰
- å¸–å­ä½œè€…å’Œç®¡ç†å‘˜ä»å¯è§ï¼Œç”¨"ä»…è‡ªå·±å¯è§"æ ·å¼å±•ç¤º
- å‰ç«¯æ˜¾ç¤ºæç¤ºï¼š"è¯¥å†…å®¹å·²è¢«éšè—ï¼Œä»…ä½œè€…å’Œç®¡ç†å‘˜å¯è§"
- åç«¯è¿”å›æ—¶ï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·èº«ä»½åˆ¤æ–­æ˜¯å¦è¿”å›å†…å®¹ï¼š
  ```python
  # ä¼ªä»£ç ç¤ºä¾‹
  if not post.is_visible:
      if is_admin or post.author_id == current_user.id:
          # è¿”å›å†…å®¹ï¼Œä½†æ ‡è®°ä¸ºéšè—
          return {"post": post, "is_hidden": True, "hidden_reason": "é£æ§éšè—"}
      else:
          raise HTTPException(404, "å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«éšè—")
  ```

**è¿™äº›è§„åˆ™ç¡®å®šå¥½åï¼Œå‰åç«¯å¯¹"ä¸ºä»€ä¹ˆæˆ‘çœ‹ä¸åˆ° / ä¸ºä»€ä¹ˆè¿˜èƒ½çœ‹åˆ°"å°±ä¸ä¼šåµæ¶** ğŸ˜‚

---

---

## ğŸ“‹ ä¸šåŠ¡é€»è¾‘çº¦å®šæ€»ç»“

### ç»Ÿè®¡å­—æ®µæ›´æ–°æ¸…å•

| æ“ä½œ | éœ€è¦æ›´æ–°çš„å­—æ®µ | æ›´æ–°é€»è¾‘ |
|------|--------------|---------|
| åˆ›å»ºå¸–å­ | `category.post_count += 1`<br>`category.last_post_at = now()` | ä»…å½“ `is_deleted = FALSE AND is_visible = TRUE` |
| åˆ é™¤å¸–å­ | `category.post_count -= 1`<br>`category.last_post_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“åŸ `is_deleted = FALSE AND is_visible = TRUE` |
| æ¢å¤å¸–å­ | `category.post_count += 1`<br>`category.last_post_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“æ¢å¤å `is_deleted = FALSE AND is_visible = TRUE` |
| éšè—å¸–å­ | `category.post_count -= 1`<br>`category.last_post_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“åŸ `is_visible = TRUE` |
| å–æ¶ˆéšè—å¸–å­ | `category.post_count += 1`<br>`category.last_post_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“ `is_deleted = FALSE` ä¸”åŸ `is_visible = FALSE` |
| åˆ›å»ºå›å¤ | `post.reply_count += 1`<br>`post.last_reply_at = now()` | ä»…å½“ `is_deleted = FALSE AND is_visible = TRUE` |
| åˆ é™¤å›å¤ | `post.reply_count -= 1`<br>`post.last_reply_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“åŸ `is_deleted = FALSE AND is_visible = TRUE` |
| æ¢å¤å›å¤ | `post.reply_count += 1`<br>`post.last_reply_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“æ¢å¤å `is_deleted = FALSE AND is_visible = TRUE` |
| éšè—å›å¤ | `post.reply_count -= 1`<br>`post.last_reply_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“åŸ `is_visible = TRUE` |
| å–æ¶ˆéšè—å›å¤ | `post.reply_count += 1`<br>`post.last_reply_at` é‡æ–°æŸ¥è¯¢ | ä»…å½“ `is_deleted = FALSE` ä¸”åŸ `is_visible = FALSE` |
| ç‚¹èµ/æ”¶è— | `post.like_count += 1`<br>`post.favorite_count += 1` | ç›´æ¥æ›´æ–° |
| å–æ¶ˆç‚¹èµ/æ”¶è— | `post.like_count -= 1`<br>`post.favorite_count -= 1` | ç›´æ¥æ›´æ–° |

### æŸ¥è¯¢è¿‡æ»¤çº¦å®š

- âœ… æ‰€æœ‰åˆ—è¡¨æŸ¥è¯¢ï¼š`WHERE is_deleted = FALSE AND is_visible = TRUE`
- âœ… æ‰€æœ‰ç»Ÿè®¡æŸ¥è¯¢ï¼šåªç»Ÿè®¡ `is_deleted = FALSE AND is_visible = TRUE` çš„æ•°æ®
- âœ… è¯¦æƒ…æŸ¥è¯¢ï¼š
  - å¦‚æœ `is_deleted = TRUE`ï¼Œè¿”å› 404 æˆ–"è¯¥å¸–å­å·²è¢«åˆ é™¤"
  - å¦‚æœ `is_visible = FALSE`ï¼Œæ™®é€šç”¨æˆ·è¿”å› 404ï¼Œä½œè€…å’Œç®¡ç†å‘˜å¯æ­£å¸¸æŸ¥çœ‹

### æƒé™å’Œè¡Œä¸ºè§„åˆ™

- âœ… é”å®šå¸–å­ï¼šç¦æ­¢æ–°å›å¤ï¼Œä½†ä½œè€…ä»å¯ç¼–è¾‘
- âœ… è½¯åˆ é™¤å†…å®¹ï¼šä¸æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ï¼Œè¯¦æƒ…é¡µè¿”å› 404
- âœ… ä¸¾æŠ¥å”¯ä¸€æ€§ï¼šåŒä¸€ç”¨æˆ·å¯¹åŒä¸€ç›®æ ‡çš„ pending ä¸¾æŠ¥åªèƒ½æœ‰ä¸€æ¡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.4  
**æœ€åæ›´æ–°**: 2025-01-27  
**ç»´æŠ¤è€…**: LinkUå¼€å‘å›¢é˜Ÿ

