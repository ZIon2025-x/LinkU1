# Celery å®Œæ•´æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [éœ€æ±‚å˜æ›´è¯´æ˜](#éœ€æ±‚å˜æ›´è¯´æ˜)
3. [å·²çŸ¥é—®é¢˜å’Œé£é™©](#å·²çŸ¥é—®é¢˜å’Œé£é™©)
4. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
5. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
6. [ä»»åŠ¡åˆ—è¡¨](#ä»»åŠ¡åˆ—è¡¨)
7. [å®šæ—¶ä»»åŠ¡é…ç½®](#å®šæ—¶ä»»åŠ¡é…ç½®)
8. [ä»»åŠ¡å®ç°ç»†èŠ‚](#ä»»åŠ¡å®ç°ç»†èŠ‚)
9. [å¯åŠ¨å’Œéƒ¨ç½²](#å¯åŠ¨å’Œéƒ¨ç½²)
10. [ç›‘æ§å’ŒæŒ‡æ ‡](#ç›‘æ§å’ŒæŒ‡æ ‡)
11. [æ•…éšœå¤„ç†](#æ•…éšœå¤„ç†)
12. [å›é€€æœºåˆ¶](#å›é€€æœºåˆ¶)
13. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)

---

## éœ€æ±‚å˜æ›´è¯´æ˜

### âš ï¸ é‡è¦ï¼šéœ€è¦ç¦ç”¨çš„ä»»åŠ¡

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œä»¥ä¸‹ä»»åŠ¡éœ€è¦è¢«ç¦ç”¨ï¼ˆ**æ³¨æ„ï¼šç›®å‰ä»£ç ä¸­è¿™äº›ä»»åŠ¡ä»ç„¶å¯ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨ç¦ç”¨**ï¼‰ï¼š

#### 1. `auto-complete-expired-time-slot-tasks`ï¼ˆè‡ªåŠ¨å®Œæˆå·²è¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡ï¼‰

- **å½“å‰çŠ¶æ€**: âœ… å·²å¯ç”¨ï¼ˆåœ¨ `celery_app.py` ä¸­é…ç½®ï¼‰
- **éœ€æ±‚**: âŒ **ä¸éœ€è¦**è‡ªåŠ¨å®Œæˆè¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡
- **åŸåŠŸèƒ½**: æ¯1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œè‡ªåŠ¨å®Œæˆå·²è¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡
- **å½±å“**: æ—¶é—´æ®µè¿‡æœŸåï¼Œä»»åŠ¡ä¸ä¼šè‡ªåŠ¨æ ‡è®°ä¸ºå·²å®Œæˆï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
- **æ“ä½œ**: éœ€è¦åœ¨ `backend/app/celery_app.py` ä¸­æ³¨é‡Šæ‰æ­¤ä»»åŠ¡é…ç½®

#### 2. `check-and-end-activities`ï¼ˆæ£€æŸ¥å¹¶ç»“æŸæ´»åŠ¨ï¼‰

- **å½“å‰çŠ¶æ€**: âœ… å·²å¯ç”¨ï¼ˆåœ¨ `celery_app.py` ä¸­é…ç½®ï¼‰
- **éœ€æ±‚**: âŒ **ä¸éœ€è¦**æ£€æŸ¥å¤šäººæ´»åŠ¨æ˜¯å¦è¿‡æœŸ/æ˜¯å¦è¿‡äº†æœ€åä¸€ä¸ªæ—¶é—´æ®µ
- **åŸåŠŸèƒ½**: æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œæ£€æŸ¥å¤šäººæ´»åŠ¨æ˜¯å¦åº”è¯¥ç»“æŸï¼ˆæœ€åä¸€ä¸ªæ—¶é—´æ®µç»“æŸæˆ–è¾¾åˆ°æˆªè‡³æ—¥æœŸï¼‰
- **å½±å“**: æ´»åŠ¨ä¸ä¼šè‡ªåŠ¨ç»“æŸï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
- **æ“ä½œ**: éœ€è¦åœ¨ `backend/app/celery_app.py` ä¸­æ³¨é‡Šæ‰æ­¤ä»»åŠ¡é…ç½®

#### 3. `auto_generate_future_time_slots`ï¼ˆè‡ªåŠ¨ç”Ÿæˆæœªæ¥æ—¶é—´æ®µï¼‰

- **å½“å‰çŠ¶æ€**: âœ… å·²å¯ç”¨ï¼ˆé€šè¿‡ `CleanupTasks` ç±»è°ƒç”¨ï¼Œä¸æ˜¯ Celery ä»»åŠ¡ï¼‰
- **éœ€æ±‚**: âŒ **ä¸éœ€è¦**æ¯å¤©æ–°å¢æ—¶é—´æ®µæœåŠ¡çš„ä¸‹ä¸€ä¸ªæ—¶é—´æ®µ
- **åŸåŠŸèƒ½**: æ¯å¤©è‡ªåŠ¨ä¸ºæ‰€æœ‰å¯ç”¨äº†æ—¶é—´æ®µåŠŸèƒ½çš„æœåŠ¡ç”Ÿæˆä¸‹ä¸ªæœˆçš„ä»Šå¤©çš„æ—¶é—´æ®µ
- **ä½ç½®**: `backend/app/cleanup_tasks.py` - `_auto_generate_future_time_slots()` æ–¹æ³•
- **è°ƒç”¨ä½ç½®**: `backend/app/crud.py` - `auto_generate_future_time_slots()` å‡½æ•°
- **å½±å“**: æ—¶é—´æ®µä¸ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º
- **æ“ä½œ**: éœ€è¦åœ¨ `backend/app/cleanup_tasks.py` ä¸­æ³¨é‡Šæ‰ `await self._auto_generate_future_time_slots()` è°ƒç”¨

### å½“å‰ä»»åŠ¡çŠ¶æ€

- **Celery å®šæ—¶ä»»åŠ¡**: 12ä¸ªï¼ˆå…¶ä¸­2ä¸ªéœ€è¦ç¦ç”¨ï¼‰
- **CleanupTasks ä»»åŠ¡**: åŒ…å«æ—¶é—´æ®µè‡ªåŠ¨ç”Ÿæˆä»»åŠ¡ï¼ˆéœ€è¦ç¦ç”¨ï¼‰

### å¦‚ä½•ç¦ç”¨è¿™äº›ä»»åŠ¡

#### ç¦ç”¨ Celery ä»»åŠ¡

åœ¨ `backend/app/celery_app.py` ä¸­æ³¨é‡Šæ‰ä»¥ä¸‹é…ç½®ï¼š

```python
# æ³¨é‡Šæ‰è‡ªåŠ¨å®Œæˆè¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡
# 'auto-complete-expired-time-slot-tasks': {
#     'task': 'app.celery_tasks.auto_complete_expired_time_slot_tasks_task',
#     'schedule': 60.0,
# },

# æ³¨é‡Šæ‰æ£€æŸ¥å¹¶ç»“æŸæ´»åŠ¨
# 'check-and-end-activities': {
#     'task': 'app.celery_tasks.check_and_end_activities_task',
#     'schedule': 300.0,
# },
```

#### ç¦ç”¨æ—¶é—´æ®µè‡ªåŠ¨ç”Ÿæˆä»»åŠ¡

åœ¨ `backend/app/cleanup_tasks.py` çš„ `_run_cleanup_cycle()` æ–¹æ³•ä¸­æ³¨é‡Šæ‰ï¼š

```python
# æ³¨é‡Šæ‰è‡ªåŠ¨ç”Ÿæˆæœªæ¥æ—¶é—´æ®µ
# await self._auto_generate_future_time_slots()
```

#### âš ï¸ é‡è¦ï¼šåŒæ—¶ç¦ç”¨ TaskScheduler ä¸­çš„ä»»åŠ¡

**å¿…é¡»åŒæ­¥æ“ä½œ**ï¼šåœ¨ `backend/app/task_scheduler.py` çš„ `init_scheduler()` å‡½æ•°ä¸­ï¼Œä¹Ÿè¦æ³¨é‡Šæ‰å¯¹åº”çš„ä»»åŠ¡ï¼š

```python
# æ³¨é‡Šæ‰è‡ªåŠ¨å®Œæˆè¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡
# scheduler.register_task(
#     'auto_complete_expired_time_slot_tasks',
#     with_db(auto_complete_expired_time_slot_tasks),
#     interval_seconds=60,
#     description="è‡ªåŠ¨å®Œæˆå·²è¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡"
# )

# æ³¨é‡Šæ‰æ£€æŸ¥å¹¶ç»“æŸæ´»åŠ¨
# scheduler.register_task(
#     'check_and_end_activities',
#     lambda: check_and_end_activities_sync(SessionLocal()),
#     interval_seconds=300,
#     description="æ£€æŸ¥å¹¶ç»“æŸæ´»åŠ¨"
# )
```

**åŸå› **: å¦‚æœç³»ç»Ÿå›é€€åˆ° TaskSchedulerï¼ˆå½“ Celery ä¸å¯ç”¨æ—¶ï¼‰ï¼Œè¿™äº›ä»»åŠ¡ä»ä¼šæ‰§è¡Œï¼Œå¯¼è‡´è¡Œä¸ºä¸ä¸€è‡´ã€‚

**æœ€ä½³å®è·µ**: ä»¥ååªè¦æ˜¯"ä¸šåŠ¡åºŸå¼ƒ"çš„å®šæ—¶ä»»åŠ¡ï¼Œè¦åŒæ­¥ä» Celery Beat + TaskScheduler ä¸¤è¾¹ä¸€èµ·åˆ ã€‚

---

## å·²çŸ¥é—®é¢˜å’Œé£é™©

### âš ï¸ ä¸€ã€å¯èƒ½å¯¼è‡´è¡Œä¸ºä¸ç¬¦åˆé¢„æœŸçš„ç‚¹ï¼ˆä¼˜å…ˆæ’æŸ¥ï¼‰

#### 1. ç¦ç”¨éœ€æ±‚åªåŠ¨äº† Celery / CleanupTasksï¼Œæ²¡æœ‰åŠ¨ TaskScheduler

**é—®é¢˜æè¿°**:

å½“å‰éœ€è¦ç¦ç”¨çš„ä»»åŠ¡æœ‰ 3 ä¸ªï¼š
- `auto-complete-expired-time-slot-tasks`ï¼ˆCelery Beat ä»»åŠ¡ï¼Œ1 åˆ†é’Ÿä¸€æ¬¡ï¼‰
- `check-and-end-activities`ï¼ˆCelery Beat ä»»åŠ¡ï¼Œ5 åˆ†é’Ÿä¸€æ¬¡ï¼‰
- `_auto_generate_future_time_slots`ï¼ˆCleanupTasks ä»»åŠ¡ï¼Œæ¯å¤©ä¸€æ¬¡ï¼‰

**å½“å‰ç¦ç”¨æ“ä½œ**:
- åœ¨ `celery_app.py` é‡Œæ³¨é‡Š Beat çš„é…ç½®
- åœ¨ `_run_cleanup_cycle()` é‡Œæ³¨é‡Š `await self._auto_generate_future_time_slots()`

**é£é™©**:

ä¸€æ—¦ç³»ç»Ÿå› ä¸º Redis/Celery ä¸å¯ç”¨è€Œå›é€€åˆ° TaskSchedulerï¼Œè¿™ä¸¤ä¸ªæœ¬æ¥"ä¸šåŠ¡ä¸Šå·²ç»ä¸è¦"çš„ä»»åŠ¡ä¼šåœ¨å¤‡ç”¨è°ƒåº¦å™¨é‡Œç»§ç»­æ‰§è¡Œã€‚

è¿™ä¸æ˜¯æ–‡æ¡£é—®é¢˜ï¼Œæ˜¯è¡Œä¸ºä¸ä¸€è‡´çš„é—®é¢˜ï¼šéœ€æ±‚æ˜¯"ä¸šåŠ¡ä¸Šä¸å†éœ€è¦è¿™ä¸ªåŠŸèƒ½"ï¼Œè€Œä¸æ˜¯"åªåœ¨ Celery æ¨¡å¼ä¸‹ä¸è·‘"ã€‚

**âœ… è§£å†³æ–¹æ¡ˆ**:

åœ¨ `task_scheduler.py` çš„ `init_scheduler()` å‡½æ•°ä¸­ï¼ŒæŠŠå¯¹åº”çš„ä¸¤é¡¹ä»»åŠ¡ä»è°ƒåº¦åˆ—è¡¨é‡Œæ˜ç¡®ç§»é™¤ï¼š

```python
# æ³¨é‡Šæ‰è‡ªåŠ¨å®Œæˆè¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡
# scheduler.register_task(
#     'auto_complete_expired_time_slot_tasks',
#     with_db(auto_complete_expired_time_slot_tasks),
#     interval_seconds=60,
#     description="è‡ªåŠ¨å®Œæˆå·²è¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡"
# )

# æ³¨é‡Šæ‰æ£€æŸ¥å¹¶ç»“æŸæ´»åŠ¨
# scheduler.register_task(
#     'check_and_end_activities',
#     lambda: check_and_end_activities_sync(SessionLocal()),
#     interval_seconds=300,
#     description="æ£€æŸ¥å¹¶ç»“æŸæ´»åŠ¨"
# )
```

**æœ€ä½³å®è·µ**: ä»¥ååªè¦æ˜¯"ä¸šåŠ¡åºŸå¼ƒ"çš„å®šæ—¶ä»»åŠ¡ï¼Œè¦åŒæ­¥ä» Celery Beat + TaskScheduler ä¸¤è¾¹ä¸€èµ·åˆ ã€‚

---

#### 2. ç¦ç”¨è‡ªåŠ¨å®Œæˆ time-slot ä»»åŠ¡åï¼Œä»ç„¶æ¯å¤©æ¸…ç†"æ˜¨å¤©åŠä¹‹å‰æ‰€æœ‰æ—¶é—´æ®µ"

**é—®é¢˜æè¿°**:

å½“å‰ç»„åˆæ˜¯ï¼š
- Celeryï¼ˆæˆ– TaskSchedulerï¼‰ä¸å†è‡ªåŠ¨æŠŠè¿‡æœŸ time-slot é‡Œçš„ä»»åŠ¡æ ‡è®°å®Œæˆï¼ˆå·²ç¦ç”¨ï¼‰
- CleanupTasks é‡Œ `_cleanup_expired_time_slots` æ¯å¤©ä¸€æ¬¡ï¼Œ"æ¸…ç†æ˜¨å¤©åŠä¹‹å‰çš„æ‰€æœ‰æ—¶é—´æ®µ"ï¼ˆä»åœ¨è¿è¡Œï¼‰

**ä¸šåŠ¡é£é™©**:

1. **ä»»åŠ¡çŠ¶æ€ä¸ä¸€è‡´**: ä»»åŠ¡çŠ¶æ€å°šæœªåˆ°"ç»ˆæ€"ï¼Œtime slot å°±è¢«æ¸…ç†æ‰äº†
   - å¦‚æœä»»åŠ¡ç°åœ¨æ˜¯"æœªå®Œæˆï¼Œä½†å·²ç»è¿‡æœŸ"ï¼Œä½ åˆç¦æ­¢è‡ªåŠ¨å®Œæˆ
   - ä½†å¦ä¸€ä¸ªä»»åŠ¡æŠŠ time slot è®°å½•ç›´æ¥åˆ äº†
   - ä¹‹åå†æŸ¥å†å²/åšç»Ÿè®¡ï¼Œå¯èƒ½ä¼šå‡ºç°"æœ‰ä»»åŠ¡ä½†æ²¡æœ‰å¯¹åº” time slot"çš„ä¸ä¸€è‡´

2. **å†å²æŸ¥è¯¢/å®¡è®¡å®Œå…¨æ²¡æœ‰ time slot è®°å½•**
   - æŒ‰ç°åœ¨é€»è¾‘ï¼Œåªä¿ç•™"ä»Šå¤©åŠä»¥å"çš„ time slots
   - å¦‚æœä½ æœ‰"å†å²æ’ç­/é¢„çº¦è®°å½•"çš„éœ€æ±‚ï¼Œè¿™ä¸ªæ•°æ®ä¼šè¢«æ¸…å¾—å¾ˆå¹²å‡€

**âœ… è§£å†³æ–¹æ¡ˆï¼ˆé€‰ä¸€ï¼‰**:

**æ–¹æ¡ˆ A - ä¿å®ˆæ–¹æ¡ˆ**: è®© `_cleanup_expired_time_slots` åªæ¸…ç†"å¯¹åº”ä»»åŠ¡å·²å®Œæˆ/å–æ¶ˆ"çš„ time slot

ä¿®æ”¹ `backend/app/crud.py` ä¸­çš„ `cleanup_expired_time_slots()` å‡½æ•°ï¼Œæ·»åŠ ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ã€‚

**æ–¹æ¡ˆ B - ä¿ç•™æœŸé™æ–¹æ¡ˆ**: ç»™æ¸…ç†åŠ ä¸ªä¿ç•™æœŸé™ï¼Œæ¯”å¦‚"ä¿ç•™ 30/90 å¤©å‰çš„ time slot"ï¼Œè€Œä¸æ˜¯"æ˜¨å¤©ä»¥å‰å…¨éƒ¨åˆ "

ä¿®æ”¹æ¸…ç†é€»è¾‘ï¼Œä¿ç•™æœ€è¿‘ N å¤©çš„å†å²è®°å½•ã€‚

**æ–¹æ¡ˆ C - ç¡®è®¤ä¸éœ€è¦å†å²**: å¦‚æœç¡®å®šä¸éœ€è¦ä»»ä½•å†å²ï¼Œåˆ™è‡³å°‘ç¡®ä¿æ‰€æœ‰ä¾èµ– time-slot çš„é€»è¾‘ä¸ä¼šå†è¢«è°ƒç”¨ï¼ˆä¸ç„¶ä¼šæŸ¥ä¸åˆ°æ•°æ®ï¼‰

---

#### 3. CleanupTasks çš„ã€Œæ¯å¤©ä¸€æ¬¡ã€åªæ˜¯è¿›ç¨‹å†…è®°å¿†ï¼Œé‡å¯/å¤šå®ä¾‹ä¼šé‡å¤è·‘

**é—®é¢˜æè¿°**:

CleanupTasks æ˜¯ä¸€ä¸ªæ¯å°æ—¶è·‘ä¸€æ¬¡çš„å¾ªç¯ï¼Œå†…éƒ¨ç”¨ç±»ä¼¼ `last_xxx_cleanup_date` å˜é‡æ§åˆ¶"æ¯å¤©åªæ‰§è¡Œä¸€æ¬¡"çš„ä»»åŠ¡ï¼š
- `_cleanup_completed_tasks_files`
- `_cleanup_expired_tasks_files`
- `_cleanup_expired_flea_market_items`
- `_cleanup_expired_time_slots`
- `_auto_generate_future_time_slots`

**é£é™©**:

1. **é‡å¯è¿›ç¨‹åä¼šå†è·‘ä¸€æ¬¡**
   - `last_xxx_cleanup_date` æ˜¯å†…å­˜å˜é‡
   - ä½ ä¸­åˆé‡å¯æœåŠ¡ï¼Œè¿™äº›"æ¯å¤©ä¸€æ¬¡"çš„æ¸…ç†ä»»åŠ¡ä¼šåœ¨å½“å¤©å†æ¬¡æ‰§è¡Œä¸€è½®
   - å¯¹äº"å¹‚ç­‰ + æ•°æ®èŒƒå›´å°"çš„æ¸…ç†é—®é¢˜ä¸å¤§ï¼Œä½†å¯¹"IO/DB/æ–‡ä»¶éå†å¤š"çš„ä»»åŠ¡ï¼Œå°±æ˜¯é‡å¤è´Ÿè½½

2. **å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼Œæ¯ä¸ªå®ä¾‹éƒ½ä¼šå„è·‘ä¸€é**
   - æ¯”å¦‚ä½ åœ¨ç”Ÿäº§èµ·äº† 3 ä¸ª app å‰¯æœ¬ï¼Œæ¯ä¸ªå‰¯æœ¬éƒ½æœ‰è‡ªå·±çš„ CleanupTasks å¾ªç¯
   - é‚£"æ¯å¤©ä¸€æ¬¡"çš„ä»»åŠ¡ï¼Œå®é™…ä¸Šå˜æˆäº†"æ¯å¤© Ã— å®ä¾‹æ•° æ¬¡"
   - å¦‚æœæ¸…ç†é€»è¾‘æ²¡æœ‰åš"åˆ†ç‰‡/é”"ï¼Œå°±ä¼šæ˜¯çº¯é‡å¤å·¥ä½œ

**âœ… è§£å†³æ–¹æ¡ˆ**:

æŠŠ"æœ€è¿‘ä¸€æ¬¡æ‰§è¡Œæ—¶é—´"å­˜åˆ°å…±äº«å­˜å‚¨ï¼ˆDB/Redisï¼‰ï¼ŒæŒ‰ `task_name` åš keyï¼š

```python
# ä½¿ç”¨æ•°æ®åº“è¡¨è®°å½•æ‰§è¡Œæ—¶é—´
CREATE TABLE scheduled_task_executions (
    task_name VARCHAR(100) PRIMARY KEY,
    last_execution_date DATE NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

# æˆ–è€…ä½¿ç”¨ Redis
redis.set(f"scheduled_task:{task_name}:last_date", today, ex=86400*2)
```

æ‰§è¡Œå‰å…ˆ `SELECT ... FOR UPDATE` æˆ–ç”¨ Redis çš„ `SETNX` åšä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼š

```python
# ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”
lock_key = f"scheduled_task:{task_name}:lock"
if redis.setnx(lock_key, now, ex=3600):  # 1å°æ—¶è¿‡æœŸ
    try:
        # æ‰§è¡Œä»»åŠ¡
        pass
    finally:
        redis.delete(lock_key)
```

çœŸæ­£åšåˆ°ï¼šæ‰€æœ‰å®ä¾‹ + é‡å¯æƒ…å†µä¸‹ï¼Œæ•´ä¸ªç³»ç»Ÿå±‚é¢ä¿è¯ä¸€å¤©åªè·‘ä¸€æ¬¡ã€‚

---

#### 4. ä¼šè¯æ¸…ç†é€»è¾‘æœ‰ä¸¤æ¡å®šæ—¶é“¾è·¯ï¼ŒåŠŸèƒ½é‡å 

**é—®é¢˜æè¿°**:

å½“å‰æƒ…å†µï¼š
- **CleanupTasks ä¸­çš„ `_cleanup_expired_sessions`**: æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†å¾ªç¯æ—¶è·‘
  - è°ƒç”¨ `SecureAuthManager/ServiceAuthManager/AdminAuthManager.cleanup_expired_sessions`
  - å†è°ƒç”¨ `user_redis_cleanup.cleanup_all_user_data()`
- **ç‹¬ç«‹ä»»åŠ¡ `run_session_cleanup_task`**: æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  - ä¹Ÿæ˜¯æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆè‡³å°‘åŒ…æ‹¬ `SecureAuthManager.cleanup_expired_sessions()`ï¼‰

**é—®é¢˜**:

1. **ä¸ä¼šç›´æ¥é€ æˆé€»è¾‘é”™è¯¯**ï¼ˆæ¸…ç†å¤šä¸€æ¬¡ä¸€èˆ¬ä¸ä¼šå‡ºäº‹ï¼‰ï¼Œä½†åœ¨ Redis/DB æ“ä½œé¢‘ç‡ä¸Šæ˜¯ç¿»å€çš„
2. **é€»è¾‘ç»´æŠ¤åˆ†æ•£**: å¦‚æœä½ ä»¥åä¿®æ”¹"ä¼šè¯è¿‡æœŸè§„åˆ™"ï¼Œè¦æ”¹ä¸¤ä¸ªåœ°æ–¹ï¼Œå¾ˆå®¹æ˜“æ¼æ”¹å…¶ä¸€
3. **æ¸…ç†é¢‘ç‡è¿‡é«˜**: æ¯ 5 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡å¯èƒ½è¿‡äºé¢‘ç¹ï¼Œå› ä¸º Redis TTL å·²ç»å¤„ç†äº†å¤§éƒ¨åˆ†è¿‡æœŸé”®çš„è‡ªåŠ¨åˆ é™¤

**Redis TTL è®¾ç½®æƒ…å†µ**:

- **ç”¨æˆ·ä¼šè¯**: `session:{session_id}` è®¾ç½®äº† TTLï¼ˆ`SESSION_EXPIRE_HOURS * 3600`ï¼Œé»˜è®¤1å°æ—¶ï¼‰
- **å®¢æœä¼šè¯**: `service_session:{service_id}:{session_id}` è®¾ç½®äº† TTLï¼ˆ`SERVICE_SESSION_EXPIRE_HOURS * 3600`ï¼Œé»˜è®¤6å°æ—¶ï¼‰
- **ç®¡ç†å‘˜ä¼šè¯**: `admin_session:{admin_id}:{session_id}` è®¾ç½®äº† TTLï¼ˆ`ADMIN_SESSION_EXPIRE_HOURS * 3600`ï¼Œé»˜è®¤2å°æ—¶ï¼‰

**ä¸ºä»€ä¹ˆè¿˜éœ€è¦æ¸…ç†é€»è¾‘**:

è™½ç„¶ Redis TTL ä¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸçš„é”®ï¼Œä½†æ¸…ç†é€»è¾‘è¿˜åšäº†é¢å¤–çš„å·¥ä½œï¼š
1. **æ¸…ç†é›†åˆå†…çš„å…ƒç´ **: `user_sessions:{user_id}` é›†åˆå†…çš„ä¼šè¯IDä¸ä¼šéš TTL è‡ªåŠ¨åˆ é™¤ï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†
2. **æ¸…ç† `is_active=False` çš„ä¼šè¯**: å³ä½¿ TTL è¿˜æ²¡åˆ°ï¼Œè¢«æ ‡è®°ä¸ºä¸æ´»è·ƒçš„ä¼šè¯ä¹Ÿéœ€è¦åˆ é™¤
3. **å†…å­˜å­˜å‚¨çš„æ¸…ç†**: Redis ä¸å¯ç”¨æ—¶éœ€è¦æ¸…ç†å†…å­˜ä¸­çš„ä¼šè¯

**âœ… è§£å†³æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ A - é™ä½æ¸…ç†é¢‘ç‡**:
- å°† `run_session_cleanup_task` ä»æ¯ 5 åˆ†é’Ÿæ”¹ä¸ºæ¯å°æ—¶æˆ–æ¯å¤©
- æˆ–è€…å®Œå…¨ç§»é™¤ `run_session_cleanup_task`ï¼Œåªä¿ç•™ CleanupTasks ä¸­çš„æ¸…ç†ï¼ˆæ¯å°æ—¶ä¸€æ¬¡ï¼‰

**æ–¹æ¡ˆ B - æ”¹ä¸ºäº‹ä»¶é©±åŠ¨**:
- åœ¨ç”¨æˆ·ç™»å½•/ç™»å‡ºæ—¶è§¦å‘æ¸…ç†
- åœ¨æ£€æŸ¥ä¼šè¯æ•°é‡é™åˆ¶æ—¶è§¦å‘æ¸…ç†ï¼ˆ`_get_active_sessions` æ—¶ï¼‰
- ç§»é™¤å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼Œæ”¹ä¸ºæŒ‰éœ€æ¸…ç†

**æ–¹æ¡ˆ C - åˆå¹¶é€»è¾‘å¹¶é™ä½é¢‘ç‡**:
- æŠŠæ¸…ç†ä¼šè¯çš„æ ¸å¿ƒé€»è¾‘æŠ½æˆä¸€ä¸ªç»Ÿä¸€çš„å‡½æ•°ï¼Œæ¯”å¦‚ `cleanup_all_sessions()`
- CleanupTasks å’Œ `run_session_cleanup_task` éƒ½åªè°ƒç”¨è¿™ä¸ªç»Ÿä¸€å‡½æ•°
- é™ä½æ¸…ç†é¢‘ç‡åˆ°æ¯å°æ—¶æˆ–æ¯å¤©ä¸€æ¬¡

**æ¨èæ–¹æ¡ˆ**: **æ–¹æ¡ˆ Bï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰** + **æ–¹æ¡ˆ Cï¼ˆåˆå¹¶é€»è¾‘ï¼‰**
- åœ¨ç”¨æˆ·ç™»å½•æ—¶æ¸…ç†è¯¥ç”¨æˆ·çš„è¿‡æœŸä¼šè¯ï¼ˆæ£€æŸ¥ä¼šè¯æ•°é‡é™åˆ¶æ—¶ï¼‰
- åœ¨ç”¨æˆ·ç™»å‡ºæ—¶æ¸…ç†è¯¥ç”¨æˆ·çš„ä¼šè¯
- ä¿ç•™ CleanupTasks ä¸­çš„æ¸…ç†ä½œä¸ºå…œåº•ï¼ˆæ¯å°æ—¶ä¸€æ¬¡ï¼Œæ¸…ç†æ‰€æœ‰ç”¨æˆ·çš„è¿‡æœŸä¼šè¯ï¼‰
- ç§»é™¤ `run_session_cleanup_task`ï¼ˆæ¯ 5 åˆ†é’Ÿå¤ªé¢‘ç¹ï¼‰

---

#### 5. Celery / TaskScheduler å¯èƒ½å‡ºç°"è¯¯åŒè·‘"çš„é£é™©

**é—®é¢˜æè¿°**:

é€»è¾‘ä¸Šè®¾è®¡æ˜¯ï¼š
- å¯åŠ¨æ—¶æ£€æµ‹ Redis/Celery Worker çŠ¶æ€
- èƒ½ç”¨å°±ç”¨ Celery + Beat
- ä¸èƒ½ç”¨å°±ç”¨ TaskScheduler

ç†è®ºä¸Šä¸ä¼šåŒæ—¶è·‘ä¸¤å¥—ï¼Œä½†åœ¨çœŸå®è¿ç»´é‡Œï¼Œå®¹æ˜“å‡ºç°è¿™ç§æƒ…å†µï¼š

**é…ç½®/ç¯å¢ƒæé”™**: æŸä¸ªå®ä¾‹æ²¡æ£€æµ‹åˆ° Celery å¯ç”¨ï¼Œè¿˜æ˜¯å¯ç”¨äº† TaskScheduler

äºæ˜¯ï¼šåŒä¸€æ‰¹ä»»åŠ¡ï¼Œè¢« Celery Beat + TaskScheduler åŒé‡è°ƒåº¦

**å½±å“**:
- ä¸šåŠ¡å‰¯ä½œç”¨è¢«æ‰§è¡Œä¸¤æ¬¡ï¼ˆä¾‹å¦‚å‘é€šçŸ¥ã€å‘ç§¯åˆ†ï¼‰
- å³ä½¿ä»»åŠ¡æ˜¯å¹‚ç­‰çš„ï¼Œä¹Ÿä¼šé€ æˆé¢å¤– DB å‹åŠ›

**âœ… è§£å†³æ–¹æ¡ˆ**:

å¼•å…¥ä¸€ä¸ªæ˜ç¡®çš„å¼€å…³ï¼Œä¾‹å¦‚ `SCHEDULER_MODE=celery / local`ï¼š

```python
# åœ¨ main.py çš„ startup_event ä¸­
SCHEDULER_MODE = os.getenv("SCHEDULER_MODE", "auto")  # auto, celery, local

if SCHEDULER_MODE == "celery":
    # åªå…è®¸ Celery Beat è°ƒåº¦ï¼ŒTaskScheduler æ ¹æœ¬ä¸åˆå§‹åŒ–
    # å¼ºåˆ¶è¦æ±‚ Celery å¯ç”¨
elif SCHEDULER_MODE == "local":
    # åªç”¨ TaskSchedulerï¼Œå®Œå…¨ä¸è·‘ Celery Beat
    # ä¸æ£€æµ‹ Celery
else:  # auto
    # è‡ªåŠ¨æ£€æµ‹ + é»˜è®¤å€¼ï¼ˆå½“å‰é€»è¾‘ï¼‰
```

å¯åŠ¨é€»è¾‘å¯ä»¥ä»ç„¶åš"è‡ªåŠ¨æ£€æµ‹ + é»˜è®¤å€¼"ï¼Œä½†æœ€ç»ˆä»¥ç¯å¢ƒå˜é‡ä¸ºå‡†ï¼Œé¿å…åŒè·‘ã€‚

---

### âš ï¸ äºŒã€å¯ä»¥ä¼˜åŒ–ï¼ˆæ€§èƒ½ / å¯é æ€§ï¼‰çš„ç‚¹

#### 6. é«˜é¢‘/é‡ä»»åŠ¡è¦é¿å…"å è·‘"ï¼Œå»ºè®®åŠ åˆ†å¸ƒå¼é”æˆ– skip æœºåˆ¶

**é—®é¢˜æè¿°**:

å‡ ä¸ªå…¸å‹ä»»åŠ¡ï¼š
- `update-all-users-statistics`: æ¯ 10 åˆ†é’Ÿä¸€æ¬¡
- å®¢æœé˜Ÿåˆ—ç›¸å…³ä»»åŠ¡ï¼šæ¯ 30 ç§’ä¸€æ¬¡
- è¿‡æœŸæ£€æŸ¥ï¼šæ¯ 5 åˆ†é’Ÿä¸€æ¬¡ï¼ˆä¼˜æƒ åˆ¸ / é‚€è¯·ç  / ç§¯åˆ† / æ´»åŠ¨ï¼‰

å¦‚æœæŸæ¬¡æ‰§è¡Œå› ä¸ºæ•°æ®é‡è¿‡å¤§æˆ– DB æ…¢è€Œæ‹‰é•¿æ‰§è¡Œæ—¶é—´ï¼Œå°±ä¼šå‡ºç°ï¼š
- ä¸Šä¸€è½®è¿˜æ²¡è·‘å®Œï¼Œä¸‹ä¸€è½®è°ƒåº¦åˆæ¥äº†
- Celery é»˜è®¤æ˜¯ä¼šæŠŠæ¯ä¸€è½®éƒ½è·‘æ‰çš„ï¼Œé™¤éä½ ä¸»åŠ¨åœ¨ä»»åŠ¡é‡Œåš"è‡ªæˆ‘è·³è¿‡"

**âœ… è§£å†³æ–¹æ¡ˆ**:

åœ¨ä»»åŠ¡å¼€å§‹æ—¶ï¼Œç”¨ Redis åšä¸€ä¸ªç®€æ˜“é”ï¼š

```python
@celery_app.task
def update_all_users_statistics_task(self):
    lock_key = "scheduled:update_all_users_statistics:lock"
    lock_ttl = 600  # 10åˆ†é’Ÿ
    
    # å°è¯•è·å–é”
    if not redis.setnx(lock_key, time.time(), ex=lock_ttl):
        logger.warning("ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡è°ƒåº¦")
        return {"status": "skipped", "reason": "previous_task_running"}
    
    try:
        # æ‰§è¡Œä»»åŠ¡
        update_all_users_statistics()
    finally:
        redis.delete(lock_key)
```

æˆ–è€…åœ¨ DB é‡Œç”¨ä¸€å¼  `scheduled_task_lock` å°è¡¨è®°å½• `task_name + last_start_time + running` çŠ¶æ€ï¼Œé…åˆ `SELECT ... FOR UPDATE`ã€‚

è¿™æ ·èƒ½é¿å…"æ•°æ®é‡ä¸€å¤§å°±ç–¯ç‹‚å è·‘ï¼ŒæŠŠæ•°æ®åº“å‹æ­»"çš„æƒ…å†µã€‚

---

#### 7. `_cleanup_unused_temp_images` æ¯å°æ—¶æ‰«æ–‡ä»¶ç³»ç»Ÿï¼Œå¯èƒ½éœ€è¦é™æµ/åˆ†ç‰‡

**é—®é¢˜æè¿°**:

è¿™ä¸ªä»»åŠ¡æ¯æ¬¡å¾ªç¯éƒ½ä¼šï¼š
- éå† `uploads/public/images/public/temp_*`
- éå† `uploads/flea_market/temp_*`
- åˆ é™¤è¶…è¿‡ 24 å°æ—¶çš„ä¸´æ—¶å›¾ç‰‡

å¦‚æœä½ çš„å›¾ç‰‡é‡å˜å¤§ï¼š
- ä¸€æ¬¡æ€§æ‰«æ•´ä¸ªç›®å½•ä¼šæ¯”è¾ƒåƒ IO
- åœ¨å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼Œè¿˜ä¼šè¢«å¤šæ¬¡é‡å¤æ‰«

**âœ… ä¼˜åŒ–æ€è·¯**:

1. **æ¯æ¬¡åªå¤„ç†å‰ N ä¸ªæ–‡ä»¶**ï¼ˆä¾‹å¦‚æŒ‰æ–‡ä»¶å/æ—¶é—´æ’åºå–å‰ 1000 ä¸ªï¼‰ï¼Œé¿å…ä¸€æ¬¡çˆ†æ‰«
2. **åœ¨ DB/Redis ä¸­è®°å½•ä¸Šä¼ æ—¶é—´**ï¼ŒæŒ‰æ—¶é—´çª—å£å»åˆ ï¼Œè€Œä¸æ˜¯ file system å…¨é‡éå†
3. **ç»“åˆåˆ†å¸ƒå¼é”/æ¯æ—¥ä¸€æ¬¡æ§åˆ¶**ï¼Œé˜²æ­¢å¤šå®ä¾‹é‡å¤å¹²åŒä¸€ä»¶äº‹

---

#### 8. è¿‡æœŸæ£€æŸ¥ä»»åŠ¡çš„é¢‘ç‡å¯ä»¥æŒ‰ä¸šåŠ¡éœ€æ±‚å†ç»†åˆ†

**é—®é¢˜æè¿°**:

ç›®å‰æ‰€æœ‰è¿‡æœŸæ£€æŸ¥ä»»åŠ¡çš„é¢‘ç‡æ˜¯ç»Ÿä¸€çš„ï¼ˆ5 åˆ†é’Ÿï¼‰ï¼š
- ä¼˜æƒ åˆ¸è¿‡æœŸ
- é‚€è¯·ç è¿‡æœŸ
- ç§¯åˆ†è¿‡æœŸ
- æ´»åŠ¨ç»“æŸ

ä½†è¿™å‡ ç±»çš„"å®æ—¶æ€§éœ€æ±‚"å¹¶ä¸ä¸€å®šä¸€æ ·ï¼š
- ä¼˜æƒ åˆ¸/ç§¯åˆ†ï¼šå¾ˆå¤šåœºæ™¯ä¸‹"å»¶åå‡ å°æ—¶æ‰æ ‡è®°è¿‡æœŸ"ä¹Ÿèƒ½æ¥å—
- æ´»åŠ¨ç»“æŸï¼šå¦‚æœç»“æŸæ—¶é—´ç‚¹æ˜¯å¯¹ç”¨æˆ·å¯è§çš„ï¼Œ5 åˆ†é’Ÿå†…ç»“æŸè¿˜ç®— OK
- é‚€è¯·ç ï¼šä¸€èˆ¬ä¹Ÿæ²¡å¼ºå®æ—¶éœ€æ±‚

**âœ… å»ºè®®**:

æŠŠå®ƒä»¬æ‹†æˆä¸åŒé¢‘ç‡ï¼Œä¾‹å¦‚ï¼š
- æ´»åŠ¨ç»“æŸï¼š5 åˆ†é’Ÿï¼ˆéœ€è¦è¾ƒé«˜å®æ—¶æ€§ï¼‰
- ä¼˜æƒ åˆ¸/é‚€è¯·ç ï¼š15 åˆ†é’Ÿ æˆ– 1 å°æ—¶
- ç§¯åˆ†ï¼š1 å°æ—¶

æˆ–è€…ç»Ÿä¸€æ”¾åˆ° CleanupTasks ä¸­åš"æŒ‰æ—¶é—´çª—å£çš„æ‰¹é‡æ‰«æ"ï¼Œå‡å°‘é«˜é¢‘è½®è¯¢ã€‚

è¿™æ ·èƒ½å°‘ä¸€äº› DB æ‰«æå‹åŠ›ã€‚

---

#### 9. æ—¶åŒºé—®é¢˜ï¼šCrontab ä»»åŠ¡åœ¨ UTC è·‘è¿˜æ˜¯ä¸šåŠ¡æ—¶åŒºè·‘ï¼Ÿ

**ä¸šåŠ¡æ—¶åŒºè¯´æ˜**:

- **ä¸šåŠ¡æ—¶åŒº**: è‹±å›½ï¼ˆEurope/Londonï¼‰
- **ä½¿ç”¨æœ€å°‘çš„æ—¶é—´æ®µ**: è‹±å›½æ—¶é—´å‡Œæ™¨ 3:00 - 5:00ï¼ˆUTC æ—¶é—´ 2:00 - 4:00 æˆ– 3:00 - 5:00ï¼Œå–å†³äºå¤ä»¤æ—¶ï¼‰
- **å½“å‰é…ç½®**: Celery æ—¶åŒºè®¾ç½®ä¸º UTC

**å½“å‰ Crontab ä»»åŠ¡æ‰§è¡Œæ—¶é—´**:

- `cleanup-long-inactive-chats`: UTC æ—¶é—´å‡Œæ™¨ 2 ç‚¹
  - è‹±å›½å¤ä»¤æ—¶æœŸé—´ï¼ˆ3æœˆ-10æœˆï¼‰ï¼šè‹±å›½æ—¶é—´å‡Œæ™¨ 3 ç‚¹ âœ…ï¼ˆç¬¦åˆä½¿ç”¨æœ€å°‘æ—¶é—´æ®µï¼‰
  - è‹±å›½å†¬ä»¤æ—¶æœŸé—´ï¼ˆ10æœˆ-3æœˆï¼‰ï¼šè‹±å›½æ—¶é—´å‡Œæ™¨ 2 ç‚¹ âœ…ï¼ˆç¬¦åˆä½¿ç”¨æœ€å°‘æ—¶é—´æ®µï¼‰
- `update-featured-task-experts-response-time`: UTC æ—¶é—´å‡Œæ™¨ 3 ç‚¹
  - è‹±å›½å¤ä»¤æ—¶æœŸé—´ï¼ˆ3æœˆ-10æœˆï¼‰ï¼šè‹±å›½æ—¶é—´å‡Œæ™¨ 4 ç‚¹ âœ…ï¼ˆç¬¦åˆä½¿ç”¨æœ€å°‘æ—¶é—´æ®µï¼‰
  - è‹±å›½å†¬ä»¤æ—¶æœŸé—´ï¼ˆ10æœˆ-3æœˆï¼‰ï¼šè‹±å›½æ—¶é—´å‡Œæ™¨ 3 ç‚¹ âœ…ï¼ˆç¬¦åˆä½¿ç”¨æœ€å°‘æ—¶é—´æ®µï¼‰

**âœ… å»ºè®®**:

**æ¨èæ–¹æ¡ˆ**: å°† Celery æ—¶åŒºæ”¹ä¸ºè‹±å›½æ—¶åŒºï¼Œè¿™æ · Crontab ä»»åŠ¡çš„æ—¶é—´é…ç½®æ›´ç›´è§‚

```python
celery_app.conf.update(
    timezone='Europe/London',  # è‹±å›½æ—¶åŒº
    enable_utc=False,  # æˆ–ä¿æŒ Trueï¼Œä½†ä½¿ç”¨è‹±å›½æ—¶åŒºçš„ crontab æ—¶é—´
)
```

ç„¶åè°ƒæ•´ Crontab ä»»åŠ¡æ—¶é—´ä¸ºè‹±å›½æ—¶é—´ 3-5 ç‚¹ï¼ˆä½¿ç”¨æœ€å°‘çš„æ—¶é—´æ®µï¼‰ï¼š

```python
# æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ - è‹±å›½æ—¶é—´å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ
'cleanup-long-inactive-chats': {
    'task': 'app.celery_tasks.cleanup_long_inactive_chats_task',
    'schedule': crontab(hour=3, minute=0),  # è‹±å›½æ—¶é—´å‡Œæ™¨ 3 ç‚¹
},

# æ›´æ–°ç‰¹å¾ä»»åŠ¡è¾¾äººçš„å“åº”æ—¶é—´ - è‹±å›½æ—¶é—´å‡Œæ™¨ 4 ç‚¹æ‰§è¡Œ
'update-featured-task-experts-response-time': {
    'task': 'app.celery_tasks.update_featured_task_experts_response_time_task',
    'schedule': crontab(hour=4, minute=0),  # è‹±å›½æ—¶é—´å‡Œæ™¨ 4 ç‚¹
},
```

**å¤‡é€‰æ–¹æ¡ˆ**: ä¿æŒ UTCï¼Œä½†æ˜ç¡®æ–‡æ¡£è¯´æ˜ï¼š
- UTC 2 ç‚¹ â‰ˆ è‹±å›½æ—¶é—´ 3 ç‚¹ï¼ˆå¤ä»¤æ—¶ï¼‰æˆ– 2 ç‚¹ï¼ˆå†¬ä»¤æ—¶ï¼‰
- UTC 3 ç‚¹ â‰ˆ è‹±å›½æ—¶é—´ 4 ç‚¹ï¼ˆå¤ä»¤æ—¶ï¼‰æˆ– 3 ç‚¹ï¼ˆå†¬ä»¤æ—¶ï¼‰
- è¿™äº›æ—¶é—´éƒ½åœ¨è‹±å›½ä½¿ç”¨æœ€å°‘çš„æ—¶é—´æ®µï¼ˆ3-5ç‚¹ï¼‰å†…

---

#### 10. å®¢æœé˜Ÿåˆ—ä»»åŠ¡å¯ä»¥è€ƒè™‘ä»"çº¯è½®è¯¢"å‘"äº‹ä»¶é©±åŠ¨ + è½®è¯¢å…œåº•"æ¼”è¿›

**é—®é¢˜æè¿°**:

ç°åœ¨å®¢æœç›¸å…³æœ‰ä¸‰ä¸ª 30 ç§’ä¸€æ¬¡çš„ä»»åŠ¡ï¼š
- å¤„ç†æ’é˜Ÿ
- è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯
- å‘é€è¶…æ—¶é¢„è­¦

å¦‚æœå½“å‰è´Ÿè½½è¿˜å°ï¼Œ30 ç§’è½®è¯¢æ²¡é—®é¢˜ï¼›ä½†éšç€ç”¨æˆ·é‡å¢åŠ ï¼š
- æ¯ 30 ç§’ä¸€æ¬¡æ‰«æé˜Ÿåˆ—/ä¼šè¯è¡¨ï¼Œæˆæœ¬ä¼šå˜é«˜
- æ˜æ˜æœ‰äº‹ä»¶è§¦å‘ï¼ˆæ¥æ¶ˆæ¯ã€ç”¨æˆ·è¿›å…¥é˜Ÿåˆ—ï¼‰ï¼Œå´è¦é€šè¿‡ poll æ¥é©±åŠ¨

**âœ… å¯æ¼”è¿›æ–¹å‘ï¼ˆä¸ç”¨ç°åœ¨å°±æ”¹ï¼‰**:

1. **äº‹ä»¶é©±åŠ¨**: å½“ç”¨æˆ·è¿›å…¥é˜Ÿåˆ—æ—¶ï¼Œç›´æ¥è§¦å‘ä¸€ä¸ª Celery ä»»åŠ¡å»"å°è¯•åˆ†é…ä¸€æ¬¡"
2. **è½®è¯¢å…œåº•**: è½®è¯¢ä»»åŠ¡å¯ä»¥æ”¹æˆ"å‡ åˆ†é’Ÿä¸€æ¬¡ï¼Œåªåšå…œåº•æ£€æŸ¥"
3. **å»¶æ—¶ä»»åŠ¡**: å¯¹è¶…æ—¶/é¢„è­¦ï¼Œä¹Ÿå¯ä»¥æ ¹æ®"ä¸‹ä¸€æ¬¡è¶…æ—¶æ—¶é—´"æ³¨å†Œä¸€ç±»å»¶æ—¶ä»»åŠ¡ï¼ˆä¸è¿‡å®ç°ä¼šå¤æ‚ä¸€äº›ï¼‰

---

## æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ **Celery** ä½œä¸ºåˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”¨äºæ‰§è¡Œå®šæ—¶ä»»åŠ¡å’Œåå°ä»»åŠ¡ã€‚Celery æä¾›äº†ï¼š

- âœ… åˆ†å¸ƒå¼ä»»åŠ¡æ‰§è¡Œ
- âœ… å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼ˆCelery Beatï¼‰
- âœ… ä»»åŠ¡é‡è¯•æœºåˆ¶
- âœ… ä»»åŠ¡ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
- âœ… è‡ªåŠ¨æ•…éšœæ¢å¤
- âœ… ä¼˜é›…é™çº§ï¼ˆå›é€€åˆ° TaskSchedulerï¼‰

### ä¸šåŠ¡æ—¶åŒºè¯´æ˜

- **ä¸šåŠ¡æ—¶åŒº**: è‹±å›½ï¼ˆEurope/Londonï¼‰
- **ä½¿ç”¨æœ€å°‘çš„æ—¶é—´æ®µ**: è‹±å›½æ—¶é—´å‡Œæ™¨ 3:00 - 5:00
- **Celery æ—¶åŒºé…ç½®**: UTCï¼ˆå½“å‰ï¼‰
- **æ¯æ—¥ç»´æŠ¤ä»»åŠ¡**: å·²å®‰æ’åœ¨ UTC 2-3 ç‚¹æ‰§è¡Œï¼Œå¯¹åº”è‹±å›½æ—¶é—´ 3-4 ç‚¹ï¼ˆåœ¨ä½¿ç”¨æœ€å°‘æ—¶é—´æ®µå†…ï¼‰
  - å¤ä»¤æ—¶æœŸé—´ï¼ˆ3æœˆ-10æœˆï¼‰ï¼šUTC 2ç‚¹ = è‹±å›½æ—¶é—´ 3ç‚¹ï¼ŒUTC 3ç‚¹ = è‹±å›½æ—¶é—´ 4ç‚¹
  - å†¬ä»¤æ—¶æœŸé—´ï¼ˆ10æœˆ-3æœˆï¼‰ï¼šUTC 2ç‚¹ = è‹±å›½æ—¶é—´ 2ç‚¹ï¼ŒUTC 3ç‚¹ = è‹±å›½æ—¶é—´ 3ç‚¹

### æ ¸å¿ƒç»„ä»¶

1. **Celery App** (`backend/app/celery_app.py`) - Celery åº”ç”¨é…ç½®
2. **Celery Tasks** (`backend/app/celery_tasks.py`) - é€šç”¨å®šæ—¶ä»»åŠ¡
3. **Customer Service Tasks** (`backend/app/customer_service_tasks.py`) - å®¢æœç³»ç»Ÿä»»åŠ¡
4. **Task Scheduler** (`backend/app/task_scheduler.py`) - å¤‡ç”¨è°ƒåº¦å™¨

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI App   â”‚
â”‚   (ä¸»åº”ç”¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ æ£€æµ‹ Celery Worker
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Redis   â”‚â—„â”€â”€â”€â”€â”€â”€â”
    â”‚ (Broker)â”‚       â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
         â”‚            â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚                       â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ Celery â”‚          â”‚ Celery Beat â”‚
â”‚ Worker â”‚          â”‚ (è°ƒåº¦å™¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµç¨‹

1. **FastAPI åº”ç”¨å¯åŠ¨** â†’ æ£€æµ‹ Celery Worker æ˜¯å¦å¯ç”¨
2. **å¦‚æœ Celery å¯ç”¨** â†’ ä½¿ç”¨ Celery Beat è°ƒåº¦ä»»åŠ¡ï¼ŒCelery Worker æ‰§è¡Œ
3. **å¦‚æœ Celery ä¸å¯ç”¨** â†’ å›é€€åˆ° TaskSchedulerï¼ˆçº¿ç¨‹è°ƒåº¦å™¨ï¼‰

---

## é…ç½®è¯´æ˜

### Celery åº”ç”¨é…ç½®

**æ–‡ä»¶ä½ç½®**: `backend/app/celery_app.py`

#### åŸºæœ¬é…ç½®

```python
celery_app = Celery(
    'linku_tasks',  # åº”ç”¨åç§°
    broker=REDIS_URL if USE_REDIS else 'memory://',  # æ¶ˆæ¯ä»£ç†
    backend=REDIS_URL if USE_REDIS else 'cache+memory://',  # ç»“æœåç«¯
    include=[
        'app.customer_service_tasks',  # å®¢æœä»»åŠ¡æ¨¡å—
        'app.celery_tasks'  # é€šç”¨ä»»åŠ¡æ¨¡å—
    ]
)
```

#### ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | é»˜è®¤å€¼ | å¿…éœ€ |
|--------|------|--------|------|
| `REDIS_URL` | Redis è¿æ¥ URL | `redis://localhost:6379/0` | æ˜¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ |
| `USE_REDIS` | æ˜¯å¦ä½¿ç”¨ Redis | `true` | å¦ |

#### Celery é…ç½®å‚æ•°

```python
celery_app.conf.update(
    # åºåˆ—åŒ–é…ç½®
    task_serializer='json',
    accept_content=['json'],
    result_serializer='json',
    
    # æ—¶åŒºé…ç½®
    timezone='UTC',  # æ³¨æ„ï¼šä¸šåŠ¡æ—¶åŒºæ˜¯è‹±å›½ï¼ˆEurope/Londonï¼‰ï¼ŒUTC æ—¶é—´ä¸è‹±å›½æ—¶é—´åœ¨å¤ä»¤æ—¶æœŸé—´ç›¸åŒï¼Œå†¬ä»¤æ—¶æœŸé—´è‹±å›½æ—¶é—´æ¯” UTC æ™š1å°æ—¶
    enable_utc=True,
    
    # ä»»åŠ¡è·Ÿè¸ª
    task_track_started=True,
    
    # è¶…æ—¶é…ç½®
    task_time_limit=30 * 60,  # 30åˆ†é’Ÿç¡¬è¶…æ—¶
    task_soft_time_limit=25 * 60,  # 25åˆ†é’Ÿè½¯è¶…æ—¶
    
    # Worker é…ç½®
    worker_prefetch_multiplier=1,  # æ¯ä¸ª worker é¢„å–1ä¸ªä»»åŠ¡
    worker_max_tasks_per_child=1000,  # æ¯ä¸ªå­è¿›ç¨‹æœ€å¤šæ‰§è¡Œ1000ä¸ªä»»åŠ¡åé‡å¯
    
    # ä»»åŠ¡ç¡®è®¤é…ç½®
    task_acks_late=True,  # ä»»åŠ¡å®Œæˆåæ‰ç¡®è®¤ï¼Œé˜²æ­¢ä»»åŠ¡ä¸¢å¤±
    task_reject_on_worker_lost=True,  # Worker ä¸¢å¤±æ—¶æ‹’ç»ä»»åŠ¡
    
    # é»˜è®¤é‡è¯•é…ç½®
    task_default_retry_delay=60,  # é»˜è®¤é‡è¯•å»¶è¿Ÿ60ç§’
    task_max_retries=3,  # é»˜è®¤æœ€å¤§é‡è¯•3æ¬¡
)
```

---

## ä»»åŠ¡åˆ—è¡¨

### ä»»åŠ¡åˆ†ç±»

é¡¹ç›®ä¸­çš„å®šæ—¶ä»»åŠ¡åˆ†ä¸ºä¸‰ç±»ï¼š

1. **Celery å®šæ—¶ä»»åŠ¡** - é€šè¿‡ Celery Beat è°ƒåº¦ï¼ŒCelery Worker æ‰§è¡Œï¼ˆä¸»è¦æ–¹å¼ï¼‰
2. **CleanupTasks ä»»åŠ¡** - é€šè¿‡ `CleanupTasks` ç±»ç®¡ç†ï¼Œæ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆæ¸…ç†ä»»åŠ¡ï¼‰
3. **TaskScheduler ä»»åŠ¡** - å¤‡ç”¨è°ƒåº¦å™¨ï¼Œå½“ Celery ä¸å¯ç”¨æ—¶ä½¿ç”¨
4. **å…¶ä»–ç‹¬ç«‹ä»»åŠ¡** - ç‹¬ç«‹è¿è¡Œçš„åå°ä»»åŠ¡

### ä¸€ã€Celery å®šæ—¶ä»»åŠ¡ï¼ˆ12ä¸ªï¼‰

è¿™äº›ä»»åŠ¡é€šè¿‡ Celery Beat è°ƒåº¦ï¼ŒCelery Worker æ‰§è¡Œã€‚

#### 1. å®¢æœç³»ç»Ÿä»»åŠ¡ï¼ˆé«˜é¢‘ - 30ç§’ï¼‰

| ä»»åŠ¡åç§° | ä»»åŠ¡å‡½æ•° | è¯´æ˜ | é‡è¯•é…ç½® |
|---------|---------|------|---------|
| `process-customer-service-queue` | `process_customer_service_queue_task` | å¤„ç†å®¢æœæ’é˜Ÿï¼Œæ‰¹é‡åˆ†é…ç”¨æˆ·ç»™å®¢æœ | 3æ¬¡ï¼Œå»¶è¿Ÿ30ç§’ |
| `auto-end-timeout-chats` | `auto_end_timeout_chats_task` | è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯ï¼ˆ2åˆ†é’Ÿæ— æ´»åŠ¨ï¼‰ | 3æ¬¡ï¼Œå»¶è¿Ÿ30ç§’ |
| `send-timeout-warnings` | `send_timeout_warnings_task` | å‘é€è¶…æ—¶é¢„è­¦ï¼ˆ1åˆ†é’Ÿé¢„è­¦ï¼‰ | 3æ¬¡ï¼Œå»¶è¿Ÿ30ç§’ |

#### 2. ä»»åŠ¡ç®¡ç†ä»»åŠ¡ï¼ˆé«˜é¢‘ - 1åˆ†é’Ÿï¼‰

| ä»»åŠ¡åç§° | ä»»åŠ¡å‡½æ•° | è¯´æ˜ | é‡è¯•é…ç½® |
|---------|---------|------|---------|
| `cancel-expired-tasks` | `cancel_expired_tasks_task` | å–æ¶ˆè¿‡æœŸä»»åŠ¡ | 3æ¬¡ï¼Œå»¶è¿Ÿ60ç§’ |
| `auto-complete-expired-time-slot-tasks` | `auto_complete_expired_time_slot_tasks_task` | è‡ªåŠ¨å®Œæˆå·²è¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡ | 3æ¬¡ï¼Œå»¶è¿Ÿ60ç§’ |

#### 3. è¿‡æœŸæ£€æŸ¥ä»»åŠ¡ï¼ˆä¸­é¢‘ - 5åˆ†é’Ÿï¼‰

| ä»»åŠ¡åç§° | ä»»åŠ¡å‡½æ•° | è¯´æ˜ | é‡è¯•é…ç½® |
|---------|---------|------|---------|
| `check-expired-coupons` | `check_expired_coupons_task` | æ£€æŸ¥å¹¶æ ‡è®°è¿‡æœŸä¼˜æƒ åˆ¸ | 3æ¬¡ï¼Œå»¶è¿Ÿ60ç§’ |
| `check-expired-invitation-codes` | `check_expired_invitation_codes_task` | æ£€æŸ¥å¹¶æ ‡è®°è¿‡æœŸé‚€è¯·ç  | 3æ¬¡ï¼Œå»¶è¿Ÿ60ç§’ |
| `check-expired-points` | `check_expired_points_task` | æ£€æŸ¥å¹¶æ ‡è®°è¿‡æœŸç§¯åˆ† | 3æ¬¡ï¼Œå»¶è¿Ÿ60ç§’ |
| `check-and-end-activities` | `check_and_end_activities_task` | æ£€æŸ¥å¹¶ç»“æŸè¿‡æœŸæ´»åŠ¨ | 2æ¬¡ï¼Œå»¶è¿Ÿ120ç§’ |

#### 4. ç»Ÿè®¡æ›´æ–°ä»»åŠ¡ï¼ˆä½é¢‘ - 10åˆ†é’Ÿï¼‰

| ä»»åŠ¡åç§° | ä»»åŠ¡å‡½æ•° | è¯´æ˜ | é‡è¯•é…ç½® |
|---------|---------|------|---------|
| `update-all-users-statistics` | `update_all_users_statistics_task` | æ›´æ–°æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ | 2æ¬¡ï¼Œå»¶è¿Ÿ300ç§’ |

#### 5. æ¯æ—¥ç»´æŠ¤ä»»åŠ¡ï¼ˆæ¯å¤©ç‰¹å®šæ—¶é—´ï¼‰

| ä»»åŠ¡åç§° | ä»»åŠ¡å‡½æ•° | æ‰§è¡Œæ—¶é—´ | è¯´æ˜ | é‡è¯•é…ç½® |
|---------|---------|---------|------|---------|
| `cleanup-long-inactive-chats` | `cleanup_long_inactive_chats_task` | UTC å‡Œæ™¨2ç‚¹ï¼ˆè‹±å›½æ—¶é—´3ç‚¹/2ç‚¹ï¼‰ | æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ï¼ˆ30å¤©ï¼‰ | 2æ¬¡ï¼Œå»¶è¿Ÿ300ç§’ |
| `update-featured-task-experts-response-time` | `update_featured_task_experts_response_time_task` | UTC å‡Œæ™¨3ç‚¹ï¼ˆè‹±å›½æ—¶é—´4ç‚¹/3ç‚¹ï¼‰ | æ›´æ–°ç‰¹å¾ä»»åŠ¡è¾¾äººçš„å“åº”æ—¶é—´ | 2æ¬¡ï¼Œå»¶è¿Ÿ300ç§’ |

**æ³¨æ„**: 
- ä¸šåŠ¡æ—¶åŒºä¸ºè‹±å›½ï¼ˆEurope/Londonï¼‰
- è‹±å›½æ—¶é—´ 3:00-5:00 æ˜¯ä½¿ç”¨æœ€å°‘çš„æ—¶é—´æ®µ
- å½“å‰ä»»åŠ¡æ‰§è¡Œæ—¶é—´å·²å®‰æ’åœ¨è‹±å›½ä½¿ç”¨æœ€å°‘çš„æ—¶é—´æ®µå†…

---

### äºŒã€CleanupTasks æ¸…ç†ä»»åŠ¡ï¼ˆ8ä¸ªï¼‰

è¿™äº›ä»»åŠ¡é€šè¿‡ `CleanupTasks` ç±»ç®¡ç†ï¼Œæ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†å¾ªç¯ã€‚éƒ¨åˆ†ä»»åŠ¡æ¯å¤©åªæ‰§è¡Œä¸€æ¬¡ï¼ˆé€šè¿‡æ—¥æœŸæ£€æŸ¥ï¼‰ã€‚

**æ‰§è¡Œé¢‘ç‡**: æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†å¾ªç¯ï¼ˆ`cleanup_interval = 3600`ï¼‰

**ä½ç½®**: `backend/app/cleanup_tasks.py`

| ä»»åŠ¡åç§° | æ–¹æ³•å | æ‰§è¡Œé¢‘ç‡ | è¯´æ˜ | è°ƒç”¨å‡½æ•° |
|---------|--------|---------|------|---------|
| `æ¸…ç†è¿‡æœŸä¼šè¯` | `_cleanup_expired_sessions` | æ¯æ¬¡å¾ªç¯ | æ¸…ç†ç”¨æˆ·ã€å®¢æœã€ç®¡ç†å‘˜çš„è¿‡æœŸä¼šè¯ï¼Œæ¸…ç†ç”¨æˆ·Redisæ•°æ® | `SecureAuthManager.cleanup_expired_sessions()`, `ServiceAuthManager.cleanup_expired_sessions()`, `AdminAuthManager.cleanup_expired_sessions()`, `user_redis_cleanup.cleanup_all_user_data()` |
| `æ¸…ç†è¿‡æœŸç¼“å­˜` | `_cleanup_expired_cache` | æ¯æ¬¡å¾ªç¯ | æ¸…ç†Redisä¸­è¶…è¿‡7å¤©æœªä½¿ç”¨çš„ç¼“å­˜é”® | `redis_cache.delete()` |
| `æ¸…ç†å·²å®Œæˆä»»åŠ¡æ–‡ä»¶` | `_cleanup_completed_tasks_files` | æ¯å¤©ä¸€æ¬¡ | æ¸…ç†å·²å®Œæˆè¶…è¿‡3å¤©çš„ä»»åŠ¡çš„å›¾ç‰‡å’Œæ–‡ä»¶ | `app.crud.cleanup_completed_tasks_files(db)` |
| `æ¸…ç†è¿‡æœŸä»»åŠ¡æ–‡ä»¶` | `_cleanup_expired_tasks_files` | æ¯å¤©ä¸€æ¬¡ | æ¸…ç†è¿‡æœŸä»»åŠ¡ï¼ˆå·²å–æ¶ˆæˆ–deadlineå·²è¿‡è¶…è¿‡3å¤©ï¼‰çš„æ–‡ä»¶ | `app.crud.cleanup_expired_tasks_files(db)` |
| `æ¸…ç†è¿‡æœŸè·³èš¤å¸‚åœºå•†å“` | `_cleanup_expired_flea_market_items` | æ¯å¤©ä¸€æ¬¡ | æ¸…ç†è¶…è¿‡10å¤©æœªåˆ·æ–°çš„è·³èš¤å¸‚åœºå•†å“ | `app.crud.cleanup_expired_flea_market_items(db)` |
| `æ¸…ç†æœªä½¿ç”¨ä¸´æ—¶å›¾ç‰‡` | `_cleanup_unused_temp_images` | æ¯æ¬¡å¾ªç¯ | æ¸…ç†è¶…è¿‡24å°æ—¶æœªä½¿ç”¨çš„ä¸´æ—¶å›¾ç‰‡ï¼ˆåŒ…å«è·³èš¤å¸‚åœºä¸´æ—¶å›¾ç‰‡ï¼‰ | ç›´æ¥æ–‡ä»¶æ“ä½œ |
| `æ¸…ç†è¿‡æœŸæ—¶é—´æ®µ` | `_cleanup_expired_time_slots` | æ¯å¤©ä¸€æ¬¡ | æ¸…ç†è¿‡æœŸæ—¶é—´æ®µï¼ˆæ˜¨å¤©åŠä¹‹å‰çš„æ‰€æœ‰æ—¶é—´æ®µï¼‰ | `app.crud.cleanup_expired_time_slots(db)` |
| `è‡ªåŠ¨ç”Ÿæˆæœªæ¥æ—¶é—´æ®µ` | `_auto_generate_future_time_slots` | æ¯å¤©ä¸€æ¬¡ | âš ï¸ **éœ€è¦ç¦ç”¨** - è‡ªåŠ¨ä¸ºæ‰€æœ‰å¯ç”¨äº†æ—¶é—´æ®µåŠŸèƒ½çš„æœåŠ¡ç”Ÿæˆä¸‹ä¸ªæœˆçš„ä»Šå¤©çš„æ—¶é—´æ®µ | `app.crud.auto_generate_future_time_slots(db)` |

**æ³¨æ„**: 
- æ ‡è®°ä¸º"æ¯å¤©ä¸€æ¬¡"çš„ä»»åŠ¡ä¼šæ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰§è¡Œï¼Œé¿å…é‡å¤æ‰§è¡Œ
- `_cleanup_unused_temp_images` å†…éƒ¨ä¼šè°ƒç”¨ `_cleanup_flea_market_temp_images` æ¸…ç†è·³èš¤å¸‚åœºä¸´æ—¶å›¾ç‰‡

---

### ä¸‰ã€TaskScheduler å¤‡ç”¨ä»»åŠ¡ï¼ˆä¸ Celery ä»»åŠ¡ç›¸åŒï¼‰

å½“ Celery ä¸å¯ç”¨æ—¶ï¼Œ`TaskScheduler` ä¼šä½œä¸ºå¤‡ç”¨è°ƒåº¦å™¨æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ã€‚ä»»åŠ¡åˆ—è¡¨ä¸ Celery ä»»åŠ¡ç›¸åŒï¼Œä½†å¢åŠ äº†ä»¥ä¸‹é¢å¤–ä»»åŠ¡ï¼š

| ä»»åŠ¡åç§° | æ‰§è¡Œé¢‘ç‡ | è¯´æ˜ |
|---------|---------|------|
| `update_task_experts_bio` | UTC å‡Œæ™¨3ç‚¹ï¼ˆè‹±å›½æ—¶é—´4ç‚¹/3ç‚¹ï¼‰ | æ›´æ–°ä»»åŠ¡è¾¾äºº bioï¼ˆæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼Œä½†åªåœ¨3ç‚¹æ‰§è¡Œï¼‰ |

**æ³¨æ„**: ä¸šåŠ¡æ—¶åŒºä¸ºè‹±å›½ï¼Œä»»åŠ¡æ‰§è¡Œæ—¶é—´å·²å®‰æ’åœ¨è‹±å›½ä½¿ç”¨æœ€å°‘çš„æ—¶é—´æ®µï¼ˆ3-5ç‚¹ï¼‰å†…

**ä½ç½®**: `backend/app/task_scheduler.py`

**æ³¨æ„**: TaskScheduler æ˜¯å¤‡ç”¨æ–¹æ¡ˆï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šä½¿ç”¨ï¼ˆå½“ Celery å¯ç”¨æ—¶ï¼‰ã€‚

---

### å››ã€å…¶ä»–ç‹¬ç«‹å®šæ—¶ä»»åŠ¡

#### 1. åå°ä»»åŠ¡å¾ªç¯ (`run_background_task`)

- **ä½ç½®**: `backend/app/main.py`
- **æ‰§è¡Œé¢‘ç‡**: æ¯1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡å¾ªç¯
- **å¯åŠ¨æ–¹å¼**: åå°çº¿ç¨‹ï¼ˆdaemonï¼‰
- **åŒ…å«çš„å­ä»»åŠ¡**:
  1. **å–æ¶ˆè¿‡æœŸä»»åŠ¡** (`cancel_expired_tasks`) - æ¯åˆ†é’Ÿæ‰§è¡Œ
     - âš ï¸ **æ³¨æ„**: æ­¤ä»»åŠ¡åœ¨ Celery ä¸­ä¹Ÿæœ‰ï¼ˆ`cancel-expired-tasks`ï¼‰ï¼Œå¯èƒ½å­˜åœ¨é‡å¤æ‰§è¡Œ
  2. **æ›´æ–°æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯** (`update_all_users_statistics`) - æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     - âš ï¸ **æ³¨æ„**: æ­¤ä»»åŠ¡åœ¨ Celery ä¸­ä¹Ÿæœ‰ï¼ˆ`update-all-users-statistics`ï¼‰ï¼Œå¯èƒ½å­˜åœ¨é‡å¤æ‰§è¡Œ
  3. **æ›´æ–°æ‰€æœ‰ä»»åŠ¡è¾¾äººçš„ bio** (`update_all_task_experts_bio`) - æ¯å¤©æ‰§è¡Œä¸€æ¬¡
     - âš ï¸ **æ³¨æ„**: æ­¤ä»»åŠ¡åœ¨ TaskScheduler ä¸­ä¹Ÿæœ‰ï¼ˆ`update_task_experts_bio`ï¼‰ï¼Œå¯èƒ½å­˜åœ¨é‡å¤æ‰§è¡Œ

**âš ï¸ é‡è¦**: è¿™ä¸ªåå°ä»»åŠ¡å¾ªç¯ä¸ Celery/TaskScheduler ä¸­çš„ä»»åŠ¡æœ‰é‡å¤ï¼Œå»ºè®®ï¼š
- å¦‚æœä½¿ç”¨ Celeryï¼Œåº”è¯¥ç¦ç”¨ `run_background_task` ä¸­çš„é‡å¤ä»»åŠ¡
- æˆ–è€…å®Œå…¨ç§»é™¤ `run_background_task`ï¼Œç»Ÿä¸€ä½¿ç”¨ Celery/TaskScheduler

#### 2. ä¼šè¯æ¸…ç†ä»»åŠ¡ (`run_session_cleanup_task`)

- **ä½ç½®**: `backend/app/main.py`
- **æ‰§è¡Œé¢‘ç‡**: æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- **åŠŸèƒ½**: æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆé€šè¿‡ `SecureAuthManager.cleanup_expired_sessions()`ï¼‰
- **å¯åŠ¨æ–¹å¼**: åå°çº¿ç¨‹ï¼ˆdaemonï¼‰
- **è¯´æ˜**: ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ– Celery æˆ– TaskScheduler
- **âš ï¸ æ³¨æ„**: 
  - æ­¤åŠŸèƒ½ä¸ CleanupTasks ä¸­çš„ `_cleanup_expired_sessions` æœ‰é‡å ï¼ˆè§"å·²çŸ¥é—®é¢˜å’Œé£é™©"éƒ¨åˆ†ï¼‰
  - **ä¼˜åŒ–å»ºè®®**: æ¸…ç†é¢‘ç‡è¿‡é«˜ï¼ˆæ¯5åˆ†é’Ÿï¼‰ï¼Œå»ºè®®æ”¹ä¸ºäº‹ä»¶é©±åŠ¨æˆ–é™ä½é¢‘ç‡ï¼ˆè§"å·²çŸ¥é—®é¢˜å’Œé£é™©"éƒ¨åˆ†ï¼‰

#### 3. æ•°æ®åº“è¿æ¥æ± ç›‘æ§ä»»åŠ¡ (`start_pool_monitor`)

- **ä½ç½®**: `backend/app/database.py`
- **å¯åŠ¨æ–¹å¼**: åœ¨ `main.py` çš„ `startup_event()` ä¸­è°ƒç”¨
- **åŠŸèƒ½**: ç›‘æ§æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
- **è¯´æ˜**: è¿™æ˜¯ç›‘æ§ä»»åŠ¡ï¼Œä¸æ˜¯ä¸šåŠ¡å®šæ—¶ä»»åŠ¡ï¼Œä½†å±äºåå°è¿è¡Œçš„ä»»åŠ¡

---

### å®Œæ•´ä»»åŠ¡ç»Ÿè®¡

| ä»»åŠ¡ç±»å‹ | ä»»åŠ¡æ•°é‡ | è¯´æ˜ |
|---------|---------|------|
| **Celery å®šæ—¶ä»»åŠ¡** | 12ä¸ª | é€šè¿‡ Celery Beat è°ƒåº¦ |
| **CleanupTasks ä»»åŠ¡** | 8ä¸ª | æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†å¾ªç¯ï¼ˆç‹¬ç«‹ç³»ç»Ÿï¼‰ |
| **TaskScheduler ä»»åŠ¡** | 13ä¸ª | å¤‡ç”¨æ–¹æ¡ˆï¼ˆåŒ…å«1ä¸ªé¢å¤–ä»»åŠ¡ï¼‰ |
| **run_background_task** | 3ä¸ªå­ä»»åŠ¡ | åå°çº¿ç¨‹ï¼Œæ¯åˆ†é’Ÿå¾ªç¯ï¼ˆâš ï¸ ä¸ Celery/TaskScheduler æœ‰é‡å¤ï¼‰ |
| **run_session_cleanup_task** | 1ä¸ª | åå°çº¿ç¨‹ï¼Œæ¯5åˆ†é’Ÿæ‰§è¡Œï¼ˆâš ï¸ ä¸ CleanupTasks æœ‰é‡å ï¼‰ |
| **æ•°æ®åº“è¿æ¥æ± ç›‘æ§** | 1ä¸ª | ç›‘æ§ä»»åŠ¡ï¼ˆéä¸šåŠ¡å®šæ—¶ä»»åŠ¡ï¼‰ |
| **æ€»è®¡** | **38ä¸ªä»»åŠ¡/å­ä»»åŠ¡** | åŒ…å«æ‰€æœ‰ç±»å‹çš„å®šæ—¶ä»»åŠ¡å’Œç›‘æ§ä»»åŠ¡ |

**âš ï¸ é‡è¦è¯´æ˜**:
- `run_background_task` ä¸­çš„ä»»åŠ¡ä¸ Celery/TaskScheduler ä¸­çš„ä»»åŠ¡æœ‰é‡å¤ï¼Œå¯èƒ½å¯¼è‡´é‡å¤æ‰§è¡Œ
- `run_session_cleanup_task` ä¸ CleanupTasks ä¸­çš„ `_cleanup_expired_sessions` æœ‰é‡å 
- å»ºè®®ç»Ÿä¸€ä½¿ç”¨ Celery/TaskSchedulerï¼Œç§»é™¤æˆ–ç¦ç”¨ `run_background_task` ä¸­çš„é‡å¤ä»»åŠ¡

**æ³¨æ„**: 
- Celery å’Œ TaskScheduler ä»»åŠ¡æœ‰é‡å ï¼ˆTaskScheduler ä½œä¸ºå¤‡ç”¨ï¼‰
- CleanupTasks ä»»åŠ¡ç‹¬ç«‹è¿è¡Œ
- å®é™…è¿è¡Œçš„ä»»åŠ¡æ•°é‡å–å†³äºç³»ç»Ÿé…ç½®ï¼ˆCelery å¯ç”¨æ—¶ä½¿ç”¨ Celeryï¼Œå¦åˆ™ä½¿ç”¨ TaskSchedulerï¼‰

---

### CleanupTasks è¯¦ç»†è¯´æ˜

**ç±»ä½ç½®**: `backend/app/cleanup_tasks.py`

**å¯åŠ¨æ–¹å¼**: åœ¨ `main.py` çš„ `startup_event()` ä¸­é€šè¿‡ `asyncio.create_task(start_background_cleanup())` å¯åŠ¨

**æ‰§è¡Œæœºåˆ¶**:
- æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†å¾ªç¯ï¼ˆ`cleanup_interval = 3600`ï¼‰
- åœ¨ `_run_cleanup_cycle()` æ–¹æ³•ä¸­ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰æ¸…ç†ä»»åŠ¡
- éƒ¨åˆ†ä»»åŠ¡é€šè¿‡æ—¥æœŸæ£€æŸ¥ç¡®ä¿æ¯å¤©åªæ‰§è¡Œä¸€æ¬¡

**ä»»åŠ¡è¯¦ç»†è¯´æ˜**:

1. **`_cleanup_expired_sessions`** - æ¸…ç†è¿‡æœŸä¼šè¯
   - æ¸…ç†ç”¨æˆ·ä¼šè¯ï¼ˆ`SecureAuthManager.cleanup_expired_sessions()`ï¼‰
   - æ¸…ç†å®¢æœä¼šè¯ï¼ˆ`ServiceAuthManager.cleanup_expired_sessions()`ï¼‰
   - æ¸…ç†ç®¡ç†å‘˜ä¼šè¯ï¼ˆ`AdminAuthManager.cleanup_expired_sessions()`ï¼‰
   - æ¸…ç†ç”¨æˆ·Redisæ•°æ®ï¼ˆ`user_redis_cleanup.cleanup_all_user_data()`ï¼‰

2. **`_cleanup_expired_cache`** - æ¸…ç†è¿‡æœŸç¼“å­˜
   - æ£€æŸ¥Redisä¸­æ‰€æœ‰åŒ¹é…æ¨¡å¼çš„é”®
   - åˆ é™¤è¶…è¿‡7å¤©æœªä½¿ç”¨çš„ç¼“å­˜é”®ï¼ˆæ²¡æœ‰TTLä¸”åŒ…å«æ—¶é—´æˆ³çš„é”®ï¼‰

3. **`_cleanup_completed_tasks_files`** - æ¸…ç†å·²å®Œæˆä»»åŠ¡æ–‡ä»¶
   - æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼ˆé€šè¿‡ `last_completed_tasks_cleanup_date` æ£€æŸ¥ï¼‰
   - æ¸…ç†å·²å®Œæˆè¶…è¿‡3å¤©çš„ä»»åŠ¡çš„å›¾ç‰‡å’Œæ–‡ä»¶
   - è°ƒç”¨ `app.crud.cleanup_completed_tasks_files(db)`

4. **`_cleanup_expired_tasks_files`** - æ¸…ç†è¿‡æœŸä»»åŠ¡æ–‡ä»¶
   - æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼ˆé€šè¿‡ `last_expired_tasks_cleanup_date` æ£€æŸ¥ï¼‰
   - æ¸…ç†è¿‡æœŸä»»åŠ¡ï¼ˆå·²å–æ¶ˆæˆ–deadlineå·²è¿‡è¶…è¿‡3å¤©ï¼‰çš„æ–‡ä»¶
   - è°ƒç”¨ `app.crud.cleanup_expired_tasks_files(db)`

5. **`_cleanup_expired_flea_market_items`** - æ¸…ç†è¿‡æœŸè·³èš¤å¸‚åœºå•†å“
   - æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼ˆé€šè¿‡ `last_flea_market_cleanup_date` æ£€æŸ¥ï¼‰
   - æ¸…ç†è¶…è¿‡10å¤©æœªåˆ·æ–°çš„è·³èš¤å¸‚åœºå•†å“
   - è°ƒç”¨ `app.crud.cleanup_expired_flea_market_items(db)`

6. **`_cleanup_unused_temp_images`** - æ¸…ç†æœªä½¿ç”¨ä¸´æ—¶å›¾ç‰‡
   - æ¯æ¬¡å¾ªç¯éƒ½æ‰§è¡Œ
   - æ¸…ç†è¶…è¿‡24å°æ—¶æœªä½¿ç”¨çš„ä¸´æ—¶å›¾ç‰‡ï¼ˆ`uploads/public/images/public/temp_*`ï¼‰
   - åŒæ—¶æ¸…ç†è·³èš¤å¸‚åœºä¸´æ—¶å›¾ç‰‡ï¼ˆ`uploads/flea_market/temp_*`ï¼‰
   - ç›´æ¥è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œ

7. **`_cleanup_expired_time_slots`** - æ¸…ç†è¿‡æœŸæ—¶é—´æ®µ
   - æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼ˆé€šè¿‡ `last_time_slots_cleanup_date` æ£€æŸ¥ï¼‰
   - æ¸…ç†è¿‡æœŸæ—¶é—´æ®µï¼ˆæ˜¨å¤©åŠä¹‹å‰çš„æ‰€æœ‰æ—¶é—´æ®µï¼‰
   - è°ƒç”¨ `app.crud.cleanup_expired_time_slots(db)`

8. **`_auto_generate_future_time_slots`** - è‡ªåŠ¨ç”Ÿæˆæœªæ¥æ—¶é—´æ®µ âš ï¸ **éœ€è¦ç¦ç”¨**
   - æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼ˆé€šè¿‡ `last_time_slots_generation_date` æ£€æŸ¥ï¼‰
   - è‡ªåŠ¨ä¸ºæ‰€æœ‰å¯ç”¨äº†æ—¶é—´æ®µåŠŸèƒ½çš„æœåŠ¡ç”Ÿæˆä¸‹ä¸ªæœˆçš„ä»Šå¤©çš„æ—¶é—´æ®µ
   - è°ƒç”¨ `app.crud.auto_generate_future_time_slots(db)`

---

## å®šæ—¶ä»»åŠ¡é…ç½®

### Celery Beat è°ƒåº¦é…ç½®

**æ–‡ä»¶ä½ç½®**: `backend/app/celery_app.py`

#### é«˜é¢‘ä»»åŠ¡ï¼ˆ30ç§’-1åˆ†é’Ÿï¼‰

```python
# å®¢æœç›¸å…³ä»»åŠ¡ - æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
'process-customer-service-queue': {
    'task': 'app.customer_service_tasks.process_customer_service_queue_task',
    'schedule': 30.0,  # 30ç§’
},
'auto-end-timeout-chats': {
    'task': 'app.customer_service_tasks.auto_end_timeout_chats_task',
    'schedule': 30.0,  # 30ç§’
},
'send-timeout-warnings': {
    'task': 'app.customer_service_tasks.send_timeout_warnings_task',
    'schedule': 30.0,  # 30ç§’
},

# å–æ¶ˆè¿‡æœŸä»»åŠ¡ - æ¯1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
'cancel-expired-tasks': {
    'task': 'app.celery_tasks.cancel_expired_tasks_task',
    'schedule': 60.0,  # 1åˆ†é’Ÿ
},

# è‡ªåŠ¨å®Œæˆå·²è¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡ - æ¯1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
'auto-complete-expired-time-slot-tasks': {
    'task': 'app.celery_tasks.auto_complete_expired_time_slot_tasks_task',
    'schedule': 60.0,  # 1åˆ†é’Ÿ
},
```

#### ä¸­é¢‘ä»»åŠ¡ï¼ˆ5åˆ†é’Ÿï¼‰

```python
# æ£€æŸ¥è¿‡æœŸä¼˜æƒ åˆ¸ - æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
'check-expired-coupons': {
    'task': 'app.celery_tasks.check_expired_coupons_task',
    'schedule': 300.0,  # 5åˆ†é’Ÿ
},

# æ£€æŸ¥è¿‡æœŸé‚€è¯·ç  - æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
'check-expired-invitation-codes': {
    'task': 'app.celery_tasks.check_expired_invitation_codes_task',
    'schedule': 300.0,  # 5åˆ†é’Ÿ
},

# æ£€æŸ¥è¿‡æœŸç§¯åˆ† - æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
'check-expired-points': {
    'task': 'app.celery_tasks.check_expired_points_task',
    'schedule': 300.0,  # 5åˆ†é’Ÿ
},

# æ£€æŸ¥å¹¶ç»“æŸæ´»åŠ¨ - æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
'check-and-end-activities': {
    'task': 'app.celery_tasks.check_and_end_activities_task',
    'schedule': 300.0,  # 5åˆ†é’Ÿ
},
```

#### ä½é¢‘ä»»åŠ¡ï¼ˆ10åˆ†é’Ÿï¼‰

```python
# æ›´æ–°æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ - æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
'update-all-users-statistics': {
    'task': 'app.celery_tasks.update_all_users_statistics_task',
    'schedule': 600.0,  # 10åˆ†é’Ÿ
},
```

#### æ¯æ—¥ä»»åŠ¡ï¼ˆCrontab è°ƒåº¦ï¼‰

```python
from celery.schedules import crontab

# æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ - UTC å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆå¯¹åº”è‹±å›½æ—¶é—´3ç‚¹/2ç‚¹ï¼Œåœ¨ä½¿ç”¨æœ€å°‘æ—¶é—´æ®µå†…ï¼‰
'cleanup-long-inactive-chats': {
    'task': 'app.celery_tasks.cleanup_long_inactive_chats_task',
    'schedule': crontab(hour=2, minute=0),  # UTC å‡Œæ™¨2ç‚¹ï¼ˆè‹±å›½æ—¶é—´3ç‚¹/2ç‚¹ï¼‰
},

# æ›´æ–°ç‰¹å¾ä»»åŠ¡è¾¾äººçš„å“åº”æ—¶é—´ - UTC å‡Œæ™¨3ç‚¹æ‰§è¡Œï¼ˆå¯¹åº”è‹±å›½æ—¶é—´4ç‚¹/3ç‚¹ï¼Œåœ¨ä½¿ç”¨æœ€å°‘æ—¶é—´æ®µå†…ï¼‰
'update-featured-task-experts-response-time': {
    'task': 'app.celery_tasks.update_featured_task_experts_response_time_task',
    'schedule': crontab(hour=3, minute=0),  # UTC å‡Œæ™¨3ç‚¹ï¼ˆè‹±å›½æ—¶é—´4ç‚¹/3ç‚¹ï¼‰
},
```

---

## ä»»åŠ¡å®ç°ç»†èŠ‚

### ä»»åŠ¡åŒ…è£…æ¨¡å¼

æ‰€æœ‰ Celery ä»»åŠ¡éƒ½éµå¾ªç»Ÿä¸€çš„åŒ…è£…æ¨¡å¼ï¼š

```python
@celery_app.task(
    name='app.module.task_name',
    bind=True,  # ç»‘å®šä»»åŠ¡å®ä¾‹ï¼Œå¯ä»¥è®¿é—® self
    max_retries=3,  # æœ€å¤§é‡è¯•æ¬¡æ•°
    default_retry_delay=60  # é»˜è®¤é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
)
def task_name(self):
    """ä»»åŠ¡æè¿°"""
    start_time = time.time()
    task_name_str = 'task_name'
    db = SessionLocal()
    try:
        # æ‰§è¡Œå®é™…ä¸šåŠ¡é€»è¾‘
        result = actual_business_logic(db)
        duration = time.time() - start_time
        logger.info(f"ä»»åŠ¡å®Œæˆ (è€—æ—¶: {duration:.2f}ç§’)")
        _record_task_metrics(task_name_str, "success", duration)
        return {"status": "success", "message": "Task completed"}
    except Exception as e:
        duration = time.time() - start_time
        logger.error(f"ä»»åŠ¡å¤±è´¥: {e}", exc_info=True)
        _record_task_metrics(task_name_str, "error", duration)
        try:
            db.rollback()
        except Exception:
            pass
        # é‡è¯•æœºåˆ¶
        if self.request.retries < self.max_retries:
            logger.info(f"ä»»åŠ¡å°†é‡è¯• ({self.request.retries + 1}/{self.max_retries})")
            raise self.retry(exc=e)
        raise
    finally:
        db.close()
```

### å…³é”®ç‰¹æ€§

#### 1. æŒ‡æ ‡è®°å½•

æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè®°å½• Prometheus æŒ‡æ ‡ï¼š

```python
def _record_task_metrics(task_name: str, status: str, duration: float):
    """è®°å½•ä»»åŠ¡æ‰§è¡ŒæŒ‡æ ‡"""
    try:
        from app.metrics import record_scheduled_task
        record_scheduled_task(task_name, status, duration)
    except Exception:
        pass  # æŒ‡æ ‡è®°å½•å¤±è´¥ä¸å½±å“ä»»åŠ¡æ‰§è¡Œ
```

#### 2. æ•°æ®åº“ä¼šè¯ç®¡ç†

æ¯ä¸ªä»»åŠ¡éƒ½åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯ï¼Œç¡®ä¿äº‹åŠ¡éš”ç¦»ï¼š

```python
db = SessionLocal()
try:
    # ä¸šåŠ¡é€»è¾‘
    pass
finally:
    db.close()  # ç¡®ä¿ä¼šè¯å…³é—­
```

#### 3. é”™è¯¯å¤„ç†å’Œé‡è¯•

- æ‰€æœ‰å¼‚å¸¸éƒ½ä¼šè¢«æ•è·å’Œè®°å½•
- æ”¯æŒè‡ªåŠ¨é‡è¯•ï¼ˆå¯é…ç½®é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿï¼‰
- æ•°æ®åº“äº‹åŠ¡å›æ»šä¿æŠ¤

#### 4. ä»»åŠ¡è¶…æ—¶ä¿æŠ¤

- ç¡¬è¶…æ—¶ï¼š30åˆ†é’Ÿï¼ˆå¼ºåˆ¶ç»ˆæ­¢ï¼‰
- è½¯è¶…æ—¶ï¼š25åˆ†é’Ÿï¼ˆä¼˜é›…ç»ˆæ­¢ï¼‰

### ä»»åŠ¡è¯¦ç»†è¯´æ˜

#### å®¢æœç³»ç»Ÿä»»åŠ¡

##### 1. `process_customer_service_queue_task`

**åŠŸèƒ½**: å¤„ç†å®¢æœæ’é˜Ÿï¼Œæ‰¹é‡åˆ†é…ç”¨æˆ·ç»™å¯ç”¨å®¢æœ

**å®ç°é€»è¾‘**:
- æ‰¹é‡è·å–å¾…åˆ†é…ç”¨æˆ·ï¼ˆæœ€å¤š10ä¸ªï¼‰
- ä½¿ç”¨è¡Œçº§é”é˜²æ­¢å¹¶å‘åˆ†é…
- è®¡ç®—æ¯ä¸ªå®¢æœçš„è´Ÿè½½
- é€‰æ‹©è´Ÿè½½æœ€ä½ä¸”æœ‰ä½™é‡çš„å®¢æœ
- åˆ›å»ºå¯¹è¯å¹¶æ›´æ–°é˜Ÿåˆ—çŠ¶æ€

**å…³é”®ç‰¹æ€§**:
- æ‰¹é‡å¤„ç†ï¼ˆæé«˜æ•ˆç‡ï¼‰
- äº‹åŠ¡ä¿æŠ¤ï¼ˆé˜²æ­¢åŒåˆ†é…ï¼‰
- è´Ÿè½½å‡è¡¡ï¼ˆæŒ‰å®¹é‡å’Œè¯„åˆ†ï¼‰

##### 2. `auto_end_timeout_chats_task`

**åŠŸèƒ½**: è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯ï¼ˆ2åˆ†é’Ÿæ— æ´»åŠ¨ï¼‰

**å®ç°é€»è¾‘**:
- æŸ¥æ‰¾è¶…è¿‡2åˆ†é’Ÿæ— æ´»åŠ¨çš„å¯¹è¯
- åˆ¤æ–­è¶…æ—¶ç±»å‹ï¼ˆç”¨æˆ·ä¸æ´»è·ƒ/å®¢æœä¸æ´»è·ƒï¼‰
- ç»“æŸå¯¹è¯å¹¶è®°å½•åŸå› 

##### 3. `send_timeout_warnings_task`

**åŠŸèƒ½**: å‘é€è¶…æ—¶é¢„è­¦ï¼ˆè·ç¦»è¶…æ—¶è¿˜æœ‰1åˆ†é’Ÿæ—¶ï¼‰

**å®ç°é€»è¾‘**:
- æŸ¥æ‰¾å³å°†è¶…æ—¶çš„å¯¹è¯ï¼ˆ1åˆ†é’Ÿåå°†è¶…æ—¶ï¼‰
- æ£€æŸ¥æ˜¯å¦å·²å‘é€è¿‡é¢„è­¦ï¼ˆé¿å…é‡å¤é€šçŸ¥ï¼‰
- åˆ›å»ºé€šçŸ¥å¹¶é€šè¿‡ WebSocket æ¨é€

#### é€šç”¨ä»»åŠ¡

##### 1. `cancel_expired_tasks_task`

**åŠŸèƒ½**: å–æ¶ˆè¿‡æœŸä»»åŠ¡

**è°ƒç”¨**: `app.crud.cancel_expired_tasks(db)`

##### 2. `auto_complete_expired_time_slot_tasks_task`

**åŠŸèƒ½**: è‡ªåŠ¨å®Œæˆå·²è¿‡æœŸæ—¶é—´æ®µçš„ä»»åŠ¡

**è°ƒç”¨**: `app.scheduled_tasks.auto_complete_expired_time_slot_tasks(db)`

##### 3. `check_expired_coupons_task`

**åŠŸèƒ½**: æ£€æŸ¥å¹¶æ ‡è®°è¿‡æœŸä¼˜æƒ åˆ¸

**è°ƒç”¨**: `app.scheduled_tasks.check_expired_coupons(db)`

##### 4. `check_expired_invitation_codes_task`

**åŠŸèƒ½**: æ£€æŸ¥å¹¶æ ‡è®°è¿‡æœŸé‚€è¯·ç 

**è°ƒç”¨**: `app.scheduled_tasks.check_expired_invitation_codes(db)`

##### 5. `check_expired_points_task`

**åŠŸèƒ½**: æ£€æŸ¥å¹¶æ ‡è®°è¿‡æœŸç§¯åˆ†

**è°ƒç”¨**: `app.scheduled_tasks.check_expired_points(db)`

##### 6. `check_and_end_activities_task`

**åŠŸèƒ½**: æ£€æŸ¥å¹¶ç»“æŸè¿‡æœŸæ´»åŠ¨

**è°ƒç”¨**: `app.scheduled_tasks.check_and_end_activities_sync(db)`

**æ³¨æ„**: æ­¤ä»»åŠ¡å†…éƒ¨ä½¿ç”¨å¼‚æ­¥æ•°æ®åº“ä¼šè¯

##### 7. `update_all_users_statistics_task`

**åŠŸèƒ½**: æ›´æ–°æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯

**è°ƒç”¨**: `app.main.update_all_users_statistics()`

**æ³¨æ„**: æ­¤ä»»åŠ¡ä¸éœ€è¦æ•°æ®åº“ä¼šè¯å‚æ•°

##### 8. `update_featured_task_experts_response_time_task`

**åŠŸèƒ½**: æ›´æ–°ç‰¹å¾ä»»åŠ¡è¾¾äººçš„å“åº”æ—¶é—´

**è°ƒç”¨**: `app.crud.update_all_featured_task_experts_response_time()`

**æ‰§è¡Œæ—¶é—´**: UTC å‡Œæ™¨3ç‚¹ï¼ˆå¯¹åº”è‹±å›½æ—¶é—´4ç‚¹/3ç‚¹ï¼Œåœ¨ä½¿ç”¨æœ€å°‘æ—¶é—´æ®µå†…ï¼‰

##### 9. `cleanup_long_inactive_chats_task`

**åŠŸèƒ½**: æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ï¼ˆ30å¤©ï¼‰

**è°ƒç”¨**: `app.customer_service_tasks.cleanup_long_inactive_chats(db, inactive_days=30)`

**æ‰§è¡Œæ—¶é—´**: UTC å‡Œæ™¨2ç‚¹ï¼ˆå¯¹åº”è‹±å›½æ—¶é—´3ç‚¹/2ç‚¹ï¼Œåœ¨ä½¿ç”¨æœ€å°‘æ—¶é—´æ®µå†…ï¼‰

---

## å¯åŠ¨å’Œéƒ¨ç½²

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

#### 1. å¯åŠ¨ Redis

```bash
# ä½¿ç”¨ Docker
docker run -d -p 6379:6379 redis:latest

# æˆ–ä½¿ç”¨æœ¬åœ° Redis
redis-server
```

#### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
export REDIS_URL=redis://localhost:6379/0
export USE_REDIS=true
```

#### 3. å¯åŠ¨æœåŠ¡

**ç»ˆç«¯ 1 - FastAPI åº”ç”¨**:
```bash
cd backend
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**ç»ˆç«¯ 2 - Celery Worker**:
```bash
cd backend
celery -A app.celery_app worker --loglevel=info
```

**ç»ˆç«¯ 3 - Celery Beat**:
```bash
cd backend
celery -A app.celery_app beat --loglevel=info
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### Railway éƒ¨ç½²

å‚è€ƒ: `RAILWAY_CELERY_éƒ¨ç½²é…ç½®æŒ‡å—.md`

**æœåŠ¡é…ç½®**:

1. **App Service** (FastAPI)
   - Root Directory: `backend`
   - Start Command: `python -m uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000} --http h11`
   - Healthcheck Path: `/health`

2. **Celery Worker Service**
   - Root Directory: `backend`
   - Start Command: `celery -A app.celery_app worker --loglevel=info`
   - Healthcheck: ç¦ç”¨ï¼ˆä¸æä¾› HTTP æœåŠ¡ï¼‰

3. **Celery Beat Service**
   - Root Directory: `backend`
   - Start Command: `celery -A app.celery_app beat --loglevel=info`
   - Healthcheck: ç¦ç”¨ï¼ˆä¸æä¾› HTTP æœåŠ¡ï¼‰

**ç¯å¢ƒå˜é‡**ï¼ˆæ‰€æœ‰æœåŠ¡éƒ½éœ€è¦ï¼‰:
- `REDIS_URL=${{Redis.REDIS_URL}}`
- `USE_REDIS=true`
- `DATABASE_URL=${{Postgres.DATABASE_URL}}`
- å…¶ä»–åº”ç”¨éœ€è¦çš„ç¯å¢ƒå˜é‡

#### Docker éƒ¨ç½²

**docker-compose.yml** ç¤ºä¾‹:

```yaml
version: '3.8'

services:
  redis:
    image: redis:latest
    ports:
      - "6379:6379"

  app:
    build: ./backend
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    environment:
      - REDIS_URL=redis://redis:6379/0
      - USE_REDIS=true
    depends_on:
      - redis

  celery-worker:
    build: ./backend
    command: celery -A app.celery_app worker --loglevel=info
    environment:
      - REDIS_URL=redis://redis:6379/0
      - USE_REDIS=true
    depends_on:
      - redis

  celery-beat:
    build: ./backend
    command: celery -A app.celery_app beat --loglevel=info
    environment:
      - REDIS_URL=redis://redis:6379/0
      - USE_REDIS=true
    depends_on:
      - redis
```

### å¯åŠ¨è„šæœ¬

é¡¹ç›®æä¾›äº†å¯åŠ¨è„šæœ¬ï¼š

**`backend/start_celery.sh`**:
```bash
#!/bin/bash
celery -A app.celery_app worker --loglevel=info &
celery -A app.celery_app beat --loglevel=info &
```

---

## ç›‘æ§å’ŒæŒ‡æ ‡

### Prometheus æŒ‡æ ‡

æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè®°å½•ä»¥ä¸‹æŒ‡æ ‡ï¼š

- `scheduled_task_total` - ä»»åŠ¡æ‰§è¡Œæ€»æ•°
- `scheduled_task_duration_seconds` - ä»»åŠ¡æ‰§è¡Œè€—æ—¶
- `scheduled_task_status` - ä»»åŠ¡çŠ¶æ€ï¼ˆsuccess/errorï¼‰

### å¥åº·æ£€æŸ¥

FastAPI åº”ç”¨æä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š`/health`

**æ£€æŸ¥é¡¹**:
- æ•°æ®åº“è¿æ¥
- Redis è¿æ¥
- Celery Worker çŠ¶æ€

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "database": "connected",
  "redis": "connected",
  "celery_worker": "available"
}
```

### æ—¥å¿—ç›‘æ§

æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè®°å½•è¯¦ç»†æ—¥å¿—ï¼š

- ä»»åŠ¡å¼€å§‹/å®Œæˆæ—¶é—´
- æ‰§è¡Œè€—æ—¶
- é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…å«å †æ ˆè·Ÿè¸ªï¼‰
- é‡è¯•ä¿¡æ¯

**æ—¥å¿—çº§åˆ«**:
- `INFO`: æ­£å¸¸æ‰§è¡Œä¿¡æ¯
- `WARNING`: è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚å›é€€åˆ° TaskSchedulerï¼‰
- `ERROR`: é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…å«å¼‚å¸¸è¯¦æƒ…ï¼‰

---

## æ•…éšœå¤„ç†

### å¸¸è§é—®é¢˜

#### 1. Celery Worker æœªå¯åŠ¨

**ç—‡çŠ¶**: ä»»åŠ¡ä¸æ‰§è¡Œï¼Œæ—¥å¿—æ˜¾ç¤º "Celery Worker æœªæ£€æµ‹åˆ°"

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ Redis è¿æ¥
- å¯åŠ¨ Celery Worker: `celery -A app.celery_app worker --loglevel=info`
- æ£€æŸ¥ Worker æ—¥å¿—

#### 2. ä»»åŠ¡æ‰§è¡Œå¤±è´¥

**ç—‡çŠ¶**: ä»»åŠ¡é¢‘ç¹é‡è¯•æˆ–æœ€ç»ˆå¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—ï¼ˆåŒ…å«é”™è¯¯å †æ ˆï¼‰
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
3. æ£€æŸ¥ä¸šåŠ¡é€»è¾‘é”™è¯¯
4. æŸ¥çœ‹ Prometheus æŒ‡æ ‡

#### 3. Redis è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: æ— æ³•è¿æ¥åˆ° Redis

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ Redis æœåŠ¡æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥ `REDIS_URL` é…ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç³»ç»Ÿä¼šè‡ªåŠ¨å›é€€åˆ° TaskScheduler

#### 4. ä»»åŠ¡è¶…æ—¶

**ç—‡çŠ¶**: ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¢«å¼ºåˆ¶ç»ˆæ­¢

**è§£å†³æ–¹æ¡ˆ**:
- ä¼˜åŒ–ä»»åŠ¡é€»è¾‘
- å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆä¸æ¨èï¼‰
- æ‹†åˆ†å¤§ä»»åŠ¡ä¸ºå¤šä¸ªå°ä»»åŠ¡

### ä»»åŠ¡é‡è¯•æœºåˆ¶

æ‰€æœ‰ä»»åŠ¡éƒ½æ”¯æŒè‡ªåŠ¨é‡è¯•ï¼š

- **é»˜è®¤é‡è¯•æ¬¡æ•°**: 3æ¬¡
- **é»˜è®¤é‡è¯•å»¶è¿Ÿ**: 60ç§’
- **å¯é…ç½®**: æ¯ä¸ªä»»åŠ¡å¯ä»¥å•ç‹¬é…ç½®é‡è¯•å‚æ•°

**é‡è¯•æ¡ä»¶**:
- ä¸´æ—¶é”™è¯¯ï¼ˆå¦‚æ•°æ®åº“è¿æ¥é—®é¢˜ï¼‰
- ç½‘ç»œé”™è¯¯
- å…¶ä»–å¯æ¢å¤çš„å¼‚å¸¸

**ä¸é‡è¯•çš„æƒ…å†µ**:
- è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
- ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå¦‚æ•°æ®éªŒè¯å¤±è´¥ï¼‰

---

## å›é€€æœºåˆ¶

### è‡ªåŠ¨æ£€æµ‹å’Œå›é€€

ç³»ç»Ÿåœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æµ‹ Celery å¯ç”¨æ€§ï¼š

**æ£€æµ‹æµç¨‹**:
1. æ£€æŸ¥ Redis è¿æ¥
2. æ£€æŸ¥ Celery Worker æ˜¯å¦åœ¨çº¿ï¼ˆä½¿ç”¨ `ping()` æˆ– `stats()`ï¼‰
3. å¦‚æœå¯ç”¨ â†’ ä½¿ç”¨ Celery
4. å¦‚æœä¸å¯ç”¨ â†’ å›é€€åˆ° TaskScheduler

**æ£€æµ‹ä»£ç ä½ç½®**: `backend/app/main.py` - `startup_event()`

### TaskSchedulerï¼ˆå¤‡ç”¨è°ƒåº¦å™¨ï¼‰

**æ–‡ä»¶ä½ç½®**: `backend/app/task_scheduler.py`

**ç‰¹æ€§**:
- åŸºäºçº¿ç¨‹çš„è°ƒåº¦å™¨
- ä¸éœ€è¦ Redis
- è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰å®šæ—¶ä»»åŠ¡
- ä¸ Celery ä»»åŠ¡é…ç½®ä¿æŒä¸€è‡´

**ä½¿ç”¨åœºæ™¯**:
- å¼€å‘ç¯å¢ƒï¼ˆRedis ä¸å¯ç”¨ï¼‰
- Celery Worker æœªå¯åŠ¨
- ç´§æ€¥å›é€€

### å›é€€æ¡ä»¶

ç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹æƒ…å†µå›é€€åˆ° TaskSchedulerï¼š

1. âœ… Redis è¿æ¥å¤±è´¥
2. âœ… Celery Worker æœªå¯åŠ¨
3. âœ… Celery æœªå®‰è£…
4. âœ… `USE_REDIS=false`

### æ— ç¼åˆ‡æ¢

- âœ… ä»»åŠ¡é…ç½®ä¿æŒä¸€è‡´
- âœ… ä¸šåŠ¡é€»è¾‘å®Œå…¨ç›¸åŒ
- âœ… æ—¥å¿—æ ¼å¼ç»Ÿä¸€
- âœ… æŒ‡æ ‡è®°å½•ç»Ÿä¸€

**æ³¨æ„**: å¦‚æœ Celery Worker ç¨åå¯åŠ¨ï¼Œç³»ç»Ÿä¸ä¼šè‡ªåŠ¨åˆ‡æ¢å› Celeryã€‚éœ€è¦é‡å¯ FastAPI åº”ç”¨ã€‚

---

## æœ€ä½³å®è·µ

### 1. ä»»åŠ¡è®¾è®¡

- âœ… ä»»åŠ¡åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰
- âœ… ä»»åŠ¡åº”è¯¥å¤„ç†æ‰€æœ‰å¼‚å¸¸
- âœ… ä»»åŠ¡åº”è¯¥è®°å½•è¯¦ç»†æ—¥å¿—
- âœ… ä»»åŠ¡åº”è¯¥è®°å½•æŒ‡æ ‡

### 2. æ•°æ®åº“æ“ä½œ

- âœ… æ¯ä¸ªä»»åŠ¡åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯
- âœ… ä½¿ç”¨äº‹åŠ¡ä¿æŠ¤æ•°æ®ä¸€è‡´æ€§
- âœ… ç¡®ä¿ä¼šè¯æ­£ç¡®å…³é—­ï¼ˆä½¿ç”¨ `finally`ï¼‰

### 3. é”™è¯¯å¤„ç†

- âœ… æ•è·æ‰€æœ‰å¼‚å¸¸
- âœ… è®°å½•é”™è¯¯è¯¦æƒ…ï¼ˆåŒ…å«å †æ ˆè·Ÿè¸ªï¼‰
- âœ… å®ç°åˆç†çš„é‡è¯•æœºåˆ¶
- âœ… é¿å…æ— é™é‡è¯•

### 4. æ€§èƒ½ä¼˜åŒ–

- âœ… æ‰¹é‡å¤„ç†æ•°æ®ï¼ˆå¦‚å®¢æœé˜Ÿåˆ—ï¼‰
- âœ… ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
- âœ… é¿å…é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- âœ… åˆç†è®¾ç½®ä»»åŠ¡é¢‘ç‡

### 5. ç›‘æ§

- âœ… ç›‘æ§ä»»åŠ¡æ‰§è¡Œæ—¶é—´
- âœ… ç›‘æ§ä»»åŠ¡å¤±è´¥ç‡
- âœ… ç›‘æ§ Worker çŠ¶æ€
- âœ… è®¾ç½®å‘Šè­¦é˜ˆå€¼

---

## æ€»ç»“

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„å®šæ—¶ä»»åŠ¡ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

- âœ… **12ä¸ª Celery å®šæ—¶ä»»åŠ¡**ï¼ˆé€šè¿‡ Celery Beat è°ƒåº¦ï¼‰
- âœ… **8ä¸ª CleanupTasks æ¸…ç†ä»»åŠ¡**ï¼ˆæ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
- âœ… **13ä¸ª TaskScheduler å¤‡ç”¨ä»»åŠ¡**ï¼ˆå½“ Celery ä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰
- âœ… **1ä¸ªç‹¬ç«‹ä¼šè¯æ¸…ç†ä»»åŠ¡**ï¼ˆæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
- âœ… **æ€»è®¡ 34ä¸ªå®šæ—¶ä»»åŠ¡**ï¼ˆåŒ…å«æ‰€æœ‰ç±»å‹çš„ä»»åŠ¡ï¼‰
- âœ… **è‡ªåŠ¨æ•…éšœæ¢å¤**ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
- âœ… **ä¼˜é›…é™çº§**ï¼ˆå›é€€åˆ° TaskSchedulerï¼‰
- âœ… **å®Œæ•´ç›‘æ§**ï¼ˆPrometheus æŒ‡æ ‡ï¼‰
- âœ… **è¯¦ç»†æ—¥å¿—**ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰

ç³»ç»Ÿè®¾è®¡éµå¾ªæœ€ä½³å®è·µï¼Œç¡®ä¿é«˜å¯ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### ä»»åŠ¡æ‰§è¡Œä¼˜å…ˆçº§

1. **Celery ä»»åŠ¡** - ä¸»è¦æ‰§è¡Œæ–¹å¼ï¼ˆå¦‚æœ Celery Worker å¯ç”¨ï¼‰
2. **CleanupTasks** - ç‹¬ç«‹è¿è¡Œï¼Œä¸å— Celery å½±å“
3. **TaskScheduler** - å¤‡ç”¨æ–¹æ¡ˆï¼ˆå½“ Celery ä¸å¯ç”¨æ—¶ï¼‰
4. **ç‹¬ç«‹ä»»åŠ¡** - ç‹¬ç«‹è¿è¡Œï¼ˆå¦‚ä¼šè¯æ¸…ç†ï¼‰

---

## ç›¸å…³æ–‡æ¡£

- `CELERY_SETUP_GUIDE.md` - Celery è®¾ç½®æŒ‡å—
- `RAILWAY_CELERY_éƒ¨ç½²é…ç½®æŒ‡å—.md` - Railway éƒ¨ç½²é…ç½®
- `CELERY_CHECK_REPORT.md` - Celery æ£€æŸ¥æŠ¥å‘Š
- `CELERY_IMPLEMENTATION_REVIEW.md` - Celery å®ç°å®¡æŸ¥

---

**æœ€åæ›´æ–°**: 2024å¹´

