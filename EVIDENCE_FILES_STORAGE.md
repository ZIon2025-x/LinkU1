# è¯æ®æ–‡ä»¶å­˜å‚¨ä½ç½®è¯´æ˜

## ğŸ“ å­˜å‚¨ä½ç½®æ€»è§ˆ

æ‰€æœ‰è¯æ®æ–‡ä»¶éƒ½å­˜å‚¨åœ¨**ç§æœ‰æ–‡ä»¶ç³»ç»Ÿ**ä¸­ï¼Œç¡®ä¿åªæœ‰ä»»åŠ¡å‚ä¸è€…å¯ä»¥è®¿é—®ã€‚

### å­˜å‚¨è·¯å¾„ç»“æ„

```
/data/uploads/                    # Railway ç”Ÿäº§ç¯å¢ƒ
  â””â”€â”€ private_files/              # ç§æœ‰æ–‡ä»¶ç›®å½•ï¼ˆéœ€è¦ç­¾åURLè®¿é—®ï¼‰
      â”œâ”€â”€ tasks/                  # ä»»åŠ¡ç›¸å…³æ–‡ä»¶
      â”‚   â””â”€â”€ {task_id}/          # æŒ‰ä»»åŠ¡IDåˆ†ç±»
      â”‚       â””â”€â”€ {file_id}.{ext} # æ–‡ä»¶å­˜å‚¨åœ¨è¿™é‡Œ
      â””â”€â”€ chats/                  # å®¢æœèŠå¤©æ–‡ä»¶
          â””â”€â”€ {chat_id}/          # æŒ‰èŠå¤©IDåˆ†ç±»

uploads/                          # æœ¬åœ°å¼€å‘ç¯å¢ƒ
  â””â”€â”€ private_files/              # ç§æœ‰æ–‡ä»¶ç›®å½•
      â”œâ”€â”€ tasks/
      â”‚   â””â”€â”€ {task_id}/
      â””â”€â”€ chats/
          â””â”€â”€ {chat_id}/
```

## ğŸ“‹ å„ç±»è¯æ®æ–‡ä»¶çš„å­˜å‚¨ä½ç½®

### 1. å®Œæˆè¯æ®ï¼ˆæ¥å—è€…æ ‡è®°å®Œæˆæ—¶ä¸Šä¼ ï¼‰

**ä¸Šä¼ ç«¯ç‚¹**: `/api/upload/image`

**å­˜å‚¨ä½ç½®**:
- **è·¯å¾„**: `private_images/tasks/{task_id}/{image_id}.jpg`
- **å®Œæ•´è·¯å¾„**:
  - Railway: `/data/uploads/private_images/tasks/{task_id}/{image_id}.jpg`
  - æœ¬åœ°: `uploads/private_images/tasks/{task_id}/{image_id}.jpg`

**ç‰¹ç‚¹**:
- ä½¿ç”¨ç§å¯†å›¾ç‰‡ç³»ç»Ÿï¼ˆ`PrivateImageSystem`ï¼‰
- åªæ”¯æŒå›¾ç‰‡æ ¼å¼
- è‡ªåŠ¨å‹ç¼©ï¼ˆæœ€å¤§5MBï¼‰
- æ–‡ä»¶IDæ ¼å¼: `{user_id}_{timestamp}_{random}`

**ç¤ºä¾‹**:
```
ä»»åŠ¡ID: 12345
ç”¨æˆ·ID: ABC12345
æ–‡ä»¶ID: ABC12345_1704067200_a1b2c3d4
å­˜å‚¨è·¯å¾„: /data/uploads/private_images/tasks/12345/ABC12345_1704067200_a1b2c3d4.jpg
```

### 2. æœªå®Œæˆè¯æ®ï¼ˆé€€æ¬¾ç”³è¯·æ—¶ä¸Šä¼ ï¼‰

**ä¸Šä¼ ç«¯ç‚¹**: `/api/upload/file`

**å­˜å‚¨ä½ç½®**:
- **è·¯å¾„**: `private_files/tasks/{task_id}/{file_id}.{ext}`
- **å®Œæ•´è·¯å¾„**:
  - Railway: `/data/uploads/private_files/tasks/{task_id}/{file_id}.{ext}`
  - æœ¬åœ°: `uploads/private_files/tasks/{task_id}/{file_id}.{ext}`

**ç‰¹ç‚¹**:
- ä½¿ç”¨ç§å¯†æ–‡ä»¶ç³»ç»Ÿï¼ˆ`PrivateFileSystem`ï¼‰
- æ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹ï¼ˆå›¾ç‰‡ã€PDFã€Wordã€æ–‡æœ¬ç­‰ï¼‰
- å›¾ç‰‡æœ€å¤§5MBï¼Œå…¶ä»–æ–‡ä»¶æœ€å¤§10MB
- æ–‡ä»¶IDæ ¼å¼: `{user_id}_{timestamp}_{random}`

**ç¤ºä¾‹**:
```
ä»»åŠ¡ID: 12345
ç”¨æˆ·ID: ABC12345
æ–‡ä»¶ID: ABC12345_1704067200_a1b2c3d4
æ–‡ä»¶ç±»å‹: PDF
å­˜å‚¨è·¯å¾„: /data/uploads/private_files/tasks/12345/ABC12345_1704067200_a1b2c3d4.pdf
```

### 3. ç¡®è®¤å®Œæˆè¯æ®ï¼ˆå‘å¸ƒè€…ç¡®è®¤å®Œæˆæ—¶ä¸Šä¼ ï¼‰

**ä¸Šä¼ ç«¯ç‚¹**: `/api/upload/file`

**å­˜å‚¨ä½ç½®**:
- **è·¯å¾„**: `private_files/tasks/{task_id}/{file_id}.{ext}`
- **å®Œæ•´è·¯å¾„**:
  - Railway: `/data/uploads/private_files/tasks/{task_id}/{file_id}.{ext}`
  - æœ¬åœ°: `uploads/private_files/tasks/{task_id}/{file_id}.{ext}`

**ç‰¹ç‚¹**:
- ä½¿ç”¨ç§å¯†æ–‡ä»¶ç³»ç»Ÿï¼ˆ`PrivateFileSystem`ï¼‰
- æ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹ï¼ˆå›¾ç‰‡ã€PDFã€Wordã€æ–‡æœ¬ç­‰ï¼‰
- å›¾ç‰‡æœ€å¤§5MBï¼Œå…¶ä»–æ–‡ä»¶æœ€å¤§10MB
- æ–‡ä»¶IDæ ¼å¼: `{user_id}_{timestamp}_{random}`

**ç¤ºä¾‹**:
```
ä»»åŠ¡ID: 12345
ç”¨æˆ·ID: DEF67890
æ–‡ä»¶ID: DEF67890_1704067300_e5f6g7h8
æ–‡ä»¶ç±»å‹: JPG
å­˜å‚¨è·¯å¾„: /data/uploads/private_files/tasks/12345/DEF67890_1704067300_e5f6g7h8.jpg
```

## ğŸ”’ æ–‡ä»¶è®¿é—®æ§åˆ¶

### è®¿é—®æ–¹å¼

æ‰€æœ‰è¯æ®æ–‡ä»¶éƒ½é€šè¿‡**ç§æœ‰æ–‡ä»¶ç³»ç»Ÿ**å­˜å‚¨ï¼Œè®¿é—®éœ€è¦ï¼š

1. **ç­¾åURL**ï¼ˆå¸¦tokençš„URLï¼‰
   - æ ¼å¼: `/api/private-file?file={file_id}&token={access_token}`
   - Token åŒ…å«ç”¨æˆ·IDã€å‚ä¸è€…åˆ—è¡¨ã€è¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯
   - åªæœ‰ä»»åŠ¡å‚ä¸è€…å¯ä»¥ç”Ÿæˆæœ‰æ•ˆçš„è®¿é—®token

2. **æƒé™éªŒè¯**
   - ç³»ç»Ÿä¼šéªŒè¯ç”¨æˆ·æ˜¯å¦ä¸ºä»»åŠ¡å‚ä¸è€…ï¼ˆå‘å¸ƒè€…æˆ–æ¥å—è€…ï¼‰
   - åªæœ‰å‚ä¸è€…æ‰èƒ½è®¿é—®ä»»åŠ¡ç›¸å…³çš„è¯æ®æ–‡ä»¶

### æ–‡ä»¶è®¿é—®æµç¨‹

```
1. ç”¨æˆ·è¯·æ±‚è®¿é—®æ–‡ä»¶
   â†“
2. ç³»ç»ŸéªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™
   â†“
3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºä»»åŠ¡å‚ä¸è€…
   â†“
4. ç”Ÿæˆè®¿é—®tokenï¼ˆåŒ…å«å‚ä¸è€…åˆ—è¡¨ï¼‰
   â†“
5. è¿”å›ç­¾åURL
   â†“
6. ç”¨æˆ·é€šè¿‡ç­¾åURLè®¿é—®æ–‡ä»¶
   â†“
7. ç³»ç»ŸéªŒè¯tokenæœ‰æ•ˆæ€§
   â†“
8. ä»ç£ç›˜è¯»å–æ–‡ä»¶å¹¶è¿”å›
```

## ğŸ“Š å­˜å‚¨ç³»ç»Ÿå¯¹æ¯”

| è¯æ®ç±»å‹ | ä¸Šä¼ ç«¯ç‚¹ | å­˜å‚¨ç³»ç»Ÿ | å­˜å‚¨è·¯å¾„ | æ–‡ä»¶ç±»å‹é™åˆ¶ | å¤§å°é™åˆ¶ |
|---------|---------|---------|---------|------------|---------|
| å®Œæˆè¯æ® | `/api/upload/image` | PrivateImageSystem | `private_images/tasks/{task_id}/` | ä»…å›¾ç‰‡ | 5MB |
| æœªå®Œæˆè¯æ® | `/api/upload/file` | PrivateFileSystem | `private_files/tasks/{task_id}/` | å¤šç§ç±»å‹ | å›¾ç‰‡5MBï¼Œå…¶ä»–10MB |
| ç¡®è®¤å®Œæˆè¯æ® | `/api/upload/file` | PrivateFileSystem | `private_files/tasks/{task_id}/` | å¤šç§ç±»å‹ | å›¾ç‰‡5MBï¼Œå…¶ä»–10MB |

## ğŸ” æ–‡ä»¶æŸ¥æ‰¾æœºåˆ¶

### é€šè¿‡æ–‡ä»¶IDæŸ¥æ‰¾æ–‡ä»¶

ç³»ç»Ÿä½¿ç”¨ä»¥ä¸‹ç­–ç•¥æŸ¥æ‰¾æ–‡ä»¶ï¼š

1. **ä¼˜å…ˆä»æ•°æ®åº“æŸ¥è¯¢**
   - æŸ¥è¯¢ `MessageAttachment` è¡¨ï¼Œè·å– `blob_id`ï¼ˆæ–‡ä»¶IDï¼‰
   - é€šè¿‡é™„ä»¶æ‰¾åˆ°æ¶ˆæ¯ï¼Œå†æ‰¾åˆ° `task_id` æˆ– `chat_id`
   - ç›´æ¥å®šä½åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹

2. **å›é€€åˆ°å…¨å±€æœç´¢**ï¼ˆå‘åå…¼å®¹ï¼‰
   - å¦‚æœæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œæœç´¢æ‰€æœ‰ä»»åŠ¡æ–‡ä»¶å¤¹
   - å†æœç´¢æ‰€æœ‰èŠå¤©æ–‡ä»¶å¤¹
   - æœ€åæœç´¢æ ¹ç›®å½•

### æ–‡ä»¶å‘½åè§„åˆ™

- **æ–‡ä»¶IDæ ¼å¼**: `{user_id}_{timestamp}_{random}`
  - `user_id`: ç”¨æˆ·IDï¼ˆ8ä½å­—ç¬¦ä¸²ï¼‰
  - `timestamp`: Unixæ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  - `random`: UUIDå‰8ä½

- **å®Œæ•´æ–‡ä»¶å**: `{file_id}.{extension}`
  - æ‰©å±•åä»åŸå§‹æ–‡ä»¶åã€Content-Type æˆ– magic bytes æ£€æµ‹

## ğŸ’¾ å­˜å‚¨ç¯å¢ƒ

### Railway ç”Ÿäº§ç¯å¢ƒ

- **åŸºç¡€ç›®å½•**: `/data/uploads`
- **ç§æœ‰æ–‡ä»¶ç›®å½•**: `/data/uploads/private_files`
- **ç§æœ‰å›¾ç‰‡ç›®å½•**: `/data/uploads/private_images`
- **ç‰¹ç‚¹**: ä½¿ç”¨æŒä¹…åŒ–å·ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

- **åŸºç¡€ç›®å½•**: `uploads`ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
- **ç§æœ‰æ–‡ä»¶ç›®å½•**: `uploads/private_files`
- **ç§æœ‰å›¾ç‰‡ç›®å½•**: `uploads/private_images`
- **ç‰¹ç‚¹**: æ–‡ä»¶å­˜å‚¨åœ¨é¡¹ç›®ç›®å½•ä¸­

## ğŸ“ æ•°æ®åº“è®°å½•

### MessageAttachment è¡¨

æ‰€æœ‰è¯æ®æ–‡ä»¶éƒ½ä¼šåœ¨ `MessageAttachment` è¡¨ä¸­åˆ›å»ºè®°å½•ï¼š

```sql
CREATE TABLE message_attachments (
    id SERIAL PRIMARY KEY,
    message_id INTEGER NOT NULL,           -- å…³è”çš„ç³»ç»Ÿæ¶ˆæ¯ID
    attachment_type VARCHAR(20),           -- 'image' æˆ– 'file'
    url TEXT,                              -- æ–‡ä»¶è®¿é—®URLï¼ˆå¸¦tokenï¼‰
    blob_id VARCHAR(255),                 -- æ–‡ä»¶IDï¼ˆç”¨äºæŸ¥æ‰¾æ–‡ä»¶ï¼‰
    meta TEXT,                             -- JSONå…ƒæ•°æ®ï¼ˆåŒ…å«file_idç­‰ï¼‰
    created_at TIMESTAMP WITH TIME ZONE
);
```

### è®°å½•ç¤ºä¾‹

**å®Œæˆè¯æ®**:
```json
{
  "message_id": 12345,
  "attachment_type": "image",
  "url": "/api/private-file?file=ABC12345_1704067200_a1b2c3d4&token=...",
  "blob_id": "ABC12345_1704067200_a1b2c3d4",
  "meta": null
}
```

**é€€æ¬¾ç”³è¯·è¯æ®**:
```json
{
  "message_id": 12346,
  "attachment_type": "file",
  "url": "/api/private-file?file=ABC12345_1704067200_a1b2c3d4&token=...",
  "blob_id": "ABC12345_1704067200_a1b2c3d4",
  "meta": "{\"file_id\": \"ABC12345_1704067200_a1b2c3d4\"}"
}
```

## ğŸ” å®‰å…¨æ€§

### 1. æ–‡ä»¶è®¿é—®æ§åˆ¶

- **ç§æœ‰å­˜å‚¨**: æ‰€æœ‰è¯æ®æ–‡ä»¶å­˜å‚¨åœ¨ç§æœ‰ç›®å½•ï¼Œä¸å¯¹å¤–å…¬å¼€
- **ç­¾åURL**: è®¿é—®éœ€è¦å¸¦tokençš„ç­¾åURL
- **æƒé™éªŒè¯**: åªæœ‰ä»»åŠ¡å‚ä¸è€…å¯ä»¥è®¿é—®

### 2. æ–‡ä»¶éªŒè¯

- **æ–‡ä»¶ç±»å‹éªŒè¯**: ç¦æ­¢ä¸Šä¼ å±é™©æ–‡ä»¶ç±»å‹ï¼ˆ.exe, .bat, .shç­‰ï¼‰
- **æ–‡ä»¶å¤§å°é™åˆ¶**: é˜²æ­¢ä¸Šä¼ è¿‡å¤§æ–‡ä»¶
- **å†…å®¹éªŒè¯**: æ”¯æŒä» magic bytes æ£€æµ‹çœŸå®æ–‡ä»¶ç±»å‹

### 3. æ–‡ä»¶éš”ç¦»

- **æŒ‰ä»»åŠ¡åˆ†ç±»**: æ¯ä¸ªä»»åŠ¡çš„æ–‡ä»¶å­˜å‚¨åœ¨ç‹¬ç«‹æ–‡ä»¶å¤¹
- **æŒ‰èŠå¤©åˆ†ç±»**: å®¢æœèŠå¤©çš„æ–‡ä»¶å­˜å‚¨åœ¨ç‹¬ç«‹æ–‡ä»¶å¤¹
- **é˜²æ­¢è·¯å¾„éå†**: æ–‡ä»¶åç»è¿‡å®‰å…¨å¤„ç†

## ğŸ“Š å­˜å‚¨ç»Ÿè®¡

### æ–‡ä»¶å¤§å°ä¼°ç®—

å‡è®¾ä¸€ä¸ªä»»åŠ¡æœ‰ï¼š
- å®Œæˆè¯æ®ï¼š3å¼ å›¾ç‰‡ï¼Œæ¯å¼ 2MB = 6MB
- é€€æ¬¾ç”³è¯·è¯æ®ï¼š2ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª3MB = 6MB
- ç¡®è®¤å®Œæˆè¯æ®ï¼š1ä¸ªæ–‡ä»¶ï¼Œ2MB = 2MB
- **æ€»è®¡**: çº¦14MB/ä»»åŠ¡

### å­˜å‚¨å»ºè®®

1. **å®šæœŸæ¸…ç†**: å¯ä»¥æ¸…ç†å·²å®Œæˆä¸”è¶…è¿‡ä¸€å®šæ—¶é—´çš„ä»»åŠ¡æ–‡ä»¶
2. **å‹ç¼©å­˜å‚¨**: å›¾ç‰‡å·²è‡ªåŠ¨å‹ç¼©ï¼Œå…¶ä»–æ–‡ä»¶å¯ä»¥è€ƒè™‘å‹ç¼©
3. **å½’æ¡£ç­–ç•¥**: é•¿æœŸå­˜å‚¨å¯ä»¥è€ƒè™‘å½’æ¡£åˆ°å†·å­˜å‚¨

## ğŸ”§ ç»´æŠ¤æ“ä½œ

### æŸ¥çœ‹æ–‡ä»¶

```bash
# Railway ç¯å¢ƒ
ls -lh /data/uploads/private_files/tasks/{task_id}/

# æœ¬åœ°ç¯å¢ƒ
ls -lh uploads/private_files/tasks/{task_id}/
```

### æ¸…ç†æ–‡ä»¶

```bash
# æ¸…ç†ç‰¹å®šä»»åŠ¡çš„æ–‡ä»¶
rm -rf /data/uploads/private_files/tasks/{task_id}/
rm -rf /data/uploads/private_images/tasks/{task_id}/
```

### å¤‡ä»½æ–‡ä»¶

```bash
# å¤‡ä»½æ‰€æœ‰è¯æ®æ–‡ä»¶
tar -czf evidence_backup_$(date +%Y%m%d).tar.gz /data/uploads/private_files/ /data/uploads/private_images/
```

## ğŸ“ æ€»ç»“

### å­˜å‚¨ä½ç½®æ€»ç»“

1. **å®Œæˆè¯æ®**ï¼ˆæ¥å—è€…ä¸Šä¼ ï¼‰:
   - å­˜å‚¨è·¯å¾„: `private_images/tasks/{task_id}/{file_id}.jpg`
   - ä½¿ç”¨ç§å¯†å›¾ç‰‡ç³»ç»Ÿ

2. **æœªå®Œæˆè¯æ®**ï¼ˆé€€æ¬¾ç”³è¯·ï¼‰:
   - å­˜å‚¨è·¯å¾„: `private_files/tasks/{task_id}/{file_id}.{ext}`
   - ä½¿ç”¨ç§å¯†æ–‡ä»¶ç³»ç»Ÿ

3. **ç¡®è®¤å®Œæˆè¯æ®**ï¼ˆå‘å¸ƒè€…ä¸Šä¼ ï¼‰:
   - å­˜å‚¨è·¯å¾„: `private_files/tasks/{task_id}/{file_id}.{ext}`
   - ä½¿ç”¨ç§å¯†æ–‡ä»¶ç³»ç»Ÿ

### å…³é”®ç‰¹ç‚¹

- âœ… **ç§æœ‰å­˜å‚¨**: æ‰€æœ‰æ–‡ä»¶å­˜å‚¨åœ¨ç§æœ‰ç›®å½•ï¼Œä¸å¯¹å¤–å…¬å¼€
- âœ… **æŒ‰ä»»åŠ¡åˆ†ç±»**: æ¯ä¸ªä»»åŠ¡çš„æ–‡ä»¶å­˜å‚¨åœ¨ç‹¬ç«‹æ–‡ä»¶å¤¹
- âœ… **æƒé™æ§åˆ¶**: åªæœ‰ä»»åŠ¡å‚ä¸è€…å¯ä»¥è®¿é—®
- âœ… **ç­¾åURL**: è®¿é—®éœ€è¦å¸¦tokençš„ç­¾åURL
- âœ… **æ•°æ®åº“è®°å½•**: æ‰€æœ‰æ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„æ•°æ®åº“è®°å½•

### è®¿é—®æ–¹å¼

æ‰€æœ‰è¯æ®æ–‡ä»¶éƒ½é€šè¿‡ `/api/private-file` ç«¯ç‚¹è®¿é—®ï¼Œéœ€è¦ï¼š
- æ–‡ä»¶IDï¼ˆ`file` å‚æ•°ï¼‰
- è®¿é—®tokenï¼ˆ`token` å‚æ•°ï¼‰
- ç”¨æˆ·å¿…é¡»æ˜¯ä»»åŠ¡å‚ä¸è€…
