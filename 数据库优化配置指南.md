# LinkU 数据库优化配置指南

## 📋 快速配置（使用 pg_trgm）

**推荐配置**：前期使用 **pg_trgm**（适合中英文混合场景）

### 1. 环境变量配置

```env
# 搜索配置（推荐配置）
USE_PG_TRGM=true          # ✅ 启用 pg_trgm 扩展（推荐）
# SEARCH_LANGUAGE=english  # ⚠️ 使用 pg_trgm 时此配置不起作用，可以忽略或删除
```

**重要说明**：
- ✅ `USE_PG_TRGM=true`：使用 pg_trgm 相似度搜索
- ⚠️ `SEARCH_LANGUAGE`：**在使用 pg_trgm 时不起作用**，可以忽略
- `SEARCH_LANGUAGE` 只在 `USE_PG_TRGM=false`（使用全文搜索）时才会使用

### 2. 执行数据库迁移

执行索引迁移脚本，创建 pg_trgm 索引：

```bash
psql -U postgres -d linku_db -f backend/migrations/add_performance_indexes.sql
```

**重要**：迁移脚本会自动：
- 启用 `pg_trgm` 扩展
- 创建 `idx_tasks_title_trgm` 索引（标题相似度搜索）
- 创建 `idx_tasks_description_trgm` 索引（描述相似度搜索）

### 3. 验证 pg_trgm 扩展

```sql
-- 检查扩展是否已启用
SELECT * FROM pg_extension WHERE extname = 'pg_trgm';

-- 检查索引是否已创建
SELECT 
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE indexname LIKE '%trgm%';
```

### 4. 测试搜索功能

```sql
-- 测试相似度搜索
SELECT 
    title,
    similarity(title, 'delivery') as sim_score
FROM tasks
WHERE similarity(title, 'delivery') > 0.2
ORDER BY sim_score DESC
LIMIT 10;
```

---

## 🎯 pg_trgm 的优势

### ✅ 适合您的场景

1. **中英文都适用**
   - 不需要额外的中文分词器
   - 对中文字符串也能进行相似度匹配

2. **容错搜索**
   - 支持拼写错误：搜索 "delivry" 可以匹配 "delivery"
   - 支持部分匹配：搜索 "deliv" 可以匹配 "delivery"

3. **相似度排序**
   - 可以按相似度分数排序，最相关的结果排在前面

### 📊 搜索示例

```python
# 用户搜索 "delivry"（拼写错误）
# pg_trgm 可以匹配：
- "delivery" (相似度: 0.85)
- "deliver" (相似度: 0.75)
- "delivered" (相似度: 0.70)

# 用户搜索 "送"（中文）
# pg_trgm 可以匹配：
- "送货" (相似度: 0.50)
- "配送" (相似度: 0.40)
- "快递送货" (相似度: 0.35)
```

---

## ⚙️ 配置说明

### USE_PG_TRGM=true 时

- ✅ 使用 `similarity()` 函数进行相似度搜索
- ✅ 支持模糊匹配和容错
- ✅ 中英文都适用
- ❌ 不支持词干提取（"running" 不会匹配 "run"）
- ❌ 不会过滤停用词（"the" 也会被搜索）

### 代码中的行为

当 `USE_PG_TRGM=true` 时，搜索查询会：

```python
# 使用相似度搜索
query = query.where(
    or_(
        func.similarity(models.Task.title, keyword) > 0.2,
        func.similarity(models.Task.description, keyword) > 0.2,
    )
).order_by(
    func.similarity(models.Task.title, keyword).desc(),
    func.similarity(models.Task.description, keyword).desc(),
    models.Task.created_at.desc(),  # tie-breaker
    models.Task.id.desc()
)
```

---

## 🔄 后续切换

如果将来需要切换到全文搜索：

```env
USE_PG_TRGM=false
SEARCH_LANGUAGE=english  # 或 simple/chinese
```

**注意**：
- 切换后需要重新创建全文搜索索引
- 搜索行为会改变（不再支持模糊匹配）
- 但会支持词干提取和停用词过滤

---

## 📝 检查清单

- [ ] 环境变量已设置：`USE_PG_TRGM=true`
- [ ] 已执行数据库迁移脚本
- [ ] pg_trgm 扩展已启用
- [ ] trgm 索引已创建
- [ ] 搜索功能已测试

---

## 🐛 常见问题

### Q: 为什么搜索没有使用索引？

**A**: 检查以下几点：
1. 确保 `pg_trgm` 扩展已启用
2. 确保索引已创建（`idx_tasks_title_trgm`, `idx_tasks_description_trgm`）
3. 使用 `EXPLAIN ANALYZE` 查看查询计划

```sql
EXPLAIN ANALYZE
SELECT * FROM tasks 
WHERE similarity(title, 'delivery') > 0.2
ORDER BY similarity(title, 'delivery') DESC
LIMIT 20;
```

预期应该看到：`Bitmap Index Scan using idx_tasks_title_trgm`

### Q: 相似度阈值 0.2 是什么意思？

**A**: 
- `0.0` = 完全不相似
- `1.0` = 完全相同
- `0.2` = 20% 相似度（推荐值，可以根据实际情况调整）

如果搜索结果太多，可以提高到 `0.3` 或 `0.4`  
如果搜索结果太少，可以降低到 `0.1`

---

**配置完成时间**: 2025-01-27  
**推荐配置**: `USE_PG_TRGM=true` ✅

