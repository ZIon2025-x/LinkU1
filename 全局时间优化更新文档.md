# å…¨å±€æ—¶é—´ä¼˜åŒ–æ›´æ–°æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2024-12-28  
> **é¡¹ç›®**: LinkUå¹³å°  
> **çŠ¶æ€**: ğŸ“‹ å¾…å®æ–½

---

## ğŸ“‹ ç›®å½•

1. [å½“å‰æ—¶é—´ä½¿ç”¨æƒ…å†µåˆ†æ](#å½“å‰æ—¶é—´ä½¿ç”¨æƒ…å†µåˆ†æ)
2. [å­˜åœ¨çš„é—®é¢˜](#å­˜åœ¨çš„é—®é¢˜)
3. [ä¼˜åŒ–ç›®æ ‡](#ä¼˜åŒ–ç›®æ ‡)
4. [ä¼˜åŒ–æ–¹æ¡ˆ](#ä¼˜åŒ–æ–¹æ¡ˆ)
5. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
6. [æ•°æ®åº“è¿ç§»è„šæœ¬](#æ•°æ®åº“è¿ç§»è„šæœ¬)
7. [ä»£ç è¿ç§»æ¸…å•](#ä»£ç è¿ç§»æ¸…å•)
8. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
9. [å›æ»šæ–¹æ¡ˆ](#å›æ»šæ–¹æ¡ˆ)
10. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)

---

## ğŸ” å½“å‰æ—¶é—´ä½¿ç”¨æƒ…å†µåˆ†æ

> **ğŸš¨ğŸš¨ğŸš¨ é˜»æ–­çº§è­¦ç¤ºï¼šä»¥ä¸‹æ‰€æœ‰æ—§å‡½æ•°å‡ä¸ºå­˜é‡ä»£ç  ğŸš¨ğŸš¨ğŸš¨**
> 
> **å®æ–½åå¿…é¡»ä¸º 0 å¤„**ï¼š
> - âŒ `get_uk_time()` - å¿…é¡»åˆ é™¤
> - âŒ `get_uk_time_naive()` - å¿…é¡»åˆ é™¤  
> - âŒ `datetime.utcnow()` - å¿…é¡»æ›¿æ¢ä¸º `get_utc_time()`
> - âŒ `pytz` - å¿…é¡»æ›¿æ¢ä¸º `zoneinfo`
> - âŒ æ— æ—¶åŒºçš„ `get_utc_time()` å®ç° - å¿…é¡»ç»Ÿä¸€ä¸º tz-aware ç‰ˆæœ¬
> 
> **å”¯ä¸€å…è®¸çš„å®ç°**ï¼š
> - âœ… `app/utils/time_utils.py` ä¸­çš„ `get_utc_time()`ï¼ˆè¿”å› tz-aware UTCï¼‰
> - âœ… `zoneinfo.ZoneInfo`ï¼ˆç¦æ­¢ `pytz`ï¼‰
> 
> âš ï¸ **è¯·å‹¿å¤åˆ¶ä»¥ä¸‹æ—§ä»£ç ï¼Œå®ƒä»¬å°†åœ¨è¿ç§»åå…¨éƒ¨åˆ é™¤**

### 1. æ—¶é—´å‡½æ•°ä½¿ç”¨æƒ…å†µ

#### 1.1 å½“å‰å­˜åœ¨çš„æ—¶é—´å‡½æ•°

**ä½ç½®**: `backend/app/models.py`

```python
# å‡½æ•°1: get_uk_time() - è¿”å›ä¼¦æ•¦æ—¶åŒºæ—¶é—´ï¼ˆå¸¦æ—¶åŒºï¼‰
def get_uk_time():
    """è·å–å½“å‰è‹±å›½æ—¶é—´ (è‡ªåŠ¨å¤„ç†å¤ä»¤æ—¶/å†¬ä»¤æ—¶)"""
    import pytz
    uk_tz = pytz.timezone("Europe/London")
    return datetime.now(uk_tz)  # è¿”å›å¸¦æ—¶åŒºçš„datetime

# å‡½æ•°2: get_uk_time_naive() - è¿”å›UTCæ—¶é—´ï¼ˆæ— æ—¶åŒºï¼Œä½†å®é™…è¿”å›UTCï¼‰
def get_uk_time_naive():
    """è·å–å½“å‰è‹±å›½æ—¶é—´ (timezone-naiveï¼Œç”¨äºæ•°æ®åº“å­˜å‚¨) - å…¼å®¹æ€§å‡½æ•°"""
    from app.time_utils import get_utc_time
    return get_utc_time()  # å®é™…è¿”å›UTC

# å‡½æ•°3: get_utc_time() - è¿”å›UTCæ—¶é—´ï¼ˆå¸¦æ—¶åŒºï¼‰
def get_utc_time():
    """è·å–å½“å‰UTCæ—¶é—´ï¼ˆç”¨äºæ•°æ®åº“å­˜å‚¨ï¼‰"""
    return datetime.now(tz.utc)  # è¿”å›å¸¦æ—¶åŒºçš„UTCæ—¶é—´
```

**ä½ç½®**: `backend/app/time_utils.py`

```python
# å‡½æ•°4: get_utc_time() - è¿”å›UTCæ—¶é—´ï¼ˆæ— æ—¶åŒºï¼‰
def get_utc_time():
    """è·å–å½“å‰UTCæ—¶é—´"""
    return datetime.utcnow()  # âš ï¸ è¿”å›æ— æ—¶åŒºçš„UTCæ—¶é—´

# å‡½æ•°5: get_uk_time_utc() - è¿”å›UTCæ—¶é—´ï¼ˆæ— æ—¶åŒºï¼‰
def get_uk_time_utc():
    """è·å–è‹±å›½æ—¶é—´å¹¶è½¬æ¢ä¸ºUTCå­˜å‚¨"""
    uk_tz = pytz.timezone("Europe/London")
    uk_time = datetime.now(uk_tz)
    return uk_time.astimezone(timezone.utc).replace(tzinfo=None)
```

#### 1.2 ç›´æ¥ä½¿ç”¨çš„æ—¶é—´å‡½æ•°

**ç»Ÿè®¡ç»“æœ**ï¼ˆé€šè¿‡grepæœç´¢ï¼‰:
- `datetime.utcnow()`: **36å¤„**ï¼ˆservice_auth.py, routers.py, crud.pyç­‰ï¼‰
- `datetime.now()`: **å¤šå¤„**ï¼ˆéƒ¨åˆ†å¸¦æ—¶åŒºï¼Œéƒ¨åˆ†ä¸å¸¦ï¼‰
- `pytz.timezone("Europe/London")`: **å¤šå¤„**
- `get_uk_time()`: **å¤šå¤„**ï¼ˆæ¨¡å‹é»˜è®¤å€¼ï¼‰
- `get_uk_time_naive()`: **å¤šå¤„**ï¼ˆæ¨¡å‹é»˜è®¤å€¼ï¼‰
- `get_utc_time()`: **éƒ¨åˆ†æ–°æ¨¡å‹ä½¿ç”¨**

### 2. æ•°æ®åº“æ¨¡å‹æ—¶é—´å­—æ®µä½¿ç”¨æƒ…å†µ

#### 2.1 ä½¿ç”¨ `DateTime`ï¼ˆæ— æ—¶åŒºï¼‰çš„æ¨¡å‹

```python
# ä½¿ç”¨ get_uk_time() çš„æ¨¡å‹
- User.created_at
- TaskCancelRequest.created_at
- CustomerService.created_at
- AdminRequest.created_at
- SystemSettings.created_at, updated_at
- CustomerServiceChat.created_at, ended_at, last_message_at, rated_at
- CustomerServiceMessage.created_at
- PendingUser.created_at, expires_at
- AdminUser.created_at, last_login
- Message.created_at  # ä½¿ç”¨ lambda: datetime.now()

# ä½¿ç”¨ get_uk_time_naive() çš„æ¨¡å‹
- TaskApplication.created_at, accepted_at, completed_at
- Review.created_at
- Notification.created_at
- TaskExpertApplication.created_at, updated_at  # âš ï¸ ä½†å­—æ®µæ˜¯DateTime(timezone=True)
- Coupon.created_at, updated_at  # âš ï¸ ä½†å­—æ®µæ˜¯DateTime(timezone=True)
```

#### 2.2 ä½¿ç”¨ `DateTime(timezone=True)` çš„æ¨¡å‹

```python
# ä½¿ç”¨ lambda: datetime.now(tz.utc) çš„æ¨¡å‹ï¼ˆæ–°æ¨¡å‹ï¼‰
- Coupon.valid_from, valid_until, created_at, updated_at
- CouponUsage.obtained_at, used_at, created_at
- PaymentAuthorization.reserved_at, confirmed_at, expires_at, created_at
- PaymentTransaction.created_at, updated_at
- RefundTransaction.refunded_at, created_at
- TaskExpertApplication.created_at, updated_at  # âš ï¸ ä½†é»˜è®¤å€¼ç”¨get_uk_time_naive()
- ç­‰ç­‰...
```

### 3. æ—¶åŒºåº“ä½¿ç”¨æƒ…å†µ

- **pytz**: å¤šå¤„ä½¿ç”¨ï¼ˆå·²å¼ƒç”¨ï¼ŒPython 3.9+æ¨èä½¿ç”¨zoneinfoï¼‰
- **zoneinfo**: éƒ¨åˆ†æ–°ä»£ç ä½¿ç”¨ï¼ˆ`time_utils.py`ä¸­æœ‰æ¡ä»¶å¯¼å…¥ï¼‰

---

## âš ï¸ å­˜åœ¨çš„é—®é¢˜

### 1. æ—¶é—´åŸºå‡†æ··ç”¨

**é—®é¢˜æè¿°**:
- å­˜å‚¨æ—¶é—´æ··ç”¨äº†ä¼¦æ•¦æ—¶åŒºï¼ˆBST/GMTï¼‰å’ŒUTC
- åŒä¸€æ¨¡å‹çš„ä¸åŒå­—æ®µå¯èƒ½ä½¿ç”¨ä¸åŒçš„æ—¶é—´åŸºå‡†
- `get_uk_time_naive()` å‡½æ•°åæš—ç¤ºè¿”å›ä¼¦æ•¦æ—¶é—´ï¼Œä½†å®é™…è¿”å›UTC

**å½±å“**:
- DSTåˆ‡æ¢æ—¶ä¼šå‡ºç°æ—¶é—´è®¡ç®—é”™è¯¯
- æ’é˜Ÿç­‰å¾…æ—¶é—´è®¡ç®—ä¸å‡†ç¡®
- è¶…æ—¶åˆ¤æ–­å¯èƒ½å‡ºé”™
- æ•°æ®ä¸ä¸€è‡´

### 2. æ—¶åŒºä¿¡æ¯ç¼ºå¤±

**é—®é¢˜æè¿°**:
- å¤§é‡æ¨¡å‹ä½¿ç”¨ `DateTime`ï¼ˆæ— æ—¶åŒºï¼‰ï¼Œæ— æ³•æ­£ç¡®å¤„ç†DST
- éƒ¨åˆ†æ¨¡å‹ä½¿ç”¨ `DateTime(timezone=True)`ï¼Œä½†é»˜è®¤å€¼ä½¿ç”¨æ— æ—¶åŒºå‡½æ•°

**å½±å“**:
- æ— æ³•å‡†ç¡®åˆ¤æ–­æ—¶é—´æ˜¯å¦åœ¨DSTæœŸé—´
- æ—¶é—´æ¯”è¾ƒå¯èƒ½å‡ºç°Â±1å°æ—¶è¯¯å·®
- è·¨æ—¶åŒºæŸ¥è¯¢å›°éš¾

### 3. å‡½æ•°è¯­ä¹‰æ··ä¹±

**é—®é¢˜æè¿°**:
- `get_uk_time()` è¿”å›ä¼¦æ•¦æ—¶åŒº
- `get_uk_time_naive()` å®é™…è¿”å›UTCï¼ˆä½†å‡½æ•°åæš—ç¤ºä¼¦æ•¦æ—¶é—´ï¼‰
- `get_utc_time()` åœ¨ä¸åŒæ–‡ä»¶ä¸­æœ‰ä¸åŒå®ç°ï¼ˆä¸€ä¸ªè¿”å›å¸¦æ—¶åŒºï¼Œä¸€ä¸ªè¿”å›æ— æ—¶åŒºï¼‰

**å½±å“**:
- ä»£ç å¯è¯»æ€§å·®
- å®¹æ˜“è¯¯ç”¨
- ç»´æŠ¤å›°éš¾

### 4. ç›´æ¥ä½¿ç”¨ `datetime.utcnow()`

**é—®é¢˜æè¿°**:
- 36å¤„ç›´æ¥ä½¿ç”¨ `datetime.utcnow()`ï¼ˆè¿”å›æ— æ—¶åŒºæ—¶é—´ï¼‰
- ä¸ç¬¦åˆPython 3.9+æœ€ä½³å®è·µ

**å½±å“**:
- æ—¶åŒºä¿¡æ¯ä¸¢å¤±
- æ— æ³•æ­£ç¡®å¤„ç†DST

### 5. pytz vs zoneinfoæ··ç”¨

**é—®é¢˜æè¿°**:
- æ—§ä»£ç ä½¿ç”¨ `pytz`
- æ–°ä»£ç ä½¿ç”¨ `zoneinfo`
- `time_utils.py` ä¸­æœ‰æ¡ä»¶å¯¼å…¥ï¼Œä½†å®é™…ä»ä½¿ç”¨pytz

**å½±å“**:
- ä»£ç ä¸ä¸€è‡´
- pytzå·²å¼ƒç”¨ï¼ˆPython 3.9+æ¨èzoneinfoï¼‰

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™

1. **å­˜å‚¨ä¸è®¡ç®—ä¸€å¾‹UTC**ï¼›å­—æ®µå¿…é¡»å¸¦æ—¶åŒºï¼ˆTIMESTAMPTZ / timezone-awareï¼‰
2. **å±•ç¤ºä¸è¥ä¸šè§„åˆ™è‹¥éœ€è¦"å½“åœ°æ—¶é—´"**ï¼Œåªåœ¨å…¥/å‡ºè¾¹ç•Œä½¿ç”¨Europe/Londonï¼ˆzoneinfoï¼‰ï¼Œä¸è¦åœ¨ä¸­é—´è¿‡ç¨‹æ··å…¥æœ¬åœ°æ—¶é—´
3. **è°ƒåº¦ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ç”¨UTCè§¦å‘**ï¼›å¦‚éœ€"æ¯å¤©8:00è‹±å›½æ—¶é—´"ï¼Œç”¨"croné€»è¾‘+Europe/London"è€Œä¸æ˜¯æŠŠUTCå½“æœ¬åœ°

### å…·ä½“ç›®æ ‡

1. âœ… ç»Ÿä¸€æ‰€æœ‰æ•°æ®åº“æ—¶é—´å­—æ®µä¸º `DateTime(timezone=True)`ï¼ˆå¯¹åº”PostgreSQLçš„TIMESTAMPTZï¼‰
2. âœ… ç»Ÿä¸€æ‰€æœ‰æ—¶é—´ç”Ÿæˆå‡½æ•°ä¸º `get_utc_time()`ï¼ˆè¿”å›å¸¦æ—¶åŒºçš„UTCæ—¶é—´ï¼‰
3. âœ… ç§»é™¤æ‰€æœ‰ `datetime.utcnow()` å’Œ `datetime.now()` çš„ç›´æ¥ä½¿ç”¨
4. âœ… ç»Ÿä¸€ä½¿ç”¨ `zoneinfo` æ›¿ä»£ `pytz`
5. âŒ ç«‹å³åˆ é™¤ `get_uk_time()` å’Œ `get_uk_time_naive()`ï¼Œä¸ä¿ç•™å¼ƒç”¨å‡½æ•°ï¼ˆä¼šè¢«è¯¯ç”¨ï¼‰
6. âœ… æ‰€æœ‰APIè¿”å›ISO-8601 + Zçš„UTCæ ¼å¼ï¼ˆæœåŠ¡ç«¯ä¸è¿”å›æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ï¼‰
7. âœ… å‰ç«¯ç»Ÿä¸€ä½¿ç”¨UTCï¼Œæ˜¾ç¤ºæ—¶æŒ‰ `Europe/London` æ—¶åŒºæ¸²æŸ“

---

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. åˆ›å»ºç»Ÿä¸€çš„æ—¶é—´å·¥å…·æ¨¡å—

**æ–‡ä»¶**: `backend/app/utils/time_utils.py`ï¼ˆæ–°å»ºï¼‰

**ğŸš¨ å…³é”®åŸåˆ™**:
- âœ… åªä¿ç•™ä¸€ä¸ª `get_utc_time()` å®ç°ï¼ˆå¸¦æ—¶åŒºUTCï¼‰
- âœ… å…¨å±€ç»Ÿä¸€ä½¿ç”¨ `zoneinfo`ï¼Œç¦æ­¢ `pytz`
- âœ… ä¸¥æ ¼åŒºåˆ†è§£æï¼ˆnaiveâ†’awareï¼‰å’Œè½¬æ¢ï¼ˆawareâ†’UTCï¼‰
- âœ… ç«‹å³åˆ é™¤ `get_uk_time()` å’Œ `get_uk_time_naive()`ï¼Œä¸è¦ä¿ç•™å¼ƒç”¨å‡½æ•°

```python
"""
ç»Ÿä¸€æ—¶é—´å¤„ç†å·¥å…·æ¨¡å—
æ‰€æœ‰æ—¶é—´ç›¸å…³æ“ä½œç»Ÿä¸€ä½¿ç”¨æ­¤æ¨¡å—

æ ¸å¿ƒåŸåˆ™ï¼š
1. å­˜å‚¨ä¸è®¡ç®—ä¸€å¾‹UTCï¼ˆå¸¦æ—¶åŒºï¼‰
2. å±•ç¤ºä¸è§£æåªåœ¨å…¥/å‡ºè¾¹ç•Œä½¿ç”¨Europe/London
3. ç¦æ­¢naiveæ—¶é—´è‡ªåŠ¨å‡è®¾ä¸ºUTC
4. å…¨å±€ç»Ÿä¸€ä½¿ç”¨zoneinfoï¼Œç¦æ­¢pytz
"""
from datetime import datetime, timezone
from zoneinfo import ZoneInfo

# æ—¶åŒºå¸¸é‡
LONDON = ZoneInfo("Europe/London")

# ==================== æ ¸å¿ƒæ—¶é—´å‡½æ•° ====================

def get_utc_time() -> datetime:
    """
    è·å–å½“å‰UTCæ—¶é—´ï¼ˆå¸¦æ—¶åŒºä¿¡æ¯ï¼‰
    
    è¿™æ˜¯å”¯ä¸€çš„æ—¶é—´ç”Ÿæˆå‡½æ•°ï¼Œæ‰€æœ‰æ–°ä»£ç å¿…é¡»ä½¿ç”¨æ­¤å‡½æ•°
    
    Returns:
        datetime: å¸¦æ—¶åŒºçš„UTCæ—¶é—´å¯¹è±¡
    """
    return datetime.now(timezone.utc)  # å”¯ä¸€æƒå¨


def to_utc(dt: datetime) -> datetime:
    """
    å°†å¸¦æ—¶åŒºçš„æ—¶é—´è½¬æ¢ä¸ºUTC
    
    âš ï¸ ä¸æ¥å—naiveæ—¶é—´ï¼Œå¿…é¡»æ˜¾å¼æä¾›æ—¶åŒºä¿¡æ¯
    
    Args:
        dt: å¸¦æ—¶åŒºçš„æ—¶é—´å¯¹è±¡
    
    Returns:
        datetime: UTCæ—¶é—´å¯¹è±¡ï¼ˆå¸¦æ—¶åŒºï¼‰
    
    Raises:
        ValueError: å¦‚æœdtæ˜¯naiveæ—¶é—´
    """
    if dt.tzinfo is None:
        raise ValueError("Naive datetime is not allowed. Use parse_local_as_utc().")
    return dt.astimezone(timezone.utc)


def parse_local_as_utc(naive_local: datetime, tz: ZoneInfo = LONDON) -> datetime:
    """
    æŠŠæœ¬åœ°å¢™é’Ÿæ—¶é—´è§£é‡Šä¸ºæŸæ—¶åŒºï¼Œå†è½¬UTC
    
    ç”¨äºæ—§æ•°æ®è¿ç§»æˆ–ç”¨æˆ·è¾“å…¥è§£æ
    å¯¹"ä¸å¯è¾¾"æˆ–"æ­§ä¹‰"æ—¶åˆ»ï¼Œæ˜¾å¼æ‹’ç»/æ¶ˆæ­§
    
    Args:
        naive_local: æ— æ—¶åŒºçš„æœ¬åœ°æ—¶é—´ï¼ˆå¢™é’Ÿæ—¶é—´ï¼‰
        tz: æ—¶åŒºå¯¹è±¡ï¼Œé»˜è®¤ä¸ºEurope/London
    
    Returns:
        datetime: UTCæ—¶é—´å¯¹è±¡ï¼ˆå¸¦æ—¶åŒºï¼‰
    
    Raises:
        ValueError: å¦‚æœnaive_localå·²å¸¦æ—¶åŒºæˆ–æ—¶é—´æ— æ•ˆ
    """
    if naive_local.tzinfo is not None:
        raise ValueError("Expect naive local time")
    
    # å¯¹"ä¸å¯è¾¾"æˆ–"æ­§ä¹‰"æ—¶åˆ»ï¼Œæ˜¾å¼æ‹’ç»/æ¶ˆæ­§ï¼ˆé»˜è®¤laterï¼‰
    return handle_ambiguous_time(naive_local, tz, disambiguation="later")


def handle_ambiguous_time(
    naive_local: datetime,
    tz: ZoneInfo = LONDON,
    disambiguation: str = "later"
) -> datetime:
    """
    å¤„ç†æ­§ä¹‰æ—¶é—´ï¼ˆDSTå›æ‹¨æ—¶å‡ºç°ï¼‰
    
    spring-gap: raise ValueError
    fall-back: fold=0/1 æ¶ˆæ­§
    
    Args:
        naive_local: æœ¬åœ°æ—¶é—´ï¼ˆæ— æ—¶åŒºï¼‰
        tz: æ—¶åŒºå¯¹è±¡ï¼Œé»˜è®¤ä¸ºEurope/London
        disambiguation: å¤„ç†ç­–ç•¥ ("earlier", "later", "reject")
    
    Returns:
        datetime: UTCæ—¶é—´å¯¹è±¡
    
    Raises:
        ValueError: å¦‚æœæ—¶é—´æ— æ•ˆï¼ˆæ˜¥å‰æ‹¨ï¼‰æˆ–disambiguation="reject"ä¸”æ—¶é—´æ­§ä¹‰
    """
    if naive_local.tzinfo is not None:
        raise ValueError("Expect naive local time")
    
    try:
        if disambiguation == "earlier":
            aware = naive_local.replace(tzinfo=tz, fold=0)
        elif disambiguation == "later":
            aware = naive_local.replace(tzinfo=tz, fold=1)
        else:  # reject
            a0 = naive_local.replace(tzinfo=tz, fold=0)
            a1 = naive_local.replace(tzinfo=tz, fold=1)
            if a0.utcoffset() != a1.utcoffset():
                raise ValueError("Ambiguous local time; choose earlier/later")
            aware = a0
    except Exception as e:
        raise ValueError("Invalid local time due to DST transition") from e
    
    return aware.astimezone(timezone.utc)


def to_user_timezone(dt_utc: datetime, tz: ZoneInfo = LONDON) -> datetime:
    """
    å°†UTCæ—¶é—´è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼‰
    
    Args:
        dt_utc: UTCæ—¶é—´å¯¹è±¡ï¼ˆå¦‚æœæ— æ—¶åŒºï¼Œå‡è®¾æ˜¯UTCï¼‰
        tz: ç›®æ ‡æ—¶åŒºå¯¹è±¡ï¼Œé»˜è®¤ä¸ºEurope/London
    
    Returns:
        datetime: ç”¨æˆ·æ—¶åŒºæ—¶é—´å¯¹è±¡
    """
    if dt_utc.tzinfo is None:
        # å¦‚æœæ— æ—¶åŒºï¼Œå‡è®¾æ˜¯UTCï¼ˆä»…ç”¨äºformat_iso_utcçš„å…œåº•ï¼‰
        dt_utc = dt_utc.replace(tzinfo=timezone.utc)
    else:
        # ç¡®ä¿æ˜¯UTC
        dt_utc = dt_utc.astimezone(timezone.utc)
    
    return dt_utc.astimezone(tz)


def format_time_for_display(dt: datetime, user_timezone: ZoneInfo = LONDON) -> str:
    """
    æ ¼å¼åŒ–æ—¶é—´ç”¨äºæ˜¾ç¤ºï¼ˆè½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºï¼‰
    
    Args:
        dt: UTCæ—¶é—´å¯¹è±¡
        user_timezone: ç”¨æˆ·æ—¶åŒºå¯¹è±¡
    
    Returns:
        str: æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
    """
    local_time = to_user_timezone(dt, user_timezone)
    return local_time.strftime('%Y-%m-%d %H:%M:%S %Z')


def format_iso_utc(dt: datetime) -> str:
    """
    æ ¼å¼åŒ–ä¸ºISO-8601 UTCæ ¼å¼ï¼ˆç”¨äºAPIè¿”å›ï¼‰
    
    Args:
        dt: UTCæ—¶é—´å¯¹è±¡ï¼ˆå¦‚æœæ— æ—¶åŒºï¼Œå‡è®¾æ˜¯UTCï¼‰
    
    Returns:
        str: ISO-8601æ ¼å¼å­—ç¬¦ä¸²ï¼Œå¦‚ "2024-12-28T10:30:00Z"
    """
    # å…œåº•ï¼šå¦‚æœæ— æ—¶åŒºï¼Œå‡è®¾æ˜¯UTCï¼ˆä»…æ­¤ä¸€å¤„å…è®¸ï¼‰
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    else:
        dt = dt.astimezone(timezone.utc)
    
    return dt.isoformat().replace('+00:00', 'Z')


def detect_dst_transition_dates(year: int, tz: ZoneInfo = LONDON) -> dict:
    """
    æ£€æµ‹æŒ‡å®šå¹´ä»½çš„DSTåˆ‡æ¢æ—¥æœŸ
    
    Args:
        year: å¹´ä»½
        tz: æ—¶åŒºå¯¹è±¡
    
    Returns:
        dict: {
            "spring_transition": "YYYY-MM-DD" or None,
            "autumn_transition": "YYYY-MM-DD" or None,
            "year": year
        }
    """
    spring_transition = None
    autumn_transition = None
    
    # æ£€æŸ¥3æœˆæœ€åä¸€ä¸ªå‘¨æ—¥ï¼ˆæ˜¥å­£ï¼‰
    for day in range(25, 32):
        try:
            test_date = datetime(year, 3, day, 1, 0, tzinfo=tz)
            if test_date.weekday() == 6:  # å‘¨æ—¥
                # æ£€æŸ¥æ˜¯å¦ä¸ºåˆ‡æ¢æ—¥ï¼ˆUTCåç§»å˜åŒ–ï¼‰
                prev_day = datetime(year, 3, day - 1, 1, 0, tzinfo=tz)
                if test_date.utcoffset() != prev_day.utcoffset():
                    spring_transition = test_date.strftime("%Y-%m-%d")
                    break
        except (ValueError, OSError):
            continue
    
    # æ£€æŸ¥10æœˆæœ€åä¸€ä¸ªå‘¨æ—¥ï¼ˆç§‹å­£ï¼‰
    for day in range(25, 32):
        try:
            test_date = datetime(year, 10, day, 1, 0, tzinfo=tz)
            if test_date.weekday() == 6:  # å‘¨æ—¥
                # æ£€æŸ¥æ˜¯å¦ä¸ºåˆ‡æ¢æ—¥
                prev_day = datetime(year, 10, day - 1, 1, 0, tzinfo=tz)
                if test_date.utcoffset() != prev_day.utcoffset():
                    autumn_transition = test_date.strftime("%Y-%m-%d")
                    break
        except (ValueError, OSError):
            continue
    
    return {
        "spring_transition": spring_transition,
        "autumn_transition": autumn_transition,
        "year": year
    }
```

**âš ï¸ é‡è¦è¯´æ˜**:
- âœ… **å”¯ä¸€å®ç°**: åªä¿ç•™ä¸€ä¸ª `get_utc_time()`ï¼ˆè¿”å›tz-aware UTCï¼‰
- âŒ **ç«‹å³åˆ é™¤** `get_uk_time()` å’Œ `get_uk_time_naive()`ï¼Œä¸è¦ä¿ç•™å¼ƒç”¨å‡½æ•°ï¼ˆä¼šè¢«è¯¯ç”¨ï¼‰
- âŒ **ç¦æ­¢pytz**: å…¨å±€ç»Ÿä¸€ä½¿ç”¨ `zoneinfo.ZoneInfo`ï¼Œç¦æ­¢ä»»ä½• `pytz` å¯¼å…¥å’Œä½¿ç”¨ï¼ˆè¿ç§»è„šæœ¬é™¤å¤–ï¼‰
- âœ… æ‰€æœ‰ä»£ç ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`
- âœ… æ—§æ•°æ®è¿ç§»ä½¿ç”¨ `parse_local_as_utc()` æ˜ç¡®è§£æ
- âœ… `to_user_timezone()` åªæ¥å— `ZoneInfo` å¯¹è±¡ï¼Œä¸æ¥å—å­—ç¬¦ä¸²

### 2. æ•°æ®åº“è¿ç§»ç­–ç•¥

**åŸåˆ™**: **å…ˆåº“åä»£ç **

1. å…ˆæŠŠæ•°æ®åº“å­—æ®µåˆ‡ä¸º `TIMESTAMPTZ` å¹¶å®Œæˆæ•°æ®è½¬æ¢
2. å†å…¨é‡æ›¿æ¢è°ƒç”¨ç‚¹åˆ° `get_utc_time()`
3. æœ€åç§»é™¤ `get_uk_time()` æˆ–æ ‡è®°ä¸ºå¼ƒç”¨

### 3. ä»£ç è¿ç§»ç­–ç•¥

1. **æ¨¡å‹é»˜è®¤å€¼**: ç»Ÿä¸€æ”¹ä¸º `default=get_utc_time`
2. **æ¨¡å‹å­—æ®µç±»å‹**: ç»Ÿä¸€æ”¹ä¸º `DateTime(timezone=True)`
3. **å‡½æ•°è°ƒç”¨**: å…¨é‡æ›¿æ¢ `datetime.utcnow()` â†’ `get_utc_time()`
4. **æ—¶åŒºåº“**: ç»Ÿä¸€ä½¿ç”¨ `zoneinfo`ï¼Œç§»é™¤ `pytz`ï¼ˆè¿ç§»è„šæœ¬é™¤å¤–ï¼‰

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### é˜¶æ®µ1: å‡†å¤‡é˜¶æ®µï¼ˆ1-2å¤©ï¼‰

#### 1.1 åˆ›å»ºç»Ÿä¸€æ—¶é—´å·¥å…·æ¨¡å—

- [ ] åˆ›å»º `backend/app/utils/time_utils.py`
- [ ] å®ç°æ‰€æœ‰æ—¶é—´å·¥å…·å‡½æ•°
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

#### 1.2 ä»£ç å®¡è®¡

- [ ] ç»Ÿè®¡æ‰€æœ‰ä½¿ç”¨æ—¶é—´å‡½æ•°çš„ä½ç½®
- [ ] åˆ—å‡ºéœ€è¦è¿ç§»çš„æ¨¡å‹å’Œå­—æ®µ
- [ ] åˆ—å‡ºéœ€è¦è¿ç§»çš„å‡½æ•°è°ƒç”¨

#### 1.3 å¤‡ä»½æ•°æ®

- [ ] å¤‡ä»½æ‰€æœ‰ç›¸å…³è¡¨çš„æ•°æ®
- [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§

### é˜¶æ®µ2: æ•°æ®åº“è¿ç§»ï¼ˆ3-5å¤©ï¼‰

#### 2.1 è¿ç§»è„šæœ¬å‡†å¤‡

- [ ] ç¼–å†™æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆè§ä¸‹æ–¹ï¼‰
- [ ] åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»è„šæœ¬
- [ ] å‡†å¤‡å›æ»šè„šæœ¬

#### 2.2 æ‰§è¡Œè¿ç§»

- [ ] åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œè¿ç§»
- [ ] éªŒè¯æ•°æ®è½¬æ¢æ­£ç¡®æ€§ï¼ˆç‰¹åˆ«æ˜¯DSTåˆ‡æ¢æ—¥æœŸï¼‰
- [ ] åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»ï¼ˆä½å³°æœŸï¼‰

#### 2.3 éªŒè¯è¿ç§»ç»“æœ

- [ ] æŠ½æ ·æ£€æŸ¥æ•°æ®è½¬æ¢ç»“æœ
- [ ] éªŒè¯æ—¶é—´æŸ¥è¯¢æ­£ç¡®æ€§
- [ ] éªŒè¯DSTåˆ‡æ¢æ—¥æœŸæ•°æ®

### é˜¶æ®µ3: ä»£ç è¿ç§»ï¼ˆ5-7å¤©ï¼‰

#### 3.1 æ¨¡å‹è¿ç§»

- [ ] æ›´æ–°æ‰€æœ‰æ¨¡å‹çš„æ—¶é—´å­—æ®µä¸º `DateTime(timezone=True)`
- [ ] æ›´æ–°æ‰€æœ‰æ¨¡å‹çš„é»˜è®¤å€¼ä¸º `get_utc_time`
- [ ] è¿è¡Œæµ‹è¯•ç¡®ä¿æ¨¡å‹å®šä¹‰æ­£ç¡®

#### 3.2 å‡½æ•°è°ƒç”¨è¿ç§»

- [ ] æ›¿æ¢æ‰€æœ‰ `datetime.utcnow()` â†’ `get_utc_time()`
- [ ] æ›¿æ¢æ‰€æœ‰ `datetime.now()` â†’ `get_utc_time()`
- [ ] æ›¿æ¢æ‰€æœ‰ `get_uk_time()` â†’ `get_utc_time()`ï¼ˆæ–°ä»£ç ï¼‰
- [ ] æ›¿æ¢æ‰€æœ‰ `get_uk_time_naive()` â†’ `get_utc_time()`ï¼ˆæ–°ä»£ç ï¼‰

#### 3.3 æ—¶åŒºåº“è¿ç§»

- [ ] æ›¿æ¢æ‰€æœ‰ `pytz` â†’ `zoneinfo`ï¼ˆé™¤è¿ç§»è„šæœ¬ï¼‰
- [ ] æ›´æ–° `time_utils.py` ç§»é™¤pytzä¾èµ–

#### 3.4 APIè¿”å›æ ¼å¼ç»Ÿä¸€

- [ ] æ‰€æœ‰APIè¿”å›æ—¶é—´ä½¿ç”¨ `format_iso_utc()`
- [ ] ç¡®ä¿è¿”å›æ ¼å¼ä¸ºISO-8601 + Z

### é˜¶æ®µ4: æµ‹è¯•ä¸éªŒè¯ï¼ˆ3-5å¤©ï¼‰

#### 4.1 å•å…ƒæµ‹è¯•

- [ ] æµ‹è¯•æ—¶é—´å‡½æ•°æ­£ç¡®æ€§
- [ ] æµ‹è¯•DSTåˆ‡æ¢æ—¥æœŸå¤„ç†
- [ ] æµ‹è¯•æ—¶é—´è½¬æ¢æ­£ç¡®æ€§

#### 4.2 é›†æˆæµ‹è¯•

- [ ] æµ‹è¯•æ—¶é—´å­—æ®µè¯»å†™
- [ ] æµ‹è¯•æ—¶é—´æŸ¥è¯¢
- [ ] æµ‹è¯•APIè¿”å›æ ¼å¼

#### 4.3 å›å½’æµ‹è¯•

- [ ] æµ‹è¯•æ‰€æœ‰æ—¶é—´ç›¸å…³åŠŸèƒ½
- [ ] æµ‹è¯•å®¢æœå¯¹è¯è¶…æ—¶
- [ ] æµ‹è¯•ä»»åŠ¡æˆªæ­¢æ—¶é—´
- [ ] æµ‹è¯•ç”¨æˆ·æ³¨å†Œæ—¶é—´

### é˜¶æ®µ5: ä¸Šçº¿ä¸ç›‘æ§ï¼ˆ1-2å¤©ï¼‰

#### 5.1 ä¸Šçº¿

- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] ç›‘æ§é”™è¯¯æ—¥å¿—
- [ ] ç›‘æ§æ€§èƒ½æŒ‡æ ‡

#### 5.2 éªŒè¯

- [ ] éªŒè¯ç”Ÿäº§ç¯å¢ƒæ•°æ®æ­£ç¡®æ€§
- [ ] éªŒè¯APIè¿”å›æ ¼å¼
- [ ] éªŒè¯å‰ç«¯æ—¶é—´æ˜¾ç¤º

---

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»è„šæœ¬

### è„šæœ¬1: CustomerServiceChatè¡¨è¿ç§»

```sql
-- ============================================
-- CustomerServiceChat è¡¨æ—¶é—´å­—æ®µè¿ç§»
-- ============================================

-- æ­¥éª¤1: å¤‡ä»½æ•°æ®
CREATE TABLE customer_service_chats_backup AS 
SELECT * FROM customer_service_chats;

-- æ­¥éª¤2: æ·»åŠ æ–°åˆ—ï¼ˆå¸¦æ—¶åŒºï¼‰
ALTER TABLE customer_service_chats
  ADD COLUMN created_at_utc       TIMESTAMPTZ,
  ADD COLUMN last_message_at_utc  TIMESTAMPTZ,
  ADD COLUMN ended_at_utc         TIMESTAMPTZ,
  ADD COLUMN rated_at_utc         TIMESTAMPTZ;

-- æ­¥éª¤3: éªŒè¯æ•°æ®æºï¼ˆåœ¨è½¬æ¢å‰æ‰§è¡Œï¼Œéœ€è¦äººå·¥ç¡®è®¤ï¼‰
-- 
-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘  ğŸš¨ğŸš¨ğŸš¨ é˜»æ–­çº§è­¦ç¤ºï¼šåªè§£é‡Šä¸€æ¬¡ä¼¦æ•¦â†’UTC çš„é€‚ç”¨èŒƒå›´ ğŸš¨ğŸš¨ğŸš¨                â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘  æœ¬è„šæœ¬å‡è®¾æ‰€æœ‰æ—§æ•°æ®éƒ½æ˜¯ä¼¦æ•¦æ—¶åŒºï¼ˆEurope/Londonï¼‰çš„å¢™é’Ÿæ—¶é—´            â•‘
-- â•‘                                                                          â•‘
-- â•‘  âŒ ç¦æ­¢ï¼šå¦‚æœæ•°æ®æ¥æºä¸æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œç¦æ­¢å¥—ç”¨æ­¤è„šæœ¬                      â•‘
-- â•‘  âœ… å¿…é¡»ï¼šéä¼¦æ•¦æ¥æºçš„æ•°æ®è¯·å•ç‹¬è¿ç§»ï¼Œä½¿ç”¨ç‹¬ç«‹çš„è½¬æ¢ç­–ç•¥                â•‘
-- â•‘                                                                          â•‘
-- â•‘  ä¸Šçº¿å½“å¤©æ‰§è¡Œ runbook æ—¶ï¼Œæ­¤è­¦ç¤ºå¿…é¡»å‡ºç°åœ¨ Checklist é¡¶éƒ¨              â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 
-- âš ï¸ å…³é”®ï¼šå¿…é¡»å…ˆç¡®è®¤æ—§æ•°æ®æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œå¦åˆ™ä¼šé”™è¯¯è§£é‡Š
-- è¯·å…ˆæ‰§è¡ŒéªŒè¯æŸ¥è¯¢ï¼Œäººå·¥ç¡®è®¤æ•°æ®æºåå†ç»§ç»­
SELECT 
    created_at,
    created_at AT TIME ZONE 'Europe/London' as interpreted_as_london,
    created_at AT TIME ZONE 'UTC' as interpreted_as_utc
FROM customer_service_chats
WHERE created_at IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;
-- è¯·äººå·¥ç¡®è®¤ï¼šå¦‚æœ"è§£é‡Šä¸ºä¼¦æ•¦"çš„ç»“æœåˆç†ï¼Œåˆ™ç»§ç»­ï¼›å¦åˆ™éœ€è¦è°ƒæ•´è½¬æ¢ç­–ç•¥
-- å¦‚æœæ•°æ®æ¥æºä¸æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œè¯·ä½¿ç”¨å•ç‹¬çš„è¿ç§»è„šæœ¬

-- æ­¥éª¤4: è½¬æ¢ç°æœ‰æ•°æ®ï¼ˆåªè§£é‡Šä¸€æ¬¡ï¼šå‡è®¾æ—§æ•°æ®æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œè½¬æ¢ä¸ºUTCï¼‰
-- ğŸš¨ é‡è¦ï¼šæ­¤æ­¥éª¤å°†æ—§æ•°æ®è§£é‡Šä¸ºä¼¦æ•¦æ—¶åŒºï¼Œåªæ‰§è¡Œä¸€æ¬¡
-- å¦‚æœæ•°æ®æ¥æºä¸æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œè¯·åœæ­¢å¹¶ä¿®æ”¹è½¬æ¢ç­–ç•¥
UPDATE customer_service_chats
SET created_at_utc      = created_at      AT TIME ZONE 'Europe/London',
    last_message_at_utc = last_message_at AT TIME ZONE 'Europe/London',
    ended_at_utc        = ended_at         AT TIME ZONE 'Europe/London',
    rated_at_utc        = rated_at         AT TIME ZONE 'Europe/London'
WHERE created_at IS NOT NULL;

-- æ­¥éª¤5: å›å¡«NULLå€¼ï¼ˆåœ¨SET NOT NULLä¹‹å‰ï¼‰
-- âš ï¸ æ³¨æ„ï¼šNOW()æ˜¯TIMESTAMPTZï¼Œç›´æ¥ä½¿ç”¨ï¼Œä¸è¦ AT TIME ZONE 'UTC'ï¼ˆä¼šå˜æˆnaiveï¼‰
UPDATE customer_service_chats
SET created_at_utc = COALESCE(created_at_utc, NOW())
WHERE created_at_utc IS NULL;

UPDATE customer_service_chats
SET last_message_at_utc = COALESCE(last_message_at_utc, NOW())
WHERE last_message_at_utc IS NULL;

-- æ­¥éª¤6: éªŒè¯æ•°æ®ï¼ˆæŠ½æ ·æ£€æŸ¥ï¼Œç‰¹åˆ«æ˜¯DSTåˆ‡æ¢æ—¥æœŸï¼‰
SELECT 
    id,
    created_at,
    created_at_utc,
    created_at_utc AT TIME ZONE 'Europe/London' as london_time_check,
    last_message_at,
    last_message_at_utc,
    ended_at,
    ended_at_utc
FROM customer_service_chats
WHERE created_at IS NOT NULL
ORDER BY created_at DESC
LIMIT 20;

-- æ­¥éª¤7: æ£€æŸ¥DSTåˆ‡æ¢æ—¥æœŸçš„æ•°æ®ï¼ˆä½¿ç”¨åŠ¨æ€æ£€æµ‹ï¼Œç¦æ­¢ç¡¬ç¼–ç ï¼‰
-- âš ï¸ é‡è¦ï¼šå¿…é¡»ä½¿ç”¨ detect_dst_transition_dates(year) å‡½æ•°åŠ¨æ€è·å–DSTåˆ‡æ¢æ—¥æœŸ
-- âŒ ç¦æ­¢ç¡¬ç¼–ç æ—¥æœŸï¼ˆå¦‚ '2024-03-31'ï¼‰ï¼Œé¿å…æ˜å¹´å¿˜æ”¹
-- 
-- æ‰§è¡Œå‰å…ˆè¿è¡ŒPythonè„šæœ¬è·å–DSTåˆ‡æ¢æ—¥æœŸï¼š
-- python -c "from app.utils.time_utils import detect_dst_transition_dates, LONDON; d=detect_dst_transition_dates(2024, LONDON); print(d['spring_transition'], d['autumn_transition'])"
--
-- ç„¶åå°†è¾“å‡ºæ—¥æœŸå¡«å…¥ä»¥ä¸‹æŸ¥è¯¢ï¼š
SELECT 
    id,
    created_at,
    created_at_utc
FROM customer_service_chats
WHERE DATE(created_at) IN (
    -- âš ï¸ å¿…é¡»ä½¿ç”¨ detect_dst_transition_dates(2024) çš„è¾“å‡ºï¼Œä¸è¦ç¡¬ç¼–ç 
    -- ç¤ºä¾‹ï¼ˆå®é™…åº”æ›¿æ¢ä¸ºå‡½æ•°è¾“å‡ºï¼‰ï¼š
    '2024-03-31',  -- æ˜¥å‰æ‹¨ï¼ˆä» detect_dst_transition_dates(2024) è·å–ï¼‰
    '2024-10-27'   -- ç§‹å›æ‹¨ï¼ˆä» detect_dst_transition_dates(2024) è·å–ï¼‰
)
ORDER BY created_at;

-- æ­¥éª¤8: å¯¼å‡ºä¾èµ–å…³ç³»ï¼ˆç´¢å¼•ã€å¤–é”®ã€é»˜è®¤å€¼ã€è§¦å‘å™¨ï¼‰
-- åœ¨åˆ é™¤åˆ—ä¹‹å‰ï¼Œå…ˆå¯¼å‡ºè¿™äº›ä¾èµ–ï¼Œè¿ç§»åéœ€è¦é‡å»º
-- 
-- å¯¼å‡ºç´¢å¼•ï¼š
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'customer_service_chats';
--
-- å¯¼å‡ºå¤–é”®ï¼š
SELECT conname, pg_get_constraintdef(oid) as definition
FROM pg_constraint
WHERE conrelid = 'customer_service_chats'::regclass
AND contype = 'f';
--
-- å¯¼å‡ºé»˜è®¤å€¼ï¼š
SELECT column_name, column_default
FROM information_schema.columns
WHERE table_name = 'customer_service_chats'
AND column_default IS NOT NULL;

-- æ­¥éª¤9: å¦‚æœéªŒè¯é€šè¿‡ï¼Œåˆ é™¤æ—§åˆ—ï¼Œé‡å‘½åæ–°åˆ—
-- âš ï¸ æ³¨æ„ï¼šåˆ é™¤åˆ—ä¼šåŒæ—¶åˆ é™¤ç´¢å¼•ï¼Œéœ€è¦é‡å»º
ALTER TABLE customer_service_chats
  DROP COLUMN created_at,
  RENAME COLUMN created_at_utc      TO created_at,
  DROP COLUMN last_message_at,
  RENAME COLUMN last_message_at_utc TO last_message_at,
  DROP COLUMN ended_at,
  RENAME COLUMN ended_at_utc        TO ended_at,
  DROP COLUMN rated_at,
  RENAME COLUMN rated_at_utc        TO rated_at;

-- æ­¥éª¤10: é‡å»ºç´¢å¼•å’Œçº¦æŸï¼ˆå›ºå®šæ¨¡æ¿ï¼Œå¿…é¡»æ‰§è¡Œï¼‰
-- âš ï¸ æ³¨æ„ï¼šä»¥ä¸‹ä¸ºç¤ºä¾‹æ¨¡æ¿ï¼Œå®é™…æ‰§è¡Œæ—¶éœ€æ ¹æ®æ­¥éª¤8å¯¼å‡ºçš„å®šä¹‰è°ƒæ•´
-- âš ï¸ é˜²æ­¢é‡åå†²çªï¼šå…ˆåˆ é™¤æ—§ç´¢å¼•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå†åˆ›å»ºæ–°ç´¢å¼•

-- 10.1 é‡å»ºç´¢å¼•ï¼ˆæ ¹æ®æ­¥éª¤8å¯¼å‡ºçš„indexdefé‡å»ºï¼Œé˜²æ­¢é‡åå†²çªï¼‰
-- å›ºå®šæ¨¡æ¿ï¼šDROP INDEX IF EXISTS ...; CREATE INDEX IF NOT EXISTS ...;
-- âš ï¸ æ³¨æ„ï¼šäº‹åŠ¡å†…ä¸èƒ½ä½¿ç”¨ CONCURRENTLYï¼Œå¤§ç´¢å¼•éœ€åœ¨äº‹åŠ¡å¤–é‡å»º
-- ç¤ºä¾‹ï¼š
DROP INDEX IF EXISTS ix_customer_service_chats_created_at;
CREATE INDEX IF NOT EXISTS ix_customer_service_chats_created_at 
ON customer_service_chats(created_at);

DROP INDEX IF EXISTS ix_customer_service_chats_last_message_at;
CREATE INDEX IF NOT EXISTS ix_customer_service_chats_last_message_at 
ON customer_service_chats(last_message_at);

-- 10.2 é‡å»ºå¤–é”®çº¦æŸï¼ˆæ ¹æ®æ­¥éª¤8å¯¼å‡ºçš„çº¦æŸå®šä¹‰é‡å»ºï¼‰
-- ç¤ºä¾‹ï¼š
-- ALTER TABLE customer_service_chats 
-- ADD CONSTRAINT fk_customer_service_chats_user_id 
-- FOREIGN KEY (user_id) REFERENCES users(id);

-- 10.3 é‡å»ºé»˜è®¤å€¼ï¼ˆè·³è¿‡å·²è¿ç§»çš„å­—æ®µï¼Œå®ƒä»¬ä¼šæœ‰æ–°çš„é»˜è®¤å€¼ï¼‰
-- ç¤ºä¾‹ï¼š
-- ALTER TABLE customer_service_chats 
-- ALTER COLUMN status SET DEFAULT 'pending';

-- æ­¥éª¤11: æ·»åŠ NOT NULLçº¦æŸï¼ˆåœ¨å›å¡«ä¹‹åï¼‰
ALTER TABLE customer_service_chats
  ALTER COLUMN created_at SET NOT NULL,
  ALTER COLUMN last_message_at SET NOT NULL;
```

### è„šæœ¬2: Userè¡¨è¿ç§»

```sql
-- ============================================
-- User è¡¨æ—¶é—´å­—æ®µè¿ç§»
-- ============================================

-- æ­¥éª¤1: å¤‡ä»½æ•°æ®
CREATE TABLE users_backup AS 
SELECT * FROM users;

-- æ­¥éª¤2: æ·»åŠ æ–°åˆ—ï¼ˆå¸¦æ—¶åŒºï¼‰
ALTER TABLE users
  ADD COLUMN created_at_utc       TIMESTAMPTZ,
  ADD COLUMN terms_agreed_at_utc  TIMESTAMPTZ,
  ADD COLUMN name_updated_at_utc  TIMESTAMPTZ,
  ADD COLUMN suspend_until_utc    TIMESTAMPTZ;

-- æ­¥éª¤3: è½¬æ¢ç°æœ‰æ•°æ®
UPDATE users
SET created_at_utc      = created_at      AT TIME ZONE 'Europe/London',
    terms_agreed_at_utc = terms_agreed_at AT TIME ZONE 'Europe/London',
    name_updated_at_utc = name_updated_at AT TIME ZONE 'Europe/London',
    suspend_until_utc   = suspend_until   AT TIME ZONE 'Europe/London'
WHERE created_at IS NOT NULL;

-- æ­¥éª¤4: éªŒè¯æ•°æ®
SELECT 
    id,
    created_at,
    created_at_utc,
    created_at_utc AT TIME ZONE 'Europe/London' as london_time_check
FROM users
WHERE created_at IS NOT NULL
ORDER BY created_at DESC
LIMIT 20;

-- æ­¥éª¤5: åˆ é™¤æ—§åˆ—ï¼Œé‡å‘½åæ–°åˆ—
ALTER TABLE users
  DROP COLUMN created_at,
  RENAME COLUMN created_at_utc      TO created_at,
  DROP COLUMN terms_agreed_at,
  RENAME COLUMN terms_agreed_at_utc TO terms_agreed_at,
  DROP COLUMN name_updated_at,
  RENAME COLUMN name_updated_at_utc TO name_updated_at,
  DROP COLUMN suspend_until,
  RENAME COLUMN suspend_until_utc   TO suspend_until;

-- æ­¥éª¤11: æ·»åŠ NOT NULLçº¦æŸï¼ˆåœ¨å›å¡«ä¹‹åï¼‰
ALTER TABLE users
  ALTER COLUMN created_at SET NOT NULL;
```

### è„šæœ¬3: æ‰¹é‡è¿ç§»æ‰€æœ‰è¡¨ï¼ˆè‡ªåŠ¨åŒ–è„šæœ¬ï¼Œå¸¦äº‹åŠ¡ä¿æŠ¤ï¼‰

```python
# migrate_all_time_fields.py
"""
æ‰¹é‡è¿ç§»æ‰€æœ‰è¡¨çš„æ—¶é—´å­—æ®µ
âš ï¸ æ¯å¼ è¡¨ç‹¬ç«‹äº‹åŠ¡ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
"""
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker
import os
from typing import Dict, List

# æ•°æ®åº“è¿æ¥
DATABASE_URL = os.getenv("DATABASE_URL")
engine = create_engine(DATABASE_URL, isolation_level="AUTOCOMMIT")  # æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡
Session = sessionmaker(bind=engine)

# éœ€è¦è¿ç§»çš„è¡¨å’Œå­—æ®µæ˜ å°„
TABLES_TO_MIGRATE: Dict[str, List[str]] = {
    "customer_service_chats": [
        "created_at",
        "last_message_at",
        "ended_at",
        "rated_at"
    ],
    "users": [
        "created_at",
        "terms_agreed_at",
        "name_updated_at",
        "suspend_until"
    ],
    # ... æ›´å¤šè¡¨
}

def export_table_dependencies(table_name: str, db) -> dict:
    """
    å¯¼å‡ºè¡¨çš„ä¾èµ–å…³ç³»ï¼ˆç´¢å¼•ã€å¤–é”®ã€é»˜è®¤å€¼ã€è§¦å‘å™¨ï¼‰
    
    Returns:
        dict: {
            "indexes": [...],
            "foreign_keys": [...],
            "defaults": {...},
            "triggers": [...]
        }
    """
    # æŸ¥è¯¢ç´¢å¼•
    indexes_result = db.execute(text(f"""
        SELECT indexname, indexdef
        FROM pg_indexes
        WHERE tablename = '{table_name}'
    """))
    indexes = [row.indexdef for row in indexes_result]
    
    # æŸ¥è¯¢å¤–é”®ï¼ˆä¿å­˜çº¦æŸåå’Œå®šä¹‰ï¼Œç”¨äºå®Œæ•´é‡å»ºï¼‰
    fk_result = db.execute(text(f"""
        SELECT conname, pg_get_constraintdef(oid) as definition
        FROM pg_constraint
        WHERE conrelid = '{table_name}'::regclass
        AND contype = 'f'
    """))
    foreign_keys = [{"name": row.conname, "def": row.definition} for row in fk_result]
    
    # æŸ¥è¯¢é»˜è®¤å€¼
    defaults_result = db.execute(text(f"""
        SELECT column_name, column_default
        FROM information_schema.columns
        WHERE table_name = '{table_name}'
        AND column_default IS NOT NULL
    """))
    defaults = {row.column_name: row.column_default for row in defaults_result}
    
    return {
        "indexes": indexes,
        "foreign_keys": foreign_keys,
        "defaults": defaults,
        "triggers": []  # è§¦å‘å™¨éœ€è¦å•ç‹¬æŸ¥è¯¢
    }

def migrate_table(table_name: str, fields: List[str], db):
    """
    è¿ç§»å•ä¸ªè¡¨çš„æ—¶é—´å­—æ®µï¼ˆå¸¦äº‹åŠ¡ä¿æŠ¤ï¼‰
    
    æ¯å¼ è¡¨ç‹¬ç«‹äº‹åŠ¡ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
    """
    print(f"\nå¼€å§‹è¿ç§»è¡¨: {table_name}")
    
    # å¼€å§‹äº‹åŠ¡
    trans = db.begin()
    
    try:
        # æ­¥éª¤1: å¯¼å‡ºä¾èµ–å…³ç³»
        print(f"  1. å¯¼å‡ºä¾èµ–å…³ç³»...")
        dependencies = export_table_dependencies(table_name, db)
        
        # æ­¥éª¤2: å¤‡ä»½ï¼ˆåœ¨äº‹åŠ¡å†…ï¼‰
        print(f"  2. å¤‡ä»½è¡¨ {table_name}...")
        db.execute(text(f"""
            CREATE TABLE {table_name}_backup AS 
            SELECT * FROM {table_name}
        """))
        # æ·»åŠ æ³¨é‡Šï¼šä»…åº”æ€¥ä¸´æ—¶ä½¿ç”¨ï¼Œä¸Šçº¿åä¸€å‘¨å†…å›æ”¶
        db.execute(text(f"""
            COMMENT ON TABLE {table_name}_backup IS 
            'Temporary backup table for time migration. Delete after 1 week.'
        """))
        
        # æ­¥éª¤3: æ·»åŠ æ–°åˆ—
        print(f"  3. æ·»åŠ æ–°åˆ—...")
        for field in fields:
            db.execute(text(f"""
                ALTER TABLE {table_name}
                ADD COLUMN {field}_utc TIMESTAMPTZ
            """))
        
        # æ­¥éª¤4: è½¬æ¢æ•°æ®ï¼ˆåªè§£é‡Šä¸€æ¬¡ï¼šå‡è®¾æ—§æ•°æ®æ˜¯ä¼¦æ•¦æ—¶åŒºï¼‰
        # 
        # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        # â•‘  ğŸš¨ğŸš¨ğŸš¨ é˜»æ–­çº§è­¦ç¤ºï¼šåªè§£é‡Šä¸€æ¬¡ä¼¦æ•¦â†’UTC çš„é€‚ç”¨èŒƒå›´ ğŸš¨ğŸš¨ğŸš¨                â•‘
        # â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        # â•‘  æœ¬è„šæœ¬å‡è®¾æ‰€æœ‰æ—§æ•°æ®éƒ½æ˜¯ä¼¦æ•¦æ—¶åŒºï¼ˆEurope/Londonï¼‰çš„å¢™é’Ÿæ—¶é—´            â•‘
        # â•‘                                                                          â•‘
        # â•‘  âŒ ç¦æ­¢ï¼šå¦‚æœæ•°æ®æ¥æºä¸æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œç¦æ­¢å¥—ç”¨æ­¤è„šæœ¬                      â•‘
        # â•‘  âœ… å¿…é¡»ï¼šéä¼¦æ•¦æ¥æºçš„æ•°æ®è¯·å•ç‹¬è¿ç§»ï¼Œä½¿ç”¨ç‹¬ç«‹çš„è½¬æ¢ç­–ç•¥                â•‘
        # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        print(f"  4. è½¬æ¢æ•°æ®...")
        set_clauses = ", ".join([
            f"{field}_utc = {field} AT TIME ZONE 'Europe/London'"
            for field in fields
        ])
        db.execute(text(f"""
            UPDATE {table_name}
            SET {set_clauses}
            WHERE {fields[0]} IS NOT NULL
        """))
        
        # æ­¥éª¤5: å›å¡«NULLå€¼ï¼ˆåœ¨SET NOT NULLä¹‹å‰ï¼‰
        print(f"  5. å›å¡«NULLå€¼...")
        for field in fields:
            # âš ï¸ æ³¨æ„ï¼šNOW()æ˜¯TIMESTAMPTZï¼Œç›´æ¥ä½¿ç”¨ï¼Œä¸è¦ AT TIME ZONE 'UTC'
            db.execute(text(f"""
                UPDATE {table_name}
                SET {field}_utc = COALESCE({field}_utc, NOW())
                WHERE {field}_utc IS NULL
            """))
        
        # æ­¥éª¤6: éªŒè¯æ•°æ®
        print(f"  6. éªŒè¯æ•°æ®...")
        result = db.execute(text(f"""
            SELECT 
                COUNT(*) as total,
                COUNT({fields[0]}_utc) as converted,
                COUNT(CASE WHEN {fields[0]}_utc IS NULL THEN 1 END) as null_count
            FROM {table_name}
        """))
        row = result.fetchone()
        print(f"    æ€»è®°å½•æ•°: {row.total}, å·²è½¬æ¢: {row.converted}, NULLæ•°: {row.null_count}")
        
        if row.null_count > 0:
            raise ValueError(f"ä»æœ‰ {row.null_count} æ¡è®°å½•çš„ {fields[0]}_utc ä¸ºNULL")
        
        # æ­¥éª¤7: åˆ é™¤æ—§åˆ—ï¼Œé‡å‘½åæ–°åˆ—
        print(f"  7. åˆ é™¤æ—§åˆ—ï¼Œé‡å‘½åæ–°åˆ—...")
        alter_clauses = []
        
        # å…ˆåˆ é™¤æ—§åˆ—
        for field in fields:
            alter_clauses.append(f"DROP COLUMN {field}")
        
        # å†é‡å‘½åæ–°åˆ—
        for field in fields:
            alter_clauses.append(f"RENAME COLUMN {field}_utc TO {field}")
        
        db.execute(text(f"""
            ALTER TABLE {table_name}
            {', '.join(alter_clauses)}
        """))
        
        # æ­¥éª¤8: é‡å»ºç´¢å¼•å’Œçº¦æŸï¼ˆå›ºå®šæ¨¡æ¿ï¼Œå¿…é¡»æ‰§è¡Œï¼Œä¸èƒ½æ˜¯passï¼‰
        print(f"  8. é‡å»ºç´¢å¼•å’Œçº¦æŸ...")
        print(f"    âš ï¸ æ³¨æ„ï¼šåˆ é™¤æ—§åˆ—ä¼šåŒæ—¶åˆ é™¤ç´¢å¼•ï¼Œå¿…é¡»é‡å»º")
        
        # 8.1 é‡å»ºç´¢å¼•ï¼ˆå›ºå®šæ¨¡æ¿ï¼Œé˜²æ­¢é‡åå†²çªï¼‰
        # PostgreSQLçš„indexdefæ ¼å¼ï¼šCREATE INDEX index_name ON table_name (column_name)
        # ç”±äºæˆ‘ä»¬ä½¿ç”¨RENAME COLUMNï¼Œå­—æ®µåä¿æŒä¸å˜ï¼Œå¤§å¤šæ•°ç´¢å¼•å®šä¹‰å¯ä»¥ç›´æ¥é‡å»º
        # âš ï¸ æ³¨æ„ï¼šäº‹åŠ¡å†…ä¸èƒ½ä½¿ç”¨ CONCURRENTLYï¼Œå¤§ç´¢å¼•éœ€åœ¨äº‹åŠ¡å¤–é‡å»º
        import re
        for idx_def in dependencies["indexes"]:
            # ä» indexdef ä¸­æå–ç´¢å¼•åï¼ˆæ ¼å¼ï¼šCREATE INDEX index_name ON ...ï¼‰
            # å¦‚æœæå–å¤±è´¥ï¼Œä½¿ç”¨è¡¨å+åˆ—åç”Ÿæˆ
            idx_name_match = re.search(r'CREATE (?:UNIQUE )?INDEX (?:IF NOT EXISTS )?(\w+)', idx_def, re.IGNORECASE)
            if idx_name_match:
                idx_name = idx_name_match.group(1)
            else:
                # å¦‚æœæ— æ³•æå–ï¼Œä½¿ç”¨è¡¨å+éšæœºåç¼€ï¼ˆå®é™…åº”é¿å…ï¼‰
                idx_name = f"{table_name}_idx_{hash(idx_def) % 10000}"
                print(f"    âš ï¸ è­¦å‘Šï¼šæ— æ³•ä»ç´¢å¼•å®šä¹‰æå–ç´¢å¼•åï¼Œä½¿ç”¨ç”Ÿæˆå: {idx_name}")
            
            # å…ˆåˆ é™¤æ—§ç´¢å¼•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå†åˆ›å»ºæ–°ç´¢å¼•
            # ä½¿ç”¨ IF NOT EXISTS é˜²æŠ–ï¼Œé¿å…é‡åå†²çª
            try:
                # åˆ é™¤æ—§ç´¢å¼•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                db.execute(text(f"DROP INDEX IF EXISTS {idx_name}"))
                
                # åˆ›å»ºæ–°ç´¢å¼•ï¼ˆä½¿ç”¨ IF NOT EXISTS é˜²æŠ–ï¼‰
                # ç§»é™¤åŸå®šä¹‰ä¸­çš„ IF NOT EXISTSï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç»Ÿä¸€ä½¿ç”¨æˆ‘ä»¬çš„æ¨¡æ¿
                cleaned_idx_def = re.sub(r'IF NOT EXISTS\s+', '', idx_def, flags=re.IGNORECASE)
                # æ›¿æ¢ CREATE INDEX æˆ– CREATE UNIQUE INDEX
                if 'UNIQUE' in cleaned_idx_def.upper():
                    rebuilt_idx_def = re.sub(
                        r'CREATE\s+UNIQUE\s+INDEX\s+' + re.escape(idx_name),
                        f'CREATE UNIQUE INDEX IF NOT EXISTS {idx_name}',
                        cleaned_idx_def,
                        flags=re.IGNORECASE,
                        count=1
                    )
                else:
                    rebuilt_idx_def = re.sub(
                        r'CREATE\s+INDEX\s+' + re.escape(idx_name),
                        f'CREATE INDEX IF NOT EXISTS {idx_name}',
                        cleaned_idx_def,
                        flags=re.IGNORECASE,
                        count=1
                    )
                
                db.execute(text(rebuilt_idx_def))
                print(f"    âœ… é‡å»ºç´¢å¼•æˆåŠŸ: {idx_name}")
            except Exception as e:
                print(f"    âš ï¸ è­¦å‘Šï¼šé‡å»ºç´¢å¼•å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´: {e}")
                print(f"    ç´¢å¼•å: {idx_name}")
                print(f"    ç´¢å¼•å®šä¹‰: {idx_def}")
                print(f"    âš ï¸ è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹SQLé‡å»ºç´¢å¼•:")
                print(f"    DROP INDEX IF EXISTS {idx_name};")
                print(f"    CREATE INDEX IF NOT EXISTS {idx_name} ON {table_name}(...);")
        
        # 8.2 é‡å»ºå¤–é”®çº¦æŸï¼ˆå›ºå®šæ¨¡æ¿ï¼‰
        # foreign_keys æ ¼å¼ï¼š[{"name": "constraint_name", "def": "FOREIGN KEY (col) REFERENCES other_table(id)"}]
        for fk in dependencies["foreign_keys"]:
            try:
                # å®Œæ•´SQLæ ¼å¼ï¼šALTER TABLE table_name ADD CONSTRAINT constraint_name fk_definition;
                constraint_sql = f"ALTER TABLE {table_name} ADD CONSTRAINT {fk['name']} {fk['def']}"
                db.execute(text(constraint_sql))
                print(f"    âœ… é‡å»ºå¤–é”®æˆåŠŸ: {fk['name']}")
            except Exception as e:
                print(f"    âš ï¸ è­¦å‘Šï¼šé‡å»ºå¤–é”®å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´: {e}")
                print(f"    çº¦æŸå: {fk['name']}")
                print(f"    å¤–é”®å®šä¹‰: {fk['def']}")
                print(f"    âš ï¸ è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹SQLé‡å»ºå¤–é”®:")
                print(f"    ALTER TABLE {table_name} ADD CONSTRAINT {fk['name']} {fk['def']};")
        
        # 8.3 é‡å»ºé»˜è®¤å€¼ï¼ˆå›ºå®šæ¨¡æ¿ï¼‰
        # è·³è¿‡å·²è¿ç§»çš„å­—æ®µï¼Œå®ƒä»¬ä¼šæœ‰æ–°çš„é»˜è®¤å€¼ï¼ˆget_utc_timeï¼‰
        for col, default_expr in dependencies["defaults"].items():
            if col not in fields:
                try:
                    db.execute(text(f"""
                        ALTER TABLE {table_name} 
                        ALTER COLUMN {col} SET DEFAULT {default_expr};
                    """))
                    print(f"    âœ… é‡å»ºé»˜è®¤å€¼æˆåŠŸ: {col}")
                except Exception as e:
                    print(f"    âš ï¸ è­¦å‘Šï¼šé‡å»ºé»˜è®¤å€¼å¤±è´¥ {col}: {e}")
                    print(f"    âš ï¸ è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹SQLé‡å»ºé»˜è®¤å€¼:")
                    print(f"    ALTER TABLE {table_name} ALTER COLUMN {col} SET DEFAULT {default_expr};")
        
        # æ­¥éª¤9: æ·»åŠ NOT NULLçº¦æŸï¼ˆåœ¨å›å¡«ä¹‹åï¼‰
        print(f"  9. æ·»åŠ NOT NULLçº¦æŸ...")
        for field in fields:
            db.execute(text(f"""
                ALTER TABLE {table_name}
                ALTER COLUMN {field} SET NOT NULL
            """))
        
        # æäº¤äº‹åŠ¡
        trans.commit()
        print(f"  âœ… è¡¨ {table_name} è¿ç§»å®Œæˆ")
        
    except Exception as e:
        # å›æ»šäº‹åŠ¡
        trans.rollback()
        print(f"  âŒ è¡¨ {table_name} è¿ç§»å¤±è´¥: {e}")
        raise

def validate_data_source(table_name: str, db):
    """
    éªŒè¯æ•°æ®æºï¼šæŠ½æ ·æ£€æŸ¥æ—§æ•°æ®æ˜¯å¦ä¸ºä¼¦æ•¦æ—¶åŒº
    
    åœ¨è¿ç§»å‰æ‰§è¡Œï¼Œéœ€è¦äººå·¥ç¡®è®¤
    
    ğŸš¨ é˜»æ–­çº§è­¦ç¤ºï¼šå¦‚æœæ•°æ®æ¥æºä¸æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œè¯·åœæ­¢å¹¶ä¿®æ”¹è½¬æ¢ç­–ç•¥
    """
    print(f"\néªŒè¯è¡¨ {table_name} çš„æ•°æ®æº...")
    print("  ğŸš¨ğŸš¨ğŸš¨ é˜»æ–­çº§è­¦ç¤ºï¼šæœ¬è„šæœ¬å‡è®¾æ‰€æœ‰æ—§æ•°æ®éƒ½æ˜¯ä¼¦æ•¦æ—¶åŒº ğŸš¨ğŸš¨ğŸš¨")
    print("  å¦‚æœæ•°æ®æ¥æºä¸æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œä½¿ç”¨æ­¤è„šæœ¬ä¼šå¯¼è‡´æ—¶é—´é”™è¯¯è§£é‡Š")
    print()
    
    # æŠ½æ ·æ£€æŸ¥
    result = db.execute(text(f"""
        SELECT 
            created_at,
            created_at AT TIME ZONE 'Europe/London' as interpreted_as_london,
            created_at AT TIME ZONE 'UTC' as interpreted_as_utc
        FROM {table_name}
        WHERE created_at IS NOT NULL
        ORDER BY created_at DESC
        LIMIT 10
    """))
    
    print("  æŠ½æ ·æ•°æ®ï¼ˆè¯·äººå·¥ç¡®è®¤æ˜¯å¦ä¸ºä¼¦æ•¦æ—¶åŒºï¼‰:")
    for row in result:
        print(f"    åŸå§‹: {row.created_at}")
        print(f"    è§£é‡Šä¸ºä¼¦æ•¦: {row.interpreted_as_london}")
        print(f"    è§£é‡Šä¸ºUTC: {row.interpreted_as_utc}")
        print()
    
    # è¯¢é—®ç”¨æˆ·ç¡®è®¤ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰
    print("  âš ï¸ è¯·ä»”ç»†æ£€æŸ¥ä¸Šè¿°æ•°æ®ï¼Œç¡®è®¤'è§£é‡Šä¸ºä¼¦æ•¦'çš„ç»“æœæ˜¯å¦åˆç†")
    response = input(f"  ç¡®è®¤è¡¨ {table_name} çš„æ—§æ•°æ®æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Ÿ(yes/no): ")
    if response.lower() != 'yes':
        raise ValueError(f"ç”¨æˆ·å–æ¶ˆè¿ç§»è¡¨ {table_name}ï¼ˆæ•°æ®æºä¸æ˜¯ä¼¦æ•¦æ—¶åŒºï¼‰")

def main():
    """ä¸»å‡½æ•°"""
    print("å¼€å§‹æ‰¹é‡è¿ç§»æ—¶é—´å­—æ®µ...")
    print("âš ï¸ æ¯å¼ è¡¨ç‹¬ç«‹äº‹åŠ¡ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š")
    
    db = Session()
    
    try:
        # å…ˆéªŒè¯æ‰€æœ‰è¡¨çš„æ•°æ®æº
        for table_name in TABLES_TO_MIGRATE.keys():
            validate_data_source(table_name, db)
        
        # å†æ‰§è¡Œè¿ç§»
        for table_name, fields in TABLES_TO_MIGRATE.items():
            migrate_table(table_name, fields, db)
        
        print("\nâœ… æ‰€æœ‰è¡¨è¿ç§»å®Œæˆ")
        print("\nâš ï¸ è¯·åœ¨ä¸€å‘¨å†…åˆ é™¤æ‰€æœ‰ _backup è¡¨")
        
    except Exception as e:
        print(f"\nâŒ è¿ç§»å¤±è´¥: {e}")
        print("å·²å›æ»šæ‰€æœ‰æœªæäº¤çš„äº‹åŠ¡")
        raise
    finally:
        db.close()

if __name__ == "__main__":
    main()
```

---

## ğŸ“ ä»£ç è¿ç§»æ¸…å•

### 1. æ¨¡å‹è¿ç§»æ¸…å•

#### éœ€è¦è¿ç§»çš„æ¨¡å‹ï¼ˆä½¿ç”¨ `DateTime` æ— æ—¶åŒºï¼‰

```python
# backend/app/models.py

# âœ… å·²è¿ç§»ï¼ˆä½¿ç”¨DateTime(timezone=True)ï¼‰
# - TaskExpertApplication
# - Coupon
# - CouponUsage
# - PaymentAuthorization
# - PaymentTransaction
# - RefundTransaction
# - ç­‰ç­‰...

# âš ï¸ å¾…è¿ç§»
- User
- Task
- TaskApplication
- Review
- Message
- Notification
- TaskCancelRequest
- CustomerService
- AdminRequest
- SystemSettings
- CustomerServiceChat
- CustomerServiceMessage
- PendingUser
- AdminUser
- ç­‰ç­‰...
```

#### è¿ç§»æ­¥éª¤

1. **æ›´æ–°å­—æ®µç±»å‹**:
   ```python
   # æ—§ä»£ç 
   created_at = Column(DateTime, default=get_uk_time)
   
   # æ–°ä»£ç 
   created_at = Column(DateTime(timezone=True), default=get_utc_time)
   ```

2. **æ›´æ–°é»˜è®¤å€¼**:
   ```python
   # æ—§ä»£ç 
   from app.models import get_uk_time
   
   # æ–°ä»£ç 
   from app.utils.time_utils import get_utc_time
   ```

### 2. å‡½æ•°è°ƒç”¨è¿ç§»æ¸…å•

#### éœ€è¦æ›¿æ¢çš„å‡½æ•°è°ƒç”¨

**æ–‡ä»¶**: `backend/app/service_auth.py`
- [ ] `datetime.utcnow()` â†’ `get_utc_time()` (9å¤„)

**æ–‡ä»¶**: `backend/app/routers.py`
- [ ] `datetime.utcnow()` â†’ `get_utc_time()` (5å¤„)
- [ ] `pytz.timezone("Europe/London")` â†’ `ZoneInfo("Europe/London")` (2å¤„)
- [ ] `datetime.now()` â†’ `get_utc_time()` (1å¤„)

**æ–‡ä»¶**: `backend/app/crud.py`
- [ ] `datetime.utcnow()` â†’ `get_utc_time()` (3å¤„)
- [ ] `pytz.timezone("Europe/London")` â†’ `ZoneInfo("Europe/London")` (1å¤„)
- [ ] `datetime.now()` â†’ `get_utc_time()` (1å¤„)

**æ–‡ä»¶**: `backend/app/user_redis_cleanup.py`
- [ ] `datetime.utcnow()` â†’ `get_utc_time()` (3å¤„)

**æ–‡ä»¶**: `backend/app/cleanup_tasks.py`
- [ ] `datetime.utcnow()` â†’ `get_utc_time()` (3å¤„)
- [ ] `datetime.now()` â†’ `get_utc_time()` (1å¤„)

**æ–‡ä»¶**: `backend/app/admin_auth.py`
- [ ] `datetime.utcnow()` â†’ `get_utc_time()` (å¤šå¤„)

**æ–‡ä»¶**: `backend/app/async_crud.py`
- [ ] `datetime.utcnow()` â†’ `get_utc_time()` (2å¤„)

**æ–‡ä»¶**: `backend/app/deps.py`
- [ ] `datetime.datetime.utcnow()` â†’ `get_utc_time()` (1å¤„)

### 3. APIè¿”å›æ ¼å¼è¿ç§»

**éœ€è¦æ›´æ–°çš„APIç«¯ç‚¹**:
- [ ] æ‰€æœ‰è¿”å›æ—¶é—´å­—æ®µçš„API
- [ ] ä½¿ç”¨ `format_iso_utc()` æ ¼å¼åŒ–æ—¶é—´

**âš ï¸ APIè¿”å›å£å¾„**:
- âœ… æœåŠ¡ç«¯ç»Ÿä¸€è¿”å›ISO-8601 + Zæ ¼å¼çš„UTCæ—¶é—´ï¼ˆä½¿ç”¨ `format_iso_utc()`ï¼‰
- âœ… æœåŠ¡ç«¯ä¸è¿”å›æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
- âœ… æ‰€æœ‰æ—¶é—´å±•ç¤ºç”±å‰ç«¯æŒ‰ `Europe/London` æ—¶åŒºæ¸²æŸ“
- âŒ ç¦æ­¢åœ¨APIä¸­ç›´æ¥ä½¿ç”¨ `.isoformat()`ï¼Œå¿…é¡»ä½¿ç”¨ `format_iso_utc()`

**âš ï¸ æ—¶åŒºè½¬æ¢å‡½æ•°å‚æ•°ç±»å‹çº¦å®š**:
- âœ… `to_user_timezone(dt_utc, tz)` çš„ `tz` å‚æ•°**åªæ¥å— `ZoneInfo` å¯¹è±¡**ï¼Œä¸æ¥å—å­—ç¬¦ä¸²
- âŒ ç¦æ­¢ä¼ å…¥å­—ç¬¦ä¸²å¦‚ `"Europe/London"`ï¼Œå¿…é¡»ä½¿ç”¨ `ZoneInfo("Europe/London")` æˆ– `LONDON` å¸¸é‡
- âœ… å‰ç«¯æ¸²æŸ“æ—¶ä¹Ÿåº”ä½¿ç”¨ `ZoneInfo` å¯¹è±¡è¿›è¡Œæ—¶åŒºè½¬æ¢
- ğŸ“ ç¤ºä¾‹ï¼š
  ```python
  # âœ… æ­£ç¡®
  from app.utils.time_utils import to_user_timezone, LONDON
  local_time = to_user_timezone(utc_time, LONDON)
  
  # âŒ é”™è¯¯
  local_time = to_user_timezone(utc_time, "Europe/London")  # TypeError
  ```

**âš ï¸ to_user_timezone() çš„ naive å…œåº•ä½¿ç”¨è¾¹ç•Œ**:
- âš ï¸ **å‡½æ•°å¯¹ naive æ—¶é—´çš„å¤„ç†**ï¼šå¦‚æœ `dt_utc` ä¸º naiveï¼ˆæ— æ—¶åŒºï¼‰ï¼Œå‡½æ•°ä¼š**å‡å®šå®ƒå°±æ˜¯ UTC å¹¶è¡¥ tzinfo**
- âœ… **å¯¹å¤– API æ°¸è¿œè¿”å›å¸¦ Z çš„ UTC**ï¼šæ‰€æœ‰ API è¿”å›çš„æ—¶é—´å¿…é¡»ä½¿ç”¨ `format_iso_utc()`ï¼Œç¡®ä¿è¿”å›å¸¦æ—¶åŒºçš„ UTC æ—¶é—´
- âš ï¸ **å†…éƒ¨ä½¿ç”¨è¾¹ç•Œ**ï¼šnaive å…œåº•é€»è¾‘ä»…ç”¨äºæå°‘æ•°å†å²é—ç•™ä»£ç çš„å…¼å®¹ï¼Œ**æ–°ä»£ç ç¦æ­¢ä¼ å…¥ naive æ—¶é—´**
- âŒ **ç¦æ­¢æ”¾æ¾è¾“å…¥æ£€æŸ¥**ï¼šçœ‹åˆ°å…œåº•é€»è¾‘ä¸ä»£è¡¨å¯ä»¥æ”¾æ¾è¾“å…¥æ£€æŸ¥ï¼Œæ‰€æœ‰æ–°ä»£ç å¿…é¡»ç¡®ä¿ä¼ å…¥çš„æ—¶é—´å¸¦æ—¶åŒº
- ğŸ“ ç¤ºä¾‹ï¼š
  ```python
  # âœ… æ­£ç¡®ï¼šAPIè¿”å›å¸¦æ—¶åŒºçš„UTC
  return {"created_at": format_iso_utc(chat.created_at)}  # è¿”å› "2024-12-28T10:30:00Z"
  
  # âŒ é”™è¯¯ï¼šä¸è¦ä¾èµ–naiveå…œåº•
  naive_time = datetime(2024, 12, 28, 10, 30, 0)  # æ— æ—¶åŒº
  local_time = to_user_timezone(naive_time, LONDON)  # è™½ç„¶èƒ½è¿è¡Œï¼Œä½†æ–°ä»£ç ç¦æ­¢
  ```

**ç¤ºä¾‹**:
```python
# æ—§ä»£ç 
return {
    "created_at": chat.created_at.isoformat(),  # âŒ ç¦æ­¢
    # ...
}

# æ–°ä»£ç 
from app.utils.time_utils import format_iso_utc

return {
    "created_at": format_iso_utc(chat.created_at),  # âœ… ç»Ÿä¸€æ ¼å¼
    # ...
}
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

#### 1.1 æ—¶é—´å‡½æ•°æµ‹è¯•

```python
# tests/test_time_utils.py
import pytest
from datetime import datetime, timezone
from zoneinfo import ZoneInfo
from app.utils.time_utils import (
    get_utc_time,
    to_utc,
    to_user_timezone,
    format_iso_utc,
    handle_ambiguous_time
)

def test_get_utc_time():
    """æµ‹è¯•è·å–UTCæ—¶é—´"""
    utc_time = get_utc_time()
    assert utc_time.tzinfo == timezone.utc
    assert isinstance(utc_time, datetime)

def test_to_utc():
    """æµ‹è¯•è½¬æ¢ä¸ºUTC"""
    from app.utils.time_utils import to_utc, LONDON
    
    # æµ‹è¯•æ— æ—¶åŒºæ—¶é—´ - å¿…é¡»æ‹’ç»
    naive_dt = datetime(2024, 12, 28, 10, 30, 0)
    with pytest.raises(ValueError, match="Naive datetime is not allowed"):
        to_utc(naive_dt)
    
    # æµ‹è¯•å¸¦æ—¶åŒºæ—¶é—´ - åº”è¯¥æˆåŠŸ
    london_dt = datetime(2024, 12, 28, 10, 30, 0, tzinfo=LONDON)
    utc_dt = to_utc(london_dt)
    assert utc_dt.tzinfo == timezone.utc

def test_to_user_timezone():
    """æµ‹è¯•è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒº"""
    from app.utils.time_utils import to_user_timezone, LONDON
    
    utc_dt = datetime(2024, 12, 28, 10, 30, 0, tzinfo=timezone.utc)
    # âœ… ä½¿ç”¨ZoneInfoå¯¹è±¡ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
    london_dt = to_user_timezone(utc_dt, LONDON)
    assert london_dt.tzinfo == LONDON
    
    # âŒ æµ‹è¯•ï¼šä¸æ¥å—å­—ç¬¦ä¸²å‚æ•°
    with pytest.raises(TypeError):
        to_user_timezone(utc_dt, "Europe/London")  # åº”è¯¥å¤±è´¥

def test_format_iso_utc():
    """æµ‹è¯•ISOæ ¼å¼æ ¼å¼åŒ–"""
    from app.utils.time_utils import format_iso_utc
    
    utc_dt = datetime(2024, 12, 28, 10, 30, 0, tzinfo=timezone.utc)
    iso_str = format_iso_utc(utc_dt)
    assert iso_str.endswith('Z')
    assert 'T' in iso_str

def test_spring_forward_gap_roundtrip():
    """æµ‹è¯•æ˜¥å‰æ‹¨ï¼šæœ¬åœ°01:30ä¸å­˜åœ¨ â†’ å¿…é¡»æ˜¾å¼æ‹’ç»"""
    from app.utils.time_utils import parse_local_as_utc, detect_dst_transition_dates, LONDON
    
    # âœ… ä½¿ç”¨å‡½æ•°æ£€æµ‹DSTåˆ‡æ¢æ—¥æœŸï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 
    dst_dates = detect_dst_transition_dates(2025, LONDON)
    spring_date = dst_dates["spring_transition"]
    
    if spring_date is None:
        pytest.skip("æ— æ³•æ£€æµ‹åˆ°DSTåˆ‡æ¢æ—¥æœŸ")
    
    # è§£ææ—¥æœŸå¹¶æ„é€ ä¸å­˜åœ¨çš„æ—¶é—´
    year, month, day = map(int, spring_date.split('-'))
    naive = datetime(year, month, day, 1, 30, 0)  # ä¸å­˜åœ¨
    
    # çº¦å®šï¼šä¸æ¥å—è¿™ç±»è¾“å…¥ â†’ å¿…é¡»æ˜¾å¼æ‹’ç»
    with pytest.raises(ValueError, match="Invalid local time due to DST transition"):
        parse_local_as_utc(naive, LONDON)

def test_fall_back_ambiguous_fold():
    """æµ‹è¯•ç§‹å›æ‹¨ï¼šä¸¤ä¸ª01:30 â†’ ç”¨foldæ¶ˆæ­§"""
    from app.utils.time_utils import parse_local_as_utc, handle_ambiguous_time, detect_dst_transition_dates, LONDON
    
    # âœ… ä½¿ç”¨å‡½æ•°æ£€æµ‹DSTåˆ‡æ¢æ—¥æœŸï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 
    dst_dates = detect_dst_transition_dates(2025, LONDON)
    autumn_date = dst_dates["autumn_transition"]
    
    if autumn_date is None:
        pytest.skip("æ— æ³•æ£€æµ‹åˆ°DSTåˆ‡æ¢æ—¥æœŸ")
    
    # è§£ææ—¥æœŸå¹¶æ„é€ æ­§ä¹‰æ—¶é—´
    year, month, day = map(int, autumn_date.split('-'))
    naive = datetime(year, month, day, 1, 30, 0)
    
    # parse_local_as_utcé»˜è®¤ä½¿ç”¨laterï¼ˆfold=1ï¼‰
    utc1 = parse_local_as_utc(naive, LONDON)
    
    # handle_ambiguous_timeå¯ä»¥æ˜¾å¼é€‰æ‹©earlierï¼ˆfold=0ï¼‰
    utc2 = handle_ambiguous_time(naive, LONDON, disambiguation="earlier")
    
    # ä¸¤ä¸ªUTCæ—¶é—´åº”è¯¥ä¸åŒ
    assert utc1 != utc2
    assert utc1.tzinfo == timezone.utc
    assert utc2.tzinfo == timezone.utc

def test_to_utc_rejects_naive():
    """æµ‹è¯•to_utcæ‹’ç»naiveæ—¶é—´"""
    from app.utils.time_utils import to_utc
    
    naive = datetime(2024, 12, 28, 10, 30, 0)
    
    with pytest.raises(ValueError, match="Naive datetime is not allowed"):
        to_utc(naive)
```

### 2. é›†æˆæµ‹è¯•

#### 2.1 æ•°æ®åº“è¯»å†™æµ‹è¯•

```python
# tests/test_time_database.py
def test_create_user_with_utc_time():
    """æµ‹è¯•åˆ›å»ºç”¨æˆ·æ—¶ä½¿ç”¨UTCæ—¶é—´"""
    from app.utils.time_utils import get_utc_time
    from app.models import User
    
    user = User(
        id="12345678",
        name="test_user",
        email="test@example.com",
        hashed_password="hashed",
        created_at=get_utc_time()
    )
    db.add(user)
    db.commit()
    
    # éªŒè¯æ—¶é—´å­—æ®µå¸¦æ—¶åŒº
    assert user.created_at.tzinfo == timezone.utc

def test_time_query():
    """æµ‹è¯•æ—¶é—´æŸ¥è¯¢"""
    from app.utils.time_utils import get_utc_time
    from datetime import timedelta
    
    # æŸ¥è¯¢æœ€è¿‘1å°æ—¶åˆ›å»ºçš„ç”¨æˆ·
    cutoff_time = get_utc_time() - timedelta(hours=1)
    recent_users = db.query(User).filter(
        User.created_at >= cutoff_time
    ).all()
    
    # éªŒè¯æŸ¥è¯¢ç»“æœ
    for user in recent_users:
        assert user.created_at >= cutoff_time
```

### 3. å›å½’æµ‹è¯•

#### 3.1 åŠŸèƒ½å›å½’æµ‹è¯•

- [ ] ç”¨æˆ·æ³¨å†Œæ—¶é—´æ­£ç¡®
- [ ] ä»»åŠ¡åˆ›å»ºæ—¶é—´æ­£ç¡®
- [ ] ä»»åŠ¡æˆªæ­¢æ—¶é—´æ­£ç¡®
- [ ] å®¢æœå¯¹è¯è¶…æ—¶åˆ¤æ–­æ­£ç¡®
- [ ] æ¶ˆæ¯æ—¶é—´æˆ³æ­£ç¡®
- [ ] é€šçŸ¥æ—¶é—´æ­£ç¡®
- [ ] æ—¶é—´æŸ¥è¯¢æ­£ç¡®
- [ ] DSTåˆ‡æ¢æ—¥æœŸæ•°æ®æ­£ç¡®

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

### 1. æ•°æ®åº“å›æ»šè„šæœ¬

```sql
-- å›æ»šCustomerServiceChatè¡¨
-- æ³¨æ„ï¼šåªæœ‰åœ¨è¿ç§»å¤±è´¥æ—¶æ‰æ‰§è¡Œæ­¤è„šæœ¬

-- æ­¥éª¤1: æ¢å¤å¤‡ä»½æ•°æ®
DROP TABLE IF EXISTS customer_service_chats;
CREATE TABLE customer_service_chats AS 
SELECT * FROM customer_service_chats_backup;

-- æ­¥éª¤2: æ¢å¤ç´¢å¼•å’Œçº¦æŸ
-- ï¼ˆæ ¹æ®è¿ç§»å‰å¯¼å‡ºçš„ä¾èµ–å…³ç³»é‡å»ºï¼‰
-- ç¤ºä¾‹ï¼š
CREATE INDEX IF NOT EXISTS ix_customer_service_chats_created_at 
ON customer_service_chats(created_at);
-- ... å…¶ä»–ç´¢å¼•å’Œçº¦æŸ
```

### 1.1 å¤‡ä»½è¡¨è‡ªåŠ¨æ¸…ç†è„šæœ¬

**âš ï¸ é‡è¦**: å¤‡ä»½è¡¨åº”åœ¨è¿ç§»ä¸Šçº¿åä¸€å‘¨å†…åˆ é™¤ï¼Œé˜²æ­¢é•¿æœŸé—ç•™å ç”¨ç©ºé—´ã€‚

```python
# cleanup_backup_tables.py
"""
æ¸…ç†æ—¶é—´è¿ç§»äº§ç”Ÿçš„å¤‡ä»½è¡¨
ä¸Šçº¿åä¸€å‘¨å†…æ‰§è¡Œï¼Œéœ€è¦äºŒæ¬¡ç¡®è®¤

âš ï¸ æ‰§è¡Œå‰è¯·ç¡®ä¿ï¼š
1. è¿ç§»å·²æˆåŠŸä¸Šçº¿è‡³å°‘3å¤©
2. ç”Ÿäº§ç¯å¢ƒæ•°æ®éªŒè¯é€šè¿‡
3. æ— å›æ»šéœ€æ±‚
"""
from sqlalchemy import create_engine, text
from datetime import datetime, timedelta
import os

DATABASE_URL = os.getenv("DATABASE_URL")
engine = create_engine(DATABASE_URL)
db = engine.connect()

# æŸ¥æ‰¾æ‰€æœ‰å¤‡ä»½è¡¨ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯ï¼‰
backup_tables_info = db.execute(text("""
    SELECT 
        t.tablename,
        pg_size_pretty(pg_total_relation_size(quote_ident(t.tablename)::regclass)) as size,
        pg_total_relation_size(quote_ident(t.tablename)::regclass) as size_bytes,
        (SELECT COUNT(*) FROM information_schema.tables WHERE table_name = t.tablename) as exists_check
    FROM pg_tables t
    WHERE t.tablename LIKE '%_backup'
    AND t.schemaname = 'public'
    ORDER BY pg_total_relation_size(quote_ident(t.tablename)::regclass) DESC
""")).fetchall()

if not backup_tables_info:
    print("âœ… æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½è¡¨")
    exit(0)

# ç»Ÿè®¡æ€»å¤§å°
total_size_bytes = sum(row.size_bytes for row in backup_tables_info)
total_size_pretty = db.execute(text(f"SELECT pg_size_pretty({total_size_bytes})")).scalar()

print("âš ï¸ æ‰¾åˆ°ä»¥ä¸‹å¤‡ä»½è¡¨ï¼ˆå«ç»Ÿè®¡ä¿¡æ¯ï¼‰:")
print(f"{'è¡¨å':<40} {'å¤§å°':<15} {'è¡Œæ•°ï¼ˆä¼°ç®—ï¼‰':<15}")
print("-" * 70)

for row in backup_tables_info:
    # è·å–è¡Œæ•°ï¼ˆä¼°ç®—ï¼‰
    try:
        row_count = db.execute(text(f"SELECT COUNT(*) FROM {row.tablename}")).scalar()
    except:
        row_count = "N/A"
    
    print(f"{row.tablename:<40} {row.size:<15} {row_count:<15}")

print("-" * 70)
print(f"æ€»è®¡: {len(backup_tables_info)} å¼ è¡¨ï¼Œé¢„è®¡é‡Šæ”¾ç©ºé—´: {total_size_pretty} ({total_size_bytes:,} å­—èŠ‚)")

print("\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤å¤‡ä»½è¡¨åæ— æ³•å›æ»šæ•°æ®è¿ç§»")
print("âš ï¸ è¯·ç¡®è®¤è¿ç§»å·²æˆåŠŸä¸Šçº¿è‡³å°‘3å¤©ï¼Œä¸”ç”Ÿäº§ç¯å¢ƒæ•°æ®éªŒè¯é€šè¿‡")
print(f"âš ï¸ é¢„è®¡é‡Šæ”¾ç©ºé—´: {total_size_pretty} ({total_size_bytes:,} å­—èŠ‚)")

# ç¬¬ä¸€æ¬¡ç¡®è®¤
response1 = input("\nç¬¬ä¸€æ¬¡ç¡®è®¤ï¼šæ˜¯å¦å·²ç¡®è®¤è¿ç§»æˆåŠŸï¼Ÿ(yes/no): ")
if response1.lower() != 'yes':
    print("å·²å–æ¶ˆï¼šè¯·å…ˆç¡®è®¤è¿ç§»æˆåŠŸ")
    exit(0)

# ç¬¬äºŒæ¬¡ç¡®è®¤ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰
response2 = input("ç¬¬äºŒæ¬¡ç¡®è®¤ï¼šç¡®è®¤åˆ é™¤æ‰€æœ‰å¤‡ä»½è¡¨ï¼Ÿ(yes/no): ")
if response2.lower() != 'yes':
    print("å·²å–æ¶ˆ")
    exit(0)

# åˆ é™¤å¤‡ä»½è¡¨
print("\nå¼€å§‹åˆ é™¤å¤‡ä»½è¡¨...")
deleted_count = 0
deleted_size_bytes = 0

for row in backup_tables_info:
    try:
        db.execute(text(f"DROP TABLE IF EXISTS {row.tablename} CASCADE"))
        deleted_count += 1
        deleted_size_bytes += row.size_bytes
        print(f"âœ… å·²åˆ é™¤: {row.tablename} (é‡Šæ”¾ {row.size})")
    except Exception as e:
        print(f"âŒ åˆ é™¤å¤±è´¥ {row.tablename}: {e}")

deleted_size_pretty = db.execute(text(f"SELECT pg_size_pretty({deleted_size_bytes})")).scalar()
print(f"\nâœ… æˆåŠŸåˆ é™¤ {deleted_count}/{len(backup_tables_info)} å¼ å¤‡ä»½è¡¨")
print(f"âœ… å®é™…é‡Šæ”¾ç©ºé—´: {deleted_size_pretty} ({deleted_size_bytes:,} å­—èŠ‚)")

db.commit()
db.close()
print("\nâœ… å¤‡ä»½è¡¨æ¸…ç†å®Œæˆ")
```

### 2. ä»£ç å›æ»š

å¦‚æœä»£ç è¿ç§»å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. **å›æ»šGitæäº¤**:
   ```bash
   git revert <commit-hash>
   ```

2. **æ¢å¤æ—§å‡½æ•°**:
   - ä¸´æ—¶æ¢å¤ `get_uk_time()` çš„ä½¿ç”¨
   - é€æ­¥ä¿®å¤é—®é¢˜

### 3. å›æ»šæ£€æŸ¥æ¸…å•

- [ ] æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- [ ] åŠŸèƒ½æ­£å¸¸æ€§æ£€æŸ¥
- [ ] æ€§èƒ½æ£€æŸ¥
- [ ] é”™è¯¯æ—¥å¿—æ£€æŸ¥

---

## âœ… éªŒæ”¶æ ‡å‡†

### 1. ä»£ç éªŒæ”¶

- [ ] æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ `DateTime(timezone=True)`
- [ ] æ‰€æœ‰æ—¶é—´ç”Ÿæˆä½¿ç”¨ `get_utc_time()`
- [ ] æ—  `datetime.utcnow()` ç›´æ¥ä½¿ç”¨
- [ ] æ—  `pytz` ç›´æ¥ä½¿ç”¨ï¼ˆé™¤è¿ç§»è„šæœ¬ï¼‰
- [ ] æ‰€æœ‰APIè¿”å›ISO-8601 + Zæ ¼å¼

### 2. æ•°æ®åº“éªŒæ”¶

- [ ] æ‰€æœ‰æ—¶é—´å­—æ®µç±»å‹ä¸º `TIMESTAMPTZ`
- [ ] æ•°æ®è½¬æ¢æ­£ç¡®ï¼ˆæŠ½æ ·æ£€æŸ¥ï¼‰
- [ ] DSTåˆ‡æ¢æ—¥æœŸæ•°æ®æ­£ç¡®
- [ ] æ—¶é—´æŸ¥è¯¢æ€§èƒ½æ­£å¸¸

### 3. åŠŸèƒ½éªŒæ”¶

- [ ] æ—¶é—´æ˜¾ç¤ºæ­£ç¡®
- [ ] æ—¶é—´è®¡ç®—æ­£ç¡®
- [ ] è¶…æ—¶åˆ¤æ–­æ­£ç¡®
- [ ] DSTåˆ‡æ¢å¤„ç†æ­£ç¡®

### 4. æ€§èƒ½éªŒæ”¶

- [ ] æ—¶é—´æŸ¥è¯¢æ€§èƒ½æ— ä¸‹é™
- [ ] APIå“åº”æ—¶é—´æ­£å¸¸
- [ ] æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æ­£å¸¸

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

### è¿ç§»è¿›åº¦è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ | å¤‡æ³¨ |
|------|------|------|----------|------|
| é˜¶æ®µ1 | åˆ›å»ºæ—¶é—´å·¥å…·æ¨¡å— | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ1 | ä»£ç å®¡è®¡ | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ1 | å¤‡ä»½æ•°æ® | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ2 | æ•°æ®åº“è¿ç§»è„šæœ¬ | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ2 | æµ‹è¯•ç¯å¢ƒè¿ç§» | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ2 | ç”Ÿäº§ç¯å¢ƒè¿ç§» | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ3 | æ¨¡å‹è¿ç§» | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ3 | å‡½æ•°è°ƒç”¨è¿ç§» | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ3 | æ—¶åŒºåº“è¿ç§» | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ3 | APIæ ¼å¼ç»Ÿä¸€ | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ4 | å•å…ƒæµ‹è¯• | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ4 | é›†æˆæµ‹è¯• | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ4 | å›å½’æµ‹è¯• | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ5 | ä¸Šçº¿éƒ¨ç½² | â¬œ å¾…å¼€å§‹ | - | - |
| é˜¶æ®µ5 | ç”Ÿäº§éªŒè¯ | â¬œ å¾…å¼€å§‹ | - | - |

---

## ğŸ” å¿«é€Ÿè‡ªæ£€æ¸…å•ï¼ˆCIæ£€æŸ¥ï¼‰

### ç¦æ­¢é¡¹æ£€æŸ¥

#### 1. ç¦æ­¢ naive UTC (`datetime.utcnow`)

```bash
# æœŸæœ›ï¼š0å¤„ï¼ˆè¿ç§»è„šæœ¬ç›®å½•ä¾‹å¤–ï¼‰
grep -R "datetime\.utcnow" backend/ --exclude-dir=migrations
```

**å”¯ä¸€æ¥æº**: `get_utc_time()` å‡½æ•°

#### 2. ç¦æ­¢ pytz

```bash
# æœŸæœ›ï¼š0å¤„ï¼ˆè¿ç§»è„šæœ¬ç›®å½•ä¾‹å¤–ï¼‰
grep -R "import pytz\|pytz\.timezone" backend/ --exclude-dir=migrations
```

**å”¯ä¸€æ¥æº**: `zoneinfo.ZoneInfo`

#### 3. ç¦æ­¢ naive æ—¶é—´è‡ªåŠ¨å½“ UTC

```bash
# æ£€æŸ¥ to_utc() å‡½æ•°ï¼šä¸å…è®¸è‡ªåŠ¨å‡è®¾naiveä¸ºUTC
grep -A 5 "def to_utc" backend/app/utils/time_utils.py
# åº”çœ‹åˆ°ï¼šif dt.tzinfo is None: raise ValueError
```

**å…è®¸**: ä»…åœ¨ `format_iso_utc()` çš„å…œåº•é€»è¾‘ä¸­å…è®¸ï¼ˆå·²æ˜ç¡®æ ‡æ³¨ï¼‰

#### 4. ç¦æ­¢æ— æ—¶åŒº DateTime

```bash
# æœŸæœ›ï¼š0å¤„
grep -R "Column(DateTime\(" backend/app/models.py | grep -v "timezone=True"
```

**è¦æ±‚**: æ‰€æœ‰æ—¶é—´åˆ—å¿…é¡»ä¸º `DateTime(timezone=True)`

#### 5. ç¦æ­¢å¼ƒç”¨å‡½æ•°

```bash
# æœŸæœ›ï¼š0å¤„ï¼ˆget_uk_time å’Œ get_uk_time_naive åº”å·²åˆ é™¤ï¼‰
grep -R "get_uk_time\|get_uk_time_naive" backend/ --exclude-dir=migrations
```

#### 6. APIç¦æ­¢ç›´æ¥ä½¿ç”¨ `.isoformat()`

```bash
# æ£€æŸ¥APIè¿”å›æ ¼å¼ï¼ˆæ‰©å¤§åˆ°æ•´ä¸ªbackendç›®å½•ï¼Œé˜²æ­¢serviceå±‚ä¹Ÿæ‹¼JSONè¿”å›ï¼‰
grep -R "\.isoformat()" backend/ | grep -v "time_utils.py"
# æœŸæœ›ï¼š0å¤„ï¼ˆåº”ç»Ÿä¸€ä½¿ç”¨ format_iso_utc()ï¼‰
# æ’é™¤ time_utils.pyï¼ˆformat_iso_utc() å†…éƒ¨å®ç°å…è®¸ä½¿ç”¨ï¼‰
```

**è¦æ±‚**: æ‰€æœ‰APIè¿”å›æ—¶é—´å¿…é¡»ä½¿ç”¨ `format_iso_utc()`ï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ `.isoformat()`

#### 7. SQLè¿ç§»è„šæœ¬ï¼šå›å¡«é»˜è®¤å€¼å¿…é¡»ä¿æŒ TIMESTAMPTZ è¯­ä¹‰

```bash
# æ£€æŸ¥è¿ç§»è„šæœ¬ä¸­çš„å›å¡«è¯­å¥
grep -R "AT TIME ZONE 'UTC'" backend/migrations/*.sql backend/migrate_*.py
# æœŸæœ›ï¼š0å¤„ï¼ˆå›å¡«NULLå€¼å¿…é¡»ä½¿ç”¨ NOW()ï¼Œä¸è¦ AT TIME ZONE 'UTC'ï¼‰

# âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
# UPDATE table SET col_utc = COALESCE(col_utc, NOW()) WHERE col_utc IS NULL;

# âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå˜æˆnaiveï¼‰ï¼š
# UPDATE table SET col_utc = COALESCE(col_utc, NOW() AT TIME ZONE 'UTC') WHERE col_utc IS NULL;
```

**SQL Lintè§„åˆ™**:
- âœ… å›å¡«TIMESTAMPTZåˆ—æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ `NOW()`ï¼ˆTIMESTAMPTZç±»å‹ï¼‰
- âŒ ç¦æ­¢ä½¿ç”¨ `NOW() AT TIME ZONE 'UTC'`ï¼ˆä¼šå˜æˆnaive timestampï¼‰
- âš ï¸ åŸå› ï¼š`AT TIME ZONE 'UTC'` ä¼šå°†TIMESTAMPTZè½¬æ¢ä¸ºnaive timestampï¼Œèµ‹å€¼ç»™TIMESTAMPTZåˆ—æ—¶ä¼šæŒ‰ä¼šè¯æ—¶åŒºå†è§£é‡Šï¼Œå¯èƒ½å¯¼è‡´åç§»

#### 8. æ—¶åŒºè½¬æ¢å‡½æ•°å‚æ•°ç±»å‹æ£€æŸ¥

```bash
# æ£€æŸ¥ to_user_timezone è°ƒç”¨ï¼šå¿…é¡»ä½¿ç”¨ ZoneInfo å¯¹è±¡ï¼Œä¸èƒ½æ˜¯å­—ç¬¦ä¸²
grep -R "to_user_timezone.*[\"']" backend/
# æœŸæœ›ï¼š0å¤„ï¼ˆå‚æ•°å¿…é¡»æ˜¯ ZoneInfo å¯¹è±¡ï¼‰

# âœ… æ­£ç¡®ï¼š
# to_user_timezone(dt, LONDON)
# to_user_timezone(dt, ZoneInfo("Europe/London"))

# âŒ é”™è¯¯ï¼š
# to_user_timezone(dt, "Europe/London")  # TypeError
```

### è¦æ±‚é¡¹æ£€æŸ¥

#### 1. æ‰€æœ‰æ—¶é—´åˆ—å¿…é¡» `timezone=True`

```bash
# æ£€æŸ¥æ‰€æœ‰æ—¶é—´å­—æ®µ
grep -R "DateTime(timezone=True)" backend/app/models.py | wc -l
# åº”è¦†ç›–æ‰€æœ‰æ—¶é—´å­—æ®µ
```

#### 2. æ‰€æœ‰æ—¶é—´å‡½æ•°ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`

```bash
# æ£€æŸ¥ä½¿ç”¨æƒ…å†µ
grep -R "get_utc_time()" backend/ | wc -l
# åº”è¦†ç›–æ‰€æœ‰æ—¶é—´ç”Ÿæˆè°ƒç”¨
```

#### 3. æ‰€æœ‰APIè¿”å›ISO-8601 UTCæ ¼å¼ï¼ˆä½¿ç”¨format_iso_utcï¼‰

```bash
# æ£€æŸ¥APIè¿”å›æ ¼å¼
grep -R "format_iso_utc" backend/app/routers.py | wc -l
# åº”è¦†ç›–æ‰€æœ‰æ—¶é—´è¿”å›
```

### è¿ç§»è„šæœ¬æ£€æŸ¥

#### 1. æ£€æŸ¥æ¯è¡¨äº‹åŠ¡

```bash
# æ£€æŸ¥è¿ç§»è„šæœ¬æ˜¯å¦æ¯è¡¨ç‹¬ç«‹äº‹åŠ¡
grep -A 10 "def migrate_table" backend/migrate_all_time_fields.py
# åº”çœ‹åˆ°ï¼štrans = db.begin() å’Œ trans.commit()/rollback()
```

#### 2. æ£€æŸ¥ç´¢å¼•é‡å»ºé€»è¾‘ï¼ˆépassï¼‰

```bash
# æ£€æŸ¥è¿ç§»è„šæœ¬æ˜¯å¦å®ç°äº†ç´¢å¼•é‡å»º
grep -A 20 "é‡å»ºç´¢å¼•å’Œçº¦æŸ" backend/migrate_all_time_fields.py
# åº”çœ‹åˆ°å®é™…çš„ç´¢å¼•é‡å»ºä»£ç ï¼Œä¸æ˜¯pass
```

#### 3. æ£€æŸ¥å›æ»šè„šæœ¬

```bash
# æ£€æŸ¥å›æ»šè„šæœ¬æ˜¯å¦å­˜åœ¨
ls backend/migrations/rollback_*.sql
# åº”å­˜åœ¨å›æ»šè„šæœ¬
```

#### 4. æ£€æŸ¥å¤‡ä»½è¡¨æ¸…ç†è®¡åˆ’

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰å¤‡ä»½è¡¨æ¸…ç†è®¡åˆ’å’Œæ¸…ç†è„šæœ¬
grep -R "_backup.*æ¸…ç†\|backup.*cleanup\|cleanup_backup_tables" backend/
# åº”æ ‡æ³¨ï¼šä¸Šçº¿åä¸€å‘¨å†…åˆ é™¤ï¼Œå¹¶æœ‰æ¸…ç†è„šæœ¬ï¼ˆå¸¦äºŒæ¬¡ç¡®è®¤ï¼‰
ls backend/cleanup_backup_tables.py
# åº”å­˜åœ¨æ¸…ç†è„šæœ¬
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Python zoneinfoæ–‡æ¡£](https://docs.python.org/3/library/zoneinfo.html)
- [PostgreSQL TIMESTAMPTZæ–‡æ¡£](https://www.postgresql.org/docs/current/datatype-datetime.html)
- [ISO-8601æ ‡å‡†](https://en.wikipedia.org/wiki/ISO_8601)
- [è‹±å›½DSTè§„åˆ™](https://www.gov.uk/when-do-the-clocks-change)

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `å®¢æœåŠŸèƒ½ä¼˜åŒ–æ—¥å¿—å¯è¡Œæ€§è¯„ä¼°.md` - å¯è¡Œæ€§è¯„ä¼°
- `å®¢æœåŠŸèƒ½ä¼˜åŒ–æ—¥å¿—.md` - å®¢æœåŠŸèƒ½ä¼˜åŒ–æ–‡æ¡£
- `backend/app/models.py` - æ•°æ®åº“æ¨¡å‹å®šä¹‰
- `backend/app/utils/time_utils.py` - æ—¶é—´å·¥å…·æ¨¡å—ï¼ˆæ–°å»ºï¼‰

---

**æœ€åæ›´æ–°**: 2024-12-28  
**æ–‡æ¡£çŠ¶æ€**: ğŸ“‹ å¾…å®æ–½  
**é¢„è®¡å®Œæˆæ—¶é—´**: 2025-01-15

