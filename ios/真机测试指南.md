# iOS 真机测试指南

## ⚠️ iOS 18 兼容性说明

如果你的设备是 iOS 18，需要确保：

1. **Xcode 版本要求**
   - 需要 Xcode 15.0 或更高版本
   - 推荐使用 Xcode 16.0+（支持 iOS 18）
   - 检查版本：`xcodebuild -version`

2. **如果 Xcode 版本太旧**
   - 更新 Xcode：App Store → 更新
   - 或从 [Apple Developer](https://developer.apple.com/xcode/) 下载最新版本

3. **部署目标已设置**
   - 项目已设置为 iOS 16.0
   - 可以在 iOS 16.0 - iOS 18+ 的设备上运行

## 📱 准备工作

### 1. 开发者账号和证书

1. **Apple Developer 账号**
   - 免费账号：可以在自己的设备上测试（7天有效期）
   - 付费账号（$99/年）：可以长期测试，支持 App Store 发布

2. **在 Xcode 中配置**
   - 打开项目
   - 选择项目 → Signing & Capabilities
   - 选择你的 Team（如果没有，点击 "Add Account" 添加 Apple ID）
   - Xcode 会自动管理证书和配置文件

### 2. 连接设备

1. **USB 连接**
   - 使用 USB 线连接 iPhone/iPad 到 Mac
   - 在设备上信任此电脑（首次连接时）

2. **无线连接**（可选）
   - 设备与 Mac 在同一 Wi-Fi 网络
   - Xcode → Window → Devices and Simulators
   - 选择设备，勾选 "Connect via network"

## 🔧 配置后端地址

### 方法1：使用生产环境（最简单）

当前配置已经设置为生产环境地址 `https://api.link2ur.com`，可以直接使用。

### 方法2：使用本地开发服务器

如果后端在本地运行，需要：

1. **获取 Mac 的 IP 地址**
   ```bash
   # 在终端运行
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```
   或者：
   - 系统设置 → 网络 → 查看 IP 地址

2. **修改 `Constants.swift`**
   ```swift
   #if DEBUG
   static let baseURL = "http://你的IP地址:8000"
   static let wsURL = "ws://你的IP地址:8000"
   #endif
   ```
   例如：`http://192.168.1.100:8000`

3. **确保防火墙允许连接**
   - 系统设置 → 网络 → 防火墙
   - 允许 Xcode 和 Python（如果运行本地后端）通过防火墙

## 🚀 运行到真机

### 步骤

1. **选择设备**
   - 在 Xcode 顶部工具栏，点击设备选择器
   - 选择你的 iPhone/iPad（不是模拟器）

2. **配置签名**
   - 如果出现签名错误：
     - 选择项目 → Signing & Capabilities
     - 选择正确的 Team
     - Bundle Identifier 确保唯一（可以添加后缀，如 `com.link2ur.ios`）

3. **运行项目**
   - 点击运行按钮（⌘R）或点击 Play 按钮
   - 首次运行可能需要在设备上信任开发者：
     - 设置 → 通用 → VPN与设备管理
     - 信任你的开发者证书

4. **查看日志**
   - 在 Xcode 底部控制台查看日志
   - 检查网络请求是否成功

## 🔍 调试技巧

### 1. 查看网络请求

在 `APIService.swift` 中添加日志：

```swift
print("Request URL: \(url)")
print("Request Body: \(body ?? [:])")
```

### 2. 检查连接

在应用启动时测试连接：

```swift
// 在 AppState 或 ContentView 中添加
func testConnection() {
    let url = URL(string: "\(Constants.API.baseURL)/api/health")!
    URLSession.shared.dataTask(with: url) { data, response, error in
        if let error = error {
            print("连接失败: \(error)")
        } else {
            print("连接成功!")
        }
    }.resume()
}
```

### 3. 常见问题

**问题1：无法连接到后端**
- 检查设备网络连接
- 确认后端地址正确
- 检查防火墙设置
- 查看 Xcode 控制台错误信息

**问题2：证书错误**
- 重新选择 Team
- 清理构建（Product → Clean Build Folder）
- 删除设备上的旧应用，重新安装

**问题3：网络请求失败**
- 检查后端是否运行
- 确认 API 地址可访问（在 Safari 中打开测试）
- 查看后端日志

## 📝 测试清单

- [ ] 设备已连接并信任
- [ ] Xcode 中选择了正确的设备
- [ ] 签名配置正确
- [ ] 后端地址配置正确
- [ ] 网络连接正常
- [ ] 可以成功登录
- [ ] API 请求正常返回数据

## 🌐 网络配置说明

### 生产环境（当前配置）
- API: `https://api.link2ur.com`
- WebSocket: `wss://api.link2ur.com`
- ✅ 真机和模拟器都可以使用
- ✅ 不需要额外配置

### 本地开发环境
- API: `http://你的Mac IP:8000`
- WebSocket: `ws://你的Mac IP:8000`
- ⚠️ 需要设备和 Mac 在同一网络
- ⚠️ 需要本地后端运行

## 💡 推荐配置

**开发阶段**：
- 使用生产环境地址（最简单，无需配置）
- 或使用本地服务器（需要配置 IP）

**发布前**：
- 确保使用生产环境地址
- 测试所有功能

