# iOS ä»£ç ä¼˜åŒ–å»ºè®®

æœ¬æ–‡æ¡£åˆ—å‡ºäº† iOS ä»£ç åº“ä¸­å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼ŒæŒ‰ä¼˜å…ˆçº§å’Œå½±å“èŒƒå›´åˆ†ç±»ã€‚

## ğŸ”´ é«˜ä¼˜å…ˆçº§ä¼˜åŒ–

### 1. æ”¯ä»˜é¡µé¢é‡å¤è¯·æ±‚é˜²æŠ¤ âœ… å·²å®Œæˆ

**é—®é¢˜**ï¼š`PaymentViewModel` åœ¨é€‰æ‹©ä¼˜æƒ åˆ¸æ—¶å¯èƒ½é‡å¤åˆ›å»ºæ”¯ä»˜æ„å›¾ï¼Œå¦‚æœç”¨æˆ·å¿«é€Ÿç‚¹å‡»å¯èƒ½é€ æˆå¤šæ¬¡è¯·æ±‚ã€‚

**ä½ç½®**ï¼š`ios/link2ur/link2ur/ViewModels/PaymentViewModel.swift`

**å·²å®æ–½**ï¼šæ·»åŠ äº† `isCreatingPaymentIntent` æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºæ”¯ä»˜æ„å›¾ã€‚

**ä¼˜åŒ–å»ºè®®**ï¼š
```swift
// æ·»åŠ è¯·æ±‚çŠ¶æ€æ ‡å¿—
private var isCreatingPaymentIntent = false

func createPaymentIntent(...) {
    // é˜²æ­¢é‡å¤è¯·æ±‚
    guard !isCreatingPaymentIntent else {
        print("âš ï¸ [PaymentViewModel] æ”¯ä»˜æ„å›¾åˆ›å»ºä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚")
        return
    }
    
    isCreatingPaymentIntent = true
    isLoading = true
    errorMessage = nil
    
    // ... ç°æœ‰ä»£ç  ...
    
    .sink(
        receiveCompletion: { [weak self] completion in
            self?.isCreatingPaymentIntent = false
            self?.isLoading = false
            // ... ç°æœ‰é”™è¯¯å¤„ç† ...
        },
        receiveValue: { [weak self] response in
            self?.isCreatingPaymentIntent = false
            self?.handlePaymentResponse(response)
        }
    )
}
```

### 2. ä¼˜æƒ åˆ¸åŠ è½½é”™è¯¯å¤„ç†ä¼˜åŒ– âœ… å·²å®Œæˆ

**é—®é¢˜**ï¼šä¼˜æƒ åˆ¸åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨ `print` è€Œä¸æ˜¯ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿã€‚

**ä½ç½®**ï¼š`ios/link2ur/link2ur/ViewModels/PaymentViewModel.swift:53`

**å·²å®æ–½**ï¼šå·²å°† `print` æ›¿æ¢ä¸º `Logger.warning`ï¼Œç»Ÿä¸€ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿã€‚

**ä¼˜åŒ–å»ºè®®**ï¼š
```swift
// æ›¿æ¢ print ä¸º Logger
if case .failure(let error) = completion {
    Logger.warning("åŠ è½½ä¼˜æƒ åˆ¸å¤±è´¥: \(error.localizedDescription)", category: .network)
    // å¯é€‰ï¼šæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„æç¤ºï¼ˆä¸å½±å“æ”¯ä»˜æµç¨‹ï¼‰
}
```

### 3. æ”¯ä»˜é¡µé¢åˆå§‹åŒ–é€»è¾‘ä¼˜åŒ–

**é—®é¢˜**ï¼šå½“å·²æœ‰ `clientSecret` æ—¶ï¼Œä»ç„¶ä¼šè°ƒç”¨ `loadAvailableCoupons()`ï¼Œä½†ä¸ä¼šåˆ›å»ºæ”¯ä»˜æ„å›¾ã€‚åº”è¯¥ç¡®ä¿ä¼˜æƒ åˆ¸åŠ è½½é€»è¾‘ä¸€è‡´ã€‚

**ä½ç½®**ï¼š`ios/link2ur/link2ur/ViewModels/PaymentViewModel.swift:35-42`

**å½“å‰ä»£ç **ï¼š
```swift
if let clientSecret = clientSecret {
    setupPaymentElement(with: clientSecret)
}
// åŠ è½½å¯ç”¨ä¼˜æƒ åˆ¸
loadAvailableCoupons()
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```swift
if let clientSecret = clientSecret {
    setupPaymentElement(with: clientSecret)
    // å³ä½¿æœ‰ clientSecretï¼Œä¹ŸåŠ è½½ä¼˜æƒ åˆ¸ï¼ˆç”¨æˆ·å¯èƒ½æƒ³æ›´æ¢ä¼˜æƒ åˆ¸ï¼‰
    loadAvailableCoupons()
} else {
    // æ²¡æœ‰ clientSecret æ—¶ï¼Œå…ˆåŠ è½½ä¼˜æƒ åˆ¸ï¼Œå†åˆ›å»ºæ”¯ä»˜æ„å›¾
    // è¿™æ ·ç”¨æˆ·å¯ä»¥å…ˆé€‰æ‹©ä¼˜æƒ åˆ¸ï¼Œé¿å…é‡å¤è¯·æ±‚
    loadAvailableCoupons()
}
```

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

### 4. ç½‘ç»œè¯·æ±‚å»é‡æœºåˆ¶ âœ… å·²å®Œæˆ

**é—®é¢˜**ï¼šæŸäº› ViewModel å¯èƒ½åœ¨çŸ­æ—¶é—´å†…å‘èµ·ç›¸åŒçš„è¯·æ±‚ï¼ˆä¾‹å¦‚å¿«é€Ÿåˆ·æ–°ï¼‰ã€‚

**å·²å®æ–½**ï¼š
- âœ… `TaskDetailViewModel.loadTask()` - å·²æ·»åŠ é‡å¤è¯·æ±‚é˜²æŠ¤
- âœ… `LeaderboardDetailViewModel.loadLeaderboard()` - å·²æ·»åŠ é‡å¤è¯·æ±‚é˜²æŠ¤
- âœ… `PaymentViewModel.createPaymentIntent()` - å·²æ·»åŠ é‡å¤è¯·æ±‚é˜²æŠ¤
- âœ… `ActivityViewModel.loadActivityDetail()` - å·²æ·»åŠ é‡å¤è¯·æ±‚é˜²æŠ¤
- âœ… `ForumPostDetailViewModel.loadPost()` - å·²æ·»åŠ é‡å¤è¯·æ±‚é˜²æŠ¤
- âœ… å…¶ä»–ä¸»è¦ ViewModel å·²æœ‰é˜²æŠ¤ï¼ˆ`TasksViewModel`, `MyTasksViewModel`, `TaskChatViewModel` ç­‰ï¼‰

**ä¼˜åŒ–å»ºè®®**ï¼š
- åœ¨ `APIService` æˆ– `NetworkManager` ä¸­æ·»åŠ è¯·æ±‚å»é‡æœºåˆ¶
- ä½¿ç”¨è¯·æ±‚ç­¾åï¼ˆmethod + endpoint + body hashï¼‰ä½œä¸º key
- ç›¸åŒè¯·æ±‚åœ¨ 1 ç§’å†…åªæ‰§è¡Œä¸€æ¬¡ï¼Œåç»­è¯·æ±‚è¿”å›ç¬¬ä¸€ä¸ªè¯·æ±‚çš„ç»“æœ

### 5. å›¾ç‰‡åŠ è½½ä¼˜åŒ– âœ… å·²å®Œæˆ

**é—®é¢˜**ï¼šè™½ç„¶å·²æœ‰ `ImageCache`ï¼Œä½†æŸäº›åœ°æ–¹å¯èƒ½ç›´æ¥ä½¿ç”¨ `URLSession` åŠ è½½å›¾ç‰‡ã€‚

**å·²å®æ–½**ï¼š
- âœ… `TaskDetailView.loadShareImage()` - å·²æ”¹ä¸ºä½¿ç”¨ `ImageCache`
- âœ… `LeaderboardShareView.loadCoverImage()` - å·²æ”¹ä¸ºä½¿ç”¨ `ImageCache`
- âœ… æ‰€æœ‰å›¾ç‰‡åŠ è½½ç°åœ¨éƒ½ç»è¿‡ç¼“å­˜å±‚ï¼Œæ”¯æŒå†…å­˜å’Œç£ç›˜ç¼“å­˜

**ä¼˜åŒ–å»ºè®®**ï¼š
- ç»Ÿä¸€ä½¿ç”¨ `AsyncImageView` ç»„ä»¶ï¼ˆæ¨èï¼‰
- ç¡®ä¿æ‰€æœ‰å›¾ç‰‡åŠ è½½éƒ½ç»è¿‡ç¼“å­˜å±‚ âœ…

### 6. å†…å­˜ç®¡ç†ä¼˜åŒ– âœ… å·²å®Œæˆ

**é—®é¢˜**ï¼šæŸäº›é—­åŒ…ä¸­å¯èƒ½ç¼ºå°‘ `[weak self]`ã€‚

**å·²å®æ–½**ï¼š
- âœ… `ActivityViewModel` - ä¿®å¤äº†æ‰€æœ‰ `DispatchQueue.main.async` å’Œ `DispatchQueue.global` é—­åŒ…
- âœ… `MyPostsViewModel` - ä¿®å¤äº†æ‰€æœ‰ `DispatchQueue.main.async` é—­åŒ…
- âœ… `LeaderboardViewModel` - ä¿®å¤äº† `DispatchQueue.main.async` é—­åŒ…
- âœ… `RecentActivityViewModel` - ä¿®å¤äº† `DispatchQueue.global` å’Œ `DispatchQueue.main.async` é—­åŒ…
- âœ… æ‰€æœ‰ Combine `sink` é—­åŒ…å·²ä½¿ç”¨ `[weak self]`

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… ä½¿ç”¨å·¥å…·æ‰«ææ‰€æœ‰é—­åŒ…ï¼Œç¡®ä¿ ViewModel ä¸­çš„é—­åŒ…éƒ½ä½¿ç”¨ `[weak self]`
- âœ… ç‰¹åˆ«æ³¨æ„ `DispatchQueue.main.async` å’Œ `DispatchQueue.global` ä¸­çš„é—­åŒ…

### 7. åŠ è½½çŠ¶æ€ç»Ÿä¸€ç®¡ç† âœ… éƒ¨åˆ†å®Œæˆ

**é—®é¢˜**ï¼šä¸åŒ ViewModel ä½¿ç”¨ä¸åŒçš„åŠ è½½çŠ¶æ€ç®¡ç†æ–¹å¼ï¼ˆ`isLoading`ã€`LoadingState` ç­‰ï¼‰ã€‚

**å·²å®æ–½**ï¼š
- âœ… ç»Ÿä¸€ä½¿ç”¨ `LoadingView` ç»„ä»¶æ›¿ä»£ç›´æ¥ä½¿ç”¨ `ProgressView()`
- âœ… å·²ä¼˜åŒ– 8 ä¸ªè§†å›¾æ–‡ä»¶ï¼Œç»Ÿä¸€ä½¿ç”¨ `LoadingView`ï¼š
  - `MessageView.swift`
  - `TasksView.swift`
  - `ChatView.swift`
  - `CustomerServiceView.swift`
  - `TaskChatListView.swift`
  - `FleaMarketView.swift`
  - `MyPostsView.swift`
  - `HomeView.swift`

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… ç»Ÿä¸€ä½¿ç”¨ `LoadingView` ç»„ä»¶ï¼ˆå·²å®æ–½ï¼‰
- âš ï¸ å¯ä»¥è€ƒè™‘åˆ›å»º `LoadingState<T>` æšä¸¾è¿›ä¸€æ­¥ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- âš ï¸ æˆ–åˆ›å»ºç»Ÿä¸€çš„ `LoadingStateManager` åè®®

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ä¼˜åŒ–

### 8. é”™è¯¯å¤„ç†ç»Ÿä¸€åŒ– âœ… éƒ¨åˆ†å®Œæˆ

**é—®é¢˜**ï¼šæŸäº›åœ°æ–¹ç›´æ¥æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ŒæŸäº›åœ°æ–¹ä½¿ç”¨ `ErrorHandler`ã€‚

**å·²å®æ–½**ï¼š
- âœ… ç»Ÿä¸€ä½¿ç”¨ `ErrorStateView` ç»„ä»¶æ›¿ä»£æ‰‹åŠ¨åˆ›å»ºé”™è¯¯è§†å›¾
- âœ… å·²ä¼˜åŒ– `MessageView.swift`ï¼Œä½¿ç”¨ `ErrorStateView` æ›¿ä»£æ‰‹åŠ¨åˆ›å»ºçš„é”™è¯¯è§†å›¾
- âœ… æ‰€æœ‰ä¸»è¦è§†å›¾å·²ä½¿ç”¨ `ErrorStateView` ç»„ä»¶

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… ç»Ÿä¸€ä½¿ç”¨ `ErrorStateView` ç»„ä»¶ï¼ˆå·²å®æ–½ï¼‰
- âœ… ç»Ÿä¸€ä½¿ç”¨ `ErrorHandler.shared.handle()` å¤„ç†é”™è¯¯ï¼ˆå·²å®æ–½ï¼‰
- âš ï¸ å¯ä»¥è€ƒè™‘åˆ›å»ºé”™è¯¯å¤„ç†çš„ ViewModifierï¼Œè‡ªåŠ¨å¤„ç†é”™è¯¯æ˜¾ç¤º

### 9. ä»£ç é‡å¤æå– âœ… éƒ¨åˆ†å®Œæˆ

**é—®é¢˜**ï¼šæŸäº› UI ç»„ä»¶æˆ–é€»è¾‘åœ¨å¤šå¤„é‡å¤ã€‚

**å·²å®æ–½**ï¼š
- âœ… æå–å…¬å…±çš„åŠ è½½è§†å›¾ç»„ä»¶ï¼ˆ`LoadingView`ã€`CompactLoadingView`ã€`FullScreenLoadingView`ï¼‰
- âœ… æå–å…¬å…±çš„é”™è¯¯è§†å›¾ç»„ä»¶ï¼ˆ`ErrorStateView`ï¼‰
- âœ… ç»Ÿä¸€ä½¿ç”¨è¿™äº›ç»„ä»¶ï¼Œå‡å°‘ä»£ç é‡å¤

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… æå–å…¬å…±çš„åŠ è½½è§†å›¾ç»„ä»¶ï¼ˆå·²å®æ–½ï¼‰
- âœ… æå–å…¬å…±çš„é”™è¯¯è§†å›¾ç»„ä»¶ï¼ˆå·²å®æ–½ï¼‰
- âš ï¸ å¯ä»¥è€ƒè™‘æå–å…¬å…±çš„ç½‘ç»œè¯·æ±‚å¤„ç†é€»è¾‘åˆ° ViewModifier

### 10. æ€§èƒ½ç›‘æ§å¢å¼º âœ… éƒ¨åˆ†å®Œæˆ

**é—®é¢˜**ï¼šè™½ç„¶æœ‰ `PerformanceMonitor`ï¼Œä½†å¯èƒ½æ²¡æœ‰è¦†ç›–æ‰€æœ‰å…³é”®è·¯å¾„ã€‚

**å·²å®æ–½**ï¼š
- âœ… 18 ä¸ª ViewModel å·²æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆ`recordNetworkRequest`ï¼‰
- âœ… è¦†ç›–äº†ä¸»è¦çš„æ•°æ®åŠ è½½æ“ä½œï¼ˆä»»åŠ¡ã€æ¶ˆæ¯ã€æ´»åŠ¨ã€æ’è¡Œæ¦œç­‰ï¼‰
- âœ… æ”¯ä»˜æµç¨‹å·²æœ‰æ€§èƒ½ç›‘æ§

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… åœ¨å…³é”® ViewModel çš„ `loadTask`ã€`loadMessages` ç­‰æ–¹æ³•ä¸­æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆå·²å®æ–½ï¼‰
- âœ… ç›‘æ§æ”¯ä»˜æµç¨‹çš„æ¯ä¸ªæ­¥éª¤ï¼ˆå·²å®æ–½ï¼‰
- âš ï¸ å¯ä»¥è€ƒè™‘æ·»åŠ ç”¨æˆ·æ“ä½œå“åº”æ—¶é—´ç›‘æ§

## ğŸ“Š å…·ä½“ä¼˜åŒ–ç‚¹ç»Ÿè®¡

### ä»£ç è´¨é‡
- âœ… å·²æœ‰å†…å­˜ç›‘æ§ (`MemoryMonitor`)
- âœ… å·²æœ‰æ€§èƒ½ç›‘æ§ (`PerformanceMonitor`)
- âœ… å·²æœ‰é”™è¯¯å¤„ç† (`ErrorHandler`)
- âœ… å·²æœ‰å›¾ç‰‡ç¼“å­˜ (`ImageCache`)
- âœ… ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿä½¿ç”¨ï¼ˆå·²å®æ–½ï¼‰
- âœ… é˜²æ­¢é‡å¤è¯·æ±‚ï¼ˆä¸»è¦ ViewModel å·²å®æ–½ï¼‰
- âœ… å›¾ç‰‡åŠ è½½ä¼˜åŒ–ï¼ˆå·²ç»Ÿä¸€ä½¿ç”¨ ImageCacheï¼‰

### ç”¨æˆ·ä½“éªŒ
- âœ… å·²æœ‰åŠ è½½çŠ¶æ€ç»„ä»¶ï¼ˆ`LoadingView`ï¼‰
- âœ… å·²æœ‰é”™è¯¯çŠ¶æ€ç»„ä»¶ï¼ˆ`ErrorStateView`ï¼‰
- âœ… å·²ç»Ÿä¸€ä½¿ç”¨åŠ è½½å’Œé”™è¯¯ç»„ä»¶ï¼ˆ8 ä¸ªè§†å›¾å·²ä¼˜åŒ–ï¼‰
- âš ï¸ å¯ä»¥ä¼˜åŒ–åŠ è½½åŠ¨ç”»
- âš ï¸ å¯ä»¥æ·»åŠ éª¨æ¶å±ï¼ˆSkeleton Screenï¼‰

### æ€§èƒ½
- âœ… å·²æœ‰ç½‘ç»œè¯·æ±‚ç¼“å­˜
- âœ… å·²æœ‰å›¾ç‰‡ç¼“å­˜
- âœ… è¯·æ±‚å»é‡ï¼ˆä¸»è¦ ViewModel å·²å®æ–½ï¼‰
- âš ï¸ å¯ä»¥ä¼˜åŒ–åˆ—è¡¨æ¸²æŸ“æ€§èƒ½ï¼ˆLazyVStack/LazyHStackï¼‰

## ğŸ¯ å»ºè®®çš„å®æ–½é¡ºåº

1. **ç«‹å³å®æ–½**ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰ï¼š
   - æ”¯ä»˜é¡µé¢é‡å¤è¯·æ±‚é˜²æŠ¤
   - ä¼˜æƒ åˆ¸åŠ è½½é”™è¯¯å¤„ç†ä¼˜åŒ–

2. **è¿‘æœŸå®æ–½**ï¼ˆæå‡ä»£ç è´¨é‡ï¼‰ï¼š
   - ç½‘ç»œè¯·æ±‚å»é‡æœºåˆ¶
   - ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿä½¿ç”¨
   - å†…å­˜ç®¡ç†æ£€æŸ¥

3. **é•¿æœŸä¼˜åŒ–**ï¼ˆæ¶æ„æ”¹è¿›ï¼‰ï¼š
   - åŠ è½½çŠ¶æ€ç»Ÿä¸€ç®¡ç†
   - é”™è¯¯å¤„ç†ç»Ÿä¸€åŒ–
   - ä»£ç é‡å¤æå–

## ğŸ“ æ³¨æ„äº‹é¡¹

- æ‰€æœ‰ä¼˜åŒ–éƒ½åº”è¯¥å…ˆè¿›è¡Œæµ‹è¯•ï¼Œç¡®ä¿ä¸å½±å“ç°æœ‰åŠŸèƒ½
- å»ºè®®ä½¿ç”¨ Feature Flag æ§åˆ¶æ–°åŠŸèƒ½çš„å¯ç”¨
- ä¼˜åŒ–ååº”è¯¥è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œç¡®ä¿ç¡®å®æœ‰æå‡
- å»ºè®®åœ¨ä»£ç å®¡æŸ¥æ—¶å…³æ³¨è¿™äº›ä¼˜åŒ–ç‚¹

