# ä¼ä¸šçº§ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹

æœ¬æ–‡æ¡£æä¾›äº†ä¼ä¸šçº§ä¼˜åŒ–ç»„ä»¶çš„å®é™…ä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ã€‚

## ğŸ“š ç›®å½•

1. [ErrorHandler ä½¿ç”¨ç¤ºä¾‹](#errorhandler-ä½¿ç”¨ç¤ºä¾‹)
2. [DependencyContainer ä½¿ç”¨ç¤ºä¾‹](#dependencycontainer-ä½¿ç”¨ç¤ºä¾‹)
3. [PerformanceMonitor ä½¿ç”¨ç¤ºä¾‹](#performancemonitor-ä½¿ç”¨ç¤ºä¾‹)
4. [ValidationHelper ä½¿ç”¨ç¤ºä¾‹](#validationhelper-ä½¿ç”¨ç¤ºä¾‹)
5. [View+Extensions ä½¿ç”¨ç¤ºä¾‹](#viewextensions-ä½¿ç”¨ç¤ºä¾‹)
6. [LoadingState ä½¿ç”¨ç¤ºä¾‹](#loadingstate-ä½¿ç”¨ç¤ºä¾‹)
7. [PaginatedList ä½¿ç”¨ç¤ºä¾‹](#paginatedlist-ä½¿ç”¨ç¤ºä¾‹)

---

## ErrorHandler ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```swift
import Foundation
import Combine

class MyViewModel: ObservableObject {
    @Published var errorMessage: String?
    private let apiService: APIService
    
    func loadData() {
        apiService.request(User.self, "/api/users/me")
            .sink(receiveCompletion: { [weak self] completion in
                if case .failure(let error) = completion {
                    // ä½¿ç”¨ ErrorHandler ç»Ÿä¸€å¤„ç†é”™è¯¯
                    ErrorHandler.shared.handle(error, context: "åŠ è½½ç”¨æˆ·ä¿¡æ¯")
                    
                    // è·å–ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
                    if let apiError = error as? APIError {
                        self?.errorMessage = apiError.userFriendlyMessage
                    } else {
                        self?.errorMessage = error.localizedDescription
                    }
                }
            }, receiveValue: { user in
                // å¤„ç†æˆåŠŸå“åº”
                print("ç”¨æˆ·ä¿¡æ¯: \(user.name)")
            })
            .store(in: &cancellables)
    }
}
```

### åœ¨ View ä¸­ä½¿ç”¨

```swift
struct MyView: View {
    @StateObject private var viewModel = MyViewModel()
    @State private var error: Error?
    
    var body: some View {
        VStack {
            // å†…å®¹
        }
        .errorAlert(error: $error)
        .onReceive(ErrorHandler.shared.$currentError) { appError in
            if let appError = appError {
                error = appError.error
            }
        }
    }
}
```

---

## DependencyContainer ä½¿ç”¨ç¤ºä¾‹

### åœ¨ ViewModel ä¸­ä½¿ç”¨

```swift
class MyViewModel: ObservableObject {
    // ä½¿ç”¨ä¾èµ–æ³¨å…¥è·å–æœåŠ¡
    private let apiService: APIService
    private let locationService: LocationService
    
    // æ”¯æŒä¾èµ–æ³¨å…¥çš„åˆå§‹åŒ–æ–¹æ³•
    init(
        apiService: APIService? = nil,
        locationService: LocationService? = nil
    ) {
        // ä½¿ç”¨ä¾èµ–æ³¨å…¥æˆ–å›é€€åˆ°é»˜è®¤å®ç°
        self.apiService = apiService ?? APIService.shared
        self.locationService = locationService ?? LocationService.shared
    }
    
    func loadData() {
        // ä½¿ç”¨æœåŠ¡
        apiService.request(User.self, "/api/users/me")
            .sink(receiveValue: { user in
                // å¤„ç†å“åº”
            })
            .store(in: &cancellables)
    }
}
```

### åœ¨æµ‹è¯•ä¸­ä½¿ç”¨

```swift
import XCTest

class MyViewModelTests: XCTestCase {
    func testLoadData() {
        // åˆ›å»º Mock æœåŠ¡
        let mockAPIService = MockAPIService()
        let mockLocationService = MockLocationService()
        
        // ä½¿ç”¨ä¾èµ–æ³¨å…¥åˆ›å»º ViewModel
        let viewModel = MyViewModel(
            apiService: mockAPIService,
            locationService: mockLocationService
        )
        
        // æµ‹è¯•
        viewModel.loadData()
        
        // éªŒè¯
        XCTAssertNotNil(viewModel.data)
    }
}
```

---

## PerformanceMonitor ä½¿ç”¨ç¤ºä¾‹

### è‡ªåŠ¨ç›‘æ§ï¼ˆå·²åœ¨ APIService ä¸­é›†æˆï¼‰

æ‰€æœ‰é€šè¿‡ APIService çš„ç½‘ç»œè¯·æ±‚éƒ½ä¼šè‡ªåŠ¨è®°å½•æ€§èƒ½æŒ‡æ ‡ã€‚

### æ‰‹åŠ¨è®°å½•è§†å›¾åŠ è½½æ€§èƒ½

```swift
struct UserProfileView: View {
    @StateObject private var viewModel = UserProfileViewModel()
    @State private var loadStartTime: Date?
    
    var body: some View {
        VStack {
            // å†…å®¹
        }
        .onAppear {
            // è®°å½•å¼€å§‹æ—¶é—´
            loadStartTime = Date()
        }
        .onReceive(viewModel.$user) { user in
            // è§†å›¾åŠ è½½å®Œæˆï¼Œè®°å½•æ€§èƒ½
            if let startTime = loadStartTime, user != nil {
                let duration = Date().timeIntervalSince(startTime)
                PerformanceMonitor.shared.recordViewLoad(
                    viewName: "UserProfileView",
                    duration: duration
                )
            }
        }
    }
}
```

### ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

```swift
// è·å–æ€§èƒ½æŠ¥å‘Š
let report = PerformanceMonitor.shared.generateReport()
print(report.summary)

// è¾“å‡ºç¤ºä¾‹ï¼š
// æ€§èƒ½æŠ¥å‘Š:
// - æ€»æŒ‡æ ‡æ•°: 150
// - å¹³å‡ç½‘ç»œè¯·æ±‚æ—¶é—´: 0.85ç§’
// - å¹³å‡è§†å›¾åŠ è½½æ—¶é—´: 0.32ç§’
// - æ…¢è¯·æ±‚æ•°: 5
// - æ…¢è§†å›¾æ•°: 2

// è·å–æ…¢è¯·æ±‚
let slowRequests = report.slowRequests
for request in slowRequests {
    print("æ…¢è¯·æ±‚: \(request.identifier), è€—æ—¶: \(request.duration)ç§’")
}
```

---

## ValidationHelper ä½¿ç”¨ç¤ºä¾‹

### é‚®ç®±éªŒè¯

```swift
let email = "user@example.com"

if ValidationHelper.isValidEmail(email) {
    print("é‚®ç®±æ ¼å¼æ­£ç¡®")
} else {
    print("é‚®ç®±æ ¼å¼é”™è¯¯")
}
```

### æ‰‹æœºå·éªŒè¯

```swift
let phone = "+441234567890"

// éªŒè¯è‹±å›½æ‰‹æœºå·
if ValidationHelper.isValidUKPhone(phone) {
    print("è‹±å›½æ‰‹æœºå·æ ¼å¼æ­£ç¡®")
}

// éªŒè¯å›½é™…æ‰‹æœºå·
if ValidationHelper.isValidInternationalPhone(phone) {
    print("å›½é™…æ‰‹æœºå·æ ¼å¼æ­£ç¡®")
}
```

### å¯†ç å¼ºåº¦éªŒè¯

```swift
let password = "MyPassword123"

let result = ValidationHelper.validatePassword(
    password,
    minLength: 8,
    requireUppercase: true,
    requireLowercase: true,
    requireDigit: true,
    requireSpecialChar: false
)

if result.isValid {
    print("å¯†ç å¼ºåº¦ç¬¦åˆè¦æ±‚")
} else {
    print("å¯†ç ä¸ç¬¦åˆè¦æ±‚: \(result.errorMessage)")
    for error in result.errors {
        print("- \(error.localizedDescription)")
    }
}
```

### åœ¨ ViewModel ä¸­ä½¿ç”¨

```swift
class AuthViewModel: ObservableObject {
    @Published var email = ""
    @Published var password = ""
    @Published var emailError: String?
    @Published var passwordError: String?
    
    func validateEmail() -> Bool {
        if !ValidationHelper.isValidEmail(email) {
            emailError = "è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€"
            return false
        }
        emailError = nil
        return true
    }
    
    func validatePassword() -> Bool {
        let result = ValidationHelper.validatePassword(
            password,
            minLength: 8,
            requireUppercase: true,
            requireDigit: true
        )
        
        if !result.isValid {
            passwordError = result.errorMessage
            return false
        }
        passwordError = nil
        return true
    }
    
    func login() {
        guard validateEmail() && validatePassword() else {
            return
        }
        // æ‰§è¡Œç™»å½•
    }
}
```

---

## View+Extensions ä½¿ç”¨ç¤ºä¾‹

### åŠ è½½çŠ¶æ€è¦†ç›–å±‚

```swift
struct MyView: View {
    @StateObject private var viewModel = MyViewModel()
    
    var body: some View {
        VStack {
            // å†…å®¹
        }
        .loadingOverlay(isLoading: viewModel.isLoading)
    }
}
```

### é”™è¯¯æç¤º

```swift
struct MyView: View {
    @StateObject private var viewModel = MyViewModel()
    @State private var error: Error?
    
    var body: some View {
        VStack {
            // å†…å®¹
        }
        .errorAlert(error: $error)
        .onChange(of: viewModel.errorMessage) { message in
            if let message = message {
                error = NSError(domain: "AppError", code: -1, userInfo: [NSLocalizedDescriptionKey: message])
            }
        }
    }
}
```

### æ¡ä»¶ä¿®é¥°ç¬¦

```swift
struct MyView: View {
    @State private var isEnabled = true
    
    var body: some View {
        Button("ç‚¹å‡»") {
            // æ“ä½œ
        }
        .if(isEnabled) { button in
            button
                .foregroundColor(.blue)
                .disabled(false)
        } else: { button in
            button
                .foregroundColor(.gray)
                .disabled(true)
        }
    }
}
```

---

## LoadingState ä½¿ç”¨ç¤ºä¾‹

### åœ¨ ViewModel ä¸­ä½¿ç”¨

```swift
class MyViewModel: ObservableObject {
    @Published var loadingState: LoadingState<[User]> = .idle
    
    func loadUsers() {
        loadingState = .loading
        
        apiService.request([User].self, "/api/users")
            .sink(receiveCompletion: { [weak self] completion in
                if case .failure(let error) = completion {
                    self?.loadingState = .failure(error)
                }
            }, receiveValue: { [weak self] users in
                self?.loadingState = .success(users)
            })
            .store(in: &cancellables)
    }
}
```

### åœ¨ View ä¸­ä½¿ç”¨

```swift
struct UsersView: View {
    @StateObject private var viewModel = MyViewModel()
    
    var body: some View {
        List {
            ForEach(viewModel.loadingState.value ?? []) { user in
                UserRow(user: user)
            }
        }
        .loadingState(viewModel.loadingState)
        .onAppear {
            viewModel.loadUsers()
        }
    }
}
```

---

## PaginatedList ä½¿ç”¨ç¤ºä¾‹

### åœ¨ ViewModel ä¸­ä½¿ç”¨

```swift
class UsersViewModel: ObservableObject {
    @Published var listViewModel: PaginatedListViewModel<User>
    
    init() {
        listViewModel = PaginatedListViewModel<User>(
            pageSize: 20,
            loadPage: { page, size in
                // è¿”å›ç½‘ç»œè¯·æ±‚ Publisher
                APIService.shared.request(
                    UserListResponse.self,
                    "/api/users?page=\(page)&size=\(size)"
                )
                .map { $0.users }
                .eraseToAnyPublisher()
            }
        )
    }
    
    func loadData() {
        listViewModel.loadFirstPage()
    }
}
```

### åœ¨ View ä¸­ä½¿ç”¨

```swift
struct UsersListView: View {
    @StateObject private var viewModel = UsersViewModel()
    
    var body: some View {
        PaginatedList(viewModel: viewModel.listViewModel) { user in
            UserRow(user: user)
        }
        .onAppear {
            viewModel.loadData()
        }
    }
}
```

---

## ç»¼åˆç¤ºä¾‹

### å®Œæ•´çš„ ViewModel ç¤ºä¾‹

```swift
import Foundation
import Combine

class CompleteViewModel: ObservableObject {
    // ä½¿ç”¨ä¾èµ–æ³¨å…¥
    private let apiService: APIService
    
    // ä½¿ç”¨ LoadingState
    @Published var loadingState: LoadingState<[Item]> = .idle
    
    // é”™è¯¯æ¶ˆæ¯ï¼ˆç”¨äº UI æ˜¾ç¤ºï¼‰
    @Published var errorMessage: String?
    
    private var cancellables = Set<AnyCancellable>()
    
    init(apiService: APIService? = nil) {
        self.apiService = apiService ?? APIService.shared
    }
    
    func loadItems() {
        loadingState = .loading
        errorMessage = nil
        
        apiService.request([Item].self, "/api/items")
            .sink(receiveCompletion: { [weak self] completion in
                if case .failure(let error) = completion {
                    // ä½¿ç”¨ ErrorHandler ç»Ÿä¸€å¤„ç†
                    ErrorHandler.shared.handle(error, context: "åŠ è½½é¡¹ç›®åˆ—è¡¨")
                    
                    // è®¾ç½® LoadingState
                    self?.loadingState = .failure(error)
                    
                    // è®¾ç½®é”™è¯¯æ¶ˆæ¯
                    if let apiError = error as? APIError {
                        self?.errorMessage = apiError.userFriendlyMessage
                    } else {
                        self?.errorMessage = error.localizedDescription
                    }
                }
            }, receiveValue: { [weak self] items in
                self?.loadingState = .success(items)
            })
            .store(in: &cancellables)
    }
}
```

### å®Œæ•´çš„ View ç¤ºä¾‹

```swift
import SwiftUI

struct CompleteView: View {
    @StateObject private var viewModel = CompleteViewModel()
    @State private var error: Error?
    
    var body: some View {
        NavigationView {
            List {
                ForEach(viewModel.loadingState.value ?? []) { item in
                    ItemRow(item: item)
                }
            }
            .navigationTitle("é¡¹ç›®åˆ—è¡¨")
            .loadingState(viewModel.loadingState)
            .errorAlert(error: $error)
            .onAppear {
                viewModel.loadItems()
            }
            .onReceive(ErrorHandler.shared.$currentError) { appError in
                if let appError = appError {
                    error = appError.error
                }
            }
        }
    }
}
```

---

## æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†
- âœ… å§‹ç»ˆä½¿ç”¨ `ErrorHandler.shared.handle()` å¤„ç†é”™è¯¯
- âœ… ä½¿ç”¨ `APIError.userFriendlyMessage` æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- âœ… åœ¨ View ä¸­ä½¿ç”¨ `.errorAlert()` æ˜¾ç¤ºé”™è¯¯

### 2. ä¾èµ–æ³¨å…¥
- âœ… åœ¨ ViewModel çš„ init æ–¹æ³•ä¸­æ”¯æŒä¾èµ–æ³¨å…¥
- âœ… æä¾›é»˜è®¤å€¼ä»¥ä¿æŒå‘åå…¼å®¹
- âœ… åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ Mock æœåŠ¡

### 3. æ€§èƒ½ç›‘æ§
- âœ… ç½‘ç»œè¯·æ±‚è‡ªåŠ¨ç›‘æ§ï¼ˆæ— éœ€æ‰‹åŠ¨æ·»åŠ ï¼‰
- âœ… æ‰‹åŠ¨è®°å½•è§†å›¾åŠ è½½æ€§èƒ½
- âœ… å®šæœŸæ£€æŸ¥æ€§èƒ½æŠ¥å‘Š

### 4. æ•°æ®éªŒè¯
- âœ… ä½¿ç”¨ `ValidationHelper` è¿›è¡Œæ•°æ®éªŒè¯
- âœ… åœ¨ç”¨æˆ·è¾“å…¥æ—¶å®æ—¶éªŒè¯
- âœ… æ˜¾ç¤ºæ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯

### 5. UI ç»„ä»¶
- âœ… ä½¿ç”¨ `LoadingState` ç®¡ç†åŠ è½½çŠ¶æ€
- âœ… ä½¿ç”¨ `PaginatedList` å¤„ç†åˆ†é¡µåˆ—è¡¨
- âœ… ä½¿ç”¨ `View+Extensions` ä¸­çš„æ‰©å±•æ–¹æ³•

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç‰ˆæœ¬**: 1.0

