# å¼•å¯¼æ•™ç¨‹ä¸ªæ€§åŒ–è®¾ç½®å®ç°è¯´æ˜

## ğŸ†• æœ€æ–°æ›´æ–°

### è·å–å½“å‰ä½ç½®åŠŸèƒ½ï¼ˆ2024-01-XXï¼‰

åœ¨å¼•å¯¼æ•™ç¨‹çš„"å¸¸ç”¨åŸå¸‚"é€‰æ‹©é¡µé¢ä¸­ï¼Œæ–°å¢äº†**"ä½¿ç”¨å½“å‰ä½ç½®"**æŒ‰é’®ï¼š

- âœ… ç‚¹å‡»æŒ‰é’®è‡ªåŠ¨è·å–ç”¨æˆ·å½“å‰æ‰€åœ¨åŸå¸‚
- âœ… è‡ªåŠ¨è¯·æ±‚ä½ç½®æƒé™ï¼ˆå¦‚æœæœªæˆæƒï¼‰
- âœ… æ˜¾ç¤ºåŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º
- âœ… è·å–æˆåŠŸåè‡ªåŠ¨è®¾ç½®ä¸ºé€‰ä¸­åŸå¸‚
- âœ… æ”¯æŒä¸­è‹±æ–‡ç•Œé¢

---

## ğŸ“‹ é—®é¢˜åˆ†æ

ä½ æå‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼š**æ–°ç”¨æˆ·åˆšä¸‹è½½åº”ç”¨æ—¶è¿˜æ²¡æœ‰ç™»å½•ï¼Œä¸ªæ€§åŒ–è®¾ç½®èƒ½å¦ä¿å­˜ï¼Ÿæ˜¯å¦å·²ç»å®è£…ï¼Ÿ**

### ä¹‹å‰çš„çŠ¶æ€

âœ… **ä¿å­˜åŠŸèƒ½å·²å®ç°**ï¼š
- åœ¨ `OnboardingView.swift` çš„ `completeOnboarding()` æ–¹æ³•ä¸­ï¼Œä¸ªæ€§åŒ–è®¾ç½®ç¡®å®ä¿å­˜åˆ°äº† `UserDefaults`ï¼š
  - `preferred_city` - ç”¨æˆ·é€‰æ‹©çš„å¸¸ç”¨åŸå¸‚
  - `preferred_task_types` - ç”¨æˆ·é€‰æ‹©çš„ä»»åŠ¡ç±»å‹ï¼ˆæœ¬åœ°åŒ–æ˜¾ç¤ºåç§°ï¼‰

âŒ **ä½¿ç”¨åŠŸèƒ½ç¼ºå¤±**ï¼š
- ä¿å­˜çš„è®¾ç½®æ²¡æœ‰è¢«è¯»å–å’Œåº”ç”¨
- ä»»åŠ¡åˆ—è¡¨åŠ è½½æ—¶æ²¡æœ‰ä½¿ç”¨è¿™äº›åå¥½è®¾ç½®
- ç”¨æˆ·ç™»å½•åæ²¡æœ‰å°†æœ¬åœ°åå¥½åŒæ­¥åˆ°æœåŠ¡å™¨

---

## âœ… å·²å®ç°çš„ä¿®å¤

### 1. åœ¨ä»»åŠ¡åˆ—è¡¨åº”ç”¨åå¥½è®¾ç½®

**æ–‡ä»¶**: `ios/link2ur/link2ur/Views/Tasks/TasksView.swift`

**æ–°å¢åŠŸèƒ½**ï¼š
- æ·»åŠ äº† `applyOnboardingPreferences()` æ–¹æ³•
- åœ¨é¦–æ¬¡åŠ è½½ä»»åŠ¡æ—¶ï¼ˆ`.task` ä¿®é¥°ç¬¦ä¸­ï¼‰è‡ªåŠ¨åº”ç”¨å¼•å¯¼æ•™ç¨‹ä¿å­˜çš„åå¥½è®¾ç½®
- è¯»å– `UserDefaults` ä¸­çš„ `preferred_city` å¹¶åº”ç”¨åˆ° `selectedCity`
- è¯»å– `preferred_task_types`ï¼Œå°†æœ¬åœ°åŒ–æ˜¾ç¤ºåç§°è½¬æ¢ä¸ºåç«¯å€¼ï¼Œå¹¶åº”ç”¨åˆ° `selectedCategory`

**å®ç°ç»†èŠ‚**ï¼š
```swift
private func applyOnboardingPreferences() {
    // åªåº”ç”¨ä¸€æ¬¡ï¼Œé¿å…é‡å¤åº”ç”¨
    guard !hasAppliedOnboardingPreferences else { return }
    hasAppliedOnboardingPreferences = true
    
    // è¯»å–å¹¶åº”ç”¨åå¥½åŸå¸‚
    if let preferredCity = UserDefaults.standard.string(forKey: "preferred_city"),
       !preferredCity.isEmpty {
        selectedCity = preferredCity
    }
    
    // è¯»å–å¹¶åº”ç”¨åå¥½ä»»åŠ¡ç±»å‹ï¼ˆå¦‚æœåªé€‰æ‹©äº†ä¸€ä¸ªï¼‰
    if let preferredTaskTypes = UserDefaults.standard.array(forKey: "preferred_task_types") as? [String],
       preferredTaskTypes.count == 1 {
        // å°†æœ¬åœ°åŒ–åç§°è½¬æ¢ä¸ºåç«¯å€¼
        let backendValue = taskTypeMapping[preferredTaskTypes.first!]
        selectedCategory = backendValue
    }
}
```

### 2. ç™»å½•ååŒæ­¥åˆ°æœåŠ¡å™¨

**æ–‡ä»¶**: `ios/link2ur/link2ur/Utils/AppState.swift`

**æ–°å¢åŠŸèƒ½**ï¼š
- æ·»åŠ äº† `syncOnboardingPreferencesToServer()` æ–¹æ³•
- åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ˆå»¶è¿Ÿ3ç§’ï¼‰è‡ªåŠ¨åŒæ­¥æœ¬åœ°åå¥½è®¾ç½®åˆ°æœåŠ¡å™¨
- å°†æœ¬åœ°åŒ–çš„ä»»åŠ¡ç±»å‹åç§°è½¬æ¢ä¸ºåç«¯å€¼
- ä½¿ç”¨ `onboarding_preferences_synced` æ ‡è®°é¿å…é‡å¤åŒæ­¥

**å®ç°ç»†èŠ‚**ï¼š
```swift
private func syncOnboardingPreferencesToServer() {
    // æ£€æŸ¥æ˜¯å¦æœ‰å¼•å¯¼åå¥½è®¾ç½®
    guard let preferredCity = UserDefaults.standard.string(forKey: "preferred_city"),
          let preferredTaskTypes = UserDefaults.standard.array(forKey: "preferred_task_types") as? [String] else {
        return
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²åŒæ­¥è¿‡
    if UserDefaults.standard.bool(forKey: "onboarding_preferences_synced") {
        return
    }
    
    // è½¬æ¢ä¸ºåç«¯å€¼å¹¶åŒæ­¥åˆ°æœåŠ¡å™¨
    let preferences = UserPreferences(
        taskTypes: backendTaskTypes,
        locations: [preferredCity],
        ...
    )
    
    apiService.updateUserPreferences(preferences: preferences)
        .sink(...)
}
```

---

## ğŸ”„ å®Œæ•´æµç¨‹

### æ–°ç”¨æˆ·æµç¨‹

1. **é¦–æ¬¡æ‰“å¼€åº”ç”¨** â†’ æ˜¾ç¤ºå¼•å¯¼æ•™ç¨‹
2. **å®Œæˆä¸ªæ€§åŒ–è®¾ç½®** â†’ ä¿å­˜åˆ° `UserDefaults`ï¼š
   - `preferred_city` = "London"
   - `preferred_task_types` = ["è·‘è…¿ä»£è´­", "æŠ€èƒ½æœåŠ¡"]
3. **è¿›å…¥ä»»åŠ¡åˆ—è¡¨** â†’ è‡ªåŠ¨åº”ç”¨åå¥½è®¾ç½®ï¼š
   - åŸå¸‚ç­›é€‰è‡ªåŠ¨è®¾ç½®ä¸º "London"
   - å¦‚æœåªé€‰æ‹©äº†ä¸€ä¸ªä»»åŠ¡ç±»å‹ï¼Œè‡ªåŠ¨åº”ç”¨è¯¥ç±»å‹ç­›é€‰
4. **ç”¨æˆ·ç™»å½•** â†’ å»¶è¿Ÿ3ç§’åè‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨ï¼š
   - å°†æœ¬åœ°åå¥½è½¬æ¢ä¸º `UserPreferences` æ ¼å¼
   - è°ƒç”¨ `updateUserPreferences` API
   - æ ‡è®° `onboarding_preferences_synced = true`

### å·²ç™»å½•ç”¨æˆ·æµç¨‹

- å¦‚æœç”¨æˆ·å·²ç»ç™»å½•ï¼Œå¼•å¯¼æ•™ç¨‹ä¸ä¼šæ˜¾ç¤º
- åå¥½è®¾ç½®é€šè¿‡ `TaskPreferencesView` ç®¡ç†ï¼Œç›´æ¥åŒæ­¥åˆ°æœåŠ¡å™¨

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æœ¬åœ°åŒ–åç§°åˆ°åç«¯å€¼çš„æ˜ å°„

å¼•å¯¼æ•™ç¨‹ä¸­ä¿å­˜çš„æ˜¯æœ¬åœ°åŒ–çš„æ˜¾ç¤ºåç§°ï¼ˆå¦‚"è·‘è…¿ä»£è´­"ï¼‰ï¼Œä½†åç«¯éœ€è¦çš„æ˜¯è‹±æ–‡å€¼ï¼ˆå¦‚"Errand Running"ï¼‰ã€‚å› æ­¤éœ€è¦æ˜ å°„ï¼š

```swift
let taskTypeMapping: [String: String] = [
    LocalizationKey.taskCategoryErrandRunning.localized: "Errand Running",
    LocalizationKey.taskCategorySkillService.localized: "Skill Service",
    // ...
]
```

### ä»»åŠ¡ç±»å‹ç­›é€‰é€»è¾‘

- **å¦‚æœç”¨æˆ·åªé€‰æ‹©äº†ä¸€ä¸ªä»»åŠ¡ç±»å‹**ï¼šè‡ªåŠ¨åº”ç”¨è¯¥ç±»å‹ç­›é€‰
- **å¦‚æœç”¨æˆ·é€‰æ‹©äº†å¤šä¸ªä»»åŠ¡ç±»å‹**ï¼šä¸è‡ªåŠ¨åº”ç”¨ç­›é€‰ï¼ˆé¿å…è¿‡äºé™åˆ¶ï¼‰ï¼Œä½†ä¼šåœ¨ç™»å½•ååŒæ­¥åˆ°æœåŠ¡å™¨ç”¨äºæ¨èç®—æ³•

### åŒæ­¥æ—¶æœº

- **å»¶è¿Ÿ3ç§’**ï¼šç¡®ä¿ç”¨æˆ·ç™»å½•æµç¨‹å®Œå…¨å®Œæˆï¼Œé¿å…ä¸ç™»å½•è¯·æ±‚å†²çª
- **åªåŒæ­¥ä¸€æ¬¡**ï¼šä½¿ç”¨ `onboarding_preferences_synced` æ ‡è®°é¿å…é‡å¤åŒæ­¥

---

## âœ… éªŒè¯æ¸…å•

- [x] ä¸ªæ€§åŒ–è®¾ç½®ä¿å­˜åˆ° `UserDefaults`
- [x] ä»»åŠ¡åˆ—è¡¨é¦–æ¬¡åŠ è½½æ—¶åº”ç”¨åå¥½åŸå¸‚
- [x] ä»»åŠ¡åˆ—è¡¨é¦–æ¬¡åŠ è½½æ—¶åº”ç”¨åå¥½ä»»åŠ¡ç±»å‹ï¼ˆå¦‚æœåªé€‰äº†ä¸€ä¸ªï¼‰
- [x] ç”¨æˆ·ç™»å½•åè‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨
- [x] é¿å…é‡å¤åŒæ­¥ï¼ˆä½¿ç”¨æ ‡è®°ï¼‰
- [x] æœ¬åœ°åŒ–åç§°æ­£ç¡®è½¬æ¢ä¸ºåç«¯å€¼

---

## ğŸ¯ æ€»ç»“

ç°åœ¨ä¸ªæ€§åŒ–è®¾ç½®åŠŸèƒ½å·²ç»**å®Œå…¨å®è£…**ï¼š

1. âœ… **ä¿å­˜åŠŸèƒ½**ï¼šå¼•å¯¼æ•™ç¨‹ä¸­çš„è®¾ç½®ä¼šä¿å­˜åˆ° `UserDefaults`
2. âœ… **åº”ç”¨åŠŸèƒ½**ï¼šä»»åŠ¡åˆ—è¡¨ä¼šè‡ªåŠ¨åº”ç”¨è¿™äº›åå¥½è®¾ç½®
3. âœ… **åŒæ­¥åŠŸèƒ½**ï¼šç”¨æˆ·ç™»å½•åä¼šè‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨

æ–°ç”¨æˆ·å³ä½¿æ²¡æœ‰ç™»å½•ï¼Œä»–ä»¬çš„ä¸ªæ€§åŒ–è®¾ç½®ä¹Ÿä¼šè¢«ä¿å­˜å¹¶åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­ç”Ÿæ•ˆã€‚ç™»å½•åï¼Œè¿™äº›è®¾ç½®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨ï¼Œç”¨äºä¸ªæ€§åŒ–æ¨èç­‰åŠŸèƒ½ã€‚
