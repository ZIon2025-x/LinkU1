# 部署前检查清单

## ✅ 已完成项目

### 1. 后端路由更新
- [x] 所有用户端路由已更新为 `/api/user/customer-service/...`
- [x] 所有客服端路由已更新为 `/api/customer-service/chats/...`
- [x] 超时相关路由已更新
- [x] 所有旧路由已移除，无兼容层
- [x] 代码通过 lint 检查

### 2. 前端路由更新
- [x] `frontend/src/api.ts` - 所有API函数已更新
- [x] `frontend/src/pages/Message.tsx` - 所有直接fetch调用已更新
- [x] `frontend/src/pages/CustomerService.tsx` - 客服端路由已更新
- [x] `frontend/src/config.ts` - 路由配置已更新
- [x] 代码通过 lint 检查

### 3. 数据库迁移
- [x] `add_customer_service_fields.sql` - 已创建
- [x] `add_customer_service_queue.sql` - 已创建
- [x] `backend/app/db_migrations.py` - 已配置自动迁移
- [x] `backend/app/main.py` - 已集成自动迁移到启动事件

### 4. 功能实现
- [x] 结束对话原因字段已添加
- [x] 消息状态字段已添加
- [x] 客服排队系统表已创建
- [x] 速率限制已添加
- [x] 路由统一命名已完成

## 📋 部署步骤

### 1. 数据库迁移（自动执行）
- ✅ 迁移脚本会在应用启动时自动执行
- ✅ 使用 `IF NOT EXISTS` 确保幂等性
- ✅ 无需手动执行SQL脚本

### 2. 后端部署
```bash
# 1. 确保所有依赖已安装
pip install -r requirements.txt

# 2. 检查环境变量
# 确保以下环境变量已配置：
# - DATABASE_URL
# - REDIS_URL
# - SECRET_KEY
# - 其他必要配置

# 3. 启动应用
# 迁移会在启动时自动执行
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 3. 前端部署
```bash
# 1. 安装依赖
npm install

# 2. 构建生产版本
npm run build

# 3. 部署构建产物
# 根据你的部署方式（Vercel、Netlify等）进行部署
```

## ⚠️ 重要注意事项

### 1. 部署顺序
- **推荐**：同时部署前端和后端（或先部署后端，再部署前端）
- **不推荐**：先部署前端，后部署后端（会导致前端调用旧路由404）

### 2. 数据库迁移
- ✅ 迁移脚本使用 `IF NOT EXISTS`，可以安全地重复执行
- ✅ 如果之前已经手动执行过迁移，不会重复执行
- ✅ 新部署会自动执行未执行的迁移

### 3. 路由变更影响
- ⚠️ **无向后兼容**：所有旧路由已完全移除
- ⚠️ 如果前端和后端版本不一致，会出现404错误
- ✅ 确保前端和后端代码版本同步

### 4. 参数类型变更
- `rateCustomerService`: 参数从 `sessionId: number` 改为 `chatId: string`
- `endCustomerServiceSession`: 参数从 `sessionId: number` 改为 `chatId: string`
- ✅ 前端代码已更新，无需额外处理

## 🔍 部署后验证

### 1. 后端验证
```bash
# 检查应用是否正常启动
curl http://localhost:8000/api/health

# 检查路由是否正常
curl -X POST http://localhost:8000/api/user/customer-service/assign
```

### 2. 前端验证
- [ ] 用户端：分配客服功能正常
- [ ] 用户端：发送消息功能正常
- [ ] 用户端：获取消息功能正常
- [ ] 用户端：结束对话功能正常
- [ ] 用户端：评分功能正常
- [ ] 客服端：获取对话列表正常
- [ ] 客服端：发送消息功能正常
- [ ] 客服端：结束对话功能正常
- [ ] 客服端：超时结束功能正常

### 3. 数据库验证
```sql
-- 检查新字段是否存在
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'customer_service_chats' 
AND column_name IN ('ended_reason', 'ended_by', 'ended_type', 'ended_comment');

-- 检查新表是否存在
SELECT table_name 
FROM information_schema.tables 
WHERE table_name = 'customer_service_queue';

-- 检查索引是否存在
SELECT indexname 
FROM pg_indexes 
WHERE tablename = 'customer_service_queue';
```

## 🚨 回滚方案

如果部署后出现问题，可以：

1. **快速回滚**：恢复到之前的代码版本
2. **数据库回滚**：新字段和新表可以保留（不影响旧功能）
3. **路由回滚**：需要同时回滚前端和后端代码

## ✅ 最终确认

- [x] 所有代码已更新
- [x] 所有路由已统一
- [x] 数据库迁移已配置
- [x] 代码通过 lint 检查
- [x] 无旧路由残留
- [x] 前端和后端路由已同步

**状态**: ✅ **可以部署**

---

**部署日期**: 2024-12-28
**版本**: 路由统一版本

