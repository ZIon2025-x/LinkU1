# 竞品图片上传逻辑说明

## 整体流程

### 1. 用户选择图片
- 用户在表单中点击上传按钮
- 选择图片文件（最多5张，每张不超过5MB）

### 2. 立即显示预览（前端）
```typescript
// 当用户选择文件后
handleImageChange(info) {
  // 1. 立即创建临时预览
  const newFile = {
    uid: `temp-${Date.now()}-${Math.random()}`,
    name: fileToUpload.name,
    status: 'uploading',  // 显示上传中状态
    url: URL.createObjectURL(fileToUpload),  // 临时预览URL
    originFileObj: fileToUpload
  };
  
  // 2. 立即添加到上传列表，用户可以看到预览
  setUploadingFileList(prev => [...prev, newFile]);
  
  // 3. 延迟执行压缩和上传（避免阻塞UI）
  setTimeout(async () => {
    // 执行压缩和上传
  }, 0);
}
```

### 3. 图片压缩（前端，异步执行）
```typescript
// 压缩参数
compressImage(file, {
  maxSizeMB: 1,           // 最大1MB
  maxWidthOrHeight: 1920, // 最大尺寸1920px
  useWebWorker: true,     // 使用Web Worker，不阻塞主线程
  initialQuality: 0.8     // 质量80%
})
```

**压缩逻辑**：
- 如果文件已经 ≤ 1MB 且尺寸 ≤ 1920px，直接返回原文件
- 否则使用 `browser-image-compression` 库压缩
- 使用 Web Worker 在后台线程执行，不阻塞UI

### 4. 上传到服务器
```typescript
// 上传接口
POST /api/upload/public-image
Content-Type: multipart/form-data

// 请求体
FormData {
  image: compressedFile  // 压缩后的图片文件
}

// 响应
{
  success: true,
  url: "https://example.com/uploads/images/xxx.jpg"  // 图片URL
}
```

**后端处理**：
- 接收压缩后的图片文件
- 保存到 `uploads/public/images/` 目录
- 返回图片的完整URL

### 5. 更新UI状态
```typescript
// 上传成功后
setUploadingFileList(prev => prev.map(f => 
  f.uid === tempId 
    ? { ...f, status: 'done', url: serverUrl }  // 更新为完成状态
    : f
));

// 添加到已上传图片列表
setUploadingImages(prev => [...prev, serverUrl]);
```

### 6. 提交竞品（包含图片URL）
```typescript
// 用户填写完表单，点击提交
handleSubmitItem(values) {
  await submitLeaderboardItem({
    leaderboard_id: Number(leaderboardId),
    name: values.name,
    description: values.description,
    address: values.address,
    phone: values.phone,
    website: values.website,
    images: uploadingImages  // 图片URL数组
  });
}
```

**API请求**：
```typescript
POST /api/custom-leaderboards/items
{
  leaderboard_id: 1,
  name: "竞品名称",
  description: "描述",
  images: [
    "https://example.com/uploads/images/img1.jpg",
    "https://example.com/uploads/images/img2.jpg"
  ]
}
```

**后端处理**：
- 创建竞品记录
- 将图片URL数组存储到数据库的 `images` 字段（JSON格式）

## 状态管理

### 前端状态
1. **`uploadingImages`**: 已上传完成的图片URL数组
   - 用于提交竞品时发送给后端
   - 用于显示已完成的图片预览

2. **`uploadingFileList`**: 正在上传的图片列表
   - 包含上传中的文件信息
   - 显示上传进度和临时预览

3. **`uploading`**: 全局上传状态
   - 用于显示加载指示器

### 文件状态流转
```
选择文件 
  → uploading (显示临时预览)
    → 压缩中 (后台执行)
      → 上传中 (显示进度)
        → done (显示完成预览)
          → 添加到 uploadingImages
```

## 关键特性

### 1. 非阻塞UI
- 使用 `setTimeout(..., 0)` 延迟执行压缩和上传
- 使用 Web Worker 进行图片压缩
- 立即显示预览，不等待上传完成

### 2. 实时反馈
- 选择文件后立即显示预览
- 显示上传中状态和进度
- 上传完成后显示成功提示

### 3. 错误处理
- 压缩失败：使用原文件
- 上传失败：移除文件，显示错误提示
- 网络错误：自动重试（由axios处理）

### 4. 性能优化
- 前端压缩减少上传时间
- 限制文件大小和尺寸
- 使用Web Worker避免阻塞主线程

## 数据流

```
用户选择图片
  ↓
立即显示预览 (URL.createObjectURL)
  ↓
延迟执行压缩 (setTimeout)
  ↓
压缩图片 (browser-image-compression + Web Worker)
  ↓
上传到服务器 (POST /api/upload/public-image)
  ↓
获取服务器URL
  ↓
更新预览 (使用服务器URL)
  ↓
添加到 uploadingImages
  ↓
提交竞品时一起发送 (POST /api/custom-leaderboards/items)
  ↓
后端保存到数据库
```

## 限制

- **最多5张图片**：由 `maxCount={5}` 限制
- **每张不超过5MB**：前端提示，后端验证
- **压缩后最大1MB**：压缩目标
- **最大尺寸1920px**：压缩目标

## 优势

1. **用户体验好**：立即显示预览，实时反馈
2. **性能优化**：前端压缩，减少服务器负担
3. **不阻塞UI**：使用异步和Web Worker
4. **错误处理完善**：各种异常情况都有处理

