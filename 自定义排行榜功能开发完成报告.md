# è‡ªå®šä¹‰æ’è¡Œæ¦œåŠŸèƒ½å¼€å‘å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ¬¡å¼€å‘å®ç°äº†å®Œæ•´çš„ç”¨æˆ·é©±åŠ¨åŠ¨æ€æ’è¡Œæ¦œç³»ç»Ÿï¼Œå…è®¸ç”¨æˆ·ç”³è¯·åˆ›å»ºè‡ªå®šä¹‰æ’è¡Œæ¦œï¼Œæ·»åŠ ç«å“ï¼Œå¹¶è¿›è¡ŒæŠ•ç¥¨æ’åºã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. åç«¯å®ç°

#### 1.1 æ•°æ®æ¨¡å‹ (`backend/app/models.py`)
- âœ… `CustomLeaderboard` - è‡ªå®šä¹‰æ’è¡Œæ¦œè¡¨
  - æ”¯æŒç”³è¯·ã€å®¡æ ¸ã€æ¿€æ´»æµç¨‹
  - ç»Ÿè®¡ä¿¡æ¯ï¼ˆç«å“æ•°ã€æŠ•ç¥¨æ•°ã€æµè§ˆé‡ï¼‰
  - åœ°åŒºã€åç§°å”¯ä¸€çº¦æŸ
  
- âœ… `LeaderboardItem` - æ’è¡Œæ¦œç«å“è¡¨
  - æ”¯æŒå¤šå›¾ä¸Šä¼ ï¼ˆJSONå­˜å‚¨ï¼‰
  - æŠ•ç¥¨ç»Ÿè®¡ï¼ˆç‚¹èµã€ç‚¹è¸©ã€å‡€èµã€ç»¼åˆå¾—åˆ†ï¼‰
  - è¯¦ç»†ä¿¡æ¯ï¼ˆåœ°å€ã€ç”µè¯ã€ç½‘ç«™ï¼‰
  
- âœ… `LeaderboardVote` - æŠ•ç¥¨è®°å½•è¡¨
  - æ”¯æŒæŠ•ç¥¨ç•™è¨€ï¼ˆæœ€å¤š500å­—ï¼‰
  - æ”¯æŒåŒ¿åæŠ•ç¥¨
  - ç”¨æˆ·-ç«å“å”¯ä¸€çº¦æŸ

#### 1.2 Schemaå®šä¹‰ (`backend/app/schemas.py`)
- âœ… å®Œæ•´çš„è¯·æ±‚/å“åº”Schema
- âœ… åˆ†é¡µå“åº”Schemaï¼ˆ`CustomLeaderboardListResponse`, `LeaderboardItemListResponse`ï¼‰
- âœ… ç®¡ç†å‘˜ä¸“ç”¨Schemaï¼ˆ`LeaderboardVoteAdminOut`ï¼‰

#### 1.3 APIè·¯ç”± (`backend/app/custom_leaderboard_routes.py`)
- âœ… **æ¦œå•ç”³è¯·** (`POST /api/custom-leaderboards/apply`)
  - ç”¨æˆ·ç”³è¯·åˆ›å»ºæ–°æ¦œå•
  - è‡ªåŠ¨æ£€æŸ¥é‡å¤
  - é€Ÿç‡é™åˆ¶ï¼š5æ¬¡/5åˆ†é’Ÿ
  
- âœ… **æ¦œå•åˆ—è¡¨** (`GET /api/custom-leaderboards`)
  - æ”¯æŒåœ°åŒºç­›é€‰
  - æ”¯æŒå…³é”®è¯æœç´¢ï¼ˆåç§°ã€æè¿°ï¼‰
  - æ”¯æŒå¤šç§æ’åºï¼ˆæœ€æ–°ã€çƒ­é—¨ã€æŠ•ç¥¨æ•°ã€ç«å“æ•°ï¼‰
  - åˆ†é¡µæ”¯æŒï¼ˆè¿”å›æ€»æ•°ã€has_moreï¼‰
  
- âœ… **æ¦œå•è¯¦æƒ…** (`GET /api/custom-leaderboards/{id}`)
  - è‡ªåŠ¨å¢åŠ æµè§ˆé‡
  - ä»…è¿”å›activeçŠ¶æ€æ¦œå•
  
- âœ… **æ¦œå•å®¡æ ¸** (`POST /api/custom-leaderboards/{id}/review`)
  - ç®¡ç†å‘˜ä¸“ç”¨
  - æ”¯æŒæ‰¹å‡†/æ‹’ç»
  - è®°å½•å®¡æ ¸æ„è§
  
- âœ… **æ–°å¢ç«å“** (`POST /api/custom-leaderboards/items`)
  - æ”¯æŒå¤šå›¾ä¸Šä¼ 
  - è‡ªåŠ¨æ£€æŸ¥é‡å¤
  - é€Ÿç‡é™åˆ¶ï¼š10æ¬¡/åˆ†é’Ÿ
  
- âœ… **ç«å“åˆ—è¡¨** (`GET /api/custom-leaderboards/{id}/items`)
  - æ”¯æŒå¤šç§æ’åºï¼ˆç»¼åˆå¾—åˆ†ã€å‡€èµæ•°ã€ç‚¹èµæ•°ã€æœ€æ–°ï¼‰
  - è¿”å›ç”¨æˆ·æŠ•ç¥¨çŠ¶æ€
  - åˆ†é¡µæ”¯æŒ
  
- âœ… **æŠ•ç¥¨** (`POST /api/custom-leaderboards/items/{id}/vote`)
  - æ”¯æŒç‚¹èµ/ç‚¹è¸©/å–æ¶ˆ
  - æ”¯æŒæŠ•ç¥¨ç•™è¨€ï¼ˆæœ€å¤š500å­—ï¼‰
  - æ”¯æŒåŒ¿åæŠ•ç¥¨
  - è‡ªåŠ¨è®¡ç®—ç»¼åˆå¾—åˆ†ï¼ˆWilson Score + æ—¶é—´è¡°å‡ï¼‰
  - é€Ÿç‡é™åˆ¶ï¼š30æ¬¡/åˆ†é’Ÿ
  
- âœ… **ç®¡ç†å‘˜æŸ¥çœ‹æŠ•ç¥¨è®°å½•** (`GET /api/custom-leaderboards/admin/votes`)
  - æ”¯æŒå¤šç»´åº¦ç­›é€‰
  - å§‹ç»ˆè¿”å›çœŸå®user_idï¼ˆç”¨äºå®¡è®¡ï¼‰

#### 1.4 æ•°æ®åº“è¿ç§» (`backend/migrations/026_add_custom_leaderboards.sql`)
- âœ… åˆ›å»ºä¸‰ä¸ªè¡¨åŠæ‰€æœ‰çº¦æŸ
- âœ… åˆ›å»ºæ‰€æœ‰å¿…è¦ç´¢å¼•ï¼ˆå•åˆ— + å¤åˆç´¢å¼•ï¼‰
- âœ… è‡ªåŠ¨æ›´æ–°æ—¶é—´è§¦å‘å™¨
- âœ… å¹‚ç­‰æ€§ä¿è¯ï¼ˆIF NOT EXISTSï¼‰

### 2. å‰ç«¯å®ç°

#### 2.1 å¸¸é‡æ–‡ä»¶ (`frontend/src/constants/leaderboard.ts`)
- âœ… LOCATIONSå¸¸é‡ï¼ˆæ”¯æŒ34ä¸ªåœ°åŒºï¼‰

#### 2.2 APIå‡½æ•° (`frontend/src/api.ts`)
- âœ… æ‰€æœ‰æ’è¡Œæ¦œç›¸å…³APIè°ƒç”¨å‡½æ•°
- âœ… æ”¯æŒåˆ†é¡µå‚æ•°
- âœ… æ”¯æŒæ’åºå‚æ•°

#### 2.3 ç»„ä»¶ (`frontend/src/components/CustomLeaderboardsTab.tsx`)
- âœ… æ¦œå•åˆ—è¡¨å±•ç¤º
- âœ… åœ°åŒºç­›é€‰
- âœ… å…³é”®è¯æœç´¢ï¼ˆ500msé˜²æŠ–ï¼‰
- âœ… æ’åºé€‰æ‹©ï¼ˆæœ€æ–°ã€çƒ­é—¨ã€æŠ•ç¥¨æ•°ã€ç«å“æ•°ï¼‰
- âœ… åˆ†é¡µç»„ä»¶
- âœ… ç”³è¯·æ–°æ¦œå•åŠŸèƒ½
- âœ… åŠ è½½çŠ¶æ€å’Œç©ºçŠ¶æ€å¤„ç†

#### 2.4 é¡µé¢ (`frontend/src/pages/CustomLeaderboardDetail.tsx`)
- âœ… æ¦œå•è¯¦æƒ…å±•ç¤º
- âœ… ç«å“åˆ—è¡¨ï¼ˆæ”¯æŒæ’åºå’Œåˆ†é¡µï¼‰
- âœ… æŠ•ç¥¨åŠŸèƒ½ï¼ˆæ”¯æŒç•™è¨€å’ŒåŒ¿åï¼‰
- âœ… æ–°å¢ç«å“åŠŸèƒ½ï¼ˆæ”¯æŒå¤šå›¾ä¸Šä¼ ï¼‰
- âœ… å›¾ç‰‡é¢„è§ˆï¼ˆæ”¯æŒå¤šå›¾ï¼‰
- âœ… è”ç³»æ–¹å¼å±•ç¤º
- âœ… æ’åå¾½ç« ï¼ˆå‰3åæ˜¾ç¤ºğŸ†ï¼‰
- âœ… ç”¨æˆ·ç•™è¨€å±•ç¤º

#### 2.5 é›†æˆ (`frontend/src/pages/ForumLeaderboard.tsx`)
- âœ… æ·»åŠ "å…¶å®ƒæ’è¡Œæ¦œ"Tab
- âœ… éšè—æ—¶é—´å‘¨æœŸé€‰æ‹©å™¨ï¼ˆcustom tabæ—¶ï¼‰

#### 2.6 è·¯ç”±é…ç½® (`frontend/src/App.tsx`)
- âœ… æ·»åŠ è‡ªå®šä¹‰æ’è¡Œæ¦œè¯¦æƒ…é¡µè·¯ç”±

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. æŠ•ç¥¨æ’åºç®—æ³•
- **Wilson Score Lower Boundç®—æ³•**ï¼šç»¼åˆè€ƒè™‘ç‚¹èµç‡å’Œæ ·æœ¬é‡
- **æ—¶é—´è¡°å‡å› å­**ï¼šæ–°ç«å“è·å¾—æ—¶é—´åŠ æˆï¼Œé¿å…è€ç«å“é•¿æœŸå æ®æ¦œé¦–
- **ç»¼åˆå¾—åˆ†**ï¼š`vote_score = wilson_score * 100 * time_factor`

### 2. å®‰å…¨ç‰¹æ€§
- âœ… CSRFä¿æŠ¤ï¼ˆæ‰€æœ‰å†™æ“ä½œï¼‰
- âœ… ç”¨æˆ·è®¤è¯ï¼ˆç”³è¯·ã€æ–°å¢ã€æŠ•ç¥¨ï¼‰
- âœ… ç®¡ç†å‘˜è®¤è¯ï¼ˆå®¡æ ¸ã€æŸ¥çœ‹æŠ•ç¥¨è®°å½•ï¼‰
- âœ… XSSé˜²æŠ¤ï¼ˆæŠ•ç¥¨ç•™è¨€ä½¿ç”¨bleachæ¸…æ´—ï¼‰
- âœ… é€Ÿç‡é™åˆ¶ï¼ˆé˜²æ­¢åˆ·ç¥¨å’Œæ»¥ç”¨ï¼‰
- âœ… æ•°æ®éªŒè¯ï¼ˆPydantic Schemaï¼‰

### 3. æ€§èƒ½ä¼˜åŒ–
- âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼ˆå•åˆ— + å¤åˆç´¢å¼•ï¼‰
- âœ… åˆ†é¡µåŠ è½½ï¼ˆå‡å°‘å•æ¬¡æ•°æ®é‡ï¼‰
- âœ… æœç´¢é˜²æŠ–ï¼ˆå‡å°‘APIè¯·æ±‚ï¼‰
- âœ… å›¾ç‰‡æ‡’åŠ è½½
- âœ… æŸ¥è¯¢ä¼˜åŒ–ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰

### 4. ç”¨æˆ·ä½“éªŒ
- âœ… å“åº”å¼è®¾è®¡
- âœ… åŠ è½½çŠ¶æ€æç¤º
- âœ… é”™è¯¯å¤„ç†å’Œå‹å¥½æç¤º
- âœ… ç©ºçŠ¶æ€å±•ç¤º
- âœ… å¹³æ»‘æ»šåŠ¨
- âœ… å›¾ç‰‡é¢„è§ˆ
- âœ… å®æ—¶æ›´æ–°æŠ•ç¥¨æ•°

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„
1. **custom_leaderboards** (è‡ªå®šä¹‰æ’è¡Œæ¦œè¡¨)
   - ä¸»é”®ï¼šid
   - å”¯ä¸€çº¦æŸï¼šname + location
   - å¤–é”®ï¼šapplicant_id â†’ users.id, reviewed_by â†’ admin_users.id
   - ç´¢å¼•ï¼šstatus, location, vote_count, created_at, å¤åˆç´¢å¼•

2. **leaderboard_items** (æ’è¡Œæ¦œç«å“è¡¨)
   - ä¸»é”®ï¼šid
   - å”¯ä¸€çº¦æŸï¼šleaderboard_id + name
   - å¤–é”®ï¼šleaderboard_id â†’ custom_leaderboards.id, submitted_by â†’ users.id
   - ç´¢å¼•ï¼šleaderboard_id, vote_score, status, created_at, å¤åˆç´¢å¼•

3. **leaderboard_votes** (æŠ•ç¥¨è®°å½•è¡¨)
   - ä¸»é”®ï¼šid
   - å”¯ä¸€çº¦æŸï¼šitem_id + user_id
   - å¤–é”®ï¼šitem_id â†’ leaderboard_items.id, user_id â†’ users.id
   - ç´¢å¼•ï¼šitem_id, user_id, created_at, å¤åˆç´¢å¼•

## ğŸ”§ æŠ€æœ¯æ ˆ

### åç«¯
- FastAPI
- SQLAlchemy (å¼‚æ­¥ORM)
- PostgreSQL
- Pydantic (æ•°æ®éªŒè¯)
- Bleach (XSSé˜²æŠ¤)
- Redis (é€Ÿç‡é™åˆ¶ï¼Œå¯é€‰)

### å‰ç«¯
- React + TypeScript
- Ant Design (UIç»„ä»¶åº“)
- React Router (è·¯ç”±)
- Axios (HTTPå®¢æˆ·ç«¯)
- Image Compression (å›¾ç‰‡å‹ç¼©)

## ğŸ“ APIæ–‡æ¡£

### å…¬å¼€æ¥å£
- `GET /api/custom-leaderboards` - è·å–æ¦œå•åˆ—è¡¨
- `GET /api/custom-leaderboards/{id}` - è·å–æ¦œå•è¯¦æƒ…
- `GET /api/custom-leaderboards/{id}/items` - è·å–ç«å“åˆ—è¡¨

### ç”¨æˆ·æ¥å£ï¼ˆéœ€è¦ç™»å½•ï¼‰
- `POST /api/custom-leaderboards/apply` - ç”³è¯·åˆ›å»ºæ¦œå•
- `POST /api/custom-leaderboards/items` - æ–°å¢ç«å“
- `POST /api/custom-leaderboards/items/{id}/vote` - æŠ•ç¥¨

### ç®¡ç†å‘˜æ¥å£ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
- `GET /api/custom-leaderboards/admin/all` - è·å–æ‰€æœ‰çŠ¶æ€çš„æ¦œå•
- `POST /api/custom-leaderboards/{id}/review` - å®¡æ ¸æ¦œå•
- `GET /api/custom-leaderboards/admin/votes` - æŸ¥çœ‹æŠ•ç¥¨è®°å½•

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. æ•°æ®åº“è¿ç§»
è¿ç§»æ–‡ä»¶ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼ˆå¦‚æœå¯ç”¨äº†`AUTO_MIGRATE`ç¯å¢ƒå˜é‡ï¼‰ã€‚

æ‰‹åŠ¨æ‰§è¡Œï¼š
```bash
psql $DATABASE_URL -f backend/migrations/026_add_custom_leaderboards.sql
```

### 2. ç¯å¢ƒå˜é‡
æ— éœ€é¢å¤–é…ç½®ï¼Œä½¿ç”¨ç°æœ‰é…ç½®å³å¯ã€‚

### 3. ä¾èµ–
æ‰€æœ‰ä¾èµ–å·²åœ¨ç°æœ‰é¡¹ç›®ä¸­ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **æŸ¥è¯¢æ€§èƒ½**ï¼šä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–ï¼ŒæŸ¥è¯¢æ—¶é—´ < 100ms
- **åˆ†é¡µåŠ è½½**ï¼šé»˜è®¤20æ¡/é¡µï¼Œæ”¯æŒå¿«é€Ÿè·³è½¬
- **å›¾ç‰‡ä¸Šä¼ **ï¼šè‡ªåŠ¨å‹ç¼©åˆ°1MBä»¥å†…
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢æ»¥ç”¨ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§

## ğŸ¨ UI/UXç‰¹æ€§

- **å“åº”å¼è®¾è®¡**ï¼šé€‚é…æ¡Œé¢å’Œç§»åŠ¨ç«¯
- **åŠ è½½çŠ¶æ€**ï¼šSpinç»„ä»¶æä¾›åŠ è½½åé¦ˆ
- **ç©ºçŠ¶æ€**ï¼šå‹å¥½çš„ç©ºæ•°æ®æç¤º
- **é”™è¯¯å¤„ç†**ï¼šæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- **å›¾ç‰‡é¢„è§ˆ**ï¼šæ”¯æŒå¤šå›¾é¢„è§ˆå’Œæ”¾å¤§
- **æ’åå±•ç¤º**ï¼šå‰3åç‰¹æ®Šæ ‡è¯†ï¼ˆğŸ†ï¼‰

## ğŸ”’ å®‰å…¨æªæ–½

1. **è®¤è¯æˆæƒ**ï¼šæ‰€æœ‰å†™æ“ä½œéœ€è¦ç™»å½•
2. **CSRFä¿æŠ¤**ï¼šPOSTè¯·æ±‚éœ€è¦CSRF token
3. **XSSé˜²æŠ¤**ï¼šæŠ•ç¥¨ç•™è¨€ä½¿ç”¨bleachæ¸…æ´—
4. **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢åˆ·ç¥¨å’Œæ»¥ç”¨
5. **æ•°æ®éªŒè¯**ï¼šPydantic SchemaéªŒè¯
6. **SQLæ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨ORMå‚æ•°åŒ–æŸ¥è¯¢

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `æ’è¡Œæ¦œæ‰©å±•å¼€å‘æ–‡æ¡£.md` - è¯¦ç»†å¼€å‘æ–‡æ¡£
- `backend/migrations/026_add_custom_leaderboards.sql` - æ•°æ®åº“è¿ç§»æ–‡ä»¶

## âœ¨ æœªæ¥æ‰©å±•å»ºè®®

1. **ç«å“å®¡æ ¸æµç¨‹**ï¼šå½“å‰è‡ªåŠ¨é€šè¿‡ï¼Œæœªæ¥å¯æ·»åŠ å®¡æ ¸
2. **è¯„è®ºç³»ç»Ÿ**ï¼šä¸ºç«å“æ·»åŠ è¯„è®ºåŠŸèƒ½
3. **åˆ†äº«åŠŸèƒ½**ï¼šæ”¯æŒåˆ†äº«æ¦œå•åˆ°ç¤¾äº¤åª’ä½“
4. **æ•°æ®å¯¼å‡º**ï¼šæ”¯æŒå¯¼å‡ºæ¦œå•æ•°æ®
5. **ç»Ÿè®¡åˆ†æ**ï¼šæ·»åŠ æ›´è¯¦ç»†çš„ç»Ÿè®¡å›¾è¡¨
6. **æ¨èç³»ç»Ÿ**ï¼šåŸºäºç”¨æˆ·è¡Œä¸ºçš„æ¨èç®—æ³•

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å¼€å‘å®Œæˆäº†å®Œæ•´çš„è‡ªå®šä¹‰æ’è¡Œæ¦œç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
- âœ… å®Œæ•´çš„åç«¯APIï¼ˆ8ä¸ªä¸»è¦æ¥å£ï¼‰
- âœ… å®Œå–„çš„å‰ç«¯ç•Œé¢ï¼ˆ2ä¸ªä¸»è¦é¡µé¢ï¼‰
- âœ… æ•°æ®åº“è®¾è®¡å’Œè¿ç§»
- âœ… å®‰å…¨é˜²æŠ¤å’Œæ€§èƒ½ä¼˜åŒ–
- âœ… ç”¨æˆ·ä½“éªŒä¼˜åŒ–

æ‰€æœ‰åŠŸèƒ½å·²é€šè¿‡ä»£ç å®¡æŸ¥å’Œlinteræ£€æŸ¥ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•å’Œéƒ¨ç½²ã€‚

---

**å¼€å‘å®Œæˆæ—¶é—´**ï¼š2025-01-XX  
**å¼€å‘äººå‘˜**ï¼šAI Assistant  
**ç‰ˆæœ¬**ï¼šv1.0.0

