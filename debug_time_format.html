<!DOCTYPE html>
<html>
<head>
    <title>时间格式调试</title>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/timezone.js"></script>
</head>
<body>
    <h1>时间格式调试工具</h1>
    <div id="output"></div>

    <script>
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);

        function formatLastMessageTime(utcTimeString, userTimezone = 'Europe/London') {
            if (!utcTimeString) return '';
            
            try {
                console.log('输入时间字符串:', utcTimeString);
                
                // 确保正确解析UTC时间
                let utcTime;
                if (utcTimeString.endsWith('Z')) {
                    utcTime = dayjs.utc(utcTimeString);
                } else {
                    utcTime = dayjs.utc(utcTimeString + 'Z');
                }
                
                console.log('解析后UTC时间:', utcTime.format());
                
                // 转换为用户时区
                const messageTime = utcTime.tz(userTimezone);
                const now = dayjs().tz(userTimezone);
                
                console.log('用户时区时间:', messageTime.format());
                console.log('当前时间:', now.format());
                
                // 计算时间差
                const diffInMinutes = now.diff(messageTime, 'minute');
                const diffInHours = now.diff(messageTime, 'hour');
                const diffInDays = now.diff(messageTime, 'day');
                
                console.log(`时间差: ${diffInMinutes}分钟, ${diffInHours}小时, ${diffInDays}天`);
                
                // 根据时间差显示不同格式
                if (diffInMinutes < 1) {
                    return '刚刚';
                } else if (diffInMinutes < 60) {
                    return `${diffInMinutes}分钟前`;
                } else if (diffInHours < 24) {
                    return `${diffInHours}小时前`;
                } else if (diffInDays < 7) {
                    return `${diffInDays}天前`;
                } else {
                    return messageTime.format('MM/DD');
                }
            } catch (error) {
                console.error('最后消息时间格式化错误:', error);
                return utcTimeString;
            }
        }

        // 测试不同时间格式
        const now = new Date();
        const testTimes = [
            // 标准ISO格式
            now.toISOString(),
            // 数据库可能返回的格式（无Z）
            now.toISOString().replace('Z', ''),
            // 几分钟前
            new Date(now.getTime() - 5 * 60 * 1000).toISOString(),
            // 1小时前
            new Date(now.getTime() - 60 * 60 * 1000).toISOString(),
            // 30秒前
            new Date(now.getTime() - 30 * 1000).toISOString(),
        ];

        const output = document.getElementById('output');
        testTimes.forEach((timeStr, index) => {
            const result = formatLastMessageTime(timeStr);
            const div = document.createElement('div');
            div.innerHTML = `<strong>测试 ${index + 1}:</strong> ${timeStr} → ${result}`;
            div.style.margin = '10px 0';
            div.style.padding = '10px';
            div.style.border = '1px solid #ccc';
            output.appendChild(div);
        });
    </script>
</body>
</html>
