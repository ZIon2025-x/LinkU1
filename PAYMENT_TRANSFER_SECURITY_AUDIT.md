# æ”¯ä»˜å’Œè½¬è´¦å®‰å…¨å®¡è®¡æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å…¨é¢å®¡è®¡æ”¯ä»˜æµç¨‹å’Œä»»åŠ¡å®Œæˆåçš„è½¬è´¦æµç¨‹ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´ã€é‡å¤æ”¯ä»˜/è½¬è´¦é£é™©ã€é‡‘é¢è®¡ç®—é”™è¯¯ç­‰é—®é¢˜ã€‚

## âœ… å·²æ£€æŸ¥çš„åŠŸèƒ½

### 1. æ”¯ä»˜æµç¨‹ âœ…

#### Webhook å¤„ç† (`routers.py:3978-4227`)

**æ”¯ä»˜æˆåŠŸå¤„ç†** (`payment_intent.succeeded`):
- âœ… å¹‚ç­‰æ€§æ£€æŸ¥ï¼š`if task and not task.is_paid`
- âœ… æ›´æ–° `is_paid = 1`
- âœ… ä¿å­˜ `payment_intent_id`
- âœ… è®¡ç®— `escrow_amount = ä»»åŠ¡é‡‘é¢ - å¹³å°æœåŠ¡è´¹`
- âœ… å¤„ç† `pending_approval` æ ‡è®°ï¼ˆæ‰¹å‡†ç”³è¯·ï¼‰
- âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼š`pending_payment` â†’ `in_progress`
- âœ… åˆ›å»º/æ›´æ–° `PaymentHistory` è®°å½•ï¼ˆç”¨äºå®¡è®¡ï¼‰

**æ”¯ä»˜å¤±è´¥å¤„ç†** (`payment_intent.payment_failed`):
- âœ… æ’¤é”€ç”³è¯·æ‰¹å‡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- âœ… æ¢å¤ä»»åŠ¡çŠ¶æ€ä¸º `open`
- âœ… æ¸…é™¤ `payment_intent_id`
- âœ… å‘é€é€šçŸ¥ç»™ç”³è¯·è€…å’Œå‘å¸ƒè€…

**PaymentIntent å–æ¶ˆå¤„ç†** (`payment_intent.canceled`):
- âœ… æ¸…é™¤ `payment_intent_id`ï¼Œå…è®¸é‡æ–°åˆ›å»ºæ”¯ä»˜
- âœ… ä¿æŒ `pending_payment` çŠ¶æ€ï¼Œç­‰å¾…è¶…æ—¶å¤„ç†

**å®‰å…¨æ€§**:
- âœ… å¹‚ç­‰æ€§æ£€æŸ¥é˜²æ­¢é‡å¤å¤„ç†
- âœ… Webhook ç­¾åéªŒè¯
- âœ… äº‹ä»¶ ID å»é‡ï¼ˆé€šè¿‡ `WebhookEvent` è¡¨ï¼‰

### 2. è½¬è´¦æµç¨‹ âœ…

#### è½¬è´¦è§¦å‘ (`routers.py:2413-2486`)

**è½¬è´¦æ¡ä»¶æ£€æŸ¥**:
- âœ… `task.is_paid == 1` - ä»»åŠ¡å·²æ”¯ä»˜
- âœ… `task.is_confirmed == 0` - ä»»åŠ¡æœªç¡®è®¤ï¼ˆé˜²æ­¢é‡å¤è½¬è´¦ï¼‰
- âœ… `task.taker_id` - æœ‰ä»»åŠ¡æ¥å—äºº
- âœ… `task.escrow_amount > 0` - æ‰˜ç®¡é‡‘é¢å¤§äº0

**é‡å¤è½¬è´¦é˜²æŠ¤**:
- âœ… **å·²ä¿®å¤**ï¼šåœ¨åˆ›å»ºè½¬è´¦è®°å½•å‰æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆåŠŸçš„è½¬è´¦è®°å½•
- âœ… **å·²ä¿®å¤**ï¼šåœ¨åˆ›å»ºè½¬è´¦è®°å½•å‰æ£€æŸ¥æ˜¯å¦å·²æœ‰å¾…å¤„ç†çš„è½¬è´¦è®°å½•ï¼ˆ`pending` æˆ– `retrying`ï¼‰
- âœ… å¦‚æœå·²æœ‰æˆåŠŸè½¬è´¦ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆå¯èƒ½æ˜¯ webhook å»¶è¿Ÿï¼‰
- âœ… å¦‚æœå·²æœ‰å¾…å¤„ç†è½¬è´¦ï¼Œä½¿ç”¨ç°æœ‰è®°å½•æ‰§è¡Œè½¬è´¦

**è½¬è´¦æ‰§è¡Œ** (`payment_transfer_service.py:65-243`):
- âœ… æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼š`is_confirmed == 1 && escrow_amount == 0` æ—¶è·³è¿‡
- âœ… æ£€æŸ¥æ˜¯å¦æœ‰æˆåŠŸçš„è½¬è´¦è®°å½•
- âœ… éªŒè¯ Stripe Connect è´¦æˆ·çŠ¶æ€ï¼ˆ`details_submitted`, `charges_enabled`ï¼‰
- âœ… æ£€æŸ¥ä¸»è´¦æˆ·å¯ç”¨ä½™é¢ï¼ˆä»…ç”¨äºæ—¥å¿—ï¼‰
- âœ… åˆ›å»º Stripe Transfer
- âœ… æ›´æ–°è½¬è´¦è®°å½•çŠ¶æ€ä¸º `pending`ï¼ˆç­‰å¾… webhook ç¡®è®¤ï¼‰
- âœ… ä¸ç«‹å³æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆç­‰å¾… webhook ç¡®è®¤ï¼‰

**è½¬è´¦ Webhook å¤„ç†** (`routers.py:4495-4613`):

**è½¬è´¦æˆåŠŸ** (`transfer.paid`):
- âœ… å¹‚ç­‰æ€§æ£€æŸ¥ï¼š`if transfer_record.status == "succeeded"`
- âœ… æ›´æ–°è½¬è´¦è®°å½•çŠ¶æ€ä¸º `succeeded`
- âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼š`is_confirmed = 1`, `paid_to_user_id = taker_id`, `escrow_amount = 0`
- âœ… å‘é€é€šçŸ¥ç»™ä»»åŠ¡æ¥å—äºº
- âœ… è®°å½•æˆåŠŸæ—¶é—´

**è½¬è´¦å¤±è´¥** (`transfer.failed`):
- âœ… æ›´æ–°è½¬è´¦è®°å½•çŠ¶æ€ä¸º `failed`
- âœ… è®°å½•å¤±è´¥åŸå› 
- âœ… ä¸æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆä¿æŒåŸçŠ¶ï¼Œç­‰å¾…é‡è¯•ï¼‰

**è½¬è´¦é‡è¯•æœºåˆ¶** (`payment_transfer_service.py:246-318`):
- âœ… æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ï¼ˆ1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿã€1å°æ—¶ã€4å°æ—¶ã€24å°æ—¶ï¼‰
- âœ… æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶ï¼ˆ6æ¬¡ï¼‰
- âœ… æ£€æŸ¥æ˜¯å¦åˆ°é‡è¯•æ—¶é—´
- âœ… éªŒè¯ Stripe Connect è´¦æˆ·çŠ¶æ€
- âœ… æ›´æ–°é‡è¯•æ¬¡æ•°å’Œä¸‹æ¬¡é‡è¯•æ—¶é—´

**å®šæ—¶ä»»åŠ¡å¤„ç†** (`payment_transfer_service.py:411-479`):
- âœ… å¤„ç†å¾…å¤„ç†çš„è½¬è´¦è®°å½•
- âœ… å¤„ç†éœ€è¦é‡è¯•çš„è½¬è´¦è®°å½•
- âœ… æ£€æŸ¥è½¬è´¦è¶…æ—¶ï¼ˆ24å°æ—¶ï¼‰

### 3. é‡‘é¢è®¡ç®— âœ…

#### æ‰˜ç®¡é‡‘é¢è®¡ç®— (`escrow_amount`)

**æ”¯ä»˜æ—¶è®¡ç®—** (`routers.py:4003-4006`):
```python
task_amount = float(task.agreed_reward) if task.agreed_reward is not None else float(task.base_reward)
application_fee = application_fee_pence / 100.0
taker_amount = task_amount - application_fee
task.escrow_amount = max(0.0, taker_amount)  # ç¡®ä¿ä¸ä¸ºè´Ÿæ•°
```

**è½¬è´¦æ—¶éªŒè¯** (`routers.py:2419-2426`):
- âœ… å¦‚æœ `escrow_amount <= 0`ï¼Œé‡æ–°è®¡ç®—
- âœ… ä½¿ç”¨ç›¸åŒçš„è®¡ç®—å…¬å¼ç¡®ä¿ä¸€è‡´æ€§

**å®‰å…¨æ€§**:
- âœ… ç¡®ä¿ `escrow_amount` ä¸ä¸ºè´Ÿæ•°
- âœ… å¹³å°æœåŠ¡è´¹æ­£ç¡®æ‰£é™¤
- âœ… è½¬è´¦é‡‘é¢ä½¿ç”¨ `escrow_amount`ï¼ˆå·²æ‰£é™¤æœåŠ¡è´¹ï¼‰

### 4. å¹¶å‘å®‰å…¨ âœ…

**è½¬è´¦è®°å½•åˆ›å»º**:
- âœ… æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆåŠŸçš„è½¬è´¦è®°å½•ï¼ˆé˜²æ­¢é‡å¤è½¬è´¦ï¼‰
- âœ… æ£€æŸ¥æ˜¯å¦å·²æœ‰å¾…å¤„ç†çš„è½¬è´¦è®°å½•ï¼ˆé˜²æ­¢é‡å¤åˆ›å»ºï¼‰

**è½¬è´¦æ‰§è¡Œ**:
- âœ… æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å’Œè½¬è´¦è®°å½•çŠ¶æ€
- âœ… ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿åŸå­æ€§

**Webhook å¤„ç†**:
- âœ… å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé€šè¿‡ `WebhookEvent` è¡¨ï¼‰
- âœ… è½¬è´¦è®°å½•çŠ¶æ€æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰

## ğŸ”´ å‘ç°çš„é—®é¢˜å’Œä¿®å¤

### 1. é‡å¤è½¬è´¦é£é™© âš ï¸

**é—®é¢˜æè¿°**:
- åœ¨ `confirm_completion` ä¸­ï¼Œå¦‚æœå¤šæ¬¡è°ƒç”¨ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤šä¸ªè½¬è´¦è®°å½•
- è™½ç„¶æ£€æŸ¥äº† `is_confirmed == 0`ï¼Œä½†åœ¨åˆ›å»ºè½¬è´¦è®°å½•å‰æ²¡æœ‰æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆåŠŸçš„è½¬è´¦è®°å½•

**é£é™©ç­‰çº§**: ğŸŸ¡ **ä¸­ç­‰**

**ä¿®å¤çŠ¶æ€**: âœ… **å·²ä¿®å¤**
- åœ¨åˆ›å»ºè½¬è´¦è®°å½•å‰æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆåŠŸçš„è½¬è´¦è®°å½•
- åœ¨åˆ›å»ºè½¬è´¦è®°å½•å‰æ£€æŸ¥æ˜¯å¦å·²æœ‰å¾…å¤„ç†çš„è½¬è´¦è®°å½•
- å¦‚æœå·²æœ‰æˆåŠŸè½¬è´¦ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆå¯èƒ½æ˜¯ webhook å»¶è¿Ÿï¼‰
- å¦‚æœå·²æœ‰å¾…å¤„ç†è½¬è´¦ï¼Œä½¿ç”¨ç°æœ‰è®°å½•æ‰§è¡Œè½¬è´¦

**ä¿®å¤ä½ç½®**: `backend/app/routers.py:2413-2486`

### 2. è½¬è´¦è®°å½•é‡å¤åˆ›å»ºé£é™© âš ï¸

**é—®é¢˜æè¿°**:
- å¦‚æœä»»åŠ¡æ¥å—äººæ²¡æœ‰ Stripe Connect è´¦æˆ·ï¼Œæ¯æ¬¡è°ƒç”¨ `confirm_completion` éƒ½ä¼šåˆ›å»ºæ–°çš„è½¬è´¦è®°å½•

**é£é™©ç­‰çº§**: ğŸŸ¡ **ä¸­ç­‰**

**ä¿®å¤çŠ¶æ€**: âœ… **å·²ä¿®å¤**
- åœ¨åˆ›å»ºè½¬è´¦è®°å½•å‰æ£€æŸ¥æ˜¯å¦å·²æœ‰å¾…å¤„ç†çš„è½¬è´¦è®°å½•
- å¦‚æœå·²æœ‰å¾…å¤„ç†è½¬è´¦ï¼Œè·³è¿‡åˆ›å»ºæ–°è®°å½•

**ä¿®å¤ä½ç½®**: `backend/app/routers.py:2432-2447`

## âœ… å®‰å…¨æªæ–½æ€»ç»“

### æ”¯ä»˜æµç¨‹å®‰å…¨æªæ–½

1. **å¹‚ç­‰æ€§ä¿æŠ¤**:
   - Webhook äº‹ä»¶ ID å»é‡ï¼ˆ`WebhookEvent` è¡¨ï¼‰
   - æ”¯ä»˜çŠ¶æ€æ£€æŸ¥ï¼ˆ`is_paid`ï¼‰
   - ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ï¼ˆ`pending_payment`ï¼‰

2. **é‡‘é¢éªŒè¯**:
   - ç¡®ä¿ `escrow_amount` ä¸ä¸ºè´Ÿæ•°
   - å¹³å°æœåŠ¡è´¹æ­£ç¡®æ‰£é™¤
   - é‡‘é¢è®¡ç®—ä¸€è‡´æ€§æ£€æŸ¥

3. **çŠ¶æ€ä¸€è‡´æ€§**:
   - æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€
   - æ”¯ä»˜å¤±è´¥åæ¢å¤ä»»åŠ¡çŠ¶æ€
   - PaymentIntent å–æ¶ˆåæ¸…é™¤ `payment_intent_id`

### è½¬è´¦æµç¨‹å®‰å…¨æªæ–½

1. **é‡å¤è½¬è´¦é˜²æŠ¤**:
   - æ£€æŸ¥ `is_confirmed == 0`ï¼ˆä»»åŠ¡æœªç¡®è®¤ï¼‰
   - æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆåŠŸçš„è½¬è´¦è®°å½•
   - æ£€æŸ¥æ˜¯å¦å·²æœ‰å¾…å¤„ç†çš„è½¬è´¦è®°å½•
   - Webhook å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆè½¬è´¦è®°å½•çŠ¶æ€ï¼‰

2. **è´¦æˆ·éªŒè¯**:
   - éªŒè¯ Stripe Connect è´¦æˆ·å­˜åœ¨
   - éªŒè¯è´¦æˆ·çŠ¶æ€ï¼ˆ`details_submitted`, `charges_enabled`ï¼‰
   - æ£€æŸ¥ä¸»è´¦æˆ·å¯ç”¨ä½™é¢ï¼ˆä»…ç”¨äºæ—¥å¿—ï¼‰

3. **é”™è¯¯å¤„ç†å’Œé‡è¯•**:
   - è½¬è´¦å¤±è´¥åè‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
   - æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶
   - è½¬è´¦è¶…æ—¶æ£€æŸ¥ï¼ˆ24å°æ—¶ï¼‰
   - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

4. **çŠ¶æ€ä¸€è‡´æ€§**:
   - è½¬è´¦æˆåŠŸåæ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆé€šè¿‡ webhookï¼‰
   - è½¬è´¦å¤±è´¥åä¸æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆç­‰å¾…é‡è¯•ï¼‰
   - è½¬è´¦è®°å½•çŠ¶æ€ä¸ä»»åŠ¡çŠ¶æ€åŒæ­¥

## ğŸ“Š å®¡è®¡ç»“è®º

### æ”¯ä»˜æµç¨‹ âœ…

- âœ… æ”¯ä»˜æµç¨‹å®‰å…¨å¯é 
- âœ… å¹‚ç­‰æ€§ä¿æŠ¤å®Œå–„
- âœ… é‡‘é¢è®¡ç®—æ­£ç¡®
- âœ… çŠ¶æ€æ›´æ–°åŠæ—¶

### è½¬è´¦æµç¨‹ âœ…

- âœ… è½¬è´¦æµç¨‹å®‰å…¨å¯é 
- âœ… é‡å¤è½¬è´¦é˜²æŠ¤å®Œå–„ï¼ˆå·²ä¿®å¤ï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶å®Œå–„
- âœ… çŠ¶æ€ä¸€è‡´æ€§è‰¯å¥½

### æ€»ä½“è¯„ä¼°

**å®‰å…¨æ€§**: âœ… **è‰¯å¥½**
- æ‰€æœ‰å…³é”®æµç¨‹éƒ½æœ‰é€‚å½“çš„å®‰å…¨æªæ–½
- å·²ä¿®å¤é‡å¤è½¬è´¦é£é™©
- å¹‚ç­‰æ€§ä¿æŠ¤å®Œå–„
- é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

**å»ºè®®**:
- å®šæœŸæ£€æŸ¥è½¬è´¦è¶…æ—¶è®°å½•
- ç›‘æ§è½¬è´¦å¤±è´¥ç‡
- å®šæœŸå®¡è®¡è½¬è´¦è®°å½•

## ç›¸å…³æ–‡ä»¶

- `backend/app/routers.py` - Webhook å¤„ç†å’Œè½¬è´¦è§¦å‘
- `backend/app/payment_transfer_service.py` - è½¬è´¦æ‰§è¡Œå’Œé‡è¯•é€»è¾‘
- `backend/app/models.py` - æ•°æ®æ¨¡å‹ï¼ˆ`PaymentTransfer`, `PaymentHistory`, `WebhookEvent`ï¼‰
- `backend/app/celery_tasks.py` - å®šæ—¶ä»»åŠ¡ï¼ˆè½¬è´¦é‡è¯•ï¼‰
