# 排行榜待开发功能清单

## 📋 概述

本文档列出了排行榜扩展开发文档中标记为"后续优化"和"优化建议"的功能，需要继续开发。

**检查日期**：2024年  
**文档版本**：2.3

---

## ✅ 已完成的功能

### 1. ★★★★★ 投票高并发"丢票"问题 ✅
- **状态**：已修复
- **实现**：使用数据库原子更新
- **文件**：`backend/app/custom_leaderboard_routes.py`

### 2. ★★★★☆ 投票留言长度限制 + 后端清洗 ✅
- **状态**：已实现
- **实现**：
  - 数据库层：`CheckConstraint('LENGTH(comment) <= 500')`
  - 后端清洗：`bleach.clean(comment, tags=[], strip=True)`
  - 前端限制：`maxLength={500}`

### 3. ★★★☆☆ vote_count 统计字段加索引 ✅
- **状态**：已实现
- **实现**：`Index('idx_leaderboard_vote_count', 'vote_count')`

### 4. ★★☆☆☆ 管理员后台投票记录搜索优化 ✅
- **状态**：已实现
- **实现**：`/admin/votes` 接口支持 `keyword` 参数

### 5. 留言点赞功能 ✅
- **状态**：已实现
- **实现**：
  - 数据模型：`VoteCommentLike` 表
  - 后端API：`POST /api/custom-leaderboards/votes/{vote_id}/like`
  - 前端界面：留言列表中添加点赞按钮

### 6. 留言列表只显示有留言的投票 ✅
- **状态**：已实现
- **实现**：后端API过滤 `comment.isnot(None)` 和 `comment != ''`

---

## ⚠️ 待开发的功能

### 1. ★★★★☆ 竞品图片上传功能 ⚠️

**优先级**：★★★★☆（V2必须品）

**当前状态**：
- ✅ 前端已实现图片上传功能（`CustomLeaderboardDetail.tsx`）
- ✅ 后端已支持 `images` 字段（JSON存储）
- ⚠️ 但文档标记为"V2必须品"，需要确认是否作为V1功能上线

**需要确认**：
- [ ] 是否作为V1功能上线？
- [ ] 图片上传流程是否需要优化？

**参考实现**：
- 前端已使用 `/api/upload/public-image` 接口
- 可以参考跳蚤市场的图片上传实现

---

### 2. ★★★★☆ 榜单/竞品举报功能 📋

**优先级**：★★★★☆（社区自净必备）

**必要性**：必然会出现恶意榜单、虚假餐厅、刷票等，需要社区自净机制。

**需要实现**：

#### 2.1 数据库设计
- [ ] 创建 `leaderboard_reports` 表（榜单举报表）
- [ ] 创建 `item_reports` 表（竞品举报表）
- [ ] 创建数据库迁移文件

#### 2.2 后端API
- [ ] `POST /api/custom-leaderboards/{id}/report` - 举报榜单
- [ ] `POST /api/custom-leaderboards/items/{id}/report` - 举报竞品
- [ ] `GET /api/custom-leaderboards/admin/reports` - 管理员查看举报列表
- [ ] `POST /api/custom-leaderboards/admin/reports/{id}/review` - 管理员处理举报

#### 2.3 前端界面
- [ ] 榜单详情页添加"举报"按钮
- [ ] 竞品详情页添加"举报"按钮
- [ ] 举报弹窗（选择举报原因、填写描述）
- [ ] 管理员后台举报管理页面

**参考实现**：
- 跳蚤市场已有举报功能（`FleaMarketReport`）
- 论坛已有举报功能（`ForumReport`）

**数据库设计参考**：
```python
# 榜单举报表
class LeaderboardReport(Base):
    __tablename__ = "leaderboard_reports"
    
    id = Column(Integer, primary_key=True)
    leaderboard_id = Column(Integer, ForeignKey("custom_leaderboards.id"), nullable=False)
    reporter_id = Column(String(8), ForeignKey("users.id"), nullable=False)
    reason = Column(String(500), nullable=False)  # 举报原因
    status = Column(String(20), default="pending")  # pending, reviewed, dismissed
    reviewed_by = Column(String(36), ForeignKey("admin_users.id"), nullable=True)
    reviewed_at = Column(DateTime(timezone=True), nullable=True)
    created_at = Column(DateTime(timezone=True), default=get_utc_time)
    
    __table_args__ = (
        UniqueConstraint('leaderboard_id', 'reporter_id', name='uq_leaderboard_report'),
    )

# 竞品举报表
class ItemReport(Base):
    __tablename__ = "item_reports"
    
    id = Column(Integer, primary_key=True)
    item_id = Column(Integer, ForeignKey("leaderboard_items.id"), nullable=False)
    reporter_id = Column(String(8), ForeignKey("users.id"), nullable=False)
    reason = Column(String(500), nullable=False)
    status = Column(String(20), default="pending")
    reviewed_by = Column(String(36), ForeignKey("admin_users.id"), nullable=True)
    reviewed_at = Column(DateTime(timezone=True), nullable=True)
    created_at = Column(DateTime(timezone=True), default=get_utc_time)
    
    __table_args__ = (
        UniqueConstraint('item_id', 'reporter_id', name='uq_item_report'),
    )
```

---

### 3. ★★★☆☆ 匿名留言楼层式展示 📋

**优先级**：★★★☆☆（提升互动感）

**当前状态**：
- ✅ 留言列表已实现分页
- ✅ 匿名留言已显示"匿名用户"
- ⚠️ 但缺少楼层式展示（如"匿名用户 #7 · 3小时前"）

**需要实现**：
- [ ] 为匿名留言添加序号（#1, #2, #3...）
- [ ] 优化显示格式：`"匿名用户 #7 · 3小时前"`
- [ ] 前端显示时按时间顺序分配编号

**实现方式**：
```typescript
// 前端：在显示留言时，为匿名留言分配序号
let anonymousCount = 0;
votes.forEach((vote, index) => {
  if (vote.is_anonymous) {
    anonymousCount++;
    vote.displayName = `匿名用户 #${anonymousCount}`;
  }
});
```

---

### 4. ★★☆☆☆ 特性开关细化 📋

**优先级**：★★☆☆☆（灰度更灵活）

**当前状态**：没有找到特性开关的实现

**需要实现**：
- [ ] 在 `backend/app/config.py` 中添加特性开关
- [ ] 实现三个细化开关：
  - `CUSTOM_LEADERBOARD_ENABLED` - 整体开关
  - `CUSTOM_LEADERBOARD_ANONYMOUS_VOTE_ENABLED` - 匿名投票开关
  - `CUSTOM_LEADERBOARD_ITEM_IMAGE_ENABLED` - 图片上传开关
- [ ] 前端根据开关显示/隐藏功能

**实现方式**：
```python
# backend/app/config.py
CUSTOM_LEADERBOARD_ENABLED = os.getenv("CUSTOM_LEADERBOARD_ENABLED", "true") == "true"
CUSTOM_LEADERBOARD_ANONYMOUS_VOTE_ENABLED = os.getenv("CUSTOM_LEADERBOARD_ANONYMOUS_VOTE_ENABLED", "true") == "true"
CUSTOM_LEADERBOARD_ITEM_IMAGE_ENABLED = os.getenv("CUSTOM_LEADERBOARD_ITEM_IMAGE_ENABLED", "false") == "true"
```

---

### 5. 投票记录管理界面（管理员后台）📋

**优先级**：★★★☆☆（可选/后续）

**当前状态**：
- ✅ 已有管理员查看投票记录API（`/admin/votes`）
- ⚠️ 但缺少前端管理界面

**需要实现**：
- [ ] 管理员后台添加"投票记录管理"页面
- [ ] 表格展示投票记录
- [ ] 支持筛选（按竞品ID、榜单ID、是否匿名）
- [ ] 支持搜索（用户名/留言内容）
- [ ] 显示匿名标识
- [ ] 支持导出功能（可选）

---

### 6. 其他优化建议 📋

#### 6.1 前端投票后局部更新（可选/后续）
- **当前状态**：投票后调用 `loadData()` 重新请求全部数据
- **优化方案**：使用返回的统计值局部更新，避免全量刷新
- **优先级**：低（等数据量增大时再优化）

#### 6.2 审核操作日志（后续优化）
- **当前状态**：已有基本审核信息（`reviewed_by`, `reviewed_at`, `review_comment`）
- **增强项**：如需更详细的操作审计，可增加 `admin_audit_logs` 表
- **优先级**：低（V1版本暂不实现）

#### 6.3 防刷票增强（后续增强项）
- **当前实现**：用户维度唯一 + 登录限制
- **未来增强**：
  - IP限制
  - 验证码
  - 频率限制（N秒内最多M次投票）
- **优先级**：低（根据实际使用情况决定）

---

## 📊 开发优先级排序

### 高优先级（建议立即开发）

1. **★★★★☆ 榜单/竞品举报功能**
   - 社区自净必备
   - 参考跳蚤市场和论坛的举报功能
   - 预计工作量：2-3天

2. **★★★★☆ 竞品图片上传功能确认**
   - 前端已实现，需要确认是否作为V1上线
   - 预计工作量：0.5天（确认）+ 优化（如需要）

### 中优先级（建议近期开发）

3. **★★★☆☆ 匿名留言楼层式展示**
   - 提升用户体验
   - 预计工作量：0.5天

4. **★★★☆☆ 投票记录管理界面**
   - 管理员后台功能
   - 预计工作量：1-2天

### 低优先级（可选优化）

5. **★★☆☆☆ 特性开关细化**
   - 灰度发布和降级需要
   - 预计工作量：0.5天

6. **其他优化建议**
   - 根据实际使用情况决定

---

## 🎯 开发建议

### 第一阶段：核心功能完善（1周）
1. ✅ 并发投票优化（已完成）
2. ✅ 留言点赞功能（已完成）
3. ⚠️ 榜单/竞品举报功能（待开发）
4. ⚠️ 竞品图片上传功能确认（待确认）

### 第二阶段：体验优化（3-5天）
1. ⚠️ 匿名留言楼层式展示
2. ⚠️ 投票记录管理界面

### 第三阶段：运营支持（2-3天）
1. ⚠️ 特性开关细化
2. ⚠️ 其他优化建议（按需）

---

## 📝 开发检查清单

### 举报功能开发清单
- [ ] 创建数据模型（`LeaderboardReport`, `ItemReport`）
- [ ] 创建数据库迁移文件
- [ ] 创建Schema定义
- [ ] 实现后端API接口
- [ ] 前端添加举报按钮
- [ ] 前端举报弹窗
- [ ] 管理员后台举报管理页面
- [ ] 测试举报流程

### 匿名留言楼层展示开发清单
- [ ] 后端API返回匿名序号（或前端计算）
- [ ] 前端显示格式优化
- [ ] 测试匿名留言显示

### 特性开关开发清单
- [ ] 后端添加配置项
- [ ] 前端读取配置
- [ ] 根据开关显示/隐藏功能
- [ ] 测试开关功能

---

## 📚 参考文档

- [排行榜扩展开发文档](./排行榜扩展开发文档.md)
- [排行榜开发完成度检查报告](./排行榜开发完成度检查报告.md)
- [并发投票优化修复说明](./并发投票优化修复说明.md)
- 跳蚤市场举报功能：`backend/app/flea_market_routes.py`
- 论坛举报功能：`backend/app/forum_routes.py`

---

**最后更新**：2024年  
**维护者**：LinkU开发团队

