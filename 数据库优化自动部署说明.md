# æ•°æ®åº“ä¼˜åŒ–æ‰‹åŠ¨éƒ¨ç½²è¯´æ˜

## ğŸ“‹ éƒ¨ç½²è¯´æ˜

æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ç´¢å¼•è¿ç§»éœ€è¦**æ‰‹åŠ¨æ‰§è¡Œ**ï¼Œä¸ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```env
# æœç´¢é…ç½®ï¼ˆæ¨èä½¿ç”¨ pg_trgmï¼‰
USE_PG_TRGM=true          # âœ… å¯ç”¨ pg_trgm æ‰©å±•ï¼ˆæ¨èï¼‰
# SEARCH_LANGUAGE=english  # âš ï¸ ä½¿ç”¨ pg_trgm æ—¶æ­¤é…ç½®ä¸èµ·ä½œç”¨
```

### 2. æ‰‹åŠ¨æ‰§è¡Œè¿ç§»

**éœ€è¦æ‰‹åŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬**ï¼š

#### æ–¹å¼1ï¼šä½¿ç”¨ psqlï¼ˆæ¨èï¼‰

```bash
psql $DATABASE_URL -f backend/migrations/add_performance_indexes.sql
```

#### æ–¹å¼2ï¼šåœ¨ Python ä¸­æ‰§è¡Œ

```python
from app.database import sync_engine
from app.db_migrations import run_migration_sync
run_migration_sync(sync_engine)
```

### 3. éªŒè¯éƒ¨ç½²

æ‰§è¡Œè¿ç§»åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨æ•°æ®åº“è¿ç§»...
ğŸš€ å¼€å§‹æ‰§è¡Œ add_performance_indexes.sql...
âœ… add_performance_indexes.sql è¿ç§»å®Œæˆ
âœ… è‡ªåŠ¨æ•°æ®åº“è¿ç§»å®Œæˆï¼
   æ€»è®¡ - æ‰§è¡Œ: XX, è·³è¿‡: XX, é”™è¯¯: 0
```

---

## âš ï¸ é‡è¦è¯´æ˜

1. **è¿ç§»éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ**ï¼šåº”ç”¨å¯åŠ¨æ—¶ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»
2. **å¹‚ç­‰æ€§**ï¼šè¿ç§»è„šæœ¬å¯ä»¥å®‰å…¨åœ°å¤šæ¬¡æ‰§è¡Œï¼Œå·²å­˜åœ¨çš„å¯¹è±¡ä¼šè¢«è·³è¿‡
3. **ä¹‹å‰çš„è¿ç§»è„šæœ¬å·²ç»æ‰§è¡Œè¿‡**ï¼šå½“å‰åªéœ€è¦æ‰§è¡Œ `add_performance_indexes.sql`

## ğŸ“‹ è¿ç§»è„šæœ¬åŒ…å«çš„å†…å®¹

### 1. PostgreSQL æ‰©å±•
- âœ… `pg_trgm` æ‰©å±•ï¼ˆç”¨äºç›¸ä¼¼åº¦æœç´¢ï¼‰

### 2. ä»»åŠ¡è¡¨ç´¢å¼•
- âœ… `ix_tasks_status_created_id` - æ¸¸æ ‡åˆ†é¡µç´¢å¼•
- âœ… `ix_tasks_type_location_status` - ç»„åˆæŸ¥è¯¢ç´¢å¼•
- âœ… `ix_tasks_poster_status_created` - ç”¨æˆ·å‘å¸ƒä»»åŠ¡ç´¢å¼•
- âœ… `ix_tasks_taker_status_created` - ç”¨æˆ·æ¥å—ä»»åŠ¡ç´¢å¼•
- âœ… `idx_tasks_title_trgm` - æ ‡é¢˜ç›¸ä¼¼åº¦æœç´¢ç´¢å¼•
- âœ… `idx_tasks_description_trgm` - æè¿°ç›¸ä¼¼åº¦æœç´¢ç´¢å¼•
- âœ… `idx_tasks_search` - å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆå¯é€‰ï¼‰

### 3. ç”³è¯·è¡¨ç´¢å¼•
- âœ… `ix_applications_applicant_created` - ç”³è¯·è€…æŸ¥è¯¢ç´¢å¼•
- âœ… `ix_applications_task_status` - ä»»åŠ¡ç”³è¯·çŠ¶æ€ç´¢å¼•

### 4. æ¶ˆæ¯è¡¨ä¼˜åŒ–
- âœ… `conversation_key` å­—æ®µï¼ˆè‡ªåŠ¨ç»´æŠ¤ï¼‰
- âœ… `ix_messages_conversation_created` - å¯¹è¯æŸ¥è¯¢ç´¢å¼•
- âœ… `ix_messages_receiver_created` - æ¥æ”¶è€…æŸ¥è¯¢ç´¢å¼•
- âœ… è‡ªåŠ¨è§¦å‘å™¨ï¼ˆç»´æŠ¤ conversation_keyï¼‰

### 5. é€šçŸ¥è¡¨ç´¢å¼•
- âœ… `ix_notifications_user_read_created` - ç”¨æˆ·é€šçŸ¥æŸ¥è¯¢ç´¢å¼•

---

## ğŸ” éªŒè¯ç´¢å¼•åˆ›å»º

éƒ¨ç½²åå¯ä»¥æ‰§è¡Œä»¥ä¸‹ SQL éªŒè¯ï¼š

```sql
-- æ£€æŸ¥ pg_trgm æ‰©å±•
SELECT * FROM pg_extension WHERE extname = 'pg_trgm';

-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦åˆ›å»º
SELECT 
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename IN ('tasks', 'task_applications', 'messages', 'notifications')
  AND (indexname LIKE 'ix_%' OR indexname LIKE 'idx_%')
ORDER BY tablename, indexname;

-- æ£€æŸ¥ conversation_key å­—æ®µ
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'messages' AND column_name = 'conversation_key';

-- æ£€æŸ¥è§¦å‘å™¨
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers
WHERE event_object_table = 'messages' 
  AND trigger_name LIKE '%conversation%';
```

---

## âš ï¸ é‡è¦è¯´æ˜

### 1. å¹‚ç­‰æ€§

æ‰€æœ‰è¿ç§»è„šæœ¬éƒ½ä½¿ç”¨äº† `IF NOT EXISTS` æˆ– `CREATE OR REPLACE`ï¼Œå¯ä»¥å®‰å…¨åœ°å¤šæ¬¡æ‰§è¡Œï¼š

- âœ… å·²å­˜åœ¨çš„ç´¢å¼•ä¼šè¢«è·³è¿‡
- âœ… å·²å­˜åœ¨çš„æ‰©å±•ä¸ä¼šè¢«é‡å¤åˆ›å»º
- âœ… å·²å­˜åœ¨çš„å­—æ®µä¸ä¼šè¢«é‡å¤æ·»åŠ 

### 2. è¿ç§»é¡ºåº

è¿ç§»è„šæœ¬æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

1. åŸºç¡€è¡¨ç»“æ„è¿ç§»
2. ä¸šåŠ¡åŠŸèƒ½è¿ç§»
3. **æ€§èƒ½ä¼˜åŒ–ç´¢å¼•è¿ç§»**ï¼ˆæœ€åæ‰§è¡Œï¼‰

### 3. é”™è¯¯å¤„ç†

- âœ… è¿ç§»å¤±è´¥**ä¸ä¼šé˜»æ­¢åº”ç”¨å¯åŠ¨**
- âœ… é”™è¯¯ä¼šè¢«è®°å½•åˆ°æ—¥å¿—
- âœ… å·²å­˜åœ¨çš„å¯¹è±¡ä¼šè¢«è‡ªåŠ¨è·³è¿‡

### 4. æ€§èƒ½å½±å“

- ç´¢å¼•åˆ›å»ºå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼ˆå–å†³äºæ•°æ®é‡ï¼‰
- å»ºè®®åœ¨ä½å³°æœŸéƒ¨ç½²
- é¦–æ¬¡éƒ¨ç½²åï¼Œåç»­éƒ¨ç½²ä¼šå¿«é€Ÿè·³è¿‡å·²å­˜åœ¨çš„ç´¢å¼•

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè¿ç§»æœªæ‰§è¡Œ

**æ£€æŸ¥**ï¼š
1. æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰è¿ç§»ç›¸å…³è¾“å‡º
2. æ£€æŸ¥ `AUTO_MIGRATE` ç¯å¢ƒå˜é‡ï¼ˆé»˜è®¤åº”ä¸º `true`ï¼‰
3. ç¡®è®¤ `backend/migrations/add_performance_indexes.sql` æ–‡ä»¶å­˜åœ¨

### é—®é¢˜2ï¼šç´¢å¼•åˆ›å»ºå¤±è´¥

**æ£€æŸ¥**ï¼š
1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯ä¿¡æ¯
2. ç¡®è®¤æ•°æ®åº“ç”¨æˆ·æœ‰åˆ›å»ºç´¢å¼•çš„æƒé™
3. ç¡®è®¤ PostgreSQL ç‰ˆæœ¬æ”¯æŒç›¸å…³åŠŸèƒ½ï¼ˆå»ºè®® 12+ï¼‰

### é—®é¢˜3ï¼špg_trgm æ‰©å±•åˆ›å»ºå¤±è´¥

**æ£€æŸ¥**ï¼š
1. ç¡®è®¤ PostgreSQL å·²å®‰è£… `pg_trgm` æ‰©å±•
2. ç¡®è®¤æ•°æ®åº“ç”¨æˆ·æœ‰åˆ›å»ºæ‰©å±•çš„æƒé™
3. æŸäº›äº‘æ•°æ®åº“å¯èƒ½éœ€è¦æ‰‹åŠ¨å¯ç”¨æ‰©å±•

---

## ğŸ“ æ‰‹åŠ¨æ‰§è¡Œè¿ç§»ï¼ˆå¯é€‰ï¼‰

å¦‚æœè‡ªåŠ¨è¿ç§»è¢«ç¦ç”¨ï¼ˆ`AUTO_MIGRATE=false`ï¼‰ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# æ–¹å¼1ï¼šä½¿ç”¨ psql
psql $DATABASE_URL -f backend/migrations/add_performance_indexes.sql

# æ–¹å¼2ï¼šåœ¨ Python ä¸­æ‰§è¡Œ
python -c "
from app.database import sync_engine
from app.db_migrations import run_migration_sync
run_migration_sync(sync_engine)
"
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®ï¼š`USE_PG_TRGM=true`
- [ ] **æ‰‹åŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬**ï¼š`psql $DATABASE_URL -f backend/migrations/add_performance_indexes.sql`
- [ ] åº”ç”¨å·²éƒ¨ç½²å¹¶å¯åŠ¨
- [ ] éªŒè¯ç´¢å¼•å·²åˆ›å»ºï¼ˆä½¿ç”¨ SQL æŸ¥è¯¢ï¼‰
- [ ] éªŒè¯ pg_trgm æ‰©å±•å·²å¯ç”¨
- [ ] éªŒè¯ conversation_key å­—æ®µå’Œè§¦å‘å™¨å·²åˆ›å»º

---

**éƒ¨ç½²å®Œæˆæ—¶é—´**: 2025-01-27  
**è¿ç§»æ–¹å¼**: âš ï¸ **æ‰‹åŠ¨æ‰§è¡Œ**  
**çŠ¶æ€**: âœ… å°±ç»ªéƒ¨ç½²

