# 数据库优化自动部署说明

## ✅ 自动迁移已配置完成

数据库性能优化索引迁移已集成到自动迁移系统中，**应用启动时会自动执行**。

---

## 🚀 部署流程

### 1. 环境变量配置

确保设置以下环境变量：

```env
# 搜索配置（推荐使用 pg_trgm）
USE_PG_TRGM=true          # ✅ 启用 pg_trgm 扩展（推荐）
# SEARCH_LANGUAGE=english  # ⚠️ 使用 pg_trgm 时此配置不起作用

# 自动迁移配置（默认启用）
AUTO_MIGRATE=true         # 启用自动迁移（默认值，可不设置）
```

### 2. 部署应用

**无需手动执行迁移**，应用启动时会自动：

1. ✅ 创建数据库表（如果不存在）
2. ✅ 执行所有迁移脚本（包括性能优化索引）
3. ✅ 创建 pg_trgm 扩展
4. ✅ 创建所有性能优化索引
5. ✅ 添加 conversation_key 字段和触发器

### 3. 验证部署

部署后查看应用日志，应该看到：

```
🚀 开始执行自动数据库迁移...
🚀 开始执行 add_performance_indexes.sql...
✅ add_performance_indexes.sql 迁移完成
✅ 自动数据库迁移完成！
   总计 - 执行: XX, 跳过: XX, 错误: 0
```

---

## ⚠️ 重要说明

**之前的迁移脚本已经执行过，不再重复执行。**  
当前自动迁移只包含新的性能优化索引迁移。

## 📋 迁移脚本包含的内容

### 1. PostgreSQL 扩展
- ✅ `pg_trgm` 扩展（用于相似度搜索）

### 2. 任务表索引
- ✅ `ix_tasks_status_created_id` - 游标分页索引
- ✅ `ix_tasks_type_location_status` - 组合查询索引
- ✅ `ix_tasks_poster_status_created` - 用户发布任务索引
- ✅ `ix_tasks_taker_status_created` - 用户接受任务索引
- ✅ `idx_tasks_title_trgm` - 标题相似度搜索索引
- ✅ `idx_tasks_description_trgm` - 描述相似度搜索索引
- ✅ `idx_tasks_search` - 全文搜索索引（可选）

### 3. 申请表索引
- ✅ `ix_applications_applicant_created` - 申请者查询索引
- ✅ `ix_applications_task_status` - 任务申请状态索引

### 4. 消息表优化
- ✅ `conversation_key` 字段（自动维护）
- ✅ `ix_messages_conversation_created` - 对话查询索引
- ✅ `ix_messages_receiver_created` - 接收者查询索引
- ✅ 自动触发器（维护 conversation_key）

### 5. 通知表索引
- ✅ `ix_notifications_user_read_created` - 用户通知查询索引

---

## 🔍 验证索引创建

部署后可以执行以下 SQL 验证：

```sql
-- 检查 pg_trgm 扩展
SELECT * FROM pg_extension WHERE extname = 'pg_trgm';

-- 检查索引是否创建
SELECT 
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename IN ('tasks', 'task_applications', 'messages', 'notifications')
  AND (indexname LIKE 'ix_%' OR indexname LIKE 'idx_%')
ORDER BY tablename, indexname;

-- 检查 conversation_key 字段
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'messages' AND column_name = 'conversation_key';

-- 检查触发器
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers
WHERE event_object_table = 'messages' 
  AND trigger_name LIKE '%conversation%';
```

---

## ⚠️ 重要说明

### 1. 幂等性

所有迁移脚本都使用了 `IF NOT EXISTS` 或 `CREATE OR REPLACE`，可以安全地多次执行：

- ✅ 已存在的索引会被跳过
- ✅ 已存在的扩展不会被重复创建
- ✅ 已存在的字段不会被重复添加

### 2. 迁移顺序

迁移脚本按以下顺序执行：

1. 基础表结构迁移
2. 业务功能迁移
3. **性能优化索引迁移**（最后执行）

### 3. 错误处理

- ✅ 迁移失败**不会阻止应用启动**
- ✅ 错误会被记录到日志
- ✅ 已存在的对象会被自动跳过

### 4. 性能影响

- 索引创建可能需要一些时间（取决于数据量）
- 建议在低峰期部署
- 首次部署后，后续部署会快速跳过已存在的索引

---

## 🐛 故障排查

### 问题1：迁移未执行

**检查**：
1. 查看应用启动日志，确认是否有迁移相关输出
2. 检查 `AUTO_MIGRATE` 环境变量（默认应为 `true`）
3. 确认 `backend/migrations/add_performance_indexes.sql` 文件存在

### 问题2：索引创建失败

**检查**：
1. 查看应用日志中的具体错误信息
2. 确认数据库用户有创建索引的权限
3. 确认 PostgreSQL 版本支持相关功能（建议 12+）

### 问题3：pg_trgm 扩展创建失败

**检查**：
1. 确认 PostgreSQL 已安装 `pg_trgm` 扩展
2. 确认数据库用户有创建扩展的权限
3. 某些云数据库可能需要手动启用扩展

---

## 📝 手动执行迁移（可选）

如果自动迁移被禁用（`AUTO_MIGRATE=false`），可以手动执行：

```bash
# 方式1：使用 psql
psql $DATABASE_URL -f backend/migrations/add_performance_indexes.sql

# 方式2：在 Python 中执行
python -c "
from app.database import sync_engine
from app.db_migrations import run_migration_sync
run_migration_sync(sync_engine)
"
```

---

## ✅ 部署检查清单

- [ ] 环境变量已设置：`USE_PG_TRGM=true`
- [ ] `AUTO_MIGRATE=true`（或留空，默认启用）
- [ ] 应用已部署并启动
- [ ] 查看日志确认迁移已执行
- [ ] 验证索引已创建（使用 SQL 查询）
- [ ] 验证 pg_trgm 扩展已启用
- [ ] 验证 conversation_key 字段和触发器已创建

---

**部署完成时间**: 2025-01-27  
**自动迁移**: ✅ 已启用  
**状态**: ✅ 就绪部署

