<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API修复测试</title>
</head>
<body>
    <h1>API修复测试</h1>
    <div id="status">正在测试...</div>
    <button onclick="testNotifications()">测试通知API</button>
    <button onclick="clearCounters()">清理重试计数器</button>
    <div id="logs"></div>

    <script>
        // 模拟API配置
        const API_BASE_URL = 'http://localhost:8000';
        
        // 重试计数器
        const retryCounters = new Map();
        const GLOBAL_RETRY_COUNTER = new Map();
        const MAX_RETRY_ATTEMPTS = 2;
        const MAX_GLOBAL_RETRIES = 5;
        
        let isRefreshing = false;
        let refreshPromise = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            logs.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }
        
        function clearCounters() {
            retryCounters.clear();
            GLOBAL_RETRY_COUNTER.clear();
            log('已清理所有重试计数器');
        }
        
        async function testNotifications() {
            log('开始测试通知API...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/notifications`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('通知API请求成功: ' + JSON.stringify(data));
                } else {
                    log('通知API请求失败: ' + response.status + ' ' + response.statusText);
                    
                    // 模拟前端的重试逻辑
                    if (response.status === 401) {
                        await handle401Error();
                    }
                }
            } catch (error) {
                log('请求异常: ' + error.message);
            }
        }
        
        async function handle401Error() {
            const globalKey = 'global_401_retry';
            const globalRetryCount = GLOBAL_RETRY_COUNTER.get(globalKey) || 0;
            
            log(`处理401错误 - 全局重试次数: ${globalRetryCount}`);
            
            if (globalRetryCount >= MAX_GLOBAL_RETRIES) {
                log('全局401重试次数已达上限，停止所有重试');
                GLOBAL_RETRY_COUNTER.delete(globalKey);
                retryCounters.clear();
                return;
            }
            
            // 避免重复刷新token
            if (isRefreshing) {
                log('正在刷新token，等待完成...');
                if (refreshPromise) {
                    try {
                        await refreshPromise;
                        log('等待token刷新完成，重试原始请求');
                        GLOBAL_RETRY_COUNTER.set(globalKey, globalRetryCount + 1);
                        await testNotifications();
                    } catch (refreshError) {
                        log('等待token刷新失败');
                        GLOBAL_RETRY_COUNTER.set(globalKey, globalRetryCount + 1);
                    }
                }
                return;
            }
            
            // 开始刷新token
            isRefreshing = true;
            log('开始刷新token...');
            
            refreshPromise = fetch(`${API_BASE_URL}/api/secure-auth/refresh`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            try {
                const refreshResponse = await refreshPromise;
                log('Token刷新成功，重试原始请求');
                
                // 增加全局重试计数
                GLOBAL_RETRY_COUNTER.set(globalKey, globalRetryCount + 1);
                
                // 重试原始请求
                await testNotifications();
            } catch (refreshError) {
                log('Token刷新失败: ' + refreshError.message);
                // 增加全局重试计数
                GLOBAL_RETRY_COUNTER.set(globalKey, globalRetryCount + 1);
            } finally {
                // 重置刷新状态
                isRefreshing = false;
                refreshPromise = null;
            }
        }
        
        // 页面加载时显示状态
        document.getElementById('status').textContent = 'API修复测试页面已加载';
        log('页面加载完成，可以开始测试');
    </script>
</body>
</html>
