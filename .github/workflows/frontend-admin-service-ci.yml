name: Frontend, Admin & Service CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - 'admin/**'
      - 'service/**'
      - '.github/workflows/frontend-admin-service-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'admin/**'
      - 'service/**'
      - '.github/workflows/frontend-admin-service-ci.yml'

jobs:
  # Frontend å‰ç«¯æ„å»º
  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # éœ€è¦è·å–ä¸Šä¸€ä¸ªæäº¤æ¥æ¯”è¾ƒ
    
    - name: Check if frontend changed
      id: check-frontend
      run: |
        if git diff HEAD^ HEAD --quiet -- frontend/; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â­ï¸  No changes in frontend folder"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Frontend folder has changes"
        fi
    
    - name: Set up Node.js
      if: steps.check-frontend.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      if: steps.check-frontend.outputs.changed == 'true'
      run: npm ci
    
    - name: TypeScript check
      if: steps.check-frontend.outputs.changed == 'true'
      run: |
        echo "ğŸ” Running TypeScript type checking..."
        npx tsc --noEmit || true
        echo "âœ… TypeScript check completed"
    
    - name: Build frontend
      if: steps.check-frontend.outputs.changed == 'true'
      run: |
        echo "ğŸ—ï¸  Building frontend application..."
        npm run build
        echo "âœ… Frontend build successful"
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.link2ur.com' }}
        REACT_APP_WS_URL: ${{ secrets.REACT_APP_WS_URL || 'wss://api.link2ur.com' }}
        REACT_APP_MAIN_SITE_URL: ${{ secrets.REACT_APP_MAIN_SITE_URL || 'https://www.link2ur.com' }}
    
    - name: Skip build (no changes)
      if: steps.check-frontend.outputs.changed == 'false'
      run: |
        echo "â­ï¸  Skipping frontend build - no changes detected"

  # Admin ç®¡ç†åå°æ„å»º
  build-admin:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./admin
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # éœ€è¦è·å–ä¸Šä¸€ä¸ªæäº¤æ¥æ¯”è¾ƒ
    
    - name: Check if admin changed
      id: check-admin
      run: |
        if git diff HEAD^ HEAD --quiet -- admin/; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â­ï¸  No changes in admin folder"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Admin folder has changes"
        fi
    
    - name: Set up Node.js
      if: steps.check-admin.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: admin/package-lock.json
    
    - name: Install dependencies
      if: steps.check-admin.outputs.changed == 'true'
      run: npm ci
    
    - name: TypeScript check
      if: steps.check-admin.outputs.changed == 'true'
      run: |
        echo "ğŸ” Running TypeScript type checking..."
        npx tsc --noEmit || true
        echo "âœ… TypeScript check completed"
    
    - name: Build admin
      if: steps.check-admin.outputs.changed == 'true'
      run: |
        echo "ğŸ—ï¸  Building admin dashboard..."
        npm run build
        echo "âœ… Admin build successful"
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.link2ur.com' }}
        REACT_APP_WS_URL: ${{ secrets.REACT_APP_WS_URL || 'wss://api.link2ur.com' }}
        REACT_APP_MAIN_SITE_URL: ${{ secrets.REACT_APP_MAIN_SITE_URL || 'https://www.link2ur.com' }}
    
    - name: Skip build (no changes)
      if: steps.check-admin.outputs.changed == 'false'
      run: |
        echo "â­ï¸  Skipping admin build - no changes detected"

  # Service å®¢æœç³»ç»Ÿæ„å»º
  build-service:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./service
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # éœ€è¦è·å–ä¸Šä¸€ä¸ªæäº¤æ¥æ¯”è¾ƒ
    
    - name: Check if service changed
      id: check-service
      run: |
        if git diff HEAD^ HEAD --quiet -- service/; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â­ï¸  No changes in service folder"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Service folder has changes"
        fi
    
    - name: Set up Node.js
      if: steps.check-service.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: service/package-lock.json
    
    - name: Install dependencies
      if: steps.check-service.outputs.changed == 'true'
      run: npm ci
    
    - name: TypeScript check
      if: steps.check-service.outputs.changed == 'true'
      run: |
        echo "ğŸ” Running TypeScript type checking..."
        npx tsc --noEmit || true
        echo "âœ… TypeScript check completed"
    
    - name: Build service
      if: steps.check-service.outputs.changed == 'true'
      run: |
        echo "ğŸ—ï¸  Building customer service dashboard..."
        npm run build
        echo "âœ… Service build successful"
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.link2ur.com' }}
        REACT_APP_WS_URL: ${{ secrets.REACT_APP_WS_URL || 'wss://api.link2ur.com' }}
        REACT_APP_MAIN_SITE_URL: ${{ secrets.REACT_APP_MAIN_SITE_URL || 'https://www.link2ur.com' }}
    
    - name: Skip build (no changes)
      if: steps.check-service.outputs.changed == 'false'
      run: |
        echo "â­ï¸  Skipping service build - no changes detected"

  # æ„å»ºçŠ¶æ€æ±‡æ€»
  build-summary:
    runs-on: ubuntu-latest
    needs: [build-frontend, build-admin, build-service]
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "ğŸ“Š Build Summary"
        echo "================"
        echo ""
        echo "Frontend build: ${{ needs.build-frontend.result }}"
        echo "Admin build: ${{ needs.build-admin.result }}"
        echo "Service build: ${{ needs.build-service.result }}"
        echo ""
        if [ "${{ needs.build-frontend.result }}" == "success" ] || [ "${{ needs.build-admin.result }}" == "success" ] || [ "${{ needs.build-service.result }}" == "success" ]; then
          echo "âœ… At least one build completed successfully"
        else
          echo "â„¹ï¸  No builds were triggered (no changes detected)"
        fi
