name: Frontend, Admin & Service CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - 'admin/**'
      - 'service/**'
      - '.github/workflows/frontend-admin-service-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'admin/**'
      - 'service/**'
      - '.github/workflows/frontend-admin-service-ci.yml'
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  # Frontend ÂâçÁ´ØÊûÑÂª∫
  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ÈúÄË¶ÅËé∑Âèñ‰∏ä‰∏Ä‰∏™Êèê‰∫§Êù•ÊØîËæÉ
    
    - name: Check if frontend changed
      id: check-frontend
      run: |
        # Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏ä‰∏Ä‰∏™Êèê‰∫§
        if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
          if git diff HEAD^ HEAD --quiet -- frontend/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No changes in frontend folder"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend folder has changes"
          fi
        else
          # Â¶ÇÊûúÊ≤°Êúâ‰∏ä‰∏Ä‰∏™Êèê‰∫§ÔºàÈ¶ñÊ¨°Êèê‰∫§ÊàñÂçïÊèê‰∫§ÂàÜÊîØÔºâ
          # Áî±‰∫éÂ∑•‰ΩúÊµÅÂ∑≤ÁªèÈÄöËøáË∑ØÂæÑËøáÊª§Ëß¶ÂèëÔºåÊ£ÄÊü•ÂΩìÂâçÊèê‰∫§‰∏≠ÊòØÂê¶ÊúâfrontendÁõ∏ÂÖ≥Êñá‰ª∂
          if git diff --name-only --diff-filter=ACMRT HEAD | grep -q "^frontend/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend folder detected in this commit"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No frontend files in this commit"
          fi
        fi
    
    - name: Set up Node.js
      if: steps.check-frontend.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      if: steps.check-frontend.outputs.changed == 'true'
      run: npm ci
    
    - name: TypeScript check
      if: steps.check-frontend.outputs.changed == 'true'
      run: |
        echo "üîç Running TypeScript type checking..."
        npx tsc --noEmit || true
        echo "‚úÖ TypeScript check completed"
    
    - name: Run tests
      if: steps.check-frontend.outputs.changed == 'true'
      run: |
        echo "üß™ Running frontend tests..."
        npm test -- --watchAll=false --coverage --passWithNoTests
        echo "‚úÖ Frontend tests passed"
    
    - name: Build frontend
      if: steps.check-frontend.outputs.changed == 'true'
      run: |
        echo "üèóÔ∏è  Building frontend application..."
        npm run build
        echo "‚úÖ Frontend build successful"
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.link2ur.com' }}
        REACT_APP_WS_URL: ${{ secrets.REACT_APP_WS_URL || 'wss://api.link2ur.com' }}
        REACT_APP_MAIN_SITE_URL: ${{ secrets.REACT_APP_MAIN_SITE_URL || 'https://www.link2ur.com' }}
    
    - name: Skip build (no changes)
      if: steps.check-frontend.outputs.changed == 'false'
      run: |
        echo "‚è≠Ô∏è  Skipping frontend build - no changes detected"

  # Admin ÁÆ°ÁêÜÂêéÂè∞ÊûÑÂª∫
  build-admin:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./admin
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ÈúÄË¶ÅËé∑Âèñ‰∏ä‰∏Ä‰∏™Êèê‰∫§Êù•ÊØîËæÉ
    
    - name: Check if admin changed
      id: check-admin
      run: |
        # Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏ä‰∏Ä‰∏™Êèê‰∫§
        if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
          if git diff HEAD^ HEAD --quiet -- admin/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No changes in admin folder"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Admin folder has changes"
          fi
        else
          # Â¶ÇÊûúÊ≤°Êúâ‰∏ä‰∏Ä‰∏™Êèê‰∫§ÔºàÈ¶ñÊ¨°Êèê‰∫§ÊàñÂçïÊèê‰∫§ÂàÜÊîØÔºâ
          if git diff --name-only --diff-filter=ACMRT HEAD | grep -q "^admin/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Admin folder detected in this commit"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No admin files in this commit"
          fi
        fi
    
    - name: Set up Node.js
      if: steps.check-admin.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: admin/package-lock.json
    
    - name: Install dependencies
      if: steps.check-admin.outputs.changed == 'true'
      run: npm ci
    
    - name: TypeScript check
      if: steps.check-admin.outputs.changed == 'true'
      run: |
        echo "üîç Running TypeScript type checking..."
        npx tsc --noEmit || true
        echo "‚úÖ TypeScript check completed"
    
    - name: Build admin
      if: steps.check-admin.outputs.changed == 'true'
      run: |
        echo "üèóÔ∏è  Building admin dashboard..."
        npm run build
        echo "‚úÖ Admin build successful"
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.link2ur.com' }}
        REACT_APP_WS_URL: ${{ secrets.REACT_APP_WS_URL || 'wss://api.link2ur.com' }}
        REACT_APP_MAIN_SITE_URL: ${{ secrets.REACT_APP_MAIN_SITE_URL || 'https://www.link2ur.com' }}
    
    - name: Skip build (no changes)
      if: steps.check-admin.outputs.changed == 'false'
      run: |
        echo "‚è≠Ô∏è  Skipping admin build - no changes detected"

  # Service ÂÆ¢ÊúçÁ≥ªÁªüÊûÑÂª∫
  build-service:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./service
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ÈúÄË¶ÅËé∑Âèñ‰∏ä‰∏Ä‰∏™Êèê‰∫§Êù•ÊØîËæÉ
    
    - name: Check if service changed
      id: check-service
      run: |
        # Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏ä‰∏Ä‰∏™Êèê‰∫§
        if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
          if git diff HEAD^ HEAD --quiet -- service/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No changes in service folder"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Service folder has changes"
          fi
        else
          # Â¶ÇÊûúÊ≤°Êúâ‰∏ä‰∏Ä‰∏™Êèê‰∫§ÔºàÈ¶ñÊ¨°Êèê‰∫§ÊàñÂçïÊèê‰∫§ÂàÜÊîØÔºâ
          if git diff --name-only --diff-filter=ACMRT HEAD | grep -q "^service/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Service folder detected in this commit"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No service files in this commit"
          fi
        fi
    
    - name: Set up Node.js
      if: steps.check-service.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: service/package-lock.json
    
    - name: Install dependencies
      if: steps.check-service.outputs.changed == 'true'
      run: npm ci
    
    - name: TypeScript check
      if: steps.check-service.outputs.changed == 'true'
      run: |
        echo "üîç Running TypeScript type checking..."
        npx tsc --noEmit || true
        echo "‚úÖ TypeScript check completed"
    
    - name: Build service
      if: steps.check-service.outputs.changed == 'true'
      run: |
        echo "üèóÔ∏è  Building customer service dashboard..."
        npm run build
        echo "‚úÖ Service build successful"
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.link2ur.com' }}
        REACT_APP_WS_URL: ${{ secrets.REACT_APP_WS_URL || 'wss://api.link2ur.com' }}
        REACT_APP_MAIN_SITE_URL: ${{ secrets.REACT_APP_MAIN_SITE_URL || 'https://www.link2ur.com' }}
    
    - name: Skip build (no changes)
      if: steps.check-service.outputs.changed == 'false'
      run: |
        echo "‚è≠Ô∏è  Skipping service build - no changes detected"

  # ÊûÑÂª∫Áä∂ÊÄÅÊ±áÊÄª
  build-summary:
    runs-on: ubuntu-latest
    needs: [build-frontend, build-admin, build-service]
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "üìä Build Summary"
        echo "================"
        echo ""
        echo "Frontend build: ${{ needs.build-frontend.result }}"
        echo "Admin build: ${{ needs.build-admin.result }}"
        echo "Service build: ${{ needs.build-service.result }}"
        echo ""
        if [ "${{ needs.build-frontend.result }}" == "success" ] || [ "${{ needs.build-admin.result }}" == "success" ] || [ "${{ needs.build-service.result }}" == "success" ]; then
          echo "‚úÖ At least one build completed successfully"
        else
          echo "‚ÑπÔ∏è  No builds were triggered (no changes detected)"
        fi
