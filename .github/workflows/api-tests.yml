# API 自动化测试工作流
# 
# 测试目标：Railway 测试环境（非生产环境）
# 触发条件：push 到 main/develop 分支，或 PR 到 main 分支
#
# 必需的 GitHub Secrets:
#   - TEST_API_URL: Railway 测试环境 URL（例如 https://xxx-test.up.railway.app）
#   - TEST_USER_EMAIL: 测试账号邮箱
#   - TEST_USER_PASSWORD: 测试账号密码
#   - STRIPE_TEST_SECRET_KEY: (可选) Stripe 测试密钥

name: API Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/api-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
  # 支持手动触发
  workflow_dispatch:
    inputs:
      test_url:
        description: '测试环境 URL (可选，覆盖 secret)'
        required: false
        type: string
      test_category:
        description: '测试分类'
        required: false
        type: choice
        options:
          - all
          - auth
          - task
          - payment
        default: 'all'
      skip_env_check:
        description: '跳过环境检查 (仅用于调试)'
        required: false
        type: boolean
        default: false

# 确保同一分支只有一个工作流运行
concurrency:
  group: api-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================================================================
  # 安全检查和环境验证
  # =========================================================================
  pre-check:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      test_url: ${{ steps.validate.outputs.test_url }}
      can_run: ${{ steps.validate.outputs.can_run }}
    
    env:
      TEST_API_URL: ${{ github.event.inputs.test_url || secrets.TEST_API_URL }}
      
    steps:
      - name: Validate configuration
        id: validate
        run: |
          echo "🔒 验证测试配置..."
          
          # 检查 TEST_API_URL 是否配置
          if [ -z "$TEST_API_URL" ]; then
            echo "⚠️ TEST_API_URL 未配置"
            echo "can_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 检查是否误用生产环境
          PRODUCTION_URLS=("api.link2ur.com" "linku1-production" "www.link2ur.com" "link2ur.com")
          for prod_url in "${PRODUCTION_URLS[@]}"; do
            if [[ "$TEST_API_URL" == *"$prod_url"* ]]; then
              echo "❌ 严重错误: TEST_API_URL 包含生产环境地址 '$prod_url'!"
              echo "当前值: $TEST_API_URL"
              echo "测试绝对不能指向生产环境!"
              exit 1
            fi
          done
          
          echo "test_url=$TEST_API_URL" >> $GITHUB_OUTPUT
          echo "can_run=true" >> $GITHUB_OUTPUT
          echo "✅ 配置验证通过"
          echo "  测试环境: $TEST_API_URL"

      - name: Check test environment availability
        if: steps.validate.outputs.can_run == 'true' && github.event.inputs.skip_env_check != 'true'
        run: |
          echo "🔍 检查测试环境可用性..."
          
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$TEST_API_URL/api/secure-auth/captcha-site-key" || echo "000")
            
            if [ "$HTTP_CODE" != "000" ]; then
              echo "✅ 测试环境在线 (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "⏳ 连接失败，${RETRY_DELAY}秒后重试... ($i/$MAX_RETRIES)"
              sleep $RETRY_DELAY
            fi
          done
          
          echo "❌ 无法连接到测试环境: $TEST_API_URL"
          echo "请检查 Railway 测试环境是否正常运行"
          exit 1

  # =========================================================================
  # 认证 API 测试
  # =========================================================================
  test-auth:
    name: Auth API Tests
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.can_run == 'true' && (github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'auth' || github.event.inputs.test_category == '')
    timeout-minutes: 10
    
    env:
      TEST_API_URL: ${{ github.event.inputs.test_url || secrets.TEST_API_URL }}
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      PYTHONPATH: ${{ github.workspace }}/backend
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-test.txt

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt

      - name: Run auth tests
        working-directory: ./backend
        run: |
          echo "🧪 运行认证 API 测试..."
          python -m pytest tests/api/test_auth_api.py \
            -v \
            --tb=short \
            --color=yes \
            --timeout=60 \
            --junitxml=test-results-auth.xml \
            2>&1 | tee test_output_auth.txt
          
          exit ${PIPESTATUS[0]}

      - name: Upload auth test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-test-results
          path: |
            backend/test_output_auth.txt
            backend/test-results-auth.xml
          retention-days: 7

  # =========================================================================
  # 任务 API 测试
  # =========================================================================
  test-task:
    name: Task API Tests
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.can_run == 'true' && (github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'task' || github.event.inputs.test_category == '')
    timeout-minutes: 10
    
    env:
      TEST_API_URL: ${{ github.event.inputs.test_url || secrets.TEST_API_URL }}
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      PYTHONPATH: ${{ github.workspace }}/backend
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-test.txt

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt

      - name: Run task tests
        working-directory: ./backend
        run: |
          echo "🧪 运行任务 API 测试..."
          python -m pytest tests/api/test_task_api.py \
            -v \
            --tb=short \
            --color=yes \
            --timeout=60 \
            --junitxml=test-results-task.xml \
            2>&1 | tee test_output_task.txt
          
          exit ${PIPESTATUS[0]}

      - name: Upload task test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: task-test-results
          path: |
            backend/test_output_task.txt
            backend/test-results-task.xml
          retention-days: 7

  # =========================================================================
  # 支付 API 测试
  # =========================================================================
  test-payment:
    name: Payment API Tests
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.can_run == 'true' && (github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'payment' || github.event.inputs.test_category == '')
    timeout-minutes: 10
    
    env:
      TEST_API_URL: ${{ github.event.inputs.test_url || secrets.TEST_API_URL }}
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      STRIPE_TEST_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
      PYTHONPATH: ${{ github.workspace }}/backend
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Stripe test key
        if: env.STRIPE_TEST_SECRET_KEY != ''
        run: |
          if [[ "$STRIPE_TEST_SECRET_KEY" != sk_test_* ]]; then
            echo "❌ 严重错误: STRIPE_TEST_SECRET_KEY 不是测试密钥!"
            echo "测试必须使用 sk_test_ 开头的测试密钥!"
            exit 1
          fi
          echo "✅ Stripe 测试密钥验证通过"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-test.txt

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt

      - name: Run payment tests
        working-directory: ./backend
        run: |
          echo "🧪 运行支付 API 测试..."
          python -m pytest tests/api/test_payment_api.py \
            -v \
            --tb=short \
            --color=yes \
            --timeout=60 \
            --junitxml=test-results-payment.xml \
            2>&1 | tee test_output_payment.txt
          
          exit ${PIPESTATUS[0]}

      - name: Upload payment test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: payment-test-results
          path: |
            backend/test_output_payment.txt
            backend/test-results-payment.xml
          retention-days: 7

  # =========================================================================
  # 测试汇总
  # =========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [pre-check, test-auth, test-task, test-payment]
    if: always() && needs.pre-check.outputs.can_run == 'true'
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
          merge-multiple: true
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## 🧪 API 测试结果汇总" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 测试模块 | 状态 |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Auth 测试结果
          if [ "${{ needs.test-auth.result }}" == "success" ]; then
            echo "| 认证 API | ✅ 通过 |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-auth.result }}" == "failure" ]; then
            echo "| 认证 API | ❌ 失败 |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-auth.result }}" == "skipped" ]; then
            echo "| 认证 API | ⏭️ 跳过 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 认证 API | ⚠️ 未运行 |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Task 测试结果
          if [ "${{ needs.test-task.result }}" == "success" ]; then
            echo "| 任务 API | ✅ 通过 |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-task.result }}" == "failure" ]; then
            echo "| 任务 API | ❌ 失败 |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-task.result }}" == "skipped" ]; then
            echo "| 任务 API | ⏭️ 跳过 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 任务 API | ⚠️ 未运行 |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Payment 测试结果
          if [ "${{ needs.test-payment.result }}" == "success" ]; then
            echo "| 支付 API | ✅ 通过 |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-payment.result }}" == "failure" ]; then
            echo "| 支付 API | ❌ 失败 |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-payment.result }}" == "skipped" ]; then
            echo "| 支付 API | ⏭️ 跳过 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 支付 API | ⚠️ 未运行 |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**测试环境:** \`${{ needs.pre-check.outputs.test_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**运行时间:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Check overall result
        run: |
          AUTH_RESULT="${{ needs.test-auth.result }}"
          TASK_RESULT="${{ needs.test-task.result }}"
          PAYMENT_RESULT="${{ needs.test-payment.result }}"
          
          # 如果任何测试失败，整体失败
          if [ "$AUTH_RESULT" == "failure" ] || [ "$TASK_RESULT" == "failure" ] || [ "$PAYMENT_RESULT" == "failure" ]; then
            echo "❌ 部分测试失败"
            exit 1
          fi
          
          echo "✅ 所有测试通过或跳过"

  # =========================================================================
  # 配置缺失时的提示
  # =========================================================================
  config-missing:
    name: Configuration Missing
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.can_run == 'false'
    
    steps:
      - name: Show configuration guide
        run: |
          echo "## ⚠️ API 测试未运行 - 缺少配置" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "请在 GitHub 仓库设置中配置以下 Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret 名称 | 说明 | 示例 |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`TEST_API_URL\` | Railway 测试环境 URL | \`https://xxx-test.up.railway.app\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`TEST_USER_EMAIL\` | 测试账号邮箱 | \`test@example.com\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`TEST_USER_PASSWORD\` | 测试账号密码 | \`TestPass123!\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`STRIPE_TEST_SECRET_KEY\` | (可选) Stripe 测试密钥 | \`sk_test_xxx\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 配置步骤" >> $GITHUB_STEP_SUMMARY
          echo "1. 进入仓库 Settings → Secrets and variables → Actions" >> $GITHUB_STEP_SUMMARY
          echo "2. 点击 'New repository secret'" >> $GITHUB_STEP_SUMMARY
          echo "3. 添加上述 Secrets" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "⚠️ API 测试未运行 - 缺少 TEST_API_URL 配置"
          echo "请在 GitHub Secrets 中配置测试环境 URL"
