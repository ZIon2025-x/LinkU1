# API è‡ªåŠ¨åŒ–æµ‹è¯•å·¥ä½œæµ
# 
# æµ‹è¯•ç›®æ ‡ï¼šRailway æµ‹è¯•ç¯å¢ƒï¼ˆéç”Ÿäº§ç¯å¢ƒï¼‰
# è§¦å‘æ¡ä»¶ï¼špush åˆ° main/develop åˆ†æ”¯ï¼Œæˆ– PR åˆ° main åˆ†æ”¯
#
# å¿…éœ€çš„ GitHub Secrets:
#   - TEST_API_URL: Railway æµ‹è¯•ç¯å¢ƒ URLï¼ˆä¾‹å¦‚ https://xxx-test.up.railway.appï¼‰
#   - TEST_USER_EMAIL: æµ‹è¯•è´¦å·é‚®ç®±
#   - TEST_USER_PASSWORD: æµ‹è¯•è´¦å·å¯†ç 
#   - STRIPE_TEST_SECRET_KEY: (å¯é€‰) Stripe æµ‹è¯•å¯†é’¥

name: API Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/api-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_url:
        description: 'æµ‹è¯•ç¯å¢ƒ URL (å¯é€‰ï¼Œè¦†ç›– secret)'
        required: false
        type: string

jobs:
  api-tests:
    name: Run API Tests
    runs-on: ubuntu-latest
    
    # è¶…æ—¶è®¾ç½®
    timeout-minutes: 10
    
    env:
      # ä» Secrets è¯»å–ï¼Œæ”¯æŒæ‰‹åŠ¨è¾“å…¥è¦†ç›–
      TEST_API_URL: ${{ github.event.inputs.test_url || secrets.TEST_API_URL }}
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      STRIPE_TEST_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
      # Python ç¯å¢ƒ
      PYTHONPATH: ${{ github.workspace }}/backend
      
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-test.txt

      # å®‰è£…æµ‹è¯•ä¾èµ–
      - name: Install test dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt

      # å®‰å…¨æ£€æŸ¥
      - name: Security check
        run: |
          echo "ğŸ”’ å®‰å…¨æ£€æŸ¥..."
          
          # æ£€æŸ¥ TEST_API_URL æ˜¯å¦é…ç½®
          if [ -z "$TEST_API_URL" ]; then
            echo "âŒ é”™è¯¯: TEST_API_URL æœªé…ç½®"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½® TEST_API_URL"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦è¯¯ç”¨ç”Ÿäº§ç¯å¢ƒ
          if [[ "$TEST_API_URL" == *"api.link2ur.com"* ]] || \
             [[ "$TEST_API_URL" == *"linku1-production"* ]] || \
             [[ "$TEST_API_URL" == *"www.link2ur.com"* ]]; then
            echo "âŒ ä¸¥é‡é”™è¯¯: TEST_API_URL åŒ…å«ç”Ÿäº§ç¯å¢ƒåœ°å€!"
            echo "å½“å‰å€¼: $TEST_API_URL"
            echo "æµ‹è¯•ç»å¯¹ä¸èƒ½æŒ‡å‘ç”Ÿäº§ç¯å¢ƒ!"
            exit 1
          fi
          
          # æ£€æŸ¥ Stripe å¯†é’¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
          if [ -n "$STRIPE_TEST_SECRET_KEY" ]; then
            if [[ "$STRIPE_TEST_SECRET_KEY" != sk_test_* ]]; then
              echo "âŒ ä¸¥é‡é”™è¯¯: STRIPE_TEST_SECRET_KEY ä¸æ˜¯æµ‹è¯•å¯†é’¥!"
              echo "æµ‹è¯•å¿…é¡»ä½¿ç”¨ sk_test_ å¼€å¤´çš„æµ‹è¯•å¯†é’¥!"
              exit 1
            fi
          fi
          
          echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"
          echo "  æµ‹è¯•ç¯å¢ƒ: $TEST_API_URL"

      # æ£€æŸ¥æµ‹è¯•ç¯å¢ƒå¯ç”¨æ€§
      - name: Check test environment
        run: |
          echo "ğŸ” æ£€æŸ¥æµ‹è¯•ç¯å¢ƒå¯ç”¨æ€§..."
          
          # å‘é€ç®€å•è¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨çº¿
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$TEST_API_URL/api/secure-auth/captcha-site-key" || echo "000")
          
          if [ "$HTTP_CODE" = "000" ]; then
            echo "âŒ æ— æ³•è¿æ¥åˆ°æµ‹è¯•ç¯å¢ƒ: $TEST_API_URL"
            echo "è¯·æ£€æŸ¥ Railway æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­£å¸¸è¿è¡Œ"
            exit 1
          fi
          
          echo "âœ… æµ‹è¯•ç¯å¢ƒåœ¨çº¿ (HTTP $HTTP_CODE)"

      # è¿è¡Œ API æµ‹è¯•
      - name: Run API tests
        working-directory: ./backend
        run: |
          echo "ğŸ§ª è¿è¡Œ API æµ‹è¯•..."
          echo "ç›®æ ‡ç¯å¢ƒ: $TEST_API_URL"
          echo ""
          
          python -m pytest tests/api/ \
            -v \
            --tb=short \
            -x \
            --color=yes \
            --timeout=60 \
            2>&1 | tee test_output.txt
          
          # æ£€æŸ¥æµ‹è¯•ç»“æœ
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo ""
            echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

      # ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: backend/test_output.txt
          retention-days: 7

      # æµ‹è¯•æ‘˜è¦
      - name: Test Summary
        if: always()
        run: |
          echo "## API æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•ç¯å¢ƒ: \`$TEST_API_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f backend/test_output.txt ]; then
            # æå–æµ‹è¯•ç»Ÿè®¡
            PASSED=$(grep -oP '\d+(?= passed)' backend/test_output.txt | tail -1 || echo "0")
            FAILED=$(grep -oP '\d+(?= failed)' backend/test_output.txt | tail -1 || echo "0")
            SKIPPED=$(grep -oP '\d+(?= skipped)' backend/test_output.txt | tail -1 || echo "0")
            
            echo "### æµ‹è¯•ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… é€šè¿‡: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ å¤±è´¥: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- â­ï¸ è·³è¿‡: $SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi

  # é€šçŸ¥ä½œä¸šï¼ˆå¯é€‰ï¼Œå¤±è´¥æ—¶é€šçŸ¥ï¼‰
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: api-tests
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "âš ï¸ API æµ‹è¯•å¤±è´¥"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—äº†è§£è¯¦æƒ…"
          # å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ  Slack/Discord/é‚®ä»¶é€šçŸ¥
