# è®ºå›å­¦æ ¡æ¿å—è®¿é—®æ§åˆ¶å¼€å‘æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-06  
> **çŠ¶æ€**: æ­£å¼ç¨¿  
> **ç»´æŠ¤å›¢é˜Ÿ**: LinkU å¼€å‘å›¢é˜Ÿ  

---

## ğŸ“Œ ç›®æ ‡ä¸èŒƒå›´
- å¯¹å­¦æ ¡ç±»æ¿å—å®æ–½åˆ†çº§å¯è§æ€§ä¸æ“ä½œæƒé™æ§åˆ¶ã€‚
- ä¿éšœï¼šæœªè®¤è¯/éå­¦ç”Ÿç”¨æˆ·ä¸å¯è§ä¸”ä¸å¯æ“ä½œï¼›å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿä»…çœ‹åˆ°"è‹±å›½ç•™å­¦ç”Ÿ"å¤§æ¿å—ä¸è‡ªå·±æ‰€å±å¤§å­¦çš„å°æ¿å—ã€‚
- è¦†ç›–ï¼šæ¿å—åˆ—è¡¨ã€å¸–å­/å›å¤è¯»å–ã€å‘å¸–/äº’åŠ¨ã€ç›´è¾¾é“¾æ¥è®¿é—®ã€å‰ç«¯å¯¼èˆªã€‚
- é€‚é…å¯¹è±¡ï¼šFastAPI åç«¯ + Web/å°ç¨‹åºå‰ç«¯ï¼›æ•°æ®åº“ PostgreSQLï¼›ç¼“å­˜ Redisã€‚
- è¯´æ˜ï¼šæ–‡æ¡£ä»…ä¿ç•™ä¸€å¥—è§„èŒƒåŒ–å°èŠ‚ï¼Œåç»­è¡¥å……ä¿¡æ¯å°†å¹¶å…¥å¯¹åº”å°èŠ‚ï¼Œä¸å†é‡å¤ã€‚

## ğŸ§­ è§’è‰²ä¸å¯è§æ€§çŸ©é˜µ

### è§’è‰²å®šä¹‰

**"å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿ"çš„ç²¾ç¡®å®šä¹‰**ï¼š
- `student_verifications.status = 'verified'`ï¼ˆpending çŠ¶æ€ä¸ç®—ï¼‰
- å…³è”çš„ `universities` è®°å½•å±äºè‹±å›½ï¼ˆå¦‚ `country='UK'` æˆ–é€šè¿‡å…¶ä»–æ–¹å¼åˆ¤æ–­ä¸ºè‹±å›½å¤§å­¦ï¼‰
- è®¤è¯æœªè¿‡æœŸï¼ˆ`expires_at > NOW()`ï¼‰
- **é‡è¦**ï¼šé UK å¤§å­¦è®¤è¯ç”¨æˆ·æš‚ä¸å¼€æ”¾å­¦æ ¡æ¿å—è®¿é—®ï¼›æœªæ¥å¦‚æ¥å…¥å…¶ä»–å›½å®¶å¤§å­¦è®¤è¯ï¼Œéœ€æ‰©å±•æƒé™è§„åˆ™

### å¯è§æ€§è§„åˆ™
- **è®¿å®¢/æœªç™»å½•**ï¼šä¸å¯è§ä»»ä½•å­¦æ ¡æ¿å—/å¸–å­ï¼›æ— å‘å¸–/äº’åŠ¨æƒé™ã€‚
- **å·²ç™»å½•éå­¦ç”Ÿæˆ–æœªé€šè¿‡å­¦ç”Ÿè®¤è¯**ï¼šåŒä¸Šã€‚
- **å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿ**ï¼š
  - å¯è§/å¯æ“ä½œï¼š`è‹±å›½ç•™å­¦ç”Ÿ`å¤§æ¿å—ï¼ˆtype=root, country=UKï¼‰ã€‚
  - å¯è§/å¯æ“ä½œï¼šå…¶ `university_code` å¯¹åº”çš„å°æ¿å—ã€‚
  - ä¸å¯è§/ä¸å¯æ“ä½œï¼šå…¶ä»–å¤§å­¦å°æ¿å—ã€‚
- **ç®¡ç†å‘˜/ç‰ˆä¸»**ï¼šæŒ‰å¹³å°æˆæƒç­–ç•¥å¯è¶ŠæƒæŸ¥çœ‹/ç®¡ç†ã€‚

ç®€è¡¨ï¼ˆå¯è§/å¯å†™/å¯ç®¡ç†ï¼‰ï¼š

| è§’è‰²                    | è‹±å›½ç•™å­¦ç”Ÿ(root) | è‡ªå·±å¤§å­¦ | å…¶ä»–å¤§å­¦ |
|-------------------------|------------------|----------|----------|
| è®¿å®¢/æœªè®¤è¯             | Ã— / Ã— / Ã—        | Ã— / Ã— / Ã—| Ã— / Ã— / Ã—|
| å·²ç™»å½•éå­¦ç”Ÿ            | Ã— / Ã— / Ã—        | Ã— / Ã— / Ã—| Ã— / Ã— / Ã—|
| å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿ        | âœ“ / âœ“ / Ã—        | âœ“ / âœ“ / Ã—| Ã— / Ã— / Ã—|
| ç®¡ç†å‘˜/ç‰ˆä¸»ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰ | âœ“ / âœ“ / âœ“        | âœ“ / âœ“ / âœ“| âœ“ / âœ“ / âœ“|
> ç®¡ç†å‘˜/ç‰ˆä¸»é»˜è®¤å…¨å±€è¶Šæƒï¼›è‹¥éœ€æŒ‰æ¿å—æˆæƒï¼Œéœ€é¢å¤–å®ç°â€œç‰ˆä¸»-æ¿å—æ˜ å°„â€å¹¶æ›¿æ¢å…¨å±€æ”¾è¡Œé€»è¾‘ã€‚

## ğŸ—‚ï¸ æ•°æ®æ¨¡å‹ä¸å­—æ®µ

### ç°æœ‰è¡¨ç»“æ„
- `forum_categories`ï¼ˆå½“å‰å­—æ®µï¼‰ï¼š
  - `id`, `name`, `description`, `icon`, `sort_order`, `is_visible`, `is_admin_only`, `post_count`, `last_post_at`, `created_at`, `updated_at`
- `student_verifications`ï¼ˆå‚è€ƒã€Šè‹±å›½ç•™å­¦ç”Ÿè®¤è¯ç³»ç»Ÿæ–‡æ¡£ã€‹ï¼‰ï¼š
  - `user_id`, `university_id`, `status`, `email`, `verified_at`, `expires_at`, `revoked_at`
  - çº¦æŸï¼šæ´»è·ƒè®¤è¯ï¼ˆpending/verifiedï¼‰å”¯ä¸€ï¼›è¿‡æœŸ/æ’¤é”€åç«‹å³å¤±æ•ˆå¯è§æ€§ã€‚
- `universities`ï¼š
  - `id`, `name`, `name_cn`, `email_domain`, `domain_pattern`, `is_active`
  - **æ³¨æ„**ï¼šå½“å‰è¡¨ç»“æ„æ²¡æœ‰ `country`ã€`code` æˆ– `university_code` å­—æ®µï¼ˆéœ€é€šè¿‡è¿ç§»æ·»åŠ ï¼‰

### éœ€è¦æ–°å¢çš„å­—æ®µï¼ˆæ•°æ®åº“è¿ç§»ï¼‰

#### 1. `forum_categories` è¡¨æ–°å¢å­—æ®µ
```sql
-- æ³¨æ„ï¼šPostgreSQL ä¸­ ADD COLUMN æ—¶ä¸èƒ½ç›´æ¥æ·»åŠ  CHECK çº¦æŸï¼Œéœ€åˆ†æ­¥æ‰§è¡Œ

-- 1.1 æ·»åŠ å­—æ®µ
ALTER TABLE forum_categories 
ADD COLUMN IF NOT EXISTS type VARCHAR(20) DEFAULT 'general',
ADD COLUMN IF NOT EXISTS country VARCHAR(10),
ADD COLUMN IF NOT EXISTS university_code VARCHAR(50);

-- 1.2 æ·»åŠ  type å­—æ®µçš„ CHECK çº¦æŸ
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'chk_forum_type'
    ) THEN
        ALTER TABLE forum_categories 
        ADD CONSTRAINT chk_forum_type 
        CHECK (type IN ('general', 'root', 'university'));
    END IF;
END $$;

-- 1.3 æ·»åŠ  type ä¸ university_code çš„å…³è”çº¦æŸ
-- æ³¨æ„ï¼šå¦‚æœçº¦æŸå·²å­˜åœ¨ä¼šæŠ¥é”™ï¼Œä½¿ç”¨ DO å—æ£€æŸ¥
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'chk_forum_type_university_code'
    ) THEN
        ALTER TABLE forum_categories 
        ADD CONSTRAINT chk_forum_type_university_code 
        CHECK (
            (type = 'university' AND university_code IS NOT NULL) OR 
            (type IN ('general', 'root') AND university_code IS NULL)
        );
    END IF;
END $$;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_forum_categories_type_country ON forum_categories(type, country);
CREATE INDEX idx_forum_categories_university_code ON forum_categories(university_code) WHERE university_code IS NOT NULL;
```

#### 2. `universities` è¡¨æ–°å¢å­—æ®µï¼ˆæ¨èï¼‰
```sql
-- æ·»åŠ  country å­—æ®µï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦è‹±å›½å¤§å­¦ï¼‰
ALTER TABLE universities 
ADD COLUMN country VARCHAR(10);  -- å›½å®¶ä»£ç ï¼Œå¦‚ 'UK'ï¼ˆè‹±å›½ï¼‰

-- æ·»åŠ  code å­—æ®µï¼ˆå¤§å­¦ç¼–ç ï¼Œå¯é€‰ä½†æ¨èï¼‰
ALTER TABLE universities 
ADD COLUMN code VARCHAR(50) UNIQUE;  -- å¤§å­¦ç¼–ç ï¼Œå¦‚ 'UOB'ï¼ˆå¸ƒé‡Œæ–¯æ‰˜ï¼‰ã€'UOX'ï¼ˆç‰›æ´¥ï¼‰

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_universities_country ON universities(country) WHERE country IS NOT NULL;
CREATE INDEX idx_universities_code ON universities(code) WHERE code IS NOT NULL;

-- ä¸ºç°æœ‰è‹±å›½å¤§å­¦å¡«å…… countryï¼ˆç¤ºä¾‹ï¼‰
UPDATE universities SET country = 'UK' WHERE email_domain LIKE '%.ac.uk';
```

**è¯´æ˜**ï¼š
- **`country` å­—æ®µ**ï¼šç”¨äºåˆ¤æ–­æ˜¯å¦è‹±å›½å¤§å­¦ï¼Œå½“å‰çº¦å®šè‹±å›½ä¸º `'UK'`ã€‚**å¿…é¡»æ·»åŠ **ï¼Œç”¨äºå®ç°"é UK å¤§å­¦è®¤è¯ç”¨æˆ·ä¸å¼€æ”¾å­¦æ ¡æ¿å—è®¿é—®"çš„è§„åˆ™ã€‚
- **`code` å­—æ®µ**ï¼šå¦‚æœæ·»åŠ äº† `code` å­—æ®µï¼Œåˆ™ `forum_categories.university_code` ç›´æ¥å¼•ç”¨ `universities.code`ï¼›å¦‚æœä¸æ·»åŠ ï¼Œåˆ™ `forum_categories.university_code` å¯é€šè¿‡ `universities.email_domain` æˆ– `universities.name` æ˜ å°„ç”Ÿæˆï¼ˆéœ€åœ¨åº”ç”¨å±‚ç»´æŠ¤æ˜ å°„å…³ç³»ï¼‰ã€‚

### æ•°æ®å…³è”é€»è¾‘
- ç”¨æˆ·å¯è§æ€§åˆ¤å®šæµç¨‹ï¼š
  1. ä» `student_verifications` è·å– `university_id`ï¼ˆéœ€ `status='verified'` ä¸”æœªè¿‡æœŸï¼‰
  2. é€šè¿‡ `university_id` å…³è” `universities` è¡¨è·å–å¤§å­¦ä¿¡æ¯
  3. ä» `universities.code`ï¼ˆæˆ–é€šè¿‡ `email_domain` æ˜ å°„ï¼‰è·å– `university_code`
  4. åœ¨ `forum_categories` ä¸­æŸ¥æ‰¾ `type='university'` ä¸” `university_code` åŒ¹é…çš„æ¿å—
  5. åŒæ—¶åŒ…å« `type='root'` ä¸” `country='UK'` çš„æ¿å—

### å­—æ®µè¯´æ˜
- `forum_categories.type`ï¼š
  - `'general'`ï¼šæ™®é€šæ¿å—ï¼ˆé»˜è®¤ï¼Œä¸å—å­¦æ ¡é™åˆ¶ï¼‰
  - `'root'`ï¼šå›½å®¶/åœ°åŒºçº§å¤§æ¿å—ï¼ˆå¦‚"è‹±å›½ç•™å­¦ç”Ÿ"ï¼‰
  - `'university'`ï¼šå¤§å­¦çº§å°æ¿å—
- `forum_categories.country`ï¼šå›½å®¶ä»£ç ï¼ˆå¦‚ `'UK'`ï¼‰ï¼Œä»… `type='root'` æ—¶ä½¿ç”¨
- `forum_categories.university_code`ï¼šå¤§å­¦ç¼–ç ï¼ˆå¦‚ `'UOB'`ï¼‰ï¼Œä»… `type='university'` æ—¶ä½¿ç”¨ï¼Œéœ€ä¸ `universities.code` æˆ–æ˜ å°„è§„åˆ™ä¸€è‡´

## ğŸ§  æƒé™åˆ¤å®šä¼ªä»£ç 

### æ ¸å¿ƒå‡½æ•°å®ç°
```python
# æ³¨æ„ï¼šä»¥ä¸‹å‡½æ•°ä¸ºè¾…åŠ©å‡½æ•°ï¼Œå®é™…å®ç°ä¸­å¯ç›´æ¥åœ¨ visible_forums ä¸­å†…è”ï¼Œé¿å…é‡å¤æŸ¥è¯¢
async def get_user_university_code(user_id: str, db: AsyncSession) -> Optional[str]:
    """
    ä» student_verifications è·å–ç”¨æˆ·çš„ university_codeï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
    
    æ³¨æ„ï¼šæ­¤å‡½æ•°ä¼šå•ç‹¬æŸ¥è¯¢æ•°æ®åº“ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œå»ºè®®ç›´æ¥åœ¨ visible_forums ä¸­
    ä¸€æ¬¡æ€§æŸ¥è¯¢ verification å’Œ universityï¼Œé¿å…é‡å¤è®¿é—®æ•°æ®åº“ã€‚
    """
    verification = await db.execute(
        select(StudentVerification)
        .join(University)
        .where(
            StudentVerification.user_id == user_id,
            StudentVerification.status == 'verified',
            StudentVerification.expires_at > func.now(),
            University.is_active == True
        )
    )
    verification = verification.scalar_one_or_none()
    if not verification:
        return None
    
    # æ–¹æ¡ˆ1ï¼šå¦‚æœ universities è¡¨æœ‰ code å­—æ®µ
    return verification.university.code if verification.university.code else None
    
    # æ–¹æ¡ˆ2ï¼šå¦‚æœ universities è¡¨æ²¡æœ‰ code å­—æ®µï¼Œé€šè¿‡ email_domain æ˜ å°„
    # return map_email_domain_to_code(verification.university.email_domain)

def is_uk_university(university: University) -> bool:
    """
    åˆ¤æ–­æ˜¯å¦ä¸ºè‹±å›½å¤§å­¦
    
    å®ç°æ–¹å¼ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
    1. å¦‚æœ universities è¡¨æœ‰ country å­—æ®µï¼šreturn university.country == 'UK'
    2. å¦åˆ™é€šè¿‡ email_domain åˆ¤æ–­ï¼šreturn university.email_domain.endswith('.ac.uk')
    
    **é‡è¦**ï¼šå¿…é¡»ä¸ã€Šè‹±å›½ç•™å­¦ç”Ÿè®¤è¯ç³»ç»Ÿæ–‡æ¡£ã€‹ä¸­"åˆ¤æ–­æ˜¯å¦è‹±å›½å¤§å­¦"çš„é€»è¾‘ 100% ä¿æŒä¸€è‡´ã€‚
    ä»»ä½•ä¿®æ”¹éƒ½éœ€è¦åŒæ­¥æ›´æ–°è®¤è¯ç³»ç»Ÿçš„åˆ¤æ–­é€»è¾‘ï¼Œé¿å…æƒé™åˆ¤æ–­ä¸ä¸€è‡´ã€‚
    """
    # æ–¹æ¡ˆ1ï¼šä½¿ç”¨ country å­—æ®µï¼ˆæ¨èï¼‰
    if hasattr(university, 'country') and university.country:
        return university.country == 'UK'
    
    # æ–¹æ¡ˆ2ï¼šé€šè¿‡ email_domain åˆ¤æ–­ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    return university.email_domain.endswith('.ac.uk')

async def visible_forums(user: User, db: AsyncSession) -> List[int]:
    """
    è·å–ç”¨æˆ·å¯è§çš„ã€å­¦æ ¡ç›¸å…³æ¿å—ã€‘ID åˆ—è¡¨ï¼ˆä¸åŒ…å« type='general' çš„æ™®é€šæ¿å—ï¼‰
    
    è¿”å›å€¼ï¼š
    - å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿï¼šè¿”å› [è‹±å›½ç•™å­¦ç”Ÿå¤§æ¿å—ID, è‡ªå·±å¤§å­¦çš„æ¿å—ID]
    - å…¶ä»–ç”¨æˆ·ï¼ˆåŒ…æ‹¬é UK å¤§å­¦è®¤è¯ç”¨æˆ·ï¼‰ï¼šè¿”å›ç©ºåˆ—è¡¨ []
    
    æ³¨æ„ï¼š
    - æ­¤å‡½æ•°ä¸è¿”å› type='general' çš„æ™®é€šæ¿å—ï¼Œè°ƒç”¨æ–¹éœ€è‡ªè¡Œåˆå¹¶ã€‚
    - **é‡è¦**ï¼šæ­¤å‡½æ•°åº”åœ¨ `require_student_verified(country="UK")` ä¾èµ–ä¹‹åè°ƒç”¨ï¼Œæˆ–ç¡®ä¿ä¼ å…¥çš„ç”¨æˆ·å·²é€šè¿‡ UK å­¦ç”Ÿè®¤è¯ã€‚
    """
    if not user or not user.is_authenticated:
        return []
    
    # è·å–ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼ˆä¸€æ¬¡æ€§æŸ¥è¯¢ï¼Œé¿å…é‡å¤ï¼‰
    # æ³¨æ„ï¼šè¿™é‡ŒåªæŸ¥è¯¢ verified çŠ¶æ€ï¼ŒUK åˆ¤æ–­åœ¨ä¸‹æ–¹æ˜¾å¼è¿›è¡Œ
    verification = await db.execute(
        select(StudentVerification)
        .join(University)
        .where(
            StudentVerification.user_id == user.id,
            StudentVerification.status == 'verified',
            StudentVerification.expires_at > func.now(),
            University.is_active == True
        )
    )
    verification = verification.scalar_one_or_none()
    
    if not verification:
        return []
    
    university = verification.university
    
    # æ˜¾å¼åˆ¤æ–­ï¼šæ˜¯å¦ä¸ºè‹±å›½å¤§å­¦ï¼Œé UK å¤§å­¦è®¤è¯ç”¨æˆ·ä¸å¼€æ”¾å­¦æ ¡æ¿å—è®¿é—®
    # é˜²å¾¡æ€§ç¼–ç¨‹ï¼šå³ä½¿è°ƒç”¨æ–¹æ²¡èµ° require_student_verifiedï¼Œä¹Ÿè¦åœ¨è¿™é‡ŒäºŒæ¬¡åˆ¤æ–­éUKå¤§å­¦
    # è¿™æ˜¯æœ€åä¸€é“é˜²çº¿ï¼Œç¡®ä¿é UK å¤§å­¦è®¤è¯ç”¨æˆ·æ— æ³•è®¿é—®å­¦æ ¡æ¿å—
    if not is_uk_university(university):
        return []
    
    # è·å– university_code
    university_code = None
    if hasattr(university, 'code') and university.code:
        university_code = university.code
    else:
        # å¦‚æœæ²¡æœ‰ code å­—æ®µï¼Œå¯é€šè¿‡ email_domain æ˜ å°„ï¼ˆéœ€å®ç°æ˜ å°„å‡½æ•°ï¼‰
        # university_code = map_email_domain_to_code(university.email_domain)
        pass
    
    forums = []
    # 1. æ·»åŠ è‹±å›½ç•™å­¦ç”Ÿå¤§æ¿å—ï¼ˆtype='root', country='UK'ï¼‰
    # æ³¨æ„ï¼šåŒä¸€å›½å®¶åªåº”æœ‰ä¸€ä¸ª root æ¿å—ï¼Œä½¿ç”¨ scalar_one_or_none() ç¡®ä¿å”¯ä¸€æ€§
    root_forum = await db.execute(
        select(ForumCategory.id)
        .where(
            ForumCategory.type == 'root',
            ForumCategory.country == 'UK',
            ForumCategory.is_visible == True
        )
    )
    root_id = root_forum.scalar_one_or_none()
    if root_id:
        forums.append(root_id)
    
    # 2. æ·»åŠ ç”¨æˆ·æ‰€å±å¤§å­¦çš„æ¿å—
    if university_code:
        university_forum = await db.execute(
            select(ForumCategory.id)
            .where(
                ForumCategory.type == 'university',
                ForumCategory.university_code == university_code,
                ForumCategory.is_visible == True
            )
        )
        uni_id = university_forum.scalar_one_or_none()
        if uni_id:
            forums.append(uni_id)
    
    return forums

# æ³¨æ„ï¼šå®ç°ä¸Šå¯å¤ç”¨æŸ¥è¯¢ï¼Œé¿å…é‡å¤è®¿é—®æ•°æ®åº“ã€‚
# ä¾‹å¦‚ï¼švisible_forums ä¸­å·²æŸ¥è¯¢äº† verification å’Œ universityï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€å†è°ƒç”¨ get_user_university_codeã€‚

async def assert_forum_visible(
    user: User, 
    forum_id: int, 
    db: AsyncSession,
    raise_exception: bool = True
) -> bool:
    """
    æ ¡éªŒç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®æŒ‡å®šæ¿å—
    
    æ³¨æ„ï¼šæ­¤å‡½æ•°åº”åœ¨ `require_student_verified(country="UK")` ä¾èµ–ä¹‹åè°ƒç”¨ï¼Œ
    æˆ–ç¡®ä¿ä¼ å…¥çš„ç”¨æˆ·å·²é€šè¿‡ UK å­¦ç”Ÿè®¤è¯ã€‚å¦åˆ™é UK å¤§å­¦è®¤è¯ç”¨æˆ·ä¹Ÿä¼šè¢«å…è®¸è®¿é—®ã€‚
    """
    # å½“å‰ç‰ˆæœ¬ï¼šç®¡ç†å‘˜/ç‰ˆä¸»å…¨å±€è¶Šæƒï¼›å¦‚éœ€ç»†åˆ†ï¼Œæ”¹ä¸º"ç‰ˆä¸»-æ¿å—æ˜ å°„"æ ¡éªŒ
    if user.is_admin_or_moderator:
        return True
    
    visible_ids = await visible_forums(user, db)
    if forum_id in visible_ids:
        return True
    
    if raise_exception:
        # å¯¹å¤–é»˜è®¤ 404 éšè—å­˜åœ¨æ€§ï¼›å†…éƒ¨/ç®¡ç†æ¥å£å¯é…ç½®ä¸º 403
        raise HTTPException(status_code=404, detail="Forum not found")
    return False
```

### FastAPI ä¾èµ–æ³¨å…¥ç¤ºä¾‹
```python
from fastapi import Depends, HTTPException, Path
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import Optional

# æ³¨æ„ï¼šä»¥ä¸‹å¯¼å…¥è·¯å¾„éœ€è¦æ ¹æ®å®é™…ä»£ç åº“è°ƒæ•´
# from app.models import User, StudentVerification, University, ForumCategory
# from app.deps import get_current_user_secure_async_csrf, get_async_db_dependency
# æˆ–ä½¿ç”¨ forum_routes.py ä¸­å·²å®šä¹‰çš„ä¾èµ–

async def check_forum_visibility(
    forum_id: int = Path(...),
    current_user: User = Depends(get_current_user_secure_async_csrf),  # æ ¹æ®å®é™…ä»£ç åº“è°ƒæ•´
    db: AsyncSession = Depends(get_async_db_dependency)  # æ ¹æ®å®é™…ä»£ç åº“è°ƒæ•´
):
    """
    FastAPI ä¾èµ–ï¼šæ ¡éªŒæ¿å—å¯è§æ€§
    
    æ³¨æ„ï¼šå¯¹äºå­¦æ ¡æ¿å—ï¼ˆtype='root' æˆ– type='university'ï¼‰ï¼Œ
    åº”é…åˆ require_student_verified(country="UK") ä½¿ç”¨ï¼Œç¡®ä¿åªå…è®¸ UK å­¦ç”Ÿè®¿é—®ã€‚
    """
    await assert_forum_visible(current_user, forum_id, db, raise_exception=True)
    return forum_id

# ä½¿ç”¨ç¤ºä¾‹ï¼šå­¦æ ¡æ¿å—æ¥å£ï¼ˆå¿…é¡»éªŒè¯ UK å­¦ç”Ÿèº«ä»½ï¼‰
@router.get("/forums/{forum_id}/posts")
async def get_school_forum_posts(
    forum_id: int = Depends(check_forum_visibility),  # è‡ªåŠ¨æ ¡éªŒæƒé™
    current_user: User = Depends(require_student_verified(country="UK")),  # ç¡®ä¿ UK å­¦ç”Ÿè®¤è¯
    db: AsyncSession = Depends(get_async_db_dependency)
):
    """
    è·å–å­¦æ ¡æ¿å—çš„å¸–å­åˆ—è¡¨
    
    æ³¨æ„ï¼šæ­¤æ¥å£åŒæ—¶ä½¿ç”¨ check_forum_visibility å’Œ require_student_verifiedï¼Œ
    ç¡®ä¿åªå…è®¸å·²è®¤è¯çš„ UK å­¦ç”Ÿè®¿é—®å­¦æ ¡æ¿å—ã€‚
    """
    # ä¸šåŠ¡é€»è¾‘ï¼Œæ­¤æ—¶å·²ç¡®ä¿ç”¨æˆ·æ˜¯ UK å­¦ç”Ÿä¸”æœ‰æƒé™è®¿é—®è¯¥æ¿å—
    posts = await db.execute(
        select(ForumPost)
        .where(ForumPost.category_id == forum_id, ForumPost.is_deleted == False)
    )
    return posts.scalars().all()

# ä½¿ç”¨ç¤ºä¾‹ï¼šæ™®é€šæ¿å—æ¥å£ï¼ˆæ— éœ€å­¦ç”Ÿè®¤è¯ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è®¿é—®ï¼‰
@router.get("/forums/{forum_id}/posts")
async def get_general_forum_posts(
    forum_id: int = Path(...),
    current_user: Optional[User] = Depends(get_current_user_optional),
    db: AsyncSession = Depends(get_async_db_dependency)
):
    """
    è·å–æ™®é€šæ¿å—çš„å¸–å­åˆ—è¡¨
    
    æ³¨æ„ï¼šæ™®é€šæ¿å—ï¼ˆtype='general'ï¼‰æ‰€æœ‰ç”¨æˆ·éƒ½å¯è®¿é—®ï¼Œæ— éœ€ç‰¹æ®Šæƒé™æ ¡éªŒã€‚
    ä½†å»ºè®®åœ¨ä¸šåŠ¡é€»è¾‘ä¸­éªŒè¯æ¿å—ç±»å‹ï¼Œç¡®ä¿ä¸ä¼šè¯¯ç”¨æ­¤æ¥å£è®¿é—®å­¦æ ¡æ¿å—ã€‚
    """
    # å¯é€‰ï¼šéªŒè¯æ¿å—ç±»å‹
    category = await db.get(ForumCategory, forum_id)
    if category and category.type != 'general':
        raise HTTPException(status_code=404, detail="Forum not found")
    
    posts = await db.execute(
        select(ForumPost)
        .where(ForumPost.category_id == forum_id, ForumPost.is_deleted == False)
    )
    return posts.scalars().all()
```

**é‡è¦**ï¼šæ‰€æœ‰è°ƒç”¨ `visible_forums` / `assert_forum_visible` çš„å­¦æ ¡æ¿å—ç›¸å…³æ¥å£ï¼Œéƒ½åº”å…ˆé€šè¿‡ `require_student_verified(country="UK")` ä¾èµ–ï¼Œç¡®ä¿åªå…è®¸ UK å­¦ç”Ÿè®¿é—®ã€‚å¦åˆ™é UK å¤§å­¦è®¤è¯ç”¨æˆ·ä¹Ÿä¼šè¢«å½“æˆ"verified å­¦ç”Ÿ"ã€‚

- æ‰€æœ‰æ¥å£å…±ç”¨ `assert_forum_visible`ï¼›å¯¹å¤–ä¸å¯è§ä¸€å¾‹è¿”å› 404ï¼ˆéšè—å­˜åœ¨æ€§ï¼‰ï¼›å†…éƒ¨/ç®¡ç†æ¥å£å¯æŒ‰é…ç½®æ˜¾å¼ 403ã€‚

## ğŸ”’ è®¿é—®æ§åˆ¶è§„åˆ™ï¼ˆç»Ÿä¸€æ ¡éªŒï¼‰
```text
1) æœªç™»å½•æˆ–æœªå­¦ç”Ÿè®¤è¯ â†’ æ‹’ç»æ‰€æœ‰å­¦æ ¡æ¿å—è¯»å†™
2) å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿï¼ˆç²¾ç¡®å®šä¹‰è§"è§’è‰²ä¸å¯è§æ€§çŸ©é˜µ"ï¼‰ï¼š
   - å…è®¸ï¼štype=root ä¸” country=UKï¼ˆè‹±å›½ç•™å­¦ç”Ÿå¤§æ¿å—ï¼‰
   - å…è®¸ï¼štype=university ä¸” university_code == user.university_code
   - æ‹’ç»ï¼šå…¶ä»– university_code
   - è‹¥ is_student_verified=True ä½† university_code ä¸ºç©ºï¼ˆå¼‚å¸¸æ•°æ®ï¼‰ï¼šä»…å…è®¸ root UKï¼Œæ‰€æœ‰ university æ¿å—æ‹’ç»
   - é UK å¤§å­¦è®¤è¯ç”¨æˆ·ï¼šä¸å¼€æ”¾å­¦æ ¡æ¿å—è®¿é—®
3) ç®¡ç†å‘˜/ç‰ˆä¸»ï¼šæŒ‰è§’è‰²ç­–ç•¥åˆ¤å®šï¼Œå¯è¶Šæƒ
```
- æ‰€æœ‰æ¥å£ï¼ˆåˆ—è¡¨/è¯¦æƒ…/å‘å¸–/å›å¤/ç‚¹èµç­‰ï¼‰è°ƒç”¨å‰ï¼Œéœ€æ ¡éªŒ `forum_id` æ˜¯å¦åœ¨ç”¨æˆ·å¯è§é›†åˆï¼›ä¸åœ¨åˆ™å¯¹å¤–ç»Ÿä¸€è¿”å› 404ï¼ˆéšè—å­˜åœ¨æ€§ï¼‰ï¼›å†…éƒ¨/ç®¡ç†æ¥å£å¯æŒ‰é…ç½®æ˜¾å¼ 403ã€‚
- æ·±é“¾è®¿é—®ï¼ˆç›´æ¥ URLï¼‰åŒæ ·æ‰§è¡Œæ ¡éªŒã€‚

## ğŸ”Œ API è®¾è®¡è¦ç‚¹
- `GET /forums/visible`
  - **æ³¨æ„**ï¼šæ­¤æ¥å£ä¸ºä¸“ç”¨æ¥å£ï¼Œç”¨äºè·å–å½“å‰ç”¨æˆ·å¯è§çš„æ¿å—åˆ—è¡¨ã€‚ä¸å»ºè®®å¤ç”¨ `GET /forums` æ¥å£ï¼Œé¿å…æ··æ·†ã€‚
  - å‡ºå‚ï¼š`[{id, name, type, country, university_code, description, icon, post_count}]`
  - å‚æ•°ï¼š
    - `include_all`ï¼ˆå¯é€‰ï¼Œboolï¼‰ï¼šç®¡ç†å‘˜æŸ¥çœ‹å…¨éƒ¨æ¿å—ï¼ˆå¸¦å­—æ®µ `can_manage=true`ï¼‰
    - `view_as`ï¼ˆå¯é€‰ï¼Œstrï¼‰ï¼šç®¡ç†å‘˜ä»¥æŒ‡å®šç”¨æˆ·IDè§†è§’æŸ¥çœ‹å¯è§æ¿å—ï¼ˆç”¨äºå®¢æœ/æ’é”™åœºæ™¯ï¼Œéœ€ç®¡ç†å‘˜æƒé™ï¼‰
  - é€»è¾‘ï¼š
    - **æœªç™»å½•/æœªè®¤è¯ç”¨æˆ·**ï¼šä»…è¿”å› `type='general'` çš„æ™®é€šæ¿å—ï¼ˆå­¦æ ¡ç›¸å…³æ¿å—ä¸è¿”å›ï¼‰
    - **å·²ç™»å½•ä½†æœªå­¦ç”Ÿè®¤è¯**ï¼šä»…è¿”å› `type='general'` çš„æ™®é€šæ¿å—ï¼ˆå­¦æ ¡ç›¸å…³æ¿å—ä¸è¿”å›ï¼‰
    - **å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿ**ï¼šè¿”å› `type='general'` + `type='root'`ï¼ˆcountry='UK'ï¼‰+ `type='university'`ï¼ˆåŒ¹é…å…¶ university_codeï¼‰çš„æ¿å—
    - **ç®¡ç†å‘˜**ï¼š
      - é»˜è®¤è¿”å›ä¸æ™®é€šç”¨æˆ·ä¸€è‡´çš„å¯è§åˆ—è¡¨
      - `?include_all=true`ï¼šè¿”å›å…¨éƒ¨æ¿å—ï¼ˆå¸¦å­—æ®µ `can_manage=true`ï¼‰
      - `?view_as={user_id}`ï¼šä»¥æŒ‡å®šç”¨æˆ·è§†è§’æŸ¥çœ‹å¯è§æ¿å—ï¼ˆç”¨äºå®¢æœ/æ’é”™ï¼‰
  - **é‡è¦**ï¼šå‰ç«¯å¿…é¡»ä½¿ç”¨æ­¤æ¥å£è·å–æ¿å—åˆ—è¡¨ï¼Œç¦æ­¢ç¡¬ç¼–ç æˆ–ç›´æ¥æŸ¥è¯¢æ‰€æœ‰æ¿å—
- `GET /forums/{id}/posts`
  - æ ¡éªŒ `assert_forum_visible` åå†æŸ¥è¯¢ï¼›åˆ†é¡µè¿”å›ã€‚
- `GET /posts/{id}`
  - æ ¹æ®å¸–å­ `forum_id` è°ƒç”¨ `assert_forum_visible`ã€‚
- `POST /forums/{id}/posts`
  - æ ¡éªŒå­¦ç”Ÿè®¤è¯ + æ¿å—å¯è§ï¼›å¯é€‰é™æµã€‚
- `POST /posts/{id}/reply`ã€ç‚¹èµ/æ”¶è—ã€å¸–å­/å›å¤åˆ é™¤/ç¼–è¾‘
  - å‡å…ˆæ ¡éªŒæ‰€å±æ¿å—å¯è§æ€§ã€‚
- é”™è¯¯ç ä¸æ–‡æ¡ˆå»ºè®®
  - 401ï¼šæœªç™»å½•ã€‚
  - 404ï¼šå·²ç™»å½•ä½†æ— æƒé™æ—¶ç»Ÿä¸€ 404ï¼ˆå¯¹å¤–éšè—å­˜åœ¨æ€§ï¼Œéœ€ä¸â€œçŠ¶æ€ç ç¡¬è§„åˆ™â€ä¸€è‡´ï¼‰ã€‚
  - 403ï¼šä»…å†…éƒ¨/ç®¡ç†æ¥å£å¯é€šè¿‡å¼€å…³æ˜¾å¼æ‹’ç»ï¼ˆéœ€å…¨å±€ä¸€è‡´ï¼‰ã€‚
  - 409ï¼šæ¿å—é…ç½®é”™è¯¯ï¼ˆå¦‚å¤§å­¦ç¼–ç ç¼ºå¤±å¯¼è‡´æ˜ å°„å¤±è´¥ï¼‰ã€‚

## ğŸ—ï¸ åç«¯å®ç°è¦ç‚¹ï¼ˆFastAPIï¼‰

### æ ¸å¿ƒæ¥å£å®ç°

#### `GET /forums/visible` æ¥å£å®ç°
```python
@router.get("/forums/visible")
async def get_visible_forums(
    include_all: bool = Query(False, description="ç®¡ç†å‘˜æŸ¥çœ‹å…¨éƒ¨æ¿å—"),
    view_as: Optional[str] = Query(None, description="ç®¡ç†å‘˜ä»¥æŒ‡å®šç”¨æˆ·è§†è§’æŸ¥çœ‹ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰"),
    current_user: Optional[User] = Depends(get_current_user_optional),  # å…è®¸æœªç™»å½•
    db: AsyncSession = Depends(get_async_db_dependency)
):
    """
    è·å–å½“å‰ç”¨æˆ·å¯è§çš„æ¿å—åˆ—è¡¨
    
    å‚æ•°è¯´æ˜ï¼š
    - include_all: ç®¡ç†å‘˜æŸ¥çœ‹å…¨éƒ¨æ¿å—ï¼ˆå¸¦ can_manage=true å­—æ®µï¼‰
    - view_as: ç®¡ç†å‘˜ä»¥æŒ‡å®šç”¨æˆ·IDè§†è§’æŸ¥çœ‹å¯è§æ¿å—ï¼ˆç”¨äºå®¢æœ/æ’é”™åœºæ™¯ï¼‰
    """
    # ç®¡ç†å‘˜ç‰¹æ®Šå¤„ç†ï¼šä»¥æŒ‡å®šç”¨æˆ·è§†è§’æŸ¥çœ‹
    if view_as and current_user and current_user.is_admin_or_moderator:
        target_user = await db.get(User, view_as)
        if not target_user:
            raise HTTPException(status_code=404, detail="User not found")
        visible_ids = await visible_forums(target_user, db)
        if not visible_ids:
            # è¿”å›æ™®é€šæ¿å—
            forums = await db.execute(
                select(ForumCategory)
                .where(
                    ForumCategory.type == 'general',
                    ForumCategory.is_visible == True
                )
                .order_by(ForumCategory.sort_order, ForumCategory.created_at)
            )
            return [forum.dict() for forum in forums.scalars().all()]
        # è¿”å›è¯¥ç”¨æˆ·å¯è§çš„æ¿å—
        stmt_school = select(ForumCategory).where(
            ForumCategory.id.in_(visible_ids),
            ForumCategory.is_visible == True
        )
        stmt_general = select(ForumCategory).where(
            ForumCategory.type == 'general',
            ForumCategory.is_visible == True
        )
        union_stmt = stmt_school.union(stmt_general).order_by(
            ForumCategory.sort_order, 
            ForumCategory.created_at
        )
        forums = await db.execute(union_stmt)
        return [forum.dict() for forum in forums.scalars().all()]
    
    # ç®¡ç†å‘˜ç‰¹æ®Šå¤„ç†ï¼šæŸ¥çœ‹å…¨éƒ¨æ¿å—
    if include_all and current_user and current_user.is_admin_or_moderator:
        forums = await db.execute(
            select(ForumCategory)
            .where(ForumCategory.is_visible == True)
            .order_by(ForumCategory.sort_order, ForumCategory.created_at)
        )
        return [
            {
                **forum.dict(),
                "can_manage": True
            }
            for forum in forums.scalars().all()
        ]
    
    # æ™®é€šç”¨æˆ·ï¼šæ ¹æ®èº«ä»½è¿”å›å¯è§æ¿å—
    if not current_user or not current_user.is_authenticated:
        # æœªç™»å½•ï¼šä»…è¿”å›æ™®é€šæ¿å—
        forums = await db.execute(
            select(ForumCategory)
            .where(
                ForumCategory.type == 'general',
                ForumCategory.is_visible == True
            )
            .order_by(ForumCategory.sort_order, ForumCategory.created_at)
        )
        return [forum.dict() for forum in forums.scalars().all()]
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºå­¦ç”Ÿè®¤è¯ç”¨æˆ·
    visible_ids = await visible_forums(current_user, db)
    
    if not visible_ids:
        # æœªå­¦ç”Ÿè®¤è¯ï¼šä»…è¿”å›æ™®é€šæ¿å—
        forums = await db.execute(
            select(ForumCategory)
            .where(
                ForumCategory.type == 'general',
                ForumCategory.is_visible == True
            )
            .order_by(ForumCategory.sort_order, ForumCategory.created_at)
        )
        return [forum.dict() for forum in forums.scalars().all()]
    
    # å·²è®¤è¯å­¦ç”Ÿï¼šè¿”å›æ™®é€šæ¿å— + å¯è§çš„å­¦æ ¡æ¿å—
    # æ³¨æ„ï¼šSQLAlchemy ä¸­ union() éœ€å…ˆæ„å»ºä¸¤ä¸ªç‹¬ç«‹çš„ selectï¼Œå† unionï¼Œæœ€å order_by
    stmt_school = select(ForumCategory).where(
        ForumCategory.id.in_(visible_ids),
        ForumCategory.is_visible == True
    )
    stmt_general = select(ForumCategory).where(
        ForumCategory.type == 'general',
        ForumCategory.is_visible == True
    )
    union_stmt = stmt_school.union(stmt_general).order_by(
        ForumCategory.sort_order, 
        ForumCategory.created_at
    )
    forums = await db.execute(union_stmt)
    return [forum.dict() for forum in forums.scalars().all()]
```

### ä¾èµ–/ä¸­é—´ä»¶
- `get_current_user`ï¼šè·å–ç”¨æˆ·ä¸è§’è‰²ã€‚
- `get_current_user_optional`ï¼šå¯é€‰ç”¨æˆ·ï¼ˆç”¨äº `/forums/visible` æ¥å£ï¼Œå…è®¸æœªç™»å½•è®¿é—®ï¼‰
- `require_student_verified(country="UK")`ï¼šç¡®ä¿è‹±å›½ç•™å­¦ç”Ÿè®¤è¯æœ‰æ•ˆã€æœªè¿‡æœŸï¼›å®šä¹‰ä¸º `status == 'verified'`ã€‚
- `check_forum_visibility(forum_id)`ï¼šæ ¸å¿ƒæ ¡éªŒï¼Œå†…éƒ¨è°ƒç”¨ `visible_forums`ã€‚

### å¤ç”¨æ–¹å¼
- åœ¨è·¯ç”±å±‚æ³¨å…¥ `Depends(check_forum_visibility)`ï¼Œé¿å…ä¸šåŠ¡é‡å¤åˆ¤æ–­ã€‚
- ç®¡ç†æ¥å£å•ç‹¬èµ° `require_admin_or_moderator`ã€‚
- **é‡è¦**ï¼šæ‰€æœ‰è·å–æ¿å—åˆ—è¡¨çš„æ¥å£å¿…é¡»è°ƒç”¨ `visible_forums` æˆ– `/forums/visible`ï¼Œç¦æ­¢ç›´æ¥æŸ¥è¯¢æ‰€æœ‰æ¿å—ã€‚

### ç¼“å­˜ç­–ç•¥

#### ç¼“å­˜é”®è®¾è®¡ï¼ˆæ¨èæ–¹æ¡ˆï¼‰
**æ–¹æ¡ˆ1ï¼ˆç®€å•ç²—æš´ï¼Œæ¨èç”Ÿäº§ä½¿ç”¨ï¼‰**ï¼š
- ç¼“å­˜é”®ï¼š`visible_forums:v2:{user_id}`
- å¤±æ•ˆæ–¹å¼ï¼šè®¤è¯çŠ¶æ€å˜æ›´ã€å¤§å­¦å˜æ›´ã€æ’¤é”€æ—¶ï¼Œç»Ÿä¸€æ‰§è¡Œ `DEL visible_forums:v2:{user_id}` æˆ– `DEL visible_forums:v2:*`ï¼ˆæ‰¹é‡å¤±æ•ˆï¼‰
- ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œå¤±æ•ˆé€»è¾‘æ¸…æ™°ï¼Œé€‚åˆ Redis è®¢é˜…è®¤è¯å˜æ›´äº‹ä»¶ç»Ÿä¸€å¤„ç†

**æ–¹æ¡ˆ2ï¼ˆç‰ˆæœ¬å·æ–¹æ¡ˆï¼Œå¯é€‰ï¼‰**ï¼š
- ç¼“å­˜é”®ï¼š`visible_forums:{user_id}:{verification_version}`
- `verification_version` å¯å– `student_verifications.updated_at`ï¼ˆæ—¶é—´æˆ³ï¼‰æˆ–ç‹¬ç«‹ç‰ˆæœ¬å·å­—æ®µ
- å¤±æ•ˆæ–¹å¼ï¼šè®¤è¯çŠ¶æ€å˜æ›´æ—¶æ›´æ–° `verification_version`ï¼Œæ—§ç‰ˆæœ¬ç¼“å­˜è‡ªç„¶è¿‡æœŸ
- ä¼˜ç‚¹ï¼šæ”¯æŒå¤šç‰ˆæœ¬å…±å­˜ï¼Œä¾¿äºè°ƒè¯•

#### ç¼“å­˜å¤±æ•ˆæ—¶æœº
- è®¤è¯çŠ¶æ€å˜æ›´ï¼ˆverified/pendingâ†’expired/revokedï¼‰
- å¤§å­¦å˜æ›´ï¼ˆuniversity_id å˜æ›´ï¼‰
- è®¤è¯æ’¤é”€
- å»ºè®®ï¼šé€šè¿‡ Redis è®¢é˜…è®¤è¯å˜æ›´äº‹ä»¶ï¼Œç»Ÿä¸€å¤„ç†ç¼“å­˜å¤±æ•ˆ

#### ç¼“å­˜å†…å®¹
- ç¼“å­˜ç”¨æˆ·å¯è§çš„æ¿å—IDåˆ—è¡¨ï¼Œè€Œéæ‰€æœ‰æ¿å—åˆ—è¡¨
- ç¼“å­˜æ—¶é—´å»ºè®®ï¼š5-15 åˆ†é’Ÿï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´ï¼‰

### è¯Šæ–­/æ—¥å¿—
- è®°å½•è¢«æ‹’ç»è®¿é—®çš„ `user_id / forum_id / path`ï¼Œä¾¿äºå®‰å…¨å®¡è®¡ä¸æ•…éšœæ’æŸ¥ã€‚
- è®°å½• `/forums/visible` æ¥å£è°ƒç”¨ï¼Œç›‘æ§ä¸åŒç”¨æˆ·èº«ä»½è¿”å›çš„æ¿å—æ•°é‡ã€‚

## ğŸ–¥ï¸ å‰ç«¯å±•ç¤ºä¸é˜²æŠ¤

### æ¿å—åˆ—è¡¨æ¸²æŸ“è§„åˆ™ï¼ˆæ ¸å¿ƒè¦æ±‚ï¼‰

**å¿…é¡»æ ¹æ®ç”¨æˆ·èº«ä»½åŠ¨æ€æ¸²æŸ“æ¿å—åˆ—è¡¨ï¼Œç¦æ­¢ç¡¬ç¼–ç æˆ–æ˜¾ç¤ºæ‰€æœ‰æ¿å—ã€‚**

#### æ¸²æŸ“é€»è¾‘
1. **æ™®é€šç”¨æˆ·ï¼ˆæœªç™»å½•/å·²ç™»å½•ä½†æœªå­¦ç”Ÿè®¤è¯ï¼‰**ï¼š
   - âœ… æ¸²æŸ“ï¼š`type='general'` çš„æ™®é€šæ¿å—ï¼ˆå¦‚"ç»¼åˆè®¨è®º"ã€"ç”Ÿæ´»åˆ†äº«"ç­‰ï¼‰
   - âŒ **ä¸æ¸²æŸ“**ï¼š`type='root'` çš„å­¦ç”Ÿå¤§æ¿å—ï¼ˆå¦‚"è‹±å›½ç•™å­¦ç”Ÿ"ï¼‰
   - âŒ **ä¸æ¸²æŸ“**ï¼š`type='university'` çš„å­¦æ ¡å°æ¿å—ï¼ˆå¦‚"å¸ƒé‡Œæ–¯æ‰˜å¤§å­¦"ï¼‰

2. **å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿç”¨æˆ·**ï¼š
   - âœ… æ¸²æŸ“ï¼š`type='general'` çš„æ™®é€šæ¿å—
   - âœ… æ¸²æŸ“ï¼š`type='root'` ä¸” `country='UK'` çš„å­¦ç”Ÿå¤§æ¿å—ï¼ˆå¦‚"è‹±å›½ç•™å­¦ç”Ÿ"ï¼‰
   - âœ… æ¸²æŸ“ï¼š`type='university'` ä¸” `university_code` åŒ¹é…å…¶å­¦æ ¡çš„æ¿å—ï¼ˆå¦‚"å¸ƒé‡Œæ–¯æ‰˜å¤§å­¦"ï¼‰
   - âŒ **ä¸æ¸²æŸ“**ï¼šå…¶ä»–å¤§å­¦çš„ `type='university'` æ¿å—

3. **ç®¡ç†å‘˜/ç‰ˆä¸»**ï¼š
   - âœ… æ¸²æŸ“ï¼šæ‰€æœ‰æ¿å—ï¼ˆå¯é€šè¿‡ `?include_all=true` è·å–ï¼‰
   - éœ€æ˜¾å¼æƒé™æ ‡è¯†åŒºåˆ†ç®¡ç†è§†å›¾å’Œæ™®é€šè§†å›¾

#### å®ç°æ–¹å¼
- **å¯¼èˆªæ /ä¾§æ /ä¸‹æ‹‰èœå•**ï¼šåªæ¸²æŸ“ `/forums/visible` æ¥å£è¿”å›çš„æ¿å—åˆ—è¡¨
- **æ¿å—åˆ—è¡¨é¡µé¢**ï¼šè°ƒç”¨ `/forums/visible` æ¥å£ï¼Œæ ¹æ®è¿”å›ç»“æœæ¸²æŸ“
- **ç¦æ­¢**ï¼š
  - âŒ ç¡¬ç¼–ç å­¦æ ¡æ¿å—åç§°æˆ–ID
  - âŒ å‰ç«¯ç›´æ¥æŸ¥è¯¢æ‰€æœ‰æ¿å—ç„¶åè¿‡æ»¤
  - âŒ ç¼“å­˜æ‰€æœ‰æ¿å—åˆ—è¡¨ï¼ˆåº”ç¼“å­˜ç”¨æˆ·å¯è§åˆ—è¡¨ï¼‰

#### å…¶ä»–é˜²æŠ¤æªæ–½
- **ç›´è¾¾é“¾æ¥**ï¼šåç«¯å¯¹å¤–ç»Ÿä¸€è¿”å› 404ï¼ˆéšè—å­˜åœ¨æ€§ï¼‰ï¼›å‰ç«¯ç»Ÿä¸€æç¤º"æ— è®¿é—®æƒé™/éœ€å­¦ç”Ÿè®¤è¯"ï¼Œæä¾›è·³è½¬è®¤è¯é¡µæˆ–ä¸»é¡µ
- **äº¤äº’å…¥å£**ï¼šæ— æƒé™æ—¶éšè—å‘å¸–/å›å¤æŒ‰é’®ï¼›ä»…åœ¨å¯è§æ¿å—å†…æ˜¾ç¤ºäº¤äº’å…¥å£
- **çŠ¶æ€åŒæ­¥**ï¼šç”¨æˆ·åˆ‡æ¢/é€€å‡ºç™»å½•åç«‹å³åˆ·æ–°å¯è§åˆ—è¡¨ï¼›æ¸…ç†å®¢æˆ·ç«¯ç¼“å­˜
- **ç®¡ç†å‘˜è§†å›¾**ï¼šå…è®¸ç®¡ç†å‘˜åœ¨å‰ç«¯å·¥å…·æ€æŸ¥çœ‹æ‰€æœ‰æ¿å—ï¼ˆéœ€æ˜¾å¼æƒé™æ ‡è¯†ï¼Œå¦‚"ç®¡ç†è§†å›¾"åˆ‡æ¢æŒ‰é’®ï¼‰

### å‰ç«¯ä»£ç ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰
```javascript
// React/Vue ç¤ºä¾‹
async function loadVisibleForums() {
  const response = await fetch('/api/forums/visible', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const forums = await response.json();
  
  // åªæ¸²æŸ“è¿”å›çš„æ¿å—ï¼Œä¸è¿›è¡Œé¢å¤–è¿‡æ»¤
  return forums.filter(forum => forum.is_visible);
}

// æ¸²æŸ“é€»è¾‘
function ForumList() {
  const forums = useVisibleForums(); // è°ƒç”¨ loadVisibleForums
  
  return (
    <div>
      {forums.map(forum => (
        <ForumCard key={forum.id} forum={forum} />
      ))}
      {/* æ™®é€šç”¨æˆ·ä¸ä¼šçœ‹åˆ°å­¦æ ¡ç›¸å…³æ¿å— */}
      {/* å­¦ç”Ÿç”¨æˆ·ä¼šçœ‹åˆ°"è‹±å›½ç•™å­¦ç”Ÿ"å’Œè‡ªå·±å¤§å­¦çš„æ¿å— */}
    </div>
  );
}
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹ï¼ˆå…³é”®åœºæ™¯ï¼‰

### æ¿å—åˆ—è¡¨æ¸²æŸ“æµ‹è¯•ï¼ˆ`GET /forums/visible`ï¼‰

#### æ™®é€šç”¨æˆ·ï¼ˆæœªç™»å½•/å·²ç™»å½•ä½†æœªå­¦ç”Ÿè®¤è¯ï¼‰
- âœ… **åº”è¿”å›**ï¼šä»… `type='general'` çš„æ™®é€šæ¿å—ï¼ˆå¦‚"ç»¼åˆè®¨è®º"ã€"ç”Ÿæ´»åˆ†äº«"ï¼‰
- âŒ **ä¸åº”è¿”å›**ï¼š`type='root'` çš„å­¦ç”Ÿå¤§æ¿å—ï¼ˆå¦‚"è‹±å›½ç•™å­¦ç”Ÿ"ï¼‰
- âŒ **ä¸åº”è¿”å›**ï¼š`type='university'` çš„ä»»ä½•å­¦æ ¡å°æ¿å—
- **å‰ç«¯éªŒè¯**ï¼šå¯¼èˆªæ /ä¾§æ /æ¿å—åˆ—è¡¨é¡µé¢ä¸åº”æ˜¾ç¤ºä»»ä½•å­¦æ ¡ç›¸å…³æ¿å—

#### å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿç”¨æˆ·
- âœ… **åº”è¿”å›**ï¼š
  - `type='general'` çš„æ™®é€šæ¿å—
  - `type='root'` ä¸” `country='UK'` çš„å­¦ç”Ÿå¤§æ¿å—ï¼ˆå¦‚"è‹±å›½ç•™å­¦ç”Ÿ"ï¼‰
  - `type='university'` ä¸” `university_code` åŒ¹é…å…¶å­¦æ ¡çš„æ¿å—ï¼ˆå¦‚å¸ƒé‡Œæ–¯æ‰˜å­¦ç”Ÿçœ‹åˆ°"å¸ƒé‡Œæ–¯æ‰˜å¤§å­¦"ï¼‰
- âŒ **ä¸åº”è¿”å›**ï¼šå…¶ä»–å¤§å­¦çš„ `type='university'` æ¿å—
- **å‰ç«¯éªŒè¯**ï¼šåº”æ˜¾ç¤º"è‹±å›½ç•™å­¦ç”Ÿ"å’Œè‡ªå·±å¤§å­¦çš„æ¿å—ï¼Œä¸æ˜¾ç¤ºå…¶ä»–å¤§å­¦æ¿å—

#### å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿä½†æ—  `university_code`ï¼ˆå¼‚å¸¸æ•°æ®ï¼‰
- âœ… **åº”è¿”å›**ï¼š
  - `type='general'` çš„æ™®é€šæ¿å—
  - `type='root'` ä¸” `country='UK'` çš„å­¦ç”Ÿå¤§æ¿å—
- âŒ **ä¸åº”è¿”å›**ï¼šä»»ä½• `type='university'` çš„æ¿å—

#### é UK å¤§å­¦è®¤è¯ç”¨æˆ·ï¼ˆå¦‚ç¾å›½ã€åŠ æ‹¿å¤§ç­‰ï¼‰
- âœ… **åº”è¿”å›**ï¼šä»… `type='general'` çš„æ™®é€šæ¿å—
- âŒ **ä¸åº”è¿”å›**ï¼š`type='root'` çš„å­¦ç”Ÿå¤§æ¿å—ï¼ˆå¦‚"è‹±å›½ç•™å­¦ç”Ÿ"ï¼‰
- âŒ **ä¸åº”è¿”å›**ï¼šä»»ä½• `type='university'` çš„æ¿å—
- **è¡Œä¸ºéªŒè¯**ï¼š
  - `visible_forums()` è¿”å›ç©ºåˆ—è¡¨ `[]`
  - `/forums/visible` æ ¹æ® `visible_ids` ä¸ºç©ºï¼Œå½“æˆ"æœªå­¦ç”Ÿè®¤è¯"å¤„ç†ï¼Œåªè¿”å› `general` æ¿å—
- **å‰ç«¯éªŒè¯**ï¼šä¸åº”æ˜¾ç¤ºä»»ä½•å­¦æ ¡ç›¸å…³æ¿å—

#### ç®¡ç†å‘˜
- âœ… **åº”è¿”å›**ï¼šæ‰€æœ‰æ¿å—ï¼ˆé€šè¿‡ `?include_all=true`ï¼‰
- âœ… **å­—æ®µéªŒè¯**ï¼šè¿”å›ç»“æœåŒ…å« `can_manage=true` å­—æ®µ
- âœ… **view_as åŠŸèƒ½**ï¼šé€šè¿‡ `?view_as={user_id}` å¯ä»¥ä»¥æŒ‡å®šç”¨æˆ·è§†è§’æŸ¥çœ‹å¯è§æ¿å—
  - æµ‹è¯•åœºæ™¯ï¼šç®¡ç†å‘˜æŸ¥çœ‹æ™®é€šç”¨æˆ·è§†è§’ â†’ åº”è¿”å›è¯¥ç”¨æˆ·å¯è§çš„æ¿å—
  - æµ‹è¯•åœºæ™¯ï¼šç®¡ç†å‘˜æŸ¥çœ‹å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿè§†è§’ â†’ åº”è¿”å›è¯¥å­¦ç”Ÿå¯è§çš„æ¿å—ï¼ˆåŒ…æ‹¬å­¦æ ¡æ¿å—ï¼‰
  - æµ‹è¯•åœºæ™¯ï¼šç®¡ç†å‘˜æŸ¥çœ‹é UK è®¤è¯ç”¨æˆ·è§†è§’ â†’ åº”è¿”å›ä»…æ™®é€šæ¿å—
  - **æƒé™éªŒè¯**ï¼šéç®¡ç†å‘˜ä½¿ç”¨ `view_as` å‚æ•°åº”è¢«æ‹’ç»æˆ–å¿½ç•¥

### æƒé™æ‹’ç»æµ‹è¯•
- æœªç™»å½•è®¿é—®å­¦æ ¡æ¿å—/å¸–å­ â†’ 401ã€‚
- å·²ç™»å½•æœªå­¦ç”Ÿè®¤è¯è®¿é—®å­¦æ ¡æ¿å—/å¸–å­ â†’ 404ï¼ˆå¯¹å¤–éšè—å­˜åœ¨æ€§ï¼›å†…éƒ¨å¦‚å¼€å¯æ˜¾å¼æ‹’ç»åˆ™ 403ï¼‰ã€‚
- **é UK å¤§å­¦è®¤è¯ç”¨æˆ·è®¿é—®å­¦æ ¡æ¿å—/å¸–å­** â†’ 404ï¼ˆ`visible_forums` è¿”å›ç©ºåˆ—è¡¨ï¼Œ`assert_forum_visible` æ‹’ç»è®¿é—®ï¼‰ã€‚

### æ­£å¸¸æ”¾è¡Œæµ‹è¯•
- å·²è®¤è¯è‹±å›½ç•™å­¦ç”Ÿ `university_code=UOB`ï¼ˆå¸ƒé‡Œæ–¯æ‰˜ï¼‰ï¼š
  - å¯è§/å¯æ“ä½œï¼šè‹±å›½ç•™å­¦ç”Ÿã€å¸ƒé‡Œæ–¯æ‰˜å¤§å­¦ã€‚
  - ä¸å¯è§/ä¸å¯æ“ä½œï¼šå…¶ä»–å¤§å­¦ã€‚

### ç›´è¾¾é“¾æ¥æµ‹è¯•
- è®¿é—®ä¸å¯è§æ¿å—æˆ–å¸–å­ï¼Œå¯¹å¤– 404ï¼›å†…éƒ¨æ˜¾å¼æ‹’ç»åˆ™ 403ã€‚
- **å‰ç«¯éªŒè¯**ï¼šæ˜¾ç¤ºç»Ÿä¸€é”™è¯¯æç¤º"æ— è®¿é—®æƒé™/éœ€å­¦ç”Ÿè®¤è¯"ï¼Œæä¾›è·³è½¬é“¾æ¥ã€‚

### è®¤è¯å˜æ›´æµ‹è¯•
- æ’¤é”€æˆ–è¿‡æœŸåï¼Œç«‹å³æ— æ³•è®¿é—®å­¦æ ¡æ¿å—ï¼ˆç¼“å­˜åº”å¤±æ•ˆï¼‰ã€‚
- **å‰ç«¯éªŒè¯**ï¼šåˆ·æ–°æ¿å—åˆ—è¡¨åï¼Œå­¦æ ¡ç›¸å…³æ¿å—åº”æ¶ˆå¤±ã€‚

### æ€§èƒ½/ç¼“å­˜æµ‹è¯•
- å¤šæ¬¡è®¿é—® `visible` åº”å‘½ä¸­ç¼“å­˜ï¼›å˜æ›´åç¼“å­˜å¤±æ•ˆç”Ÿæ•ˆã€‚
- **å‰ç«¯éªŒè¯**ï¼šç”¨æˆ·åˆ‡æ¢/é€€å‡ºç™»å½•åï¼Œæ¿å—åˆ—è¡¨åº”ç«‹å³æ›´æ–°ã€‚

## ğŸš¦ çŠ¶æ€ç ç¡¬è§„åˆ™ï¼ˆå»ºè®®ç»Ÿä¸€ï¼‰
| åœºæ™¯                            | çŠ¶æ€ç  | è¯´æ˜ |
|---------------------------------|--------|------|
| æœªç™»å½•                          | 401    | éœ€è¦ç™»å½• |
| å·²ç™»å½•ä½†æ— æƒé™ï¼ˆå­¦æ ¡æ¿å—/å¸–å­ï¼‰ | 404    | éšè—å­˜åœ¨æ€§ï¼Œç»Ÿä¸€è¿”å› 404ï¼ˆæ¨èï¼‰ |
| ç®¡ç†æˆ–è°ƒè¯•éœ€è¦æ˜¾å¼æ‹’ç»          | 403    | å¯é€šè¿‡é…ç½®å¼€å…³å¯ç”¨ï¼Œä»…é™å†…éƒ¨/ç®¡ç†æ¥å£ |
> **é»˜è®¤ç­–ç•¥**ï¼šå¯¹å¤–æ¥å£æœªæˆæƒä¸€å¾‹ 404ï¼Œé¿å…æ³„éœ²æ¿å—å­˜åœ¨ï¼›ä»…æœªç™»å½•è¿”å› 401ã€‚è‹¥ä¸šåŠ¡æ›´åå‘æ˜¾å¼æ‹’ç»ï¼Œå¯å°†"å·²ç™»å½•æ— æƒé™"æ”¹ä¸º 403ï¼Œä½†éœ€å…¨å±€ä¸€è‡´ã€‚

> **å¼ºåˆ¶è¦æ±‚**ï¼šæ‰€æœ‰å­¦æ ¡æ¿å—/å¸–å­ç›¸å…³å¯¹å¤–æ¥å£å¿…é¡»éµå®ˆä¸Šè¿°çŠ¶æ€ç çº¦å®šï¼Œä¸å¾—å•ç‹¬çº¦å®šä¾‹å¤–ã€‚æ–°å¢æ¥å£æ—¶éœ€ç»Ÿä¸€ä½¿ç”¨ `assert_forum_visible` æˆ– `check_forum_visibility` ä¾èµ–ï¼Œç¡®ä¿çŠ¶æ€ç ä¸€è‡´æ€§ã€‚

## ğŸ“ æ•°æ®åº“è¿ç§»è„šæœ¬ç¤ºä¾‹

### å®Œæ•´è¿ç§»è„šæœ¬ï¼ˆSQLï¼‰
```sql
-- è¿ç§»è„šæœ¬ï¼šæ·»åŠ å­¦æ ¡æ¿å—è®¿é—®æ§åˆ¶å­—æ®µ
-- åˆ›å»ºæ—¶é—´: 2025-12-06
-- è¯´æ˜: ä¸º forum_categories è¡¨æ·»åŠ  type, country, university_code å­—æ®µ

BEGIN;

-- 1. æ·»åŠ æ–°å­—æ®µ
ALTER TABLE forum_categories 
ADD COLUMN IF NOT EXISTS type VARCHAR(20) DEFAULT 'general',
ADD COLUMN IF NOT EXISTS country VARCHAR(10),
ADD COLUMN IF NOT EXISTS university_code VARCHAR(50);

-- 2. æ·»åŠ çº¦æŸ
DO $$
BEGIN
    -- æ£€æŸ¥çº¦æŸæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'chk_forum_type_university_code'
    ) THEN
        ALTER TABLE forum_categories 
        ADD CONSTRAINT chk_forum_type_university_code 
        CHECK (
            (type = 'university' AND university_code IS NOT NULL) OR 
            (type IN ('general', 'root') AND university_code IS NULL)
        );
    END IF;
END $$;

-- 3. æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_forum_categories_type_country 
ON forum_categories(type, country) 
WHERE type IN ('root', 'university');

CREATE INDEX IF NOT EXISTS idx_forum_categories_university_code 
ON forum_categories(university_code) 
WHERE university_code IS NOT NULL;

-- 4. åˆ›å»º"è‹±å›½ç•™å­¦ç”Ÿ"å¤§æ¿å—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
INSERT INTO forum_categories (name, description, type, country, sort_order, is_visible)
SELECT 'è‹±å›½ç•™å­¦ç”Ÿ', 'è‹±å›½ç•™å­¦ç”Ÿäº¤æµè®¨è®ºåŒº', 'root', 'UK', 0, true
WHERE NOT EXISTS (
    SELECT 1 FROM forum_categories WHERE name = 'è‹±å›½ç•™å­¦ç”Ÿ'
);

-- 5. ä¸ºç°æœ‰å­¦æ ¡ç›¸å…³æ¿å—æ ‡è®°ç±»å‹ï¼ˆç¤ºä¾‹ï¼šéœ€è¦æ ¹æ®å®é™…æ•°æ®è°ƒæ•´ï¼‰
-- å‡è®¾å·²æœ‰"å¸ƒé‡Œæ–¯æ‰˜å¤§å­¦"æ¿å—ï¼Œéœ€è¦æ‰‹åŠ¨æˆ–é€šè¿‡è„šæœ¬æ›´æ–°
-- UPDATE forum_categories 
-- SET type = 'university', university_code = 'UOB', country = 'UK'
-- WHERE name LIKE '%å¸ƒé‡Œæ–¯æ‰˜%' OR name LIKE '%Bristol%';

COMMIT;
```

### ä¸º universities è¡¨æ·»åŠ å­—æ®µï¼ˆå¿…é¡»ï¼‰
```sql
-- ä¸º universities è¡¨æ·»åŠ  country å’Œ code å­—æ®µ
BEGIN;

-- 1. æ·»åŠ  country å­—æ®µï¼ˆå¿…é¡»ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦è‹±å›½å¤§å­¦ï¼‰
ALTER TABLE universities 
ADD COLUMN IF NOT EXISTS country VARCHAR(10);

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_universities_country 
ON universities(country) 
WHERE country IS NOT NULL;

-- ä¸ºç°æœ‰è‹±å›½å¤§å­¦å¡«å…… countryï¼ˆé€šè¿‡ email_domain åˆ¤æ–­ï¼‰
UPDATE universities 
SET country = 'UK' 
WHERE email_domain LIKE '%.ac.uk' AND country IS NULL;

-- 2. æ·»åŠ  code å­—æ®µï¼ˆæ¨èï¼Œç”¨äºå¤§å­¦ç¼–ç ï¼‰
ALTER TABLE universities 
ADD COLUMN IF NOT EXISTS code VARCHAR(50);

-- æ·»åŠ å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX IF NOT EXISTS idx_universities_code_unique 
ON universities(code) 
WHERE code IS NOT NULL;

-- ç¤ºä¾‹ï¼šä¸ºç°æœ‰å¤§å­¦å¡«å…… codeï¼ˆéœ€è¦æ ¹æ®å®é™…æ•°æ®è°ƒæ•´ï¼‰
-- UPDATE universities SET code = 'UOB' WHERE email_domain = 'bristol.ac.uk';
-- UPDATE universities SET code = 'UOX' WHERE email_domain = 'ox.ac.uk';
-- UPDATE universities SET code = 'UCAM' WHERE email_domain = 'cam.ac.uk';

COMMIT;
```

### æ•°æ®ä¸€è‡´æ€§æ ¡éªŒè„šæœ¬
```sql
-- æ ¡éªŒè„šæœ¬ï¼šæ£€æŸ¥ forum_categories ä¸ universities çš„ç¼–ç ä¸€è‡´æ€§
SELECT 
    fc.id as forum_id,
    fc.name as forum_name,
    fc.university_code as forum_code,
    u.id as university_id,
    u.name as university_name,
    u.code as university_code,
    CASE 
        WHEN fc.university_code IS NULL AND fc.type = 'university' THEN 'ERROR: universityæ¿å—ç¼ºå°‘university_code'
        WHEN fc.university_code IS NOT NULL AND fc.type != 'university' THEN 'ERROR: éuniversityæ¿å—ä¸åº”æœ‰university_code'
        WHEN fc.university_code IS NOT NULL AND u.code IS NULL THEN 'WARNING: universitiesè¡¨ç¼ºå°‘codeå­—æ®µ'
        WHEN fc.university_code != u.code THEN 'ERROR: ç¼–ç ä¸ä¸€è‡´'
        ELSE 'OK'
    END as status
FROM forum_categories fc
LEFT JOIN universities u ON fc.university_code = u.code
WHERE fc.type = 'university';
```

## âš ï¸ é£é™©ä¸æ³¨æ„äº‹é¡¹

### æ•°æ®ä¸€è‡´æ€§
- `Forum.university_code` å¿…é¡»ä¸è®¤è¯ç³»ç»Ÿçš„ç¼–ç è¡¨ä¿æŒåŒæ­¥ï¼›ä¸Šæ–°/ä¸‹çº¿å¤§å­¦éœ€åŒå‘æ›´æ–°ã€‚
- `universities.country` å­—æ®µå¿…é¡»å‡†ç¡®ï¼Œé”™è¯¯çš„å›½å®¶æ ‡è¯†ä¼šå¯¼è‡´æƒé™åˆ¤æ–­é”™è¯¯ã€‚
- ä¸Šçº¿æ–°å¤§å­¦æ—¶åŠ¡å¿…åŒæ­¥ä¸‰æ­¥ï¼š
  1ï¼‰åœ¨ `universities/university_email_patterns` ä¸­æ–°å¢ï¼Œå¹¶è®¾ç½® `country='UK'`ï¼ˆå¦‚ä¸ºè‹±å›½å¤§å­¦ï¼‰ï¼›  
  2ï¼‰åœ¨ `forum_categories` ä¸­æ–°å¢å¯¹åº”æ¿å—å¹¶ç»‘å®šç›¸åŒ `university_code`ï¼›  
  3ï¼‰è¿è¡Œå¯¹é½è„šæœ¬æ ¡éªŒç¼–ç ä¸€è‡´æ€§ã€‚

### è®¤è¯å‡†ç¡®æ€§
- è¿‡æœŸ/æ’¤é”€åº”åŒæ­¥å½±å“å¯è§æ€§ï¼›å¼‚æ­¥ä»»åŠ¡æˆ–äº‹ä»¶æ€»çº¿éœ€å¯é ã€‚
- **é‡è¦**ï¼š`is_uk_university()` å‡½æ•°çš„åˆ¤æ–­é€»è¾‘å¿…é¡»ä¸è®¤è¯ç³»ç»Ÿä¿æŒä¸€è‡´ï¼Œé¿å…é UK å­¦ç”Ÿè¢«è¯¯åˆ¤ã€‚

### å®‰å…¨
- é”™è¯¯ä¿¡æ¯é¿å…æ³„éœ²æ¿å—å­˜åœ¨æ€§ï¼›å¿…è¦æ—¶ç»Ÿä¸€ 404ã€‚
- æ‰€æœ‰å­¦æ ¡æ¿å—ç›¸å…³æ¥å£å¿…é¡»ä½¿ç”¨ `require_student_verified(country="UK")` ä¾èµ–ï¼Œä¸å¾—ç»•è¿‡ã€‚

### æ€§èƒ½
- ç¼“å­˜ï¼šé¿å…è„è¯»ï¼›è®¤è¯çŠ¶æ€å˜æ›´éœ€ä¸»åŠ¨å¤±æ•ˆã€‚
- é¿å…åœ¨ `visible_forums` ä¸­é‡å¤æŸ¥è¯¢æ•°æ®åº“ï¼Œåº”ä¸€æ¬¡æ€§è·å–æ‰€éœ€ä¿¡æ¯ã€‚

### å®¡è®¡
- è®°å½•æ‹’ç»äº‹ä»¶ï¼Œç›‘æ§å¼‚å¸¸è®¿é—®ã€‚
- è®°å½•é UK å¤§å­¦è®¤è¯ç”¨æˆ·è®¿é—®å­¦æ ¡æ¿å—çš„å°è¯•ï¼Œä¾¿äºå®‰å…¨åˆ†æã€‚

## âœ… å¼€å‘å‰æ£€æŸ¥æ¸…å•

### å¿…éœ€ä¾èµ–å‡½æ•°æ£€æŸ¥
åœ¨å¼€å§‹å¼€å‘å‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹ä¾èµ–å‡½æ•°æ˜¯å¦å­˜åœ¨ï¼Œå¦‚ä¸å­˜åœ¨éœ€å…ˆå®ç°ï¼š

- [ ] `get_current_user_optional`ï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰ï¼šç”¨äº `/forums/visible` æ¥å£ï¼Œå…è®¸æœªç™»å½•è®¿é—®
  - æ£€æŸ¥ä½ç½®ï¼š`backend/app/forum_routes.py` æˆ– `backend/app/deps.py`
  - å¦‚ä¸å­˜åœ¨ï¼Œå‚è€ƒæ–‡æ¡£ä¸­çš„å®ç°ç¤ºä¾‹åˆ›å»º

- [ ] `require_student_verified(country="UK")`ï¼š**éœ€è¦å®ç°**ï¼Œç”¨äºç¡®ä¿åªå…è®¸ UK å­¦ç”Ÿè®¿é—®å­¦æ ¡æ¿å—
  - åŠŸèƒ½ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ `status='verified'` ä¸”æœªè¿‡æœŸçš„å­¦ç”Ÿè®¤è¯ï¼Œä¸”å…³è”çš„å¤§å­¦å±äºè‹±å›½
  - å®ç°ä½ç½®ï¼šå»ºè®®åœ¨ `backend/app/deps.py` æˆ–æ–°å»º `backend/app/forum_deps.py`
  - å‚è€ƒå®ç°ï¼š
    ```python
    async def require_student_verified(
        country: str = "UK",
        current_user: User = Depends(get_current_user_secure_async_csrf),
        db: AsyncSession = Depends(get_async_db_dependency)
    ) -> User:
        """ç¡®ä¿ç”¨æˆ·å·²é€šè¿‡æŒ‡å®šå›½å®¶çš„å­¦ç”Ÿè®¤è¯"""
        verification = await db.execute(
            select(StudentVerification)
            .join(University)
            .where(
                StudentVerification.user_id == current_user.id,
                StudentVerification.status == 'verified',
                StudentVerification.expires_at > func.now(),
                University.is_active == True
            )
        )
        verification = verification.scalar_one_or_none()
        
        if not verification:
            raise HTTPException(status_code=401, detail="Student verification required")
        
        # æ£€æŸ¥å›½å®¶
        university = verification.university
        if not is_uk_university(university):
            raise HTTPException(status_code=403, detail="Access denied")
        
        return current_user
    ```

- [ ] `get_current_user`ï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰ï¼šç”¨äºéœ€è¦ç™»å½•çš„æ¥å£
  - æ£€æŸ¥ä½ç½®ï¼š`backend/app/deps.py` æˆ– `backend/app/forum_routes.py`
  - å¦‚ä¸å­˜åœ¨ï¼Œä½¿ç”¨ `get_current_user_secure_async_csrf`

### æ•°æ®åº“è¿ç§»æ£€æŸ¥
- [ ] ç¡®è®¤å½“å‰æ•°æ®åº“ç‰ˆæœ¬å’Œè¿ç§»å·¥å…·ï¼ˆAlembic æˆ–ç›´æ¥ SQLï¼‰
- [ ] å¤‡ä»½æ•°æ®åº“ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
- [ ] æ£€æŸ¥ `forum_categories` è¡¨æ˜¯å¦å·²æœ‰ `type`, `country`, `university_code` å­—æ®µï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
- [ ] æ£€æŸ¥ `universities` è¡¨æ˜¯å¦å·²æœ‰ `country`, `code` å­—æ®µï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
- [ ] æ£€æŸ¥ç°æœ‰çº¦æŸåç§°ï¼Œé¿å…çº¦æŸå†²çª

### ä»£ç åº“å…¼å®¹æ€§æ£€æŸ¥
- [ ] ç¡®è®¤ `ForumCategory` æ¨¡å‹ä½ç½®ï¼š`backend/app/models.py`
- [ ] ç¡®è®¤ `StudentVerification` æ¨¡å‹ä½ç½®ï¼š`backend/app/models.py`
- [ ] ç¡®è®¤ `University` æ¨¡å‹ä½ç½®ï¼š`backend/app/models.py`
- [ ] ç¡®è®¤è®ºå›è·¯ç”±æ–‡ä»¶ä½ç½®ï¼š`backend/app/forum_routes.py`
- [ ] ç¡®è®¤æ•°æ®åº“ä¼šè¯ä¾èµ–ï¼š`get_async_db_dependency` æˆ– `get_sync_db`

### æµ‹è¯•ç¯å¢ƒå‡†å¤‡
- [ ] å‡†å¤‡æµ‹è¯•æ•°æ®ï¼šè‡³å°‘ä¸€ä¸ªè‹±å›½å¤§å­¦ã€ä¸€ä¸ªéè‹±å›½å¤§å­¦
- [ ] å‡†å¤‡æµ‹è¯•ç”¨æˆ·ï¼šå·²è®¤è¯è‹±å›½å­¦ç”Ÿã€æœªè®¤è¯ç”¨æˆ·ã€é UK è®¤è¯ç”¨æˆ·
- [ ] å‡†å¤‡æµ‹è¯•æ¿å—ï¼šè‡³å°‘ä¸€ä¸ª `type='general'`ã€ä¸€ä¸ª `type='root'`ã€ä¸€ä¸ª `type='university'`

## ğŸ“¦ äº¤ä»˜ç‰©æ¸…å•

### æ•°æ®åº“è¿ç§»
- [ ] åˆ›å»ºè¿ç§»è„šæœ¬ï¼šä¸º `forum_categories` è¡¨æ·»åŠ  `type`, `country`, `university_code` å­—æ®µ
- [ ] **å¿…é¡»**ï¼šä¸º `universities` è¡¨æ·»åŠ  `country` å­—æ®µï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦è‹±å›½å¤§å­¦ï¼‰
- [ ] **æ¨è**ï¼šä¸º `universities` è¡¨æ·»åŠ  `code` å­—æ®µï¼ˆç”¨äºå¤§å­¦ç¼–ç ï¼‰
- [ ] æ·»åŠ æ•°æ®åº“çº¦æŸå’Œç´¢å¼•
- [ ] æ•°æ®è¿ç§»è„šæœ¬ï¼šå°†ç°æœ‰å­¦æ ¡ç›¸å…³æ¿å—æ ‡è®°ä¸º `type='university'` å¹¶å¡«å…… `university_code`
- [ ] ä¸ºç°æœ‰è‹±å›½å¤§å­¦å¡«å…… `country='UK'`

### åç«¯å®ç°
- [ ] è®¿é—®æ§åˆ¶ä¾èµ–/ä¸­é—´ä»¶ï¼š`check_forum_visibility`ã€`is_uk_university`ã€`visible_forums`ã€`assert_forum_visible`
- [ ] å®ç° `require_student_verified(country="UK")` ä¾èµ–ï¼Œç¡®ä¿åªå…è®¸ UK å­¦ç”Ÿè®¿é—®å­¦æ ¡æ¿å—
- [ ] é›†æˆåˆ°æ‰€æœ‰è®ºå›è·¯ç”±ï¼š`GET /forums/{id}`, `GET /forums/{id}/posts`, `GET /posts/{id}`, `POST /forums/{id}/posts` ç­‰
- [ ] `/forums/visible` æ¥å£å®ç°ä¸ç¼“å­˜/å¤±æ•ˆæœºåˆ¶
- [ ] ç¼“å­˜å¤±æ•ˆäº‹ä»¶ï¼šè®¤è¯çŠ¶æ€å˜æ›´ã€å¤§å­¦å˜æ›´æ—¶è§¦å‘
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…åœ¨ `visible_forums` ä¸­é‡å¤æŸ¥è¯¢æ•°æ®åº“

### å‰ç«¯å®ç°
- [ ] å¯¼èˆªã€ä¾§æ ã€ä¸‹æ‹‰åªæ¸²æŸ“ `/forums/visible` è¿”å›ç»“æœ
- [ ] å‘å¸–/å›å¤å…¥å£çš„æƒé™æ§åˆ¶æ›´æ–°
- [ ] ç›´è¾¾é“¾æ¥é”™è¯¯å¤„ç†ï¼šç»Ÿä¸€æç¤º"æ— è®¿é—®æƒé™/éœ€å­¦ç”Ÿè®¤è¯"
- [ ] ç”¨æˆ·åˆ‡æ¢/é€€å‡ºç™»å½•ååˆ·æ–°å¯è§åˆ—è¡¨

### æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•ï¼šæƒé™åˆ¤å®šå‡½æ•°
- [ ] é›†æˆæµ‹è¯•ï¼šAPI æ¥å£æƒé™æ ¡éªŒ
- [ ] å›å½’æµ‹è¯•ï¼šæƒé™ä¸ç¼“å­˜ç”¨ä¾‹
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¼“å­˜å‘½ä¸­ç‡ã€æŸ¥è¯¢æ€§èƒ½

### æ–‡æ¡£
- [ ] æ›´æ–° API æ–‡æ¡£ï¼ˆSwagger/OpenAPIï¼‰
- [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£ï¼šæ•°æ®åº“è¿ç§»æ­¥éª¤
- [ ] æ›´æ–°è¿ç»´æ–‡æ¡£ï¼šç¼“å­˜å¤±æ•ˆç›‘æ§ã€å¼‚å¸¸è®¿é—®å‘Šè­¦
