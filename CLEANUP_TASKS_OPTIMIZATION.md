# å®šæœŸæ¸…ç†ä»»åŠ¡ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
1. [å½“å‰å®šæœŸä»»åŠ¡æ¸…å•](#å½“å‰å®šæœŸä»»åŠ¡æ¸…å•)
2. [å®Œæ•´å®šæ—¶ä»»åŠ¡æ¸…å•ï¼ˆè¯¦ç»†ç‰ˆï¼‰](#å®Œæ•´å®šæ—¶ä»»åŠ¡æ¸…å•è¯¦ç»†ç‰ˆ)
3. [æ€§èƒ½é—®é¢˜åˆ†æ](#æ€§èƒ½é—®é¢˜åˆ†æ)
4. [ä¼˜åŒ–ç­–ç•¥](#ä¼˜åŒ–ç­–ç•¥)
5. [è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ](#è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ)
6. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
7. [é¢„æœŸæ•ˆæœ](#é¢„æœŸæ•ˆæœ)
8. [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
9. [æ€»ç»“](#æ€»ç»“)

---

## å½“å‰å®šæœŸä»»åŠ¡æ¸…å•

### 1. ä¼šè¯æ¸…ç†ä»»åŠ¡ (`run_session_cleanup_task`)
- **é¢‘ç‡**: æ¯5åˆ†é’Ÿ
- **ä½ç½®**: `backend/app/main.py:461`
- **å¯åŠ¨æ–¹å¼**: åå°çº¿ç¨‹ï¼ˆdaemonï¼‰
- **åŠŸèƒ½**: æ¸…ç†è¿‡æœŸç”¨æˆ·ä¼šè¯
- **è°ƒç”¨**: `SecureAuthManager.cleanup_expired_sessions()`
- **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆç§»é™¤ï¼Œä¾èµ–Redis TTLï¼‰

### 2. å®šæœŸæ¸…ç†ä»»åŠ¡ (`CleanupTasks`)
- **é¢‘ç‡**: æ¯å°æ—¶
- **ä½ç½®**: `backend/app/cleanup_tasks.py`
- **å¯åŠ¨æ–¹å¼**: å¼‚æ­¥ä»»åŠ¡ï¼ˆ`asyncio.create_task`ï¼‰
- **åŠŸèƒ½**:
  - æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆç”¨æˆ·/å®¢æœ/ç®¡ç†å‘˜ï¼‰- æ¯å°æ—¶
  - æ¸…ç†è¿‡æœŸç¼“å­˜ - æ¯å°æ—¶
  - æ¸…ç†å·²å®Œæˆä»»åŠ¡æ–‡ä»¶ - æ¯å¤©ä¸€æ¬¡
  - æ¸…ç†è¿‡æœŸä»»åŠ¡æ–‡ä»¶ - æ¯å¤©ä¸€æ¬¡
  - æ¸…ç†æœªä½¿ç”¨ä¸´æ—¶å›¾ç‰‡ - æ¯å°æ—¶
- **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆéƒ¨åˆ†å¯ç§»é™¤æˆ–é™ä½é¢‘ç‡ï¼‰

### 3. å®šæ—¶ä»»åŠ¡ (`run_scheduled_tasks`)
- **é¢‘ç‡**: æ¯5åˆ†é’Ÿ
- **ä½ç½®**: `backend/app/scheduled_tasks.py`
- **å¯åŠ¨æ–¹å¼**: åå°çº¿ç¨‹ï¼ˆdaemonï¼‰
- **åŠŸèƒ½**:
  - æ£€æŸ¥è¿‡æœŸä¼˜æƒ åˆ¸ (`check_expired_coupons`)
  - æ£€æŸ¥è¿‡æœŸé‚€è¯·ç  (`check_expired_invitation_codes`)
  - æ£€æŸ¥è¿‡æœŸç§¯åˆ† (`check_expired_points`)
  - å®¢æœç³»ç»Ÿä»»åŠ¡ï¼ˆæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰:
    - å¤„ç†å®¢æœæ’é˜Ÿ (`process_customer_service_queue`)
    - è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯ (`auto_end_timeout_chats`, è¶…æ—¶2åˆ†é’Ÿ)
    - å‘é€è¶…æ—¶é¢„è­¦ (`send_timeout_warnings`, é¢„è­¦1åˆ†é’Ÿ)
    - æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ (`cleanup_long_inactive_chats`, æ¯å¤©å‡Œæ™¨2ç‚¹ï¼Œ30å¤©æ— æ´»åŠ¨ï¼‰
- **çŠ¶æ€**: éƒ¨åˆ†å¯ä¼˜åŒ–ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ã€äº‹ä»¶é©±åŠ¨ï¼‰

### 4. åå°ä»»åŠ¡ (`run_background_task`)
- **é¢‘ç‡**: æ¯åˆ†é’Ÿ
- **ä½ç½®**: `backend/app/main.py:430`
- **å¯åŠ¨æ–¹å¼**: åå°çº¿ç¨‹ï¼ˆdaemonï¼‰
- **åŠŸèƒ½**:
  - å–æ¶ˆè¿‡æœŸä»»åŠ¡ (`cancel_expired_tasks`) - æ¯åˆ†é’Ÿ
  - æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ (`update_all_users_statistics`) - æ¯10åˆ†é’Ÿ
  - æ›´æ–°ä»»åŠ¡è¾¾äººbio (`update_all_task_experts_bio`) - æ¯å¤©ä¸€æ¬¡
- **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ã€äº‹ä»¶é©±åŠ¨ï¼‰

### 5. Celery Beatå®šæ—¶ä»»åŠ¡ (`celery_app`)
- **é¢‘ç‡**: æ ¹æ®é…ç½®
- **ä½ç½®**: `backend/app/celery_app.py`
- **å¯åŠ¨æ–¹å¼**: Celery Beatè°ƒåº¦å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
- **åŠŸèƒ½**:
  - å¤„ç†å®¢æœæ’é˜Ÿ (`process_customer_service_queue_task`) - æ¯30ç§’
  - è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯ (`auto_end_timeout_chats_task`) - æ¯30ç§’
  - å‘é€è¶…æ—¶é¢„è­¦ (`send_timeout_warnings_task`) - æ¯30ç§’
  - æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ (`cleanup_long_inactive_chats_task`) - æ¯å¤©å‡Œæ™¨2ç‚¹
- **çŠ¶æ€**: å¤‡ç”¨æ–¹æ¡ˆï¼ˆå¦‚æœCeleryä¸å¯ç”¨ï¼Œå›é€€åˆ°`scheduled_tasks.py`ï¼‰

### 6. æ¸…ç†è¿‡æœŸå¾…éªŒè¯ç”¨æˆ· (`cleanup_expired_pending_users`)
- **é¢‘ç‡**: æœªå‘ç°å®šæ—¶ä»»åŠ¡ï¼ˆå¯èƒ½æ‰‹åŠ¨è°ƒç”¨æˆ–ç¼ºå¤±ï¼‰
- **ä½ç½®**: `backend/app/email_verification.py:339`
- **åŠŸèƒ½**: æ¸…ç†è¿‡æœŸçš„å¾…éªŒè¯ç”¨æˆ·ï¼ˆ`PendingUser`è¡¨ï¼‰
- **çŠ¶æ€**: âš ï¸ éœ€è¦æ·»åŠ å®šæ—¶ä»»åŠ¡

### 7. å…¶ä»–å¯èƒ½çš„å®šæ—¶ä»»åŠ¡
- **é‚®ä»¶å‘é€ä»»åŠ¡**: é€šè¿‡ `BackgroundTasks` å¼‚æ­¥æ‰§è¡Œï¼Œéå®šæ—¶ä»»åŠ¡
- **WebSocketæ¶ˆæ¯æ¨é€**: é€šè¿‡ `BackgroundTasks` å¼‚æ­¥æ‰§è¡Œï¼Œéå®šæ—¶ä»»åŠ¡
- **å›¾ç‰‡æ¸…ç†**: åœ¨ `cleanup_tasks.py` ä¸­å·²åŒ…å«

---

## æ€§èƒ½é—®é¢˜åˆ†æ

### ğŸ”´ ä¸»è¦é—®é¢˜

1. **é¢‘ç¹å…¨è¡¨æ‰«æ**
   - ä¼šè¯æ¸…ç†ï¼šæ¯5åˆ†é’Ÿæ‰«ææ‰€æœ‰Redisä¼šè¯é”®
   - ç¼“å­˜æ¸…ç†ï¼šæ¯å°æ—¶æ‰«ææ‰€æœ‰ç¼“å­˜é”®
   - ä»»åŠ¡æ–‡ä»¶æ¸…ç†ï¼šæ¯å¤©æ‰«ææ‰€æœ‰å·²å®Œæˆ/è¿‡æœŸä»»åŠ¡

2. **é‡å¤å·¥ä½œ**
   - ä¼šè¯æ¸…ç†åœ¨ä¸¤ä¸ªåœ°æ–¹æ‰§è¡Œï¼ˆ`run_session_cleanup_task` å’Œ `CleanupTasks`ï¼‰
   - Rediså·²ç»è®¾ç½®äº†TTLï¼Œä½†ä»å®šæœŸæ‰«ææ£€æŸ¥

3. **èµ„æºæµªè´¹**
   - å³ä½¿æ²¡æœ‰è¿‡æœŸæ•°æ®ï¼Œä¹Ÿè¦æ‰§è¡Œæ‰«æ
   - å¤§é‡æ— æ•ˆçš„æ•°æ®åº“æŸ¥è¯¢å’Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œ

4. **å»¶è¿Ÿæ¸…ç†**
   - ä»»åŠ¡å®Œæˆåéœ€è¦ç­‰å¾…3å¤©æ‰èƒ½æ¸…ç†æ–‡ä»¶
   - è¿‡æœŸæ•°æ®ä¸èƒ½åŠæ—¶é‡Šæ”¾èµ„æº

---

## ä¼˜åŒ–ç­–ç•¥

### æ ¸å¿ƒæ€æƒ³ï¼š**è®©æ•°æ®è‡ªå·±æ¸…ç†è‡ªå·±**

é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ç»„åˆï¼š

1. **Redis TTLè‡ªåŠ¨è¿‡æœŸ** - å®Œå…¨ä¾èµ–Redisçš„TTLæœºåˆ¶
2. **å»¶è¿Ÿåˆ é™¤ï¼ˆLazy Deletionï¼‰** - è®¿é—®æ—¶æ£€æŸ¥å¹¶æ¸…ç†
3. **äº‹ä»¶é©±åŠ¨æ¸…ç†** - åœ¨å…³é”®äº‹ä»¶å‘ç”Ÿæ—¶ç«‹å³æ¸…ç†
4. **æ•°æ®åº“çº§æ¸…ç†** - ä½¿ç”¨æ•°æ®åº“çº¦æŸå’Œè§¦å‘å™¨
5. **å‡å°‘å®šæœŸæ‰«æ** - åªä¿ç•™å¿…è¦çš„å®šæœŸæ£€æŸ¥

---

## è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ä¼šè¯æ¸…ç†ä¼˜åŒ–

#### å½“å‰å®ç°
```python
# æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
SecureAuthManager.cleanup_expired_sessions()
# æ‰«ææ‰€æœ‰ session:* é”®ï¼Œæ£€æŸ¥è¿‡æœŸæ—¶é—´
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šå®Œå…¨ä¾èµ–Redis TTLï¼ˆæ¨èï¼‰**
- Rediså·²ç»è®¾ç½®äº†TTLï¼ˆ`SESSION_EXPIRE_HOURS * 3600`ç§’ï¼‰
- **ç§»é™¤å®šæœŸæ‰«æ**ï¼Œå®Œå…¨ä¾èµ–Redisè‡ªåŠ¨è¿‡æœŸ
- åœ¨è®¿é—®ä¼šè¯æ—¶è¿›è¡Œå»¶è¿Ÿåˆ é™¤æ£€æŸ¥ï¼ˆå·²å®ç°ï¼‰

**æ–¹æ¡ˆBï¼šå»¶è¿Ÿåˆ é™¤å¢å¼º**
- åœ¨ `get_session()` ä¸­æ£€æŸ¥è¿‡æœŸï¼ˆå·²å®ç°ï¼‰
- åœ¨ `validate_session()` ä¸­æ£€æŸ¥è¿‡æœŸï¼ˆå·²å®ç°ï¼‰
- ç§»é™¤å®šæœŸæ‰«æä»»åŠ¡

**å®æ–½æ­¥éª¤**ï¼š
1. ç§»é™¤ `run_session_cleanup_task()` çº¿ç¨‹
2. ç§»é™¤ `CleanupTasks._cleanup_expired_sessions()` ä¸­çš„ä¼šè¯æ¸…ç†
3. ç¡®ä¿æ‰€æœ‰ä¼šè¯åˆ›å»ºæ—¶éƒ½è®¾ç½®äº†TTL
4. åœ¨è®¿é—®ä¼šè¯æ—¶è¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼ˆå·²å®ç°ï¼‰

**ä»£ç ä¿®æ”¹**ï¼š
```python
# backend/app/main.py
# åˆ é™¤ run_session_cleanup_task() å‡½æ•°å’Œå¯åŠ¨ä»£ç 

# backend/app/cleanup_tasks.py
# ä» _run_cleanup_cycle() ä¸­ç§»é™¤ _cleanup_expired_sessions() è°ƒç”¨
```

---

### 2. ç¼“å­˜æ¸…ç†ä¼˜åŒ–

#### å½“å‰å®ç°
```python
# æ¯å°æ—¶æ‰«ææ‰€æœ‰ç¼“å­˜é”®
# æ£€æŸ¥æ²¡æœ‰TTLçš„é”®ï¼Œæ‰‹åŠ¨æ£€æŸ¥è¿‡æœŸæ—¶é—´
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šå¼ºåˆ¶æ‰€æœ‰ç¼“å­˜è®¾ç½®TTLï¼ˆæ¨èï¼‰**
- ç¡®ä¿æ‰€æœ‰ç¼“å­˜æ“ä½œéƒ½ä½¿ç”¨ `setex()` æˆ– `set()` æ—¶æŒ‡å®šTTL
- ç§»é™¤å®šæœŸæ‰«æé€»è¾‘
- Redisä¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸé”®

**æ–¹æ¡ˆBï¼šå»¶è¿Ÿåˆ é™¤**
- åœ¨ `redis_cache.get()` ä¸­æ£€æŸ¥TTL
- å¦‚æœTTLä¸º-1ï¼ˆæ— TTLï¼‰ï¼Œæ£€æŸ¥æ•°æ®ä¸­çš„æ—¶é—´æˆ³
- è¿‡æœŸåˆ™åˆ é™¤å¹¶è¿”å›None

**å®æ–½æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ‰€æœ‰ç¼“å­˜è®¾ç½®æ“ä½œï¼Œç¡®ä¿éƒ½æœ‰TTL
2. ç§»é™¤ `CleanupTasks._cleanup_expired_cache()` ä¸­çš„æ‰«æé€»è¾‘
3. åœ¨ `RedisCache.get()` ä¸­æ·»åŠ å»¶è¿Ÿåˆ é™¤æ£€æŸ¥

**ä»£ç ä¿®æ”¹**ï¼š
```python
# backend/app/redis_cache.py
def get(self, key: str) -> Optional[Any]:
    """è·å–ç¼“å­˜æ•°æ®ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®"""
    if not self.enabled:
        return None
    
    try:
        # æ£€æŸ¥TTL
        ttl = self.get_ttl(key)
        if ttl == -1:  # æ²¡æœ‰TTLçš„é”®ï¼Œæ£€æŸ¥æ•°æ®ä¸­çš„æ—¶é—´æˆ³
            data = self.redis_client.get(key)
            if data:
                parsed = self._deserialize(data)
                if parsed and isinstance(parsed, dict):
                    # æ£€æŸ¥æ˜¯å¦æœ‰æ—¶é—´æˆ³å­—æ®µ
                    if 'expires_at' in parsed:
                        expires_at = parse_iso_utc(parsed['expires_at'])
                        if expires_at < get_utc_time():
                            # è¿‡æœŸï¼Œåˆ é™¤å¹¶è¿”å›None
                            self.delete(key)
                            return None
        elif ttl == -2:  # é”®ä¸å­˜åœ¨
            return None
        
        # æ­£å¸¸è·å–æ•°æ®
        data = self.redis_client.get(key)
        if data:
            return self._deserialize(data)
        return None
    except RedisError as e:
        logger.error(f"Redisè·å–å¤±è´¥: {e}")
        return None

# backend/app/cleanup_tasks.py
# ç§»é™¤ _cleanup_expired_cache() æ–¹æ³•æˆ–ç®€åŒ–ä¸ºç©ºå®ç°
```

---

### 3. ä»»åŠ¡æ–‡ä»¶æ¸…ç†ä¼˜åŒ–

#### å½“å‰å®ç°
```python
# æ¯å¤©æ‰«ææ‰€æœ‰å·²å®Œæˆè¶…è¿‡3å¤©çš„ä»»åŠ¡
# æ¯å¤©æ‰«ææ‰€æœ‰è¿‡æœŸè¶…è¿‡3å¤©çš„ä»»åŠ¡
# æ‰¹é‡æ¸…ç†æ–‡ä»¶
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šäº‹ä»¶é©±åŠ¨æ¸…ç†ï¼ˆæ¨èï¼‰**
- åœ¨ä»»åŠ¡å®Œæˆæ—¶ï¼Œè®¾ç½®å»¶è¿Ÿæ¸…ç†ä»»åŠ¡ï¼ˆ3å¤©åï¼‰
- åœ¨ä»»åŠ¡è¿‡æœŸæ—¶ï¼Œç«‹å³æ¸…ç†æ–‡ä»¶
- ä½¿ç”¨åå°ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¦‚Celeryï¼‰æˆ–asyncioå®šæ—¶å™¨

**æ–¹æ¡ˆBï¼šæ•°æ®åº“è§¦å‘å™¨**
- åœ¨ä»»åŠ¡çŠ¶æ€å˜æ›´æ—¶è§¦å‘æ¸…ç†
- ä½¿ç”¨PostgreSQLçš„è§¦å‘å™¨æˆ–åº”ç”¨å±‚äº‹ä»¶

**æ–¹æ¡ˆCï¼šå»¶è¿Ÿåˆ é™¤ + å®šæœŸå…œåº•**
- åœ¨è®¿é—®ä»»åŠ¡è¯¦æƒ…æ—¶æ£€æŸ¥æ˜¯å¦è¶…è¿‡3å¤©
- å¦‚æœè¶…è¿‡ä¸”æœªæ¸…ç†ï¼Œè§¦å‘æ¸…ç†
- ä¿ç•™æ¯å‘¨ä¸€æ¬¡çš„å®šæœŸæ‰«æä½œä¸ºå…œåº•

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨ `confirm_task_completion()` ä¸­ï¼Œä»»åŠ¡å®Œæˆæ—¶è®¾ç½®å»¶è¿Ÿæ¸…ç†
2. åœ¨ `cancel_expired_tasks()` ä¸­ï¼Œä»»åŠ¡è¿‡æœŸæ—¶ç«‹å³æ¸…ç†æ–‡ä»¶
3. åœ¨ä»»åŠ¡è¯¦æƒ…APIä¸­ï¼Œæ·»åŠ å»¶è¿Ÿåˆ é™¤æ£€æŸ¥
4. å°†å®šæœŸæ¸…ç†æ”¹ä¸ºæ¯å‘¨ä¸€æ¬¡ï¼ˆä½œä¸ºå…œåº•ï¼‰

**ä»£ç ä¿®æ”¹**ï¼š
```python
# backend/app/routers.py
@router.post("/tasks/{task_id}/confirm_completion")
def confirm_task_completion(...):
    # ... ç°æœ‰ä»£ç  ...
    
    # è®¾ç½®å»¶è¿Ÿæ¸…ç†ä»»åŠ¡ï¼ˆ3å¤©åï¼‰
    from app.cleanup_tasks import schedule_task_file_cleanup
    schedule_task_file_cleanup(task_id, delay_days=3)
    
    return task

# backend/app/main.py
def cancel_expired_tasks():
    """å–æ¶ˆè¿‡æœŸä»»åŠ¡ï¼Œå¹¶ç«‹å³æ¸…ç†æ–‡ä»¶"""
    # ... ç°æœ‰ä»£ç  ...
    
    for task in expired_tasks:
        # å–æ¶ˆä»»åŠ¡
        task.status = "cancelled"
        # ç«‹å³æ¸…ç†æ–‡ä»¶
        from app.crud import cleanup_task_files
        cleanup_task_files(db, task.id)
    
    db.commit()

# backend/app/crud.py
def get_task(db: Session, task_id: int):
    """è·å–ä»»åŠ¡ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶"""
    task = db.query(Task).filter(Task.id == task_id).first()
    
    if task:
        # å»¶è¿Ÿåˆ é™¤æ£€æŸ¥ï¼šå¦‚æœä»»åŠ¡å·²å®Œæˆè¶…è¿‡3å¤©ï¼Œæ¸…ç†æ–‡ä»¶
        if task.status == "completed" and task.completed_at:
            days_since_completion = (get_utc_time() - task.completed_at).days
            if days_since_completion >= 3:
                # æ£€æŸ¥æ˜¯å¦å·²æ¸…ç†ï¼ˆå¯ä»¥é€šè¿‡æ·»åŠ æ ‡è®°å­—æ®µï¼‰
                if not getattr(task, 'files_cleaned', False):
                    cleanup_task_files(db, task_id)
                    # æ ‡è®°å·²æ¸…ç†ï¼ˆéœ€è¦æ·»åŠ å­—æ®µæˆ–ä½¿ç”¨ç¼“å­˜ï¼‰
    
    return task
```

---

### 4. ä¸´æ—¶å›¾ç‰‡æ¸…ç†ä¼˜åŒ–

#### å½“å‰å®ç°
```python
# æ¯å°æ—¶æ‰«ææ‰€æœ‰ä¸´æ—¶æ–‡ä»¶å¤¹
# æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼Œåˆ é™¤è¶…è¿‡24å°æ—¶çš„æ–‡ä»¶
```

#### é—®é¢˜åˆ†æ
- **ä¸´æ—¶å›¾ç‰‡ç‰¹ç‚¹**ï¼šç”¨æˆ·ä¸Šä¼ åç­‰å¾…åˆ›å»ºä»»åŠ¡ï¼Œå¦‚æœæœªåˆ›å»ºä»»åŠ¡ï¼Œå›¾ç‰‡ä¸ä¼šè¢«è®¿é—®
- **å»¶è¿Ÿåˆ é™¤ä¸é€‚ç”¨**ï¼šå› ä¸ºä¸´æ—¶å›¾ç‰‡é€šå¸¸ä¸ä¼šè¢«è®¿é—®ï¼Œæ— æ³•é€šè¿‡è®¿é—®æ—¶æ£€æŸ¥æ¥è§¦å‘åˆ é™¤
- **éœ€è¦ä¸»åŠ¨æ¸…ç†**ï¼šå¿…é¡»å®šæœŸæ‰«ææˆ–ä½¿ç”¨å…¶ä»–æœºåˆ¶ä¸»åŠ¨æ¸…ç†

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šRedisè®°å½• + å®šæœŸæ£€æŸ¥ï¼ˆæ¨èï¼‰**
- ä¸Šä¼ ä¸´æ—¶å›¾ç‰‡æ—¶ï¼Œåœ¨Redisä¸­è®°å½•æ–‡ä»¶è·¯å¾„å’Œä¸Šä¼ æ—¶é—´
- è®¾ç½®Redisé”®çš„TTLä¸º24å°æ—¶
- å®šæœŸæ£€æŸ¥Redisä¸­çš„è®°å½•ï¼Œæ¸…ç†å¯¹åº”çš„æ–‡ä»¶
- å¦‚æœRedisé”®å·²è¿‡æœŸï¼ˆTTLåˆ°æœŸï¼‰ï¼Œè¯´æ˜æ–‡ä»¶åº”è¯¥è¢«æ¸…ç†

**æ–¹æ¡ˆBï¼šä»»åŠ¡åˆ›å»ºæ—¶æ¸…ç†**
- åœ¨ä»»åŠ¡åˆ›å»ºæˆåŠŸåï¼Œæ¸…ç†è¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¸´æ—¶å›¾ç‰‡ï¼ˆå› ä¸ºå·²è¿ç§»åˆ°ä»»åŠ¡æ–‡ä»¶å¤¹ï¼‰
- ä¿ç•™å®šæœŸæ‰«æä½œä¸ºå…œåº•ï¼ˆæ¸…ç†æœªåˆ›å»ºä»»åŠ¡çš„ä¸´æ—¶å›¾ç‰‡ï¼‰

**æ–¹æ¡ˆCï¼šä¼˜åŒ–å®šæœŸæ‰«æ**
- ä¿ç•™å®šæœŸæ‰«æï¼Œä½†ä¼˜åŒ–æ‰«ææ•ˆç‡
- åªæ‰«æ `temp_*` æ–‡ä»¶å¤¹
- ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ—¶é—´æˆ³ï¼Œé¿å…è¯»å–æ–‡ä»¶å†…å®¹
- å‡å°‘æ‰«æé¢‘ç‡ï¼ˆä»æ¯å°æ—¶æ”¹ä¸ºæ¯6å°æ—¶æˆ–æ¯å¤©ï¼‰

**æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆA + æ–¹æ¡ˆBç»„åˆ**
- ä¸Šä¼ æ—¶è®°å½•åˆ°Redisï¼ˆæ–¹æ¡ˆAï¼‰
- ä»»åŠ¡åˆ›å»ºæ—¶ç«‹å³æ¸…ç†ï¼ˆæ–¹æ¡ˆBï¼‰
- å®šæœŸæ£€æŸ¥Redisè®°å½•å¹¶æ¸…ç†ï¼ˆæ–¹æ¡ˆAï¼‰
- å®šæœŸæ‰«æä½œä¸ºå…œåº•ï¼ˆæ–¹æ¡ˆCï¼Œé¢‘ç‡é™ä½ï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨ä¸´æ—¶å›¾ç‰‡ä¸Šä¼ æ—¶ï¼Œè®°å½•åˆ°Redis
2. åœ¨ä»»åŠ¡åˆ›å»ºæˆåŠŸåï¼Œæ¸…ç†è¯¥ç”¨æˆ·çš„ä¸´æ—¶å›¾ç‰‡
3. æ·»åŠ å®šæœŸä»»åŠ¡æ£€æŸ¥Redisè®°å½•å¹¶æ¸…ç†æ–‡ä»¶
4. ä¼˜åŒ–å®šæœŸæ‰«æï¼Œé™ä½é¢‘ç‡

**ä»£ç ä¿®æ”¹**ï¼š
```python
# backend/app/routers.py
@router.post("/upload/public-image")
async def upload_public_image(...):
    # ... ç°æœ‰ä¸Šä¼ é€»è¾‘ ...
    
    # å¦‚æœæ˜¯ä¸´æ—¶å›¾ç‰‡ï¼ˆcategory=public ä¸”æ—  resource_idï¼‰
    if category == "public" and resource_id.startswith("temp_"):
        # è®°å½•åˆ°Redisï¼Œè®¾ç½®24å°æ—¶TTL
        from app.redis_cache import get_redis_client
        redis_client = get_redis_client()
        if redis_client:
            temp_image_key = f"temp_image:{user_id}:{file_path.name}"
            redis_client.setex(
                temp_image_key,
                24 * 3600,  # 24å°æ—¶TTL
                json.dumps({
                    "file_path": str(file_path),
                    "uploaded_at": format_iso_utc(get_utc_time())
                })
            )
    
    return result

# backend/app/async_routers.py
@async_router.post("/tasks")
async def create_task_async(...):
    # ... ç°æœ‰ä»»åŠ¡åˆ›å»ºé€»è¾‘ ...
    
    # è¿ç§»ä¸´æ—¶å›¾ç‰‡åï¼Œæ¸…ç†è¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¸´æ—¶å›¾ç‰‡
    if task.images and len(task.images) > 0:
        # ... è¿ç§»é€»è¾‘ ...
        
        # æ¸…ç†è¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¸´æ—¶å›¾ç‰‡ï¼ˆå·²è¿ç§»ï¼Œä¸å†éœ€è¦ï¼‰
        from app.cleanup_tasks import cleanup_user_temp_images
        cleanup_user_temp_images(current_user.id)
    
    return db_task

# backend/app/cleanup_tasks.py
async def _cleanup_unused_temp_images(self):
    """æ¸…ç†æœªä½¿ç”¨çš„ä¸´æ—¶å›¾ç‰‡ï¼ˆé€šè¿‡Redisè®°å½•ï¼‰"""
    from app.redis_cache import get_redis_client
    redis_client = get_redis_client()
    
    if not redis_client:
        # Redisä¸å¯ç”¨ï¼Œå›é€€åˆ°æ–‡ä»¶ç³»ç»Ÿæ‰«æ
        await self._cleanup_temp_images_by_filesystem()
        return
    
    # æ‰«æRedisä¸­çš„ä¸´æ—¶å›¾ç‰‡è®°å½•
    temp_image_keys = redis_client.keys("temp_image:*")
    cleaned_count = 0
    
    for key in temp_image_keys:
        # æ£€æŸ¥TTLï¼Œå¦‚æœå·²è¿‡æœŸï¼ˆTTLä¸º-2ï¼‰ï¼Œè¯´æ˜åº”è¯¥æ¸…ç†
        ttl = redis_client.ttl(key)
        if ttl == -2:  # é”®å·²è¿‡æœŸä½†è¿˜æœªè¢«Redisåˆ é™¤ï¼ˆå¯èƒ½åˆšè¿‡æœŸï¼‰
            # è·å–æ–‡ä»¶è·¯å¾„å¹¶åˆ é™¤
            try:
                data = redis_client.get(key)
                if data:
                    info = json.loads(data)
                    file_path = Path(info["file_path"])
                    if file_path.exists():
                        file_path.unlink()
                        cleaned_count += 1
                # åˆ é™¤Redisé”®
                redis_client.delete(key)
            except Exception as e:
                logger.warning(f"æ¸…ç†ä¸´æ—¶å›¾ç‰‡å¤±è´¥ {key}: {e}")
    
    if cleaned_count > 0:
        logger.info(f"é€šè¿‡Redisè®°å½•æ¸…ç†äº† {cleaned_count} ä¸ªä¸´æ—¶å›¾ç‰‡")
    
    # å…œåº•ï¼šæ‰«ææ–‡ä»¶ç³»ç»Ÿï¼Œæ¸…ç†æ²¡æœ‰Redisè®°å½•çš„æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯æ—§æ•°æ®ï¼‰
    await self._cleanup_temp_images_by_filesystem()

async def _cleanup_temp_images_by_filesystem(self):
    """é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ‰«ææ¸…ç†ä¸´æ—¶å›¾ç‰‡ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰"""
    # ... ç°æœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ‰«æé€»è¾‘ ...
    # ä½†é™ä½é¢‘ç‡ï¼šåªåœ¨Redisæ¸…ç†åæ‰§è¡Œï¼Œæˆ–æ¯å¤©æ‰§è¡Œä¸€æ¬¡

def cleanup_user_temp_images(user_id: str):
    """æ¸…ç†æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰ä¸´æ—¶å›¾ç‰‡ï¼ˆä»»åŠ¡åˆ›å»ºåè°ƒç”¨ï¼‰"""
    from pathlib import Path
    import os
    
    RAILWAY_ENVIRONMENT = os.getenv("RAILWAY_ENVIRONMENT")
    if RAILWAY_ENVIRONMENT:
        base_public_dir = Path("/data/uploads/public/images")
    else:
        base_public_dir = Path("uploads/public/images")
    
    temp_dir = base_public_dir / "public" / f"temp_{user_id}"
    
    if temp_dir.exists():
        # åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¸´æ—¶å›¾ç‰‡
        for file_path in temp_dir.iterdir():
            if file_path.is_file():
                file_path.unlink()
        
        # åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤¹
        try:
            temp_dir.rmdir()
        except:
            pass
        
        # æ¸…ç†Redisä¸­çš„è®°å½•
        from app.redis_cache import get_redis_client
        redis_client = get_redis_client()
        if redis_client:
            pattern = f"temp_image:{user_id}:*"
            keys = redis_client.keys(pattern)
            if keys:
                redis_client.delete(*keys)
```

---

### 5. å®šæ—¶ä»»åŠ¡ä¼˜åŒ–

#### 5.1 è¿‡æœŸä¼˜æƒ åˆ¸/é‚€è¯·ç /ç§¯åˆ†æ£€æŸ¥

**å½“å‰å®ç°**ï¼šæ¯5åˆ†é’Ÿæ‰«ææ‰€æœ‰è®°å½•

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆAï¼šæ•°æ®åº“ç´¢å¼• + æŸ¥è¯¢ä¼˜åŒ–**
- æ·»åŠ  `(status, valid_until)` å¤åˆç´¢å¼•
- åªæŸ¥è¯¢å³å°†è¿‡æœŸçš„è®°å½•ï¼ˆå¦‚æœªæ¥1å°æ—¶å†…ï¼‰
- å‡å°‘æ‰«æèŒƒå›´

**æ–¹æ¡ˆBï¼šäº‹ä»¶é©±åŠ¨**
- åœ¨åˆ›å»ºä¼˜æƒ åˆ¸/é‚€è¯·ç æ—¶ï¼Œè®¾ç½®è¿‡æœŸæ£€æŸ¥ä»»åŠ¡
- ä½¿ç”¨Celeryå®šæ—¶ä»»åŠ¡åœ¨è¿‡æœŸæ—¶é—´ç‚¹æ‰§è¡Œ

**æ–¹æ¡ˆCï¼šå»¶è¿Ÿæ£€æŸ¥**
- åœ¨ç”¨æˆ·ä½¿ç”¨ä¼˜æƒ åˆ¸/é‚€è¯·ç æ—¶æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
- åœ¨æŸ¥è¯¢ç§¯åˆ†æ—¶æ£€æŸ¥æ˜¯å¦è¿‡æœŸ

**å®æ–½æ­¥éª¤**ï¼š
1. æ·»åŠ æ•°æ®åº“ç´¢å¼•
2. ä¼˜åŒ–æŸ¥è¯¢ï¼Œåªæ£€æŸ¥å³å°†è¿‡æœŸçš„è®°å½•
3. åœ¨ç›¸å…³æ“ä½œä¸­æ·»åŠ è¿‡æœŸæ£€æŸ¥

---

#### 5.2 å®¢æœç³»ç»Ÿä»»åŠ¡ä¼˜åŒ–

**å½“å‰å®ç°**ï¼šæ¯5åˆ†é’Ÿæ‰§è¡Œæ‰€æœ‰å®¢æœä»»åŠ¡

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆAï¼šWebSocketäº‹ä»¶é©±åŠ¨**
- åœ¨å¯¹è¯çŠ¶æ€å˜æ›´æ—¶è§¦å‘ç›¸å…³æ£€æŸ¥
- å‡å°‘å®šæœŸæ‰«æ

**æ–¹æ¡ˆBï¼šä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶**
- åªæŸ¥è¯¢éœ€è¦å¤„ç†çš„å¯¹è¯
- æ·»åŠ é€‚å½“çš„æ•°æ®åº“ç´¢å¼•

**ä¿ç•™å®šæœŸä»»åŠ¡**ï¼šå®¢æœç³»ç»Ÿä»»åŠ¡éœ€è¦å®šæœŸæ£€æŸ¥ï¼Œä½†å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢æ•ˆç‡

---

#### 5.3 è¿‡æœŸä»»åŠ¡å–æ¶ˆä¼˜åŒ–

**å½“å‰å®ç°**ï¼šæ¯åˆ†é’Ÿæ‰«ææ‰€æœ‰ä»»åŠ¡

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆAï¼šæ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**
- æ·»åŠ  `(status, deadline)` å¤åˆç´¢å¼•
- åªæŸ¥è¯¢ `status='open' AND deadline < NOW()` çš„ä»»åŠ¡

**æ–¹æ¡ˆBï¼šäº‹ä»¶é©±åŠ¨**
- åœ¨ä»»åŠ¡åˆ›å»ºæ—¶ï¼Œå¦‚æœè®¾ç½®äº†deadlineï¼Œè®¾ç½®è¿‡æœŸæ£€æŸ¥ä»»åŠ¡
- ä½¿ç”¨Celeryåœ¨deadlineæ—¶é—´ç‚¹æ‰§è¡Œ

**ä¿ç•™å®šæœŸä»»åŠ¡**ï¼šä½†ä¼˜åŒ–ä¸ºåªæŸ¥è¯¢éœ€è¦å–æ¶ˆçš„ä»»åŠ¡

**ä»£ç ä¿®æ”¹**ï¼š
```python
# backend/app/main.py
def cancel_expired_tasks():
    """å–æ¶ˆè¿‡æœŸä»»åŠ¡ï¼ˆä¼˜åŒ–ï¼šåªæŸ¥è¯¢éœ€è¦å–æ¶ˆçš„ä»»åŠ¡ï¼‰"""
    from app.models import Task
    from app.database import SessionLocal
    from sqlalchemy import and_
    
    db = SessionLocal()
    try:
        now = get_utc_time()
        # åªæŸ¥è¯¢éœ€è¦å–æ¶ˆçš„ä»»åŠ¡ï¼ˆopençŠ¶æ€ä¸”deadlineå·²è¿‡ï¼‰
        expired_tasks = db.query(Task).filter(
            and_(
                Task.status == "open",
                Task.deadline.isnot(None),
                Task.deadline < now
            )
        ).all()
        
        for task in expired_tasks:
            task.status = "cancelled"
            # ç«‹å³æ¸…ç†æ–‡ä»¶
            from app.crud import cleanup_task_files
            cleanup_task_files(db, task.id)
        
        db.commit()
    finally:
        db.close()
```

---

## å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šä¼šè¯å’Œç¼“å­˜ä¼˜åŒ–ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- [ ] ç§»é™¤ `run_session_cleanup_task()` çº¿ç¨‹
- [ ] ç§»é™¤ `CleanupTasks._cleanup_expired_sessions()` ä¸­çš„ä¼šè¯æ¸…ç†
- [ ] ä¼˜åŒ– `RedisCache.get()` æ·»åŠ å»¶è¿Ÿåˆ é™¤
- [ ] ç§»é™¤ `CleanupTasks._cleanup_expired_cache()` ä¸­çš„æ‰«æé€»è¾‘
- [ ] ç¡®ä¿æ‰€æœ‰ç¼“å­˜æ“ä½œéƒ½è®¾ç½®äº†TTL

### é˜¶æ®µ2ï¼šä»»åŠ¡æ–‡ä»¶æ¸…ç†ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- [ ] åœ¨ä»»åŠ¡å®Œæˆæ—¶è®¾ç½®å»¶è¿Ÿæ¸…ç†ä»»åŠ¡
- [ ] åœ¨ä»»åŠ¡è¿‡æœŸæ—¶ç«‹å³æ¸…ç†æ–‡ä»¶
- [ ] åœ¨ä»»åŠ¡è¯¦æƒ…APIä¸­æ·»åŠ å»¶è¿Ÿåˆ é™¤æ£€æŸ¥
- [ ] å°†å®šæœŸæ¸…ç†æ”¹ä¸ºæ¯å‘¨ä¸€æ¬¡ï¼ˆå…œåº•ï¼‰

### é˜¶æ®µ3ï¼šä¸´æ—¶å›¾ç‰‡æ¸…ç†ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- [ ] åœ¨ä¸´æ—¶å›¾ç‰‡ä¸Šä¼ æ—¶è®°å½•åˆ°Redis
- [ ] åœ¨ä»»åŠ¡åˆ›å»ºæˆåŠŸåæ¸…ç†è¯¥ç”¨æˆ·çš„ä¸´æ—¶å›¾ç‰‡
- [ ] æ·»åŠ å®šæœŸä»»åŠ¡æ£€æŸ¥Redisè®°å½•å¹¶æ¸…ç†æ–‡ä»¶
- [ ] ä¼˜åŒ–å®šæœŸæ‰«æï¼Œé™ä½é¢‘ç‡ï¼ˆä»æ¯å°æ—¶æ”¹ä¸ºæ¯6å°æ—¶æˆ–æ¯å¤©ï¼‰

### é˜¶æ®µ4ï¼šå®šæ—¶ä»»åŠ¡ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
- [ ] ä¼˜åŒ–è¿‡æœŸä¼˜æƒ åˆ¸/é‚€è¯·ç /ç§¯åˆ†æ£€æŸ¥ï¼ˆåªæŸ¥è¯¢å³å°†è¿‡æœŸçš„ï¼‰
- [ ] ä¼˜åŒ–è¿‡æœŸä»»åŠ¡å–æ¶ˆæŸ¥è¯¢ï¼ˆåªæŸ¥è¯¢éœ€è¦å–æ¶ˆçš„ä»»åŠ¡ï¼‰
- [ ] ä¼˜åŒ–ç”¨æˆ·ç»Ÿè®¡æ›´æ–°ï¼ˆå¢é‡æ›´æ–°æˆ–äº‹ä»¶é©±åŠ¨ï¼‰
- [ ] ä¼˜åŒ–ä»»åŠ¡è¾¾äººbioæ›´æ–°ï¼ˆå¢é‡æ›´æ–°æˆ–äº‹ä»¶é©±åŠ¨ï¼‰

### é˜¶æ®µ5ï¼šç¼ºå¤±çš„å®šæ—¶ä»»åŠ¡ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- [ ] æ·»åŠ æ¸…ç†è¿‡æœŸå¾…éªŒè¯ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡
- [ ] ç»Ÿä¸€å®šæ—¶ä»»åŠ¡ç®¡ç†ï¼ˆè€ƒè™‘ä½¿ç”¨Celeryæˆ–APSchedulerï¼‰

### é˜¶æ®µ6ï¼šæµ‹è¯•å’Œç›‘æ§ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§
- [ ] éªŒè¯æ¸…ç†æ•ˆæœ
- [ ] ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- [ ] æ·»åŠ å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¥å¿—å’Œç»Ÿè®¡

---

## é¢„æœŸæ•ˆæœ

### æ€§èƒ½æå‡

1. **CPUä½¿ç”¨ç‡é™ä½**
   - ç§»é™¤é¢‘ç¹çš„å…¨è¡¨æ‰«æ
   - å‡å°‘æ— æ•ˆçš„æ•°æ®åº“æŸ¥è¯¢

2. **å†…å­˜ä½¿ç”¨ä¼˜åŒ–**
   - Redisè‡ªåŠ¨æ¸…ç†è¿‡æœŸé”®ï¼Œæ— éœ€æ‰‹åŠ¨æ‰«æ
   - åŠæ—¶é‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿèµ„æº

3. **å“åº”æ—¶é—´æ”¹å–„**
   - å‡å°‘å®šæœŸä»»åŠ¡å¯¹ç³»ç»Ÿçš„å½±å“
   - å»¶è¿Ÿåˆ é™¤åœ¨è®¿é—®æ—¶æ‰§è¡Œï¼Œä¸å½±å“æ­£å¸¸è¯·æ±‚

### èµ„æºèŠ‚çœ

1. **æ•°æ®åº“æŸ¥è¯¢å‡å°‘**
   - ä»æ¯åˆ†é’Ÿ/æ¯5åˆ†é’Ÿå…¨è¡¨æ‰«æ â†’ æŒ‰éœ€æŸ¥è¯¢
   - é¢„è®¡å‡å°‘ 80-90% çš„æ¸…ç†ç›¸å…³æŸ¥è¯¢

2. **Redisæ“ä½œå‡å°‘**
   - ä»æ¯å°æ—¶æ‰«ææ‰€æœ‰é”® â†’ ä¾èµ–TTLè‡ªåŠ¨è¿‡æœŸ
   - é¢„è®¡å‡å°‘ 95% çš„æ¸…ç†ç›¸å…³æ“ä½œ

3. **æ–‡ä»¶ç³»ç»Ÿæ“ä½œä¼˜åŒ–**
   - ä»æ‰¹é‡æ‰«æ â†’ äº‹ä»¶é©±åŠ¨æ¸…ç†
   - åŠæ—¶é‡Šæ”¾å­˜å‚¨ç©ºé—´

### ä»£ç ç®€åŒ–

1. **ç§»é™¤å†—ä½™ä»£ç **
   - ç§»é™¤ `run_session_cleanup_task()`
   - ç®€åŒ– `CleanupTasks` ç±»

2. **é€»è¾‘æ›´æ¸…æ™°**
   - æ¸…ç†é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘ç»“åˆ
   - æ›´å®¹æ˜“ç»´æŠ¤å’Œç†è§£

---

## å®Œæ•´å®šæ—¶ä»»åŠ¡æ¸…å•ï¼ˆè¯¦ç»†ç‰ˆï¼‰

### æŒ‰æ‰§è¡Œé¢‘ç‡åˆ†ç±»

#### æ¯30ç§’æ‰§è¡Œ
1. **å¤„ç†å®¢æœæ’é˜Ÿ** (`process_customer_service_queue_task`)
   - **ä½ç½®**: `backend/app/customer_service_tasks.py:28`
   - **æ‰§è¡Œæ–¹å¼**: Celeryä»»åŠ¡ï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–é€šè¿‡ `scheduled_tasks.py` æ¯5åˆ†é’Ÿæ‰§è¡Œ
   - **åŠŸèƒ½**: æ‰¹é‡åˆ†é…ç­‰å¾…ä¸­çš„ç”¨æˆ·åˆ°å¯ç”¨å®¢æœ

2. **è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯** (`auto_end_timeout_chats_task`)
   - **ä½ç½®**: `backend/app/customer_service_tasks.py:37`
   - **æ‰§è¡Œæ–¹å¼**: Celeryä»»åŠ¡ï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–é€šè¿‡ `scheduled_tasks.py` æ¯5åˆ†é’Ÿæ‰§è¡Œ
   - **è¶…æ—¶æ—¶é—´**: 2åˆ†é’Ÿæ— æ´»åŠ¨
   - **åŠŸèƒ½**: è‡ªåŠ¨ç»“æŸè¶…æ—¶çš„å®¢æœå¯¹è¯

3. **å‘é€è¶…æ—¶é¢„è­¦** (`send_timeout_warnings_task`)
   - **ä½ç½®**: `backend/app/customer_service_tasks.py:46`
   - **æ‰§è¡Œæ–¹å¼**: Celeryä»»åŠ¡ï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–é€šè¿‡ `scheduled_tasks.py` æ¯5åˆ†é’Ÿæ‰§è¡Œ
   - **é¢„è­¦æ—¶é—´**: 1åˆ†é’Ÿæ— æ´»åŠ¨
   - **åŠŸèƒ½**: å‘å³å°†è¶…æ—¶çš„å¯¹è¯å‘é€é¢„è­¦

#### æ¯åˆ†é’Ÿæ‰§è¡Œ
1. **å–æ¶ˆè¿‡æœŸä»»åŠ¡** (`cancel_expired_tasks`)
   - **ä½ç½®**: `backend/app/main.py:383`
   - **æ‰§è¡Œæ–¹å¼**: åå°çº¿ç¨‹ï¼ˆ`run_background_task`ï¼‰
   - **åŠŸèƒ½**: è‡ªåŠ¨å–æ¶ˆdeadlineå·²è¿‡çš„opençŠ¶æ€ä»»åŠ¡
   - **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆåªæŸ¥è¯¢éœ€è¦å–æ¶ˆçš„ä»»åŠ¡ï¼‰

#### æ¯5åˆ†é’Ÿæ‰§è¡Œ
1. **ä¼šè¯æ¸…ç†** (`run_session_cleanup_task`)
   - **ä½ç½®**: `backend/app/main.py:461`
   - **æ‰§è¡Œæ–¹å¼**: åå°çº¿ç¨‹ï¼ˆdaemonï¼‰
   - **åŠŸèƒ½**: æ¸…ç†è¿‡æœŸç”¨æˆ·ä¼šè¯
   - **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆç§»é™¤ï¼Œä¾èµ–Redis TTLï¼‰

2. **å®šæ—¶ä»»åŠ¡** (`run_scheduled_tasks`)
   - **ä½ç½®**: `backend/app/scheduled_tasks.py:125`
   - **æ‰§è¡Œæ–¹å¼**: åå°çº¿ç¨‹ï¼ˆdaemonï¼‰
   - **åŠŸèƒ½**:
     - æ£€æŸ¥è¿‡æœŸä¼˜æƒ åˆ¸ (`check_expired_coupons`)
     - æ£€æŸ¥è¿‡æœŸé‚€è¯·ç  (`check_expired_invitation_codes`)
     - æ£€æŸ¥è¿‡æœŸç§¯åˆ† (`check_expired_points`)
     - å®¢æœç³»ç»Ÿä»»åŠ¡ï¼ˆæ’é˜Ÿã€è¶…æ—¶ã€é¢„è­¦ï¼‰
   - **çŠ¶æ€**: éƒ¨åˆ†å¯ä¼˜åŒ–ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ã€äº‹ä»¶é©±åŠ¨ï¼‰

#### æ¯10åˆ†é’Ÿæ‰§è¡Œ
1. **æ›´æ–°ç”¨æˆ·ç»Ÿè®¡** (`update_all_users_statistics`)
   - **ä½ç½®**: `backend/app/main.py:401`
   - **æ‰§è¡Œæ–¹å¼**: åå°çº¿ç¨‹ï¼ˆ`run_background_task`ï¼‰
   - **åŠŸèƒ½**: æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»»åŠ¡æ•°ã€å®Œæˆæ•°ã€è¯„åˆ†ç­‰ï¼‰
   - **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆå¢é‡æ›´æ–°æˆ–äº‹ä»¶é©±åŠ¨ï¼‰

#### æ¯å°æ—¶æ‰§è¡Œ
1. **å®šæœŸæ¸…ç†ä»»åŠ¡** (`CleanupTasks._run_cleanup_cycle`)
   - **ä½ç½®**: `backend/app/cleanup_tasks.py:42`
   - **æ‰§è¡Œæ–¹å¼**: å¼‚æ­¥ä»»åŠ¡ï¼ˆ`asyncio.create_task`ï¼‰
   - **åŠŸèƒ½**:
     - æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆç”¨æˆ·/å®¢æœ/ç®¡ç†å‘˜ï¼‰- æ¯å°æ—¶
     - æ¸…ç†è¿‡æœŸç¼“å­˜ - æ¯å°æ—¶
     - æ¸…ç†å·²å®Œæˆä»»åŠ¡æ–‡ä»¶ - æ¯å¤©ä¸€æ¬¡ï¼ˆæ£€æŸ¥æ—¥æœŸï¼‰
     - æ¸…ç†è¿‡æœŸä»»åŠ¡æ–‡ä»¶ - æ¯å¤©ä¸€æ¬¡ï¼ˆæ£€æŸ¥æ—¥æœŸï¼‰
     - æ¸…ç†æœªä½¿ç”¨ä¸´æ—¶å›¾ç‰‡ - æ¯å°æ—¶
   - **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆéƒ¨åˆ†å¯ç§»é™¤æˆ–é™ä½é¢‘ç‡ï¼‰

#### æ¯å¤©æ‰§è¡Œ
1. **æ›´æ–°ä»»åŠ¡è¾¾äººbio** (`update_all_task_experts_bio`)
   - **ä½ç½®**: `backend/app/crud.py:275`
   - **æ‰§è¡Œæ–¹å¼**: åå°çº¿ç¨‹ï¼ˆ`run_background_task`ï¼Œæ£€æŸ¥æ—¥æœŸï¼‰
   - **åŠŸèƒ½**: æ›´æ–°æ‰€æœ‰ä»»åŠ¡è¾¾äººçš„å“åº”æ—¶é—´å’Œç»Ÿè®¡å­—æ®µ
   - **çŠ¶æ€**: å¯ä¼˜åŒ–ï¼ˆå¢é‡æ›´æ–°æˆ–äº‹ä»¶é©±åŠ¨ï¼‰

2. **æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯** (`cleanup_long_inactive_chats`)
   - **ä½ç½®**: `backend/app/customer_service_tasks.py:374`
   - **æ‰§è¡Œæ—¶é—´**: æ¯å¤©å‡Œæ™¨2ç‚¹
   - **æ‰§è¡Œæ–¹å¼**: Celeryä»»åŠ¡ï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–é€šè¿‡ `scheduled_tasks.py` æ£€æŸ¥æ—¶é—´
   - **åŠŸèƒ½**: æ¸…ç†30å¤©æ— æ´»åŠ¨çš„å®¢æœå¯¹è¯
   - **å‚æ•°**: `inactive_days=30`

3. **æ¸…ç†å·²å®Œæˆä»»åŠ¡æ–‡ä»¶** (`cleanup_completed_tasks_files`)
   - **ä½ç½®**: `backend/app/crud.py:1740`
   - **æ‰§è¡Œæ–¹å¼**: é€šè¿‡ `CleanupTasks` æ¯å¤©æ£€æŸ¥ä¸€æ¬¡
   - **åŠŸèƒ½**: æ¸…ç†å·²å®Œæˆè¶…è¿‡3å¤©çš„ä»»åŠ¡æ–‡ä»¶ï¼ˆå…¬å¼€å’Œç§å¯†ï¼‰

4. **æ¸…ç†è¿‡æœŸä»»åŠ¡æ–‡ä»¶** (`cleanup_expired_tasks_files`)
   - **ä½ç½®**: `backend/app/crud.py:1783`
   - **æ‰§è¡Œæ–¹å¼**: é€šè¿‡ `CleanupTasks` æ¯å¤©æ£€æŸ¥ä¸€æ¬¡
   - **åŠŸèƒ½**: æ¸…ç†è¿‡æœŸè¶…è¿‡3å¤©çš„ä»»åŠ¡æ–‡ä»¶ï¼ˆå·²å–æ¶ˆæˆ–deadlineå·²è¿‡ï¼‰

### ç¼ºå¤±çš„å®šæ—¶ä»»åŠ¡

1. **æ¸…ç†è¿‡æœŸå¾…éªŒè¯ç”¨æˆ·** (`cleanup_expired_pending_users`)
   - **ä½ç½®**: `backend/app/email_verification.py:339`
   - **çŠ¶æ€**: âš ï¸ **æœªå‘ç°å®šæ—¶ä»»åŠ¡ï¼Œéœ€è¦æ·»åŠ **
   - **å»ºè®®é¢‘ç‡**: æ¯å¤©æ‰§è¡Œä¸€æ¬¡
   - **åŠŸèƒ½**: æ¸…ç†è¿‡æœŸçš„ `PendingUser` è®°å½•ï¼ˆé‚®ç®±éªŒè¯æœªå®Œæˆï¼‰

### ä»»åŠ¡æ‰§è¡Œæ–¹å¼æ€»ç»“

1. **åå°çº¿ç¨‹** (`threading.Thread`)
   - `run_session_cleanup_task` - æ¯5åˆ†é’Ÿ
   - `run_background_task` - æ¯åˆ†é’Ÿï¼ˆåŒ…å«å¤šä¸ªå­ä»»åŠ¡ï¼‰
   - `run_tasks_periodically` - æ¯5åˆ†é’Ÿï¼ˆscheduled_tasksï¼‰

2. **å¼‚æ­¥ä»»åŠ¡** (`asyncio.create_task`)
   - `CleanupTasks.start_cleanup_tasks` - æ¯å°æ—¶

3. **Celery Beat** (å¦‚æœå¯ç”¨)
   - å®¢æœç³»ç»Ÿç›¸å…³ä»»åŠ¡ï¼ˆæ¯30ç§’æˆ–æ¯å¤©ï¼‰
   - é…ç½®ä½ç½®ï¼š`backend/app/celery_app.py:37`

4. **BackgroundTasks** (FastAPI)
   - é‚®ä»¶å‘é€
   - WebSocketæ¨é€
   - éå®šæ—¶ä»»åŠ¡ï¼Œäº‹ä»¶é©±åŠ¨

### ä»»åŠ¡ä¾èµ–å…³ç³»

- **å®¢æœç³»ç»Ÿä»»åŠ¡**: å¦‚æœCeleryå¯ç”¨ï¼Œä½¿ç”¨Celery Beatï¼ˆæ¯30ç§’ï¼‰ï¼›å¦åˆ™å›é€€åˆ° `scheduled_tasks.py`ï¼ˆæ¯5åˆ†é’Ÿï¼‰
- **æ¸…ç†ä»»åŠ¡**: `CleanupTasks` å†…éƒ¨æ£€æŸ¥æ—¥æœŸï¼Œç¡®ä¿æ¯å¤©åªæ‰§è¡Œä¸€æ¬¡æ–‡ä»¶æ¸…ç†
- **åå°ä»»åŠ¡**: `run_background_task` å†…éƒ¨ä½¿ç”¨è®¡æ•°å™¨ï¼Œå®ç°ä¸åŒé¢‘ç‡çš„å­ä»»åŠ¡

---

## æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**
   - ç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
   - é€æ­¥è¿ç§»ï¼Œä¿ç•™å…œåº•æœºåˆ¶

2. **ç›‘æ§å’Œæ—¥å¿—**
   - æ·»åŠ æ¸…ç†æ“ä½œçš„ç›‘æ§
   - è®°å½•æ¸…ç†ç»Ÿè®¡ä¿¡æ¯

3. **é”™è¯¯å¤„ç†**
   - å»¶è¿Ÿåˆ é™¤å¤±è´¥ä¸åº”å½±å“æ­£å¸¸ä¸šåŠ¡
   - å®šæœŸå…œåº•ä»»åŠ¡ç¡®ä¿æ•°æ®æœ€ç»ˆè¢«æ¸…ç†

4. **æµ‹è¯•**
   - å……åˆ†æµ‹è¯•å„ç§åœºæ™¯
   - éªŒè¯æ¸…ç†æ•ˆæœå’Œæ€§èƒ½æå‡

---

## æ€»ç»“

é€šè¿‡é‡‡ç”¨"è®©æ•°æ®è‡ªå·±æ¸…ç†è‡ªå·±"çš„ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. âœ… **ç§»é™¤å¤§éƒ¨åˆ†å®šæœŸæ‰«æä»»åŠ¡**
2. âœ… **åˆ©ç”¨Redis TTLè‡ªåŠ¨è¿‡æœŸ**
3. âœ… **åœ¨è®¿é—®æ—¶è¿›è¡Œå»¶è¿Ÿåˆ é™¤**
4. âœ… **åœ¨å…³é”®äº‹ä»¶æ—¶ç«‹å³æ¸…ç†**
5. âœ… **ä¿ç•™å¿…è¦çš„å®šæœŸå…œåº•ä»»åŠ¡**

è¿™æ ·æ—¢èƒ½ä¿è¯æ•°æ®åŠæ—¶æ¸…ç†ï¼Œåˆèƒ½å¤§å¹…å‡å°‘ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼Œæå‡æ•´ä½“æ€§èƒ½ã€‚

