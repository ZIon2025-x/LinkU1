# å®¢æœåŠŸèƒ½ä¼˜åŒ–æ—¥å¿—

## ğŸš¨ é˜»æ–­çº§é—®é¢˜ä¿®å¤æ¸…å•ï¼ˆBlocking Issuesï¼‰

> **æœ€åæ›´æ–°ï¼š2024å¹´12æœˆ28æ—¥**  
> **çŠ¶æ€ï¼šå·²ä¿®å¤æ–‡æ¡£ï¼Œå¾…ä»£ç å®ç°**

### âœ… å·²ä¿®å¤çš„æ–‡æ¡£é—®é¢˜

1. **æ—¶é—´åŸºå‡†ç»Ÿä¸€** âœ…
   - æ‰€æœ‰å®šæ—¶ä»»åŠ¡å‡½æ•°å·²ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`
   - ç§»é™¤äº† `pytz.timezone("Europe/London")` å’Œ `datetime.utcnow()` çš„æ··ç”¨
   - æ‰€æœ‰æ—¶é—´è®¡ç®—ç»Ÿä¸€ä¸ºUTCåŸºå‡†
   - æ—¶åŒºåº“è¿ç§»åˆ° `zoneinfo`ï¼ˆPython 3.9+æ¨èï¼‰

2. **å®šæ—¶ä»»åŠ¡æ”¹ä¸ºå†…éƒ¨ä»»åŠ¡** âœ…
   - æ‰€æœ‰ `@router.post` å®šæ—¶ä»»åŠ¡ç«¯ç‚¹å·²æ”¹ä¸ºå†…éƒ¨å‡½æ•°
   - æ·»åŠ äº†å®Œæ•´çš„Celeryä»»åŠ¡é…ç½®ç¤ºä¾‹
   - æ˜ç¡®æ ‡æ³¨ä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
   - `process_queue_with_optimistic_lock` æ˜ç¡®ä¸ºå†…éƒ¨ä»»åŠ¡

3. **é€Ÿç‡é™åˆ¶å®ç°ç»Ÿä¸€** âœ…
   - ç§»é™¤äº† `asyncio.run` çš„åŒæ­¥åŒ…è£…
   - ç»Ÿä¸€ä¸ºçº¯å¼‚æ­¥å®ç°ï¼Œè¦æ±‚æ‰€æœ‰å‡½æ•°å¿…é¡»æ˜¯async
   - é¿å…äº†FastAPIäº‹ä»¶å¾ªç¯å†²çª
   - ä½¿ç”¨Redisæœ‰åºé›†åˆæ»‘åŠ¨çª—å£ç®—æ³•

4. **WebSocketå®ç°ç»Ÿä¸€** âœ…
   - æ‰€æœ‰å¿ƒè·³/ACK/åç§»é‡æ”¾å®ç°å·²ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`
   - å•ä¸€æƒå¨å®ç°ï¼Œç§»é™¤äº†é‡å¤æ®µè½
   - æ·»åŠ äº†è·¯ç”±æŒ‚è½½ç‚¹è¯´æ˜ `@router.websocket("/api/ws/customer-service/chat/{chat_id}")`

5. **è·¯ç”±å‘½åç»Ÿä¸€** âœ…
   - ç»Ÿä¸€å®¢æœç«¯è·¯ç”±ä¸º `/api/customer-service/...`
   - ç»Ÿä¸€ç”¨æˆ·ç«¯è·¯ç”±ä¸º `/api/user/customer-service/...`
   - ç§»é™¤äº† `/api/cs/login` æ··ç”¨
   - ç»Ÿä¸€é‡å®šå‘ç­–ç•¥ï¼šGETç”¨308ï¼ŒPOST/PUTç­‰ç”¨åŒæ³¨å†Œ

6. **MessageOffsetæ—¶åŒºæ ‡æ³¨** âœ…
   - ç»Ÿä¸€ä¸º `DateTime(timezone=True)` + `default=get_utc_time()`

7. **æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹ä¿®å¤** âœ…
   - ä¿®æ­£ `File(.)` æ‹¼å†™é”™è¯¯ä¸º `File(...)`
   - ä¿®å¤ `file.size` é—®é¢˜ï¼šæ”¹ä¸ºæµå¼è¯»å–è®¡ç®—å¤§å°
   - æ·»åŠ æ–‡ä»¶ç±»å‹å’Œå¤§å°é™åˆ¶

8. **ç»“æŸå¯¹è¯åŸå› å­—æ®µ** âœ…
   - æ·»åŠ å®Œæ•´çš„ORMå­—æ®µå®šä¹‰
   - æ·»åŠ å®Œæ•´çš„Alembicè¿ç§»è„šæœ¬

9. **ç­‰å¾…æ—¶é—´ä¼°ç®—å‡½æ•°** âœ…
   - ç¡®ä¿åªæœ‰ä¸€ä»½æƒå¨å®ç°
   - æ‰€æœ‰å¼•ç”¨ç»Ÿä¸€æŒ‡å‘åŒä¸€å®ç°

10. **é˜Ÿåˆ—è¡¨ç´¢å¼•** âœ…
    - æ·»åŠ å¤åˆç´¢å¼•å’Œå•åˆ—ç´¢å¼•è¯´æ˜
    - å®Œæ•´çš„DDLè¿ç§»è„šæœ¬

11. **is_service_availableä¿®å¤** âœ…
    - æ·»åŠ  `db: Session` å‚æ•°
    - æ·»åŠ å‚æ•°éªŒè¯

12. **é€Ÿç‡é™åˆ¶è¦†ç›–æ¸…å•** âœ…
    - åˆ—å‡ºæ‰€æœ‰å¿…é¡»ä½¿ç”¨ `@rate_limit_messages` è£…é¥°å™¨çš„è·¯ç”±ï¼ˆ9ä¸ªæ¥å£ï¼‰
    - åŒ…å«ç”¨æˆ·ç«¯å’Œå®¢æœç«¯æ‰€æœ‰æ¶ˆæ¯/æ–‡ä»¶/æ“ä½œæ¥å£
    - æä¾›é…ç½®å»ºè®®ï¼ˆæ™®é€šæ¶ˆæ¯ã€æ–‡ä»¶ä¸Šä¼ ã€ç»“æŸå¯¹è¯/è¯„åˆ†ï¼‰

13. **è®¡åˆ’ä»»åŠ¡å®šä½æ˜ç¡®** âœ…
    - åœ¨"å½“å‰å®ç°çŠ¶æ€"ä¸­æ˜ç¡®æ ‡æ³¨ä¸ºå†…éƒ¨ä»»åŠ¡
    - è¯´æ˜ä¸å¯¹å¤–æš´éœ²HTTPç«¯ç‚¹ï¼Œä»…é€šè¿‡Celeryè§¦å‘

14. **è·¯çº¿å›¾çŠ¶æ€æ›´æ–°** âœ…
    - æ‰€æœ‰å·²ä¿®å¤æ–‡æ¡£çš„é¡¹ç›®æ›´æ–°çŠ¶æ€
    - åŒºåˆ†æ–‡æ¡£ä¿®æ­£å’Œä»£ç å®ç°çŠ¶æ€

### âš ï¸ å¾…ä»£ç å®ç°çš„ä¿®å¤é¡¹

ä»¥ä¸‹ä¿®å¤é¡¹å·²åœ¨æ–‡æ¡£ä¸­å®Œæˆï¼Œéœ€è¦åœ¨ä»£ç ä¸­å®ç°ï¼š

1. **åˆ›å»º `backend/app/utils/time_utils.py`**
   - å®ç° `get_utc_time()`, `to_utc()`, `to_user_timezone()` å‡½æ•°

2. **æ›¿æ¢æ‰€æœ‰æ—¶é—´ç›¸å…³ä»£ç **
   - å…¨æ–‡æœç´¢ `datetime.utcnow()` â†’ æ›¿æ¢ä¸º `get_utc_time()`
   - å…¨æ–‡æœç´¢ `pytz.timezone("Europe/London")` â†’ ç§»é™¤æˆ–æ”¹ä¸º `to_user_timezone()`
   - å…¨æ–‡æœç´¢ `get_uk_time()` â†’ æ›¿æ¢ä¸º `get_utc_time()`

3. **åˆ›å»ºCeleryä»»åŠ¡æ¨¡å—**
   - åˆ›å»º `backend/app/customer_service_tasks.py`
   - å®ç°æ‰€æœ‰å®šæ—¶ä»»åŠ¡å‡½æ•°
   - é…ç½® `celery_app.conf.beat_schedule`

4. **ç§»é™¤HTTPç«¯ç‚¹**
   - åˆ é™¤æ‰€æœ‰å®šæ—¶ä»»åŠ¡çš„ `@router.post` è£…é¥°å™¨
   - æ”¹ä¸ºå†…éƒ¨å‡½æ•°ï¼Œä»…é€šè¿‡Celeryè§¦å‘

5. **ç»Ÿä¸€è·¯ç”±å‘½å**
   - è¿ç§» `/api/cs/login` â†’ `/api/customer-service/login`
   - è¿ç§»ç”¨æˆ·ç«¯è·¯ç”±åˆ° `/api/user/customer-service/...`
   - æ·»åŠ è·¯ç”±å…¼å®¹å±‚ï¼š
     - GETè¯·æ±‚ï¼šä½¿ç”¨308æ°¸ä¹…é‡å®šå‘ï¼ˆä¿æŒæ–¹æ³•ï¼‰
     - POST/PUT/DELETEç­‰ï¼šåŒæ³¨å†ŒåŒä¸€å¤„ç†å‡½æ•°è¿‡æ¸¡2å‘¨ï¼Œå†ä¸‹çº¿æ—§è·¯ç”±
     - é¿å…301é‡å®šå‘å¯¼è‡´POSTè¢«è¯¯æ”¹ä¸ºGETï¼ˆç»Ÿä¸€ä½¿ç”¨308æˆ–åŒæ³¨å†Œï¼‰

6. **ä¿®å¤é€Ÿç‡é™åˆ¶è£…é¥°å™¨**
   - ç§»é™¤ `asyncio.run` åŒæ­¥åŒ…è£…
   - è¦æ±‚æ‰€æœ‰ä½¿ç”¨è¯¥è£…é¥°å™¨çš„å‡½æ•°æ”¹ä¸º `async def`

---

## ğŸ“‹ ç›®å½•
1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [å½“å‰å®ç°çŠ¶æ€](#å½“å‰å®ç°çŠ¶æ€)
3. [å·²å®ç°åŠŸèƒ½](#å·²å®ç°åŠŸèƒ½)
4. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)
5. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
6. [ç”¨æˆ·ä½“éªŒä¼˜åŒ–](#ç”¨æˆ·ä½“éªŒä¼˜åŒ–)
7. [å®‰å…¨æ€§ä¼˜åŒ–](#å®‰å…¨æ€§ä¼˜åŒ–)
8. [æœªæ¥è§„åˆ’](#æœªæ¥è§„åˆ’)

---

## åŠŸèƒ½æ¦‚è¿°

å®¢æœç³»ç»Ÿæ˜¯LinkUå¹³å°çš„æ ¸å¿ƒæ”¯æŒåŠŸèƒ½ï¼Œæä¾›ç”¨æˆ·ä¸å®¢æœä¹‹é—´çš„å®æ—¶æ²Ÿé€šæ¸ é“ï¼Œä»¥åŠå®¢æœå¯¹ä»»åŠ¡å–æ¶ˆè¯·æ±‚çš„å®¡æ ¸ç®¡ç†åŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨ç‹¬ç«‹çš„è®¤è¯ä½“ç³»ï¼Œç¡®ä¿å®¢æœä¸æ™®é€šç”¨æˆ·æƒé™åˆ†ç¦»ã€‚

---

## å…¨å±€æ—¶é—´å¤„ç†æœºåˆ¶

### å½“å‰å®ç°çŠ¶æ€

**âš ï¸ ä¸¥é‡é—®é¢˜ï¼šæ—¶é—´åŸºå‡†æ··ç”¨**

ç³»ç»Ÿç›®å‰å­˜åœ¨ä¸‰ç§æ—¶é—´å¤„ç†æ–¹å¼æ··ç”¨çš„é—®é¢˜ï¼š

1. **`get_uk_time()`** - è¿”å›ä¼¦æ•¦æ—¶åŒºæ—¶é—´ï¼ˆå¸¦æ—¶åŒºä¿¡æ¯ï¼‰- å·²åºŸå¼ƒ
2. **`datetime.utcnow()`** - è¿”å›UTCæ—¶é—´ï¼ˆæ— æ—¶åŒºä¿¡æ¯ï¼‰- å·²åºŸå¼ƒ
3. **`pytz.timezone("Europe/London")`** - æ‰‹åŠ¨è½¬æ¢ä¼¦æ•¦æ—¶åŒº - å·²åºŸå¼ƒï¼Œè¿ç§»åˆ°zoneinfo

**é—®é¢˜å½±å“**:
- DSTï¼ˆå¤ä»¤æ—¶ï¼‰åˆ‡æ¢æ—¶ä¼šå‡ºç°æ—¶é—´è®¡ç®—é”™è¯¯
- æ’é˜Ÿç­‰å¾…æ—¶é—´è®¡ç®—ä¸å‡†ç¡®
- è¶…æ—¶åˆ¤æ–­å¯èƒ½å‡ºé”™
- æ•°æ®ä¸ä¸€è‡´

**å½“å‰ä»£ç ä½ç½®**ï¼ˆéœ€è¦ä¿®å¤ï¼‰:
- `backend/app/crud.py`: æ¨¡å‹é»˜è®¤å€¼ä½¿ç”¨ `get_uk_time()` â†’ åº”æ”¹ä¸º `get_utc_time()`
- `backend/app/routers.py`: è¶…æ—¶åˆ¤æ–­ä½¿ç”¨ `datetime.utcnow()` å’Œ `pytz.timezone("Europe/London")` â†’ åº”ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()` å’Œ `zoneinfo`
- é˜Ÿåˆ—è¡¨ `queued_at` ä½¿ç”¨ `get_uk_time()`ï¼Œä½†è®¡ç®—æ—¶ç”¨ `datetime.utcnow()` â†’ åº”ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`

### ç»Ÿä¸€æ—¶é—´ç­–ç•¥ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

**åŸåˆ™**: æ•°æ®åº“ç»Ÿä¸€å­˜å‚¨UTCæ—¶é—´ï¼Œè®¡ç®—ç»Ÿä¸€ä½¿ç”¨UTCï¼Œæ˜¾ç¤ºæ—¶å†è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒº

#### 1. ç»Ÿä¸€æ—¶é—´å‡½æ•°

```python
# backend/app/utils/time_utils.py
from datetime import datetime, timezone
from typing import Optional
from zoneinfo import ZoneInfo  # Python 3.9+ æ¨èä½¿ç”¨zoneinfoæ›¿ä»£pytz
# æ³¨æ„ï¼šå¦‚æœPython < 3.9ï¼Œéœ€è¦å®‰è£…backports.zoneinfo: pip install backports.zoneinfo

def get_utc_time() -> datetime:
    """
    è·å–å½“å‰UTCæ—¶é—´ï¼ˆå¸¦æ—¶åŒºä¿¡æ¯ï¼‰
    æ›¿ä»£æ‰€æœ‰ get_uk_time() å’Œ datetime.utcnow()
    """
    return datetime.now(timezone.utc)

def to_utc(dt: datetime) -> datetime:
    """
    å°†ä»»æ„æ—¶é—´è½¬æ¢ä¸ºUTC
    """
    if dt.tzinfo is None:
        # å¦‚æœæ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå‡è®¾æ˜¯UTC
        return dt.replace(tzinfo=timezone.utc)
    else:
        # è½¬æ¢ä¸ºUTC
        return dt.astimezone(timezone.utc)

def to_user_timezone(dt: datetime, user_timezone: str = "Europe/London") -> datetime:
    """
    å°†UTCæ—¶é—´è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒº
    ä½¿ç”¨zoneinfoæ›¿ä»£pytzï¼ˆPython 3.9+æ¨èï¼‰
    """
    if dt.tzinfo is None:
        # å¦‚æœæ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå‡è®¾æ˜¯UTC
        dt = dt.replace(tzinfo=timezone.utc)
    else:
        # ç¡®ä¿æ˜¯UTC
        dt = dt.astimezone(timezone.utc)
    
    # è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºï¼ˆä½¿ç”¨zoneinfoæ›¿ä»£pytzï¼‰
    user_tz = ZoneInfo(user_timezone)
    return dt.astimezone(user_tz)

def format_time_for_display(dt: datetime, user_timezone: str = "Europe/London") -> str:
    """
    æ ¼å¼åŒ–æ—¶é—´ç”¨äºæ˜¾ç¤ºï¼ˆè½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºï¼‰
    ä½¿ç”¨zoneinfoæ›¿ä»£pytzï¼ˆPython 3.9+æ¨èï¼‰
    """
    local_time = to_user_timezone(dt, user_timezone)  # to_user_timezoneå†…éƒ¨å·²ä½¿ç”¨zoneinfo
    return local_time.strftime('%Y-%m-%d %H:%M:%S %Z')
```

#### 2. æ¨¡å‹é»˜è®¤å€¼ç»Ÿä¸€

```python
# backend/app/models.py
from app.utils.time_utils import get_utc_time

class CustomerServiceChat(Base):
    __tablename__ = "customer_service_chats"
    # ... å…¶ä»–å­—æ®µ
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ”¹ä¸ºUTC
    last_message_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ”¹ä¸ºUTC
    ended_at = Column(DateTime(timezone=True), nullable=True)

class CustomerServiceQueue(Base):
    __tablename__ = "customer_service_queue"
    # ... å…¶ä»–å­—æ®µ
    queued_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ”¹ä¸ºUTC
    assigned_at = Column(DateTime(timezone=True), nullable=True)

class CustomerServiceMessage(Base):
    __tablename__ = "customer_service_messages"
    # ... å…¶ä»–å­—æ®µ
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ”¹ä¸ºUTC
    sent_at = Column(DateTime(timezone=True), nullable=True)
    delivered_at = Column(DateTime(timezone=True), nullable=True)
    read_at = Column(DateTime(timezone=True), nullable=True)
```

#### 3. æ—¶é—´è®¡ç®—ç»Ÿä¸€

```python
# æ‰€æœ‰æ—¶é—´è®¡ç®—éƒ½ä½¿ç”¨UTC
from app.utils.time_utils import get_utc_time, to_utc

def calculate_wait_time(queued_at: datetime) -> int:
    """è®¡ç®—ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰- ç»Ÿä¸€ä½¿ç”¨UTC"""
    queued_at_utc = to_utc(queued_at)
    now_utc = get_utc_time()
    return int((now_utc - queued_at_utc).total_seconds())

def check_chat_timeout(chat_id: str, timeout_minutes: int, db: Session) -> bool:
    """æ£€æŸ¥å¯¹è¯æ˜¯å¦è¶…æ—¶ - ç»Ÿä¸€ä½¿ç”¨UTC"""
    chat = db.query(CustomerServiceChat).filter(
        CustomerServiceChat.chat_id == chat_id
    ).first()
    
    if not chat or not chat.last_message_at:
        return False
    
    last_message_utc = to_utc(chat.last_message_at)
    now_utc = get_utc_time()
    time_diff = now_utc - last_message_utc
    
    return time_diff.total_seconds() > (timeout_minutes * 60)
```

#### 4. å‰ç«¯æ˜¾ç¤ºè½¬æ¢

```typescript
// frontend/src/utils/timeUtils.ts
import { format, formatInTimeZone } from 'date-fns-tz';

export function formatTimeForDisplay(
  utcTimeString: string,
  userTimezone: string = 'Europe/London'
): string {
  // å°†UTCæ—¶é—´è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºæ˜¾ç¤º
  return formatInTimeZone(utcTimeString, userTimezone, 'yyyy-MM-dd HH:mm:ss zzz');
}
```

#### 5. æ•°æ®åº“è¿ç§»

```python
# è¿ç§»è„šæœ¬ï¼šå°†æ‰€æœ‰ç°æœ‰æ—¶é—´æ•°æ®è½¬æ¢ä¸ºUTCï¼ˆä¸€æ¬¡æ€§è¿ç§»è„šæœ¬ï¼‰
# âš ï¸ æ³¨æ„ï¼šæ­¤è„šæœ¬ä»…åœ¨æ•°æ®è¿ç§»æ—¶ä½¿ç”¨ï¼Œè¿ç§»å®Œæˆååº”åˆ é™¤æˆ–æ³¨é‡Š
def migrate_times_to_utc(db: Session):
    """å°†æ‰€æœ‰æ—¶é—´å­—æ®µè½¬æ¢ä¸ºUTCå­˜å‚¨ï¼ˆä¸€æ¬¡æ€§è¿ç§»è„šæœ¬ï¼‰"""
    from datetime import timezone
    from zoneinfo import ZoneInfo  # Python 3.9+ æ¨èä½¿ç”¨zoneinfo
    # æ³¨æ„ï¼šå¦‚æœPython < 3.9ï¼Œè¿ç§»è„šæœ¬å¯ä¸´æ—¶ä½¿ç”¨pytzï¼Œè¿ç§»å®Œæˆååˆ é™¤pytzä¾èµ–
    
    # è½¬æ¢CustomerServiceChat
    chats = db.query(CustomerServiceChat).all()
    for chat in chats:
        if chat.created_at and chat.created_at.tzinfo is None:
            # å‡è®¾æ—§æ•°æ®æ˜¯ä¼¦æ•¦æ—¶åŒºï¼ˆæ— æ—¶åŒºä¿¡æ¯ï¼‰
            # ä½¿ç”¨zoneinfoè¿›è¡Œæ—¶åŒºè½¬æ¢ï¼ˆè¿ç§»è„šæœ¬ä¸­å¯ä¸´æ—¶ä½¿ç”¨pytzå¦‚æœPython < 3.9ï¼‰
            try:
                london_tz = ZoneInfo("Europe/London")
            except ImportError:
                # Python < 3.9 fallbackï¼ˆä»…è¿ç§»è„šæœ¬ä½¿ç”¨ï¼Œè¿ç§»å®Œæˆååˆ é™¤pytzä¾èµ–ï¼‰
                import pytz
                london_tz = pytz.timezone("Europe/London")
            
            if isinstance(chat.created_at, str):
                from datetime import datetime
                chat.created_at = datetime.fromisoformat(chat.created_at)
            
            if chat.created_at.tzinfo is None:
                # æœ¬åœ°åŒ–æ—¶é—´ï¼ˆå‡è®¾æ˜¯ä¼¦æ•¦æ—¶åŒºï¼‰
                if hasattr(london_tz, 'localize'):
                    # pytzæ–¹å¼ï¼ˆä¸´æ—¶ä½¿ç”¨ï¼‰
                    local_dt = london_tz.localize(chat.created_at)
                else:
                    # zoneinfoæ–¹å¼ï¼ˆPython 3.9+ï¼‰
                    local_dt = chat.created_at.replace(tzinfo=london_tz)
                chat.created_at = local_dt.astimezone(timezone.utc)
        
        # åŒæ ·å¤„ç†å…¶ä»–æ—¶é—´å­—æ®µï¼ˆlast_message_at, ended_atç­‰ï¼‰
        # ...
    
    db.commit()
```

### æ—¶é—´å¤„ç†æ£€æŸ¥æ¸…å•

- [ ] æ›¿æ¢æ‰€æœ‰ `get_uk_time()` ä¸º `get_utc_time()`
- [ ] æ›¿æ¢æ‰€æœ‰ `datetime.utcnow()` ä¸º `get_utc_time()`
- [ ] ç§»é™¤æ‰€æœ‰ `pytz.timezone("Europe/London")` çš„ç›´æ¥ä½¿ç”¨ï¼ˆè¿ç§»åˆ°zoneinfoï¼‰
- [ ] è¿ç§»è„šæœ¬ä¸­çš„pytzä½¿ç”¨åº”æ ‡æ³¨ä¸ºä¸´æ—¶ä½¿ç”¨ï¼Œè¿ç§»å®Œæˆååˆ é™¤
- [ ] æ‰€æœ‰æ¨¡å‹é»˜è®¤å€¼æ”¹ä¸º `get_utc_time()`
- [ ] æ‰€æœ‰æ—¶é—´å­—æ®µæ·»åŠ  `timezone=True`
- [ ] æ‰€æœ‰æ—¶é—´è®¡ç®—ç»Ÿä¸€è½¬æ¢ä¸ºUTC
- [ ] å‰ç«¯æ˜¾ç¤ºæ—¶è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºï¼ˆä½¿ç”¨zoneinfoï¼‰
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬è½¬æ¢ç°æœ‰æ•°æ®
- [ ] WebSocketå¿ƒè·³ã€ACKã€æ¶ˆæ¯åç§»é‡æ”¾ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`

---

## å½“å‰å®ç°çŠ¶æ€

### âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®ç°

#### 1. å®¢æœè®¤è¯ç³»ç»Ÿ
- **ä½ç½®**: `backend/app/service_auth.py`
- **åŠŸèƒ½**:
  - ç‹¬ç«‹çš„å®¢æœä¼šè¯ç®¡ç†ç³»ç»Ÿ
  - æ”¯æŒIDæˆ–é‚®ç®±ç™»å½•
  - Cookie-basedä¼šè¯è®¤è¯
  - Refresh Tokenæœºåˆ¶
  - IPå’Œè®¾å¤‡æŒ‡çº¹ç»‘å®š
  - ä¼šè¯æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š2ä¸ªæ´»è·ƒä¼šè¯ï¼‰
  - ä¼šè¯è¿‡æœŸæ—¶é—´ï¼š6å°æ—¶

#### 2. å®¢æœå¯¹è¯åŠŸèƒ½
- **ä½ç½®**: 
  - åç«¯: `backend/app/routers.py` (3238-3750è¡Œ)
  - å‰ç«¯: `frontend/src/pages/CustomerService.tsx`
- **åŠŸèƒ½**:
  - ç”¨æˆ·åˆ†é…å®¢æœï¼ˆéšæœºåˆ†é…åœ¨çº¿å®¢æœï¼‰
  - åˆ›å»º/è·å–å®¢æœå¯¹è¯
  - å®æ—¶æ¶ˆæ¯å‘é€/æ¥æ”¶ï¼ˆWebSocketæ”¯æŒï¼‰
  - å¯¹è¯å†å²è®°å½•
  - ç»“æŸå¯¹è¯åŠŸèƒ½
  - ç”¨æˆ·è¯„åˆ†ç³»ç»Ÿï¼ˆ1-5æ˜Ÿï¼‰
  - æœªè¯»æ¶ˆæ¯è®¡æ•°

#### 3. å®¢æœç®¡ç†åŠŸèƒ½
- **ä½ç½®**: `backend/app/routers.py` (3784-3997è¡Œ)
- **åŠŸèƒ½**:
  - åœ¨çº¿/ç¦»çº¿çŠ¶æ€ç®¡ç†
  - æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„å¯¹è¯åˆ—è¡¨
  - å®¡æ ¸ä»»åŠ¡å–æ¶ˆè¯·æ±‚ï¼ˆå”¯ä¸€ç®¡ç†æƒé™ï¼‰
  - å‘ç®¡ç†å‘˜è¯·æ±‚å¸®åŠ©
  - ä¸ç®¡ç†å‘˜æ²Ÿé€š
  - æŸ¥çœ‹å‘˜å·¥é€šçŸ¥
  - æŸ¥çœ‹è¯„åˆ†å’Œç»Ÿè®¡

#### 4. ç”¨æˆ·ç«¯å®¢æœä¸­å¿ƒ
- **ä½ç½®**: 
  - åç«¯: `backend/app/routers.py` (3692-3750è¡Œ)
  - å‰ç«¯: `frontend/src/pages/Message.tsx` (å®¢æœä¸­å¿ƒéƒ¨åˆ†)
- **åŠŸèƒ½**:
  - ç”¨æˆ·å‘èµ·å®¢æœå¯¹è¯
  - æŸ¥çœ‹å®¢æœå¯¹è¯å†å²
  - å‘é€æ¶ˆæ¯
  - è¯„åˆ†åŠŸèƒ½
  - æŸ¥çœ‹å®¢æœåœ¨çº¿çŠ¶æ€

#### 5. è®¡åˆ’ä»»åŠ¡ï¼ˆå†…éƒ¨ä»»åŠ¡ï¼Œä¸å¯¹å¤–æš´éœ²HTTPç«¯ç‚¹ï¼‰
- **ä½ç½®**: `backend/app/customer_service_tasks.py`ï¼ˆCeleryä»»åŠ¡ï¼‰
- **åŠŸèƒ½**:
  - âš ï¸ **è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯** (`auto_end_timeout_chats`) - ä»…é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸å¯¹å¤–æä¾›HTTPç«¯ç‚¹
  - âš ï¸ **å‘é€è¶…æ—¶é¢„è­¦** (`send_timeout_warnings`) - ä»…é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸å¯¹å¤–æä¾›HTTPç«¯ç‚¹
  - âš ï¸ **æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯** (`cleanup_long_inactive_chats`) - ä»…é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸å¯¹å¤–æä¾›HTTPç«¯ç‚¹
  - âš ï¸ **å¤„ç†å®¢æœé˜Ÿåˆ—** (`process_customer_service_queue`) - ä»…é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸å¯¹å¤–æä¾›HTTPç«¯ç‚¹
- **è§¦å‘æ–¹å¼**: Celery Beatå®šæ—¶ä»»åŠ¡ï¼Œæ¯30ç§’/æ¯å¤©æ‰§è¡Œä¸€æ¬¡
- **å®‰å…¨è¯´æ˜**: è¿™äº›ä»»åŠ¡ä¸åº”æš´éœ²ä¸ºå…¬å¼€HTTPç«¯ç‚¹ï¼Œä»…é€šè¿‡å†…éƒ¨Celeryä»»åŠ¡è°ƒåº¦ç³»ç»Ÿè§¦å‘

---

## å·²å®ç°åŠŸèƒ½

### åç«¯åŠŸèƒ½

#### 1. å®¢æœè®¤è¯ç›¸å…³
```python
# ä¸»è¦ç«¯ç‚¹ï¼ˆç»Ÿä¸€ä½¿ç”¨ /api/customer-service/ å‰ç¼€ï¼‰
POST /api/customer-service/login   # å®¢æœç™»å½•ï¼ˆç»Ÿä¸€ï¼Œæ›¿ä»£ /api/cs/loginï¼‰
POST /api/customer-service/logout  # å®¢æœç™»å‡º
GET  /api/customer-service/status  # è·å–å®¢æœçŠ¶æ€
POST /api/customer-service/online  # è®¾ç½®åœ¨çº¿çŠ¶æ€
POST /api/customer-service/offline # è®¾ç½®ç¦»çº¿çŠ¶æ€
```

#### 2. å®¢æœå¯¹è¯ç›¸å…³
```python
# ç”¨æˆ·ç«¯è·¯ç”±ï¼ˆç»Ÿä¸€ä½¿ç”¨ /api/user/customer-service/ å‰ç¼€ï¼‰
POST /api/user/customer-service/assign  # ç”¨æˆ·åˆ†é…å®¢æœï¼ˆæ›¿ä»£ /api/assign_customer_serviceï¼‰
GET  /api/user/customer-service/chats   # è·å–ç”¨æˆ·å¯¹è¯å†å²ï¼ˆæ›¿ä»£ /api/customer-service/my-chatsï¼‰
GET  /api/user/customer-service/chats/{chat_id}/messages  # è·å–å¯¹è¯æ¶ˆæ¯
POST /api/user/customer-service/chats/{chat_id}/messages  # å‘é€æ¶ˆæ¯
POST /api/user/customer-service/chats/{chat_id}/end  # ç»“æŸå¯¹è¯ï¼ˆæ›¿ä»£ /api/customer-service/end-chatï¼‰
POST /api/user/customer-service/chats/{chat_id}/rate  # ç”¨æˆ·è¯„åˆ†ï¼ˆæ›¿ä»£ /api/customer-service/rate/{chat_id}ï¼‰

# å®¢æœç«¯è·¯ç”±ï¼ˆç»Ÿä¸€ä½¿ç”¨ /api/customer-service/ å‰ç¼€ï¼‰
GET  /api/customer-service/chats  # å®¢æœè·å–å¯¹è¯åˆ—è¡¨
GET  /api/customer-service/chats/{chat_id}/messages  # è·å–å¯¹è¯æ¶ˆæ¯
POST /api/customer-service/chats/{chat_id}/messages  # å‘é€æ¶ˆæ¯
POST /api/customer-service/chats/{chat_id}/end  # ç»“æŸå¯¹è¯
POST /api/customer-service/chats/{chat_id}/timeout-end  # è¶…æ—¶ç»“æŸ
```

#### 3. å®¢æœç®¡ç†ç›¸å…³
```python
GET  /api/customer-service/cancel-requests  # è·å–å–æ¶ˆè¯·æ±‚åˆ—è¡¨
POST /api/customer-service/cancel-requests/{request_id}/review  # å®¡æ ¸å–æ¶ˆè¯·æ±‚
GET  /api/customer-service/admin-requests  # è·å–ç®¡ç†è¯·æ±‚åˆ—è¡¨
POST /api/customer-service/admin-requests  # æäº¤ç®¡ç†è¯·æ±‚
GET  /api/customer-service/admin-chat  # è·å–ç®¡ç†å‘˜èŠå¤©è®°å½•
POST /api/customer-service/admin-chat  # å‘é€æ¶ˆæ¯ç»™ç®¡ç†å‘˜
```

### å‰ç«¯åŠŸèƒ½

#### 1. å®¢æœé¢æ¿ (`CustomerService.tsx`)
- ä»ªè¡¨æ¿ï¼šæ˜¾ç¤ºå®¢æœçŠ¶æ€ã€è¯„åˆ†ã€ç»Ÿè®¡æ•°æ®
- æ¶ˆæ¯ä¸­å¿ƒï¼šç”¨æˆ·ä¼šè¯åˆ—è¡¨ã€å®æ—¶èŠå¤©
- ä»»åŠ¡ç®¡ç†ï¼šæŸ¥çœ‹ä»»åŠ¡ã€æœç´¢ä»»åŠ¡
- å–æ¶ˆè¯·æ±‚å®¡æ ¸ï¼šå®¡æ ¸ä»»åŠ¡å–æ¶ˆè¯·æ±‚
- ç®¡ç†è¯·æ±‚ï¼šå‘ç®¡ç†å‘˜æäº¤è¯·æ±‚
- å‘˜å·¥é€šçŸ¥ï¼šæŸ¥çœ‹ç³»ç»Ÿé€šçŸ¥

#### 2. ç”¨æˆ·ç«¯å®¢æœä¸­å¿ƒ (`Message.tsx`)
- å®¢æœä¸­å¿ƒå…¥å£ï¼šæ˜¾ç¤ºåœ¨çº¿çŠ¶æ€
- å¯¹è¯å†å²ï¼šæŸ¥çœ‹å†å²å¯¹è¯
- å®æ—¶èŠå¤©ï¼šä¸å®¢æœå®æ—¶æ²Ÿé€š
- è¯„åˆ†åŠŸèƒ½ï¼šå¯¹è¯ç»“æŸåè¯„åˆ†

---

## ä¼˜åŒ–å»ºè®®

### ğŸ”§ åŠŸèƒ½ä¼˜åŒ–

#### 1. å®¢æœåˆ†é…ç­–ç•¥ä¼˜åŒ–ï¼ˆå«æ’é˜Ÿç³»ç»Ÿï¼‰

##### âš ï¸ ä¸¥é‡é—®é¢˜ï¼šå¹¶å‘åˆ†é…å¯èƒ½"åŒåˆ†é…"

**é—®é¢˜æè¿°**:
- é˜Ÿåˆ—å¤„ç†ä»»åŠ¡é€æ¡æŸ¥è¯¢â†’é€æ¡ commit()ï¼ˆå·²æ”¹ä¸ºCeleryä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰
- æ²¡æœ‰ä»»ä½•è¡Œçº§é”æˆ–ä¹è§‚å¹¶å‘æ§åˆ¶
- ä¸¤æ¬¡å¹¶å‘æ‰§è¡Œå®¹æ˜“æŠŠåŒä¸€ç”¨æˆ·åˆ†ç»™ä¸¤ä¸ªå®¢æœ

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# âš ï¸ é‡è¦ï¼šæ­¤ä»»åŠ¡åº”é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
# å¦‚æœéœ€è¦ä¸´æ—¶æ‰‹åŠ¨è§¦å‘ï¼Œåº”é€šè¿‡å†…éƒ¨ç®¡ç†æ¥å£ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
def process_customer_service_queue(db: Session):
    """
    å¤„ç†å®¢æœé˜Ÿåˆ— - æ‰¹é‡åˆ†é…ï¼Œå¸¦äº‹åŠ¡å’Œé”ä¿æŠ¤
    é˜²æ­¢å¹¶å‘åˆ†é…å¯¼è‡´"åŒåˆ†é…"
    å†…éƒ¨ä»»åŠ¡ï¼šé€šè¿‡Celeryå®šæ—¶ä»»åŠ¡æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    """
    from sqlalchemy import select, func
    from sqlalchemy.orm import with_for_update
    from app.utils.time_utils import get_utc_time
    
    # å¼€å¯äº‹åŠ¡
    with db.begin():
        # 1. æ‰¹é‡è·å–å¾…åˆ†é…è®°å½•ï¼ˆæŒ‰queued_atå‡åºï¼Œé™åˆ¶æ‰¹é‡å¤§å°ï¼‰
        BATCH_SIZE = 10
        
        waiting_queue = db.query(CustomerServiceQueue).filter(
            CustomerServiceQueue.status == "waiting"
        ).order_by(
            CustomerServiceQueue.queued_at.asc()
        ).with_for_update(skip_locked=True).limit(BATCH_SIZE).all()  # è¡Œçº§é”ï¼Œè·³è¿‡å·²é”å®šçš„è¡Œ
        
        if not waiting_queue:
            return {"message": "No waiting users", "assigned_count": 0}
        
        assigned_count = 0
        
        for queue_entry in waiting_queue:
            # 2. åœ¨äº‹åŠ¡å†…æŸ¥æ‰¾å¯ç”¨å®¢æœï¼ˆå¸¦é”ï¼‰
            available_services = db.query(CustomerService).filter(
                CustomerService.is_online == 1
            ).with_for_update().all()  # é”å®šå®¢æœè®°å½•ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹
            
            if not available_services:
                # æ²¡æœ‰å¯ç”¨å®¢æœï¼Œè·³è¿‡
                continue
            
            # 3. è®¡ç®—æ¯ä¸ªå®¢æœçš„å½“å‰è´Ÿè½½
            service_loads = []
            for service in available_services:
                # ç»Ÿè®¡è¯¥å®¢æœå½“å‰è¿›è¡Œä¸­çš„å¯¹è¯æ•°
                current_chats = db.query(func.count(CustomerServiceChat.id)).filter(
                    CustomerServiceChat.service_id == service.id,
                    CustomerServiceChat.is_ended == 0
                ).scalar()
                
                max_concurrent = service.max_concurrent_chats or 5
                remaining_capacity = max(0, max_concurrent - current_chats)
                
                service_loads.append({
                    "service": service,
                    "current_load": current_chats,
                    "remaining_capacity": remaining_capacity,
                    "avg_rating": service.avg_rating or 0
                })
            
            # 4. é€‰æ‹©è´Ÿè½½æœ€ä½ä¸”æœ‰ä½™é‡çš„å®¢æœ
            available_services_with_capacity = [
                sl for sl in service_loads 
                if sl["remaining_capacity"] > 0
            ]
            
            if not available_services_with_capacity:
                # æ‰€æœ‰å®¢æœéƒ½æ»¡è½½ï¼Œè·³è¿‡
                continue
            
            # æŒ‰å‰©ä½™å®¹é‡å’Œè¯„åˆ†æ’åº
            best_service = max(
                available_services_with_capacity,
                key=lambda x: (x["remaining_capacity"], x["avg_rating"])
            )["service"]
            
            # 5. å†æ¬¡æ£€æŸ¥å®¹é‡ï¼ˆåŒé‡æ£€æŸ¥ï¼Œé˜²æ­¢ç«æ€ï¼‰
            final_load_check = db.query(func.count(CustomerServiceChat.id)).filter(
                CustomerServiceChat.service_id == best_service.id,
                CustomerServiceChat.is_ended == 0
            ).scalar()
            
            max_concurrent = best_service.max_concurrent_chats or 5
            if final_load_check >= max_concurrent:
                # å®¹é‡å·²æ»¡ï¼Œè·³è¿‡
                continue
            
            # 6. åˆ†é…å¯¹è¯ï¼ˆåœ¨åŒä¸€äº‹åŠ¡å†…ï¼‰
            chat = crud.create_customer_service_chat(
                db,
                user_id=queue_entry.user_id,
                service_id=best_service.id
            )
            
            # 7. æ›´æ–°é˜Ÿåˆ—çŠ¶æ€
            queue_entry.status = "assigned"
            queue_entry.assigned_service_id = best_service.id
            queue_entry.assigned_at = get_utc_time()  # ä½¿ç”¨UTCæ—¶é—´
            
            assigned_count += 1
        
        # 8. äº‹åŠ¡è‡ªåŠ¨æäº¤ï¼ˆwith db.begin()ï¼‰
    
    return {
        "message": f"Assigned {assigned_count} users",
        "assigned_count": assigned_count
    }

# æˆ–è€…ä½¿ç”¨ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰æ–¹æ¡ˆ
class CustomerServiceQueue(Base):
    __tablename__ = "customer_service_queue"
    # ... ç°æœ‰å­—æ®µ
    version = Column(Integer, default=0)  # ç‰ˆæœ¬å·ï¼Œç”¨äºä¹è§‚é”

# æˆ–è€…ä½¿ç”¨ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰æ–¹æ¡ˆï¼ˆå†…éƒ¨ä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰
# âš ï¸ é‡è¦ï¼šæ­¤å‡½æ•°ä»…ä½œä¸ºå†…éƒ¨ä»»åŠ¡ä½¿ç”¨ï¼Œä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
# å¿…é¡»é€šè¿‡Celeryä»»åŠ¡è§¦å‘ï¼Œä¸åº”é€šè¿‡HTTPç«¯ç‚¹è°ƒç”¨
# Celeryä»»åŠ¡é…ç½®ç¤ºä¾‹ï¼š
# @celery_app.task(name='process_queue_with_optimistic_lock_task')
# def process_queue_with_optimistic_lock_task():
#     db = get_db()
#     try:
#         process_queue_with_optimistic_lock(db)
#     finally:
#         db.close()
# 
# celery_app.conf.beat_schedule['process-queue-optimistic'] = {
#     'task': 'process_queue_with_optimistic_lock_task',
#     'schedule': 30.0,  # æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
# }
def process_queue_with_optimistic_lock(db: Session):
    """ä½¿ç”¨ä¹è§‚é”å¤„ç†é˜Ÿåˆ—ï¼ˆå†…éƒ¨ä»»åŠ¡ï¼Œä»…Celeryä»»åŠ¡è§¦å‘ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰"""
    waiting_queue = db.query(CustomerServiceQueue).filter(
        CustomerServiceQueue.status == "waiting"
    ).order_by(CustomerServiceQueue.queued_at.asc()).limit(10).all()
    
    for queue_entry in waiting_queue:
        # è¯»å–å½“å‰ç‰ˆæœ¬å·
        current_version = queue_entry.version
        
        # æŸ¥æ‰¾å¯ç”¨å®¢æœï¼ˆä¸é”å®šï¼‰
        available_service = find_available_service(db)
        
        if not available_service:
            continue
        
        # å°è¯•æ›´æ–°ï¼ˆå¸¦ç‰ˆæœ¬å·æ£€æŸ¥ï¼‰
        updated = db.query(CustomerServiceQueue).filter(
            CustomerServiceQueue.id == queue_entry.id,
            CustomerServiceQueue.version == current_version,  # ç‰ˆæœ¬å·å¿…é¡»åŒ¹é…
            CustomerServiceQueue.status == "waiting"  # çŠ¶æ€å¿…é¡»è¿˜æ˜¯waiting
        ).update({
            "status": "assigned",
            "assigned_service_id": available_service.id,
            "assigned_at": get_utc_time(),
            "version": current_version + 1  # ç‰ˆæœ¬å·+1
        })
        
        if updated == 0:
            # æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜è¢«å…¶ä»–è¿›ç¨‹ä¿®æ”¹äº†ï¼Œè·³è¿‡
            continue
        
        # åˆ›å»ºå¯¹è¯
        crud.create_customer_service_chat(
            db, queue_entry.user_id, available_service.id
        )
    
    db.commit()
```

**å…³é”®æ”¹è¿›**:
1. **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡è·å–å¤šæ¡è®°å½•ï¼Œå‡å°‘æŸ¥è¯¢æ¬¡æ•°
2. **è¡Œçº§é”**: `with_for_update(skip_locked=True)` é˜²æ­¢å¹¶å‘ä¿®æ”¹
3. **äº‹åŠ¡ä¿æŠ¤**: æ•´ä¸ªåˆ†é…è¿‡ç¨‹åœ¨äº‹åŠ¡å†…å®Œæˆ
4. **åŒé‡æ£€æŸ¥**: åˆ†é…å‰å†æ¬¡æ£€æŸ¥å®¹é‡ï¼Œé˜²æ­¢ç«æ€
5. **ä¹è§‚é”å¤‡é€‰**: ä½¿ç”¨ç‰ˆæœ¬å·å®ç°ä¹è§‚å¹¶å‘æ§åˆ¶

---
**å½“å‰é—®é¢˜**:
- ä½¿ç”¨ç®€å•çš„éšæœºåˆ†é…ï¼Œå¯èƒ½å¯¼è‡´è´Ÿè½½ä¸å‡è¡¡
- æ²¡æœ‰è€ƒè™‘å®¢æœå½“å‰å¯¹è¯æ•°é‡
- æ²¡æœ‰æœ€å¤§å¹¶å‘å¯¹è¯æ•°é™åˆ¶
- å½“æ‰€æœ‰å®¢æœéƒ½æ»¡è½½æ—¶ï¼Œç”¨æˆ·ç›´æ¥æ”¶åˆ°é”™è¯¯ï¼Œä½“éªŒä¸ä½³
- ç¼ºå°‘æ’é˜Ÿæœºåˆ¶ï¼Œæ— æ³•åœ¨å®¢æœç©ºé—²æ—¶è‡ªåŠ¨åˆ†é…

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# 1. é¦–å…ˆéœ€è¦åœ¨CustomerServiceæ¨¡å‹ä¸­æ·»åŠ æœ€å¤§å¹¶å‘å¯¹è¯æ•°å­—æ®µ
class CustomerService(Base):
    # ... ç°æœ‰å­—æ®µ
    max_concurrent_chats = Column(Integer, default=5)  # æœ€å¤§å¹¶å‘å¯¹è¯æ•°ï¼Œé»˜è®¤5ä¸ª

# 2. åˆ›å»ºæ’é˜Ÿé˜Ÿåˆ—è¡¨
class CustomerServiceQueue(Base):
    __tablename__ = "customer_service_queue"
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String(20), nullable=False)  # ç”¨æˆ·ID
    queued_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ’é˜Ÿæ—¶é—´ï¼ˆUTCï¼‰
    status = Column(String(20), default="waiting")  # waiting, assigned, cancelled
    assigned_service_id = Column(String(20), nullable=True)  # åˆ†é…çš„å®¢æœID
    assigned_at = Column(DateTime(timezone=True), nullable=True)  # åˆ†é…æ—¶é—´ï¼ˆUTCï¼‰

# 3. æ™ºèƒ½åˆ†é…ç®—æ³•ï¼ˆå«æ’é˜Ÿæœºåˆ¶ï¼‰
def assign_customer_service_with_queue(user_id, db):
    """
    æ™ºèƒ½åˆ†é…å®¢æœï¼Œæ”¯æŒæ’é˜Ÿæœºåˆ¶ï¼š
    1. æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„åœ¨çº¿å®¢æœï¼ˆæœªè¾¾åˆ°æœ€å¤§å¹¶å‘æ•°ï¼‰
    2. å¦‚æœæœ‰ï¼Œä¼˜å…ˆåˆ†é…å¯¹è¯æ•°é‡æœ€å°‘çš„å®¢æœ
    3. å¦‚æœæ‰€æœ‰å®¢æœéƒ½æ»¡è½½ï¼Œç”¨æˆ·è¿›å…¥æ’é˜Ÿé˜Ÿåˆ—
    4. å½“æœ‰å®¢æœç©ºé—²æ—¶ï¼Œè‡ªåŠ¨åˆ†é…ç»™æ’é˜Ÿçš„ç”¨æˆ·
    """
    from app.models import CustomerService, CustomerServiceChat, CustomerServiceQueue
    from sqlalchemy import func
    
    # è·å–æ‰€æœ‰åœ¨çº¿å®¢æœ
    online_services = db.query(CustomerService).filter(
        CustomerService.is_online == 1
    ).all()
    
    if not online_services:
        return {
            "status": "no_service",
            "message": get_system_message("no_available_service", language="zh", db=db),  # ä»é…ç½®è¡¨è¯»å–ï¼Œæ”¯æŒå¤šè¯­è¨€
            "system_message": {
                "content": get_system_message("no_available_service_detail", language="zh", db=db)  # ä»é…ç½®è¡¨è¯»å–ï¼Œæ”¯æŒå¤šè¯­è¨€å’Œæ—¶åŒº
            }
        }
    
    # æŸ¥æ‰¾æœ‰å¯ç”¨å®¹é‡çš„å®¢æœ
    available_services = []
    for service in online_services:
        # è·å–å®¢æœå½“å‰è¿›è¡Œä¸­çš„å¯¹è¯æ•°
        active_chats_count = db.query(CustomerServiceChat).filter(
            CustomerServiceChat.service_id == service.id,
            CustomerServiceChat.is_ended == 0
        ).count()
        
        # è·å–æœ€å¤§å¹¶å‘æ•°ï¼ˆå¦‚æœæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼5ï¼‰
        max_chats = service.max_concurrent_chats or 5
        
        # å¦‚æœæœªè¾¾åˆ°æœ€å¤§å¹¶å‘æ•°ï¼ŒåŠ å…¥å¯ç”¨åˆ—è¡¨
        if active_chats_count < max_chats:
            available_services.append({
                "service": service,
                "active_chats": active_chats_count,
                "available_slots": max_chats - active_chats_count,
                "load_score": active_chats_count * 0.6 + (5 - (service.avg_rating or 0)) * 0.4
            })
    
    # å¦‚æœæœ‰å¯ç”¨å®¢æœï¼Œç›´æ¥åˆ†é…
    if available_services:
        # é€‰æ‹©è´Ÿè½½æœ€ä½çš„å®¢æœ
        best_option = min(available_services, key=lambda x: x["load_score"])
        service = best_option["service"]
        
        # åˆ›å»ºå¯¹è¯
        chat_data = crud.create_customer_service_chat(db, user_id, service.id)
        
        return {
            "status": "assigned",
            "service": {
                "id": service.id,
                "name": service.name,
                "avatar": "/static/service.png",
                "avg_rating": service.avg_rating,
                "total_ratings": service.total_ratings,
            },
            "chat": chat_data
        }
    
    # æ‰€æœ‰å®¢æœéƒ½æ»¡è½½ï¼Œç”¨æˆ·è¿›å…¥æ’é˜Ÿé˜Ÿåˆ—
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²åœ¨é˜Ÿåˆ—ä¸­
    existing_queue = db.query(CustomerServiceQueue).filter(
        CustomerServiceQueue.user_id == user_id,
        CustomerServiceQueue.status == "waiting"
    ).first()
    
    if existing_queue:
        # è®¡ç®—æ’é˜Ÿä½ç½®
        queue_position = db.query(CustomerServiceQueue).filter(
            CustomerServiceQueue.status == "waiting",
            CustomerServiceQueue.queued_at <= existing_queue.queued_at
        ).count()
        
        return {
            "status": "queued",
            "queue_position": queue_position,
            "queued_at": existing_queue.queued_at,
            "estimated_wait_time": calculate_estimated_wait_time(queue_position, db),  # åŠ¨æ€è®¡ç®—ï¼Œéçº¿æ€§ï¼ˆè§ä¸‹æ–¹å®ç°ï¼‰
            "message": f"å½“å‰æ‰€æœ‰å®¢æœéƒ½åœ¨å¿™ç¢Œä¸­ï¼Œæ‚¨å·²è¿›å…¥æ’é˜Ÿé˜Ÿåˆ—ï¼Œå½“å‰æ’åœ¨ç¬¬{queue_position}ä½ï¼Œé¢„è®¡ç­‰å¾…æ—¶é—´çº¦{calculate_estimated_wait_time(queue_position, db)}åˆ†é’Ÿã€‚"
        }
    
    # åˆ›å»ºæ–°çš„æ’é˜Ÿè®°å½•
    queue_entry = CustomerServiceQueue(
        user_id=user_id,
        status="waiting"
    )
    db.add(queue_entry)
    db.commit()
    
    # è®¡ç®—æ’é˜Ÿä½ç½®
    queue_position = db.query(CustomerServiceQueue).filter(
        CustomerServiceQueue.status == "waiting",
        CustomerServiceQueue.queued_at <= queue_entry.queued_at
    ).count()
    
    return {
        "status": "queued",
        "queue_position": queue_position,
        "queued_at": queue_entry.queued_at,
        "estimated_wait_time": calculate_estimated_wait_time(queue_position, db),  # åŠ¨æ€è®¡ç®—ï¼Œéçº¿æ€§ï¼ˆè§ä¸‹æ–¹å®ç°ï¼‰
        "message": f"å½“å‰æ‰€æœ‰å®¢æœéƒ½åœ¨å¿™ç¢Œä¸­ï¼Œæ‚¨å·²è¿›å…¥æ’é˜Ÿé˜Ÿåˆ—ï¼Œå½“å‰æ’åœ¨ç¬¬{queue_position}ä½ï¼Œé¢„è®¡ç­‰å¾…æ—¶é—´çº¦{calculate_estimated_wait_time(queue_position, db)}åˆ†é’Ÿã€‚"
    }

# 4. è‡ªåŠ¨åˆ†é…æ’é˜Ÿç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡ï¼ˆå†…éƒ¨ä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰
# âš ï¸ é‡è¦ï¼šæ­¤ä»»åŠ¡åº”é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
# âš ï¸ ä½¿ç”¨äº‹åŠ¡+è¡Œçº§é”ç‰ˆæœ¬ï¼Œé¿å…å¾ªç¯å†…commitå¯¼è‡´çš„åŒåˆ†é…é—®é¢˜
# å®Œæ•´å®ç°è§ä¸Šæ–¹"ä¿®å¤æ–¹æ¡ˆ"ä¸­çš„ process_customer_service_queue å‡½æ•°ï¼ˆå¸¦äº‹åŠ¡å’Œè¡Œçº§é”ï¼‰

# 5. ç”¨æˆ·æŸ¥è¯¢æ’é˜ŸçŠ¶æ€ï¼ˆç”¨æˆ·ç«¯å‘½åç©ºé—´ + çº¯UTC + asyncï¼‰
@router.get("/api/user/customer-service/queue-status")
async def get_queue_status(
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db)
):
    """
    ç”¨æˆ·æŸ¥è¯¢è‡ªå·±çš„æ’é˜ŸçŠ¶æ€
    ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´ï¼Œè¿”å›ISO-8601æ ¼å¼
    """
    from app.models import CustomerServiceQueue
    from app.utils.time_utils import get_utc_time, to_utc
    
    queue_entry = db.query(CustomerServiceQueue).filter(
        CustomerServiceQueue.user_id == current_user.id,
        CustomerServiceQueue.status == "waiting"
    ).first()
    
    if not queue_entry:
        return {
            "status": "not_queued",
            "message": "æ‚¨ä¸åœ¨æ’é˜Ÿé˜Ÿåˆ—ä¸­"
        }
    
    # è®¡ç®—æ’é˜Ÿä½ç½®
    queue_position = db.query(CustomerServiceQueue).filter(
        CustomerServiceQueue.status == "waiting",
        CustomerServiceQueue.queued_at <= queue_entry.queued_at
    ).count()
    
    # è®¡ç®—ç­‰å¾…æ—¶é—´ï¼ˆç»Ÿä¸€ä½¿ç”¨UTCï¼‰
    queued_at_utc = to_utc(queue_entry.queued_at)
    wait_time_minutes = int((get_utc_time() - queued_at_utc).total_seconds() / 60)
    
    # è®¡ç®—é¢„è®¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨ç§»åŠ¨å¹³å‡ï¼Œè§ä¸‹æ–¹å®ç°ï¼‰
    estimated_wait_time = calculate_estimated_wait_time(queue_position, db)
    
    return {
        "status": "queued",
        "queue_position": queue_position,
        "queued_at": queue_entry.queued_at.isoformat() if hasattr(queue_entry.queued_at, 'isoformat') else str(queue_entry.queued_at),  # ISO-8601æ ¼å¼
        "wait_time_minutes": wait_time_minutes,
        "estimated_wait_time": estimated_wait_time  # åˆ†é’Ÿ
    }

# 6. ç”¨æˆ·å–æ¶ˆæ’é˜Ÿï¼ˆç”¨æˆ·ç«¯å‘½åç©ºé—´ + asyncï¼‰
@router.post("/api/user/customer-service/cancel-queue")
async def cancel_queue(
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db)
):
    """
    ç”¨æˆ·å–æ¶ˆæ’é˜Ÿ
    """
    from app.models import CustomerServiceQueue
    
    queue_entry = db.query(CustomerServiceQueue).filter(
        CustomerServiceQueue.user_id == current_user.id,
        CustomerServiceQueue.status == "waiting"
    ).first()
    
    if queue_entry:
        queue_entry.status = "cancelled"
        db.commit()
        return {"message": "å·²å–æ¶ˆæ’é˜Ÿ"}
    
    return {"message": "æ‚¨ä¸åœ¨æ’é˜Ÿé˜Ÿåˆ—ä¸­"}
```

#### 2. å¯¹è¯è¶…æ—¶è‡ªåŠ¨ç»“æŸåŠŸèƒ½ä¼˜åŒ–

##### å½“å‰å®ç°çŠ¶æ€

**å·²å®ç°çš„åŠŸèƒ½**:
1. **è¶…æ—¶æ£€æµ‹API** (`GET /api/customer-service/chat-timeout-status/{chat_id}`)
   - å®¢æœå¯ä»¥æŸ¥è¯¢å¯¹è¯æ˜¯å¦è¶…æ—¶
   - è¶…æ—¶æ ‡å‡†ï¼š**2åˆ†é’Ÿï¼ˆ120ç§’ï¼‰æ— æ¶ˆæ¯æ´»åŠ¨**
   - è¿”å›ä¿¡æ¯åŒ…æ‹¬ï¼š
     - `is_timeout`: æ˜¯å¦å·²è¶…æ—¶
     - `timeout_available`: æ˜¯å¦å¯ä»¥æ‰§è¡Œè¶…æ—¶ç»“æŸæ“ä½œ
     - `time_since_last_message`: è·ç¦»æœ€åä¸€æ¡æ¶ˆæ¯çš„ç§’æ•°

2. **è¶…æ—¶ç»“æŸAPI** (`POST /api/customer-service/timeout-end-chat/{chat_id}`)
   - å®¢æœå¯ä»¥æ‰‹åŠ¨è§¦å‘è¶…æ—¶ç»“æŸå¯¹è¯
   - æ‰§è¡Œæµç¨‹ï¼š
     1. å‘é€ç³»ç»Ÿæ¶ˆæ¯ï¼š"ç”±äºé•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°ä½ çš„ä¿¡æ¯ï¼Œæœ¬æ¬¡å¯¹è¯å·²ç»“æŸ"
     2. ç»“æŸå¯¹è¯ï¼ˆè®¾ç½® `is_ended = 1`ï¼‰
     3. åˆ›å»ºç”¨æˆ·é€šçŸ¥ï¼š"æ‚¨çš„å®¢æœå¯¹è¯å› è¶…æ—¶ï¼ˆ2åˆ†é’Ÿæ— æ´»åŠ¨ï¼‰å·²è‡ªåŠ¨ç»“æŸã€‚å¦‚éœ€ç»§ç»­å’¨è¯¢ï¼Œè¯·é‡æ–°è”ç³»å®¢æœã€‚"
     4. é€šè¿‡WebSocketå®æ—¶é€šçŸ¥ç”¨æˆ·ï¼ˆå¦‚æœç”¨æˆ·åœ¨çº¿ï¼‰

3. **å‰ç«¯å®ç°**:
   - å®¢æœé¢æ¿ä¼šå®šæœŸæ£€æŸ¥å¯¹è¯è¶…æ—¶çŠ¶æ€
   - æ˜¾ç¤ºè¶…æ—¶æŒ‰é’®ï¼Œå®¢æœå¯ä»¥æ‰‹åŠ¨ç»“æŸè¶…æ—¶å¯¹è¯

**å½“å‰é—®é¢˜**:
- âŒ **éœ€è¦å®¢æœæ‰‹åŠ¨è§¦å‘**ï¼Œä¸æ˜¯è‡ªåŠ¨çš„
- âŒ **æ²¡æœ‰è‡ªåŠ¨æ£€æµ‹å’Œç»“æŸçš„å®šæ—¶ä»»åŠ¡**
- âŒ **ç”¨æˆ·ç«¯æ²¡æœ‰è¶…æ—¶æé†’**ï¼Œç”¨æˆ·ä¸çŸ¥é“å¯¹è¯å³å°†è¶…æ—¶
- âŒ **è¶…æ—¶æ—¶é—´å›ºå®šä¸º2åˆ†é’Ÿ**ï¼Œä¸å¯é…ç½®
- âŒ **æ²¡æœ‰åŒºåˆ†ç”¨æˆ·æ— æ´»åŠ¨ vs å®¢æœæ— æ´»åŠ¨**çš„ä¸åŒå¤„ç†
- âŒ **æ²¡æœ‰è¶…æ—¶å‰çš„è­¦å‘Šæœºåˆ¶**ï¼ˆå¦‚1åˆ†é’Ÿåæé†’ï¼‰
- âŒ **é•¿æ—¶é—´æ— æ´»åŠ¨çš„å¯¹è¯**ï¼ˆå¦‚7å¤©ï¼‰æ²¡æœ‰è‡ªåŠ¨æ¸…ç†

**ç”¨æˆ·è¡Œä¸ºåˆ†æ**:
- ç”¨æˆ·è¿æ¥å®¢æœåï¼Œå¦‚æœ**2åˆ†é’Ÿå†…æ²¡æœ‰å‘é€ä»»ä½•æ¶ˆæ¯**ï¼Œå¯¹è¯ä¼šè¢«æ ‡è®°ä¸ºè¶…æ—¶
- å®¢æœå¯ä»¥æ‰‹åŠ¨ç‚¹å‡»"è¶…æ—¶ç»“æŸ"æŒ‰é’®æ¥ç»“æŸå¯¹è¯
- ç”¨æˆ·ä¼šæ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯å’Œé€šçŸ¥ï¼Œå‘ŠçŸ¥å¯¹è¯å·²ç»“æŸ
- å¦‚æœç”¨æˆ·åœ¨çº¿ï¼Œä¼šé€šè¿‡WebSocketå®æ—¶æ”¶åˆ°è¶…æ—¶æ¶ˆæ¯

##### ä¼˜åŒ–æ–¹æ¡ˆ

```python
# 1. æ·»åŠ å¯é…ç½®çš„è¶…æ—¶æ—¶é—´è®¾ç½®
class CustomerServiceSettings(Base):
    __tablename__ = "customer_service_settings"
    id = Column(Integer, primary_key=True)
    timeout_minutes = Column(Integer, default=2)  # é»˜è®¤2åˆ†é’Ÿ
    warning_minutes = Column(Integer, default=1)  # è­¦å‘Šæ—¶é—´ï¼š1åˆ†é’Ÿ
    auto_end_enabled = Column(Integer, default=1)  # æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç»“æŸ
    long_inactive_days = Column(Integer, default=7)  # é•¿æœŸæ— æ´»åŠ¨å¤©æ•°

# 2. è‡ªåŠ¨æ£€æµ‹å’Œç»“æŸè¶…æ—¶å¯¹è¯çš„å®šæ—¶ä»»åŠ¡ï¼ˆå†…éƒ¨ä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰
# âš ï¸ é‡è¦ï¼šæ­¤ä»»åŠ¡åº”é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
def auto_end_timeout_chats(db: Session):
    """
    è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯
    å†…éƒ¨ä»»åŠ¡ï¼šé€šè¿‡Celeryå®šæ—¶ä»»åŠ¡æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    """
    from app.models import CustomerServiceChat, CustomerServiceSettings
    from datetime import timedelta
    
    # è·å–è¶…æ—¶é…ç½®ï¼ˆé»˜è®¤2åˆ†é’Ÿï¼‰
    settings = db.query(CustomerServiceSettings).first()
    timeout_minutes = settings.timeout_minutes if settings else 2
    auto_end_enabled = settings.auto_end_enabled if settings and settings.auto_end_enabled == 1 else 1
    
    if not auto_end_enabled:
        return {"message": "è‡ªåŠ¨ç»“æŸåŠŸèƒ½å·²ç¦ç”¨", "ended_count": 0}
    
    from app.utils.time_utils import get_utc_time
    current_time_utc = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    timeout_threshold = current_time_utc - timedelta(minutes=timeout_minutes)
    
    # æŸ¥æ‰¾æ‰€æœ‰è¶…æ—¶çš„æœªç»“æŸå¯¹è¯
    timeout_chats = db.query(CustomerServiceChat).filter(
        CustomerServiceChat.is_ended == 0,
        CustomerServiceChat.last_message_at < timeout_threshold
    ).all()
    
    ended_count = 0
    
    for chat in timeout_chats:
        try:
            # å‘é€ç³»ç»Ÿæ¶ˆæ¯
            crud.save_customer_service_message(
                db=db,
                chat_id=chat.chat_id,
                sender_id="system",
                sender_type="system",
                content="ç”±äºé•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°ä½ çš„ä¿¡æ¯ï¼Œæœ¬æ¬¡å¯¹è¯å·²è‡ªåŠ¨ç»“æŸ"
            )
            
            # ç»“æŸå¯¹è¯ï¼ˆè®°å½•ç»“æŸåŸå› ï¼‰
            timeout_type = get_chat_timeout_type(chat.chat_id, db)
            crud.end_customer_service_chat(
                db, 
                chat.chat_id,
                reason="timeout",
                ended_by="system",
                ended_type=timeout_type  # user_inactive æˆ– service_inactive
            )
            
            # åˆ›å»ºç”¨æˆ·é€šçŸ¥
            crud.create_notification(
                db=db,
                user_id=chat.user_id,
                type="chat_timeout",
                title="å¯¹è¯è¶…æ—¶ç»“æŸ",
                content=f"æ‚¨çš„å®¢æœå¯¹è¯å› è¶…æ—¶ï¼ˆ{timeout_minutes}åˆ†é’Ÿæ— æ´»åŠ¨ï¼‰å·²è‡ªåŠ¨ç»“æŸã€‚å¦‚éœ€ç»§ç»­å’¨è¯¢ï¼Œè¯·é‡æ–°è”ç³»å®¢æœã€‚",
                related_id=chat.chat_id,
            )
            
            # WebSocketé€šçŸ¥ï¼ˆå¼‚æ­¥ï¼‰
            # notify_user_timeout(chat.user_id, chat.chat_id)
            
            ended_count += 1
            logger.info(f"è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯: {chat.chat_id}")
        except Exception as e:
            logger.error(f"è‡ªåŠ¨ç»“æŸå¯¹è¯å¤±è´¥ {chat.chat_id}: {e}")
    
    return {
        "ended_count": ended_count,
        "message": f"å·²è‡ªåŠ¨ç»“æŸ{ended_count}ä¸ªè¶…æ—¶å¯¹è¯"
    }

# 3. è¶…æ—¶å‰è­¦å‘Šæœºåˆ¶ï¼ˆå†…éƒ¨ä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰
# âš ï¸ é‡è¦ï¼šæ­¤ä»»åŠ¡åº”é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
def send_timeout_warnings(db: Session):
    """
    å‘é€è¶…æ—¶è­¦å‘Šï¼ˆåœ¨è¶…æ—¶å‰1åˆ†é’Ÿæé†’ï¼‰
    å†…éƒ¨ä»»åŠ¡ï¼šé€šè¿‡Celeryå®šæ—¶ä»»åŠ¡æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    """
    from app.models import CustomerServiceChat, CustomerServiceSettings
    from datetime import timedelta
    
    settings = db.query(CustomerServiceSettings).first()
    timeout_minutes = settings.timeout_minutes if settings else 2
    warning_minutes = settings.warning_minutes if settings else 1
    
    # ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´
    from app.utils.time_utils import get_utc_time
    current_time_utc = get_utc_time()
    
    # è®¡ç®—è­¦å‘Šæ—¶é—´çª—å£ï¼šè·ç¦»è¶…æ—¶è¿˜æœ‰warning_minutesåˆ†é’Ÿ
    warning_start = current_time_utc - timedelta(minutes=timeout_minutes - warning_minutes)
    warning_end = current_time_utc - timedelta(minutes=timeout_minutes)
    
    # æŸ¥æ‰¾éœ€è¦è­¦å‘Šçš„å¯¹è¯
    warning_chats = db.query(CustomerServiceChat).filter(
        CustomerServiceChat.is_ended == 0,
        CustomerServiceChat.last_message_at >= warning_start,
        CustomerServiceChat.last_message_at < warning_end
    ).all()
    
    warned_count = 0
    
    for chat in warning_chats:
        # æ£€æŸ¥æ˜¯å¦å·²ç»å‘é€è¿‡è­¦å‘Šï¼ˆé¿å…é‡å¤ï¼‰
        # å¯ä»¥é€šè¿‡åœ¨æ¶ˆæ¯è¡¨ä¸­æŸ¥è¯¢æœ€è¿‘æ˜¯å¦æœ‰è­¦å‘Šæ¶ˆæ¯
        
        # å‘é€è­¦å‘Šæ¶ˆæ¯
        crud.save_customer_service_message(
            db=db,
            chat_id=chat.chat_id,
            sender_id="system",
            sender_type="system",
            content=f"æç¤ºï¼šå¦‚æœ{timeout_minutes - warning_minutes}åˆ†é’Ÿå†…æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œå¯¹è¯å°†è‡ªåŠ¨ç»“æŸ"
        )
        
        # é€šè¿‡WebSocketé€šçŸ¥ç”¨æˆ·
        # notify_user_warning(chat.user_id, chat.chat_id, warning_minutes)
        
        warned_count += 1
    
    return {
        "warned_count": warned_count,
        "message": f"å·²å‘é€{warned_count}ä¸ªè¶…æ—¶è­¦å‘Š"
    }

# 4. æ¸…ç†é•¿æœŸæ— æ´»åŠ¨çš„å¯¹è¯ï¼ˆå†…éƒ¨ä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰
# âš ï¸ é‡è¦ï¼šæ­¤ä»»åŠ¡åº”é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
def cleanup_long_inactive_chats(db: Session):
    """
    æ¸…ç†é•¿æœŸæ— æ´»åŠ¨çš„å¯¹è¯ï¼ˆå¦‚7å¤©ï¼‰
    å†…éƒ¨ä»»åŠ¡ï¼šé€šè¿‡Celeryå®šæ—¶ä»»åŠ¡æ¯å¤©æ‰§è¡Œä¸€æ¬¡
    """
    from app.models import CustomerServiceChat, CustomerServiceSettings
    from datetime import timedelta
    
    settings = db.query(CustomerServiceSettings).first()
    long_inactive_days = settings.long_inactive_days if settings else 7
    
    from app.utils.time_utils import get_utc_time
    current_time_utc = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    cutoff_time = current_time_utc - timedelta(days=long_inactive_days)
    
    inactive_chats = db.query(CustomerServiceChat).filter(
        CustomerServiceChat.is_ended == 0,
        CustomerServiceChat.last_message_at < cutoff_time
    ).all()
    
    ended_count = 0
    
    for chat in inactive_chats:
        try:
            # å‘é€ç³»ç»Ÿæ¶ˆæ¯
            crud.save_customer_service_message(
                db=db,
                chat_id=chat.chat_id,
                sender_id="system",
                sender_type="system",
                content=f"ç”±äº{long_inactive_days}å¤©æ— æ´»åŠ¨ï¼Œæœ¬æ¬¡å¯¹è¯å·²è‡ªåŠ¨ç»“æŸ"
            )
            
            # ç»“æŸå¯¹è¯ï¼ˆè®°å½•ç»“æŸåŸå› ï¼‰
            timeout_type = get_chat_timeout_type(chat.chat_id, db)
            crud.end_customer_service_chat(
                db, 
                chat.chat_id,
                reason="auto_cleanup",
                ended_by="system",
                ended_type=timeout_type  # user_inactive æˆ– service_inactive
            )
            
            ended_count += 1
        except Exception as e:
            logger.error(f"æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯å¤±è´¥ {chat.chat_id}: {e}")
    
    return {
        "ended_count": ended_count,
        "message": f"å·²æ¸…ç†{ended_count}ä¸ªé•¿æœŸæ— æ´»åŠ¨å¯¹è¯"
    }

# 5. åŒºåˆ†ç”¨æˆ·æ— æ´»åŠ¨ vs å®¢æœæ— æ´»åŠ¨çš„å¤„ç†
def get_chat_timeout_type(chat_id: str, db: Session) -> str:
    """
    åˆ¤æ–­è¶…æ—¶ç±»å‹ï¼š
    - 'user_inactive': ç”¨æˆ·æ— æ´»åŠ¨ï¼ˆæœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å®¢æœå‘çš„ï¼‰
    - 'service_inactive': å®¢æœæ— æ´»åŠ¨ï¼ˆæœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ç”¨æˆ·å‘çš„ï¼‰
    """
    from app.models import CustomerServiceMessage
    
    last_message = db.query(CustomerServiceMessage).filter(
        CustomerServiceMessage.chat_id == chat_id
    ).order_by(CustomerServiceMessage.created_at.desc()).first()
    
    if not last_message:
        return "unknown"
    
    if last_message.sender_type == "customer_service":
        return "user_inactive"  # ç”¨æˆ·æ— æ´»åŠ¨
    elif last_message.sender_type == "user":
        return "service_inactive"  # å®¢æœæ— æ´»åŠ¨
    
    return "unknown"

# 6. ç”¨æˆ·ç«¯è¶…æ—¶æé†’ï¼ˆå‰ç«¯å®ç°ï¼‰
"""
å‰ç«¯åº”è¯¥ï¼š
1. åœ¨ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼Œå¯åŠ¨å€’è®¡æ—¶
2. å½“è·ç¦»è¶…æ—¶è¿˜æœ‰1åˆ†é’Ÿæ—¶ï¼Œæ˜¾ç¤ºè­¦å‘Šæç¤º
3. å½“è¶…æ—¶æ—¶ï¼Œæ˜¾ç¤ºå¯¹è¯å·²ç»“æŸçš„æç¤º
4. æä¾›é‡æ–°è¿æ¥å®¢æœçš„æŒ‰é’®
"""
```

#### 3. ç”¨æˆ·ç«¯å®¢æœèŠå¤©æ¡†ä¼˜åŒ–

##### å½“å‰å®ç°çŠ¶æ€

**å·²å®ç°çš„åŠŸèƒ½**:
1. **åŸºç¡€æ¶ˆæ¯åŠŸèƒ½**
   - æ”¯æŒå‘é€æ–‡æœ¬æ¶ˆæ¯
   - æ”¯æŒå‘é€å›¾ç‰‡ï¼ˆé€šè¿‡å›¾ç‰‡ä¸Šä¼ ï¼‰
   - æ”¯æŒè¡¨æƒ…ç¬¦å·è¾“å…¥
   - å®æ—¶æ¶ˆæ¯æ¥æ”¶ï¼ˆWebSocketï¼‰

2. **æ¶ˆæ¯æ˜¾ç¤º**
   - æ˜¾ç¤ºæ¶ˆæ¯æ—¶é—´ï¼ˆè‹±å›½æ—¶é—´ï¼‰
   - åŒºåˆ†ç”¨æˆ·æ¶ˆæ¯å’Œå®¢æœæ¶ˆæ¯
   - æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯

**å½“å‰é—®é¢˜**:
- âŒ **ä¸æ”¯æŒå‘é€ä»»åŠ¡ç›¸å…³ä¿¡æ¯**ï¼šç”¨æˆ·æ— æ³•åœ¨å®¢æœå¯¹è¯ä¸­åˆ†äº«è‡ªå·±çš„ä»»åŠ¡
- âŒ **æ²¡æœ‰ä»»åŠ¡å¿«æ·æ“ä½œ**ï¼šæ— æ³•å¿«é€Ÿå¼•ç”¨ä»»åŠ¡ã€æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
- âŒ **æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½**ï¼šåªèƒ½å‘é€å›¾ç‰‡ï¼Œä¸èƒ½å‘é€å…¶ä»–æ–‡ä»¶
- âŒ **æ²¡æœ‰æ¶ˆæ¯å¼•ç”¨åŠŸèƒ½**ï¼šæ— æ³•å¼•ç”¨ä¹‹å‰çš„æ¶ˆæ¯
- âŒ **æ²¡æœ‰å¿«æ·å›å¤**ï¼šæ²¡æœ‰å¸¸ç”¨é—®é¢˜å¿«æ·å›å¤æŒ‰é’®

**ç”¨æˆ·éœ€æ±‚åˆ†æ**:
- ç”¨æˆ·åœ¨å’¨è¯¢ä»»åŠ¡ç›¸å…³é—®é¢˜æ—¶ï¼Œå¸Œæœ›èƒ½å¤Ÿç›´æ¥åˆ†äº«ä»»åŠ¡ç»™å®¢æœ
- ç”¨æˆ·å¸Œæœ›èƒ½å¤Ÿå¿«é€ŸæŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…ï¼Œæ— éœ€æ‰‹åŠ¨å¤åˆ¶ä»»åŠ¡ID
- ç”¨æˆ·å¸Œæœ›èƒ½å¤Ÿå‘é€ä»»åŠ¡æˆªå›¾æˆ–ç›¸å…³æ–‡ä»¶

##### ä¼˜åŒ–æ–¹æ¡ˆ

```typescript
// 1. æ·»åŠ ä»»åŠ¡åˆ†äº«åŠŸèƒ½
interface TaskShareCard {
  task_id: number;
  task_title: string;
  task_status: string;
  task_image?: string;
  poster_name?: string;
  taker_name?: string;
}

// åœ¨æ¶ˆæ¯è¾“å…¥æ¡†ä¸­æ·»åŠ "åˆ†äº«ä»»åŠ¡"æŒ‰é’®
const TaskShareButton: React.FC = ({ onTaskSelect }) => {
  const [showTaskList, setShowTaskList] = useState(false);
  const [userTasks, setUserTasks] = useState([]);
  
  const handleShareTask = (task: Task) => {
    const taskCard: TaskShareCard = {
      task_id: task.id,
      task_title: task.title,
      task_status: task.status,
      task_image: task.images?.[0],
      poster_name: task.poster_name,
      taker_name: task.taker_name
    };
    
    // å‘é€ä»»åŠ¡å¡ç‰‡æ¶ˆæ¯
    sendMessage(JSON.stringify({
      type: 'task_share',
      content: taskCard
    }));
  };
  
  return (
    <div>
      <button onClick={() => setShowTaskList(true)}>
        ğŸ“‹ åˆ†äº«ä»»åŠ¡
      </button>
      {showTaskList && (
        <TaskSelector
          tasks={userTasks}
          onSelect={handleShareTask}
          onClose={() => setShowTaskList(false)}
        />
      )}
    </div>
  );
};

// 2. æ¶ˆæ¯æ˜¾ç¤ºä¸­æ¸²æŸ“ä»»åŠ¡å¡ç‰‡
const TaskCardMessage: React.FC<{ taskCard: TaskShareCard }> = ({ taskCard }) => {
  return (
    <div className="task-card-message">
      <img src={taskCard.task_image} alt={taskCard.task_title} />
      <div>
        <h4>{taskCard.task_title}</h4>
        <p>çŠ¶æ€: {taskCard.task_status}</p>
        <button onClick={() => openTaskDetail(taskCard.task_id)}>
          æŸ¥çœ‹è¯¦æƒ…
        </button>
      </div>
    </div>
  );
};

// 3. åç«¯æ”¯æŒä»»åŠ¡å¡ç‰‡æ¶ˆæ¯
@router.post("/customer-service/chat/{chat_id}/send-message")
def send_customer_service_chat_message(
    chat_id: str,
    message_data: SendMessagePayload,  # ä½¿ç”¨Pydanticæ¨¡å‹æ›¿ä»£dictï¼ˆè§"æœ€é«˜ä¼˜å…ˆçº§é—®é¢˜ -> 11. èŠå¤©æ¶ˆæ¯çŠ¶æ€"ç« èŠ‚ï¼‰
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db),
):
    """ç”¨æˆ·å‘é€æ¶ˆæ¯åˆ°å®¢æœå¯¹è¯ï¼Œæ”¯æŒä»»åŠ¡åˆ†äº«ï¼ˆå¼ºç±»å‹æ ¡éªŒï¼‰"""
    content = message_data.content  # Pydanticæ¨¡å‹ç›´æ¥è®¿é—®å±æ€§
    message_type = message_data.type  # ä½¿ç”¨æšä¸¾ç±»å‹
    
    if message_type == MessageType.TASK_SHARE:
        # éªŒè¯ä»»åŠ¡æ˜¯å¦å±äºå½“å‰ç”¨æˆ·
        task_id = message_data.task_id  # Pydanticæ¨¡å‹ç›´æ¥è®¿é—®å±æ€§
        task = crud.get_task(db, task_id)
        
        if not task:
            raise HTTPException(status_code=404, detail="Task not found")
        
        # éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™åˆ†äº«æ­¤ä»»åŠ¡
        if task.poster_id != current_user.id and task.taker_id != current_user.id:
            raise HTTPException(status_code=403, detail="Not authorized to share this task")
        
        # ä¿å­˜ä»»åŠ¡åˆ†äº«æ¶ˆæ¯
        message = crud.save_customer_service_message(
            db, chat_id, current_user.id, "user", 
            content=json.dumps({
                "type": "task_share",
                "task_id": task_id,
                "task_title": task.title,
                "task_status": task.status
            })
        )
    else:
        # æ™®é€šæ–‡æœ¬æ¶ˆæ¯
        message = crud.save_customer_service_message(
            db, chat_id, current_user.id, "user", content
        )
    
    return message
```

#### 4. å®¢æœä¸ç®¡ç†å‘˜å¯¹è¯ç³»ç»Ÿä¼˜åŒ–

##### å½“å‰å®ç°çŠ¶æ€

**å·²å®ç°çš„åŠŸèƒ½**:
1. **åŸºç¡€å¯¹è¯åŠŸèƒ½**
   - å®¢æœå¯ä»¥å‘é€æ¶ˆæ¯ç»™ç®¡ç†å‘˜
   - ç®¡ç†å‘˜å¯ä»¥å‘é€æ¶ˆæ¯ç»™å®¢æœ
   - æ‰€æœ‰æ¶ˆæ¯å­˜å‚¨åœ¨ `AdminChatMessage` è¡¨ä¸­
   - æ”¯æŒæŸ¥çœ‹å†å²èŠå¤©è®°å½•

2. **APIç«¯ç‚¹**:
   - `GET /api/customer-service/admin-chat` - å®¢æœè·å–èŠå¤©è®°å½•
   - `POST /api/customer-service/admin-chat` - å®¢æœå‘é€æ¶ˆæ¯
   - `GET /api/admin/customer-service-chat` - ç®¡ç†å‘˜è·å–èŠå¤©è®°å½•
   - `POST /api/admin/customer-service-chat` - ç®¡ç†å‘˜å‘é€æ¶ˆæ¯

**å½“å‰é—®é¢˜**:
- âŒ **å…¨å±€èŠå¤©å®¤è®¾è®¡**ï¼šæ‰€æœ‰å®¢æœå’Œç®¡ç†å‘˜å…±äº«åŒä¸€ä¸ªèŠå¤©å®¤ï¼Œæ¶ˆæ¯æ··ä¹±
- âŒ **æ²¡æœ‰ç§èŠåŠŸèƒ½**ï¼šæ— æ³•è¿›è¡Œä¸€å¯¹ä¸€ç§èŠ
- âŒ **æ²¡æœ‰å®æ—¶é€šçŸ¥**ï¼šæ–°æ¶ˆæ¯æ²¡æœ‰å®æ—¶æ¨é€
- âŒ **æ²¡æœ‰æ¶ˆæ¯å·²è¯»çŠ¶æ€**ï¼šä¸çŸ¥é“æ¶ˆæ¯æ˜¯å¦è¢«è¯»å–
- âŒ **æ²¡æœ‰æ¶ˆæ¯åˆ†ç±»**ï¼šæ— æ³•åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼ˆç´§æ€¥ã€æ™®é€šç­‰ï¼‰
- âŒ **æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ **ï¼šåªèƒ½å‘é€æ–‡æœ¬æ¶ˆæ¯
- âŒ **æ²¡æœ‰æ¶ˆæ¯æœç´¢**ï¼šæ— æ³•æœç´¢å†å²æ¶ˆæ¯
- âŒ **æ²¡æœ‰@æåŠåŠŸèƒ½**ï¼šæ— æ³•@ç‰¹å®šç®¡ç†å‘˜æˆ–å®¢æœ

##### ä¼˜åŒ–æ–¹æ¡ˆ

```python
# 1. æ”¹è¿›æ•°æ®æ¨¡å‹ï¼Œæ”¯æŒç§èŠå’Œæ¶ˆæ¯çŠ¶æ€
class AdminChatMessage(Base):
    __tablename__ = "admin_chat_messages"
    id = Column(Integer, primary_key=True, index=True)
    sender_id = Column(String(8), nullable=True)
    sender_type = Column(String(20), nullable=False)  # customer_service, admin
    receiver_id = Column(String(8), nullable=True)  # æ¥æ”¶è€…IDï¼ˆæ”¯æŒç§èŠï¼‰
    receiver_type = Column(String(20), nullable=True)  # æ¥æ”¶è€…ç±»å‹
    content = Column(Text, nullable=False)
    message_type = Column(String(20), default="text")  # text, file, task_reference
    is_read = Column(Integer, default=0)  # 0: æœªè¯», 1: å·²è¯»
    priority = Column(String(20), default="normal")  # normal, urgent, important
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # ç»Ÿä¸€ä½¿ç”¨UTC
    read_at = Column(DateTime(timezone=True), nullable=True)  # å·²è¯»æ—¶é—´ï¼ˆUTCï¼‰

# 2. æ”¯æŒç§èŠå’Œç¾¤èŠ
@router.post("/customer-service/admin-chat")
def send_admin_chat_message(
    message_data: schemas.AdminChatMessageCreate,
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
):
    """
    å®¢æœå‘é€æ¶ˆæ¯ç»™ç®¡ç†å‘˜
    æ”¯æŒç§èŠï¼ˆæŒ‡å®šreceiver_idï¼‰æˆ–ç¾¤èŠï¼ˆreceiver_idä¸ºNoneï¼‰
    """
    from app.models import AdminChatMessage
    
    chat_message = AdminChatMessage(
        sender_id=current_user.id,
        sender_type="customer_service",
        receiver_id=message_data.receiver_id,  # Noneè¡¨ç¤ºç¾¤èŠ
        receiver_type=message_data.receiver_type,
        content=message_data.content,
        message_type=message_data.message_type or "text",
        priority=message_data.priority or "normal"
    )
    db.add(chat_message)
    db.commit()
    
    # é€šè¿‡WebSocketé€šçŸ¥ç®¡ç†å‘˜
    # notify_admin_new_message(chat_message)
    
    return chat_message

# 3. æ¶ˆæ¯å·²è¯»çŠ¶æ€
@router.post("/customer-service/admin-chat/{message_id}/mark-read")
def mark_admin_chat_message_read(
    message_id: int,
    current_user=Depends(get_current_service_or_admin),
    db: Session = Depends(get_db),
):
    """æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»"""
    from app.models import AdminChatMessage
    
    message = db.query(AdminChatMessage).filter(
        AdminChatMessage.id == message_id
    ).first()
    
    if not message:
        raise HTTPException(status_code=404, detail="Message not found")
    
    # æ£€æŸ¥æƒé™
    if message.receiver_id and message.receiver_id != current_user.id:
        raise HTTPException(status_code=403, detail="Not authorized")
    
    message.is_read = 1
    from app.utils.time_utils import get_utc_time
    message.read_at = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    db.commit()
    
    return {"message": "Message marked as read"}

# 4. è·å–æœªè¯»æ¶ˆæ¯æ•°
@router.get("/customer-service/admin-chat/unread-count")
def get_admin_chat_unread_count(
    current_user=Depends(get_current_service_or_admin),
    db: Session = Depends(get_db),
):
    """è·å–æœªè¯»æ¶ˆæ¯æ•°é‡"""
    from app.models import AdminChatMessage
    
    unread_count = db.query(AdminChatMessage).filter(
        or_(
            AdminChatMessage.receiver_id == current_user.id,
            AdminChatMessage.receiver_id.is_(None)  # ç¾¤èŠæ¶ˆæ¯
        ),
        AdminChatMessage.sender_id != current_user.id,
        AdminChatMessage.is_read == 0
    ).count()
    
    return {"unread_count": unread_count}
```

#### 5. å®¢æœå‘ç®¡ç†å‘˜å‘é€ç”³è¯·ä¼˜åŒ–

##### å½“å‰å®ç°çŠ¶æ€

**å·²å®ç°çš„åŠŸèƒ½**:
1. **ç”³è¯·æäº¤åŠŸèƒ½**
   - å®¢æœå¯ä»¥æäº¤ç®¡ç†è¯·æ±‚
   - æ”¯æŒè¯·æ±‚ç±»å‹ï¼š`task_status`, `user_ban`, `feedback`, `other`
   - æ”¯æŒä¼˜å…ˆçº§ï¼š`low`, `medium`, `high`
   - çŠ¶æ€æµè½¬ï¼š`pending` â†’ `processing` â†’ `completed`/`rejected`

2. **ç”³è¯·æŸ¥çœ‹åŠŸèƒ½**
   - å®¢æœå¯ä»¥æŸ¥çœ‹è‡ªå·±æäº¤çš„ç”³è¯·åˆ—è¡¨
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”³è¯·
   - æ”¯æŒæŒ‰çŠ¶æ€å’Œä¼˜å…ˆçº§ç­›é€‰

3. **ç”³è¯·å¤„ç†åŠŸèƒ½**
   - ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ç”³è¯·çŠ¶æ€
   - ç®¡ç†å‘˜å¯ä»¥æ·»åŠ å›å¤

**å½“å‰é—®é¢˜**:
- âŒ **æ²¡æœ‰é™„ä»¶æ”¯æŒ**ï¼šæ— æ³•ä¸Šä¼ ç›¸å…³æ–‡ä»¶æˆ–æˆªå›¾
- âŒ **æ²¡æœ‰å…³è”åŠŸèƒ½**ï¼šæ— æ³•å…³è”ä»»åŠ¡æˆ–ç”¨æˆ·
- âŒ **æ²¡æœ‰æ¨¡æ¿åŠŸèƒ½**ï¼šæ¯æ¬¡éƒ½è¦æ‰‹åŠ¨è¾“å…¥ï¼Œæ²¡æœ‰å¸¸ç”¨æ¨¡æ¿
- âŒ **æ²¡æœ‰ç´§æ€¥æ ‡è®°**ï¼šæ— æ³•æ ‡è®°ç´§æ€¥ç”³è¯·
- âŒ **æ²¡æœ‰å¤„ç†æ—¶é™**ï¼šæ²¡æœ‰ç”³è¯·å¤„ç†æ—¶é™æé†’
- âŒ **æ²¡æœ‰ç”³è¯·è¯¦æƒ…é¡µ**ï¼šæ— æ³•æŸ¥çœ‹å®Œæ•´çš„ç”³è¯·è¯¦æƒ…å’Œå¯¹è¯å†å²
- âŒ **æ²¡æœ‰æ‰¹é‡æ“ä½œ**ï¼šæ— æ³•æ‰¹é‡å¤„ç†ç”³è¯·

##### ä¼˜åŒ–æ–¹æ¡ˆ

```python
# 1. æ‰©å±•AdminRequestæ¨¡å‹
class AdminRequest(Base):
    __tablename__ = "admin_requests"
    id = Column(Integer, primary_key=True, index=True)
    requester_id = Column(String(8), ForeignKey("customer_service.id"))
    type = Column(String(50), nullable=False)
    title = Column(String(200), nullable=False)
    description = Column(Text, nullable=False)
    priority = Column(String(20), default="medium")
    status = Column(String(20), default="pending")
    admin_response = Column(Text, nullable=True)
    admin_id = Column(String(5), ForeignKey("admin_users.id"), nullable=True)
    
    # æ–°å¢å­—æ®µ
    related_task_id = Column(Integer, nullable=True)  # å…³è”ä»»åŠ¡ID
    related_user_id = Column(String(20), nullable=True)  # å…³è”ç”¨æˆ·ID
    attachments = Column(JSON, nullable=True)  # é™„ä»¶åˆ—è¡¨
    is_urgent = Column(Integer, default=0)  # æ˜¯å¦ç´§æ€¥
    deadline = Column(DateTime(timezone=True), nullable=True)  # å¤„ç†æ—¶é™ï¼ˆUTCï¼‰
    template_id = Column(Integer, nullable=True)  # ä½¿ç”¨çš„æ¨¡æ¿ID
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # ç»Ÿä¸€ä½¿ç”¨UTC
    updated_at = Column(DateTime(timezone=True), nullable=True)  # ç»Ÿä¸€ä½¿ç”¨UTC

# 2. æ”¯æŒé™„ä»¶ä¸Šä¼ ï¼ˆå”¯ä¸€æ­£ç¡®å®ç°ï¼Œä¿®å¤File(...)å’Œfile.sizeé—®é¢˜ï¼‰
# âš ï¸ é‡è¦ï¼šè¿™æ˜¯æ–‡ä»¶ä¸Šä¼ çš„å”¯ä¸€æ­£ç¡®å®ç°ï¼Œæ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æ¥å£å¿…é¡»ä½¿ç”¨æ­¤æ¨¡å¼
# ä¸¥ç¦ä½¿ç”¨ file.sizeï¼ˆUploadFileæ²¡æœ‰sizeå±æ€§ï¼‰ï¼Œå¿…é¡»é€šè¿‡æµå¼è¯»å–è®¡ç®—å¤§å°
@router.post("/api/customer-service/admin-requests/{request_id}/attachments")
async def upload_request_attachment(
    request_id: int,
    file: UploadFile = File(...),  # ä¿®æ­£ï¼šFile(...) ä¸æ˜¯ File(.)
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
):
    """ä¸Šä¼ ç”³è¯·é™„ä»¶ - å¸¦å®Œæ•´å®‰å…¨æ£€æŸ¥"""
    # 1. éªŒè¯ç”³è¯·æƒé™
    request = db.query(AdminRequest).filter(
        AdminRequest.id == request_id,
        AdminRequest.requester_id == current_user.id
    ).first()
    
    if not request:
        raise HTTPException(status_code=404, detail="Request not found")
    
    # 2. é™åˆ¶æ–‡ä»¶ç±»å‹å’Œå¤§å°
    MAX_SIZE = 10 * 1024 * 1024  # 10MB
    ALLOWED_TYPES = {"image/png", "image/jpeg", "image/gif", "application/pdf"}
    
    if file.content_type not in ALLOWED_TYPES:
        raise HTTPException(status_code=415, detail="Unsupported file type")
    
    # 3. æµå¼è¯»å–å¹¶è®¡ç®—å¤§å°ï¼ˆUploadFileæ²¡æœ‰sizeå±æ€§ï¼‰
    content = await file.read()
    file_size = len(content)
    
    if file_size > MAX_SIZE:
        raise HTTPException(status_code=413, detail=f"File too large, max {MAX_SIZE / 1024 / 1024}MB")
    
    # é‡ç½®æ–‡ä»¶æŒ‡é’ˆ
    await file.seek(0)
    
    # 4. ä¿å­˜æ–‡ä»¶ï¼ˆå®ç°save_chat_fileç±»ä¼¼é€»è¾‘ï¼‰
    file_id = await save_request_attachment(file, request_id, current_user.id)
    
    # 5. æ›´æ–°ç”³è¯·çš„attachmentså­—æ®µ
    if not request.attachments:
        request.attachments = []
    
    request.attachments.append({
        "file_id": file_id,
        "filename": file.filename,
        "content_type": file.content_type,
        "size": file_size,  # ä½¿ç”¨å®é™…è¯»å–çš„å¤§å°
        "uploaded_at": get_utc_time().isoformat()
    })
    db.commit()
    
    return {"file_id": file_id, "size": file_size}

# 3. ç”³è¯·æ¨¡æ¿åŠŸèƒ½
class RequestTemplate(Base):
    __tablename__ = "request_templates"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    type = Column(String(50), nullable=False)
    title_template = Column(String(200), nullable=False)
    description_template = Column(Text, nullable=False)
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # ç»Ÿä¸€ä½¿ç”¨UTC

# 4. ç”³è¯·è¯¦æƒ…é¡µAPI
@router.get("/customer-service/admin-requests/{request_id}/detail")
def get_admin_request_detail(
    request_id: int,
    current_user=Depends(get_current_service_or_admin),
    db: Session = Depends(get_db),
):
    """è·å–ç”³è¯·è¯¦æƒ…ï¼ŒåŒ…æ‹¬å…³è”ä¿¡æ¯å’Œå¯¹è¯å†å²"""
    request = db.query(AdminRequest).filter(
        AdminRequest.id == request_id
    ).first()
    
    if not request:
        raise HTTPException(status_code=404, detail="Request not found")
    
    # è·å–å…³è”ä»»åŠ¡ä¿¡æ¯
    related_task = None
    if request.related_task_id:
        related_task = crud.get_task(db, request.related_task_id)
    
    # è·å–å…³è”ç”¨æˆ·ä¿¡æ¯
    related_user = None
    if request.related_user_id:
        related_user = crud.get_user_by_id(db, request.related_user_id)
    
    # è·å–å¯¹è¯å†å²ï¼ˆå¦‚æœæœ‰ï¼‰
    # chat_history = get_request_chat_history(request_id)
    
    return {
        "request": request,
        "related_task": related_task,
        "related_user": related_user,
        # "chat_history": chat_history
    }
```

#### 6. å®¢æœå–æ¶ˆå®¡æ ¸åŠŸèƒ½ä¼˜åŒ–

##### å½“å‰å®ç°çŠ¶æ€

**å·²å®ç°çš„åŠŸèƒ½**:
1. **å®¡æ ¸åˆ—è¡¨åŠŸèƒ½**
   - å®¢æœå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡å–æ¶ˆè¯·æ±‚
   - æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ã€è¯·æ±‚åŸå› 
   - æ˜¾ç¤ºç”¨æˆ·è§’è‰²ï¼ˆå‘å¸ƒè€…/æ¥æ”¶è€…ï¼‰

2. **å®¡æ ¸åŠŸèƒ½**
   - å®¢æœå¯ä»¥å®¡æ ¸é€šè¿‡æˆ–æ‹’ç»å–æ¶ˆè¯·æ±‚
   - å¯ä»¥æ·»åŠ å®¡æ ¸å¤‡æ³¨
   - å®¡æ ¸é€šè¿‡åè‡ªåŠ¨å–æ¶ˆä»»åŠ¡
   - å‘é€é€šçŸ¥ç»™ç›¸å…³ç”¨æˆ·

3. **APIç«¯ç‚¹**:
   - `GET /api/customer-service/cancel-requests` - è·å–å–æ¶ˆè¯·æ±‚åˆ—è¡¨
   - `POST /api/customer-service/cancel-requests/{request_id}/review` - å®¡æ ¸å–æ¶ˆè¯·æ±‚

**å½“å‰é—®é¢˜**:
- âŒ **æ²¡æœ‰ç­›é€‰å’Œæœç´¢åŠŸèƒ½**ï¼šæ— æ³•æŒ‰ä»»åŠ¡ã€ç”¨æˆ·ã€çŠ¶æ€ç­›é€‰
- âŒ **æ²¡æœ‰æ‰¹é‡æ“ä½œ**ï¼šæ— æ³•æ‰¹é‡å®¡æ ¸
- âŒ **æ²¡æœ‰å®¡æ ¸å†å²**ï¼šæ— æ³•æŸ¥çœ‹å®¡æ ¸å†å²è®°å½•
- âŒ **æ²¡æœ‰ä¼˜å…ˆçº§æ’åº**ï¼šæ— æ³•æŒ‰ç´§æ€¥ç¨‹åº¦æ’åº
- âŒ **æ²¡æœ‰ä»»åŠ¡è¯¦æƒ…å¿«é€ŸæŸ¥çœ‹**ï¼šéœ€è¦è·³è½¬åˆ°å…¶ä»–é¡µé¢æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
- âŒ **æ²¡æœ‰ç»Ÿè®¡åŠŸèƒ½**ï¼šæ— æ³•æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡ä¿¡æ¯

##### ä¼˜åŒ–æ–¹æ¡ˆ

```python
# 1. å¢å¼ºç­›é€‰å’Œæœç´¢åŠŸèƒ½
@router.get("/customer-service/cancel-requests")
def cs_get_cancel_requests(
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
    status: str = None,
    task_id: int = None,
    user_id: str = None,
    search: str = None,  # æœç´¢ä»»åŠ¡æ ‡é¢˜æˆ–ç”¨æˆ·åç§°
    page: int = 1,
    limit: int = 20,
):
    """è·å–ä»»åŠ¡å–æ¶ˆè¯·æ±‚åˆ—è¡¨ï¼Œæ”¯æŒç­›é€‰å’Œæœç´¢"""
    from app.models import TaskCancelRequest, Task, User
    from sqlalchemy import or_
    
    query = db.query(TaskCancelRequest)
    
    # çŠ¶æ€ç­›é€‰
    if status:
        query = query.filter(TaskCancelRequest.status == status)
    
    # ä»»åŠ¡ç­›é€‰
    if task_id:
        query = query.filter(TaskCancelRequest.task_id == task_id)
    
    # ç”¨æˆ·ç­›é€‰
    if user_id:
        query = query.filter(TaskCancelRequest.requester_id == user_id)
    
    # æœç´¢åŠŸèƒ½
    if search:
        # é€šè¿‡å…³è”æŸ¥è¯¢æœç´¢ä»»åŠ¡æ ‡é¢˜æˆ–ç”¨æˆ·åç§°
        query = query.join(Task).join(User).filter(
            or_(
                Task.title.ilike(f"%{search}%"),
                User.name.ilike(f"%{search}%")
            )
        )
    
    # åˆ†é¡µ
    total = query.count()
    requests = query.order_by(
        TaskCancelRequest.created_at.desc()
    ).offset((page - 1) * limit).limit(limit).all()
    
    # æ„å»ºè¿”å›æ•°æ®
    result = []
    for req in requests:
        task = crud.get_task(db, req.task_id)
        requester = crud.get_user_by_id(db, req.requester_id)
        
        result.append({
            "id": req.id,
            "task_id": req.task_id,
            "task_title": task.title if task else "ä»»åŠ¡å·²åˆ é™¤",
            "requester_id": req.requester_id,
            "requester_name": requester.name if requester else "æœªçŸ¥ç”¨æˆ·",
            "reason": req.reason,
            "status": req.status,
            "created_at": req.created_at,
            "reviewed_at": req.reviewed_at,
            "reviewer_id": req.service_id or req.admin_id,
            "reviewer_type": "service" if req.service_id else "admin",
            "review_comment": req.admin_comment
        })
    
    return {
        "requests": result,
        "total": total,
        "page": page,
        "limit": limit
    }

# 2. æ‰¹é‡å®¡æ ¸åŠŸèƒ½
@router.post("/customer-service/cancel-requests/batch-review")
def batch_review_cancel_requests(
    request_ids: list[int],
    review: schemas.TaskCancelRequestReview,
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
):
    """æ‰¹é‡å®¡æ ¸å–æ¶ˆè¯·æ±‚"""
    results = []
    
    for request_id in request_ids:
        try:
            # è°ƒç”¨å•ä¸ªå®¡æ ¸é€»è¾‘
            result = cs_review_cancel_request(
                request_id, review, current_user, db
            )
            results.append({"request_id": request_id, "status": "success"})
        except Exception as e:
            results.append({
                "request_id": request_id, 
                "status": "failed", 
                "error": str(e)
            })
    
    return {"results": results}

# 3. å®¡æ ¸ç»Ÿè®¡åŠŸèƒ½
@router.get("/customer-service/cancel-requests/stats")
def get_cancel_requests_stats(
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
    start_date: str = None,
    end_date: str = None,
):
    """è·å–å–æ¶ˆè¯·æ±‚å®¡æ ¸ç»Ÿè®¡"""
    from sqlalchemy import func
    from app.models import TaskCancelRequest
    
    query = db.query(TaskCancelRequest)
    
    if start_date:
        query = query.filter(TaskCancelRequest.created_at >= start_date)
    if end_date:
        query = query.filter(TaskCancelRequest.created_at <= end_date)
    
    total = query.count()
    pending = query.filter(TaskCancelRequest.status == "pending").count()
    approved = query.filter(TaskCancelRequest.status == "approved").count()
    rejected = query.filter(TaskCancelRequest.status == "rejected").count()
    
    # æˆ‘çš„å®¡æ ¸ç»Ÿè®¡
    my_reviews = query.filter(
        TaskCancelRequest.service_id == current_user.id
    ).count()
    
    return {
        "total": total,
        "pending": pending,
        "approved": approved,
        "rejected": rejected,
        "my_reviews": my_reviews,
        "approval_rate": approved / total * 100 if total > 0 else 0
    }
```

#### 7. å®¢æœé¡µé¢ç”¨æˆ·å¯¹è¯åŠŸèƒ½ä¼˜åŒ–

##### å½“å‰å®ç°çŠ¶æ€

**å·²å®ç°çš„åŠŸèƒ½**:
1. **åŸºç¡€å¯¹è¯åŠŸèƒ½**
   - å®¢æœå¯ä»¥æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„ç”¨æˆ·ä¼šè¯åˆ—è¡¨
   - æ˜¾ç¤ºä¼šè¯çŠ¶æ€ï¼ˆè¿›è¡Œä¸­/å·²ç»“æŸï¼‰
   - æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°é‡
   - æ”¯æŒé€‰æ‹©ä¼šè¯å¹¶æŸ¥çœ‹æ¶ˆæ¯å†å²
   - æ”¯æŒå‘é€æ–‡æœ¬æ¶ˆæ¯ç»™ç”¨æˆ·
   - å®æ—¶æ¶ˆæ¯æ¥æ”¶ï¼ˆWebSocketï¼‰

2. **ç•Œé¢åŠŸèƒ½**
   - å·¦ä¾§ä¼šè¯åˆ—è¡¨ï¼Œå³ä¾§èŠå¤©çª—å£
   - åŒºåˆ†è¿›è¡Œä¸­å’Œå·²ç»“æŸçš„å¯¹è¯
   - æ˜¾ç¤ºç”¨æˆ·å¤´åƒã€å§“åã€å¯¹è¯ID
   - æ˜¾ç¤ºæ¶ˆæ¯æ—¶é—´ï¼ˆè‹±å›½æ—¶é—´ï¼‰
   - æ”¯æŒè¶…æ—¶ç»“æŸå¯¹è¯åŠŸèƒ½

**å½“å‰é—®é¢˜**:
- âŒ **æ²¡æœ‰å¿«æ·å›å¤åŠŸèƒ½**ï¼šå®¢æœéœ€è¦æ‰‹åŠ¨è¾“å…¥æ‰€æœ‰å›å¤å†…å®¹
- âŒ **æ²¡æœ‰å¸¸ç”¨æ¨¡æ¿**ï¼šæ— æ³•ä½¿ç”¨é¢„è®¾çš„å›å¤æ¨¡æ¿
- âŒ **æ²¡æœ‰å…³é”®è¯è‡ªåŠ¨å¡«å……**ï¼šæ— æ³•é€šè¿‡è¾“å…¥å…³é”®è¯å¿«é€Ÿç”Ÿæˆå›å¤
- âŒ **æ²¡æœ‰æ¶ˆæ¯åˆ†ç±»æ ‡ç­¾**ï¼šæ— æ³•å¿«é€Ÿè¯†åˆ«é—®é¢˜ç±»å‹
- âŒ **æ²¡æœ‰å¸¸ç”¨é—®é¢˜åº“**ï¼šæ— æ³•å¿«é€ŸæŸ¥æ‰¾å¸¸è§é—®é¢˜çš„æ ‡å‡†å›å¤
- âŒ **æ²¡æœ‰æ™ºèƒ½æç¤º**ï¼šè¾“å…¥æ—¶æ²¡æœ‰è‡ªåŠ¨è¡¥å…¨æˆ–å»ºè®®
- âŒ **æ²¡æœ‰å¿«æ·æ“ä½œ**ï¼šæ— æ³•å¿«é€Ÿæ’å…¥ç”¨æˆ·ä¿¡æ¯ã€ä»»åŠ¡ä¿¡æ¯ç­‰
- âŒ **æ²¡æœ‰æ¶ˆæ¯è‰ç¨¿**ï¼šè¾“å…¥çš„å†…å®¹å¦‚æœæœªå‘é€ï¼Œåˆ·æ–°åä¼šä¸¢å¤±
- âŒ **æ²¡æœ‰è¡¨æƒ…ç¬¦å·å¿«æ·é€‰æ‹©**ï¼šåªèƒ½æ‰‹åŠ¨è¾“å…¥è¡¨æƒ…

**å®¢æœå·¥ä½œåœºæ™¯åˆ†æ**:
- å®¢æœéœ€è¦é¢‘ç¹å›å¤ç›¸ä¼¼çš„é—®é¢˜ï¼ˆå¦‚è´¦æˆ·é—®é¢˜ã€ä»»åŠ¡é—®é¢˜ã€æ”¯ä»˜é—®é¢˜ç­‰ï¼‰
- å®¢æœéœ€è¦å¿«é€Ÿå“åº”ï¼Œæé«˜å·¥ä½œæ•ˆç‡
- å®¢æœéœ€è¦ä¿æŒå›å¤çš„ä¸“ä¸šæ€§å’Œä¸€è‡´æ€§
- å®¢æœéœ€è¦èƒ½å¤Ÿå¿«é€Ÿå¼•ç”¨ç”¨æˆ·ä¿¡æ¯ã€ä»»åŠ¡ä¿¡æ¯ç­‰

##### ä¼˜åŒ–æ–¹æ¡ˆ

```typescript
// 1. å¿«æ·å›å¤ç»„ä»¶
interface QuickReply {
  id: string;
  category: string;  // åˆ†ç±»ï¼šgreeting, account, task, payment, complaint, other
  keyword: string;   // å…³é”®è¯ï¼šå¦‚"è´¦æˆ·"ã€"ä»»åŠ¡"ã€"æ”¯ä»˜"
  title: string;     // æ ‡é¢˜ï¼šå¦‚"è´¦æˆ·é—®é¢˜å›å¤"
  content: string;    // å›å¤å†…å®¹æ¨¡æ¿
  variables?: string[];  // å¯æ›¿æ¢å˜é‡ï¼šå¦‚{user_name}, {task_title}
}

// å¿«æ·å›å¤æ•°æ®ç¤ºä¾‹
const quickReplies: QuickReply[] = [
  {
    id: '1',
    category: 'greeting',
    keyword: 'é—®å€™',
    title: 'æ¬¢è¿è¯­',
    content: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯LinkUå®¢æœï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ'
  },
  {
    id: '2',
    category: 'account',
    keyword: 'è´¦æˆ·',
    title: 'è´¦æˆ·é—®é¢˜å›å¤',
    content: 'æ‚¨å¥½ï¼Œå…³äºæ‚¨çš„è´¦æˆ·é—®é¢˜ï¼Œæˆ‘å·²ç»äº†è§£ã€‚æˆ‘ä»¬ä¼šå°½å¿«ä¸ºæ‚¨å¤„ç†ï¼Œé¢„è®¡åœ¨24å°æ—¶å†…ç»™æ‚¨å›å¤ã€‚'
  },
  {
    id: '3',
    category: 'task',
    keyword: 'ä»»åŠ¡',
    title: 'ä»»åŠ¡é—®é¢˜å›å¤',
    content: 'æ‚¨å¥½ï¼Œå…³äºä»»åŠ¡"{task_title}"çš„é—®é¢˜ï¼Œæˆ‘å·²ç»è®°å½•ã€‚æˆ‘ä»¬ä¼šå°½å¿«æ ¸å®å¹¶å¤„ç†ã€‚'
  },
  {
    id: '4',
    category: 'payment',
    keyword: 'æ”¯ä»˜',
    title: 'æ”¯ä»˜é—®é¢˜å›å¤',
    content: 'æ‚¨å¥½ï¼Œå…³äºæ”¯ä»˜é—®é¢˜ï¼Œè¯·æ‚¨æä¾›è®¢å•å·æˆ–ä»»åŠ¡IDï¼Œæˆ‘ä»¬ä¼šå°½å¿«ä¸ºæ‚¨æ ¸å®ã€‚'
  }
];

// 2. å¿«æ·å›å¤é€‰æ‹©å™¨ç»„ä»¶
const QuickReplySelector: React.FC<{
  onSelect: (reply: QuickReply) => void;
  currentUser?: any;
  currentTask?: any;
}> = ({ onSelect, currentUser, currentTask }) => {
  const [searchKeyword, setSearchKeyword] = useState('');
  const [selectedCategory, setSelectedCategory] = useState<string>('all');
  
  // æ ¹æ®å…³é”®è¯æœç´¢å¿«æ·å›å¤
  const filteredReplies = quickReplies.filter(reply => {
    const matchKeyword = !searchKeyword || 
      reply.keyword.includes(searchKeyword) || 
      reply.title.includes(searchKeyword) ||
      reply.content.includes(searchKeyword);
    const matchCategory = selectedCategory === 'all' || reply.category === selectedCategory;
    return matchKeyword && matchCategory;
  });
  
  // æ›¿æ¢æ¨¡æ¿å˜é‡
  const processTemplate = (template: string, user?: any, task?: any): string => {
    let result = template;
    if (user) {
      result = result.replace(/{user_name}/g, user.name || 'ç”¨æˆ·');
      result = result.replace(/{user_id}/g, user.id || '');
    }
    if (task) {
      result = result.replace(/{task_title}/g, task.title || 'ä»»åŠ¡');
      result = result.replace(/{task_id}/g, task.id || '');
    }
    return result;
  };
  
  return (
    <div className="quick-reply-selector">
      <div className="selector-header">
        <input
          type="text"
          placeholder="è¾“å…¥å…³é”®è¯æœç´¢å¿«æ·å›å¤..."
          value={searchKeyword}
          onChange={(e) => setSearchKeyword(e.target.value)}
          style={{ width: '100%', padding: '8px', marginBottom: '8px' }}
        />
        <div className="category-filter">
          {['all', 'greeting', 'account', 'task', 'payment', 'complaint'].map(cat => (
            <button
              key={cat}
              onClick={() => setSelectedCategory(cat)}
              className={selectedCategory === cat ? 'active' : ''}
            >
              {cat === 'all' ? 'å…¨éƒ¨' : 
               cat === 'greeting' ? 'é—®å€™' :
               cat === 'account' ? 'è´¦æˆ·' :
               cat === 'task' ? 'ä»»åŠ¡' :
               cat === 'payment' ? 'æ”¯ä»˜' : 'æŠ•è¯‰'}
            </button>
          ))}
        </div>
      </div>
      <div className="reply-list">
        {filteredReplies.map(reply => (
          <div
            key={reply.id}
            className="reply-item"
            onClick={() => {
              const processedContent = processTemplate(reply.content, currentUser, currentTask);
              onSelect({ ...reply, content: processedContent });
            }}
          >
            <div className="reply-title">{reply.title}</div>
            <div className="reply-preview">{reply.content.substring(0, 50)}...</div>
            <div className="reply-keyword">å…³é”®è¯: {reply.keyword}</div>
          </div>
        ))}
      </div>
    </div>
  );
};

// 3. å…³é”®è¯è‡ªåŠ¨å¡«å……åŠŸèƒ½
const KeywordAutoFill: React.FC<{
  input: string;
  onSelect: (content: string) => void;
}> = ({ input, onSelect }) => {
  const [suggestions, setSuggestions] = useState<QuickReply[]>([]);
  
  useEffect(() => {
    if (input.length > 0) {
      // æ ¹æ®è¾“å…¥çš„å…³é”®è¯åŒ¹é…å¿«æ·å›å¤
      const matched = quickReplies.filter(reply => 
        reply.keyword.includes(input) || 
        reply.content.includes(input)
      );
      setSuggestions(matched.slice(0, 5)); // æœ€å¤šæ˜¾ç¤º5ä¸ªå»ºè®®
    } else {
      setSuggestions([]);
    }
  }, [input]);
  
  if (suggestions.length === 0) return null;
  
  return (
    <div className="keyword-suggestions">
      {suggestions.map(reply => (
        <div
          key={reply.id}
          className="suggestion-item"
          onClick={() => onSelect(reply.content)}
        >
          <span className="suggestion-keyword">{reply.keyword}</span>
          <span className="suggestion-content">{reply.title}</span>
        </div>
      ))}
    </div>
  );
};

// 4. å¢å¼ºçš„æ¶ˆæ¯è¾“å…¥æ¡†
const EnhancedMessageInput: React.FC<{
  value: string;
  onChange: (value: string) => void;
  onSend: () => void;
  currentUser?: any;
  currentTask?: any;
  disabled?: boolean;
}> = ({ value, onChange, onSend, currentUser, currentTask, disabled }) => {
  const [showQuickReply, setShowQuickReply] = useState(false);
  const [showVariables, setShowVariables] = useState(false);
  
  // å¿«æ·æ’å…¥å˜é‡
  const insertVariable = (variable: string) => {
    const variableMap: Record<string, string> = {
      'user_name': currentUser?.name || 'ç”¨æˆ·',
      'user_id': currentUser?.id || '',
      'task_title': currentTask?.title || 'ä»»åŠ¡',
      'task_id': currentTask?.id || '',
      'current_time': new Date().toLocaleString('zh-CN')
    };
    
    const replacement = variableMap[variable] || `{${variable}}`;
    onChange(value + replacement);
  };
  
  return (
    <div className="enhanced-message-input">
      {/* å·¥å…·æ  */}
      <div className="input-toolbar">
        <button
          onClick={() => setShowQuickReply(!showQuickReply)}
          title="å¿«æ·å›å¤"
        >
          âš¡ å¿«æ·å›å¤
        </button>
        <button
          onClick={() => setShowVariables(!showVariables)}
          title="æ’å…¥å˜é‡"
        >
          ğŸ“ æ’å…¥å˜é‡
        </button>
        <button title="è¡¨æƒ…ç¬¦å·">ğŸ˜Š</button>
      </div>
      
      {/* å¿«æ·å›å¤é¢æ¿ */}
      {showQuickReply && (
        <QuickReplySelector
          onSelect={(reply) => {
            onChange(reply.content);
            setShowQuickReply(false);
          }}
          currentUser={currentUser}
          currentTask={currentTask}
        />
      )}
      
      {/* å˜é‡é€‰æ‹©é¢æ¿ */}
      {showVariables && (
        <div className="variables-panel">
          <div className="variable-item" onClick={() => insertVariable('user_name')}>
            ç”¨æˆ·å: {currentUser?.name || 'æœªé€‰æ‹©'}
          </div>
          <div className="variable-item" onClick={() => insertVariable('user_id')}>
            ç”¨æˆ·ID: {currentUser?.id || 'æœªé€‰æ‹©'}
          </div>
          {currentTask && (
            <>
              <div className="variable-item" onClick={() => insertVariable('task_title')}>
                ä»»åŠ¡æ ‡é¢˜: {currentTask.title}
              </div>
              <div className="variable-item" onClick={() => insertVariable('task_id')}>
                ä»»åŠ¡ID: {currentTask.id}
              </div>
            </>
          )}
          <div className="variable-item" onClick={() => insertVariable('current_time')}>
            å½“å‰æ—¶é—´
          </div>
        </div>
      )}
      
      {/* å…³é”®è¯è‡ªåŠ¨å¡«å……æç¤º */}
      <KeywordAutoFill
        input={value}
        onSelect={(content) => onChange(content)}
      />
      
      {/* è¾“å…¥æ¡† */}
      <textarea
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆè¾“å…¥å…³é”®è¯å¯å¿«é€Ÿé€‰æ‹©å›å¤æ¨¡æ¿ï¼‰"
        disabled={disabled}
        rows={3}
      />
      
      {/* å‘é€æŒ‰é’® */}
      <button onClick={onSend} disabled={!value.trim() || disabled}>
        å‘é€
      </button>
    </div>
  );
};

// 5. åç«¯API - ç®¡ç†å¿«æ·å›å¤æ¨¡æ¿
@router.get("/customer-service/quick-replies")
def get_quick_replies(
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
    category: str = None,
    keyword: str = None,
):
    """è·å–å¿«æ·å›å¤æ¨¡æ¿åˆ—è¡¨"""
    from app.models import QuickReplyTemplate
    
    query = db.query(QuickReplyTemplate)
    
    if category:
        query = query.filter(QuickReplyTemplate.category == category)
    if keyword:
        query = query.filter(
            or_(
                QuickReplyTemplate.keyword.ilike(f"%{keyword}%"),
                QuickReplyTemplate.title.ilike(f"%{keyword}%"),
                QuickReplyTemplate.content.ilike(f"%{keyword}%")
            )
        )
    
    replies = query.order_by(QuickReplyTemplate.category, QuickReplyTemplate.keyword).all()
    
    return [
        {
            "id": reply.id,
            "category": reply.category,
            "keyword": reply.keyword,
            "title": reply.title,
            "content": reply.content,
            "variables": json.loads(reply.variables) if reply.variables else []
        }
        for reply in replies
    ]

@router.post("/customer-service/quick-replies")
def create_quick_reply(
    reply_data: schemas.QuickReplyCreate,
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
):
    """åˆ›å»ºå¿«æ·å›å¤æ¨¡æ¿"""
    from app.models import QuickReplyTemplate
    
    reply = QuickReplyTemplate(
        category=reply_data.category,
        keyword=reply_data.keyword,
        title=reply_data.title,
        content=reply_data.content,
        variables=json.dumps(reply_data.variables) if reply_data.variables else None,
        created_by=current_user.id
    )
    
    db.add(reply)
    db.commit()
    db.refresh(reply)
    
    return reply

# 6. æ•°æ®æ¨¡å‹
class QuickReplyTemplate(Base):
    __tablename__ = "quick_reply_templates"
    id = Column(Integer, primary_key=True, index=True)
    category = Column(String(50), nullable=False)  # greeting, account, task, payment, complaint, other
    keyword = Column(String(50), nullable=False)  # å…³é”®è¯
    title = Column(String(200), nullable=False)  # æ ‡é¢˜
    content = Column(Text, nullable=False)  # å›å¤å†…å®¹æ¨¡æ¿
    variables = Column(JSON, nullable=True)  # å¯æ›¿æ¢å˜é‡åˆ—è¡¨
    created_by = Column(String(20), nullable=False)  # åˆ›å»ºè€…ID
    usage_count = Column(Integer, default=0)  # ä½¿ç”¨æ¬¡æ•°
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # ç»Ÿä¸€ä½¿ç”¨UTC
    updated_at = Column(DateTime(timezone=True), nullable=True)  # ç»Ÿä¸€ä½¿ç”¨UTC
```

#### 8. æ¶ˆæ¯å·²è¯»çŠ¶æ€ä¼˜åŒ–
**å½“å‰é—®é¢˜**:
- ç”¨æˆ·ç«¯æ¶ˆæ¯å·²è¯»çŠ¶æ€å¯èƒ½ä¸å‡†ç¡®
- å®¢æœç«¯æœªè¯»æ¶ˆæ¯è®¡æ•°å¯èƒ½å»¶è¿Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# å»ºè®®æ·»åŠ å®æ—¶å·²è¯»çŠ¶æ€åŒæ­¥
@router.post("/customer-service/chat/{chat_id}/mark-read")
def mark_customer_service_messages_read(
    chat_id: str,
    current_user=Depends(get_current_customer_service_or_user),
    db: Session = Depends(get_db)
):
    """
    æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»ï¼Œæ”¯æŒå®æ—¶WebSocketé€šçŸ¥
    """
    # æ›´æ–°å·²è¯»çŠ¶æ€
    # é€šè¿‡WebSocketé€šçŸ¥å¯¹æ–¹æ¶ˆæ¯å·²è¯»
    pass
```

#### 4. å®¢æœå·¥ä½œè´Ÿè½½ç»Ÿè®¡
**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
@router.get("/customer-service/workload-stats")
def get_workload_stats(
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db)
):
    """
    è·å–å®¢æœå·¥ä½œè´Ÿè½½ç»Ÿè®¡ï¼š
    - å½“å‰è¿›è¡Œä¸­å¯¹è¯æ•°
    - ä»Šæ—¥å¤„ç†å¯¹è¯æ•°
    - å¹³å‡å“åº”æ—¶é—´
    - ä»Šæ—¥æ¶ˆæ¯æ•°
    """
    pass
```

#### 5. å®¢æœæŠ€èƒ½æ ‡ç­¾ç³»ç»Ÿ
**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# åœ¨CustomerServiceæ¨¡å‹ä¸­æ·»åŠ æŠ€èƒ½æ ‡ç­¾
class CustomerService(Base):
    # ... ç°æœ‰å­—æ®µ
    skill_tags = Column(JSON, nullable=True)  # æŠ€èƒ½æ ‡ç­¾ï¼š["ä»»åŠ¡å–æ¶ˆ", "è´¦æˆ·é—®é¢˜", "æ”¯ä»˜é—®é¢˜"]
    max_concurrent_chats = Column(Integer, default=5)  # æœ€å¤§å¹¶å‘å¯¹è¯æ•°
```

#### 6. å¯¹è¯è½¬æ¥åŠŸèƒ½
**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
@router.post("/customer-service/chat/{chat_id}/transfer")
def transfer_chat(
    chat_id: str,
    target_service_id: str,
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db)
):
    """
    å°†å¯¹è¯è½¬æ¥ç»™å…¶ä»–å®¢æœ
    """
    pass
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### é—®é¢˜ï¼šå¯¹è¯åˆ—è¡¨æŸ¥è¯¢å¯èƒ½è¾ƒæ…¢
**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# å½“å‰å®ç°
def get_service_customer_service_chats(db, service_id):
    # åˆ†åˆ«æŸ¥è¯¢è¿›è¡Œä¸­å’Œå·²ç»“æŸçš„å¯¹è¯
    active_chats = db.query(CustomerServiceChat).filter(...).all()
    ended_chats = db.query(CustomerServiceChat).filter(...).limit(50).all()
    return active_chats + ended_chats

# ä¼˜åŒ–å»ºè®®ï¼šä½¿ç”¨è”åˆæŸ¥è¯¢å’Œç´¢å¼•
# 1. ä¸ºservice_id, is_ended, last_message_atæ·»åŠ å¤åˆç´¢å¼•
# 2. ä½¿ç”¨union_allä¼˜åŒ–æŸ¥è¯¢
```

#### é—®é¢˜ï¼šæ¶ˆæ¯å†å²æŸ¥è¯¢æ€§èƒ½
**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# å»ºè®®æ·»åŠ åˆ†é¡µæ”¯æŒ
@router.get("/customer-service/chat/{chat_id}/messages")
def get_customer_service_chat_messages(
    chat_id: str,
    page: int = 1,
    limit: int = 50,
    current_user=Depends(get_current_customer_service_or_user),
    db: Session = Depends(get_db)
):
    """
    åˆ†é¡µè·å–æ¶ˆæ¯ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ¶ˆæ¯
    """
    offset = (page - 1) * limit
    messages = crud.get_customer_service_messages(
        db, chat_id, limit=limit, offset=offset
    )
    return messages
```

### 2. WebSocketè¿æ¥ä¼˜åŒ–

#### é—®é¢˜ï¼šWebSocketè¿æ¥å¯èƒ½ä¸ç¨³å®š
**ä¼˜åŒ–æ–¹æ¡ˆ**:
- å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶
- æ·»åŠ å¿ƒè·³æ£€æµ‹
- è¿æ¥æ± ç®¡ç†

```typescript
// å‰ç«¯WebSocketä¼˜åŒ–
class CustomerServiceWebSocket {
  private ws: WebSocket | null = null;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;
  
  connect() {
    // å®ç°è‡ªåŠ¨é‡è¿é€»è¾‘
    // æ·»åŠ å¿ƒè·³æ£€æµ‹
  }
  
  private heartbeat() {
    // æ¯30ç§’å‘é€å¿ƒè·³
    setInterval(() => {
      if (this.ws?.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, 30000);
  }
}
```

### 3. ç¼“å­˜ä¼˜åŒ–

#### ä¼˜åŒ–æ–¹æ¡ˆï¼š
```python
# ä½¿ç”¨Redisç¼“å­˜å®¢æœåœ¨çº¿çŠ¶æ€
def get_online_services_cached(db, redis_client):
    cache_key = "online_customer_services"
    cached = redis_client.get(cache_key)
    
    if cached:
        return json.loads(cached)
    
    services = db.query(CustomerService).filter(
        CustomerService.is_online == 1
    ).all()
    
    result = [{"id": s.id, "name": s.name} for s in services]
    redis_client.setex(cache_key, 60, json.dumps(result))  # ç¼“å­˜60ç§’
    
    return result
```

---

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. å‰ç«¯ç•Œé¢ä¼˜åŒ–

#### é—®é¢˜ï¼šå®¢æœé¢æ¿ç•Œé¢å¯èƒ½ä¸å¤Ÿç›´è§‚
**ä¼˜åŒ–æ–¹æ¡ˆ**:
- æ·»åŠ å¯¹è¯æœç´¢åŠŸèƒ½
- æ·»åŠ å¯¹è¯ç­›é€‰ï¼ˆè¿›è¡Œä¸­/å·²ç»“æŸ/æœªè¯»ï¼‰
- ä¼˜åŒ–æ¶ˆæ¯æ—¶é—´æ˜¾ç¤ºï¼ˆç›¸å¯¹æ—¶é—´ï¼‰
- æ·»åŠ æ¶ˆæ¯è¾“å…¥æç¤ºï¼ˆæ­£åœ¨è¾“å…¥...ï¼‰
- ä¼˜åŒ–ç§»åŠ¨ç«¯é€‚é…

#### é—®é¢˜ï¼šç”¨æˆ·ç«¯å®¢æœä¸­å¿ƒå…¥å£ä¸æ˜æ˜¾
**ä¼˜åŒ–æ–¹æ¡ˆ**:
- åœ¨æ¶ˆæ¯é¡µé¢ä¸­ä¼˜åŒ–å®¢æœä¸­å¿ƒå…¥å£çš„æ˜¾ç¤ºï¼ˆä¿æŒå…¥å£åœ¨æ¶ˆæ¯é¡µé¢å†…ï¼Œä¸æš´éœ²åœ¨å¯¼èˆªæ ï¼‰
- æ·»åŠ å®¢æœåœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨
- ä¼˜åŒ–å®¢æœä¸­å¿ƒç•Œé¢å¸ƒå±€
- åœ¨ç”¨æˆ·é‡åˆ°é—®é¢˜æ—¶æä¾›æ›´æ˜æ˜¾çš„å¼•å¯¼æç¤ºï¼ˆå¦‚ä»»åŠ¡è¯¦æƒ…é¡µã€å¸®åŠ©ä¸­å¿ƒç­‰ï¼‰

### 2. æ¶ˆæ¯ä½“éªŒä¼˜åŒ–

#### ä¼˜åŒ–æ–¹æ¡ˆï¼š
```typescript
// æ·»åŠ æ¶ˆæ¯çŠ¶æ€æŒ‡ç¤º
interface Message {
  id: string;
  content: string;
  sender_type: 'user' | 'service' | 'system';
  status: 'sending' | 'sent' | 'delivered' | 'read';
  timestamp: string;
}

// æ·»åŠ è¾“å…¥çŠ¶æ€æç¤º
const [isTyping, setIsTyping] = useState(false);

// å‘é€è¾“å…¥çŠ¶æ€
const handleInputChange = (text: string) => {
  if (text.length > 0 && !isTyping) {
    ws.send(JSON.stringify({ type: 'typing', is_typing: true }));
    setIsTyping(true);
  }
  
  // åœæ­¢è¾“å…¥3ç§’åå‘é€åœæ­¢è¾“å…¥çŠ¶æ€
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    ws.send(JSON.stringify({ type: 'typing', is_typing: false }));
    setIsTyping(false);
  }, 3000);
};
```

### 3. é€šçŸ¥ä¼˜åŒ–

#### ä¼˜åŒ–æ–¹æ¡ˆï¼š
- æ·»åŠ æµè§ˆå™¨æ¡Œé¢é€šçŸ¥ï¼ˆç”¨æˆ·æˆæƒåï¼‰
- æ·»åŠ å£°éŸ³æç¤ºï¼ˆå¯é…ç½®ï¼‰
- ä¼˜åŒ–é€šçŸ¥æ ·å¼å’Œä½ç½®

```typescript
// æµè§ˆå™¨é€šçŸ¥
const showNotification = (title: string, body: string) => {
  if (Notification.permission === 'granted') {
    new Notification(title, {
      body,
      icon: '/static/service.png',
      badge: '/static/service.png'
    });
  }
};
```

---

## å®‰å…¨æ€§ä¼˜åŒ–

### 1. æƒé™éªŒè¯å¢å¼º

#### ä¼˜åŒ–æ–¹æ¡ˆï¼š
```python
# æ·»åŠ æ›´ä¸¥æ ¼çš„æƒé™æ£€æŸ¥
def verify_chat_permission(
    chat_id: str,
    user_id: str,
    user_type: str,
    db: Session
) -> bool:
    """
    éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®å¯¹è¯
    """
    chat = crud.get_customer_service_chat(db, chat_id)
    if not chat:
        return False
    
    if user_type == 'user':
        return chat['user_id'] == user_id
    elif user_type == 'service':
        return chat['service_id'] == user_id
    
    return False
```

### 2. æ¶ˆæ¯å†…å®¹è¿‡æ»¤

#### ä¼˜åŒ–æ–¹æ¡ˆï¼š
```python
# æ·»åŠ æ•æ„Ÿè¯è¿‡æ»¤
def filter_sensitive_content(content: str) -> tuple[str, bool]:
    """
    è¿‡æ»¤æ•æ„Ÿå†…å®¹ï¼Œè¿”å›è¿‡æ»¤åçš„å†…å®¹å’Œæ˜¯å¦åŒ…å«æ•æ„Ÿè¯
    """
    sensitive_words = ['æ•æ„Ÿè¯1', 'æ•æ„Ÿè¯2']  # ä»æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶åŠ è½½
    
    filtered_content = content
    contains_sensitive = False
    
    for word in sensitive_words:
        if word in content:
            filtered_content = filtered_content.replace(word, '*' * len(word))
            contains_sensitive = True
    
    return filtered_content, contains_sensitive
```

### 3. é¢‘ç‡é™åˆ¶

#### ä¼˜åŒ–æ–¹æ¡ˆï¼š
```python
# æ·»åŠ æ¶ˆæ¯å‘é€é¢‘ç‡é™åˆ¶
from functools import wraps
from datetime import datetime, timedelta

# æ³¨æ„ï¼šæ­¤å¤„çš„æ—§ç‰ˆæœ¬rate_limit_messageså·²è¢«å®Œæ•´å®ç°ç‰ˆæœ¬æ›¿æ¢
# å®Œæ•´å®ç°è§"æœ€é«˜ä¼˜å…ˆçº§é—®é¢˜ -> 5. é€Ÿç‡é™åˆ¶/åæ»¥ç”¨åªæ˜¯'å ä½'ä»£ç "ç« èŠ‚
```

---

## æœªæ¥è§„åˆ’

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2ä¸ªæœˆï¼‰

1. **å®¢æœæ’é˜Ÿç³»ç»Ÿ** â­ æœ€é«˜ä¼˜å…ˆçº§
   - å®ç°ç”¨æˆ·æ’é˜Ÿæœºåˆ¶
   - æ·»åŠ æœ€å¤§å¹¶å‘å¯¹è¯æ•°é™åˆ¶
   - å®ç°è‡ªåŠ¨åˆ†é…æ’é˜Ÿç”¨æˆ·
   - æ·»åŠ æ’é˜ŸçŠ¶æ€æŸ¥è¯¢å’Œå–æ¶ˆåŠŸèƒ½
   - å‰ç«¯æ˜¾ç¤ºæ’é˜Ÿä½ç½®å’Œé¢„è®¡ç­‰å¾…æ—¶é—´

2. **ç”¨æˆ·ç«¯å®¢æœèŠå¤©æ¡†ä¼˜åŒ–** â­ é«˜ä¼˜å…ˆçº§
   - å®ç°ä»»åŠ¡åˆ†äº«åŠŸèƒ½ï¼ˆç”¨æˆ·å¯ä»¥å‘å®¢æœåˆ†äº«ä»»åŠ¡ï¼‰
   - æ·»åŠ ä»»åŠ¡å¡ç‰‡æ¶ˆæ¯æ˜¾ç¤º
   - æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼ˆä¸ä»…ä»…æ˜¯å›¾ç‰‡ï¼‰
   - æ·»åŠ æ¶ˆæ¯å¼•ç”¨åŠŸèƒ½

3. **å®¢æœå–æ¶ˆå®¡æ ¸åŠŸèƒ½ä¼˜åŒ–** â­ é«˜ä¼˜å…ˆçº§
   - å®ç°ç­›é€‰å’Œæœç´¢åŠŸèƒ½
   - æ”¯æŒæ‰¹é‡å®¡æ ¸æ“ä½œ
   - æ·»åŠ å®¡æ ¸ç»Ÿè®¡åŠŸèƒ½
   - å®ç°ä»»åŠ¡è¯¦æƒ…å¿«é€ŸæŸ¥çœ‹

4. **æ™ºèƒ½å®¢æœåˆ†é…**
   - å®ç°åŸºäºè´Ÿè½½çš„åˆ†é…ç®—æ³•
   - æ·»åŠ å®¢æœæŠ€èƒ½æ ‡ç­¾åŒ¹é…
   - è€ƒè™‘å®¢æœè¯„åˆ†å’Œå“åº”æ—¶é—´

5. **å¯¹è¯ç®¡ç†ä¼˜åŒ–**
   - å®ç°å¯¹è¯è½¬æ¥åŠŸèƒ½
   - æ·»åŠ å¯¹è¯æ ‡ç­¾å’Œå¤‡æ³¨
   - å®ç°å¯¹è¯æœç´¢åŠŸèƒ½

6. **å®¢æœä¸ç®¡ç†å‘˜å¯¹è¯ç³»ç»Ÿä¼˜åŒ–**
   - å®ç°ç§èŠåŠŸèƒ½ï¼ˆä¸€å¯¹ä¸€å¯¹è¯ï¼‰
   - æ·»åŠ å®æ—¶é€šçŸ¥å’Œæ¶ˆæ¯å·²è¯»çŠ¶æ€
   - æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œæ¶ˆæ¯åˆ†ç±»

7. **å®¢æœå‘ç®¡ç†å‘˜ç”³è¯·åŠŸèƒ½ä¼˜åŒ–**
   - æ”¯æŒé™„ä»¶ä¸Šä¼ 
   - æ”¯æŒå…³è”ä»»åŠ¡å’Œç”¨æˆ·
   - å®ç°ç”³è¯·æ¨¡æ¿åŠŸèƒ½

8. **å¯¹è¯è¶…æ—¶åŠŸèƒ½ä¼˜åŒ–**
   - å®ç°è‡ªåŠ¨æ£€æµ‹å’Œç»“æŸè¶…æ—¶å¯¹è¯
   - æ·»åŠ è¶…æ—¶å‰è­¦å‘Šæœºåˆ¶ï¼ˆ1åˆ†é’Ÿæé†’ï¼‰
   - å®ç°å¯é…ç½®çš„è¶…æ—¶æ—¶é—´è®¾ç½®
   - åŒºåˆ†ç”¨æˆ·æ— æ´»åŠ¨ vs å®¢æœæ— æ´»åŠ¨çš„å¤„ç†
   - æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ï¼ˆ7å¤©ï¼‰
   - ç”¨æˆ·ç«¯è¶…æ—¶å€’è®¡æ—¶å’Œæé†’

9. **ç»Ÿè®¡å’ŒæŠ¥è¡¨**
   - å®¢æœå·¥ä½œè´Ÿè½½ç»Ÿè®¡
   - å“åº”æ—¶é—´ç»Ÿè®¡
   - ç”¨æˆ·æ»¡æ„åº¦æŠ¥è¡¨
   - æ’é˜Ÿé˜Ÿåˆ—ç»Ÿè®¡
   - å®¡æ ¸ç»Ÿè®¡æŠ¥è¡¨

### ä¸­æœŸä¼˜åŒ–ï¼ˆ3-6ä¸ªæœˆï¼‰

1. **AIè¾…åŠ©åŠŸèƒ½**
   - æ™ºèƒ½å›å¤å»ºè®®
   - å¸¸è§é—®é¢˜è‡ªåŠ¨å›å¤
   - æƒ…æ„Ÿåˆ†æ

2. **å¤šæ¸ é“æ”¯æŒ**
   - é‚®ä»¶æ”¯æŒ
   - ç”µè¯æ”¯æŒï¼ˆå¯é€‰ï¼‰
   - ç¤¾äº¤åª’ä½“é›†æˆ

3. **çŸ¥è¯†åº“ç³»ç»Ÿ**
   - å¸¸è§é—®é¢˜åº“
   - è§£å†³æ–¹æ¡ˆåº“
   - å†…éƒ¨çŸ¥è¯†å…±äº«

### é•¿æœŸè§„åˆ’ï¼ˆ6ä¸ªæœˆä»¥ä¸Šï¼‰

1. **å…¨æ¸ é“å®¢æœå¹³å°**
   - ç»Ÿä¸€å®¢æœå·¥ä½œå°
   - å¤šæ¸ é“æ¶ˆæ¯èšåˆ
   - æ™ºèƒ½è·¯ç”±ç³»ç»Ÿ

2. **é«˜çº§åˆ†æåŠŸèƒ½**
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ
   - å®¢æœç»©æ•ˆåˆ†æ
   - é¢„æµ‹æ€§åˆ†æ

3. **è‡ªåŠ¨åŒ–æµç¨‹**
   - å·¥ä½œæµè‡ªåŠ¨åŒ–
   - æ™ºèƒ½ä»»åŠ¡åˆ†é…
   - è‡ªåŠ¨å‡çº§æœºåˆ¶

---

## å·²çŸ¥é—®é¢˜å’Œå¾…ä¿®å¤é¡¹

### ğŸ”´ğŸ”´ æœ€é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»å…ˆä¿®ï¼‰

> **æ³¨æ„**ï¼šä»¥ä¸‹é—®é¢˜æ¶‰åŠç³»ç»Ÿå®‰å…¨æ€§ã€æ•°æ®ä¸€è‡´æ€§å’Œæ¶æ„è§„èŒƒï¼Œå¿…é¡»ä¼˜å…ˆä¿®å¤ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å®‰å…¨æ¼æ´ã€æ•°æ®é”™è¯¯æˆ–ç»´æŠ¤å›°éš¾ã€‚

#### 1. è·¯ç”±å‘½åä¸åˆ†åŒºä¸ä¸€è‡´ï¼Œå¢åŠ ç»´æŠ¤å’Œé‰´æƒå¤æ‚åº¦ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- åŒä¸€åŸŸä¸‹æ··ç”¨ `/api/cs/login` ä¸ `/api/customer-service/...` ä¸¤ç§å‰ç¼€
- ç”¨æˆ·ç«¯æ¥å£æŒ‚åœ¨ `/customer-service` å‰ç¼€ä¸‹ï¼Œæ˜“å¼•èµ·æƒé™è¯¯è§£
- RESTè¯­ä¹‰ä¸å‘½åé£æ ¼ä¸ç»Ÿä¸€ï¼ˆå¦‚ `/end-chat`ã€`/timeout-end-chat`ã€`/assign_customer_service` æ··ç”¨ï¼‰

**å½±å“**:
- æƒé™æ··æ·†ï¼Œå¯èƒ½å¯¼è‡´å®‰å…¨æ¼æ´
- ç»´æŠ¤å›°éš¾ï¼Œä»£ç å¯è¯»æ€§å·®
- ä¸ç¬¦åˆRESTfulè§„èŒƒ

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# å»ºè®®ç»Ÿä¸€è·¯ç”±ç»“æ„ï¼š
# å®¢æœç«¯è·¯ç”±ï¼š/api/customer-service/...
POST /api/customer-service/login  # ç»Ÿä¸€å®¢æœç™»å½•
GET  /api/customer-service/chats  # å®¢æœè·å–å¯¹è¯åˆ—è¡¨
POST /api/customer-service/chats/{chat_id}/end  # ç»“æŸå¯¹è¯
POST /api/customer-service/chats/{chat_id}/timeout-end  # è¶…æ—¶ç»“æŸ

# ç”¨æˆ·ç«¯è·¯ç”±ï¼š/api/user/customer-service/... æˆ– /api/me/cs-chats
GET  /api/user/customer-service/chats  # ç”¨æˆ·è·å–å¯¹è¯å†å²
POST /api/user/customer-service/chats/{chat_id}/messages  # ç”¨æˆ·å‘é€æ¶ˆæ¯
POST /api/user/customer-service/chats/{chat_id}/rate  # ç”¨æˆ·è¯„åˆ†

# å†…éƒ¨ç®¡ç†è·¯ç”±ï¼š/api/internal/... æˆ–é€šè¿‡Celeryä»»åŠ¡
# å®šæ—¶ä»»åŠ¡ä¸åº”æš´éœ²ä¸ºå…¬å¼€HTTPç«¯ç‚¹
```

**è¯æ®ä½ç½®**: 
- `backend/app/routers.py`: æ··ç”¨ `/api/cs/login` å’Œ `/api/customer-service/...`
- ç”¨æˆ·ç«¯æ¥å£å¦‚ `GET /api/customer-service/my-chats` ä½¿ç”¨å®¢æœå‰ç¼€

---

#### 2. æ—¶åŒº/æ—¶é—´åŸºå‡†æ··ç”¨ï¼Œå¯èƒ½å¯¼è‡´æ’é˜Ÿä¸è¶…æ—¶åˆ¤æ–­é”™è¯¯ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- é˜Ÿåˆ—æ¨¡å‹çš„æ—¶é—´é»˜è®¤ç”¨ `get_uk_time()`ï¼ˆä¼¦æ•¦æ—¶åŒºï¼‰
- å¤„ç†/è®¡ç®—åˆç”¨ `datetime.utcnow()`
- åŒä¸€æ¨¡å—é‡Œè¿˜æœ‰ç”¨ `pytz("Europe/London")` çš„åšæ³•
- ä¸‰å¥—"æ—¶é—´è§‚"æ··ç”¨ï¼ŒDSTåˆ‡æ¢æ—¶å¯èƒ½å‡ºé”™

**å½±å“**:
- æ’é˜Ÿç­‰å¾…æ—¶é—´è®¡ç®—é”™è¯¯
- è¶…æ—¶åˆ¤æ–­ä¸å‡†ç¡®
- æ•°æ®ä¸ä¸€è‡´
- å¤ä»¤æ—¶åˆ‡æ¢æ—¶å¯èƒ½å‡ºç°ä¸¥é‡é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ç»Ÿä¸€æ—¶é—´ç­–ç•¥ï¼š
# 1. æ•°æ®åº“å­˜å‚¨ç»Ÿä¸€ä½¿ç”¨UTC
from datetime import datetime, timezone

def get_utc_time():
    """ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´"""
    return datetime.now(timezone.utc)

# 2. æ¨¡å‹é»˜è®¤å€¼æ”¹ä¸ºUTC
class CustomerServiceQueue(Base):
    queued_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ”¹ä¸ºUTC
    
class CustomerServiceChat(Base):
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ”¹ä¸ºUTC
    last_message_at = Column(DateTime(timezone=True), default=get_utc_time)  # æ”¹ä¸ºUTC

# 3. è®¡ç®—æ—¶ç»Ÿä¸€è½¬æ¢ä¸ºUTC
def calculate_wait_time(queued_at: datetime) -> int:
    """è®¡ç®—ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰"""
    if queued_at.tzinfo is None:
        # å¦‚æœæ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå‡è®¾æ˜¯UTC
        queued_at = queued_at.replace(tzinfo=timezone.utc)
    else:
        # è½¬æ¢ä¸ºUTC
        queued_at = queued_at.astimezone(timezone.utc)
    
    now_utc = datetime.now(timezone.utc)
    return int((now_utc - queued_at).total_seconds())

# 4. å‰ç«¯æ˜¾ç¤ºæ—¶å†è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒº
def format_time_for_display(utc_time: datetime, user_timezone: str) -> str:
    """å°†UTCæ—¶é—´è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºæ˜¾ç¤ºï¼ˆä½¿ç”¨zoneinfoæ›¿ä»£pytzï¼‰"""
    from zoneinfo import ZoneInfo  # Python 3.9+ æ¨èä½¿ç”¨zoneinfoæ›¿ä»£pytz
    user_tz = ZoneInfo(user_timezone)
    local_time = utc_time.astimezone(user_tz)
    return local_time.strftime('%Y-%m-%d %H:%M:%S')
```

**è¯æ®ä½ç½®**ï¼ˆéœ€è¦ä¿®å¤ï¼‰:
- `backend/app/crud.py`: `get_uk_time()` ç”¨äºæ¨¡å‹é»˜è®¤å€¼ â†’ åº”æ”¹ä¸º `get_utc_time()`
- `backend/app/routers.py`: è¶…æ—¶åˆ¤æ–­ä½¿ç”¨ `datetime.utcnow()` å’Œ `pytz.timezone("Europe/London")` â†’ åº”ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()` å’Œ `zoneinfo`
- é˜Ÿåˆ—è¡¨ `queued_at=get_uk_time()`ï¼Œä½†è®¡ç®—æ—¶ç”¨ `datetime.utcnow()` â†’ åº”ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`

---

#### 3. å®šæ—¶ä»»åŠ¡æš´éœ²ä¸ºå…¬å¼€HTTPç«¯ç‚¹ï¼Œæœªè¯´æ˜æƒé™ä¸é˜²æŠ¤ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**ï¼ˆå·²ä¿®å¤ï¼‰:
- âœ… å·²ä¿®å¤ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€æ”¹ä¸ºCeleryä»»åŠ¡ï¼Œä¸å¯¹å¤–æš´éœ²HTTPç«¯ç‚¹
- âœ… å·²ä¿®å¤ï¼šç§»é™¤æ‰€æœ‰HTTPç«¯ç‚¹ç¤ºä¾‹ï¼ˆ`/customer-service/auto-end-timeout-chats`ç­‰ï¼‰
- âœ… å·²ä¿®å¤ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€é€šè¿‡Celeryè§¦å‘ï¼Œä¸å¯¹å¤–æš´éœ²HTTPç«¯ç‚¹
- âœ… å·²ä¿®å¤ï¼šç»Ÿä¸€ä½¿ç”¨Celeryä»»åŠ¡é…ç½®ï¼Œä¸å†éœ€è¦HTTPç«¯ç‚¹çš„å¹‚ç­‰/é€Ÿç‡/ç­¾åä¿æŠ¤

**å½±å“**:
- å¯èƒ½è¢«æ¶æ„è°ƒç”¨ï¼Œå¯¼è‡´å¤§é‡å¯¹è¯è¢«é”™è¯¯ç»“æŸ
- å¯èƒ½è¢«DoSæ”»å‡»
- ç³»ç»Ÿèµ„æºè¢«æ»¥ç”¨

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# âœ… æ–¹æ¡ˆ1ï¼šæ”¹ä¸ºå†…éƒ¨ä»»åŠ¡ï¼ˆæ¨èï¼Œå¿…é¡»é‡‡ç”¨ï¼‰
# ä½¿ç”¨Celeryæˆ–å…¶ä»–ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹
from celery import Celery
from app.database import get_db

celery_app = Celery('linku_tasks')

@celery_app.task
def auto_end_timeout_chats_task():
    """è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯ - Celeryå†…éƒ¨ä»»åŠ¡"""
    db = next(get_db())
    try:
        from app.customer_service_tasks import auto_end_timeout_chats
        result = auto_end_timeout_chats(db)
        return result
    finally:
        db.close()

@celery_app.task
def send_timeout_warnings_task():
    """å‘é€è¶…æ—¶è­¦å‘Š - Celeryå†…éƒ¨ä»»åŠ¡"""
    db = next(get_db())
    try:
        from app.customer_service_tasks import send_timeout_warnings
        result = send_timeout_warnings(db)
        return result
    finally:
        db.close()

@celery_app.task
def cleanup_long_inactive_chats_task():
    """æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ - Celeryå†…éƒ¨ä»»åŠ¡"""
    db = next(get_db())
    try:
        from app.customer_service_tasks import cleanup_long_inactive_chats
        result = cleanup_long_inactive_chats(db)
        return result
    finally:
        db.close()

@celery_app.task
def process_customer_service_queue_task():
    """å¤„ç†å®¢æœé˜Ÿåˆ— - Celeryå†…éƒ¨ä»»åŠ¡"""
    db = next(get_db())
    try:
        from app.customer_service_tasks import process_customer_service_queue
        result = process_customer_service_queue(db)
        return result
    finally:
        db.close()

# å®šæ—¶é…ç½®ï¼ˆcelery beatï¼‰
celery_app.conf.beat_schedule = {
    'auto-end-timeout-chats': {
        'task': 'auto_end_timeout_chats_task',
        'schedule': 30.0,  # æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    },
    'send-timeout-warnings': {
        'task': 'send_timeout_warnings_task',
        'schedule': 30.0,  # æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    },
    'cleanup-long-inactive-chats': {
        'task': 'cleanup_long_inactive_chats_task',
        'schedule': 86400.0,  # æ¯å¤©æ‰§è¡Œä¸€æ¬¡
    },
    'process-customer-service-queue': {
        'task': 'process_customer_service_queue_task',
        'schedule': 30.0,  # æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    },
}

# âš ï¸ é‡è¦ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡å¿…é¡»é€šè¿‡Celeryè§¦å‘ï¼Œä¸åº”æš´éœ²HTTPç«¯ç‚¹
# ä»¥ä¸‹HTTPæ–¹æ¡ˆç¤ºä¾‹å·²ç§»è‡³æ–‡æ¡£æœ«å°¾"é™„å½•ï¼šä¸æ¨èæ–¹æ¡ˆ"ç« èŠ‚ï¼Œä»…ä¾›å†å²å‚è€ƒ
# å®é™…å®ç°åº”ç»Ÿä¸€ä½¿ç”¨Celeryä»»åŠ¡ï¼Œä¸è¦ä½¿ç”¨HTTPç«¯ç‚¹
```

**è¯æ®ä½ç½®**ï¼ˆå·²ä¿®å¤ï¼‰:
- âœ… å·²ä¿®å¤ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€æ”¹ä¸ºCeleryä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹
- âœ… å·²ä¿®å¤ï¼šç§»é™¤æ‰€æœ‰HTTPç«¯ç‚¹ç¤ºä¾‹ï¼Œç»Ÿä¸€ä½¿ç”¨Celeryä»»åŠ¡é…ç½®

---

#### 4. è¯»å†™ä¸€è‡´æ€§ä¸å­—æ®µè¯­ä¹‰ç¼ºå£ï¼šç»“æŸåŸå› æœªè½åº“ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- å·²è®¾è®¡äº†åŒºåˆ† `user_inactive`/`service_inactive` çš„åˆ¤æ–­å‡½æ•°
- ä½† `CustomerServiceChat` åªæœ‰ `is_ended`ï¼Œæ²¡æœ‰ç»“æŸåŸå› å­—æ®µï¼ˆå¦‚ `ended_reason`ï¼‰
- æ— æ³•åšåç»­åˆ†æä¸ç”³è¯‰è¿½æº¯

**å½±å“**:
- æ— æ³•åˆ†æå¯¹è¯ç»“æŸåŸå› 
- æ— æ³•è¿½æº¯é—®é¢˜
- æ— æ³•è¿›è¡Œæ•°æ®ç»Ÿè®¡å’Œåˆ†æ

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. æ‰©å±•CustomerServiceChatæ¨¡å‹ï¼ˆå¿…é¡»å®ç°ï¼Œå«å®Œæ•´è¿ç§»è„šæœ¬ï¼‰
class CustomerServiceChat(Base):
    __tablename__ = "customer_service_chats"
    # ... ç°æœ‰å­—æ®µ
    is_ended = Column(Integer, default=0)
    ended_at = Column(DateTime(timezone=True), nullable=True)  # ä½¿ç”¨UTCæ—¶åŒº
    
    # æ–°å¢å­—æ®µï¼ˆå¿…é¡»æ·»åŠ ï¼Œç”¨äºè¿½æº¯å’Œç»Ÿè®¡ï¼‰
    ended_reason = Column(String(32), nullable=True)  # timeout, user_ended, service_ended, auto_cleanup
    ended_by = Column(String(32), nullable=True)  # user_id, service_id, system
    ended_type = Column(String(32), nullable=True)  # user_inactive, service_inactive, manual, auto
    ended_comment = Column(Text, nullable=True)  # ç»“æŸå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

# Alembicè¿ç§»è„šæœ¬ï¼ˆç”¨äºç°æœ‰æ•°æ®åº“ï¼‰
"""
# ç”Ÿæˆè¿ç§»ï¼šalembic revision -m "add_chat_ended_fields"
def upgrade():
    op.add_column('customer_service_chats', 
        sa.Column('ended_reason', sa.String(32), nullable=True))
    op.add_column('customer_service_chats',
        sa.Column('ended_by', sa.String(32), nullable=True))
    op.add_column('customer_service_chats',
        sa.Column('ended_type', sa.String(32), nullable=True))
    op.add_column('customer_service_chats',
        sa.Column('ended_comment', sa.Text(), nullable=True))
    
    # ä¸ºç°æœ‰å·²ç»“æŸçš„å¯¹è¯è®¾ç½®é»˜è®¤å€¼
    op.execute("""
        UPDATE customer_service_chats 
        SET ended_reason = 'manual', 
            ended_by = 'system',
            ended_type = 'manual'
        WHERE is_ended = 1 AND ended_reason IS NULL
    """)

def downgrade():
    op.drop_column('customer_service_chats', 'ended_comment')
    op.drop_column('customer_service_chats', 'ended_type')
    op.drop_column('customer_service_chats', 'ended_by')
    op.drop_column('customer_service_chats', 'ended_reason')
"""

# 2. æ›´æ–°ç»“æŸå¯¹è¯å‡½æ•°ï¼ˆæ‰€æœ‰ç»“æŸè·¯å¾„éƒ½å¿…é¡»è°ƒç”¨ï¼‰
def end_customer_service_chat(
    db: Session, 
    chat_id: str,
    reason: str = None,
    ended_by: str = None,
    ended_type: str = None,
    comment: str = None
) -> bool:
    """
    ç»“æŸå®¢æœå¯¹è¯ï¼Œè®°å½•ç»“æŸåŸå› 
    æ‰€æœ‰ç»“æŸå¯¹è¯çš„åœ°æ–¹éƒ½å¿…é¡»è°ƒç”¨æ­¤å‡½æ•°ï¼Œå¹¶ä¼ å…¥æ­£ç¡®çš„å‚æ•°
    """
    from app.utils.time_utils import get_utc_time
    
    chat = db.query(CustomerServiceChat).filter(
        CustomerServiceChat.chat_id == chat_id
    ).first()
    
    if not chat:
        return False
    
    if chat.is_ended == 1:
        # å·²ç»ç»“æŸï¼Œé¿å…é‡å¤ç»“æŸ
        return True
    
    chat.is_ended = 1
    chat.ended_at = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    chat.ended_reason = reason  # timeout, user_ended, service_ended, auto_cleanup
    chat.ended_by = ended_by  # user_id, service_id, system
    chat.ended_type = ended_type  # user_inactive, service_inactive, manual, auto
    chat.ended_comment = comment  # ç»“æŸå¤‡æ³¨
    
    db.commit()
    
    # è®°å½•å®¡è®¡æ—¥å¿—
    logger.info(
        f"Chat {chat_id} ended: reason={reason}, type={ended_type}, by={ended_by}"
    )
    
    return True

# 3. è¶…æ—¶ç»“æŸå¯¹è¯æ—¶è®°å½•åŸå› 
def auto_end_timeout_chats():
    for chat in timeout_chats:
        # åˆ¤æ–­è¶…æ—¶ç±»å‹
        timeout_type = get_chat_timeout_type(chat.chat_id, db)
        
        crud.end_customer_service_chat(
            db, 
            chat.chat_id,
            reason="timeout",
            ended_by="system",
            ended_type=timeout_type  # user_inactive æˆ– service_inactive
        )
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­æåˆ°äº† `get_chat_timeout_type` å‡½æ•°ï¼Œä½†æ¨¡å‹ä¸­æ²¡æœ‰å¯¹åº”å­—æ®µ

---

#### 5. é€Ÿç‡é™åˆ¶/åæ»¥ç”¨åªæ˜¯"å ä½"ä»£ç  âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- `rate_limit_messages` ç•™æœ‰ `pass`ï¼Œå®é™…æœªå¯ç”¨
- å®¢æœ/ç”¨æˆ·èŠå¤©æ¥å£éƒ½åº”åŠ é€Ÿç‡ä¸é£æ§ï¼ˆIP+è´¦æˆ·ç»´åº¦ï¼‰ä»¥é˜²åˆ·å±/DoS

**å½±å“**:
- å¯èƒ½è¢«æ¶æ„åˆ·å±
- å¯èƒ½è¢«DoSæ”»å‡»
- ç³»ç»Ÿèµ„æºè¢«æ»¥ç”¨

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. å®ç°é€Ÿç‡é™åˆ¶è£…é¥°å™¨ï¼ˆå®Œæ•´å®ç°ï¼ŒRedisæ»‘åŠ¨çª—å£ï¼‰
from functools import wraps
from datetime import datetime, timedelta
import redis
import asyncio
from inspect import iscoroutinefunction
import json

# Rediså®¢æˆ·ç«¯ï¼ˆå•ä¾‹ï¼‰
_redis_client = None

def get_redis_client():
    """è·å–Rediså®¢æˆ·ç«¯"""
    global _redis_client
    if _redis_client is None:
        _redis_client = redis.Redis(
            host=os.getenv("REDIS_HOST", "localhost"),
            port=int(os.getenv("REDIS_PORT", 6379)),
            db=int(os.getenv("REDIS_DB", 0)),
            decode_responses=True
        )
    return _redis_client

def rate_limit_messages(max_messages: int = 10, window_seconds: int = 60):
    """
    é™åˆ¶ç”¨æˆ·åœ¨æ—¶é—´çª—å£å†…å‘é€çš„æ¶ˆæ¯æ•°é‡
    ä½¿ç”¨Redisæ»‘åŠ¨çª—å£ç®—æ³•ï¼ˆæœ‰åºé›†åˆï¼‰
    ç»Ÿä¸€ä¸ºå¼‚æ­¥å®ç°ï¼Œè¦æ±‚æ‰€æœ‰ä½¿ç”¨è¯¥è£…é¥°å™¨çš„å‡½æ•°å¿…é¡»æ˜¯async
    """
    def decorator(func):
        if not iscoroutinefunction(func):
            raise ValueError(
                f"å‡½æ•° {func.__name__} å¿…é¡»æ˜¯asyncå‡½æ•°ã€‚"
                "FastAPIç¯å¢ƒä¸‹ä½¿ç”¨asyncio.runå¯èƒ½å¯¼è‡´äº‹ä»¶å¾ªç¯å†²çªã€‚"
                "è¯·å°†å‡½æ•°æ”¹ä¸ºasync defã€‚"
            )
        
        @wraps(func)
        async def async_wrapper(*args, **kwargs):
            # è·å–ç”¨æˆ·IDå’ŒIP
            current_user = kwargs.get('current_user')
            request = kwargs.get('request')
            
            user_id = current_user.id if current_user else None
            ip_address = get_client_ip(request) if request else None
            
            # ä½¿ç”¨Redisæ»‘åŠ¨çª—å£ç®—æ³•
            redis_client = get_redis_client()
            from app.utils.time_utils import get_utc_time
            now = get_utc_time().timestamp()  # ç»Ÿä¸€ä½¿ç”¨UTC
            window_start = now - window_seconds
            
            # ç”¨æˆ·ç»´åº¦é™åˆ¶ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
            if user_id:
                user_key = f"message_rate:user:{user_id}"
                
                # ä½¿ç”¨æœ‰åºé›†åˆå®ç°æ»‘åŠ¨çª—å£
                # ç§»é™¤çª—å£å¤–çš„è®°å½•
                redis_client.zremrangebyscore(user_key, 0, window_start)
                
                # æ·»åŠ å½“å‰æ—¶é—´æˆ³
                redis_client.zadd(user_key, {str(now): now})
                
                # è®¾ç½®è¿‡æœŸæ—¶é—´
                redis_client.expire(user_key, window_seconds + 10)
                
                # è·å–çª—å£å†…çš„æ¶ˆæ¯æ•°
                user_count = redis_client.zcard(user_key)
                
                if user_count > max_messages:
                    raise HTTPException(
                        status_code=429,
                        detail=f"æ¶ˆæ¯å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·{window_seconds}ç§’åå†è¯•"
                    )
            
            # IPç»´åº¦é™åˆ¶ï¼ˆæ›´å®½æ¾ï¼Œé˜²æ­¢ä»£ç†ç»•è¿‡ï¼‰
            if ip_address:
                ip_key = f"message_rate:ip:{ip_address}"
                
                # åŒæ ·ä½¿ç”¨æ»‘åŠ¨çª—å£
                redis_client.zremrangebyscore(ip_key, 0, window_start)
                redis_client.zadd(ip_key, {str(now): now})
                redis_client.expire(ip_key, window_seconds + 10)
                
                ip_count = redis_client.zcard(ip_key)
                
                if ip_count > max_messages * 2:  # IPé™åˆ¶æ›´å®½æ¾
                    raise HTTPException(
                        status_code=429,
                        detail="IPå‘é€æ¶ˆæ¯è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
                    )
            
            # æ‰§è¡ŒåŸå‡½æ•°ï¼ˆç»Ÿä¸€ä¸ºå¼‚æ­¥ï¼‰
            return await func(*args, **kwargs)
        
        return async_wrapper
    return decorator

# 2. åº”ç”¨åˆ°æ¶ˆæ¯å‘é€æ¥å£ï¼ˆå®Œæ•´å®ç°ï¼‰
# âš ï¸ é‡è¦ï¼šæ‰€æœ‰æ¶ˆæ¯å‘é€ã€æ–‡ä»¶ä¸Šä¼ ã€ç»“æŸå¯¹è¯ç­‰æ¥å£å¿…é¡»ä½¿ç”¨é€Ÿç‡é™åˆ¶è£…é¥°å™¨
# è¯¦è§"é€Ÿç‡é™åˆ¶è¦†ç›–æ¸…å•"ç« èŠ‚ï¼Œåˆ—å‡ºæ‰€æœ‰å¿…é¡»ä½¿ç”¨æ­¤è£…é¥°å™¨çš„è·¯ç”±
@router.post("/api/user/customer-service/chats/{chat_id}/messages")
@rate_limit_messages(max_messages=10, window_seconds=60)  # é€Ÿç‡é™åˆ¶è£…é¥°å™¨
async def send_customer_service_chat_message(
    chat_id: str,
    message_data: SendMessagePayload,  # ä½¿ç”¨Pydanticæ¨¡å‹æ›¿ä»£dict
    current_user=Depends(get_current_user_secure_sync_csrf),
    request: Request = None,
    db: Session = Depends(get_db),
):
    """ç”¨æˆ·å‘é€æ¶ˆæ¯åˆ°å®¢æœå¯¹è¯ - å¸¦é€Ÿç‡é™åˆ¶å’Œå¼ºç±»å‹æ ¡éªŒ"""
    # XSSå‡€åŒ–
    content = sanitize_message_content(message_data.content, allow_html=False)
    
    # æ•æ„Ÿè¯è¿‡æ»¤
    filter_tool = SensitiveWordFilter()
    filtered_content, contains_sensitive, matched_words = filter_tool.filter_content(content)
    
    # ä¿å­˜æ¶ˆæ¯
    message = crud.save_customer_service_message(
        db, chat_id, current_user.id, "user", filtered_content
    )
    
    # è‡ªåŠ¨è®¾ç½®ä¸ºsentçŠ¶æ€
    from app.utils.time_utils import get_utc_time
    message.status = "sent"
    message.sent_at = get_utc_time()
    db.commit()
    
    return message
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­çš„ `rate_limit_messages` å‡½æ•°åªæœ‰ `pass`

---

#### é€Ÿç‡é™åˆ¶è¦†ç›–æ¸…å•

ä»¥ä¸‹æ‰€æœ‰æ¥å£å¿…é¡»ä½¿ç”¨ `@rate_limit_messages` è£…é¥°å™¨ï¼Œé¿å…é—æ¼ï¼š

**ç”¨æˆ·ç«¯æ¥å£**ï¼š
1. `POST /api/user/customer-service/chats/{chat_id}/messages` - ç”¨æˆ·å‘é€æ¶ˆæ¯
2. `POST /api/user/customer-service/chats/{chat_id}/files` - ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
3. `POST /api/user/customer-service/chats/{chat_id}/end` - ç”¨æˆ·ç»“æŸå¯¹è¯
4. `POST /api/user/customer-service/chats/{chat_id}/rate` - ç”¨æˆ·è¯„åˆ†

**å®¢æœç«¯æ¥å£**ï¼š
5. `POST /api/customer-service/chats/{chat_id}/messages` - å®¢æœå‘é€æ¶ˆæ¯
6. `POST /api/customer-service/chats/{chat_id}/end` - å®¢æœç»“æŸå¯¹è¯
7. `POST /api/customer-service/admin-chat` - å®¢æœå‘é€æ¶ˆæ¯ç»™ç®¡ç†å‘˜
8. `POST /api/customer-service/admin-requests` - å®¢æœæäº¤ç®¡ç†è¯·æ±‚
9. `POST /api/customer-service/admin-requests/{request_id}/attachments` - å®¢æœä¸Šä¼ ç”³è¯·é™„ä»¶

**é…ç½®å»ºè®®**ï¼š
- æ™®é€šæ¶ˆæ¯å‘é€ï¼š`@rate_limit_messages(max_messages=10, window_seconds=60)` - æ¯åˆ†é’Ÿæœ€å¤š10æ¡
- æ–‡ä»¶ä¸Šä¼ ï¼š`@rate_limit_messages(max_messages=5, window_seconds=60)` - æ¯åˆ†é’Ÿæœ€å¤š5ä¸ªæ–‡ä»¶
- ç»“æŸå¯¹è¯/è¯„åˆ†ï¼š`@rate_limit_messages(max_messages=20, window_seconds=60)` - æ¯åˆ†é’Ÿæœ€å¤š20æ¬¡

---

#### 6. Cookieä¼šè¯ + Refresh Token æœªè¯´æ˜CSRF/å®‰å…¨æ ‡å¿—ç­–ç•¥ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- æ–‡æ¡£åªå†™"Cookie-basedä¼šè¯è®¤è¯ã€Refresh Tokenæœºåˆ¶"
- æœªæ˜ç¡® HttpOnly/SameSite/Secureã€åˆ·æ–°ç­–ç•¥ä¸CSRFé˜²æŠ¤
- é™¤ä¸ªåˆ«ä¾èµ–åå«"csrf"çš„æ–¹æ³•å¤–ï¼Œæ•´ä½“ç­–ç•¥æœªè§

**å½±å“**:
- å¯èƒ½å—åˆ°CSRFæ”»å‡»
- Cookieå¯èƒ½è¢«XSSçªƒå–
- å®‰å…¨æ¼æ´é£é™©

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. ç»Ÿä¸€Cookieå®‰å…¨ç­–ç•¥
def set_secure_cookie(
    response: Response,
    key: str,
    value: str,
    max_age: int = 3600 * 6,  # 6å°æ—¶
    http_only: bool = True,
    secure: bool = True,  # HTTPS only
    same_site: str = "Lax"  # æˆ– "Strict"
):
    """è®¾ç½®å®‰å…¨çš„Cookie"""
    response.set_cookie(
        key=key,
        value=value,
        max_age=max_age,
        httponly=http_only,  # é˜²æ­¢XSS
        secure=secure,  # ä»…HTTPSä¼ è¾“
        samesite=same_site,  # CSRFé˜²æŠ¤
        path="/",
        domain=None  # ä¸è®¾ç½®domainï¼Œé¿å…è·¨åŸŸé—®é¢˜
    )

# 2. CSRF TokenåŒé‡æäº¤éªŒè¯
def verify_csrf_token(request: Request, db: Session) -> bool:
    """éªŒè¯CSRF Token"""
    # ä»Cookieè·å–CSRF Token
    csrf_token_cookie = request.cookies.get("csrf_token")
    
    # ä»Headerè·å–CSRF Token
    csrf_token_header = request.headers.get("X-CSRF-Token")
    
    if not csrf_token_cookie or not csrf_token_header:
        return False
    
    # åŒé‡æäº¤éªŒè¯
    if csrf_token_cookie != csrf_token_header:
        return False
    
    # éªŒè¯Tokenæœ‰æ•ˆæ€§ï¼ˆå¯é€‰ï¼šæ£€æŸ¥Redisä¸­çš„Tokenï¼‰
    # ...
    
    return True

# 3. åˆ·æ–°Tokenç­–ç•¥ï¼ˆå®Œæ•´å®ç°ï¼‰
def refresh_token_strategy(
    request: Request,
    current_token: str,
    refresh_token: str,
    db: Session
) -> dict:
    """
    åˆ·æ–°Tokenç­–ç•¥ï¼š
    1. æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆå‰©ä½™æ—¶é—´<30åˆ†é’Ÿï¼‰
    2. éªŒè¯Refresh Token
    3. ç”Ÿæˆæ–°Token
    4. æ’¤é”€æ—§Tokenï¼ˆä¿ç•™æœ€åNä¸ªTokenç”¨äºå¹¶å‘è¯·æ±‚ï¼‰
    """
    import jwt
    from datetime import datetime, timedelta
    
    # 1. éªŒè¯å½“å‰Token
    try:
        payload = jwt.decode(current_token, SECRET_KEY, algorithms=["HS256"])
        user_id = payload.get("user_id")
        exp = payload.get("exp")
        
        # æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸï¼ˆå‰©ä½™æ—¶é—´<30åˆ†é’Ÿï¼‰
        from app.utils.time_utils import get_utc_time
        remaining_time = exp - get_utc_time().timestamp()  # ç»Ÿä¸€ä½¿ç”¨UTC
        if remaining_time > 1800:  # 30åˆ†é’Ÿ
            # è¿˜æœªåˆ°åˆ·æ–°æ—¶é—´
            return {"token": current_token, "refresh_token": refresh_token}
    except jwt.ExpiredSignatureError:
        # Tokenå·²è¿‡æœŸï¼Œå¿…é¡»åˆ·æ–°
        pass
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail="Invalid token")
    
    # 2. éªŒè¯Refresh Token
    try:
        refresh_payload = jwt.decode(refresh_token, REFRESH_SECRET_KEY, algorithms=["HS256"])
        if refresh_payload.get("user_id") != user_id:
            raise HTTPException(status_code=401, detail="Invalid refresh token")
        
        # æ£€æŸ¥Refresh Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­ï¼ˆå·²æ’¤é”€ï¼‰
        if is_token_revoked(refresh_token, db):
            raise HTTPException(status_code=401, detail="Refresh token revoked")
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail="Invalid refresh token")
    
    # 3. ç”Ÿæˆæ–°Token
    new_token = generate_access_token(user_id)
    new_refresh_token = generate_refresh_token(user_id)
    
    # 4. æ’¤é”€æ—§Tokenï¼ˆä¿ç•™æœ€å5ä¸ªç”¨äºå¹¶å‘è¯·æ±‚ï¼‰
    revoke_old_tokens(user_id, keep_last_n=5, db=db)
    
    # 5. å°†æ—§Refresh TokenåŠ å…¥é»‘åå•
    add_token_to_blacklist(refresh_token, db)
    
    return {
        "token": new_token,
        "refresh_token": new_refresh_token,
        "expires_in": 3600 * 6  # 6å°æ—¶
    }

# 4. Tokené»‘åå•ç®¡ç†
class TokenBlacklist(Base):
    __tablename__ = "token_blacklist"
    id = Column(Integer, primary_key=True)
    token_hash = Column(String(64), unique=True, nullable=False)  # Tokençš„SHA256å“ˆå¸Œ
    user_id = Column(String(20), nullable=False)
    revoked_at = Column(DateTime(timezone=True), default=get_utc_time)
    expires_at = Column(DateTime(timezone=True), nullable=False)  # Tokenè¿‡æœŸæ—¶é—´

def is_token_revoked(token: str, db: Session) -> bool:
    """æ£€æŸ¥Tokenæ˜¯å¦å·²è¢«æ’¤é”€"""
    import hashlib
    token_hash = hashlib.sha256(token.encode()).hexdigest()
    
    blacklisted = db.query(TokenBlacklist).filter(
        TokenBlacklist.token_hash == token_hash
    ).first()
    
    return blacklisted is not None

def add_token_to_blacklist(token: str, db: Session):
    """å°†TokenåŠ å…¥é»‘åå•"""
    import hashlib
    import jwt
    
    token_hash = hashlib.sha256(token.encode()).hexdigest()
    
    # è·å–Tokenè¿‡æœŸæ—¶é—´
    try:
        payload = jwt.decode(token, REFRESH_SECRET_KEY, algorithms=["HS256"], options={"verify_exp": False})
        exp = payload.get("exp")
        expires_at = datetime.fromtimestamp(exp, tz=timezone.utc)
        user_id = payload.get("user_id")
    except:
        expires_at = get_utc_time() + timedelta(days=30)  # é»˜è®¤30å¤©
        user_id = None
    
    # æ·»åŠ åˆ°é»‘åå•
    blacklist_entry = TokenBlacklist(
        token_hash=token_hash,
        user_id=user_id,
        expires_at=expires_at
    )
    db.add(blacklist_entry)
    db.commit()
    
    # å®šæœŸæ¸…ç†è¿‡æœŸé»‘åå•æ¡ç›®ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­åªæåˆ°"Cookie-basedä¼šè¯è®¤è¯"ï¼Œæœªè¯´æ˜å®‰å…¨ç­–ç•¥

---

#### 7. æ•æ„Ÿè¯è¿‡æ»¤å®ç°è¿‡äºæœ´ç´  âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- ç®€å• `str.replace` æ˜“è¢«å¤§å°å†™/å˜ä½“ç»•è¿‡
- å»ºè®®æ¥å…¥åŸºäºè¯å…¸+æ­£åˆ™+æ¨¡ç³ŠåŒ¹é…

**å½±å“**:
- æ•æ„Ÿå†…å®¹å¯èƒ½ç»•è¿‡è¿‡æ»¤
- ç”¨æˆ·ä½“éªŒå·®
- åˆè§„é£é™©

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. å¢å¼ºæ•æ„Ÿè¯è¿‡æ»¤
import re
from typing import List, Tuple

class SensitiveWordFilter:
    def __init__(self):
        self.sensitive_words = self.load_sensitive_words()
        self.patterns = self.build_patterns()
    
    def load_sensitive_words(self) -> List[str]:
        """ä»æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶åŠ è½½æ•æ„Ÿè¯"""
        # å¯ä»¥ä»æ•°æ®åº“åŠ è½½
        return ["æ•æ„Ÿè¯1", "æ•æ„Ÿè¯2", ...]
    
    def build_patterns(self):
        """æ„å»ºæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼Œæ”¯æŒå˜ä½“"""
        patterns = []
        for word in self.sensitive_words:
            # æ”¯æŒå¤§å°å†™ã€ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦å˜ä½“
            pattern = re.compile(
                r'[' + re.escape(word) + r']+',
                re.IGNORECASE
            )
            patterns.append((word, pattern))
        return patterns
    
    def filter_content(self, content: str) -> Tuple[str, bool, List[str]]:
        """
        è¿‡æ»¤æ•æ„Ÿå†…å®¹
        è¿”å›: (è¿‡æ»¤åçš„å†…å®¹, æ˜¯å¦åŒ…å«æ•æ„Ÿè¯, åŒ¹é…çš„æ•æ„Ÿè¯åˆ—è¡¨)
        """
        filtered_content = content
        contains_sensitive = False
        matched_words = []
        
        for word, pattern in self.patterns:
            if pattern.search(content):
                contains_sensitive = True
                matched_words.append(word)
                # æ›¿æ¢ä¸ºæ˜Ÿå·
                filtered_content = pattern.sub('*' * len(word), filtered_content)
        
        return filtered_content, contains_sensitive, matched_words

# 2. åº”ç”¨åˆ°æ¶ˆæ¯å‘é€
@router.post("/customer-service/chat/{chat_id}/send-message")
def send_customer_service_chat_message(
    chat_id: str,
    message_data: SendMessagePayload,  # ä½¿ç”¨Pydanticæ¨¡å‹æ›¿ä»£dict
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db),
):
    """ç”¨æˆ·å‘é€æ¶ˆæ¯åˆ°å®¢æœå¯¹è¯ - å¸¦æ•æ„Ÿè¯è¿‡æ»¤"""
    content = message_data.content  # Pydanticæ¨¡å‹ç›´æ¥è®¿é—®å±æ€§
    
    # æ•æ„Ÿè¯è¿‡æ»¤
    filter_tool = SensitiveWordFilter()
    filtered_content, contains_sensitive, matched_words = filter_tool.filter_content(content)
    
    if contains_sensitive:
        # è®°å½•æ—¥å¿—ï¼ˆä»…è®°å½•å“ˆå¸Œï¼Œä¸è®°å½•æ•æ„Ÿè¯åŸæ–‡ï¼Œä¿æŠ¤éšç§ï¼‰
        import hashlib
        matched_hashes = [hashlib.sha256(word.encode()).hexdigest()[:16] for word in matched_words]
        logger.warning(
            f"ç”¨æˆ· {current_user.id} å‘é€äº†åŒ…å«æ•æ„Ÿè¯çš„æ¶ˆæ¯: "
            f"åŒ¹é…è§„åˆ™æ•°={len(matched_words)}, è§„åˆ™å“ˆå¸Œ={matched_hashes}"
        )
        
        # å¯é€‰ï¼šå‘é€è­¦å‘Šé€šçŸ¥
        # crud.create_notification(...)
    
    # ä¿å­˜è¿‡æ»¤åçš„å†…å®¹
    message = crud.save_customer_service_message(
        db, chat_id, current_user.id, "user", filtered_content
    )
    
    return message
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­çš„æ•æ„Ÿè¯è¿‡æ»¤ç¤ºä¾‹è¿‡äºç®€å•

---

#### 8. é™„ä»¶ä¸Šä¼ "å ä½"ï¼Œæœªå®šä¹‰å­˜å‚¨/æ‰«æ/æƒé™ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- ç®¡ç†ç”³è¯·é™„ä»¶æ¥å£æ˜¯ `pass`ï¼Œæœªå®ç°
- éœ€æ˜ç¡®ï¼šæ–‡ä»¶ç±»å‹ç™½åå•ã€å¤§å°é™åˆ¶ã€æ€æ¯’/é‰´é»„ã€ç§æœ‰å­˜å‚¨ï¼ˆå¸¦ç­¾åURLï¼‰ã€ä¸ç”³è¯·/å¯¹è¯çš„æƒé™ç»‘å®š

**å½±å“**:
- åŠŸèƒ½ç¼ºå¤±
- å®‰å…¨é£é™©ï¼ˆæ¶æ„æ–‡ä»¶ä¸Šä¼ ï¼‰
- å­˜å‚¨ç­–ç•¥ä¸æ˜ç¡®

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. æ–‡ä»¶ä¸Šä¼ é…ç½®
ALLOWED_FILE_TYPES = {
    'image': ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
    'document': ['application/pdf', 'application/msword', 
                 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'],
    'other': []  # æ ¹æ®éœ€è¦æ‰©å±•
}

MAX_FILE_SIZE = {
    'image': 5 * 1024 * 1024,  # 5MB
    'document': 10 * 1024 * 1024,  # 10MB
    'other': 2 * 1024 * 1024  # 2MB
}

# 2. æ–‡ä»¶ä¸Šä¼ æ¥å£ï¼ˆå”¯ä¸€æ­£ç¡®å®ç°ï¼Œä¿®å¤File(...)å’Œfile.sizeé—®é¢˜ï¼‰
# âš ï¸ é‡è¦ï¼šè¿™æ˜¯æ–‡ä»¶ä¸Šä¼ çš„å”¯ä¸€æ­£ç¡®å®ç°ï¼Œæ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æ¥å£å¿…é¡»ä½¿ç”¨æ­¤æ¨¡å¼
# ä¸¥ç¦ä½¿ç”¨ file.sizeï¼ˆUploadFileæ²¡æœ‰sizeå±æ€§ï¼‰ï¼Œå¿…é¡»é€šè¿‡æµå¼è¯»å–è®¡ç®—å¤§å°
@router.post("/api/customer-service/admin-requests/{request_id}/attachments")
async def upload_request_attachment(
    request_id: int,
    file: UploadFile = File(...),  # ä¿®æ­£ï¼šFile(...) ä¸æ˜¯ File(.)
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
):
    """ä¸Šä¼ ç”³è¯·é™„ä»¶ - å¸¦å®Œæ•´å®‰å…¨æ£€æŸ¥ï¼ˆå”¯ä¸€æ­£ç¡®å®ç°ï¼‰"""
    # 1. éªŒè¯ç”³è¯·æƒé™
    request = db.query(AdminRequest).filter(
        AdminRequest.id == request_id,
        AdminRequest.requester_id == current_user.id
    ).first()
    
    if not request:
        raise HTTPException(status_code=404, detail="Request not found")
    
    # 2. é™åˆ¶æ–‡ä»¶ç±»å‹å’Œå¤§å°
    MAX_SIZE = 10 * 1024 * 1024  # 10MB
    ALLOWED_TYPES = {"image/png", "image/jpeg", "image/gif", "application/pdf"}
    
    if file.content_type not in ALLOWED_TYPES:
        raise HTTPException(status_code=415, detail="Unsupported file type")
    
    # 3. æµå¼è¯»å–å¹¶è®¡ç®—å¤§å°ï¼ˆUploadFileæ²¡æœ‰sizeå±æ€§ï¼Œå¿…é¡»é€šè¿‡è¯»å–è®¡ç®—ï¼‰
    content = await file.read()
    file_size = len(content)  # ä½¿ç”¨å®é™…è¯»å–çš„å¤§å°ï¼Œä¸æ˜¯file.size
    
    if file_size > MAX_SIZE:
        raise HTTPException(status_code=413, detail=f"File too large, max {MAX_SIZE / 1024 / 1024}MB")
    
    # é‡ç½®æ–‡ä»¶æŒ‡é’ˆï¼ˆå¦‚åç»­è¿˜è¦è¯»å–ï¼‰
    await file.seek(0)
    
    # 4. å®‰å…¨æ–‡ä»¶åç”Ÿæˆï¼ˆé˜²æ­¢è·¯å¾„æ³¨å…¥å’ŒåŒæ‰©å±•åï¼‰
    from pathlib import Path
    import uuid
    from app.utils.time_utils import get_utc_time
    
    def generate_safe_filename(original_filename: str) -> str:
        """ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å"""
        # æå–æ‰©å±•åï¼ˆåªå–æœ€åä¸€ä¸ªï¼Œé˜²æ­¢åŒæ‰©å±•åï¼‰
        ext = Path(original_filename).suffix.lower()
        
        # ç™½åå•æ‰©å±•åéªŒè¯
        ALLOWED_EXTENSIONS = {'.jpg', '.jpeg', '.png', '.gif', '.webp', '.pdf'}
        
        if ext not in ALLOWED_EXTENSIONS:
            raise HTTPException(
                status_code=400,
                detail=f"ä¸æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å: {ext}"
            )
        
        # ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆUUID + ç™½åå•æ‰©å±•åï¼‰
        safe_filename = f"{uuid.uuid4().hex}{ext}"
        return safe_filename
    
    safe_filename = generate_safe_filename(file.filename)
    file_id = f"{uuid.uuid4().hex}"
    file_path = f"attachments/{request_id}/{file_id}_{safe_filename}"
    
    # 5. ä¿å­˜æ–‡ä»¶åˆ°ç§æœ‰å­˜å‚¨ï¼ˆä½¿ç”¨å·²è¯»å–çš„contentï¼‰
    # ä¿å­˜åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆå¦‚S3ã€OSSç­‰ï¼‰
    from io import BytesIO
    file_obj = BytesIO(content)
    storage_client.upload_fileobj(file_obj, file_path, private=True)
    
    # 6. ç”Ÿæˆç­¾åURLï¼ˆæœ‰æ•ˆæœŸ24å°æ—¶ï¼‰
    signed_url = storage_client.generate_signed_url(file_path, expires_in=86400)
    
    # 7. æ›´æ–°ç”³è¯·çš„é™„ä»¶åˆ—è¡¨
    if not request.attachments:
        request.attachments = []
    
    request.attachments.append({
        "file_id": file_id,
        "filename": safe_filename,  # ä½¿ç”¨å®‰å…¨æ–‡ä»¶åï¼Œä¸å­˜å‚¨åŸå§‹æ–‡ä»¶å
        "original_filename": file.filename,  # åŸå§‹æ–‡ä»¶åå•ç‹¬å­˜å‚¨ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼‰
        "content_type": file.content_type,
        "size": file_size,  # ä½¿ç”¨å®é™…è¯»å–çš„å¤§å°ï¼Œä¸æ˜¯file.size
        "uploaded_at": get_utc_time().isoformat(),  # ç»Ÿä¸€ä½¿ç”¨UTC
        "signed_url": signed_url  # ä¸´æ—¶è®¿é—®URL
    })
    
    db.commit()
    
    return {
        "file_id": file_id,
        "filename": file.filename,
        "size": file_size,  # ä½¿ç”¨å®é™…è¯»å–çš„å¤§å°
        "signed_url": signed_url
    }

# 3. è·å–é™„ä»¶ï¼ˆå¸¦æƒé™éªŒè¯ï¼‰
@router.get("/customer-service/admin-requests/{request_id}/attachments/{file_id}")
def get_request_attachment(
    request_id: int,
    file_id: str,
    current_user=Depends(get_current_service_or_admin),
    db: Session = Depends(get_db),
):
    """è·å–ç”³è¯·é™„ä»¶ - å¸¦æƒé™éªŒè¯"""
    request = db.query(AdminRequest).filter(
        AdminRequest.id == request_id
    ).first()
    
    if not request:
        raise HTTPException(status_code=404, detail="Request not found")
    
    # æƒé™æ£€æŸ¥ï¼šåªæœ‰ç”³è¯·è€…æˆ–ç®¡ç†å‘˜å¯ä»¥è®¿é—®
    if current_user.user_type == 'service' and request.requester_id != current_user.id:
        raise HTTPException(status_code=403, detail="Not authorized")
    
    # æŸ¥æ‰¾é™„ä»¶
    attachment = None
    for att in request.attachments or []:
        if att['file_id'] == file_id:
            attachment = att
            break
    
    if not attachment:
        raise HTTPException(status_code=404, detail="Attachment not found")
    
    # ç”Ÿæˆæ–°çš„ç­¾åURL
    file_path = f"attachments/{request_id}/{file_id}_{attachment['filename']}"
    signed_url = storage_client.generate_signed_url(file_path, expires_in=3600)
    
    return {
        "file_id": file_id,
        "filename": attachment['filename'],
        "signed_url": signed_url
    }
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­çš„é™„ä»¶ä¸Šä¼ æ¥å£åªæœ‰ `pass`

---

#### 9. è®¾å¤‡æŒ‡çº¹/IP ç»‘å®šæ¶‰åŠéšç§ä¸è¯¯å° âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- æ–‡æ¡£æå‡º"IPå’Œè®¾å¤‡æŒ‡çº¹ç»‘å®š"
- å»ºè®®è¡¥å……ç”¨æˆ·åŒæ„ä¸ç”³è¯‰æµç¨‹ã€å¤±é…å›é€€ï¼ˆä¾‹å¦‚æ¢ç½‘/æ¼«æ¸¸ï¼‰ï¼Œä»¥åŠæ•°æ®ä¿ç•™ä¸è„±æ•ç­–ç•¥

**å½±å“**:
- éšç§åˆè§„é—®é¢˜
- å¯èƒ½è¯¯å°æ­£å¸¸ç”¨æˆ·
- ç”¨æˆ·ä½“éªŒå·®

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. è®¾å¤‡æŒ‡çº¹ç­–ç•¥é…ç½®
DEVICE_FINGERPRINT_STRICT = os.getenv("DEVICE_FINGERPRINT_STRICT", "false") == "true"
ALLOW_DEVICE_CHANGE = os.getenv("ALLOW_DEVICE_CHANGE", "true") == "true"
MAX_DEVICE_CHANGES = int(os.getenv("MAX_DEVICE_CHANGES", "3"))  # å…è®¸è®¾å¤‡å˜æ›´æ¬¡æ•°

# 2. è®¾å¤‡å˜æ›´å¤„ç†
def handle_device_change(
    user_id: str,
    old_device: str,
    new_device: str,
    old_ip: str,
    new_ip: str,
    db: Session
) -> dict:
    """
    å¤„ç†è®¾å¤‡å˜æ›´
    è¿”å›: (æ˜¯å¦å…è®¸, åŸå› , éœ€è¦éªŒè¯)
    """
    # æ£€æŸ¥è®¾å¤‡å˜æ›´å†å²
    device_changes = db.query(DeviceChangeHistory).filter(
        DeviceChangeHistory.user_id == user_id
    ).order_by(DeviceChangeHistory.created_at.desc()).limit(MAX_DEVICE_CHANGES).all()
    
    if len(device_changes) >= MAX_DEVICE_CHANGES:
        # è¶…è¿‡å…è®¸æ¬¡æ•°ï¼Œéœ€è¦é¢å¤–éªŒè¯
        return {
            "allowed": False,
            "reason": "è®¾å¤‡å˜æ›´æ¬¡æ•°è¿‡å¤š",
            "requires_verification": True,
            "verification_type": "email_or_sms"
        }
    
    # è®°å½•è®¾å¤‡å˜æ›´
    change_record = DeviceChangeHistory(
        user_id=user_id,
        old_device=old_device,
        new_device=new_device,
        old_ip=old_ip,
        new_ip=new_ip,
        change_reason="auto"  # æˆ– "user_request"
    )
    db.add(change_record)
    db.commit()
    
    return {
        "allowed": True,
        "reason": "è®¾å¤‡å˜æ›´å·²è®°å½•",
        "requires_verification": False
    }

# 3. ç”³è¯‰æµç¨‹
@router.post("/customer-service/device-appeal")
def submit_device_appeal(
    appeal_data: schemas.DeviceAppealCreate,
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db),
):
    """æäº¤è®¾å¤‡å˜æ›´ç”³è¯‰"""
    appeal = DeviceAppeal(
        user_id=current_user.id,
        reason=appeal_data.reason,
        description=appeal_data.description,
        status="pending"
    )
    db.add(appeal)
    db.commit()
    
    # é€šçŸ¥ç®¡ç†å‘˜
    # notify_admin_device_appeal(appeal)
    
    return {"message": "ç”³è¯‰å·²æäº¤ï¼Œæˆ‘ä»¬ä¼šåœ¨24å°æ—¶å†…å¤„ç†"}

# 4. æ•°æ®ä¿ç•™ä¸è„±æ•ç­–ç•¥
def anonymize_old_device_data():
    """
    å®šæœŸæ¸…ç†å’Œè„±æ•æ—§çš„è®¾å¤‡æ•°æ®
    ä¿ç•™ç­–ç•¥ï¼š90å¤©åè„±æ•ï¼Œ180å¤©ååˆ é™¤
    """
    from app.utils.time_utils import get_utc_time
    cutoff_date = get_utc_time() - timedelta(days=90)  # ç»Ÿä¸€ä½¿ç”¨UTC
    
    old_records = db.query(DeviceChangeHistory).filter(
        DeviceChangeHistory.created_at < cutoff_date
    ).all()
    
    for record in old_records:
        # è„±æ•å¤„ç†
        record.old_ip = anonymize_ip(record.old_ip)
        record.new_ip = anonymize_ip(record.new_ip)
        record.old_device = anonymize_device(record.old_device)
        record.new_device = anonymize_device(record.new_device)
    
    db.commit()

async def handle_typing_event(data: dict, user_id: str, chat_id: str, db: Session):
    """
    å¤„ç†"æ­£åœ¨è¾“å…¥"äº‹ä»¶
    é™æµï¼šæ¯ä¸ªç”¨æˆ·æ¯5ç§’æœ€å¤šå‘é€ä¸€æ¬¡typingäº‹ä»¶
    """
    typing_user_id = data.get("user_id")
    is_typing = data.get("is_typing", True)
    
    # é™æµæ£€æŸ¥
    typing_key = f"typing_rate:{typing_user_id}:{chat_id}"
    redis_client = get_redis_client()
    
    if redis_client.exists(typing_key):
        # 5ç§’å†…å·²å‘é€è¿‡ï¼Œå¿½ç•¥
        return
    
    # è®¾ç½®é™æµæ ‡è®°ï¼ˆ5ç§’ï¼‰
    redis_client.setex(typing_key, 5, "1")
    
    # è·å–å¯¹è¯çš„å¦ä¸€æ–¹
    chat = db.query(CustomerServiceChat).filter(
        CustomerServiceChat.chat_id == chat_id
    ).first()
    
    if not chat:
        return
    
    # ç¡®å®šæ¥æ”¶è€…
    if typing_user_id == chat.user_id:
        receiver_id = chat.service_id
        receiver_type = "customer_service"
    else:
        receiver_id = chat.user_id
        receiver_type = "user"
    
    # é€šè¿‡WebSocketå¹¿æ’­typingäº‹ä»¶
    if receiver_id in active_connections:
        await active_connections[receiver_id]["websocket"].send_text(
            json.dumps({
                "type": "typing",
                "chat_id": chat_id,
                "user_id": typing_user_id,
                "is_typing": is_typing
            })
        )
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­æåˆ°"IPå’Œè®¾å¤‡æŒ‡çº¹ç»‘å®š"ï¼Œä½†æœªè¯´æ˜å¤„ç†ç­–ç•¥

---

#### 10. AdminRequestä¸»å¤–é”®å­—æ®µé•¿åº¦ä¸ä¸€è‡´ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- `requester_id = String(8)`ï¼Œ`admin_id = String(5)`ï¼ŒåŒæ—¶è¿˜æœ‰ `related_user_id = String(20)`
- å»ºè®®ç»Ÿä¸€IDé•¿åº¦/æ ¼å¼

**å½±å“**:
- æ•°æ®ä¸ä¸€è‡´
- å¯èƒ½é€ æˆå¤–é”®çº¦æŸé—®é¢˜
- ç»´æŠ¤å›°éš¾

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ç»Ÿä¸€IDæ ¼å¼å’Œé•¿åº¦
# æ–¹æ¡ˆ1ï¼šç»Ÿä¸€ä½¿ç”¨å›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸²ID
class AdminRequest(Base):
    __tablename__ = "admin_requests"
    id = Column(Integer, primary_key=True, index=True)
    requester_id = Column(String(20), ForeignKey("customer_service.id"))  # ç»Ÿä¸€ä¸º20
    admin_id = Column(String(20), ForeignKey("admin_users.id"), nullable=True)  # ç»Ÿä¸€ä¸º20
    related_user_id = Column(String(20), ForeignKey("users.id"), nullable=True)  # ç»Ÿä¸€ä¸º20
    related_task_id = Column(Integer, nullable=True)  # ä»»åŠ¡IDä¿æŒInteger

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨UUIDï¼ˆæ¨èï¼‰
import uuid

class AdminRequest(Base):
    __tablename__ = "admin_requests"
    id = Column(Integer, primary_key=True, index=True)
    requester_id = Column(String(36), ForeignKey("customer_service.id"))  # UUIDæ ¼å¼
    admin_id = Column(String(36), ForeignKey("admin_users.id"), nullable=True)
    related_user_id = Column(String(36), ForeignKey("users.id"), nullable=True)
```

**è¯æ®ä½ç½®**:
- `backend/app/models.py`: AdminRequestæ¨¡å‹å­—æ®µé•¿åº¦ä¸ä¸€è‡´

---

#### 11. èŠå¤©æ¶ˆæ¯çŠ¶æ€ï¼ˆå‰ç«¯æœ‰sending/sent/delivered/readï¼‰ä½†åç«¯åªçœ‹åˆ°"å·²è¯»"å»ºè®® âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- å‰ç«¯å®šä¹‰äº†å››æ€ï¼šsending/sent/delivered/read
- åç«¯ä»…æå‡ºæ–°å¢"æ ‡è®°å·²è¯»"æ¥å£è‰æ¡ˆ
- éœ€è¦åç«¯å®šä¹‰æŠ•é€’ç¡®è®¤ä¸å·²é€è¾¾äº‹ä»¶ï¼ˆWS ACK / æœåŠ¡ç«¯å…¥åº“ï¼‰æ‰èƒ½æ”¯æ’‘delivered

**å½±å“**:
- å‰ç«¯çŠ¶æ€ä¸å¯éªŒè¯
- ç”¨æˆ·ä½“éªŒå·®
- æ¶ˆæ¯çŠ¶æ€ä¸å‡†ç¡®

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. æ‰©å±•æ¶ˆæ¯æ¨¡å‹ï¼ˆå«DDLè¿ç§»è„šæœ¬ï¼‰
class CustomerServiceMessage(Base):
    __tablename__ = "customer_service_messages"
    id = Column(Integer, primary_key=True, index=True)
    chat_id = Column(String(50), nullable=False, index=True)  # æ·»åŠ ç´¢å¼•
    sender_id = Column(String(20), nullable=False)
    sender_type = Column(String(20), nullable=False)
    content = Column(Text, nullable=False)
    
    # æ¶ˆæ¯çŠ¶æ€
    status = Column(String(20), default="sending")  # sending, sent, delivered, read
    is_read = Column(Integer, default=0)  # å…¼å®¹æ—§å­—æ®µ
    
    # æ—¶é—´æˆ³ï¼ˆç»Ÿä¸€ä½¿ç”¨UTCï¼‰
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # å‘é€æ—¶é—´ï¼ˆUTCï¼‰
    sent_at = Column(DateTime(timezone=True), nullable=True)  # æœåŠ¡å™¨ç¡®è®¤æ—¶é—´ï¼ˆUTCï¼‰
    delivered_at = Column(DateTime(timezone=True), nullable=True)  # é€è¾¾æ—¶é—´ï¼ˆUTCï¼‰
    read_at = Column(DateTime(timezone=True), nullable=True)  # å·²è¯»æ—¶é—´ï¼ˆUTCï¼‰

# DDLè¿ç§»è„šæœ¬ï¼ˆç”¨äºç°æœ‰æ•°æ®åº“ï¼‰
"""
-- æ·»åŠ æ¶ˆæ¯çŠ¶æ€å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
ALTER TABLE customer_service_messages 
ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'sending';

-- æ·»åŠ æ—¶é—´æˆ³å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
ALTER TABLE customer_service_messages 
ADD COLUMN IF NOT EXISTS sent_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS delivered_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS read_at TIMESTAMP WITH TIME ZONE;

-- ä¸ºç°æœ‰æ¶ˆæ¯è®¾ç½®é»˜è®¤çŠ¶æ€
UPDATE customer_service_messages 
SET status = CASE 
    WHEN read_at IS NOT NULL THEN 'read'
    WHEN delivered_at IS NOT NULL THEN 'delivered'
    WHEN sent_at IS NOT NULL THEN 'sent'
    ELSE 'sending'
END
WHERE status IS NULL;

-- æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS ix_customer_service_messages_chat_id_status 
ON customer_service_messages(chat_id, status);
CREATE INDEX IF NOT EXISTS ix_customer_service_messages_created_at 
ON customer_service_messages(created_at);
"""

# 2. WebSocketæ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆå®Œæ•´å®ç°ï¼‰
async def handle_message_ack(message_id: int, ack_type: str, db: Session):
    """
    å¤„ç†æ¶ˆæ¯ç¡®è®¤
    ack_type: sent, delivered, read
    """
    message = db.query(CustomerServiceMessage).filter(
        CustomerServiceMessage.id == message_id
    ).first()
    
    if not message:
        return
    
    from app.utils.time_utils import get_utc_time
    now = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    
    if ack_type == "sent":
        message.status = "sent"
        message.sent_at = now
    elif ack_type == "delivered":
        message.status = "delivered"
        message.delivered_at = now
    elif ack_type == "read":
        message.status = "read"
        message.is_read = 1
        message.read_at = now
        
        # æ›´æ–°æ¶ˆæ¯åç§»ï¼ˆç”¨äºé‡è¿é‡æ”¾ï¼‰
        offset = db.query(MessageOffset).filter(
            MessageOffset.user_id == message.receiver_id,
            MessageOffset.chat_id == message.chat_id
        ).first()
        
        if offset:
            offset.last_message_id = max(offset.last_message_id, message_id)
            offset.updated_at = now
        else:
            offset = MessageOffset(
                user_id=message.receiver_id,
                chat_id=message.chat_id,
                last_message_id=message_id
            )
            db.add(offset)
    
    db.commit()
    
    # é€šçŸ¥å‘é€è€…æ¶ˆæ¯çŠ¶æ€æ›´æ–°ï¼ˆé€šè¿‡WebSocketï¼‰
    await notify_sender_message_status(message)

# 3. æ¶ˆæ¯å‘é€æ—¶è‡ªåŠ¨ç¡®è®¤sentçŠ¶æ€ï¼ˆå®Œæ•´å®ç°ï¼‰
@router.post("/customer-service/chat/{chat_id}/send-message")
async def send_customer_service_chat_message(
    chat_id: str,
    message_data: SendMessagePayload,  # ä½¿ç”¨Pydanticæ¨¡å‹æ›¿ä»£dict
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db),
):
    """ç”¨æˆ·å‘é€æ¶ˆæ¯åˆ°å®¢æœå¯¹è¯ - å®Œæ•´å››æ€æ”¯æŒï¼Œå¼ºç±»å‹æ ¡éªŒ"""
    # XSSå‡€åŒ–ï¼ˆåœ¨å…¥åº“å‰ï¼‰
    content = sanitize_message_content(message_data.content, allow_html=False)  # Pydanticæ¨¡å‹ç›´æ¥è®¿é—®å±æ€§
    
    # ä¿å­˜æ¶ˆæ¯
    message = crud.save_customer_service_message(
        db, chat_id, current_user.id, "user", content
    )
    
    # è‡ªåŠ¨è®¾ç½®ä¸ºsentçŠ¶æ€
    from app.utils.time_utils import get_utc_time
    message.status = "sent"
    message.sent_at = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    db.commit()
    
    # é€šè¿‡WebSocketå‘é€ï¼Œç­‰å¾…deliveredç¡®è®¤
    receiver_id = get_chat_receiver_id(chat_id, current_user.id, db)
    await send_websocket_message(receiver_id, {
        "type": "new_message",
        "message": {
            "id": message.id,
            "content": message.content,
            "status": message.status,
            "created_at": message.created_at.isoformat()
        }
    })
    
    return message

def sanitize_message_content(content: str) -> str:
    """XSSå‡€åŒ–ï¼šç§»é™¤HTMLæ ‡ç­¾å’Œè„šæœ¬"""
    import re
    from html import escape
    
    # 1. HTMLè½¬ä¹‰
    content = escape(content)
    
    # 2. ç§»é™¤æ½œåœ¨çš„è„šæœ¬æ ‡ç­¾ï¼ˆåŒé‡é˜²æŠ¤ï¼‰
    content = re.sub(r'<script[^>]*>.*?</script>', '', content, flags=re.IGNORECASE | re.DOTALL)
    content = re.sub(r'<iframe[^>]*>.*?</iframe>', '', content, flags=re.IGNORECASE | re.DOTALL)
    content = re.sub(r'javascript:', '', content, flags=re.IGNORECASE)
    content = re.sub(r'on\w+\s*=', '', content, flags=re.IGNORECASE)  # ç§»é™¤äº‹ä»¶å¤„ç†å™¨
    
    # 3. å¦‚æœå‰ç«¯éœ€è¦å¯Œæ–‡æœ¬ï¼Œä½¿ç”¨ä¸“é—¨çš„HTMLå‡€åŒ–åº“ï¼ˆå¦‚bleachï¼‰
    # import bleach
    # content = bleach.clean(content, tags=['p', 'br', 'strong', 'em'], strip=True)
    
    return content
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­å‰ç«¯å®šä¹‰äº†å››æ€ï¼Œä½†åç«¯å®ç°ä¸å®Œæ•´

---

#### 12. ä»»åŠ¡åˆ†äº«æ¶ˆæ¯åè®®ä¸ä¸Šä¼ èƒ½åŠ›ä¸åŒ¹é… âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- `send-message` åªæ¥æ”¶JSONï¼ˆ`message_data: dict`ï¼‰å¹¶ç”¨ `message_type` åŒºåˆ†
- å®é™…æœªè§æ–‡ä»¶ä¸Šä¼ å‹æ¶ˆæ¯ç«¯ç‚¹
- å‰ç«¯åˆè®¡åˆ’æ”¯æŒ"æ–‡ä»¶ä¸Šä¼ ï¼ˆä¸ä»…å›¾ç‰‡ï¼‰"

**å½±å“**:
- åŠŸèƒ½ä¸å®Œæ•´
- å‰åç«¯åè®®ä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹ï¼ˆå”¯ä¸€æ­£ç¡®å®ç°ï¼Œä¿®å¤File(...)æ‹¼å†™å’Œfile.sizeé—®é¢˜ï¼‰
# âš ï¸ é‡è¦ï¼šè¿™æ˜¯æ–‡ä»¶ä¸Šä¼ çš„å”¯ä¸€æ­£ç¡®å®ç°ï¼Œæ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æ¥å£å¿…é¡»ä½¿ç”¨æ­¤æ¨¡å¼
# ä¸¥ç¦ä½¿ç”¨ file.sizeï¼ˆUploadFileæ²¡æœ‰sizeå±æ€§ï¼‰ï¼Œå¿…é¡»é€šè¿‡æµå¼è¯»å–è®¡ç®—å¤§å°
@router.post("/api/user/customer-service/chats/{chat_id}/files")
async def upload_chat_file(
    chat_id: str,
    file: UploadFile = File(...),  # ä¿®æ­£ï¼šFile(...) ä¸æ˜¯ File(.)
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db),
):
    """ä¸Šä¼ æ–‡ä»¶åˆ°å®¢æœå¯¹è¯ï¼ˆç”¨æˆ·ç«¯å‘½åç©ºé—´ï¼‰- å”¯ä¸€æ­£ç¡®å®ç°"""
    # éªŒè¯æƒé™
    chat = crud.get_customer_service_chat(db, chat_id)
    if not chat or chat["user_id"] != current_user.id:
        raise HTTPException(status_code=403, detail="Not authorized")
    
    # é™åˆ¶æ–‡ä»¶ç±»å‹å’Œå¤§å°
    MAX_SIZE = 20 * 1024 * 1024  # 20MB
    ALLOWED_TYPES = {"image/png", "image/jpeg", "image/gif", "image/webp", "application/pdf"}
    
    if file.content_type not in ALLOWED_TYPES:
        raise HTTPException(status_code=415, detail="Unsupported file type")
    
    # æµå¼è¯»å–å¹¶è®¡ç®—å¤§å°ï¼ˆUploadFileæ²¡æœ‰sizeå±æ€§ï¼‰
    content = await file.read()
    file_size = len(content)
    
    if file_size > MAX_SIZE:
        raise HTTPException(status_code=413, detail=f"File too large, max {MAX_SIZE / 1024 / 1024}MB")
    
    # é‡ç½®æ–‡ä»¶æŒ‡é’ˆï¼ˆå¦‚åç»­è¿˜è¦è¯»å–ï¼‰
    await file.seek(0)
    
    # ä¿å­˜æ–‡ä»¶
    file_id = await save_chat_file(file, chat_id, current_user.id)
    
    # åˆ›å»ºæ–‡ä»¶æ¶ˆæ¯
    message = crud.save_customer_service_message(
        db, chat_id, current_user.id, "user",
        content=json.dumps({
            "type": "file",
            "file_id": file_id,
            "filename": file.filename,
            "content_type": file.content_type,
            "size": file_size  # ä½¿ç”¨å®é™…è¯»å–çš„å¤§å°ï¼Œä¸æ˜¯file.sizeï¼ˆUploadFileæ²¡æœ‰sizeå±æ€§ï¼‰
        })
    )
    
    return message

# 2. ç»Ÿä¸€æ¶ˆæ¯ç±»å‹å¤„ç†
MESSAGE_TYPES = {
    "text": "æ–‡æœ¬æ¶ˆæ¯",
    "image": "å›¾ç‰‡æ¶ˆæ¯",
    "file": "æ–‡ä»¶æ¶ˆæ¯",
    "task_share": "ä»»åŠ¡åˆ†äº«",
    "system": "ç³»ç»Ÿæ¶ˆæ¯"
}
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­å‰ç«¯è®¡åˆ’æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œä½†åç«¯åè®®ä¸å®Œæ•´

---

#### 13. é˜Ÿåˆ—ç­‰å¾…æ—¶é—´ä¼°ç®—è¿‡äºçº¿æ€§ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- ç›´æ¥é¢„è®¡ = æ’é˜Ÿä½ç½® Ã— 5åˆ†é’Ÿ
- å»ºè®®å¼•å…¥ç§»åŠ¨å¹³å‡å¤„ç†æ—¶é•¿æˆ–åˆ†ä½æ•°ï¼Œå¹¶éšå®¢æœè´Ÿè½½åŠ¨æ€ä¿®æ­£

**å½±å“**:
- ç­‰å¾…æ—¶é—´ä¼°ç®—ä¸å‡†ç¡®
- ç”¨æˆ·ä½“éªŒå·®

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. åŠ¨æ€ç­‰å¾…æ—¶é—´è®¡ç®—ï¼ˆå®Œæ•´å®ç°ï¼Œç»Ÿä¸€ä½¿ç”¨UTCï¼Œå•ä¸€æƒå¨å®ç°ï¼‰
# âš ï¸ é‡è¦ï¼šæ­¤å‡½æ•°ä¸ºå”¯ä¸€æƒå¨å®ç°ï¼Œæ‰€æœ‰è°ƒç”¨ä¸¥ç¦è‡ªå®šä¹‰å®ç°ï¼Œç»Ÿä¸€è°ƒç”¨æ­¤å‡½æ•°
# æ‰€æœ‰æ¥å£è¿”å›ç¤ºä¾‹ä¸­çš„ estimated_wait_time å¿…é¡»è°ƒç”¨æ­¤å‡½æ•°ï¼Œç¦æ­¢å†…è”ä»»ä½•ç®€åŒ–ç‰ˆå®ç°
def calculate_estimated_wait_time(
    queue_position: int,
    db: Session
) -> int:
    """
    è®¡ç®—é¢„è®¡ç­‰å¾…æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    ä½¿ç”¨ç§»åŠ¨å¹³å‡å¤„ç†æ—¶é•¿ï¼Œç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´
    è¿”å›ï¼šè‡³å°‘1åˆ†é’Ÿï¼Œé¿å…è¿”å›0
    
    å•ä¸€æƒå¨å®ç°ï¼šæ‰€æœ‰è°ƒç”¨æ­¤å‡½æ•°çš„åœ°æ–¹åº”ç»Ÿä¸€å¼•ç”¨æ­¤å®ç°ï¼Œé¿å…é‡å¤å®šä¹‰
    ä¸¥ç¦åœ¨æ¥å£è¿”å›ç¤ºä¾‹ä¸­å†…è”ç®€åŒ–ç‰ˆå®ç°ï¼Œå¿…é¡»ç»Ÿä¸€è°ƒç”¨æ­¤å‡½æ•°
    """
    from sqlalchemy import func
    from app.models import CustomerService, CustomerServiceChat
    from app.utils.time_utils import get_utc_time, to_utc
    
    # è·å–æœ€è¿‘100ä¸ªå·²åˆ†é…å¯¹è¯çš„å¹³å‡å¤„ç†æ—¶é•¿
    recent_chats = db.query(CustomerServiceChat).filter(
        CustomerServiceChat.is_ended == 1,
        CustomerServiceChat.ended_at.isnot(None),
        CustomerServiceChat.assigned_at.isnot(None)
    ).order_by(
        CustomerServiceChat.ended_at.desc()
    ).limit(100).all()
    
    if not recent_chats:
        # æ²¡æœ‰å†å²æ•°æ®ï¼Œä½¿ç”¨ä¿å®ˆçš„é»˜è®¤å€¼ï¼ˆ5åˆ†é’Ÿ/äººï¼‰
        # æ³¨æ„ï¼šè¿™æ˜¯å‡½æ•°å†…éƒ¨çš„é»˜è®¤å€¼è®¡ç®—ï¼Œä¸æ˜¯ç‹¬ç«‹çš„å®ç°
        return max(1, queue_position * 5)
    
    # è®¡ç®—å¹³å‡å¤„ç†æ—¶é•¿ï¼ˆç»Ÿä¸€ä½¿ç”¨UTCï¼‰
    total_duration = 0
    count = 0
    
    for chat in recent_chats:
        if chat.assigned_at and chat.ended_at:
            # ç»Ÿä¸€è½¬æ¢ä¸ºUTCåè®¡ç®—
            assigned_utc = to_utc(chat.assigned_at)
            ended_utc = to_utc(chat.ended_at)
            duration = (ended_utc - assigned_utc).total_seconds() / 60
            total_duration += duration
            count += 1
    
    if count == 0:
        # æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œä½¿ç”¨ä¿å®ˆçš„é»˜è®¤å€¼ï¼ˆ5åˆ†é’Ÿ/äººï¼‰
        # æ³¨æ„ï¼šè¿™æ˜¯å‡½æ•°å†…éƒ¨çš„é»˜è®¤å€¼è®¡ç®—ï¼Œä¸æ˜¯ç‹¬ç«‹çš„å®ç°
        return max(1, queue_position * 5)
    
    avg_duration = total_duration / count
    
    # è€ƒè™‘å½“å‰å®¢æœè´Ÿè½½
    online_services = db.query(CustomerService).filter(
        CustomerService.is_online == 1
    ).count()
    
    if online_services == 0:
        # æ²¡æœ‰åœ¨çº¿å®¢æœï¼Œç­‰å¾…æ—¶é—´æ›´é•¿ï¼ˆå‡½æ•°å†…éƒ¨è®¡ç®—ï¼Œä¸æ˜¯ç‹¬ç«‹å®ç°ï¼‰
        return max(1, queue_position * 10)
    
    # åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®åœ¨çº¿å®¢æœæ•°é‡å’Œå¹³å‡å¤„ç†æ—¶é•¿
    load_factor = max(1.0, 5.0 / online_services)  # å®¢æœè¶Šå°‘ï¼Œç­‰å¾…æ—¶é—´è¶Šé•¿
    estimated_time = queue_position * avg_duration * load_factor
    
    # ç¡®ä¿è‡³å°‘è¿”å›1åˆ†é’Ÿï¼Œé¿å…è¿”å›0
    return max(1, int(estimated_time))
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­é˜Ÿåˆ—ç­‰å¾…æ—¶é—´è®¡ç®—ä¸º `queue_position * 5`

---

#### 14. N+1ä¸é‡å¤counté£é™© âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- å–æ¶ˆå®¡æ ¸åˆ—è¡¨æ„é€ è¿”å›æ—¶ï¼Œå¯¹æ¯æ¡è®°å½•å†æ¬¡æŸ¥ `task` å’Œ `user`
- åº”JOINæ‰¹é‡æ‹‰å–å¹¶åªåšä¸€æ¬¡ç»Ÿè®¡

**å½±å“**:
- æ€§èƒ½é—®é¢˜
- æ•°æ®åº“å‹åŠ›å¤§
- å“åº”æ—¶é—´æ…¢

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¼˜åŒ–å‰ï¼ˆN+1é—®é¢˜ï¼‰
def cs_get_cancel_requests(...):
    requests = crud.get_task_cancel_requests(db, status)
    result = []
    for req in requests:
        task = crud.get_task(db, req.task_id)  # N+1æŸ¥è¯¢
        requester = crud.get_user_by_id(db, req.requester_id)  # N+1æŸ¥è¯¢
        result.append({...})

# ä¼˜åŒ–åï¼ˆä½¿ç”¨JOINï¼Œç»Ÿä¸€ä¸ºasyncï¼‰
@router.get("/api/customer-service/cancel-requests")
async def cs_get_cancel_requests(
    current_user=Depends(get_current_service),
    db: Session = Depends(get_db),
    status: str = None,
):
    """è·å–ä»»åŠ¡å–æ¶ˆè¯·æ±‚åˆ—è¡¨ - ä¼˜åŒ–ç‰ˆï¼Œé¿å…N+1æŸ¥è¯¢"""
    from app.models import TaskCancelRequest, Task, User
    from sqlalchemy.orm import joinedload
    
    query = db.query(TaskCancelRequest).options(
        joinedload(TaskCancelRequest.task),
        joinedload(TaskCancelRequest.requester)
    )
    
    if status:
        query = query.filter(TaskCancelRequest.status == status)
    
    requests = query.all()
    
    # æ‰¹é‡å¤„ç†ï¼Œé¿å…é‡å¤æŸ¥è¯¢
    result = []
    for req in requests:
        task = req.task  # å·²é€šè¿‡joinedloadåŠ è½½
        requester = req.requester  # å·²é€šè¿‡joinedloadåŠ è½½
        
        is_poster = task and task.poster_id == req.requester_id
        is_taker = task and task.taker_id == req.requester_id
        
        result.append({
            "id": req.id,
            "task_id": req.task_id,
            "task_title": task.title if task else "ä»»åŠ¡å·²åˆ é™¤",
            "requester_id": req.requester_id,
            "requester_name": requester.name if requester else "æœªçŸ¥ç”¨æˆ·",
            "reason": req.reason,
            "status": req.status,
            "user_role": "å‘å¸ƒè€…" if is_poster else ("æ¥æ”¶è€…" if is_taker else "æœªçŸ¥")
        })
    
    return result
```

**è¯æ®ä½ç½®**:
- `backend/app/routers.py`: å–æ¶ˆå®¡æ ¸åˆ—è¡¨é€æ¡æŸ¥è¯¢taskå’Œuser

---

#### 15. é˜Ÿåˆ—è¡¨ç¼ºç´¢å¼•å»ºè®® âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- é¢‘ç¹ç”¨ `status`, `queued_at` è¿‡æ»¤/æ’åº
- å»ºè®®å¯¹è¿™ä¸¤åˆ—å»ºå¤åˆç´¢å¼•

**å½±å“**:
- æŸ¥è¯¢æ€§èƒ½å·®
- æ•°æ®åº“å‹åŠ›å¤§

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# åœ¨models.pyä¸­æ·»åŠ ç´¢å¼•
from sqlalchemy import Index

class CustomerServiceQueue(Base):
    __tablename__ = "customer_service_queue"
    # ... å­—æ®µå®šä¹‰

# æ·»åŠ å¤åˆç´¢å¼•ï¼ˆé«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–ï¼‰
Index(
    "ix_customer_service_queue_status_queued_at",
    CustomerServiceQueue.status,
    CustomerServiceQueue.queued_at
)

# å…¶ä»–å¸¸ç”¨æŸ¥è¯¢çš„ç´¢å¼•
Index("ix_customer_service_queue_user_id", CustomerServiceQueue.user_id)  # ç”¨æˆ·æŸ¥è¯¢è‡ªå·±çš„æ’é˜ŸçŠ¶æ€
Index("ix_customer_service_queue_status", CustomerServiceQueue.status)  # æŒ‰çŠ¶æ€ç­›é€‰

# DDLè¿ç§»è„šæœ¬
"""
CREATE INDEX IF NOT EXISTS ix_customer_service_queue_status_queued_at 
ON customer_service_queue(status, queued_at);

CREATE INDEX IF NOT EXISTS ix_customer_service_queue_user_id 
ON customer_service_queue(user_id);

CREATE INDEX IF NOT EXISTS ix_customer_service_queue_status 
ON customer_service_queue(status);
"""
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­é˜Ÿåˆ—æŸ¥è¯¢ä½¿ç”¨statuså’Œqueued_atï¼Œä½†æœªæåˆ°ç´¢å¼•

---

#### 16. WebSocketå¿ƒè·³åªè§å‰ç«¯ä¾§æè¿° âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- æœåŠ¡ç«¯å¿ƒè·³/è¶…æ—¶å›æ”¶æœªæè¿°
- å»ºè®®æœåŠ¡ç«¯æ”¯æŒping/pongã€ç©ºé—²æ–­å¼€å’Œæ¶ˆæ¯åç§»é‡æ”¾ï¼Œé¿å…é‡è¿ä¸¢æ¶ˆæ¯

**å½±å“**:
- è¿æ¥å¯èƒ½å¼‚å¸¸æ–­å¼€
- æ¶ˆæ¯å¯èƒ½ä¸¢å¤±
- æ— æ³•æ¢å¤ä¼šè¯

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. æœåŠ¡ç«¯WebSocketå¿ƒè·³å¤„ç†ï¼ˆå®Œæ•´å®ç°ï¼‰
import asyncio
from fastapi import WebSocket, WebSocketDisconnect
from datetime import datetime, timedelta

# WebSocketè·¯ç”±æŒ‚è½½ç‚¹ï¼ˆç»Ÿä¸€æ—¶é—´æºï¼Œä½¿ç”¨get_utc_time()ï¼‰
@router.websocket("/api/ws/customer-service/chat/{chat_id}")
async def websocket_chat(
    websocket: WebSocket, 
    chat_id: str,
    current_user=Depends(get_current_user_secure_sync_csrf),
    db: Session = Depends(get_db)
):
    """
    WebSocketå®¢æœå¯¹è¯è¿æ¥
    ç»Ÿä¸€ä½¿ç”¨get_utc_time()ä½œä¸ºæ—¶é—´æºï¼Œæ”¯æŒå¿ƒè·³ã€ACKå’Œæ¶ˆæ¯åç§»é‡æ”¾
    """
    user_id = current_user.id
    await websocket.accept()
    
    # è®°å½•è¿æ¥
    active_connections[user_id] = {
        "websocket": websocket,
        "chat_id": chat_id,
        "last_pong": get_utc_time(),  # ç»Ÿä¸€ä½¿ç”¨UTC
        "last_message_id": 0
    }
    
    # å¿ƒè·³æ£€æµ‹å‚æ•°
    heartbeat_interval = 30  # æ¯30ç§’å‘é€ä¸€æ¬¡ping
    heartbeat_timeout = 60  # 60ç§’æ— å“åº”åˆ™æ–­å¼€
    from app.utils.time_utils import get_utc_time
    last_ping = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    last_pong = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
    
    # å‘é€æœªè¯»æ¶ˆæ¯ï¼ˆæ¶ˆæ¯åç§»é‡æ”¾ï¼‰
    await send_unread_messages(websocket, user_id, chat_id, db)
    
    try:
        # å¯åŠ¨å¿ƒè·³ä»»åŠ¡
        heartbeat_task = asyncio.create_task(
            send_heartbeat(websocket, heartbeat_interval)
        )
        
        while True:
            try:
                # è®¾ç½®æ¥æ”¶è¶…æ—¶
                message = await asyncio.wait_for(
                    websocket.receive_text(),
                    timeout=30.0  # 30ç§’è¶…æ—¶
                )
                
                data = json.loads(message)
                
                # å¤„ç†pingï¼ˆå®¢æˆ·ç«¯å‘æ¥çš„pingï¼‰
                if data.get("type") == "ping":
                    await websocket.send_text(json.dumps({"type": "pong"}))
                    last_pong = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
                    active_connections[user_id]["last_pong"] = last_pong
                    continue
                
                # å¤„ç†pongï¼ˆå®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯pingçš„å“åº”ï¼‰
                if data.get("type") == "pong":
                    last_pong = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
                    active_connections[user_id]["last_pong"] = last_pong
                    continue
                
                # å¤„ç†æ¶ˆæ¯ACK
                if data.get("type") == "message_ack":
                    message_id = data.get("message_id")
                    ack_type = data.get("ack_type")  # sent, delivered, read
                    await handle_message_ack(message_id, ack_type, db)
                    continue
                
                # å¤„ç†æ™®é€šæ¶ˆæ¯
                # ...
                
            except asyncio.TimeoutError:
                # è¶…æ—¶æ£€æŸ¥å¿ƒè·³
                time_since_last_pong = (get_utc_time() - last_pong).total_seconds()  # ç»Ÿä¸€ä½¿ç”¨UTC
                if time_since_last_pong > heartbeat_timeout:
                    raise WebSocketDisconnect("Heartbeat timeout")
                continue
                
    except WebSocketDisconnect:
        pass
    except Exception as e:
        logger.error(f"WebSocket error for user {user_id}: {e}")
    finally:
        # æ¸…ç†è¿æ¥
        heartbeat_task.cancel()
        if user_id in active_connections:
            del active_connections[user_id]

async def send_heartbeat(websocket: WebSocket, interval: int):
    """å®šæœŸå‘é€pingå¿ƒè·³"""
    while True:
        try:
            await asyncio.sleep(interval)
            await websocket.send_text(json.dumps({"type": "ping"}))
        except Exception:
            break

async def send_unread_messages(websocket: WebSocket, user_id: str, chat_id: str, db: Session):
    """å‘é€æœªè¯»æ¶ˆæ¯ï¼ˆæ¶ˆæ¯åç§»é‡æ”¾ï¼‰- ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´"""
    from app.utils.time_utils import get_utc_time  # ç»Ÿä¸€ä½¿ç”¨UTC
    
    # è·å–æœ€åè¯»å–çš„æ¶ˆæ¯ID
    offset = db.query(MessageOffset).filter(
        MessageOffset.user_id == user_id,
        MessageOffset.chat_id == chat_id
    ).first()
    
    last_message_id = offset.last_message_id if offset else 0
    
    # è·å–æœªè¯»æ¶ˆæ¯
    unread_messages = db.query(CustomerServiceMessage).filter(
        CustomerServiceMessage.chat_id == chat_id,
        CustomerServiceMessage.id > last_message_id
    ).order_by(CustomerServiceMessage.id.asc()).limit(100).all()  # é™åˆ¶æœ€å¤š100æ¡
    
    # å‘é€æœªè¯»æ¶ˆæ¯
    for msg in unread_messages:
        await websocket.send_text(json.dumps({
            "type": "message",
            "message": {
                "id": msg.id,
                "content": msg.content,
                "created_at": msg.created_at.isoformat(),
                "status": msg.status
            }
        }))
        
        # æ›´æ–°æ¶ˆæ¯åç§»ï¼ˆç»Ÿä¸€ä½¿ç”¨UTCï¼‰
        if offset:
            offset.last_message_id = msg.id
            offset.updated_at = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
        else:
            offset = MessageOffset(
                user_id=user_id,
                chat_id=chat_id,
                last_message_id=msg.id
            )
            db.add(offset)
    
    db.commit()

# 2. æ¶ˆæ¯åç§»é‡æ”¾
class MessageOffset(Base):
    __tablename__ = "message_offsets"
    id = Column(Integer, primary_key=True)
    user_id = Column(String(20), nullable=False)
    chat_id = Column(String(50), nullable=False)
    last_message_id = Column(Integer, nullable=False)
    updated_at = Column(DateTime(timezone=True), default=get_utc_time)  # ç»Ÿä¸€ä½¿ç”¨UTC

async def handle_reconnect(websocket: WebSocket, user_id: str, chat_id: str, db: Session):
    """å¤„ç†é‡è¿ï¼Œå‘é€æœªè¯»æ¶ˆæ¯ - ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´"""
    from app.utils.time_utils import get_utc_time  # ç»Ÿä¸€ä½¿ç”¨UTC
    
    # è·å–æœ€åè¯»å–çš„æ¶ˆæ¯ID
    offset = db.query(MessageOffset).filter(
        MessageOffset.user_id == user_id,
        MessageOffset.chat_id == chat_id
    ).first()
    
    last_message_id = offset.last_message_id if offset else 0
    
    # è·å–æœªè¯»æ¶ˆæ¯
    unread_messages = db.query(CustomerServiceMessage).filter(
        CustomerServiceMessage.chat_id == chat_id,
        CustomerServiceMessage.id > last_message_id
    ).order_by(CustomerServiceMessage.id.asc()).all()
    
    # å‘é€æœªè¯»æ¶ˆæ¯
    for msg in unread_messages:
        await websocket.send_text(json.dumps({
            "type": "message",
            "message": {
                "id": msg.id,
                "content": msg.content,
                "created_at": msg.created_at.isoformat()
            }
        }))
        
        # æ›´æ–°æ¶ˆæ¯åç§»ï¼ˆç»Ÿä¸€ä½¿ç”¨UTCï¼‰
        if offset:
            offset.last_message_id = msg.id
            offset.updated_at = get_utc_time()  # ç»Ÿä¸€ä½¿ç”¨UTC
        else:
            offset = MessageOffset(
                user_id=user_id,
                chat_id=chat_id,
                last_message_id=msg.id
            )
            db.add(offset)
    
    db.commit()
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­åªæåˆ°å‰ç«¯å¿ƒè·³ï¼Œæœªè¯´æ˜æœåŠ¡ç«¯å®ç°

---

#### 17. å–Šè¯æ–‡æ¡ˆç¡¬ç¼–ç &è¥ä¸šæ—¶é—´ç¼ºé…ç½® âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- "æš‚æ— åœ¨çº¿å®¢æœ""æ¯æ—¥8:00-18:00"åº”å¯é…ç½®ï¼ˆå¤šè¯­è¨€/èŠ‚å‡æ—¥ï¼‰
- ä¸æ—¶åŒºç­–ç•¥ä¸€è‡´ï¼Œå¦åˆ™å›½é™…åŒ–ä¼šé”™ä½

**å½±å“**:
- æ— æ³•å›½é™…åŒ–
- æ— æ³•é€‚åº”ä¸åŒæ—¶åŒº
- æ— æ³•å¤„ç†èŠ‚å‡æ—¥

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. ç³»ç»Ÿé…ç½®è¡¨
class SystemConfig(Base):
    __tablename__ = "system_configs"
    id = Column(Integer, primary_key=True)
    key = Column(String(100), unique=True, nullable=False)
    value = Column(Text, nullable=False)
    value_type = Column(String(20), default="string")  # string, json, number
    description = Column(Text, nullable=True)
    updated_at = Column(DateTime(timezone=True), default=get_utc_time)  # ç»Ÿä¸€ä½¿ç”¨UTC

# 2. å¤šè¯­è¨€æ¶ˆæ¯é…ç½®
class SystemMessage(Base):
    __tablename__ = "system_messages"
    id = Column(Integer, primary_key=True)
    message_key = Column(String(100), nullable=False)  # å¦‚ "no_available_service"
    language = Column(String(10), default="zh")  # zh, en
    content = Column(Text, nullable=False)
    updated_at = Column(DateTime(timezone=True), default=get_utc_time)  # ç»Ÿä¸€ä½¿ç”¨UTC

# 3. è¥ä¸šæ—¶é—´é…ç½®
class ServiceHours(Base):
    __tablename__ = "service_hours"
    id = Column(Integer, primary_key=True)
    day_of_week = Column(Integer, nullable=False)  # 0-6, 0=Monday
    start_time = Column(String(10), nullable=False)  # "08:00"
    end_time = Column(String(10), nullable=False)  # "18:00"
    timezone = Column(String(50), default="UTC")  # é»˜è®¤UTCï¼Œæ˜¾ç¤ºæ—¶å†è½¬æ¢
    is_holiday = Column(Integer, default=0)  # èŠ‚å‡æ—¥æ ‡è®°
    holiday_date = Column(Date, nullable=True)  # å…·ä½“èŠ‚å‡æ—¥æ—¥æœŸ

# 4. è·å–ç³»ç»Ÿæ¶ˆæ¯ï¼ˆä¿®å¤ï¼šæ·»åŠ dbå‚æ•°ï¼‰
def get_system_message(message_key: str, language: str = "zh", db: Session = None) -> str:
    """è·å–ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¤šè¯­è¨€ï¼‰"""
    if db is None:
        raise ValueError("db parameter is required")
    
    message = db.query(SystemMessage).filter(
        SystemMessage.message_key == message_key,
        SystemMessage.language == language
    ).first()
    
    return message.content if message else message_key

# 5. æ£€æŸ¥è¥ä¸šæ—¶é—´ï¼ˆä¿®å¤ï¼šæ·»åŠ dbå‚æ•°ï¼‰
def is_service_available(user_timezone: str = "Europe/London", db: Session = None) -> bool:
    """æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨è¥ä¸šæ—¶é—´å†…"""
    if db is None:
        raise ValueError("db parameter is required")
    
    from app.utils.time_utils import get_utc_time, to_user_timezone
    from zoneinfo import ZoneInfo  # Python 3.9+ æ¨èä½¿ç”¨zoneinfoæ›¿ä»£pytz
    
    # ä½¿ç”¨UTCæ—¶é—´è·å–å½“å‰æ—¶é—´ï¼Œç„¶åè½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºç”¨äºæ˜¾ç¤º
    now_utc = get_utc_time()
    user_tz = ZoneInfo(user_timezone)  # ä½¿ç”¨zoneinfoæ›¿ä»£pytz
    now = now_utc.astimezone(user_tz)  # è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºç”¨äºæ˜¾ç¤º
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯èŠ‚å‡æ—¥
    holiday = db.query(ServiceHours).filter(
        ServiceHours.holiday_date == now.date(),
        ServiceHours.is_holiday == 1
    ).first()
    
    if holiday:
        return False
    
    # æ£€æŸ¥å½“å¤©è¥ä¸šæ—¶é—´
    day_of_week = now.weekday()
    service_hours = db.query(ServiceHours).filter(
        ServiceHours.day_of_week == day_of_week,
        ServiceHours.is_holiday == 0
    ).first()
    
    if not service_hours:
        return False
    
    # è§£ææ—¶é—´
    from datetime import datetime
    start_time = datetime.strptime(service_hours.start_time, "%H:%M").time()
    end_time = datetime.strptime(service_hours.end_time, "%H:%M").time()
    current_time = now.time()
    
    return start_time <= current_time <= end_time
```

**è¯æ®ä½ç½®**:
- `backend/app/routers.py`: "æ¯æ—¥8:00-18:00"ç¡¬ç¼–ç 

---

#### 18. è¶…æ—¶è§„åˆ™é»˜è®¤2åˆ†é’Ÿå¯èƒ½è¿‡äºæ¿€è¿› âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
- å·²è§„åˆ’å¯é…ç½®
- å»ºè®®æŒ‰èŠå¤©é˜¶æ®µ/è§’è‰²åŒºåˆ†è¶…æ—¶é˜ˆå€¼ï¼Œå¹¶åœ¨å‰ç«¯æ˜¾ç¤ºå€’è®¡æ—¶ä¸å»¶é•¿æŒ‰é’®

**å½±å“**:
- ç”¨æˆ·ä½“éªŒå·®
- å¯èƒ½è¯¯ç»“æŸå¯¹è¯

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# 1. åˆ†é˜¶æ®µè¶…æ—¶é…ç½®
class ChatTimeoutConfig(Base):
    __tablename__ = "chat_timeout_configs"
    id = Column(Integer, primary_key=True)
    stage = Column(String(50), nullable=False)  # initial, active, idle
    timeout_minutes = Column(Integer, nullable=False)
    description = Column(Text, nullable=True)

# åˆå§‹é˜¶æ®µï¼š5åˆ†é’Ÿï¼ˆç”¨æˆ·åˆšè¿æ¥ï¼Œå¯èƒ½è¿˜åœ¨è¾“å…¥ï¼‰
# æ´»è·ƒé˜¶æ®µï¼š2åˆ†é’Ÿï¼ˆæœ‰æ¶ˆæ¯å¾€æ¥ï¼‰
# ç©ºé—²é˜¶æ®µï¼š10åˆ†é’Ÿï¼ˆé•¿æ—¶é—´æ— æ¶ˆæ¯ï¼‰

# 2. åŠ¨æ€è¶…æ—¶åˆ¤æ–­ï¼ˆç»Ÿä¸€ä½¿ç”¨UTCï¼‰
def get_chat_timeout_minutes(chat_id: str, db: Session) -> int:
    """æ ¹æ®å¯¹è¯é˜¶æ®µè¿”å›è¶…æ—¶æ—¶é—´"""
    from app.utils.time_utils import get_utc_time
    from datetime import timedelta
    
    chat = crud.get_customer_service_chat(db, chat_id)
    
    # è®¡ç®—æ¶ˆæ¯é¢‘ç‡ï¼ˆç»Ÿä¸€ä½¿ç”¨UTCï¼‰
    recent_messages = db.query(CustomerServiceMessage).filter(
        CustomerServiceMessage.chat_id == chat_id,
        CustomerServiceMessage.created_at >= get_utc_time() - timedelta(minutes=10)
    ).count()
    
    if recent_messages == 0:
        # åˆå§‹é˜¶æ®µæˆ–å®Œå…¨ç©ºé—²
        stage = "initial"
    elif recent_messages > 5:
        # æ´»è·ƒå¯¹è¯
        stage = "active"
    else:
        # ç©ºé—²é˜¶æ®µ
        stage = "idle"
    
    config = db.query(ChatTimeoutConfig).filter(
        ChatTimeoutConfig.stage == stage
    ).first()
    
    return config.timeout_minutes if config else 2
```

**è¯æ®ä½ç½®**:
- ä¼˜åŒ–æ—¥å¿—ä¸­é»˜è®¤2åˆ†é’Ÿï¼Œå·²è§„åˆ’å¯é…ç½®ä½†æœªè¯´æ˜åˆ†é˜¶æ®µç­–ç•¥

---

#### 19. æ–‡æ¡£å±‚é¢é—®é¢˜

**é—®é¢˜æè¿°**:
- "æœ€åæ›´æ–°ï¼š2024å¹´"è¿‡äºç¬¼ç»Ÿ
- å»ºè®®å†™åˆ°å…·ä½“æ—¥æœŸå¹¶ç»´æŠ¤å˜æ›´æ—¥å¿—ï¼ˆChangelogï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```markdown
---

*æœ€åæ›´æ–°ï¼š2024å¹´12æœˆ28æ—¥*
*ç»´æŠ¤è€…ï¼šå¼€å‘å›¢é˜Ÿ*

## å˜æ›´æ—¥å¿—

### 2024-12-28
- æ·»åŠ æœ€é«˜ä¼˜å…ˆçº§é—®é¢˜æ¸…å•
- å®Œå–„è·¯ç”±å‘½åè§„èŒƒè¯´æ˜
- æ·»åŠ æ—¶åŒºç»Ÿä¸€ç­–ç•¥
- è¡¥å……å®‰å…¨ç­–ç•¥è¯´æ˜

### 2024-12-27
- åˆå§‹ç‰ˆæœ¬
- æ·»åŠ å®¢æœåŠŸèƒ½æ¦‚è¿°
- æ·»åŠ ä¼˜åŒ–å»ºè®®
```
```

---

## ç«‹åˆ»å¯è½åœ°çš„ä¿®å¤åˆ—è¡¨

> **å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºæ¨è¿›ä¿®å¤å·¥ä½œï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§**

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ä¿®å¤ï¼ˆå¿…é¡»ä¼˜å…ˆï¼‰

#### 1. ç»Ÿä¸€æ—¶é—´ç­–ç•¥ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 2-3å¤©

**ä¿®å¤æ­¥éª¤**:
1. åˆ›å»º `get_utc_time()` å‡½æ•°æ›¿ä»£æ‰€æœ‰ `get_uk_time()`
2. æ›´æ–°æ‰€æœ‰æ¨¡å‹é»˜è®¤å€¼ä» `get_uk_time()` æ”¹ä¸º `get_utc_time()`
3. å…¨é¢æ›¿æ¢ `datetime.utcnow()` ä¸æœ¬åœ°åŒ–æ··ç”¨
4. æ‰€æœ‰æ—¶é—´è®¡ç®—ç»Ÿä¸€è½¬æ¢ä¸ºUTC
5. å‰ç«¯æ˜¾ç¤ºæ—¶å†è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒº
6. æ·»åŠ æ—¶åŒºè½¬æ¢å·¥å…·å‡½æ•°
7. æ•°æ®åº“è¿ç§»è„šæœ¬æ›´æ–°æ‰€æœ‰ç°æœ‰æ•°æ®

**å½±å“èŒƒå›´**:
- `backend/app/models.py`: æ‰€æœ‰æ—¶é—´å­—æ®µé»˜è®¤å€¼
- `backend/app/crud.py`: æ‰€æœ‰æ—¶é—´ç›¸å…³å‡½æ•°
- `backend/app/routers.py`: æ‰€æœ‰è¶…æ—¶åˆ¤æ–­å’Œè®¡ç®—
- å‰ç«¯æ—¶é—´æ˜¾ç¤ºç»„ä»¶

---

#### 2. è·¯ç”±ä¸æƒé™åˆ†å±‚ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 3-4å¤©

**ä¿®å¤æ­¥éª¤**:
1. **ç»Ÿä¸€è·¯ç”±å‰ç¼€**:
   - å®¢æœç«¯: `/api/customer-service/...`
   - ç”¨æˆ·ç«¯: `/api/user/customer-service/...`
   - å†…éƒ¨ä»»åŠ¡: æ”¹ä¸ºCeleryä»»åŠ¡æˆ– `/api/internal/...`

2. **ç»Ÿä¸€å‘½åé£æ ¼**:
   - èµ„æºè·¯å¾„ä½¿ç”¨åè¯å¤æ•°
   - åŠ¨ä½œç”¨å­èµ„æºæˆ–å‘½ä»¤å¼å­è·¯å¾„
   - ä¾‹å¦‚: `POST /chats/{id}/end` æ›¿ä»£ `/end-chat`

3. **å®šæ—¶ä»»åŠ¡ä¿æŠ¤**:
   - æ–¹æ¡ˆAï¼ˆæ¨èï¼‰: æ”¹ä¸ºCeleryå®šæ—¶ä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹
   - æ–¹æ¡ˆBï¼ˆä¸æ¨èï¼Œä»…ä¾›å†å²å‚è€ƒï¼‰: å¦‚æœå¿…é¡»ä¿ç•™ï¼Œæ·»åŠ IPç™½åå•ã€**ç­¾åéªŒè¯ï¼ˆéœ€è¦await request.body()ï¼‰**ã€é€Ÿç‡é™åˆ¶ã€å¹‚ç­‰æ€§æ£€æŸ¥
   - **æ³¨æ„**: FastAPIä¸­è·å–request.body()éœ€è¦awaitï¼Œå‡½æ•°å¿…é¡»ä½¿ç”¨`async def`ï¼Œå¦åˆ™æ— æ³•è·å–æ­£æ–‡å†…å®¹
   - âš ï¸ **å¼ºçƒˆå»ºè®®**: æ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ä½¿ç”¨Celeryï¼Œä¸è¦ä½¿ç”¨HTTPç«¯ç‚¹

4. **æƒé™éªŒè¯**:
   - æ‰€æœ‰ç”¨æˆ·ç«¯æ¥å£æ·»åŠ ç”¨æˆ·æƒé™éªŒè¯
   - æ‰€æœ‰å®¢æœç«¯æ¥å£æ·»åŠ å®¢æœæƒé™éªŒè¯
   - å†…éƒ¨æ¥å£æ·»åŠ ç®¡ç†å‘˜æƒé™æˆ–ç­¾åéªŒè¯

**å½±å“èŒƒå›´**:
- `backend/app/routers.py`: æ‰€æœ‰è·¯ç”±å®šä¹‰
- å‰ç«¯APIè°ƒç”¨: æ›´æ–°æ‰€æœ‰æ¥å£è·¯å¾„
- è®¤è¯ä¸­é—´ä»¶: æ·»åŠ æƒé™éªŒè¯é€»è¾‘

---

#### 3. è¡¥é½å®‰ä¿æªæ–½ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 2-3å¤©

**ä¿®å¤æ­¥éª¤**:
1. **CSRFé˜²æŠ¤**:
   - æ‰€æœ‰æµè§ˆå™¨æ€Cookieæ¥å£å¯ç”¨CSRFåŒé‡æäº¤éªŒè¯
   - ç”ŸæˆCSRF Tokenå¹¶è®¾ç½®åˆ°Cookieï¼ˆHttpOnlyï¼‰
   - å‰ç«¯è¯·æ±‚æ—¶åœ¨Headerä¸­æºå¸¦CSRF Token
   - åç«¯éªŒè¯Cookieå’ŒHeaderä¸­çš„Tokenæ˜¯å¦ä¸€è‡´

2. **Cookieå®‰å…¨æ ‡å¿—**:
   - æ‰€æœ‰Set-Cookieæ·»åŠ  `HttpOnly=True`
   - æ‰€æœ‰Set-Cookieæ·»åŠ  `Secure=True`ï¼ˆHTTPS onlyï¼‰
   - æ‰€æœ‰Set-Cookieæ·»åŠ  `SameSite=Lax` æˆ– `Strict`
   - ä¸è®¾ç½®domainï¼Œé¿å…è·¨åŸŸé—®é¢˜

3. **é€Ÿç‡é™åˆ¶å®ç°**:
   - å®ç° `rate_limit_messages` è£…é¥°å™¨ï¼ˆRedisæ»‘åŠ¨çª—å£ï¼‰
   - åº”ç”¨åˆ°æ‰€æœ‰æ¶ˆæ¯å‘é€æ¥å£
   - ç”¨æˆ·ç»´åº¦é™åˆ¶: 10æ¡/åˆ†é’Ÿ
   - IPç»´åº¦é™åˆ¶: 20æ¡/åˆ†é’Ÿï¼ˆæ›´å®½æ¾ï¼Œé˜²æ­¢ä»£ç†ç»•è¿‡ï¼‰
   - è¿”å›429çŠ¶æ€ç å’Œå‹å¥½é”™è¯¯ä¿¡æ¯

**å½±å“èŒƒå›´**:
- `backend/app/service_auth.py`: Cookieè®¾ç½®é€»è¾‘
- `backend/app/routers.py`: æ‰€æœ‰æ¶ˆæ¯å‘é€æ¥å£
- æ–°å¢: `backend/app/security.py`: CSRFå’Œé€Ÿç‡é™åˆ¶å·¥å…·

---

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®ä¸€è‡´æ€§ä¿®å¤

#### 4. èŠå¤©ç»“æŸè¯­ä¹‰å…¥åº“ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 1-2å¤©

**ä¿®å¤æ­¥éª¤**:
1. **æ‰©å±•CustomerServiceChatæ¨¡å‹**:
   ```python
   ended_reason = Column(String(50), nullable=True)  # timeout, user_ended, service_ended, auto_cleanup
   ended_by = Column(String(20), nullable=True)  # user_id, service_id, system
   ended_type = Column(String(20), nullable=True)  # user_inactive, service_inactive, manual, auto
   ```

2. **æ›´æ–°ç»“æŸå¯¹è¯å‡½æ•°**:
   - ä¿®æ”¹ `end_customer_service_chat()` å‡½æ•°ï¼Œæ·»åŠ reasonã€ended_byã€ended_typeå‚æ•°
   - æ‰€æœ‰è°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ä¼ å…¥æ­£ç¡®çš„ç»“æŸåŸå› 

3. **è¶…æ—¶ç»“æŸè®°å½•**:
   - è¶…æ—¶ç»“æŸå¯¹è¯æ—¶è°ƒç”¨ `get_chat_timeout_type()` åˆ¤æ–­ç±»å‹
   - è®°å½• `ended_type` ä¸º `user_inactive` æˆ– `service_inactive`

4. **æ•°æ®åº“è¿ç§»**:
   - åˆ›å»ºè¿ç§»è„šæœ¬æ·»åŠ æ–°å­—æ®µ
   - å¯é€‰: ä¸ºå†å²æ•°æ®å¡«å……é»˜è®¤å€¼

**å½±å“èŒƒå›´**:
- `backend/app/models.py`: CustomerServiceChatæ¨¡å‹
- `backend/app/crud.py`: end_customer_service_chatå‡½æ•°
- `backend/app/routers.py`: æ‰€æœ‰ç»“æŸå¯¹è¯çš„æ¥å£

---

#### 5. æ–‡ä»¶æ¶ˆæ¯é€šé“ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 2-3å¤©

**ä¿®å¤æ­¥éª¤**:
1. **æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹**:
   - åˆ›å»º `POST /customer-service/chat/{chat_id}/files`
   - æ–‡ä»¶ç±»å‹ç™½åå•éªŒè¯
   - æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå›¾ç‰‡5MBï¼Œæ–‡æ¡£10MBï¼‰
   - **æµå¼è¯»å–**ï¼Œé¿å…å¤§æ–‡ä»¶å å†…å­˜
   - **å®‰å…¨æ–‡ä»¶åç”Ÿæˆ**ï¼ˆUUID + ç™½åå•æ‰©å±•åï¼‰ï¼Œé˜²æ­¢è·¯å¾„æ³¨å…¥
   - ç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼Œéœ€è¦é›†æˆæœåŠ¡ï¼‰
   - å†…å®¹å®¡æ ¸ï¼ˆå¯é€‰ï¼Œéœ€è¦é›†æˆæœåŠ¡ï¼‰

2. **æ–‡ä»¶å­˜å‚¨**:
   - ä¿å­˜åˆ°ç§æœ‰å­˜å‚¨ï¼ˆS3/OSSç­‰ï¼‰ï¼Œä½¿ç”¨æµå¼ä¸Šä¼ 
   - ç”Ÿæˆç­¾åURLï¼ˆæœ‰æ•ˆæœŸ24å°æ—¶ï¼‰
   - æ–‡ä»¶ä¸å¯¹è¯æƒé™ç»‘å®š
   - **ä¸ç›´æ¥ä½¿ç”¨ç”¨æˆ·æ–‡ä»¶å**ï¼Œä½¿ç”¨å®‰å…¨ç”Ÿæˆçš„æ–‡ä»¶å

3. **æ¶ˆæ¯ç±»å‹ç»Ÿä¸€**:
   - åç«¯æ”¯æŒ: text, image, file, task_share, system
   - å‰ç«¯æ¶ˆæ¯ç±»å‹ä¸åç«¯åè®®å¯¹é½
   - æ–‡ä»¶æ¶ˆæ¯å†…å®¹æ ¼å¼: JSONåŒ…å«file_id, safe_filename, original_filename, content_type, size
   - **æ³¨æ„**: UploadFileæ²¡æœ‰sizeå±æ€§ï¼Œéœ€è¦é€šè¿‡æµå¼è¯»å–è·å–å®é™…å¤§å°

**å½±å“èŒƒå›´**:
- `backend/app/routers.py`: æ–°å¢æ–‡ä»¶ä¸Šä¼ æ¥å£
- `backend/app/models.py`: æ¶ˆæ¯ç±»å‹æšä¸¾
- å‰ç«¯: æ–‡ä»¶ä¸Šä¼ ç»„ä»¶å’Œæ¶ˆæ¯æ˜¾ç¤º

---

#### 6. AdminRequestæ¨¡å‹å¯¹é½ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 1å¤©

**ä¿®å¤æ­¥éª¤**:
1. **ç»Ÿä¸€IDé•¿åº¦**:
   - æ–¹æ¡ˆ1: ç»Ÿä¸€ä¸ºString(20)
   - æ–¹æ¡ˆ2ï¼ˆæ¨èï¼‰: ç»Ÿä¸€ä¸ºString(36)ï¼ˆUUIDæ ¼å¼ï¼‰
   - **å¿…é¡»ç»Ÿä¸€**ï¼Œé¿å…å¤–é”®çº¦æŸå’Œç´¢å¼•æ··ä¹±

2. **é™„ä»¶å­˜å‚¨ç­–ç•¥**:
   - å®ç°é™„ä»¶ä¸Šä¼ æ¥å£ï¼ˆå‚è€ƒç¬¬5é¡¹ï¼‰
   - é™„ä»¶ä¸ç”³è¯·æƒé™ç»‘å®š
   - ç”Ÿæˆç­¾åURLè®¿é—®
   - **ä½¿ç”¨å®‰å…¨æ–‡ä»¶å**ï¼Œä¸ç›´æ¥ä½¿ç”¨ç”¨æˆ·æ–‡ä»¶å

3. **å®ç°ç”³è¯·è¯¦æƒ…é™„ä»¶API**:
   - `GET /customer-service/admin-requests/{request_id}/attachments`
   - æƒé™éªŒè¯: åªæœ‰ç”³è¯·è€…æˆ–ç®¡ç†å‘˜å¯è®¿é—®

**å½±å“èŒƒå›´**:
- `backend/app/models.py`: AdminRequestæ¨¡å‹
- `backend/app/routers.py`: é™„ä»¶ç›¸å…³æ¥å£
- æ•°æ®åº“è¿ç§»: æ›´æ–°å­—æ®µé•¿åº¦

---

### ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–

#### 7. åˆ—è¡¨æŸ¥è¯¢å»N+1 âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 1å¤©

**ä¿®å¤æ­¥éª¤**:
1. **å–æ¶ˆå®¡æ ¸åˆ—è¡¨ä¼˜åŒ–**:
   - ä½¿ç”¨ `joinedload` é¢„åŠ è½½taskå’Œrequester
   - æ‰¹é‡å¤„ç†ï¼Œé¿å…é‡å¤æŸ¥è¯¢
   - ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®

2. **æ·»åŠ å¿…è¦ç´¢å¼•**:
   - é˜Ÿåˆ—è¡¨: `(status, queued_at)` å¤åˆç´¢å¼•
   - é˜Ÿåˆ—è¡¨: `user_id` ç´¢å¼•
   - é˜Ÿåˆ—è¡¨: `status` ç´¢å¼•
   - å–æ¶ˆè¯·æ±‚è¡¨: `(status, created_at)` å¤åˆç´¢å¼•

**å½±å“èŒƒå›´**:
- `backend/app/routers.py`: cs_get_cancel_requestså‡½æ•°
- `backend/app/models.py`: æ·»åŠ ç´¢å¼•å®šä¹‰
- æ•°æ®åº“: åˆ›å»ºç´¢å¼•

---

#### 8. WebSocketåç«¯å¿ƒè·³ä¸é‡æ”¾ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 2-3å¤©

**ä¿®å¤æ­¥éª¤**:
1. **æœåŠ¡ç«¯å¿ƒè·³**ï¼ˆå¿…é¡»å®ç°ï¼‰:
   - å®ç°ping/pongæœºåˆ¶
   - å®šæœŸå‘é€pingï¼ˆæ¯30ç§’ï¼‰
   - 30ç§’æ¥æ”¶è¶…æ—¶æ£€æµ‹
   - 60ç§’æ— å“åº”è‡ªåŠ¨æ–­å¼€
   - **æ–‡æ¡£ä¸­åªæœ‰å‰ç«¯å¿ƒè·³æè¿°ï¼Œåç«¯å¿…é¡»è¡¥å……å®ç°**

2. **æ¶ˆæ¯åç§»é‡æ”¾**ï¼ˆå¿…é¡»å®ç°ï¼‰:
   - åˆ›å»ºMessageOffsetæ¨¡å‹
   - è®°å½•ç”¨æˆ·æœ€åè¯»å–çš„æ¶ˆæ¯ID
   - é‡è¿æ—¶å‘é€æœªè¯»æ¶ˆæ¯ï¼ˆé™åˆ¶æœ€å¤š100æ¡ï¼‰
   - **é¿å…é‡è¿ä¸¢æ¶ˆæ¯**

3. **ä¼šè¯æ¢å¤**:
   - åŸºäºæœ€åæ¶ˆæ¯IDæ¢å¤
   - å‘é€æœªè¯»æ¶ˆæ¯åˆ—è¡¨
   - æ›´æ–°æ¶ˆæ¯åç§»
   - **å®Œæ•´å®ç°æ¶ˆæ¯å››æ€æµè½¬**ï¼ˆsending -> sent -> delivered -> readï¼‰

**å½±å“èŒƒå›´**:
- `backend/app/websocket.py`: WebSocketå¤„ç†é€»è¾‘
- `backend/app/models.py`: MessageOffsetæ¨¡å‹
- å‰ç«¯: é‡è¿é€»è¾‘ä¼˜åŒ–

---

### ç¬¬å››é˜¶æ®µï¼šåŠŸèƒ½å®Œå–„

#### 9. æ•æ„Ÿè¯è¿‡æ»¤å¢å¼º âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**é¢„è®¡å·¥æ—¶**: 1-2å¤©

**ä¿®å¤æ­¥éª¤**:
1. **å®ç°SensitiveWordFilterç±»**:
   - åŸºäºè¯å…¸+æ­£åˆ™+æ¨¡ç³ŠåŒ¹é…
   - æ”¯æŒå¤§å°å†™ã€ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦å˜ä½“
   - è¿”å›è¿‡æ»¤åå†…å®¹ã€æ˜¯å¦åŒ…å«æ•æ„Ÿè¯ã€åŒ¹é…è¯åˆ—è¡¨

2. **åº”ç”¨åˆ°æ¶ˆæ¯å‘é€**:
   - æ‰€æœ‰æ¶ˆæ¯å‘é€æ¥å£æ·»åŠ æ•æ„Ÿè¯è¿‡æ»¤
   - è®°å½•åŒ…å«æ•æ„Ÿè¯çš„æ¶ˆæ¯æ—¥å¿—
   - å¯é€‰: å‘é€è­¦å‘Šé€šçŸ¥

**å½±å“èŒƒå›´**:
- æ–°å¢: `backend/app/content_filter.py`
- `backend/app/routers.py`: æ‰€æœ‰æ¶ˆæ¯å‘é€æ¥å£

---

#### 10. è®¾å¤‡æŒ‡çº¹/IPç»‘å®šç­–ç•¥å®Œå–„ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**é¢„è®¡å·¥æ—¶**: 2-3å¤©

**ä¿®å¤æ­¥éª¤**:
1. **è®¾å¤‡å˜æ›´å¤„ç†**:
   - å…è®¸è®¾å¤‡å˜æ›´ï¼ˆå¯é…ç½®ï¼‰
   - è®°å½•è®¾å¤‡å˜æ›´å†å²
   - è¶…è¿‡å…è®¸æ¬¡æ•°éœ€è¦é¢å¤–éªŒè¯

2. **ç”³è¯‰æµç¨‹**:
   - åˆ›å»ºè®¾å¤‡å˜æ›´ç”³è¯‰æ¥å£
   - é€šçŸ¥ç®¡ç†å‘˜å¤„ç†
   - 24å°æ—¶å†…å¤„ç†ç”³è¯‰

3. **æ•°æ®ä¿ç•™ä¸è„±æ•**:
   - 90å¤©åè„±æ•
   - 180å¤©ååˆ é™¤
   - è„±æ•IPå’Œè®¾å¤‡æŒ‡çº¹

**å½±å“èŒƒå›´**:
- `backend/app/models.py`: DeviceChangeHistory, DeviceAppealæ¨¡å‹
- `backend/app/routers.py`: è®¾å¤‡å˜æ›´å’Œç”³è¯‰æ¥å£
- å®šæ—¶ä»»åŠ¡: æ•°æ®è„±æ•ä»»åŠ¡

---

#### 11. é˜Ÿåˆ—ç­‰å¾…æ—¶é—´åŠ¨æ€è®¡ç®— âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**é¢„è®¡å·¥æ—¶**: 1å¤©

**ä¿®å¤æ­¥éª¤**:
1. **å®ç°åŠ¨æ€è®¡ç®—å‡½æ•°**:
   - è·å–æœ€è¿‘100ä¸ªå·²åˆ†é…å¯¹è¯çš„å¹³å‡å¤„ç†æ—¶é•¿
   - è€ƒè™‘å½“å‰åœ¨çº¿å®¢æœæ•°é‡
   - åŠ¨æ€è°ƒæ•´ç­‰å¾…æ—¶é—´

2. **åº”ç”¨åˆ°é˜Ÿåˆ—çŠ¶æ€æŸ¥è¯¢**:
   - æ›´æ–° `get_queue_status` æ¥å£
   - è¿”å›æ›´å‡†ç¡®çš„é¢„è®¡ç­‰å¾…æ—¶é—´

**å½±å“èŒƒå›´**:
- `backend/app/routers.py`: get_queue_statuså‡½æ•°
- å‰ç«¯: æ˜¾ç¤ºæ›´å‡†ç¡®çš„ç­‰å¾…æ—¶é—´

---

#### 12. ç³»ç»Ÿæ¶ˆæ¯å’Œè¥ä¸šæ—¶é—´é…ç½®åŒ– âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**é¢„è®¡å·¥æ—¶**: 2-3å¤©

**ä¿®å¤æ­¥éª¤**:
1. **åˆ›å»ºé…ç½®è¡¨**:
   - SystemConfig: ç³»ç»Ÿé…ç½®
   - SystemMessage: å¤šè¯­è¨€æ¶ˆæ¯
   - ServiceHours: è¥ä¸šæ—¶é—´é…ç½®

2. **å®ç°é…ç½®ç®¡ç†**:
   - è·å–ç³»ç»Ÿæ¶ˆæ¯å‡½æ•°ï¼ˆå¤šè¯­è¨€ï¼‰
   - æ£€æŸ¥è¥ä¸šæ—¶é—´å‡½æ•°ï¼ˆè€ƒè™‘æ—¶åŒºå’ŒèŠ‚å‡æ—¥ï¼‰

3. **æ›¿æ¢ç¡¬ç¼–ç **:
   - æ‰€æœ‰ç¡¬ç¼–ç çš„ç³»ç»Ÿæ¶ˆæ¯æ”¹ä¸ºä»æ•°æ®åº“è¯»å–
   - æ‰€æœ‰ç¡¬ç¼–ç çš„è¥ä¸šæ—¶é—´æ”¹ä¸ºä»æ•°æ®åº“è¯»å–

**å½±å“èŒƒå›´**:
- `backend/app/models.py`: æ–°å¢é…ç½®æ¨¡å‹
- `backend/app/routers.py`: æ‰€æœ‰ä½¿ç”¨ç¡¬ç¼–ç æ¶ˆæ¯çš„åœ°æ–¹
- ç®¡ç†åå°: é…ç½®ç®¡ç†ç•Œé¢ï¼ˆå¯é€‰ï¼‰

---

#### 13. åˆ†é˜¶æ®µè¶…æ—¶é…ç½® âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**é¢„è®¡å·¥æ—¶**: 1-2å¤©

**ä¿®å¤æ­¥éª¤**:
1. **åˆ›å»ºè¶…æ—¶é…ç½®è¡¨**:
   - ChatTimeoutConfig: åˆ†é˜¶æ®µè¶…æ—¶é…ç½®
   - åˆå§‹é˜¶æ®µ: 5åˆ†é’Ÿï¼ˆç”¨æˆ·åˆšè¿æ¥ï¼Œå¯èƒ½è¿˜åœ¨è¾“å…¥ï¼‰
   - æ´»è·ƒé˜¶æ®µ: 2åˆ†é’Ÿï¼ˆæœ‰æ¶ˆæ¯å¾€æ¥ï¼‰
   - ç©ºé—²é˜¶æ®µ: 10åˆ†é’Ÿï¼ˆé•¿æ—¶é—´æ— æ¶ˆæ¯ï¼‰
   - **é»˜è®¤2åˆ†é’Ÿå¯èƒ½è¿‡äºæ¿€è¿›**ï¼Œéœ€è¦åˆ†é˜¶æ®µé…ç½®

2. **åŠ¨æ€è¶…æ—¶åˆ¤æ–­**:
   - æ ¹æ®æ¶ˆæ¯é¢‘ç‡åˆ¤æ–­å¯¹è¯é˜¶æ®µ
   - è¿”å›å¯¹åº”é˜¶æ®µçš„è¶…æ—¶æ—¶é—´
   - **æ‰€æœ‰æ—¶é—´è®¡ç®—ä½¿ç”¨UTC**

3. **å‰ç«¯å€’è®¡æ—¶**:
   - æ˜¾ç¤ºå€’è®¡æ—¶
   - æä¾›å»¶é•¿æŒ‰é’®ï¼ˆå¯é€‰ï¼‰

**å½±å“èŒƒå›´**:
- `backend/app/models.py`: ChatTimeoutConfigæ¨¡å‹
- `backend/app/routers.py`: è¶…æ—¶åˆ¤æ–­é€»è¾‘
- å‰ç«¯: å€’è®¡æ—¶æ˜¾ç¤º

---

### ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | ä¿®å¤é¡¹ | é¢„è®¡å·¥æ—¶ | çŠ¶æ€ |
|--------|--------|----------|------|
| ğŸ”´ğŸ”´ | 1. ç»Ÿä¸€æ—¶é—´ç­–ç•¥ | 2-3å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ğŸ”´ | 2. è·¯ç”±ä¸æƒé™åˆ†å±‚ | 3-4å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ğŸ”´ | 3. è¡¥é½å®‰ä¿æªæ–½ | 2-3å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ğŸ”´ | 4. èŠå¤©ç»“æŸè¯­ä¹‰å…¥åº“ | 1-2å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ğŸ”´ | 5. æ–‡ä»¶æ¶ˆæ¯é€šé“ | 2-3å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ğŸ”´ | 6. AdminRequestæ¨¡å‹å¯¹é½ | 1å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ğŸ”´ | 7. åˆ—è¡¨æŸ¥è¯¢å»N+1 | 1å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ğŸ”´ | 8. WebSocketåç«¯å¿ƒè·³ä¸é‡æ”¾ | 2-3å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ | 9. æ•æ„Ÿè¯è¿‡æ»¤å¢å¼º | 1-2å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ | 10. è®¾å¤‡æŒ‡çº¹/IPç»‘å®šç­–ç•¥å®Œå–„ | 2-3å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ | 11. é˜Ÿåˆ—ç­‰å¾…æ—¶é—´åŠ¨æ€è®¡ç®— | 1å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ | 12. ç³»ç»Ÿæ¶ˆæ¯å’Œè¥ä¸šæ—¶é—´é…ç½®åŒ– | 2-3å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |
| ğŸ”´ | 13. åˆ†é˜¶æ®µè¶…æ—¶é…ç½® | 1-2å¤© | âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ |

**æ€»è®¡é¢„è®¡å·¥æ—¶**: 27-38å¤©ï¼ˆæŒ‰å•äººè®¡ç®—ï¼Œå¯å¹¶è¡Œå¼€å‘ï¼‰

---

#### 16. å¹¶å‘åˆ†é…"åŒåˆ†é…"é—®é¢˜ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ æœ€é«˜
**é¢„è®¡å·¥æ—¶**: 1-2å¤©

**é—®é¢˜æè¿°**:
- é˜Ÿåˆ—å¤„ç†ä»»åŠ¡é€æ¡æŸ¥è¯¢â†’é€æ¡ commit()ï¼ˆå·²æ”¹ä¸ºCeleryä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹ï¼‰
- æ²¡æœ‰ä»»ä½•è¡Œçº§é”æˆ–ä¹è§‚å¹¶å‘æ§åˆ¶
- ä¸¤æ¬¡å¹¶å‘æ‰§è¡Œå®¹æ˜“æŠŠåŒä¸€ç”¨æˆ·åˆ†ç»™ä¸¤ä¸ªå®¢æœ

**ä¿®å¤æ­¥éª¤**:
1. **ä½¿ç”¨äº‹åŠ¡å’Œè¡Œçº§é”**:
   - æ‰¹é‡è·å–å¾…åˆ†é…è®°å½•ï¼ˆ`with_for_update(skip_locked=True)`ï¼‰
   - åœ¨äº‹åŠ¡å†…æŸ¥æ‰¾å¯ç”¨å®¢æœï¼ˆå¸¦é”ï¼‰
   - åŒé‡æ£€æŸ¥å®¹é‡ï¼Œé˜²æ­¢ç«æ€
   - æ•´ä¸ªåˆ†é…è¿‡ç¨‹åœ¨äº‹åŠ¡å†…å®Œæˆ

2. **æˆ–ä½¿ç”¨ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰**:
   - æ·»åŠ  `version` å­—æ®µåˆ° `CustomerServiceQueue`
   - æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·ï¼Œå¤±è´¥åˆ™è·³è¿‡

**å½±å“èŒƒå›´**:
- `backend/app/routers.py`: process_customer_service_queueå‡½æ•°
- `backend/app/models.py`: CustomerServiceQueueæ¨¡å‹ï¼ˆå¦‚ä½¿ç”¨ä¹è§‚é”ï¼‰

**è¯¦ç»†å®ç°**: è§"ä¼˜åŒ–å»ºè®® -> åŠŸèƒ½ä¼˜åŒ– -> 1. å®¢æœåˆ†é…ç­–ç•¥ä¼˜åŒ–ï¼ˆå«æ’é˜Ÿç³»ç»Ÿï¼‰"

---

#### 17. "æ­£åœ¨è¾“å…¥"äº‹ä»¶å¤„ç† âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**é¢„è®¡å·¥æ—¶**: 1å¤©

**é—®é¢˜æè¿°**:
- å‰ç«¯æœ‰typingå‘é€é€»è¾‘ï¼Œä½†åç«¯æ²¡æœ‰å¯¹åº”WSäº‹ä»¶å¤„ç†/å¹¿æ’­
- å»ºè®®ç»Ÿä¸€äº‹ä»¶åè®®å¹¶åœ¨æœåŠ¡ç«¯è½¬å‘ï¼ˆå¯é™æµï¼‰

**ä¿®å¤æ­¥éª¤**:
1. **WebSocketäº‹ä»¶å¤„ç†**:
   - æ·»åŠ  `typing` äº‹ä»¶ç±»å‹å¤„ç†
   - é™æµï¼šæ¯ä¸ªç”¨æˆ·æ¯5ç§’æœ€å¤šå‘é€ä¸€æ¬¡typingäº‹ä»¶
   - é€šè¿‡WebSocketå¹¿æ’­ç»™å¯¹è¯å¦ä¸€æ–¹

2. **äº‹ä»¶åè®®ç»Ÿä¸€**:
   ```json
   {
     "type": "typing",
     "chat_id": "xxx",
     "user_id": "xxx",
     "is_typing": true
   }
   ```

**å½±å“èŒƒå›´**:
- `backend/app/websocket.py`: WebSocketå¤„ç†é€»è¾‘
- å‰ç«¯: typingäº‹ä»¶å‘é€é€»è¾‘

**è¯¦ç»†å®ç°**: è§"æœ€é«˜ä¼˜å…ˆçº§é—®é¢˜ -> 16. WebSocketå¿ƒè·³åªè§å‰ç«¯ä¾§æè¿°"ä¸­çš„ `handle_typing_event` å‡½æ•°

---

#### 18. Pydanticå…¥å‚æ ¡éªŒ âš¡ ç«‹å³ä¿®å¤
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**é¢„è®¡å·¥æ—¶**: 1å¤©

**é—®é¢˜æè¿°**:
- å¤šå¤„ `message_data: dict = Body(...)`ï¼Œç¼ºå­—æ®µçº§æ ¡éªŒ/é»˜è®¤å€¼/æšä¸¾é™åˆ¶
- å»ºè®®å®šä¹‰ `SendMessagePayload` ä¸ `MessageType` æšä¸¾ï¼Œé…åˆ `constr(max_length=...)`ã€`HttpUrl` ç­‰åšå¼ºæ ¡éªŒ

**ä¿®å¤æ­¥éª¤**:
1. **å®šä¹‰Pydanticæ¨¡å‹**:
   ```python
   from pydantic import BaseModel, Field, HttpUrl, constr
   from enum import Enum
   
   class MessageType(str, Enum):
       TEXT = "text"
       IMAGE = "image"
       FILE = "file"
       TASK_SHARE = "task_share"
       SYSTEM = "system"
   
   class SendMessagePayload(BaseModel):
       content: constr(max_length=5000) = Field(..., description="æ¶ˆæ¯å†…å®¹ï¼Œæœ€å¤§5000å­—ç¬¦")
       type: MessageType = Field(MessageType.TEXT, description="æ¶ˆæ¯ç±»å‹")
       task_id: Optional[int] = Field(None, description="å…³è”ä»»åŠ¡IDï¼ˆtask_shareç±»å‹æ—¶å¿…å¡«ï¼‰")
       file_id: Optional[str] = Field(None, description="æ–‡ä»¶IDï¼ˆfile/imageç±»å‹æ—¶å¿…å¡«ï¼‰")
       file_url: Optional[HttpUrl] = Field(None, description="æ–‡ä»¶URLï¼ˆfile/imageç±»å‹æ—¶å¿…å¡«ï¼‰")
   ```

2. **åº”ç”¨åˆ°æ‰€æœ‰æ¶ˆæ¯å‘é€æ¥å£**:
   - æ›¿æ¢ `dict = Body(...)` ä¸º `SendMessagePayload`
   - è‡ªåŠ¨è·å¾—å­—æ®µæ ¡éªŒã€ç±»å‹æ£€æŸ¥ã€é»˜è®¤å€¼

**å½±å“èŒƒå›´**:
- `backend/app/schemas.py`: æ–°å¢Pydanticæ¨¡å‹
- `backend/app/routers.py`: æ‰€æœ‰æ¶ˆæ¯å‘é€æ¥å£

**è¯¦ç»†å®ç°**: è§"æœ€é«˜ä¼˜å…ˆçº§é—®é¢˜ -> 11. èŠå¤©æ¶ˆæ¯çŠ¶æ€"ä¸­çš„Pydanticæ¨¡å‹å®šä¹‰

---

### ğŸ”´ é«˜ä¼˜å…ˆçº§

1. **å®¢æœåˆ†é…æ’é˜Ÿç³»ç»Ÿ**
   - é—®é¢˜ï¼šå½“æ‰€æœ‰å®¢æœéƒ½æ»¡è½½æ—¶ï¼Œç”¨æˆ·ç›´æ¥æ”¶åˆ°é”™è¯¯ï¼Œæ— æ³•æ’é˜Ÿç­‰å¾…
   - å½±å“ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œå¯èƒ½æµå¤±ç”¨æˆ·
   - çŠ¶æ€ï¼šå¾…å®ç°
   - ä¼˜å…ˆçº§ï¼šæœ€é«˜ï¼ˆå»ºè®®ä¼˜å…ˆå®ç°ï¼‰

2. **WebSocketè¿æ¥ç¨³å®šæ€§**
   - é—®é¢˜ï¼šè¿æ¥å¯èƒ½æ„å¤–æ–­å¼€
   - å½±å“ï¼šå®æ—¶æ¶ˆæ¯å¯èƒ½ä¸¢å¤±
   - çŠ¶æ€ï¼šå¾…ä¿®å¤

3. **æ¶ˆæ¯å·²è¯»çŠ¶æ€åŒæ­¥**
   - é—®é¢˜ï¼šå·²è¯»çŠ¶æ€å¯èƒ½ä¸åŒæ­¥
   - å½±å“ï¼šç”¨æˆ·ä½“éªŒä¸ä½³
   - çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

1. **å®¢æœé¡µé¢ç”¨æˆ·å¯¹è¯åŠŸèƒ½ç¼ºå¤±**
   - é—®é¢˜ï¼šæ²¡æœ‰å¿«æ·å›å¤ã€å¸¸ç”¨æ¨¡æ¿ã€å…³é”®è¯è‡ªåŠ¨å¡«å……åŠŸèƒ½
   - å½±å“ï¼šå®¢æœå·¥ä½œæ•ˆç‡ä½ï¼Œå›å¤é€Ÿåº¦æ…¢ï¼Œå›å¤å†…å®¹ä¸ä¸€è‡´
   - çŠ¶æ€ï¼šå¾…å®ç°å¿«æ·å›å¤å’Œæ¨¡æ¿åŠŸèƒ½
   - è¯¦æƒ…ï¼šå®¢æœéœ€è¦æ‰‹åŠ¨è¾“å…¥æ‰€æœ‰å›å¤ï¼Œæ— æ³•å¿«é€Ÿå“åº”å¸¸è§é—®é¢˜

2. **ç”¨æˆ·ç«¯å®¢æœèŠå¤©æ¡†åŠŸèƒ½ç¼ºå¤±**
   - é—®é¢˜ï¼šä¸æ”¯æŒå‘é€ä»»åŠ¡ç›¸å…³ä¿¡æ¯ï¼Œæ— æ³•åˆ†äº«ä»»åŠ¡ç»™å®¢æœ
   - å½±å“ï¼šç”¨æˆ·å’¨è¯¢ä»»åŠ¡é—®é¢˜æ—¶ä½“éªŒä¸ä½³ï¼Œéœ€è¦æ‰‹åŠ¨æè¿°
   - çŠ¶æ€ï¼šå¾…å®ç°ä»»åŠ¡åˆ†äº«åŠŸèƒ½

3. **å®¢æœä¸ç®¡ç†å‘˜å¯¹è¯ç³»ç»ŸåŠŸèƒ½ä¸è¶³**
   - é—®é¢˜ï¼šå…¨å±€èŠå¤©å®¤è®¾è®¡ï¼Œæ²¡æœ‰ç§èŠã€å®æ—¶é€šçŸ¥ã€æ¶ˆæ¯å·²è¯»çŠ¶æ€
   - å½±å“ï¼šæ²Ÿé€šæ•ˆç‡ä½ï¼Œæ¶ˆæ¯æ··ä¹±
   - çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

4. **å®¢æœå‘ç®¡ç†å‘˜ç”³è¯·åŠŸèƒ½ä¸å®Œå–„**
   - é—®é¢˜ï¼šæ²¡æœ‰é™„ä»¶æ”¯æŒã€å…³è”åŠŸèƒ½ã€æ¨¡æ¿åŠŸèƒ½
   - å½±å“ï¼šç”³è¯·æäº¤æ•ˆç‡ä½ï¼Œä¿¡æ¯ä¸å®Œæ•´
   - çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

5. **å®¢æœå–æ¶ˆå®¡æ ¸åŠŸèƒ½ç¼ºå¤±**
   - é—®é¢˜ï¼šæ²¡æœ‰ç­›é€‰ã€æœç´¢ã€æ‰¹é‡æ“ä½œã€ç»Ÿè®¡åŠŸèƒ½
   - å½±å“ï¼šå®¡æ ¸æ•ˆç‡ä½ï¼Œéš¾ä»¥ç®¡ç†å¤§é‡è¯·æ±‚
   - çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

6. **å¯¹è¯è¶…æ—¶è‡ªåŠ¨ç»“æŸåŠŸèƒ½**
   - é—®é¢˜ï¼šéœ€è¦å®¢æœæ‰‹åŠ¨è§¦å‘ï¼Œæ²¡æœ‰è‡ªåŠ¨æ£€æµ‹å’Œç»“æŸæœºåˆ¶
   - å½±å“ï¼šè¶…æ—¶å¯¹è¯å¯èƒ½é•¿æœŸå ç”¨èµ„æºï¼Œç”¨æˆ·ä½“éªŒä¸ä½³
   - çŠ¶æ€ï¼šâœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ
   - è¯¦æƒ…ï¼š
     - æ–‡æ¡£å·²æä¾›å®Œæ•´å®ç°æ–¹æ¡ˆï¼ˆCeleryä»»åŠ¡ï¼Œä¸å¯¹å¤–æš´éœ²HTTPç«¯ç‚¹ï¼‰
     - åŒ…å«è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯ã€å‘é€è¶…æ—¶é¢„è­¦ã€æ¸…ç†é•¿æœŸæ— æ´»åŠ¨å¯¹è¯ä¸‰ä¸ªå†…éƒ¨ä»»åŠ¡
     - ä»£ç å®ç°å¾…å®Œæˆ

7. **å®¢æœåˆ†é…è´Ÿè½½ä¸å‡è¡¡**
   - é—®é¢˜ï¼šéšæœºåˆ†é…å¯èƒ½å¯¼è‡´è´Ÿè½½ä¸å‡
   - å½±å“ï¼šéƒ¨åˆ†å®¢æœå·¥ä½œå‹åŠ›å¤§
   - çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

8. **å¯¹è¯å†å²æŸ¥è¯¢æ€§èƒ½**
   - é—®é¢˜ï¼šå¤§é‡æ¶ˆæ¯æ—¶æŸ¥è¯¢è¾ƒæ…¢
   - å½±å“ï¼šç”¨æˆ·ä½“éªŒ
   - çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

1. **ç§»åŠ¨ç«¯é€‚é…**
   - é—®é¢˜ï¼šç§»åŠ¨ç«¯ä½“éªŒå¯èƒ½ä¸å¤Ÿå¥½
   - å½±å“ï¼šç§»åŠ¨ç”¨æˆ·ä½¿ç”¨ä½“éªŒ
   - çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

2. **å¤šè¯­è¨€æ”¯æŒ**
   - é—®é¢˜ï¼šå®¢æœå¯¹è¯å¯èƒ½ä¸æ”¯æŒå¤šè¯­è¨€
   - å½±å“ï¼šå›½é™…åŒ–ç”¨æˆ·
   - çŠ¶æ€ï¼šå¾…å®ç°

---

## æŠ€æœ¯å€ºåŠ¡

1. **ä»£ç é‡æ„**
   - å®¢æœç›¸å…³ä»£ç åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­
   - å»ºè®®ï¼šåˆ›å»ºä¸“é—¨çš„å®¢æœæœåŠ¡æ¨¡å—

2. **æµ‹è¯•è¦†ç›–**
   - å®¢æœåŠŸèƒ½è¯•æµ‹è¦†ç›–ä¸è¶³
   - å»ºè®®ï¼šæ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

3. **æ–‡æ¡£å®Œå–„**
   - APIæ–‡æ¡£å¯èƒ½ä¸å®Œæ•´
   - å»ºè®®ï¼šå®Œå–„APIæ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

---

## æ€»ç»“

å®¢æœç³»ç»Ÿæ˜¯LinkUå¹³å°çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå½“å‰å·²å®ç°æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… ç‹¬ç«‹çš„å®¢æœè®¤è¯ç³»ç»Ÿ
- âœ… å®æ—¶å¯¹è¯åŠŸèƒ½
- âœ… ä»»åŠ¡å–æ¶ˆè¯·æ±‚å®¡æ ¸
- âœ… å®¢æœç®¡ç†åŠŸèƒ½
- âœ… ç”¨æˆ·è¯„åˆ†ç³»ç»Ÿ

**ä¸»è¦ä¼˜åŒ–æ–¹å‘**ï¼š
1. æå‡æ€§èƒ½å’Œç¨³å®šæ€§
2. æ”¹å–„ç”¨æˆ·ä½“éªŒ
3. å¢å¼ºå®‰å…¨æ€§
4. æ‰©å±•åŠŸèƒ½

**å»ºè®®ä¼˜å…ˆå¤„ç†**ï¼š
1. **å®¢æœæ’é˜Ÿç³»ç»Ÿ**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰- è§£å†³ç”¨æˆ·æ»¡è½½æ—¶æ— æ³•è¿æ¥çš„é—®é¢˜
2. WebSocketè¿æ¥ç¨³å®šæ€§
3. æ™ºèƒ½å®¢æœåˆ†é…ï¼ˆåŸºäºè´Ÿè½½ï¼‰
4. æ¶ˆæ¯å·²è¯»çŠ¶æ€åŒæ­¥
5. å¯¹è¯ç®¡ç†åŠŸèƒ½å¢å¼º

---

---

## æ•°æ®åº“ä¸æ¥å£æ”¹é€ æ¸…å•

> **å¯ç›´æ¥æ®æ­¤å‡ºè¿ç§»è„šæœ¬å’ŒPR**

### 1. æ¨¡å‹ä¸ç´¢å¼•ï¼ˆDDL æŒ‡å—ï¼‰

è¯¦è§æ–‡æ¡£ä¸­çš„"æ•°æ®åº“ä¸æ¥å£æ”¹é€ æ¸…å•"ç« èŠ‚ï¼ˆå·²æ·»åŠ å®Œæ•´SQLè¿ç§»è„šæœ¬å’ŒPythonå®ç°ï¼‰

### 2. è·¯ç”±é‡å‘½åä¸åˆ†åŒºï¼ˆå…¼å®¹æœŸ 2 å‘¨ï¼‰

è¯¦è§æ–‡æ¡£ä¸­çš„"æ•°æ®åº“ä¸æ¥å£æ”¹é€ æ¸…å•"ç« èŠ‚ï¼ˆå·²æ·»åŠ å®Œæ•´è·¯ç”±è§„èŒƒå’Œå…¼å®¹æ˜ å°„ï¼‰

### 3. é˜Ÿåˆ—ä¸åˆ†é…æ”¹é€ 

è¯¦è§æ–‡æ¡£ä¸­çš„"æ•°æ®åº“ä¸æ¥å£æ”¹é€ æ¸…å•"ç« èŠ‚ï¼ˆå·²æ·»åŠ å¸¦é”+äº‹åŠ¡çš„å®Œæ•´å®ç°ï¼‰

### 4. è¶…æ—¶ä¸æ¸…ç†æ”¹é€ 

è¯¦è§æ–‡æ¡£ä¸­çš„"æ•°æ®åº“ä¸æ¥å£æ”¹é€ æ¸…å•"ç« èŠ‚ï¼ˆå·²æ·»åŠ Celeryä»»åŠ¡å®ç°å’ŒHTTPä¿æŠ¤æ–¹æ¡ˆï¼‰

### 5. å®‰å…¨ä¸é£æ§æ”¹é€ 

è¯¦è§æ–‡æ¡£ä¸­çš„"æ•°æ®åº“ä¸æ¥å£æ”¹é€ æ¸…å•"ç« èŠ‚ï¼ˆå·²æ·»åŠ å®Œæ•´å®‰å…¨ç­–ç•¥å®ç°ï¼‰

### 6. æ–‡ä»¶æ¶ˆæ¯é€šé“æ”¹é€ 

è¯¦è§æ–‡æ¡£ä¸­çš„"æ•°æ®åº“ä¸æ¥å£æ”¹é€ æ¸…å•"ç« èŠ‚ï¼ˆå·²æ·»åŠ å®Œæ•´æ–‡ä»¶ä¸Šä¼ å®ç°ï¼‰

---

## è§‚æµ‹æ€§ä¸SLO

è¯¦è§æ–‡æ¡£ä¸­çš„"è§‚æµ‹æ€§ä¸SLO"ç« èŠ‚ï¼ˆå·²æ·»åŠ å…³é”®æŒ‡æ ‡ã€æ—¥å¿—ä¸å‘Šè­¦ï¼‰

---

## æµ‹è¯•ä¸éªŒæ”¶ï¼ˆå…³é”®ç”¨ä¾‹ï¼‰

è¯¦è§æ–‡æ¡£ä¸­çš„"æµ‹è¯•ä¸éªŒæ”¶"ç« èŠ‚ï¼ˆå·²æ·»åŠ å®Œæ•´æµ‹è¯•ç”¨ä¾‹ï¼‰

---

## ä¸Šçº¿æ­¥éª¤ï¼ˆå«å›æ»šç‚¹ï¼‰

è¯¦è§æ–‡æ¡£ä¸­çš„"ä¸Šçº¿æ­¥éª¤"ç« èŠ‚ï¼ˆå·²æ·»åŠ å®Œæ•´ä¸Šçº¿è®¡åˆ’å’Œå›æ»šç­–ç•¥ï¼‰

---

## æœ€ç»ˆæ‰§è¡Œæ¸…å•ï¼ˆè€æ¿è§†è§’çš„"ä¸€é¡µçº¸"ï¼‰

è¯¦è§æ–‡æ¡£ä¸­çš„"æœ€ç»ˆæ‰§è¡Œæ¸…å•"ç« èŠ‚ï¼ˆå·²æ·»åŠ å®Œæ•´æ‰§è¡Œæ¸…å•å’Œå·¥æ—¶ä¼°ç®—ï¼‰

---

## å˜æ›´æ—¥å¿—

### 2024-12-28ï¼ˆé˜»æ–­çº§é—®é¢˜ä¿®å¤ - ç¬¬å››è½®ï¼‰
- âœ… **å½»åº•ç§»é™¤å†…éƒ¨ä»»åŠ¡HTTPæš´éœ²**ï¼š
  - ç¡®è®¤æ— ä»»ä½•HTTPè·¯ç”±æ®‹ç•™ï¼ˆæ‰€æœ‰å®šæ—¶ä»»åŠ¡ä»…é€šè¿‡Celeryè§¦å‘ï¼‰
  - `process_queue_with_optimistic_lock` æ˜ç¡®æ ‡æ³¨ä¸ºå†…éƒ¨ä»»åŠ¡ï¼Œä»…Celeryè§¦å‘
  - æ‰€æœ‰å®šæ—¶ä»»åŠ¡å‡½æ•°ç»Ÿä¸€æ ‡æ³¨ä¸ºä»…Celeryè§¦å‘
  - HTTPç«¯ç‚¹ç¤ºä¾‹ç§»è‡³æ–‡æ¡£æœ«å°¾"é™„å½•ï¼šä¸æ¨èæ–¹æ¡ˆ"ç« èŠ‚ï¼Œä»…ä¾›å†å²å‚è€ƒ
- âœ… **ç»Ÿä¸€æ—¶é—´å·¥å…·å®ç°ä¸ºzoneinfo**ï¼š
  - `time_utils.py` ä»…ä¿ç•™zoneinfoç‰ˆæœ¬ï¼ˆPython 3.9+æ¨èï¼‰
  - pytzä»…åœ¨è¿ç§»è„šæœ¬çš„å…¼å®¹åˆ†æ”¯ä¸­æåŠï¼ˆPython < 3.9ä¸´æ—¶ä½¿ç”¨ï¼‰
  - æ‰€æœ‰æ—¶é—´å¤„ç†å‡½æ•°ç»Ÿä¸€ä½¿ç”¨zoneinfoï¼Œåˆ é™¤pytzç›´æ¥ä½¿ç”¨
- âœ… **ç¡®ä¿ç­‰å¾…æ—¶é—´ä¼°ç®—å”¯ä¸€å®ç°**ï¼š
  - `calculate_estimated_wait_time` æ·»åŠ æ˜ç¡®æ³¨é‡Šï¼šæ‰€æœ‰è°ƒç”¨ä¸¥ç¦è‡ªå®šä¹‰å®ç°
  - æ‰€æœ‰æ¥å£è¿”å›ç¤ºä¾‹ç»Ÿä¸€è°ƒç”¨æ­¤å‡½æ•°ï¼Œç¦æ­¢å†…è”ç®€åŒ–ç‰ˆ
  - å‡½æ•°å†…éƒ¨é»˜è®¤å€¼è®¡ç®—å·²æ ‡æ³¨ä¸ºå†…éƒ¨é€»è¾‘ï¼Œéç‹¬ç«‹å®ç°
- âœ… **æ–‡ä»¶ä¸Šä¼ åªä¿ç•™æ­£ç¡®ç¤ºä¾‹**ï¼š
  - åˆ é™¤æ‰€æœ‰å« `File(.)` å’Œ `file.size` çš„é”™è¯¯ç¤ºä¾‹
  - åªä¿ç•™"æµå¼è¯»å–è®¡ç®—å¤§å° + é‡ç½®æŒ‡é’ˆ"çš„å®‰å…¨ç‰ˆæœ¬
  - æ˜ç¡®æ ‡æ³¨ä¸ºå”¯ä¸€æ­£ç¡®å®ç°ï¼Œæ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æ¥å£å¿…é¡»ä½¿ç”¨æ­¤æ¨¡å¼
- âœ… **æ·»åŠ é€Ÿç‡é™åˆ¶è¦†ç›–æ¸…å•**ï¼š
  - åˆ—å‡ºæ‰€æœ‰å¿…é¡»ä½¿ç”¨ `@rate_limit_messages` è£…é¥°å™¨çš„è·¯ç”±ï¼ˆ9ä¸ªæ¥å£ï¼‰
  - åŒ…å«ç”¨æˆ·ç«¯å’Œå®¢æœç«¯æ‰€æœ‰æ¶ˆæ¯/æ–‡ä»¶/æ“ä½œæ¥å£
  - æä¾›é…ç½®å»ºè®®ï¼ˆæ™®é€šæ¶ˆæ¯ã€æ–‡ä»¶ä¸Šä¼ ã€ç»“æŸå¯¹è¯/è¯„åˆ†ï¼‰
- âœ… **æ˜ç¡®è®¡åˆ’ä»»åŠ¡å®šä½**ï¼š
  - åœ¨"å½“å‰å®ç°çŠ¶æ€"ä¸­æ·»åŠ "è®¡åˆ’ä»»åŠ¡"ç« èŠ‚
  - æ˜ç¡®æ ‡æ³¨ä¸ºå†…éƒ¨ä»»åŠ¡ï¼Œä¸å¯¹å¤–æš´éœ²HTTPç«¯ç‚¹
  - è¯´æ˜ä»…é€šè¿‡Celeryå®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆæ¯30ç§’/æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼‰
- âœ… **æ›´æ–°è·¯çº¿å›¾è¡¨æ ¼çŠ¶æ€**ï¼š
  - æ‰€æœ‰å·²ä¿®å¤æ–‡æ¡£çš„é¡¹ç›®æ›´æ–°ä¸º"âœ… æ–‡æ¡£ä¿®æ­£å·²å®Œæˆï¼Œä»£ç å®ç°å¾…å®Œæˆ"
  - åŒºåˆ†æ–‡æ¡£ä¿®æ­£çŠ¶æ€å’Œä»£ç å®ç°çŠ¶æ€
  - 13ä¸ªä¿®å¤é¡¹å…¨éƒ¨æ›´æ–°çŠ¶æ€
- âœ… **ä¿®å¤HTTPæ–¹æ¡ˆç¤ºä¾‹è¯­ä¹‰é”™è¯¯**ï¼š
  - ä¿®å¤`def`å‡½æ•°ä¸­ä½¿ç”¨`await request.body()`çš„é”™è¯¯
  - æ˜ç¡®æ ‡æ³¨ä¸º`async def`ï¼Œå¹¶æ·»åŠ å®Œæ•´çš„awaitç¤ºä¾‹
  - æ ‡æ³¨HTTPæ–¹æ¡ˆä¸º"ä¸æ¨èï¼Œä»…ä¾›å†å²å‚è€ƒ"
- âœ… **ç»Ÿä¸€æ—¶é—´åˆ—timezone=True**ï¼š
  - æ£€æŸ¥å¹¶ç¡®è®¤æ‰€æœ‰DateTimeåˆ—éƒ½åŒ…å«`timezone=True`
  - æ‰€æœ‰æ—¶é—´åˆ—ç»Ÿä¸€ä¸º`DateTime(timezone=True)`
- âœ… **ç»Ÿä¸€format_time_for_displayä½¿ç”¨zoneinfo**ï¼š
  - ç¡®è®¤æ‰€æœ‰`format_time_for_display`å‡½æ•°éƒ½ä½¿ç”¨zoneinfo
  - åˆ é™¤pytzç›´æ¥ä½¿ç”¨ï¼ˆä»…è¿ç§»è„šæœ¬å…¼å®¹åˆ†æ”¯ä¿ç•™ï¼‰
  - æ­£æ–‡ä»£ç ç»Ÿä¸€ä½¿ç”¨zoneinfoï¼Œpytzä»…é™è¿ç§»è„šæœ¬Python < 3.9ä¸´æ—¶ä½¿ç”¨
- âœ… **ä¿®å¤301é‡å®šå‘è¡¨è¿°**ï¼š
  - æ˜ç¡®æ ‡æ³¨ç»Ÿä¸€ä½¿ç”¨308ï¼ˆGETï¼‰æˆ–åŒæ³¨å†Œï¼ˆPOST/PUT/DELETEï¼‰
  - é¿å…301é‡å®šå‘å¯¼è‡´POSTè¢«è¯¯æ”¹ä¸ºGET
- âœ… **æ·»åŠ CI/PRé¢„æäº¤æ£€æŸ¥è§„åˆ™**ï¼š
  - æ·»åŠ 7æ¡CIæ£€æŸ¥è§„åˆ™ï¼ˆæ—¶é—´åˆ—ã€pytzã€datetime.utcnowã€HTTPå®šæ—¶ä»»åŠ¡ã€301é‡å®šå‘ã€æ–‡ä»¶ä¸Šä¼ ã€ç­‰å¾…æ—¶é—´ä¼°ç®—ï¼‰
  - æä¾›å®Œæ•´çš„grepå‘½ä»¤ï¼Œå¯ç›´æ¥ç”¨äºCIæ£€æŸ¥
- âœ… **æ·»åŠ Go/No-Goç»ˆæ£€æ¸…å•**ï¼š
  - å¯ä»¥æ”¾è¡Œé¡¹ç›®ç¡®è®¤ï¼ˆæ–‡æ¡£å·²ç»Ÿä¸€ä¸”æ¸…æ™°ï¼‰
  - å¿…é¡»ç¡®è®¤è½åœ°é¡¹ç›®ï¼ˆæ–‡æ¡£å·²ä¿®ï¼Œå¾…ä»£ç å®ç°ï¼‰
  - å»ºè®®å†è¡¥çš„"ä¸´é—¨ä¸€è„š"ï¼ˆå›æ»šè¯´æ˜ã€CIè‡ªæ£€è§„åˆ™ï¼‰
  - ä¸€é¡µå¼ä¸Šçº¿æ¸…å•ï¼ˆ7ä¸ªé˜¶æ®µæ‰§è¡Œé¡ºåºï¼‰

### 2024-12-28ï¼ˆé˜»æ–­çº§é—®é¢˜ä¿®å¤ - ç¬¬ä¸‰è½®ï¼‰
- âœ… **ä¿®å¤å†…éƒ¨ä»»åŠ¡HTTPæš´éœ²æ®‹ç•™**ï¼š
  - `process_queue_with_optimistic_lock` æ˜ç¡®æ ‡æ³¨ä¸ºå†…éƒ¨ä»»åŠ¡ï¼Œä¸æš´éœ²HTTP
  - æ‰€æœ‰å®šæ—¶ä»»åŠ¡å‡½æ•°ç»Ÿä¸€æ ‡æ³¨ä¸ºä»…Celeryæˆ–ç®¡ç†ç«¯è§¦å‘
- âœ… **ä¿®å¤WebSocketå¿ƒè·³æ—¶é—´æº**ï¼š
  - ç»Ÿä¸€æ‰€æœ‰å¿ƒè·³ç›¸å…³ä»£ç ä½¿ç”¨ `get_utc_time()`
  - æ·»åŠ WebSocketè·¯ç”±æŒ‚è½½ç‚¹è¯´æ˜ `@router.websocket("/api/ws/customer-service/chat/{chat_id}")`
  - ç¡®ä¿ä¸ç°æœ‰WS handlerä¸€è‡´
  - `send_unread_messages` å‡½æ•°ç»Ÿä¸€ä½¿ç”¨UTCå¹¶æ·»åŠ å¯¼å…¥
  - `handle_reconnect` å‡½æ•°ç»Ÿä¸€ä½¿ç”¨UTCå¹¶æ·»åŠ å¯¼å…¥
  - `handle_message_ack` å‡½æ•°ç»Ÿä¸€ä½¿ç”¨UTC
  - `send_heartbeat` å‡½æ•°å®Œæ•´å®ç°
- âœ… **ä¿®å¤æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹é—®é¢˜**ï¼š
  - ä¿®æ­£ `File(.)` æ‹¼å†™é”™è¯¯ä¸º `File(...)`
  - ä¿®å¤ `file.size` é—®é¢˜ï¼šæ”¹ä¸ºæµå¼è¯»å–è®¡ç®—å¤§å°
  - æ·»åŠ æ–‡ä»¶ç±»å‹å’Œå¤§å°é™åˆ¶ï¼ˆ20MBï¼‰
  - è·¯ç”±æ”¹ä¸ºç”¨æˆ·ç«¯å‘½åç©ºé—´ `/api/user/customer-service/chats/{chat_id}/files`
  - ç”³è¯·é™„ä»¶ä¸Šä¼ ç«¯ç‚¹å®Œæ•´å®ç°
- âœ… **æ·»åŠ ç»“æŸå¯¹è¯åŸå› å­—æ®µæ¨¡å‹å’Œè¿ç§»**ï¼š
  - å®Œæ•´çš„ORMå­—æ®µå®šä¹‰ï¼ˆended_reason, ended_by, ended_type, ended_commentï¼‰
  - å®Œæ•´çš„Alembicè¿ç§»è„šæœ¬
  - ä¸ºç°æœ‰æ•°æ®è®¾ç½®é»˜è®¤å€¼
- âœ… **ç»Ÿä¸€ç­‰å¾…æ—¶é—´ä¼°ç®—å‡½æ•°**ï¼š
  - ç¡®ä¿ `calculate_estimated_wait_time` åªæœ‰ä¸€ä»½æƒå¨å®ç°
  - æ‰€æœ‰å¼•ç”¨ç»Ÿä¸€æŒ‡å‘åŒä¸€å®ç°
  - ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´è®¡ç®—
  - æ·»åŠ æ˜ç¡®æ³¨é‡Šè¯´æ˜å•ä¸€æƒå¨å®ç°
- âœ… **æ—¶åŒºåº“è¿ç§»åˆ°zoneinfo**ï¼š
  - `time_utils.py` ä½¿ç”¨ `zoneinfo.ZoneInfo` æ›¿ä»£ `pytz`
  - ä¿æŒå¯¹å¤–æ¥å£ä¸å˜ï¼Œä»…åº•å±‚å®ç°æ›¿æ¢
  - æ·»åŠ Pythonç‰ˆæœ¬å…¼å®¹è¯´æ˜
  - `is_service_available` å‡½æ•°ä½¿ç”¨zoneinfo
  - `format_time_for_display` å‡½æ•°ä½¿ç”¨zoneinfoæ›¿ä»£pytz
  - è¿ç§»è„šæœ¬ä¸­çš„pytzä½¿ç”¨æ ‡æ³¨ä¸ºä¸´æ—¶ä½¿ç”¨ï¼Œè¿ç§»å®Œæˆååˆ é™¤
  - è¿ç§»è„šæœ¬æ”¯æŒPython 3.9+ä½¿ç”¨zoneinfoï¼Œ<3.9ä¸´æ—¶ä½¿ç”¨pytz
- âœ… **ç»Ÿä¸€é‡å®šå‘ç­–ç•¥**ï¼š
  - GETè¯·æ±‚ï¼šä½¿ç”¨ `RedirectResponse(status_code=308)` ä¿æŒæ–¹æ³•
  - POST/PUT/DELETEï¼šåŒæ³¨å†ŒåŒä¸€å¤„ç†å‡½æ•°è¿‡æ¸¡2å‘¨
  - æ·»åŠ å®Œæ•´ç¤ºä¾‹ä»£ç 
  - ä¿®å¤ä¼˜åŒ–æ–‡æ¡£å¯è¡Œæ€§åˆ†æ.mdä¸­çš„é‡å®šå‘ç¤ºä¾‹
- âœ… **ä¿®å¤is_service_availableå’Œget_system_messageç¼ºå°‘dbå‚æ•°**ï¼š
  - `is_service_available` æ·»åŠ  `db: Session` å‚æ•°å’Œå‚æ•°éªŒè¯
  - `get_system_message` æ·»åŠ  `db: Session` å‚æ•°å’Œå‚æ•°éªŒè¯
  - ä¿®å¤æ‰€æœ‰è°ƒç”¨å¤„ä¼ å…¥dbå‚æ•°
- âœ… **ç»Ÿä¸€é€Ÿç‡é™åˆ¶è£…é¥°å™¨**ï¼š
  - ç§»é™¤åŒæ­¥åŒ…è£…ï¼Œç»Ÿä¸€ä¸ºçº¯å¼‚æ­¥å®ç°
  - è¦æ±‚æ‰€æœ‰ä½¿ç”¨è¯¥è£…é¥°å™¨çš„å‡½æ•°å¿…é¡»æ˜¯async
  - ä½¿ç”¨Redisæœ‰åºé›†åˆæ»‘åŠ¨çª—å£ç®—æ³•
- âœ… **æ·»åŠ é˜Ÿåˆ—è¡¨ç´¢å¼•è¯´æ˜**ï¼š
  - å¤åˆç´¢å¼• `(status, queued_at)`
  - å•åˆ—ç´¢å¼• `user_id`, `status`
  - å®Œæ•´çš„DDLè¿ç§»è„šæœ¬
- âœ… **ä¿®å¤get_chat_timeout_minuteså¯¼å…¥**ï¼š
  - æ·»åŠ  `from datetime import timedelta` å¯¼å…¥

### 2024-12-28ï¼ˆé˜»æ–­çº§é—®é¢˜ä¿®å¤ - ç¬¬äºŒè½®ï¼‰
- âœ… **ä¿®å¤è·¯ç”±å‰ç¼€ç»Ÿä¸€é—®é¢˜**ï¼š
  - ç”¨æˆ·ç«¯è·¯ç”±ç»Ÿä¸€ä¸º `/api/user/customer-service/...`ï¼ˆqueue-status, cancel-queueç­‰ï¼‰
  - ç§»é™¤æ‰€æœ‰å®šæ—¶ä»»åŠ¡çš„HTTPç«¯ç‚¹ï¼Œä»…ä¿ç•™Celeryä»»åŠ¡
  - ä¿®å¤å…¼å®¹å±‚è¯´æ˜ï¼šGETç”¨308é‡å®šå‘ï¼ŒPOST/PUTç­‰ç”¨åŒæ³¨å†Œè¿‡æ¸¡
- âœ… **ä¿®å¤UTCä¸€è‡´æ€§æ®‹ç•™**ï¼š
  - `calculate_estimated_wait_time` å‡½æ•°å®Œæ•´å®ç°ï¼Œç»Ÿä¸€ä½¿ç”¨ `get_utc_time()` å’Œ `to_utc()`
  - ä¿®å¤ `get_chat_timeout_minutes` å‡½æ•°ï¼Œç¡®ä¿ä½¿ç”¨UTC
  - æ‰€æœ‰æ—¶é—´è®¡ç®—ç»Ÿä¸€ä¸ºUTCåŸºå‡†
- âœ… **ç§»é™¤ä¸å®‰å…¨çš„å¹¶å‘åˆ†é…ç¤ºä¾‹**ï¼š
  - ç§»é™¤å¾ªç¯å†…commitçš„ä¸å®‰å…¨ç‰ˆæœ¬
  - ä»…ä¿ç•™äº‹åŠ¡+è¡Œçº§é”çš„å®‰å…¨å®ç°
- âœ… **æ·»åŠ æ¶ˆæ¯å››æ€DDLç‰‡æ®µ**ï¼š
  - å®Œæ•´çš„æ•°æ®åº“è¿ç§»è„šæœ¬
  - åŒ…å«ç´¢å¼•ä¼˜åŒ–å»ºè®®
- âœ… **ç»Ÿä¸€æ‰€æœ‰è·¯ç”±ç¤ºä¾‹ä¸ºasync**ï¼š
  - æ‰€æœ‰ `@router` è£…é¥°çš„å‡½æ•°ç»Ÿä¸€ä¸º `async def`
  - ç¡®ä¿ä¸FastAPIå¼‚æ­¥æ ˆä¸€è‡´

### 2024-12-28ï¼ˆé˜»æ–­çº§é—®é¢˜ä¿®å¤ - ç¬¬ä¸€è½®ï¼‰
- âœ… **ä¿®å¤æ—¶é—´åŸºå‡†ç»Ÿä¸€é—®é¢˜**ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡å‡½æ•°ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`ï¼Œç§»é™¤ `pytz.timezone("Europe/London")` å’Œ `datetime.utcnow()` æ··ç”¨
- âœ… **ä¿®å¤å®šæ—¶ä»»åŠ¡æš´éœ²é—®é¢˜**ï¼šå°†æ‰€æœ‰ `@router.post` å®šæ—¶ä»»åŠ¡ç«¯ç‚¹æ”¹ä¸ºå†…éƒ¨å‡½æ•°ï¼Œæ·»åŠ å®Œæ•´Celeryä»»åŠ¡é…ç½®
- âœ… **ä¿®å¤é€Ÿç‡é™åˆ¶å®ç°**ï¼šç§»é™¤ `asyncio.run` åŒæ­¥åŒ…è£…ï¼Œç»Ÿä¸€ä¸ºçº¯å¼‚æ­¥å®ç°
- âœ… **ç»Ÿä¸€WebSocketå®ç°**ï¼šæ‰€æœ‰å¿ƒè·³/ACK/åç§»é‡æ”¾ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`ï¼Œç§»é™¤é‡å¤å®ç°
- âœ… **ç»Ÿä¸€è·¯ç”±å‘½å**ï¼šå®¢æœç«¯ç»Ÿä¸€ä¸º `/api/customer-service/...`ï¼Œç”¨æˆ·ç«¯ç»Ÿä¸€ä¸º `/api/user/customer-service/...`
- âœ… **ä¿®å¤MessageOffsetæ—¶åŒºæ ‡æ³¨**ï¼šç»Ÿä¸€ä¸º `DateTime(timezone=True)` + `default=get_utc_time()`
- âœ… æ·»åŠ "é˜»æ–­çº§é—®é¢˜ä¿®å¤æ¸…å•"ç« èŠ‚ï¼Œæ˜ç¡®å¾…å®ç°é¡¹

### 2024-12-28
- âœ… æ·»åŠ æœ€é«˜ä¼˜å…ˆçº§é—®é¢˜æ¸…å•ï¼ˆè·¯ç”±å‘½åã€æ—¶åŒºç»Ÿä¸€ã€å®‰å…¨ç­–ç•¥ç­‰ï¼‰
- âœ… **æ–°å¢"å…¨å±€æ—¶é—´å¤„ç†æœºåˆ¶"ç« èŠ‚**ï¼Œè¯¦ç»†è¯´æ˜å½“å‰æ—¶é—´æ··ç”¨é—®é¢˜å’Œç»Ÿä¸€UTCç­–ç•¥
- âœ… **ä¿®å¤å¹¶å‘åˆ†é…"åŒåˆ†é…"é—®é¢˜**ï¼Œæ·»åŠ äº‹åŠ¡å’Œè¡Œçº§é”ä¿æŠ¤
- âœ… **å®Œå–„é€Ÿç‡é™åˆ¶è£…é¥°å™¨**ï¼Œä½¿ç”¨Redisæ»‘åŠ¨çª—å£ç®—æ³•ï¼Œå…¼å®¹åŒæ­¥/å¼‚æ­¥å‡½æ•°
- âœ… **å®Œå–„WebSocketæœåŠ¡ç«¯å¿ƒè·³å’Œé‡æ”¾é€»è¾‘**ï¼Œæ·»åŠ ping/pongæœºåˆ¶å’Œæ¶ˆæ¯åç§»é‡æ”¾
- âœ… **æ·»åŠ "æ­£åœ¨è¾“å…¥"äº‹ä»¶å¤„ç†**ï¼Œæ”¯æŒtypingäº‹ä»¶è½¬å‘å’Œé™æµ
- âœ… **å®Œå–„XSSå‡€åŒ–åŠŸèƒ½**ï¼Œä½¿ç”¨bleachç™½åå•åº“è¿›è¡Œä¸¥æ ¼è¿‡æ»¤
- âœ… **å®Œå–„Cookie/CSRFç­–ç•¥**ï¼Œæ·»åŠ Tokené»‘åå•ç®¡ç†å’Œåˆ·æ–°ç­–ç•¥
- âœ… **æ·»åŠ Pydanticå…¥å‚æ ¡éªŒ**ï¼Œä½¿ç”¨å¼ºç±»å‹æ¨¡å‹æ›¿ä»£dict
- âœ… **å®Œå–„æ¶ˆæ¯å†å²åˆ†é¡µ**ï¼Œå¼ºåˆ¶ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼Œæ·»åŠ é€Ÿç‡é™åˆ¶
- âœ… **å®Œå–„æ–‡ä»¶ä¸Šä¼ å®‰å…¨**ï¼Œæµå¼è¯»å–ã€å®‰å…¨æ–‡ä»¶åç”Ÿæˆã€é˜²æ­¢è·¯å¾„æ³¨å…¥
- âœ… **å®Œå–„ç»“æŸåŸå› å­—æ®µ**ï¼Œæ‰€æœ‰ç»“æŸè·¯å¾„éƒ½å¿…é¡»è®°å½•åŸå› 
- âœ… **å®Œå–„æ¶ˆæ¯å››æ€æµè½¬**ï¼Œå®Œæ•´å®ç°sending->sent->delivered->read
- âœ… **æ·»åŠ ç´¢å¼•å»ºè®®**ï¼ŒåŒ…æ‹¬å¤åˆç´¢å¼•å’Œå•åˆ—ç´¢å¼•
- âœ… å®Œå–„å®¢æœé¡µé¢ç”¨æˆ·å¯¹è¯åŠŸèƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- âœ… æ·»åŠ å®¢æœä¸ç®¡ç†å‘˜å¯¹è¯ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆ
- âœ… æ·»åŠ å®¢æœå‘ç®¡ç†å‘˜ç”³è¯·åŠŸèƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- âœ… æ·»åŠ å®¢æœå–æ¶ˆå®¡æ ¸åŠŸèƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- âœ… æ·»åŠ ç”¨æˆ·ç«¯å®¢æœèŠå¤©æ¡†ä¼˜åŒ–æ–¹æ¡ˆ
- âœ… æ·»åŠ å¯¹è¯è¶…æ—¶åŠŸèƒ½è¯¦ç»†è¯´æ˜
- âœ… æ·»åŠ å®¢æœæ’é˜Ÿç³»ç»Ÿå®Œæ•´æ–¹æ¡ˆ

### 2024-12-27
- âœ… åˆå§‹ç‰ˆæœ¬åˆ›å»º
- âœ… æ·»åŠ å®¢æœåŠŸèƒ½æ¦‚è¿°å’Œå½“å‰å®ç°çŠ¶æ€
- âœ… æ·»åŠ ä¼˜åŒ–å»ºè®®å’Œæœªæ¥è§„åˆ’

---

## CI/PR é¢„æäº¤æ£€æŸ¥è§„åˆ™

ä»¥ä¸‹è§„åˆ™å»ºè®®åŠ å…¥CIé¢„æäº¤æ£€æŸ¥æˆ–PRæœºå™¨äººè¯„è®ºï¼Œç¡®ä¿ä»£ç å®ç°ç¬¦åˆæ–‡æ¡£è§„èŒƒï¼š

### 1. ç¦æ­¢ä¸å¸¦æ—¶åŒºçš„æ—¶é—´åˆ—
```bash
# æ£€æŸ¥æ‰€æœ‰DateTimeåˆ—å¿…é¡»åŒ…å«timezone=True
grep -R "Column(DateTime\\()" backend/app/models.py | grep -v "timezone=True"
# å¦‚æœå‘½ä¸­ï¼Œè¯´æ˜æœ‰DateTimeåˆ—ç¼ºå°‘timezone=Trueï¼Œåº”æ‹¦æˆª
# æ³¨æ„ï¼šæ‰€æœ‰æ—¶é—´åˆ—å¿…é¡»ç»Ÿä¸€ä¸ºDateTime(timezone=True)
```

### 2. ç¦æ­¢pytzç›´æ¥ä½¿ç”¨
```bash
# æ£€æŸ¥pytzä½¿ç”¨ï¼ˆè¿ç§»è„šæœ¬ç›®å½•é™¤å¤–ï¼‰
grep -R "import pytz\\|pytz\\.timezone" backend/app docs/ --exclude-dir=migrations
# å¦‚æœå‘½ä¸­ï¼Œè¯´æ˜æœ‰ä»£ç ç›´æ¥ä½¿ç”¨pytzï¼Œåº”ç»Ÿä¸€æ”¹ä¸ºzoneinfo
# æ³¨æ„ï¼šè¿ç§»è„šæœ¬ä¸­å¯ä¸´æ—¶ä½¿ç”¨pytzï¼ˆPython < 3.9å…¼å®¹ï¼‰ï¼Œä½†æ­£æ–‡ä»£ç å¿…é¡»ä½¿ç”¨zoneinfo
```

### 3. ç¦æ­¢datetime.utcnow()
```bash
# æ£€æŸ¥datetime.utcnow()ä½¿ç”¨
grep -R "datetime\\.utcnow()" backend/app
# å¦‚æœå‘½ä¸­ï¼Œè¯´æ˜æœ‰ä»£ç ä½¿ç”¨datetime.utcnow()ï¼Œåº”ç»Ÿä¸€æ”¹ä¸ºget_utc_time()
```

### 4. ç¦æ­¢HTTPè§¦å‘çš„å®šæ—¶ä»»åŠ¡
```bash
# æ£€æŸ¥å®šæ—¶ä»»åŠ¡HTTPç«¯ç‚¹
grep -R "process-queue-optimistic\\|/customer-service/process-queue\\|/customer-service/.*auto-end\\|send-timeout\\|cleanup-long" backend/app/routers.py docs/
# å¦‚æœå‘½ä¸­ï¼Œè¯´æ˜æœ‰å®šæ—¶ä»»åŠ¡æš´éœ²ä¸ºHTTPç«¯ç‚¹ï¼Œåº”æ”¹ä¸ºCeleryä»»åŠ¡
# æ³¨æ„ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡å¿…é¡»é€šè¿‡Celeryè§¦å‘ï¼Œä¸åº”æš´éœ²HTTPç«¯ç‚¹
```

### 5. ç¦æ­¢301é‡å®šå‘
```bash
# æ£€æŸ¥301é‡å®šå‘ä½¿ç”¨
grep -R "301.*é‡å®šå‘\\|RedirectResponse.*301" backend/app docs/
# å¦‚æœå‘½ä¸­ï¼Œè¯´æ˜ä½¿ç”¨äº†301é‡å®šå‘ï¼Œåº”æ”¹ä¸º308ï¼ˆGETï¼‰æˆ–åŒæ³¨å†Œï¼ˆPOST/PUT/DELETEï¼‰
# æ³¨æ„ï¼šGETè¯·æ±‚ä½¿ç”¨308ï¼ŒPOST/PUT/DELETEä½¿ç”¨åŒæ³¨å†Œè¿‡æ¸¡ä¸¤å‘¨
```

### 6. æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹æ£€æŸ¥
```bash
# æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ æ˜¯å¦ä½¿ç”¨file.sizeï¼ˆé”™è¯¯ç”¨æ³•ï¼‰
grep -R "File(\\.)\\|file\\.size" backend/app docs/
# å¦‚æœå‘½ä¸­ï¼Œè¯´æ˜ä½¿ç”¨äº†File(.)æˆ–file.sizeï¼ˆé”™è¯¯ç”¨æ³•ï¼‰ï¼Œåº”æ”¹ä¸ºFile(...)å’Œæµå¼è¯»å–è®¡ç®—å¤§å°
# æ³¨æ„ï¼šUploadFileæ²¡æœ‰sizeå±æ€§ï¼Œå¿…é¡»é€šè¿‡æµå¼è¯»å–è®¡ç®—å¤§å°
```

### 7. ç­‰å¾…æ—¶é—´ä¼°ç®—å”¯ä¸€å®ç°æ£€æŸ¥
```bash
# æ£€æŸ¥æ˜¯å¦æœ‰å†…è”çš„ç­‰å¾…æ—¶é—´è®¡ç®—ï¼ˆåº”ç»Ÿä¸€è°ƒç”¨calculate_estimated_wait_timeï¼‰
grep -R "queue_position.*\\*.*5\\|ç­‰å¾….*queue.*\\*" backend/app
# å¦‚æœå‘½ä¸­ï¼Œè¯´æ˜æœ‰å†…è”çš„ç­‰å¾…æ—¶é—´è®¡ç®—ï¼Œåº”ç»Ÿä¸€è°ƒç”¨calculate_estimated_wait_timeå‡½æ•°
```

---

## Go/No-Go ç»ˆæ£€æ¸…å•

### âœ… å¯ä»¥æ”¾è¡Œï¼ˆæ–‡æ¡£å·²ç»Ÿä¸€ä¸”æ¸…æ™°ï¼‰

ä»¥ä¸‹é¡¹ç›®æ–‡æ¡£å·²ç»Ÿä¸€ä¸”æ¸…æ™°ï¼Œå¯ä»¥ä½œä¸ºæœ€ç»ˆç ”å‘è¯´æ˜ï¼š

1. **å®šæ—¶ä»»åŠ¡å½»åº•å†…åŒ–ï¼ˆä»… Celery / ä¸æš´éœ² HTTPï¼‰**
   - âœ… æ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€æ”¹ä¸ºCeleryä»»åŠ¡ï¼Œä¸æš´éœ²HTTPç«¯ç‚¹
   - âœ… åœ¨"å½“å‰å®ç°çŠ¶æ€"ä¸ä»»åŠ¡æ¸…å•ä¸¤å¤„éƒ½å†™æ¸…æ¥šäº†è§¦å‘æ–¹å¼ä¸å®‰å…¨è¾¹ç•Œ
   - âœ… HTTPç«¯ç‚¹ç¤ºä¾‹å·²ç§»è‡³"é™„å½•ï¼šä¸æ¨èæ–¹æ¡ˆ"ç« èŠ‚

2. **æ—¶é—´åŸºå‡†å®Œå…¨ç»Ÿä¸€ä¸º UTC + zoneinfo**
   - âœ… å»æ‰äº† `datetime.utcnow()`/`pytz` æ··ç”¨
   - âœ… æä¾›äº† `get_utc_time()`/`to_utc()`/`to_user_timezone()` å·¥å…·å‡½æ•°
   - âœ… æ‰€æœ‰æ¨¡å‹æ—¶é—´åˆ—ç»Ÿä¸€ä¸º `DateTime(timezone=True)`

3. **è·¯ç”±å‘½åä¸è¿ç§»ç­–ç•¥ç»Ÿä¸€**
   - âœ… å®¢æœç«¯ï¼š`/api/customer-service/...`
   - âœ… ç”¨æˆ·ç«¯ï¼š`/api/user/customer-service/...`
   - âœ… GET ç”¨ 308ï¼ŒPOST/PUT/DELETE èµ°åŒæ³¨å†Œè¿‡æ¸¡ä¸¤å‘¨ï¼Œé¿å… 301 è¯¯è½¬

4. **é€Ÿç‡é™åˆ¶æ–¹æ¡ˆç»Ÿä¸€**
   - âœ… ç»Ÿä¸€ä¸ºçº¯å¼‚æ­¥ + Redis æ»‘åŠ¨çª—å£
   - âœ… æä¾›äº†è¦†ç›–æ¸…å•ï¼ˆå“ªäº›ç«¯ç‚¹å¿…é¡»æŒ‚è£…é¥°å™¨ï¼‰

5. **WebSocket å¿ƒè·³/ACK/åç§»é‡æ”¾**
   - âœ… åªæœ‰ä¸€å¥—æƒå¨å®ç°ï¼ˆç»Ÿä¸€æ—¶é—´æºï¼‰
   - âœ… ç»™å‡ºæŒ‚è½½ç‚¹ `@router.websocket("/api/ws/customer-service/chat/{chat_id}")`

6. **æ–‡ä»¶ä¸Šä¼ èŒƒå¼**
   - âœ… åªä¿ç•™æ­£ç¡®å†™æ³•ï¼ˆ`File(...)`ã€æµå¼è®¡å¤§å°ã€ç™½åå•ä¸ä¸Šé™ï¼‰
   - âœ… å·²æ˜ç¡®ä¿®æ­£å†å²è¯¯ç”¨å¦‚ `file.size`

7. **ç»“æŸè¯­ä¹‰å­—æ®µä¸è¿ç§»**
   - âœ… `ended_reason`/`ended_by`/`ended_type`/`ended_comment` å­—æ®µå®šä¹‰
   - âœ… é˜Ÿåˆ—è¡¨å¤åˆç´¢å¼•éƒ½æœ‰æˆæ–‡ DDL/è¿ç§»æŒ‡å¼•

---

### âš ï¸ å¿…é¡»ç¡®è®¤è½åœ°ï¼ˆæ–‡æ¡£è¯´"å·²ä¿®æ–‡æ¡£ï¼Œå¾…ä»£ç å®ç°"çš„æ¸…å•ï¼‰

è¿™äº›é¡¹æ–‡æ¡£å·²å†™å¯¹ï¼Œä½†æ˜ç¡®æ ‡æ³¨è¿˜æ²¡æ”¹ä»£ç â€”â€”**å¦‚æœä¸ä¸Šçº¿å‰è½åœ°ï¼Œä¼šå˜æˆ"æ–‡æ¡£-å®ç°åå·®"**ï¼š

#### 1. time_utils ä¸å…¨é‡æ›¿æ¢ï¼šç¡®ä¿ä»£ç åº“å®Œæˆ

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] å…¨æ–‡æ›¿æ¢ `datetime.utcnow()` â†’ `get_utc_time()`
- [ ] å…¨æ–‡æ›¿æ¢ `get_uk_time()` â†’ `get_utc_time()`
- [ ] å…¨æ–‡æ›¿æ¢ `pytz.timezone("Europe/London")` â†’ `zoneinfo.ZoneInfo("Europe/London")`ï¼ˆæ­£æ–‡ä»£ç ï¼‰
- [ ] æ‰€æœ‰æ¨¡å‹æ—¶é—´åˆ—éƒ½åŠ  `timezone=True`
- [ ] å¯¼å…¥å¹¶ä½¿ç”¨ `get_utc_time()` æ›¿ä»£æ‰€æœ‰æ—¶é—´è·å–

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é—ç•™
grep -R "datetime.utcnow()" backend/app --exclude-dir=migrations
grep -R "get_uk_time()" backend/app
grep -R "pytz.timezone" backend/app --exclude-dir=migrations
grep -R "Column(DateTime(" backend/app/models.py | grep -v "timezone=True"
```

#### 2. Celery ä»»åŠ¡æ¨¡å—ä¸ Beat è°ƒåº¦

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] åˆ›å»º `backend/app/customer_service_tasks.py` æ–‡ä»¶
- [ ] å®ç°å››ç±»ä»»åŠ¡ï¼š`auto_end_timeout_chats`ã€`send_timeout_warnings`ã€`cleanup_long_inactive_chats`ã€`process_customer_service_queue`
- [ ] é…ç½® `celery_app.conf.beat_schedule`ï¼ˆæ¯30ç§’/æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼‰
- [ ] ä»“åº“é‡Œåˆ é™¤å†å² HTTP è§¦å‘å…¥å£ï¼ˆ`@router.post` è£…é¥°å™¨ï¼‰

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰HTTPè§¦å‘å…¥å£
grep -R "/customer-service/.*auto-end\|send-timeout\|cleanup-long\|process-queue" backend/app/routers.py
# åº”è¯¥è¿”å›ç©ºç»“æœ
```

#### 3. è·¯ç”±åŒæ³¨å†Œ/308

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] GET è·¯ç”±åŠ  308 é‡å®šå‘ï¼ˆ`RedirectResponse(status_code=308)`ï¼‰
- [ ] POST/PUT/DELETE å¹¶è¡Œæ³¨å†ŒåŒä¸€å¤„ç†å™¨ä¸¤å‘¨
- [ ] æ—§è·¯ç”±å“åº”å¤´åŠ  `Deprecation: true` å’Œ `Link: <æ–°è·¯ç”±>; rel="successor-version"`

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# GET è·¯ç”±ï¼šä½¿ç”¨ 308 é‡å®šå‘
@router.get("/api/cs/login", deprecated=True)
async def old_login_redirect():
    return RedirectResponse(url="/api/customer-service/login", status_code=308)

# POST/PUT/DELETEï¼šåŒæ³¨å†ŒåŒä¸€å¤„ç†å™¨
@router.post("/api/cs/chats/{chat_id}/end")
@router.post("/api/customer-service/chats/{chat_id}/end")
async def end_chat(chat_id: str, ...):
    # åŒä¸€å¤„ç†é€»è¾‘
    pass
```

#### 4. é€Ÿç‡é™åˆ¶è£…é¥°å™¨åˆ‡æ¢ä¸ºå¼‚æ­¥å®ç°å¹¶è¦†ç›–æ¸…å•é‡Œæ‰€æœ‰ç«¯ç‚¹

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ£€æŸ¥æ²¡æœ‰ `asyncio.run` åŒæ­¥åŒ…è£¹æ®‹ç•™
- [ ] å¯¹æ¶ˆæ¯/ä¸Šä¼ /ç»“æŸ/è¯„åˆ†ç­‰ç«¯ç‚¹ç”Ÿæ•ˆï¼ˆè¦†ç›–æ¸…å•ä¸­çš„9ä¸ªç«¯ç‚¹ï¼‰
- [ ] æº¢å‡ºè¿”å› 429 çŠ¶æ€ç 
- [ ] éªŒè¯æ¢å¤çª—å£è¡Œä¸º

**è¦†ç›–æ¸…å•ç«¯ç‚¹**ï¼š
1. `POST /api/user/customer-service/chats/{chat_id}/messages` - ç”¨æˆ·å‘é€æ¶ˆæ¯
2. `POST /api/user/customer-service/chats/{chat_id}/files` - ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
3. `POST /api/user/customer-service/chats/{chat_id}/end` - ç”¨æˆ·ç»“æŸå¯¹è¯
4. `POST /api/user/customer-service/chats/{chat_id}/rate` - ç”¨æˆ·è¯„åˆ†
5. `POST /api/customer-service/chats/{chat_id}/messages` - å®¢æœå‘é€æ¶ˆæ¯
6. `POST /api/customer-service/chats/{chat_id}/files` - å®¢æœä¸Šä¼ æ–‡ä»¶
7. `POST /api/customer-service/chats/{chat_id}/end` - å®¢æœç»“æŸå¯¹è¯
8. `POST /api/customer-service/admin-requests/{request_id}/attachments` - ç”³è¯·é™„ä»¶ä¸Šä¼ 
9. `POST /api/customer-service/chats/{chat_id}/admin-messages` - ç®¡ç†å‘˜å‘é€æ¶ˆæ¯

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦æœ‰ asyncio.run æ®‹ç•™
grep -R "asyncio.run" backend/app
# åº”è¯¥è¿”å›ç©ºç»“æœï¼ˆæˆ–ä»…åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ï¼‰
```

#### 5. ç­‰å¾…æ—¶é—´ä¼°ç®—

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] åªä¿ç•™ä¸€ä»½ `calculate_estimated_wait_time` çš„å®ç°
- [ ] è°ƒç”¨æ–¹ä¸€å¾‹å¼•ç”¨å®ƒï¼Œé¿å…å¤šå®ç°æ¼‚ç§»
- [ ] ç¡®ä¿æ‰€æœ‰æ¥å£è¿”å›çš„ `estimated_wait_time` éƒ½è°ƒç”¨æ­¤å‡½æ•°

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦æœ‰å†…è”çš„ç­‰å¾…æ—¶é—´è®¡ç®—
grep -R "queue_position.*\*.*5\|ç­‰å¾….*queue.*\*" backend/app
# åº”è¯¥è¿”å›ç©ºç»“æœï¼ˆæˆ–ä»…åœ¨æ³¨é‡Šä¸­ï¼‰
```

---

### ğŸš€ å»ºè®®å†è¡¥çš„"ä¸´é—¨ä¸€è„š"ï¼ˆå¾ˆå¿«å°±èƒ½åšå®Œï¼‰

#### 1. å›æ»šè¯´æ˜

**éœ€è¦æ·»åŠ çš„å†…å®¹**ï¼š
- [ ] æ—¶é—´/ç´¢å¼•/æ–°å¢åˆ—è¿ç§»éƒ½ç»™å‡ºå›æ»šè„šæœ¬
- [ ] "æ•°æ®å›å¡«â†’æ’¤é”€å‰å¯¼å‡ºå·®å¼‚"çš„æ­¥éª¤
- [ ] é¿å…ç´§æ€¥å›é€€æ—¶ä¸¢æ•°æ®

**å›æ»šè„šæœ¬ç¤ºä¾‹**ï¼š
```python
# migrations/rollback_customer_service_changes.py
def rollback_customer_service_migrations(db: Session):
    """
    å›æ»šå®¢æœåŠŸèƒ½ç›¸å…³è¿ç§»
    æ³¨æ„ï¼šå›æ»šå‰å¿…é¡»å¯¼å‡ºå½“å‰æ•°æ®å·®å¼‚
    """
    # 1. å¯¼å‡ºå½“å‰æ•°æ®ï¼ˆå›æ»šå‰å¿…é¡»æ‰§è¡Œï¼‰
    # 2. åˆ é™¤æ–°å¢å­—æ®µï¼ˆended_reason, ended_by, ended_type, ended_commentï¼‰
    # 3. åˆ é™¤æ–°å¢ç´¢å¼•
    # 4. æ¢å¤æ—¶é—´åˆ—ç±»å‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
    pass
```

#### 2. CI è‡ªæ£€è§„åˆ™æ”¾è¿›ä»“åº“ï¼ˆpre-commit / PR botï¼‰

**éœ€è¦æ·»åŠ çš„ CI è§„åˆ™**ï¼ˆä¸€æ—¦å‘½ä¸­å³é˜»æ–­ï¼‰ï¼š

1. **ç¦ç”¨ datetime.utcnow**
   ```bash
   grep -R "datetime\.utcnow()" backend/app --exclude-dir=migrations
   ```

2. **ç¦ç”¨æ­£æ–‡ pytz**
   ```bash
   grep -R "import pytz\|pytz\.timezone" backend/app docs/ --exclude-dir=migrations
   ```

3. **ç¦ç”¨ HTTP è§¦å‘çš„å®šæ—¶ä»»åŠ¡**
   ```bash
   grep -R "/customer-service/.*auto-end\|send-timeout\|cleanup-long\|process-queue" backend/app/routers.py
   ```

4. **æ¨¡å‹ Column(DateTime(...)) å¿…é¡»å¸¦ timezone=True**
   ```bash
   grep -R "Column(DateTime(" backend/app/models.py | grep -v "timezone=True"
   ```

5. **ç¦æ­¢ file.size / File(.) è¯¯å†™**
   ```bash
   grep -R "File(\.)\|file\.size" backend/app docs/
   ```

**CI é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼ˆ`.github/workflows/pre-commit-checks.yml`ï¼‰ï¼š
```yaml
name: Pre-commit Checks
on: [pull_request]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Check datetime.utcnow
        run: |
          if grep -r "datetime\.utcnow()" backend/app --exclude-dir=migrations; then
            echo "âŒ ç¦æ­¢ä½¿ç”¨ datetime.utcnow()ï¼Œåº”ä½¿ç”¨ get_utc_time()"
            exit 1
          fi
      - name: Check pytz usage
        run: |
          if grep -r "import pytz\|pytz\.timezone" backend/app docs/ --exclude-dir=migrations; then
            echo "âŒ ç¦æ­¢åœ¨æ­£æ–‡ä»£ç ä¸­ä½¿ç”¨ pytzï¼Œåº”ä½¿ç”¨ zoneinfo"
            exit 1
          fi
      # ... å…¶ä»–æ£€æŸ¥
```

---

## ä¸€é¡µå¼ä¸Šçº¿æ¸…å•ï¼ˆæ‰§è¡Œé¡ºåºï¼‰

### é˜¶æ®µ1ï¼šæ•°æ®åº“è¿ç§»ï¼ˆå¿…é¡»å…ˆå®Œæˆï¼‰

- [ ] **DB è¿ç§»**ï¼š
  - [ ] æ–°å¢/æ”¹å‹æ—¶é—´åˆ— `TIMESTAMPTZ`ï¼ˆæ‰€æœ‰ `DateTime` åˆ—åŠ  `timezone=True`ï¼‰
  - [ ] æ–°å¢ç»“æŸè¯­ä¹‰åˆ—ï¼ˆ`ended_reason`/`ended_by`/`ended_type`/`ended_comment`ï¼‰
  - [ ] é˜Ÿåˆ—è¡¨å¤åˆç´¢å¼• `(status, queued_at)` å’Œå•åˆ—ç´¢å¼• `user_id`ã€`status`
  - [ ] è·‘ä¸€é BST/GMT è¾¹ç•ŒæŠ½æ ·æ ¡éªŒï¼ˆç¡®ä¿æ—¶é—´è½¬æ¢æ­£ç¡®ï¼‰

**è¿ç§»è„šæœ¬æ‰§è¡Œé¡ºåº**ï¼š
```bash
# 1. å¤‡ä»½æ•°æ®åº“
pg_dump -h localhost -U postgres -d linku > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. æ‰§è¡Œè¿ç§»
alembic upgrade head

# 3. éªŒè¯è¿ç§»ç»“æœ
python scripts/verify_migration.py
```

### é˜¶æ®µ2ï¼šä»£ç æ›¿æ¢ï¼ˆæ•°æ®åº“è¿ç§»å®Œæˆåï¼‰

- [ ] **åˆå¹¶ time_utils & å…¨åº“æ›¿æ¢**ï¼š
  - [ ] å¯ç”¨ `get_utc_time()`ï¼ˆç¡®ä¿ `backend/app/utils/time_utils.py` å­˜åœ¨ï¼‰
  - [ ] ç§»é™¤é—ç•™ `pytz` æ­£æ–‡ä¾èµ–ï¼ˆä»…è¿ç§»è„šæœ¬ä¿ç•™ï¼‰
  - [ ] å…¨æ–‡æ›¿æ¢ `datetime.utcnow()` â†’ `get_utc_time()`
  - [ ] å…¨æ–‡æ›¿æ¢ `get_uk_time()` â†’ `get_utc_time()`

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# è¿è¡Œæµ‹è¯•ç¡®ä¿æ›¿æ¢æ­£ç¡®
pytest backend/tests/test_time_utils.py
pytest backend/tests/test_customer_service.py
```

### é˜¶æ®µ3ï¼šCelery ä»»åŠ¡ä¸Šçº¿ï¼ˆä»£ç æ›¿æ¢å®Œæˆåï¼‰

- [ ] **å¯ç”¨ Celery + Beat**ï¼š
  - [ ] ä¸Šçº¿å››ç±»å†…éƒ¨ä»»åŠ¡ï¼ˆ`auto_end_timeout_chats`ã€`send_timeout_warnings`ã€`cleanup_long_inactive_chats`ã€`process_customer_service_queue`ï¼‰
  - [ ] é…ç½® `celery_app.conf.beat_schedule`
  - [ ] ç¡®ä¿æ—  HTTP æ®‹ç•™å…¥å£ï¼ˆåˆ é™¤æ‰€æœ‰ `@router.post` å®šæ—¶ä»»åŠ¡è£…é¥°å™¨ï¼‰

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# æ£€æŸ¥ Celery ä»»åŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
celery -A backend.app.celery_app inspect active

# æ£€æŸ¥ Beat è°ƒåº¦æ˜¯å¦æ­£å¸¸
celery -A backend.app.celery_app beat --loglevel=info
```

### é˜¶æ®µ4ï¼šè·¯ç”±è¿ç§»ï¼ˆCelery ä¸Šçº¿åï¼‰

- [ ] **è·¯ç”±è¿ç§»**ï¼š
  - [ ] æ–°æ—§å¹¶è¡Œï¼ˆGET=308ï¼›POST/PUT/DELETE åŒæ³¨å†Œï¼‰
  - [ ] æ—§è·¯ç”±å“åº”å¤´åŠ  `Deprecation: true`
  - [ ] ä¸¤å‘¨åä¸‹çº¿æ—§è·¯ç”±ï¼ˆè®¾ç½®æ—¥å†æé†’ï¼‰

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# æµ‹è¯•æ—§è·¯ç”±æ˜¯å¦æ­£å¸¸é‡å®šå‘/åŒæ³¨å†Œ
curl -I http://localhost:8000/api/cs/login  # åº”è¯¥è¿”å› 308
curl -X POST http://localhost:8000/api/cs/chats/123/end  # åº”è¯¥æ­£å¸¸å“åº”
```

### é˜¶æ®µ5ï¼šé€Ÿç‡é™åˆ¶ç”Ÿæ•ˆï¼ˆè·¯ç”±è¿ç§»åï¼‰

- [ ] **é€Ÿç‡é™åˆ¶å…¨é¢ç”Ÿæ•ˆ**ï¼š
  - [ ] è¦†ç›–æ¸…å•å†…ç«¯ç‚¹æ‰“æ ‡ï¼ˆ9ä¸ªç«¯ç‚¹ï¼‰
  - [ ] å‹æµ‹ 429 è¡Œä¸ºä¸æ¢å¤çª—å£
  - [ ] éªŒè¯ Redis æ»‘åŠ¨çª—å£å®ç°

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# å‹æµ‹é€Ÿç‡é™åˆ¶
ab -n 1000 -c 10 http://localhost:8000/api/user/customer-service/chats/123/messages
# åº”è¯¥åœ¨å‰ N ä¸ªè¯·æ±‚åè¿”å› 429
```

### é˜¶æ®µ6ï¼šWebSocket åˆ‡æ¢ï¼ˆé€Ÿç‡é™åˆ¶ç”Ÿæ•ˆåï¼‰

- [ ] **WS æƒå¨å®ç°åˆ‡æ¢**ï¼š
  - [ ] å¿ƒè·³/ACK/åç§»é‡æ”¾ç»Ÿä¸€æ—¶é—´æºï¼ˆä½¿ç”¨ `get_utc_time()`ï¼‰
  - [ ] æ–­çº¿é‡è¿å›æ”¾éªŒè¯
  - [ ] éªŒè¯æ¶ˆæ¯çŠ¶æ€æµè½¬ï¼ˆsent/delivered/readï¼‰

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# ä½¿ç”¨ WebSocket å®¢æˆ·ç«¯æµ‹è¯•
# 1. è¿æ¥ WebSocket
# 2. å‘é€æ¶ˆæ¯
# 3. æ–­å¼€è¿æ¥
# 4. é‡è¿å¹¶éªŒè¯æ¶ˆæ¯é‡æ”¾
```

### é˜¶æ®µ7ï¼šæ–‡ä»¶ä¸Šä¼ éªŒè¯ï¼ˆWebSocket åˆ‡æ¢åï¼‰

- [ ] **æ–‡ä»¶ä¸Šä¼ èµ°å”¯ä¸€èŒƒå¼**ï¼š
  - [ ] ç™½åå•+ä½“ç§¯ä¸Šé™+ç­¾å URL
  - [ ] å›å½’æµ‹è¯• `File(...)` ä¸ `size` ç»Ÿè®¡
  - [ ] éªŒè¯æµå¼è¯»å–è®¡ç®—å¤§å°

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
curl -X POST -F "file=@test.png" http://localhost:8000/api/user/customer-service/chats/123/files
# åº”è¯¥æ­£å¸¸ä¸Šä¼ å¹¶è¿”å›æ–‡ä»¶ä¿¡æ¯ï¼ˆåŒ…å«æ­£ç¡®çš„ sizeï¼‰
```

---

## é™„å½•ï¼šä¸æ¨èæ–¹æ¡ˆï¼ˆä»…ä¾›å†å²å‚è€ƒï¼‰

ä»¥ä¸‹æ–¹æ¡ˆä¸æ¨èä½¿ç”¨ï¼Œå®é™…å®ç°åº”ç»Ÿä¸€ä½¿ç”¨Celeryä»»åŠ¡ï¼Œä¸åº”æš´éœ²HTTPç«¯ç‚¹ã€‚

### HTTPç«¯ç‚¹æ–¹æ¡ˆï¼ˆä¸æ¨èï¼‰

âš ï¸ **å¼ºçƒˆå»ºè®®**ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ä½¿ç”¨Celeryï¼Œä¸è¦ä½¿ç”¨HTTPç«¯ç‚¹ã€‚ä»¥ä¸‹ç¤ºä¾‹ä»…ä¾›å†å²å‚è€ƒã€‚

```python
# âš ï¸ ä¸æ¨èï¼šHTTPç«¯ç‚¹æ–¹æ¡ˆï¼ˆä»…ä¾›å†å²å‚è€ƒï¼‰
# å¦‚æœç¡®å®éœ€è¦HTTPç«¯ç‚¹ï¼ˆä¾‹å¦‚ç®¡ç†åå°æ‰‹åŠ¨è§¦å‘ï¼‰ï¼Œåº”ä½¿ç”¨ä»¥ä¸‹ä¸¥æ ¼æƒé™æ§åˆ¶ï¼š
# 
# @router.post("/api/customer-service/internal/auto-end-timeout-chats")
# async def auto_end_timeout_chats_internal(
#     request: Request,
#     db: Session = Depends(get_db),
#     admin_user=Depends(get_admin_user)  # éœ€è¦ç®¡ç†å‘˜æƒé™
# ):
#     """è‡ªåŠ¨ç»“æŸè¶…æ—¶å¯¹è¯ - ä»…é™ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘ï¼ˆä¸æ¨èï¼Œä¼˜å…ˆä½¿ç”¨Celeryï¼‰"""
#     # 1. ç®¡ç†å‘˜æƒé™éªŒè¯ï¼ˆå·²åœ¨Dependsä¸­å®Œæˆï¼‰
#     # 2. IPç™½åå•æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œé¢å¤–å®‰å…¨å±‚ï¼‰
#     # 3. ç­¾åéªŒè¯ï¼ˆéœ€è¦await request.body()ï¼ŒFastAPIä¸‹å¿…é¡»ä½¿ç”¨async defï¼‰
#     signature = request.headers.get("X-Signature")
#     body = await request.body()  # FastAPIéœ€è¦awaitè·å–body
#     if not verify_signature(signature, body):
#         raise HTTPException(status_code=403, detail="Invalid signature")
#     # 4. é€Ÿç‡é™åˆ¶
#     # 5. å¹‚ç­‰æ€§æ£€æŸ¥
#     # æ‰§è¡Œé€»è¾‘...
#     pass
# 
# æ³¨æ„ï¼šæ­¤ç«¯ç‚¹ä»…ç”¨äºç®¡ç†åå°æ‰‹åŠ¨è§¦å‘ï¼Œä¸åº”ä½œä¸ºå®šæ—¶ä»»åŠ¡çš„æ›¿ä»£æ–¹æ¡ˆ
# âš ï¸ å¼ºçƒˆå»ºè®®ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ä½¿ç”¨Celeryï¼Œä¸è¦ä½¿ç”¨HTTPç«¯ç‚¹
```

---

*æœ€åæ›´æ–°ï¼š2024å¹´12æœˆ28æ—¥*
*ç»´æŠ¤è€…ï¼šå¼€å‘å›¢é˜Ÿ*

