# é¢„ä»˜æ¬¾ï¼ˆé¢„æˆæƒï¼‰æ–¹æ¡ˆåˆ†æ

## ğŸ“‹ å½“å‰æ”¯ä»˜æµç¨‹

**å½“å‰å®ç°**ï¼š
- ä½¿ç”¨ Stripe PaymentIntentï¼Œæ”¯ä»˜æ—¶**ç«‹å³æ‰£æ¬¾**
- èµ„é‡‘è¿›å…¥å¹³å°è´¦æˆ·ï¼ˆæ‰˜ç®¡æ¨¡å¼ï¼‰
- ä»»åŠ¡å®Œæˆåè½¬è´¦ç»™æ¥å—äºº

**æ”¯ä»˜æ—¶æœº**ï¼š
- æ‰¹å‡†ç”³è¯·æ—¶åˆ›å»º PaymentIntent
- ç”¨æˆ·åœ¨å‰ç«¯ç¡®è®¤æ”¯ä»˜
- æ”¯ä»˜æˆåŠŸåç«‹å³æ‰£æ¬¾ï¼ˆ`payment_intent.succeeded` webhookï¼‰

---

## ğŸ’¡ é¢„ä»˜æ¬¾ï¼ˆé¢„æˆæƒï¼‰æ–¹æ¡ˆ

### ä»€ä¹ˆæ˜¯é¢„æˆæƒï¼Ÿ

**é¢„æˆæƒï¼ˆAuthorization Holdï¼‰**ï¼š
- å†»ç»“ç”¨æˆ·å¡ä¸Šçš„èµ„é‡‘ï¼Œä½†ä¸å®é™…æ‰£æ¬¾
- èµ„é‡‘ä»ç„¶åœ¨ç”¨æˆ·è´¦æˆ·ä¸­ï¼Œä½†ä¸å¯ç”¨
- åœ¨ä¸€å®šæ—¶é—´åè‡ªåŠ¨é‡Šæ”¾ï¼ˆé€šå¸¸7-30å¤©ï¼‰
- éœ€è¦ä¸»åŠ¨"æ•è·"ï¼ˆCaptureï¼‰æ‰ä¼šå®é™…æ‰£æ¬¾

**Stripe å®ç°æ–¹å¼**ï¼š
- ä½¿ç”¨ `capture_method: 'manual'` åˆ›å»º PaymentIntent
- æ”¯ä»˜æ—¶åªå†»ç»“èµ„é‡‘ï¼Œä¸æ‰£æ¬¾
- ä»»åŠ¡å®Œæˆæ—¶è°ƒç”¨ `PaymentIntent.capture()` å®é™…æ‰£æ¬¾

---

## âš ï¸ é¢„ä»˜æ¬¾çš„é£é™©åˆ†æ

### 1. èµ„é‡‘ä¸è¶³é£é™©ï¼ˆæœ€ä¸¥é‡ï¼‰âš ï¸

**é—®é¢˜åœºæ™¯**ï¼š
```
æ—¶é—´çº¿ï¼š
Day 1: ç”¨æˆ·æ”¯ä»˜ï¼Œé¢„æˆæƒå†»ç»“ Â£100
Day 2-7: ä»»åŠ¡è¿›è¡Œä¸­ï¼Œç”¨æˆ·æ¶ˆè´¹äº†å¡ä¸Šçš„é’±
Day 8: ä»»åŠ¡å®Œæˆï¼Œå°è¯•æ•è· Â£100
ç»“æœï¼šâŒ èµ„é‡‘ä¸è¶³ï¼Œæ•è·å¤±è´¥
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ **é«˜**

**å½±å“**ï¼š
- ä»»åŠ¡å·²å®Œæˆï¼Œä½†æ— æ³•æ‰£æ¬¾
- æ¥å—äººæ— æ³•æ”¶åˆ°æ¬¾é¡¹
- å¹³å°éœ€è¦å¤„ç†èµ„é‡‘ä¸è¶³çš„æƒ…å†µ
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆä»»åŠ¡å®Œæˆä½†æ”¯ä»˜å¤±è´¥ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **å®æ—¶ä½™é¢æ£€æŸ¥**ï¼ˆæ¨èï¼‰
   - æ•è·å‰æ£€æŸ¥å¡ä½™é¢
   - å¦‚æœä½™é¢ä¸è¶³ï¼Œé€šçŸ¥ç”¨æˆ·å……å€¼
   - æä¾›é‡è¯•æœºåˆ¶

2. **è‡ªåŠ¨é‡è¯•æœºåˆ¶**
   - æ•è·å¤±è´¥åï¼Œæ¯24å°æ—¶è‡ªåŠ¨é‡è¯•ä¸€æ¬¡
   - æœ€å¤šé‡è¯•7å¤©
   - 7å¤©åä»å¤±è´¥ï¼Œæ ‡è®°ä¸ºéœ€è¦äººå·¥å¤„ç†

3. **é¢„æˆæƒåˆ°æœŸå¤„ç†**
   - Stripe é¢„æˆæƒé€šå¸¸7-30å¤©åè‡ªåŠ¨é‡Šæ”¾
   - å¦‚æœä»»åŠ¡æœªå®Œæˆï¼Œé¢„æˆæƒå·²é‡Šæ”¾ï¼Œéœ€è¦é‡æ–°æˆæƒ
   - éœ€è¦ç›‘æ§é¢„æˆæƒçŠ¶æ€

4. **é™çº§æ–¹æ¡ˆ**
   - å¦‚æœæ•è·å¤±è´¥ï¼Œå…è®¸ç”¨æˆ·é‡æ–°æ”¯ä»˜
   - æˆ–ä½¿ç”¨å¤‡ç”¨æ”¯ä»˜æ–¹å¼

### 2. é¢„æˆæƒè¿‡æœŸé£é™© âš ï¸

**é—®é¢˜åœºæ™¯**ï¼š
```
æ—¶é—´çº¿ï¼š
Day 1: é¢„æˆæƒå†»ç»“ Â£100ï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰
Day 2-7: ä»»åŠ¡è¿›è¡Œä¸­
Day 8: é¢„æˆæƒå·²è¿‡æœŸï¼Œèµ„é‡‘è‡ªåŠ¨é‡Šæ”¾
Day 9: ä»»åŠ¡å®Œæˆï¼Œå°è¯•æ•è·
ç»“æœï¼šâŒ é¢„æˆæƒå·²è¿‡æœŸï¼Œæ— æ³•æ•è·
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ **ä¸­**

**å½±å“**ï¼š
- é•¿æœŸä»»åŠ¡ï¼ˆ>7å¤©ï¼‰å¯èƒ½é‡åˆ°é¢„æˆæƒè¿‡æœŸ
- éœ€è¦é‡æ–°æˆæƒæˆ–ç«‹å³æ‰£æ¬¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **é¢„æˆæƒå»¶æœŸ**
   - Stripe æ”¯æŒå»¶é•¿é¢„æˆæƒæœ‰æ•ˆæœŸ
   - ä»»åŠ¡è¿›è¡Œä¸­å®šæœŸæ£€æŸ¥å¹¶å»¶æœŸ

2. **è‡ªåŠ¨è½¬æ¢**
   - é¢„æˆæƒå³å°†è¿‡æœŸæ—¶ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºç«‹å³æ‰£æ¬¾
   - æˆ–é€šçŸ¥ç”¨æˆ·é‡æ–°æˆæƒ

3. **ä»»åŠ¡æ—¶é•¿é™åˆ¶**
   - åªå¯¹çŸ­æœŸä»»åŠ¡ï¼ˆ<7å¤©ï¼‰ä½¿ç”¨é¢„æˆæƒ
   - é•¿æœŸä»»åŠ¡ä½¿ç”¨ç«‹å³æ‰£æ¬¾

### 3. ç”¨æˆ·å–æ¶ˆ/é€€æ¬¾å¤æ‚æ€§ âš ï¸

**é—®é¢˜åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šç”¨æˆ·å–æ¶ˆä»»åŠ¡ï¼ˆé¢„æˆæƒé˜¶æ®µï¼‰
- é¢„æˆæƒå°šæœªæ•è·
- éœ€è¦é‡Šæ”¾é¢„æˆæƒï¼ˆReleaseï¼‰
- æ¯”é€€æ¬¾æ›´ç®€å•ï¼ˆæ— éœ€å®é™…é€€æ¬¾ï¼‰

åœºæ™¯2ï¼šç”¨æˆ·ç”³è¯·é€€æ¬¾ï¼ˆå·²æ•è·ï¼‰
- å·²å®é™…æ‰£æ¬¾
- éœ€è¦é€€æ¬¾æµç¨‹
- ä¸å½“å‰é€€æ¬¾æµç¨‹ç›¸åŒ
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¢ **ä½**

**å½±å“**ï¼š
- é¢„æˆæƒé˜¶æ®µå–æ¶ˆæ›´ç®€å•ï¼ˆåªéœ€é‡Šæ”¾ï¼‰
- å·²æ•è·åé€€æ¬¾ä¸å½“å‰æµç¨‹ç›¸åŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é¢„æˆæƒé˜¶æ®µï¼šè°ƒç”¨ `PaymentIntent.cancel()` é‡Šæ”¾èµ„é‡‘
- å·²æ•è·é˜¶æ®µï¼šä½¿ç”¨ç°æœ‰é€€æ¬¾æµç¨‹

### 4. ç”¨æˆ·ä½“éªŒé£é™© âš ï¸

**é—®é¢˜åœºæ™¯**ï¼š
- ç”¨æˆ·çœ‹åˆ°èµ„é‡‘è¢«å†»ç»“ï¼Œå¯èƒ½æ‹…å¿ƒ
- é¢„æˆæƒé‡Šæ”¾åï¼Œç”¨æˆ·å¯èƒ½å¿˜è®°ä»»åŠ¡
- æ•è·å¤±è´¥æ—¶ï¼Œç”¨æˆ·éœ€è¦é‡æ–°æ”¯ä»˜

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ **ä¸­**

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¸…æ™°çš„ç”¨æˆ·æç¤ºï¼š"èµ„é‡‘å·²å†»ç»“ï¼Œä»»åŠ¡å®Œæˆåæ‰£æ¬¾"
- å®æ—¶é€šçŸ¥é¢„æˆæƒçŠ¶æ€
- æ•è·å¤±è´¥æ—¶ï¼Œå‹å¥½çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶

---

## ğŸ’° æ‰‹ç»­è´¹èŠ‚çœåˆ†æ

### Stripe æ‰‹ç»­è´¹ç»“æ„

**å½“å‰æ¨¡å¼ï¼ˆç«‹å³æ‰£æ¬¾ï¼‰**ï¼š
- æ”¯ä»˜æ—¶ï¼šæ”¶å–æ‰‹ç»­è´¹ï¼ˆçº¦ 1.4% + Â£0.25ï¼‰
- è½¬è´¦æ—¶ï¼šæ”¶å–è½¬è´¦æ‰‹ç»­è´¹ï¼ˆçº¦ 0.25%ï¼‰

**é¢„æˆæƒæ¨¡å¼**ï¼š
- é¢„æˆæƒæ—¶ï¼š**ä¸æ”¶å–æ‰‹ç»­è´¹**ï¼ˆåªå†»ç»“èµ„é‡‘ï¼‰
- æ•è·æ—¶ï¼šæ”¶å–æ‰‹ç»­è´¹ï¼ˆçº¦ 1.4% + Â£0.25ï¼‰
- è½¬è´¦æ—¶ï¼šæ”¶å–è½¬è´¦æ‰‹ç»­è´¹ï¼ˆçº¦ 0.25%ï¼‰

### æ‰‹ç»­è´¹èŠ‚çœåœºæ™¯

**åœºæ™¯1ï¼šç”¨æˆ·å–æ¶ˆä»»åŠ¡ï¼ˆé¢„æˆæƒé˜¶æ®µï¼‰**
- âœ… **èŠ‚çœæ‰‹ç»­è´¹**ï¼šé¢„æˆæƒé‡Šæ”¾ï¼Œæ— éœ€æ”¯ä»˜æ‰‹ç»­è´¹
- èŠ‚çœé‡‘é¢ï¼šçº¦ 1.4% + Â£0.25

**åœºæ™¯2ï¼šä»»åŠ¡æ­£å¸¸å®Œæˆ**
- âŒ **ä¸èŠ‚çœæ‰‹ç»­è´¹**ï¼šæ•è·æ—¶ä»éœ€æ”¯ä»˜æ‰‹ç»­è´¹
- æ‰‹ç»­è´¹ä¸ç«‹å³æ‰£æ¬¾ç›¸åŒ

**åœºæ™¯3ï¼šé¢„æˆæƒè¿‡æœŸï¼Œç”¨æˆ·é‡æ–°æ”¯ä»˜**
- âŒ **å¯èƒ½å¢åŠ æ‰‹ç»­è´¹**ï¼šå¦‚æœé‡æ–°æˆæƒå¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç«‹å³æ‰£æ¬¾
- å¯èƒ½äº§ç”Ÿé¢å¤–è´¹ç”¨

### æ‰‹ç»­è´¹èŠ‚çœè¯„ä¼°

**èŠ‚çœæ¡ä»¶**ï¼š
- âœ… ç”¨æˆ·å–æ¶ˆç‡ > 0%ï¼šæ¯ç¬”å–æ¶ˆèŠ‚çœçº¦ 1.4% + Â£0.25
- âŒ æ­£å¸¸å®Œæˆï¼šä¸èŠ‚çœæ‰‹ç»­è´¹
- âš ï¸ é¢„æˆæƒè¿‡æœŸï¼šå¯èƒ½å¢åŠ æˆæœ¬

**å®é™…èŠ‚çœ**ï¼š
- å¦‚æœå–æ¶ˆç‡ä¸º 10%ï¼Œå¹³å‡ä»»åŠ¡é‡‘é¢ Â£50
- æ¯100ç¬”ä»»åŠ¡ï¼Œ10ç¬”å–æ¶ˆ
- èŠ‚çœï¼š10 Ã— (50 Ã— 0.014 + 0.25) = 10 Ã— Â£0.95 = Â£9.50
- èŠ‚çœç‡ï¼šçº¦ 0.19%ï¼ˆç›¸å¯¹äºæ€»äº¤æ˜“é¢ï¼‰

**ç»“è®º**ï¼š
- ğŸ’¡ **æ‰‹ç»­è´¹èŠ‚çœæœ‰é™**ï¼šä¸»è¦å–å†³äºå–æ¶ˆç‡
- ğŸ’¡ **é£é™©æˆæœ¬å¯èƒ½æ›´é«˜**ï¼šèµ„é‡‘ä¸è¶³ã€é¢„æˆæƒè¿‡æœŸç­‰é—®é¢˜çš„å¤„ç†æˆæœ¬
- ğŸ’¡ **å»ºè®®**ï¼šå¦‚æœå–æ¶ˆç‡ < 5%ï¼Œé¢„æˆæƒçš„æ‰‹ç»­è´¹èŠ‚çœå¯èƒ½ä¸è¶³ä»¥è¦†ç›–é£é™©æˆæœ¬

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå®Œå…¨é¢„æˆæƒï¼ˆé«˜é£é™©ï¼‰

**æµç¨‹**ï¼š
1. åˆ›å»º PaymentIntentï¼ˆ`capture_method: 'manual'`ï¼‰
2. ç”¨æˆ·æ”¯ä»˜ï¼Œé¢„æˆæƒå†»ç»“èµ„é‡‘
3. ä»»åŠ¡å®Œæˆæ—¶ï¼Œæ•è· PaymentIntent
4. å¦‚æœæ•è·å¤±è´¥ï¼Œå¤„ç†èµ„é‡‘ä¸è¶³

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€å¤§ç¨‹åº¦èŠ‚çœæ‰‹ç»­è´¹ï¼ˆå–æ¶ˆæ—¶ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆèµ„é‡‘åœ¨ä»»åŠ¡å®Œæˆåæ‰æ‰£æ¬¾ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ èµ„é‡‘ä¸è¶³é£é™©é«˜
- âŒ é¢„æˆæƒè¿‡æœŸé£é™©
- âŒ éœ€è¦å¤æ‚çš„é”™è¯¯å¤„ç†

### æ–¹æ¡ˆ2ï¼šæ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰â­

**æµç¨‹**ï¼š
1. **çŸ­æœŸä»»åŠ¡ï¼ˆ<7å¤©ï¼‰**ï¼šä½¿ç”¨é¢„æˆæƒ
2. **é•¿æœŸä»»åŠ¡ï¼ˆ>7å¤©ï¼‰**ï¼šä½¿ç”¨ç«‹å³æ‰£æ¬¾
3. **é«˜ä»·å€¼ä»»åŠ¡ï¼ˆ>Â£200ï¼‰**ï¼šä½¿ç”¨ç«‹å³æ‰£æ¬¾ï¼ˆé™ä½é£é™©ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… å¹³è¡¡é£é™©å’Œæ”¶ç›Š
- âœ… çŸ­æœŸä»»åŠ¡èŠ‚çœæ‰‹ç»­è´¹
- âœ… é•¿æœŸä»»åŠ¡é™ä½é£é™©

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦åˆ¤æ–­ä»»åŠ¡ç±»å‹
- âš ï¸ å®ç°ç¨å¤æ‚

### æ–¹æ¡ˆ3ï¼šæ™ºèƒ½é¢„æˆæƒï¼ˆæœ€å®‰å…¨ï¼‰

**æµç¨‹**ï¼š
1. åˆ›å»º PaymentIntentï¼ˆ`capture_method: 'manual'`ï¼‰
2. ç”¨æˆ·æ”¯ä»˜ï¼Œé¢„æˆæƒå†»ç»“èµ„é‡‘
3. **ä»»åŠ¡å®Œæˆå‰3å¤©**ï¼šè‡ªåŠ¨æ•è·ï¼ˆé¿å…è¿‡æœŸï¼‰
4. å¦‚æœæ•è·å¤±è´¥ï¼Œé€šçŸ¥ç”¨æˆ·å¹¶é‡è¯•

**ä¼˜ç‚¹**ï¼š
- âœ… é¿å…é¢„æˆæƒè¿‡æœŸ
- âœ… ç»™ç”¨æˆ·æ—¶é—´å¤„ç†èµ„é‡‘ä¸è¶³
- âœ… é™ä½é£é™©

**ç¼ºç‚¹**ï¼š
- âš ï¸ å®ç°å¤æ‚
- âš ï¸ éœ€è¦å®šæ—¶ä»»åŠ¡

---

## ğŸ“Š é£é™© vs æ”¶ç›Šå¯¹æ¯”

| æ–¹æ¡ˆ | æ‰‹ç»­è´¹èŠ‚çœ | èµ„é‡‘ä¸è¶³é£é™© | é¢„æˆæƒè¿‡æœŸé£é™© | å®ç°å¤æ‚åº¦ | æ¨èåº¦ |
|------|-----------|------------|--------------|-----------|--------|
| å½“å‰ï¼ˆç«‹å³æ‰£æ¬¾ï¼‰ | 0% | ä½ | æ—  | ä½ | â­â­â­â­â­ |
| å®Œå…¨é¢„æˆæƒ | ä¸­ç­‰ï¼ˆå–å†³äºå–æ¶ˆç‡ï¼‰ | é«˜ | é«˜ | é«˜ | â­â­ |
| æ··åˆæ¨¡å¼ | ä½-ä¸­ç­‰ | ä¸­ | ä¸­ | ä¸­ | â­â­â­â­ |
| æ™ºèƒ½é¢„æˆæƒ | ä½-ä¸­ç­‰ | ä¸­ | ä½ | é«˜ | â­â­â­ |

---

## ğŸ’¡ å»ºè®®

### å¦‚æœå–æ¶ˆç‡ < 5%
**å»ºè®®**ï¼šâŒ **ä¸å»ºè®®ä½¿ç”¨é¢„æˆæƒ**
- æ‰‹ç»­è´¹èŠ‚çœæœ‰é™ï¼ˆ<0.1%ï¼‰
- é£é™©æˆæœ¬å¯èƒ½æ›´é«˜
- ç”¨æˆ·ä½“éªŒæå‡ä¸æ˜æ˜¾

### å¦‚æœå–æ¶ˆç‡ 5-15%
**å»ºè®®**ï¼šâœ… **ä½¿ç”¨æ··åˆæ¨¡å¼**
- çŸ­æœŸä»»åŠ¡ä½¿ç”¨é¢„æˆæƒ
- é•¿æœŸä»»åŠ¡ä½¿ç”¨ç«‹å³æ‰£æ¬¾
- å¹³è¡¡é£é™©å’Œæ”¶ç›Š

### å¦‚æœå–æ¶ˆç‡ > 15%
**å»ºè®®**ï¼šâœ… **ä½¿ç”¨æ™ºèƒ½é¢„æˆæƒ**
- æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨é¢„æˆæƒ
- ä»»åŠ¡å®Œæˆå‰3å¤©è‡ªåŠ¨æ•è·
- å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†

---

## ğŸ”¨ å®ç°è¦ç‚¹

### 1. PaymentIntent åˆ›å»º

```python
payment_intent = stripe.PaymentIntent.create(
    amount=amount_pence,
    currency="gbp",
    capture_method="manual",  # é¢„æˆæƒæ¨¡å¼
    payment_method_types=["card", "wechat_pay"],
    metadata={
        "task_id": str(task_id),
        "capture_after": str(capture_after_timestamp),  # å»ºè®®æ•è·æ—¶é—´
    }
)
```

### 2. æ•è· PaymentIntent

```python
# ä»»åŠ¡å®Œæˆæ—¶æ•è·
try:
    payment_intent = stripe.PaymentIntent.capture(
        payment_intent_id,
        amount_to_capture=amount_pence  # å¯ä»¥éƒ¨åˆ†æ•è·
    )
except stripe.error.CardError as e:
    # èµ„é‡‘ä¸è¶³å¤„ç†
    if e.code == "card_declined":
        # é€šçŸ¥ç”¨æˆ·ï¼Œæä¾›é‡è¯•æœºåˆ¶
        handle_insufficient_funds(payment_intent_id, task_id)
```

### 3. é¢„æˆæƒè¿‡æœŸæ£€æŸ¥

```python
# å®šæœŸæ£€æŸ¥é¢„æˆæƒçŠ¶æ€
def check_authorization_expiry(db):
    # æŸ¥æ‰¾å³å°†è¿‡æœŸçš„é¢„æˆæƒï¼ˆä»»åŠ¡æœªå®Œæˆï¼‰
    pending_tasks = db.query(Task).filter(
        Task.is_paid == 0,  # é¢„æˆæƒï¼Œæœªå®é™…æ‰£æ¬¾
        Task.payment_intent_id.isnot(None)
    ).all()
    
    for task in pending_tasks:
        payment_intent = stripe.PaymentIntent.retrieve(task.payment_intent_id)
        
        # æ£€æŸ¥é¢„æˆæƒçŠ¶æ€
        if payment_intent.status == "requires_capture":
            # å¦‚æœå³å°†è¿‡æœŸï¼ˆ<24å°æ—¶ï¼‰ï¼Œæå‰æ•è·
            if should_capture_early(payment_intent):
                capture_payment_intent(task.payment_intent_id)
```

### 4. èµ„é‡‘ä¸è¶³å¤„ç†

```python
def handle_insufficient_funds(payment_intent_id, task_id):
    # 1. é€šçŸ¥ç”¨æˆ·
    send_notification(
        user_id=task.poster_id,
        type="payment_capture_failed",
        title="æ”¯ä»˜å¤±è´¥",
        content="ä»»åŠ¡å·²å®Œæˆï¼Œä½†æ”¯ä»˜å¤±è´¥ã€‚è¯·ç¡®ä¿å¡ä¸Šæœ‰è¶³å¤Ÿä½™é¢ã€‚"
    )
    
    # 2. åˆ›å»ºé‡è¯•ä»»åŠ¡
    schedule_retry_capture(
        payment_intent_id=payment_intent_id,
        task_id=task_id,
        retry_count=0,
        max_retries=7
    )
    
    # 3. æ ‡è®°ä»»åŠ¡çŠ¶æ€
    task.payment_status = "capture_failed"
    task.capture_retry_count = 0
```

---

## ğŸ“ æ€»ç»“

### é¢„ä»˜æ¬¾çš„é£é™©

1. **èµ„é‡‘ä¸è¶³é£é™©**ï¼ˆæœ€ä¸¥é‡ï¼‰ï¼šä»»åŠ¡å®Œæˆæ—¶æ— æ³•æ‰£æ¬¾
2. **é¢„æˆæƒè¿‡æœŸé£é™©**ï¼šé•¿æœŸä»»åŠ¡å¯èƒ½é‡åˆ°é¢„æˆæƒè¿‡æœŸ
3. **ç”¨æˆ·ä½“éªŒé£é™©**ï¼šæ•è·å¤±è´¥éœ€è¦é‡æ–°æ”¯ä»˜
4. **å®ç°å¤æ‚åº¦**ï¼šéœ€è¦å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

### æ‰‹ç»­è´¹èŠ‚çœ

- **èŠ‚çœæœ‰é™**ï¼šä¸»è¦å–å†³äºå–æ¶ˆç‡
- **å¦‚æœå–æ¶ˆç‡ < 5%**ï¼šèŠ‚çœ < 0.1%ï¼Œå¯èƒ½ä¸è¶³ä»¥è¦†ç›–é£é™©æˆæœ¬
- **å¦‚æœå–æ¶ˆç‡ > 15%**ï¼šèŠ‚çœçº¦ 0.2-0.3%ï¼Œå€¼å¾—è€ƒè™‘

### å»ºè®®

1. **å…ˆåˆ†æå–æ¶ˆç‡**ï¼šå¦‚æœ < 5%ï¼Œä¸å»ºè®®ä½¿ç”¨é¢„æˆæƒ
2. **ä½¿ç”¨æ··åˆæ¨¡å¼**ï¼šçŸ­æœŸä»»åŠ¡é¢„æˆæƒï¼Œé•¿æœŸä»»åŠ¡ç«‹å³æ‰£æ¬¾
3. **å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†**ï¼šèµ„é‡‘ä¸è¶³ã€é¢„æˆæƒè¿‡æœŸç­‰
4. **ç›‘æ§å’Œä¼˜åŒ–**ï¼šè·Ÿè¸ªé¢„æˆæƒæˆåŠŸç‡ï¼ŒæŒç»­ä¼˜åŒ–

---

**ç»“è®º**ï¼šé¢„æˆæƒå¯ä»¥èŠ‚çœæ‰‹ç»­è´¹ï¼Œä½†é£é™©è¾ƒé«˜ã€‚å»ºè®®å…ˆåˆ†æä¸šåŠ¡æ•°æ®ï¼ˆå–æ¶ˆç‡ã€ä»»åŠ¡æ—¶é•¿ï¼‰ï¼Œå†å†³å®šæ˜¯å¦å®æ–½ã€‚
