# å®¢æœåŠŸèƒ½ä¼˜åŒ–æ—¥å¿—å¯è¡Œæ€§è¯„ä¼°æŠ¥å‘Š

> **è¯„ä¼°æ—¥æœŸ**: 2024-12-28  
> **è¯„ä¼°å¯¹è±¡**: `å®¢æœåŠŸèƒ½ä¼˜åŒ–æ—¥å¿—.md`  
> **é¡¹ç›®**: LinkUå¹³å°

---

## ğŸ“Š æ€»ä½“è¯„ä¼°

**å¯è¡Œæ€§è¯„åˆ†**: â­â­â­â­ (4/5) - **é«˜åº¦å¯è¡Œï¼Œä½†éœ€è¦åˆ†é˜¶æ®µå®æ–½**

**ä¸»è¦ç»“è®º**:
- âœ… å¤§éƒ¨åˆ†ä¼˜åŒ–æ–¹æ¡ˆæŠ€æœ¯å¯è¡Œï¼Œä¸é¡¹ç›®æ¶æ„å…¼å®¹
- âš ï¸ æ—¶é—´ç»Ÿä¸€ä¼˜åŒ–éœ€è¦æ•°æ®åº“è¿ç§»ï¼Œå­˜åœ¨æ•°æ®å…¼å®¹é£é™©
- âš ï¸ Celeryå¼•å…¥éœ€è¦è¯„ä¼°ç°æœ‰å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ
- âœ… æ–°å¢å­—æ®µå’ŒåŠŸèƒ½å¢å¼ºå¯ä»¥ç«‹å³å®æ–½
- âœ… è·¯ç”±é‡æ„å¯ä»¥å‘åå…¼å®¹
- âœ… å®‰å…¨ä¼˜åŒ–å¯ä»¥ç«‹å³å®æ–½

---

## ğŸ” è¯¦ç»†å¯è¡Œæ€§åˆ†æ

### 1. âš ï¸ æ—¶é—´å¤„ç†ç»Ÿä¸€ï¼ˆé«˜é£é™©ï¼Œéœ€è°¨æ…ï¼‰

#### å½“å‰å®ç°çŠ¶æ€
```python
# backend/app/models.py
def get_uk_time():
    """è·å–å½“å‰è‹±å›½æ—¶é—´ (è‡ªåŠ¨å¤„ç†å¤ä»¤æ—¶/å†¬ä»¤æ—¶)"""
    import pytz
    uk_tz = pytz.timezone("Europe/London")
    return datetime.now(uk_tz)

# æ¨¡å‹å®šä¹‰
class CustomerServiceChat(Base):
    created_at = Column(DateTime, default=get_uk_time)  # DateTimeæ— æ—¶åŒº
    last_message_at = Column(DateTime, default=get_uk_time)
```

**å‘ç°çš„é—®é¢˜**:
- âœ… é¡¹ç›®ä¸­ç¡®å®æ··ç”¨äº† `get_uk_time()`, `datetime.utcnow()`, `get_utc_time()` ç­‰å¤šç§æ—¶é—´å‡½æ•°
- âœ… `CustomerServiceChat` å’Œ `CustomerServiceMessage` ä½¿ç”¨ `DateTime`ï¼ˆæ— æ—¶åŒºï¼‰
- âœ… é¡¹ç›®ä¸­å·²æœ‰ `get_utc_time()` å‡½æ•°ï¼ˆåœ¨ `models.py` ç¬¬1213è¡Œï¼‰ï¼Œä½†æœªç»Ÿä¸€ä½¿ç”¨

#### æ–‡æ¡£å»ºè®®
```python
# ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´
from app.utils.time_utils import get_utc_time

class CustomerServiceChat(Base):
    created_at = Column(DateTime(timezone=True), default=get_utc_time)  # å¸¦æ—¶åŒºï¼ŒUTC
```

#### âš ï¸ å†²çªç‚¹ä¸é£é™©

1. **æ•°æ®åº“å­—æ®µç±»å‹å˜æ›´**
   - **å½“å‰**: `TIMESTAMP` (æ— æ—¶åŒº)
   - **å»ºè®®**: `TIMESTAMPTZ` (å¸¦æ—¶åŒº)
   - **å½±å“**: éœ€è¦ALTER TABLEï¼Œç°æœ‰æ•°æ®éœ€è¦è½¬æ¢
   - **é£é™©ç­‰çº§**: ğŸ”´ é«˜

2. **æ—¶é—´åŸºå‡†å˜æ›´**
   - **å½“å‰**: å­˜å‚¨ä¼¦æ•¦æ—¶åŒºæ—¶é—´ï¼ˆBST/GMTï¼‰
   - **å»ºè®®**: å­˜å‚¨UTCæ—¶é—´
   - **å½±å“**: ç°æœ‰æ•°æ®éœ€è¦è½¬æ¢ï¼ˆBSTâ†’UTCï¼ŒGMTâ†’UTCï¼‰
   - **é£é™©ç­‰çº§**: ğŸ”´ é«˜ï¼ˆDSTåˆ‡æ¢æ—¶å¯èƒ½å‡ºé”™ï¼‰

3. **å‡½æ•°è°ƒç”¨å˜æ›´**
   - **å½“å‰**: 294å¤„ä½¿ç”¨ `get_uk_time()` æˆ– `datetime.utcnow()`
   - **å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`
   - **å½±å“**: éœ€è¦å…¨é‡æ›¿æ¢ï¼Œå·¥ä½œé‡å¤§
   - **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­

#### âœ… å¯è¡Œæ€§è¯„ä¼°

**æŠ€æœ¯å¯è¡Œæ€§**: âœ… å®Œå…¨å¯è¡Œ
- é¡¹ç›®ä¸­å·²æœ‰ `get_utc_time()` å‡½æ•°
- Python 3.9+ æ”¯æŒ `zoneinfo`ï¼ˆé¡¹ç›®ä½¿ç”¨Python 3.9+ï¼‰
- æ•°æ®åº“æ”¯æŒ `TIMESTAMPTZ` ç±»å‹

**å®æ–½é£é™©**: âš ï¸ é«˜é£é™©
- æ•°æ®è¿ç§»å¯èƒ½å‡ºé”™ï¼ˆç‰¹åˆ«æ˜¯DSTåˆ‡æ¢æ—¥æœŸï¼‰
- éœ€è¦å……åˆ†æµ‹è¯•æ—¶é—´è½¬æ¢é€»è¾‘
- éœ€è¦å‡†å¤‡å›æ»šæ–¹æ¡ˆ

#### ğŸš¨ å…³é”®çº æ­£ï¼šä¸è¦æš—æ”¹å‡½æ•°è¯­ä¹‰

**âŒ é”™è¯¯åšæ³•**ï¼ˆä¼šå¯¼è‡´è¯­ä¹‰é”™ä½ï¼‰:
```python
def get_uk_time():
    """ä¸ºäº†ç»Ÿä¸€æ—¶é—´åŸºå‡†ï¼Œæ­¤å‡½æ•°ç°åœ¨è¿”å›UTCæ—¶é—´"""
    return get_utc_time()  # âŒ é”™è¯¯ï¼šè€ä»£ç ä»¥ä¸ºæ˜¯ä¼¦æ•¦æ—¶é—´ï¼Œå®ä¸ºUTC
```

**âœ… æ­£ç¡®åšæ³•**:
```python
# backend/app/utils/time_utils.py
from datetime import datetime, timezone
from zoneinfo import ZoneInfo
import warnings

def get_utc_time() -> datetime:
    """
    è·å–å½“å‰UTCæ—¶é—´ï¼ˆå¸¦æ—¶åŒºä¿¡æ¯ï¼‰
    æ–°ä»£ç ç»Ÿä¸€ä½¿ç”¨æ­¤å‡½æ•°
    """
    return datetime.now(timezone.utc)

def get_uk_time():
    """
    è·å–å½“å‰è‹±å›½æ—¶é—´ï¼ˆå·²å¼ƒç”¨ï¼‰
    
    âš ï¸ æ­¤å‡½æ•°å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ get_utc_time()
    ä¿ç•™æ­¤å‡½æ•°ä»…ç”¨äºå‘åå…¼å®¹ï¼Œå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­ç§»é™¤
    """
    warnings.warn(
        "get_uk_time() is deprecated. Use get_utc_time() instead.",
        DeprecationWarning,
        stacklevel=2
    )
    import pytz
    uk_tz = pytz.timezone("Europe/London")
    return datetime.now(uk_tz)  # âœ… ä»è¿”å›ä¼¦æ•¦æ—¶åŒºï¼Œä½†æ ‡è®°ä¸ºå¼ƒç”¨
```

**è¿ç§»ç­–ç•¥**: **å…ˆåº“åä»£ç **
1. å…ˆæŠŠæ•°æ®åº“å­—æ®µåˆ‡ä¸º `TIMESTAMPTZ` å¹¶å®Œæˆæ•°æ®è½¬æ¢
2. å†å…¨é‡æ›¿æ¢è°ƒç”¨ç‚¹åˆ° `get_utc_time()`
3. æœ€åç§»é™¤ `get_uk_time()` æˆ–æ ‡è®°ä¸ºå¼ƒç”¨

#### ğŸ“‹ æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆåªåšä¸€æ¬¡æ—¶åŒºè§£é‡Šï¼‰

**âš ï¸ å…³é”®**: åªåšä¸€æ¬¡ `AT TIME ZONE 'Europe/London'`ï¼Œä¸è¦åŒé‡è½¬æ¢

```sql
-- æ­¥éª¤1: æ·»åŠ æ–°åˆ—ï¼ˆå¸¦æ—¶åŒºï¼‰
ALTER TABLE customer_service_chats
  ADD COLUMN created_at_utc       TIMESTAMPTZ,
  ADD COLUMN last_message_at_utc  TIMESTAMPTZ,
  ADD COLUMN ended_at_utc         TIMESTAMPTZ;

-- æ­¥éª¤2: è½¬æ¢ç°æœ‰æ•°æ®ï¼ˆåªè§£é‡Šä¸€æ¬¡ï¼šå‡è®¾æ—§æ•°æ®æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œè½¬æ¢ä¸ºUTCï¼‰
UPDATE customer_service_chats
SET created_at_utc      = created_at      AT TIME ZONE 'Europe/London',
    last_message_at_utc = last_message_at AT TIME ZONE 'Europe/London',
    ended_at_utc        = ended_at         AT TIME ZONE 'Europe/London'
WHERE created_at IS NOT NULL;

-- æ­¥éª¤3: éªŒè¯æ•°æ®ï¼ˆæŠ½æ ·æ£€æŸ¥ï¼‰
SELECT 
    created_at,
    created_at_utc,
    created_at_utc AT TIME ZONE 'Europe/London' as london_time_check
FROM customer_service_chats
LIMIT 10;

-- æ­¥éª¤4: å¦‚æœéªŒè¯é€šè¿‡ï¼Œåˆ é™¤æ—§åˆ—ï¼Œé‡å‘½åæ–°åˆ—
ALTER TABLE customer_service_chats
  DROP COLUMN created_at,
  RENAME COLUMN created_at_utc      TO created_at,
  DROP COLUMN last_message_at,
  RENAME COLUMN last_message_at_utc TO last_message_at,
  DROP COLUMN ended_at,
  RENAME COLUMN ended_at_utc        TO ended_at;

-- æ­¥éª¤5: æ›´æ–°æ¨¡å‹å®šä¹‰
-- åœ¨ models.py ä¸­æ”¹ä¸ºï¼š
-- created_at = Column(DateTime(timezone=True), default=get_utc_time)
```

**æ³¨æ„**: 
- âœ… åªåšä¸€æ¬¡ `AT TIME ZONE 'Europe/London'`ï¼ˆè§£é‡Šæ—§æ•°æ®ä¸ºä¼¦æ•¦æ—¶åŒºï¼ŒPostgreSQLè‡ªåŠ¨è½¬æ¢ä¸ºUTCï¼‰
- âŒ ä¸è¦å†åš `AT TIME ZONE 'UTC'`ï¼ˆä¼šå¯¼è‡´åŒé‡è½¬æ¢é”™è¯¯ï¼‰

---

### 2. âš ï¸ Celeryä»»åŠ¡ç³»ç»Ÿå¼•å…¥ï¼ˆä¸­é£é™©ï¼‰

#### å½“å‰å®ç°çŠ¶æ€
```python
# backend/app/main.py
# å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆå¯é€‰ï¼šä½¿ç”¨APScheduleræˆ–Celeryï¼‰
# è¿™é‡Œä½¿ç”¨ç®€å•çš„åå°çº¿ç¨‹æ–¹å¼
def run_tasks_periodically():
    """æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡å®šæ—¶ä»»åŠ¡"""
    while True:
        try:
            run_scheduled_tasks()
        except Exception as e:
            logger.error(f"å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {e}", exc_info=True)
        time.sleep(300)  # 5åˆ†é’Ÿ
```

**å‘ç°çš„é—®é¢˜**:
- âœ… é¡¹ç›®ç›®å‰ä½¿ç”¨ç®€å•çš„åå°çº¿ç¨‹æ–¹å¼ï¼Œè€Œä¸æ˜¯Celery
- âœ… `requirements.txt` ä¸­æ²¡æœ‰ `celery` ä¾èµ–
- âœ… æ–‡æ¡£å»ºè®®ä½¿ç”¨Celery Beatæ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡

#### æ–‡æ¡£å»ºè®®
```python
# ä½¿ç”¨Celery Beatå®šæ—¶ä»»åŠ¡
celery_app = Celery('linku_tasks')
celery_app.conf.beat_schedule = {
    'auto-end-timeout-chats': {
        'task': 'auto_end_timeout_chats_task',
        'schedule': 30.0,  # æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    }
}
```

#### âš ï¸ å†²çªç‚¹ä¸é£é™©

1. **ä¾èµ–å¼•å…¥**
   - **å½“å‰**: æ— Celeryä¾èµ–
   - **å»ºè®®**: éœ€è¦å®‰è£… `celery`, `redis`ï¼ˆä½œä¸ºbrokerï¼‰
   - **å½±å“**: å¢åŠ ä¾èµ–ï¼Œéœ€è¦é…ç½®Redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—
   - **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­

2. **æ¶æ„å˜æ›´**
   - **å½“å‰**: å•è¿›ç¨‹åå°çº¿ç¨‹
   - **å»ºè®®**: éœ€è¦ç‹¬ç«‹çš„Celery workerè¿›ç¨‹
   - **å½±å“**: éƒ¨ç½²æ¶æ„å˜æ›´ï¼Œéœ€è¦é¢å¤–è¿›ç¨‹
   - **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­

3. **ç°æœ‰ä»»åŠ¡è¿ç§»**
   - **å½“å‰**: `scheduled_tasks.py` ä¸­çš„ä»»åŠ¡éœ€è¦è¿ç§»
   - **å»ºè®®**: æ”¹ä¸ºCeleryä»»åŠ¡
   - **å½±å“**: éœ€è¦é‡å†™ç°æœ‰å®šæ—¶ä»»åŠ¡
   - **é£é™©ç­‰çº§**: ğŸŸ¢ ä½

#### âœ… å¯è¡Œæ€§è¯„ä¼°

**æŠ€æœ¯å¯è¡Œæ€§**: âœ… å®Œå…¨å¯è¡Œ
- Celeryæ˜¯æˆç†Ÿçš„Pythonä»»åŠ¡é˜Ÿåˆ—æ¡†æ¶
- é¡¹ç›®å·²æœ‰Redisï¼ˆç”¨äºä¼šè¯ç®¡ç†ï¼‰ï¼Œå¯ä»¥ä½œä¸ºCelery broker
- æ–‡æ¡£æä¾›äº†å®Œæ•´çš„Celeryé…ç½®ç¤ºä¾‹

**å®æ–½é£é™©**: âš ï¸ ä¸­é£é™©
- éœ€è¦é¢å¤–çš„éƒ¨ç½²é…ç½®ï¼ˆCelery worker + beatï¼‰
- éœ€è¦ç¡®ä¿Rediså¯ç”¨æ€§
- ç°æœ‰å®šæ—¶ä»»åŠ¡éœ€è¦è¿ç§»

**æ¨èæ–¹æ¡ˆ**: 
- **é€‰é¡¹1**: å¼•å…¥Celeryï¼ˆæ¨èï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰
  - Redisä½œä¸ºbroker/beat
  - **å¿…é¡»**: ç¦ç”¨ä»»ä½•å…¬å¼€HTTPè§¦å‘ç«¯ç‚¹
  - ä»…é€šè¿‡Celery Beatå†…éƒ¨è°ƒåº¦
- **é€‰é¡¹2**: ç»§ç»­ä½¿ç”¨åå°çº¿ç¨‹ï¼ˆå¿«é€Ÿæ–¹æ¡ˆï¼Œä½†éœ€è¦å®‰å…¨è¾¹ç•Œï¼‰
  - **å¿…é¡»**: ä¸å¯¹å¤–æš´éœ²ä»»ä½•"æ‰‹åŠ¨è§¦å‘HTTPç«¯ç‚¹"
  - **å¿…é¡»**: åŠ å¹‚ç­‰ï¼ˆX-Task-IDï¼‰ã€é€Ÿç‡é™åˆ¶ã€IPç™½åå•/ç­¾å
  - **å¿…é¡»**: ç»Ÿä¸€ç”¨UTCè®¡ç®—è¶…æ—¶
  - **æ›´ç¨³å¦¥**: ä»æ¨èå¼•å…¥Celeryï¼ˆRediså·²è¢«å»ºè®®ä½œä¸ºbrokerï¼‰

---

### 3. âœ… æ–°å¢æ•°æ®åº“å­—æ®µï¼ˆä½é£é™©ï¼Œå¯ç›´æ¥å®æ–½ï¼‰

#### å½“å‰å®ç°çŠ¶æ€
```python
# backend/app/models.py
class CustomerServiceChat(Base):
    is_ended = Column(Integer, default=0)  # åªæœ‰æ˜¯å¦ç»“æŸ
    # ç¼ºå°‘: ended_reason, ended_by, ended_type

class CustomerServiceMessage(Base):
    is_read = Column(Integer, default=0)  # åªæœ‰å·²è¯»çŠ¶æ€
    # ç¼ºå°‘: status, sent_at, delivered_at, read_at
```

**å‘ç°çš„é—®é¢˜**:
- âœ… `CustomerServiceChat` ç¡®å®ç¼ºå°‘ `ended_reason`, `ended_by`, `ended_type` å­—æ®µ
- âœ… `CustomerServiceMessage` ç¡®å®ç¼ºå°‘ `status`, `sent_at`, `delivered_at`, `read_at` å­—æ®µ
- âœ… æ–‡æ¡£ä¸­æåˆ°çš„ `CustomerServiceQueue` æ¨¡å‹ä¸å­˜åœ¨

#### æ–‡æ¡£å»ºè®®
```python
class CustomerServiceChat(Base):
    ended_reason = Column(String(50), nullable=True)  # æ–°å¢
    ended_by = Column(String(20), nullable=True)  # æ–°å¢
    ended_type = Column(String(20), nullable=True)  # æ–°å¢

class CustomerServiceMessage(Base):
    status = Column(String(20), default="sending")  # æ–°å¢
    sent_at = Column(DateTime(timezone=True), nullable=True)  # æ–°å¢
    delivered_at = Column(DateTime(timezone=True), nullable=True)  # æ–°å¢
    read_at = Column(DateTime(timezone=True), nullable=True)  # æ–°å¢

class CustomerServiceQueue(Base):  # å…¨æ–°æ¨¡å‹
    __tablename__ = "customer_service_queue"
    # ... å­—æ®µå®šä¹‰
```

#### âœ… å¯è¡Œæ€§è¯„ä¼°

**æŠ€æœ¯å¯è¡Œæ€§**: âœ… å®Œå…¨å¯è¡Œ
- æ–°å¢å­—æ®µä¸å½±å“ç°æœ‰æ•°æ®
- å¯ä»¥ç«‹å³å®æ–½
- å‘åå…¼å®¹

**å®æ–½é£é™©**: ğŸŸ¢ ä½é£é™©
- åªéœ€æ·»åŠ è¿ç§»è„šæœ¬
- ç°æœ‰ä»£ç ä»å¯æ­£å¸¸å·¥ä½œ

**âš ï¸ å…³é”®è¡¥å……ï¼šéœ€è¦è¡¥å…¨å†™å…¥ç‚¹**

**æ‰€æœ‰ç»“æŸè·¯å¾„éƒ½è¦å†™ ended_* å­—æ®µ**:
- æ‰‹åŠ¨ç»“æŸ â†’ å†™ `ended_reason="manual"`, `ended_by="user_id"` æˆ– `"service_id"`
- è¶…æ—¶ç»“æŸ â†’ å†™ `ended_reason="timeout"`, `ended_by="system"`, `ended_type="user_inactive"` æˆ– `"service_inactive"`
- æ¸…ç†ä»»åŠ¡ â†’ å†™ `ended_reason="cleanup"`, `ended_by="system"`

**æ‰€æœ‰ACKè·¯å¾„éƒ½è¦å†™æ¶ˆæ¯çŠ¶æ€å­—æ®µ**:
- WebSocket ACK â†’ å†™ `sent_at`, `delivered_at`, `read_at`
- åŒæ­¥æ—§å¸ƒå°”å­—æ®µï¼ˆå¦‚ `is_ended`, `is_read`ï¼‰æˆ–æ”¹ä¸ºæ´¾ç”Ÿå­—æ®µ

**éœ€è¦å›å¡«è„šæœ¬**:
- å¯¹ç°æœ‰æ•°æ®å›å¡« `ended_reason`, `ended_by`, `ended_type`ï¼ˆå¦‚æœå¯æ¨æ–­ï¼‰
- å¯¹ç°æœ‰æ¶ˆæ¯å›å¡« `status`, `sent_at`, `delivered_at`, `read_at`ï¼ˆå¦‚æœå¯æ¨æ–­ï¼‰

**æ¨èæ–¹æ¡ˆ**: ç«‹å³å®æ–½ï¼Œä¼˜å…ˆçº§æœ€é«˜

---

### 4. âœ… è·¯ç”±é‡æ„ï¼ˆä½é£é™©ï¼Œå¯å‘åå…¼å®¹ï¼‰

#### å½“å‰å®ç°çŠ¶æ€
```python
# backend/app/routers.py
# æ³¨é‡Šæ˜¾ç¤ºï¼šæ—§çš„å®¢æœç™»å½•è·¯ç”±å·²åˆ é™¤ï¼Œè¯·ä½¿ç”¨ /api/cs/login
POST /api/cs/login  # æ—§è·¯ç”±
POST /api/customer-service/login  # æ–°è·¯ç”±ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰
```

**å‘ç°çš„é—®é¢˜**:
- âš ï¸ è·¯ç”±å‘½åä¸ç»Ÿä¸€ï¼ˆéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥å®é™…è·¯ç”±ï¼‰
- âš ï¸ æ–‡æ¡£å»ºè®®ç»Ÿä¸€ä¸º `/api/customer-service/...` å’Œ `/api/user/customer-service/...`

#### æ–‡æ¡£å»ºè®®
```python
# ç»Ÿä¸€è·¯ç”±
POST /api/customer-service/login  # å®¢æœç«¯
GET /api/user/customer-service/chats  # ç”¨æˆ·ç«¯
```

#### âœ… å¯è¡Œæ€§è¯„ä¼°

**æŠ€æœ¯å¯è¡Œæ€§**: âœ… å®Œå…¨å¯è¡Œ
- FastAPIæ”¯æŒè·¯ç”±é‡å®šå‘å’ŒåŒæ³¨å†Œ
- å¯ä»¥ä¿æŒå‘åå…¼å®¹

**å®æ–½é£é™©**: ğŸŸ¢ ä½é£é™©
- åªå½±å“APIè°ƒç”¨
- å¯ä»¥é€æ­¥è¿ç§»å‰ç«¯

**æ¨èæ–¹æ¡ˆ**: åˆ†é˜¶æ®µå®æ–½ï¼Œä¿ç•™æ—§è·¯ç”±2å‘¨è¿‡æ¸¡æœŸ

**è·¯ç”±é‡æ„æ‰§è¡Œæ³•**:
- **GETè¯·æ±‚**: ä½¿ç”¨ `308` æ°¸ä¹…é‡å®šå‘ï¼ˆä¿æŒHTTPæ–¹æ³•ï¼‰
  ```python
  @router.get("/api/customer-service/my-chats")  # æ—§è·¯ç”±
  async def get_user_chats_old(...):
      from fastapi.responses import RedirectResponse
      response = RedirectResponse(
          url="/api/user/customer-service/chats", 
          status_code=308  # âœ… 308ä¿æŒæ–¹æ³•
      )
      response.headers["Deprecation"] = "true"
      response.headers["Link"] = '</api/user/customer-service/chats>; rel="successor-version"'
      return response
  ```

- **POST/PUT/DELETEç­‰å†™æ“ä½œ**: åŒæ³¨å†ŒåŒä¸€handlerï¼Œä¸è¦301
  ```python
  @router.post("/api/user/customer-service/chats/{chat_id}/end")  # æ–°è·¯ç”±
  async def end_chat_new(...):
      # å®ç°

  @router.post("/api/customer-service/end-chat/{chat_id}")  # æ—§è·¯ç”±
  async def end_chat_old(...):
      # è°ƒç”¨æ–°è·¯ç”±çš„handler
      return await end_chat_new(...)
  ```

- **ä¸¤å‘¨å**: ç§»é™¤æ—§è·¯ç”±ï¼Œæ›´æ–°å‰ç«¯è°ƒç”¨

---

### 5. âœ… åŠŸèƒ½å¢å¼ºï¼ˆä½é£é™©ï¼‰

#### å½“å‰å®ç°çŠ¶æ€
- âœ… å®¢æœå¯¹è¯åŠŸèƒ½å·²å®ç°ï¼ˆ`routers.py` 3238-3750è¡Œï¼‰
- âœ… å®¢æœç®¡ç†åŠŸèƒ½å·²å®ç°ï¼ˆ`routers.py` 3784-3997è¡Œï¼‰
- âœ… ç”¨æˆ·ç«¯å®¢æœä¸­å¿ƒå·²å®ç°ï¼ˆ`Message.tsx`ï¼‰

#### æ–‡æ¡£å»ºè®®çš„åŠŸèƒ½å¢å¼º
1. **æ’é˜Ÿç³»ç»Ÿ** - æ–°åŠŸèƒ½ï¼Œæ— å†²çª
2. **å¿«æ·å›å¤** - æ–°åŠŸèƒ½ï¼Œæ— å†²çª
3. **æ–‡ä»¶ä¸Šä¼ ** - æ–°åŠŸèƒ½ï¼Œæ— å†²çª
4. **æ¶ˆæ¯çŠ¶æ€å®Œæ•´å®ç°** - éœ€è¦æ–°å¢å­—æ®µï¼ˆå·²è¯„ä¼°ï¼‰

#### âœ… å¯è¡Œæ€§è¯„ä¼°

**æŠ€æœ¯å¯è¡Œæ€§**: âœ… å®Œå…¨å¯è¡Œ
- éƒ½æ˜¯æ–°åŠŸèƒ½ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
- å¯ä»¥é€æ­¥å®æ–½

**å®æ–½é£é™©**: ğŸŸ¢ ä½é£é™©
- æ–°åŠŸèƒ½ï¼Œæ— ç ´åæ€§å˜æ›´

**æ¨èæ–¹æ¡ˆ**: æŒ‰ä¼˜å…ˆçº§é€æ­¥å®æ–½

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼Œä½é£é™©ï¼‰

1. âœ… **æ–°å¢å­—æ®µ**ï¼ˆended_reason, ended_by, ended_typeï¼‰
   - **é¢„è®¡å·¥æ—¶**: 1-2å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ— ç ´åæ€§å˜æ›´

2. âœ… **æ¶ˆæ¯çŠ¶æ€å­—æ®µ**ï¼ˆstatus, sent_at, delivered_at, read_atï¼‰
   - **é¢„è®¡å·¥æ—¶**: 1-2å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ— ç ´åæ€§å˜æ›´

3. âœ… **å®‰å…¨ä¼˜åŒ–**ï¼ˆCSRF, Cookieæ ‡å¿—, é€Ÿç‡é™åˆ¶ï¼‰
   - **é¢„è®¡å·¥æ—¶**: 2-3å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ— æ•°æ®å½±å“ï¼Œå¯ç«‹å³å›æ»š

4. âœ… **ç´¢å¼•ä¼˜åŒ–**ï¼ˆå¤åˆç´¢å¼•ï¼‰
   - **é¢„è®¡å·¥æ—¶**: 1å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ€§èƒ½æå‡ï¼Œæ— å‰¯ä½œç”¨

5. âœ… **åˆ›å»ºCustomerServiceQueueæ¨¡å‹**
   - **é¢„è®¡å·¥æ—¶**: 1å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ–°åŠŸèƒ½ï¼Œæ— å†²çª
   - **å…³é”®è¦æ±‚**: 
     - è¡Œçº§é”/ä¹è§‚é”é˜²æ­¢åŒåˆ†é…
     - å¤åˆç´¢å¼• `(status, queued_at)` ä¼˜åŒ–æŸ¥è¯¢
     - é¿å…N+1æŸ¥è¯¢é—®é¢˜

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆåˆ†é˜¶æ®µå®æ–½ï¼Œéœ€æµ‹è¯•ï¼‰

1. âš ï¸ **æ—¶é—´ç»Ÿä¸€**ï¼ˆåˆ†3é˜¶æ®µï¼šå…¼å®¹å±‚â†’è¿ç§»â†’åˆ‡æ¢ï¼‰
   - **é¢„è®¡å·¥æ—¶**: 2-3å‘¨
   - **é£é™©**: ğŸ”´ é«˜
   - **å½±å“**: éœ€è¦å……åˆ†æµ‹è¯•ï¼Œå‡†å¤‡å›æ»šæ–¹æ¡ˆ
   - **æ¨èæ–¹æ¡ˆ**: è§ç°æœ‰ `ä¼˜åŒ–æ–‡æ¡£å¯è¡Œæ€§åˆ†æ.md`

2. âš ï¸ **Celeryä»»åŠ¡ç³»ç»Ÿå¼•å…¥**
   - **é¢„è®¡å·¥æ—¶**: 3-5å¤©
   - **é£é™©**: ğŸŸ¡ ä¸­
   - **å½±å“**: éƒ¨ç½²æ¶æ„å˜æ›´
   - **æ¨èæ–¹æ¡ˆ**: 
     - å¦‚æœå·²æœ‰Redisï¼Œæ¨èå¼•å…¥Celery
     - å¦‚æœèµ„æºæœ‰é™ï¼Œå¯å…ˆæ”¹è¿›ç°æœ‰åå°çº¿ç¨‹ç³»ç»Ÿ

3. âš ï¸ **è·¯ç”±é‡æ„**ï¼ˆä¿ç•™æ—§è·¯ç”±ï¼Œæ·»åŠ æ–°è·¯ç”±ï¼‰
   - **é¢„è®¡å·¥æ—¶**: 3-4å¤©
   - **é£é™©**: ğŸŸ¡ ä¸­
   - **å½±å“**: APIå˜æ›´ï¼Œéœ€è¦å‰ç«¯é…åˆ

4. âš ï¸ **ç»“æŸå¯¹è¯å‡½æ•°å¢å¼º**ï¼ˆæ·»åŠ å¯é€‰å‚æ•°ï¼‰
   - **é¢„è®¡å·¥æ—¶**: 1-2å¤©
   - **é£é™©**: ğŸŸ¡ ä¸­
   - **å½±å“**: å‘åå…¼å®¹ï¼Œä½†éœ€è¦æ›´æ–°è°ƒç”¨æ–¹

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆåŠŸèƒ½å¢å¼ºï¼Œå¯å»¶åï¼‰

1. âœ… **æ’é˜Ÿç³»ç»Ÿ**ï¼ˆæ–°åŠŸèƒ½ï¼Œæ— å†²çªï¼‰
   - **é¢„è®¡å·¥æ—¶**: 5-7å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ–°åŠŸèƒ½ï¼Œä¸å½±å“ç°æœ‰ä»£ç 

2. âœ… **å¿«æ·å›å¤**ï¼ˆæ–°åŠŸèƒ½ï¼Œæ— å†²çªï¼‰
   - **é¢„è®¡å·¥æ—¶**: 3-5å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ–°åŠŸèƒ½

3. âœ… **æ–‡ä»¶ä¸Šä¼ **ï¼ˆæ–°åŠŸèƒ½ï¼Œæ— å†²çªï¼‰
   - **é¢„è®¡å·¥æ—¶**: 2-3å¤©
   - **é£é™©**: ğŸŸ¢ ä½
   - **å½±å“**: æ–°åŠŸèƒ½

---

## ğŸ“‹ åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### é˜¶æ®µ1: å®‰å…¨ä¸æ€§èƒ½ï¼ˆ1-2å‘¨ï¼‰

**ç›®æ ‡**: å®æ–½ä½é£é™©ã€é«˜ä»·å€¼çš„ä¼˜åŒ–

**ä»»åŠ¡æ¸…å•**:
- âœ… å®æ–½é€Ÿç‡é™åˆ¶
- âœ… æ·»åŠ CSRFä¿æŠ¤
- âœ… æ·»åŠ æ•°æ®åº“ç´¢å¼•
- âœ… æ–°å¢å­—æ®µï¼ˆended_reasonç­‰ï¼‰
- âœ… åˆ›å»ºCustomerServiceQueueæ¨¡å‹
  - è¡Œçº§é”/ä¹è§‚é”å®ç°
  - å¤åˆç´¢å¼• `(status, queued_at)`
  - é¿å…N+1æŸ¥è¯¢

**é£é™©**: ğŸŸ¢ ä½  
**å½±å“**: æ— æ•°æ®å½±å“ï¼Œå¯ç«‹å³å›æ»š  
**é¢„è®¡å·¥æ—¶**: 5-7å¤©

---

### é˜¶æ®µ2: æ—¶é—´ç»Ÿä¸€ï¼ˆ2-3å‘¨ï¼‰

**ç›®æ ‡**: ç»Ÿä¸€æ—¶é—´å¤„ç†ï¼Œæ¶ˆé™¤æ—¶åŒºé—®é¢˜

**ä»»åŠ¡æ¸…å•**:
- âš ï¸ **å…ˆåº“åä»£ç ç­–ç•¥**:
  1. æ•°æ®åº“è¿ç§»ï¼ˆTIMESTAMPâ†’TIMESTAMPTZï¼‰
  2. æ•°æ®è½¬æ¢ï¼ˆä¼¦æ•¦æ—¶åŒºâ†’UTCï¼Œåªåšä¸€æ¬¡æ—¶åŒºè§£é‡Šï¼‰
  3. å…¨é‡æ›¿æ¢è°ƒç”¨ç‚¹åˆ° `get_utc_time()`
  4. æ ‡è®° `get_uk_time()` ä¸ºå¼ƒç”¨ï¼ˆä¸è¦æš—æ”¹è¿”å›UTCï¼‰
- âš ï¸ æ¨¡å‹å­—æ®µæ”¹ä¸º `DateTime(timezone=True)`
- âš ï¸ åç«¯APIè¿”å›ISO-8601 + Zçš„UTCæ ¼å¼

**é£é™©**: ğŸ”´ é«˜  
**å½±å“**: éœ€è¦å……åˆ†æµ‹è¯•ï¼Œå‡†å¤‡å›æ»šæ–¹æ¡ˆ

**æµ‹è¯•é‡ç‚¹**:
- DSTåˆ‡æ¢æ—¥æœŸçš„æ•°æ®è½¬æ¢ï¼ˆæ˜¥å‰æ‹¨æ—¥ã€ç§‹å›æ‹¨æ—¥ï¼‰
- æ—¶é—´æ¯”è¾ƒæŸ¥è¯¢çš„æ­£ç¡®æ€§
- å‰ç«¯æ—¶é—´æ˜¾ç¤ºçš„å‡†ç¡®æ€§
- å›æ»šè„šæœ¬éªŒè¯

**å›æ»šè„šæœ¬**: å‡†å¤‡å®Œæ•´çš„å›æ»šSQLè„šæœ¬ï¼Œå¯åœ¨è¿ç§»å¤±è´¥æ—¶æ¢å¤

**é¢„è®¡å·¥æ—¶**: 10-15å¤©

---

### é˜¶æ®µ3: ä»»åŠ¡ç³»ç»Ÿå‡çº§ï¼ˆ1å‘¨ï¼‰

**ç›®æ ‡**: å¼•å…¥Celeryæˆ–æ”¹è¿›ç°æœ‰å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ

**ä»»åŠ¡æ¸…å•**:
- âš ï¸ è¯„ä¼°Celeryå¼•å…¥çš„å¿…è¦æ€§
- âš ï¸ å¦‚æœå¼•å…¥ï¼šé…ç½®Celery + Redis
- âš ï¸ è¿ç§»ç°æœ‰å®šæ—¶ä»»åŠ¡
- âš ï¸ æˆ–æ”¹è¿›ç°æœ‰åå°çº¿ç¨‹ç³»ç»Ÿ

**é£é™©**: ğŸŸ¡ ä¸­  
**å½±å“**: éƒ¨ç½²æ¶æ„å˜æ›´ï¼ˆå¦‚æœå¼•å…¥Celeryï¼‰

**é¢„è®¡å·¥æ—¶**: 3-5å¤©ï¼ˆCeleryï¼‰æˆ– 1-2å¤©ï¼ˆæ”¹è¿›ç°æœ‰ç³»ç»Ÿï¼‰

---

### é˜¶æ®µ4: åŠŸèƒ½å¢å¼ºï¼ˆ2-3å‘¨ï¼‰

**ç›®æ ‡**: å®æ–½æ–°åŠŸèƒ½å’Œè·¯ç”±é‡æ„

**ä»»åŠ¡æ¸…å•**:
- âœ… è·¯ç”±é‡æ„ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… ç»“æŸå¯¹è¯å‡½æ•°å¢å¼º
- âœ… æ¶ˆæ¯çŠ¶æ€å®Œæ•´å®ç°
- âœ… æ’é˜Ÿç³»ç»Ÿå®ç°
- âœ… å¿«æ·å›å¤åŠŸèƒ½

**é£é™©**: ğŸŸ¡ ä¸­  
**å½±å“**: APIå˜æ›´ï¼Œéœ€è¦å‰ç«¯é…åˆ

**é¢„è®¡å·¥æ—¶**: 10-15å¤©

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. æ—¶é—´ç»Ÿä¸€çš„é£é™©ç¼“è§£

**ğŸš¨ å…³é”®çº æ­£ï¼šä¸è¦æš—æ”¹å‡½æ•°è¯­ä¹‰**

**âŒ é”™è¯¯åšæ³•**:
```python
def get_uk_time():
    """ä¸ºäº†ç»Ÿä¸€æ—¶é—´åŸºå‡†ï¼Œæ­¤å‡½æ•°ç°åœ¨è¿”å›UTCæ—¶é—´"""
    return get_utc_time()  # âŒ é”™è¯¯ï¼šåˆ¶é€ è¯­ä¹‰é”™ä½
```

**âœ… æ­£ç¡®åšæ³•**:
```python
# backend/app/utils/time_utils.py
from datetime import datetime, timezone
from zoneinfo import ZoneInfo
import warnings

def get_utc_time() -> datetime:
    """
    è·å–å½“å‰UTCæ—¶é—´ï¼ˆå¸¦æ—¶åŒºä¿¡æ¯ï¼‰
    æ–°ä»£ç ç»Ÿä¸€ä½¿ç”¨æ­¤å‡½æ•°
    """
    return datetime.now(timezone.utc)

def get_uk_time():
    """
    è·å–å½“å‰è‹±å›½æ—¶é—´ï¼ˆå·²å¼ƒç”¨ï¼‰
    
    âš ï¸ æ­¤å‡½æ•°å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ get_utc_time()
    ä¿ç•™æ­¤å‡½æ•°ä»…ç”¨äºå‘åå…¼å®¹ï¼Œå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­ç§»é™¤
    """
    warnings.warn(
        "get_uk_time() is deprecated. Use get_utc_time() instead.",
        DeprecationWarning,
        stacklevel=2
    )
    import pytz
    uk_tz = pytz.timezone("Europe/London")
    return datetime.now(uk_tz)  # âœ… ä»è¿”å›ä¼¦æ•¦æ—¶åŒºï¼Œä½†æ ‡è®°ä¸ºå¼ƒç”¨
```

**è¿ç§»ç­–ç•¥**: **å…ˆåº“åä»£ç **
1. å…ˆæŠŠæ•°æ®åº“å­—æ®µåˆ‡ä¸º `TIMESTAMPTZ` å¹¶å®Œæˆæ•°æ®è½¬æ¢
2. å†å…¨é‡æ›¿æ¢è°ƒç”¨ç‚¹åˆ° `get_utc_time()`
3. æœ€åç§»é™¤ `get_uk_time()` æˆ–æ ‡è®°ä¸ºå¼ƒç”¨

### 2. Celeryå¼•å…¥è¯„ä¼°

**å†³ç­–å› ç´ **:
- âœ… å¦‚æœå·²æœ‰Redisï¼šæ¨èå¼•å…¥Celeryï¼ˆç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µï¼‰
- âš ï¸ å¦‚æœæ— Redisï¼šå¯å…ˆæ”¹è¿›ç°æœ‰åå°çº¿ç¨‹ç³»ç»Ÿ
- âš ï¸ å¦‚æœèµ„æºæœ‰é™ï¼šå¯å»¶åå¼•å…¥

**ç°æœ‰å®šæ—¶ä»»åŠ¡**:
- `scheduled_tasks.py`: æ£€æŸ¥è¿‡æœŸä¼˜æƒ åˆ¸ã€é‚€è¯·ç ã€ç§¯åˆ†
- `cleanup_tasks.py`: æ¸…ç†è¿‡æœŸä¼šè¯ã€ç¼“å­˜
- `main.py`: åå°ä»»åŠ¡å¾ªç¯

### 3. æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆåªåšä¸€æ¬¡æ—¶åŒºè§£é‡Šï¼‰

**âš ï¸ å…³é”®**: åªåšä¸€æ¬¡ `AT TIME ZONE 'Europe/London'`ï¼Œä¸è¦åŒé‡è½¬æ¢

```sql
-- æ­¥éª¤1: å¤‡ä»½æ•°æ®ï¼ˆå¿…é¡»ï¼‰
CREATE TABLE customer_service_chats_backup AS 
SELECT * FROM customer_service_chats;

-- æ­¥éª¤2: æ·»åŠ æ–°åˆ—ï¼ˆå¸¦æ—¶åŒºï¼‰
ALTER TABLE customer_service_chats
  ADD COLUMN created_at_utc       TIMESTAMPTZ,
  ADD COLUMN last_message_at_utc  TIMESTAMPTZ,
  ADD COLUMN ended_at_utc         TIMESTAMPTZ;

-- æ­¥éª¤3: è½¬æ¢ç°æœ‰æ•°æ®ï¼ˆåªè§£é‡Šä¸€æ¬¡ï¼šå‡è®¾æ—§æ•°æ®æ˜¯ä¼¦æ•¦æ—¶åŒºï¼Œè½¬æ¢ä¸ºUTCï¼‰
UPDATE customer_service_chats
SET created_at_utc      = created_at      AT TIME ZONE 'Europe/London',
    last_message_at_utc = last_message_at AT TIME ZONE 'Europe/London',
    ended_at_utc        = ended_at         AT TIME ZONE 'Europe/London'
WHERE created_at IS NOT NULL;

-- æ­¥éª¤4: éªŒè¯æ•°æ®ï¼ˆæŠ½æ ·æ£€æŸ¥ï¼Œç‰¹åˆ«æ˜¯DSTåˆ‡æ¢æ—¥æœŸï¼‰
SELECT 
    created_at,
    created_at_utc,
    created_at_utc AT TIME ZONE 'Europe/London' as london_time_check
FROM customer_service_chats
WHERE created_at IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;

-- æ­¥éª¤5: å¦‚æœéªŒè¯é€šè¿‡ï¼Œåˆ é™¤æ—§åˆ—ï¼Œé‡å‘½åæ–°åˆ—
ALTER TABLE customer_service_chats
  DROP COLUMN created_at,
  RENAME COLUMN created_at_utc      TO created_at,
  DROP COLUMN last_message_at,
  RENAME COLUMN last_message_at_utc TO last_message_at,
  DROP COLUMN ended_at,
  RENAME COLUMN ended_at_utc        TO ended_at;
```

**æ³¨æ„**: 
- âœ… åªåšä¸€æ¬¡ `AT TIME ZONE 'Europe/London'`ï¼ˆè§£é‡Šæ—§æ•°æ®ä¸ºä¼¦æ•¦æ—¶åŒºï¼ŒPostgreSQLè‡ªåŠ¨è½¬æ¢ä¸ºUTCï¼‰
- âŒ ä¸è¦å†åš `AT TIME ZONE 'UTC'`ï¼ˆä¼šå¯¼è‡´åŒé‡è½¬æ¢é”™è¯¯ï¼‰

### 4. å‰ç«¯å…¼å®¹æ€§

**åç«¯æ‰¿è¯º**: æ‰€æœ‰æ—¶é—´APIè¿”å›ISO-8601 + Zçš„UTCæ ¼å¼
```python
# åç«¯è¿”å›æ ¼å¼
return {
    "created_at": created_at.isoformat(),  # ä¾‹å¦‚: "2024-12-28T10:30:00+00:00" æˆ– "2024-12-28T10:30:00Z"
    # ...
}
```

**å‰ç«¯æ—¶é—´å¤„ç†**:
```typescript
// å‰ç«¯éœ€è¦ç»Ÿä¸€å¤„ç†UTCæ—¶é—´
import { formatInTimeZone } from 'date-fns-tz';

export function formatTimeForDisplay(
  utcTimeString: string,  // åç«¯è¿”å›çš„ISO-8601 UTCæ ¼å¼ï¼ˆå¸¦Zï¼‰
  userTimezone: string = 'Europe/London'
): string {
  // åç«¯è¿”å›çš„æ˜¯UTCï¼Œå‰ç«¯è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºæ˜¾ç¤º
  return formatInTimeZone(utcTimeString, userTimezone, 'yyyy-MM-dd HH:mm:ss zzz');
}
```

**é¿å…æ­§ä¹‰**: åç«¯ç»Ÿä¸€è¿”å›UTCï¼ˆISO-8601 + Zï¼‰ï¼Œå‰ç«¯ç»Ÿä¸€è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºæ˜¾ç¤º

---

## ğŸ“Š å·¥ä½œé‡ä¼°ç®—

### æ€»è®¡é¢„è®¡å·¥æ—¶

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | é£é™©ç­‰çº§ |
|------|------|----------|----------|
| é˜¶æ®µ1 | å®‰å…¨ä¸æ€§èƒ½ | 5-7å¤© | ğŸŸ¢ ä½ |
| é˜¶æ®µ2 | æ—¶é—´ç»Ÿä¸€ | 10-15å¤© | ğŸ”´ é«˜ |
| é˜¶æ®µ3 | ä»»åŠ¡ç³»ç»Ÿå‡çº§ | 3-5å¤© | ğŸŸ¡ ä¸­ |
| é˜¶æ®µ4 | åŠŸèƒ½å¢å¼º | 10-15å¤© | ğŸŸ¡ ä¸­ |
| **æ€»è®¡** | | **28-42å¤©** | |

**æŒ‰å•äººè®¡ç®—ï¼Œå¯å¹¶è¡Œå¼€å‘ç¼©çŸ­æ—¶é—´**

---

## âœ… æ€»ç»“

### å¯è¡Œæ€§ç»“è®º

1. **âœ… é«˜åº¦å¯è¡Œ**: å¤§éƒ¨åˆ†ä¼˜åŒ–æ–¹æ¡ˆæŠ€æœ¯å¯è¡Œï¼Œæ— æ ¹æœ¬æ€§å†²çª
2. **âš ï¸ éœ€è¦åˆ†é˜¶æ®µ**: æ—¶é—´ç»Ÿä¸€éœ€è¦è°¨æ…ï¼Œå»ºè®®åˆ†3é˜¶æ®µå®æ–½
3. **âœ… å‘åå…¼å®¹**: æ‰€æœ‰å˜æ›´éƒ½å¯ä»¥ä¿æŒå‘åå…¼å®¹
4. **âœ… å¯å›æ»š**: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å›æ»šæ–¹æ¡ˆ

### æ¨èå®æ–½é¡ºåº

1. **ç¬¬1-2å‘¨**: å®‰å…¨ä¼˜åŒ–ã€æ–°å¢å­—æ®µã€ç´¢å¼•ä¼˜åŒ–ï¼ˆä½é£é™©ï¼‰
2. **ç¬¬3-5å‘¨**: æ—¶é—´ç»Ÿä¸€ï¼ˆé«˜é£é™©ï¼Œéœ€å……åˆ†æµ‹è¯•ï¼‰
3. **ç¬¬6å‘¨**: ä»»åŠ¡ç³»ç»Ÿå‡çº§ï¼ˆä¸­é£é™©ï¼‰
4. **ç¬¬7-9å‘¨**: è·¯ç”±é‡æ„ã€åŠŸèƒ½å¢å¼ºï¼ˆä¸­é£é™©ï¼‰

### å…³é”®æˆåŠŸå› ç´ 

- âœ… å……åˆ†æµ‹è¯•æ—¶é—´è½¬æ¢é€»è¾‘ï¼ˆç‰¹åˆ«æ˜¯DSTåˆ‡æ¢ï¼‰
- âœ… ä¿ç•™æ—§è·¯ç”±å’Œå‡½æ•°ï¼Œç¡®ä¿å‘åå…¼å®¹
- âœ… å‡†å¤‡æ•°æ®è¿ç§»å›æ»šæ–¹æ¡ˆ
- âœ… å‰ç«¯ç»Ÿä¸€ä½¿ç”¨UTCï¼Œæ˜¾ç¤ºæ—¶è½¬æ¢
- âœ… åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µå……åˆ†æµ‹è¯•

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `ä¼˜åŒ–æ–‡æ¡£å¯è¡Œæ€§åˆ†æ.md` - å·²æœ‰çš„å¯è¡Œæ€§åˆ†æï¼ˆéƒ¨åˆ†å†…å®¹é‡å ï¼‰
- `å®¢æœåŠŸèƒ½ä¼˜åŒ–æ—¥å¿—.md` - å®Œæ•´çš„ä¼˜åŒ–æ–‡æ¡£
- `backend/app/models.py` - æ•°æ®åº“æ¨¡å‹å®šä¹‰
- `backend/app/routers.py` - APIè·¯ç”±å®šä¹‰

---

---

## ğŸ“‹ ä¸€é¡µå¼è½åœ°å¯¹ç…§è¡¨

| è¯„ä¼°é¡¹ | è¯„ä¼°ç»“è®º | ä¿®æ­£/è¡¥å…… |
|--------|----------|-----------|
| **æ—¶é—´ç»Ÿä¸€** | é«˜é£é™©ã€å¯è¡Œ | âœ… ç§»é™¤"get_uk_time()è¿”å›UTC"çš„å…¼å®¹å±‚<br>âœ… æŒ‰SQLæ¨¡æ¿è¿ç§»ï¼ˆåªåšä¸€æ¬¡æ—¶åŒºè§£é‡Šï¼‰<br>âœ… å…¨é‡æ›¿æ¢è°ƒç”¨ç‚¹åˆ°get_utc_time()<br>âœ… æ¨¡å‹DateTime(timezone=True)<br>âœ… å…ˆåº“åä»£ç ç­–ç•¥ |
| **Celery** | ä¸­é£é™©ã€å¯è¡Œ | âœ… é€‰Celeryï¼šRedisä½œä¸ºbroker/beat<br>âœ… ç¦ç”¨ä»»ä½•å…¬å¼€HTTPè§¦å‘<br>âœ… è‹¥ä¸´æ—¶çº¿ç¨‹å¾ªç¯ï¼Œä¹Ÿè¦ç™½åå•+ç­¾å+å¹‚ç­‰+é™é¢‘ |
| **æ–°å¢å­—æ®µ** | ä½é£é™©ã€å¯è¡Œ | âœ… æŠŠå†™å…¥ç‚¹è¡¥å…¨åˆ°æ‰€æœ‰ç»“æŸ/ACKè·¯å¾„<br>âœ… éœ€è¦å›å¡«è„šæœ¬ä¸å›å½’ç”¨ä¾‹<br>âœ… æ‰‹åŠ¨ç»“æŸ/è¶…æ—¶ç»“æŸ/æ¸…ç†ä»»åŠ¡â†’å†™ended_*<br>âœ… WS ACKâ†’å†™sent_at/delivered_at/read_at |
| **è·¯ç”±é‡æ„** | ä½é£é™©ã€å¯è¡Œ | âœ… GET=308ï¼ˆä¿æŒHTTPæ–¹æ³•ï¼‰<br>âœ… POST/PUT/DELETEåŒæ³¨å†Œä¸¤å‘¨+Deprecation/Linkå¤´<br>âœ… ä¸¤å‘¨åç§»é™¤æ—§è·¯ç”± |
| **é˜¶æ®µè®¡åˆ’** | åˆ†é˜¶æ®µå®æ–½ | âœ… é˜¶æ®µ2åˆ "æš—æ”¹å‡½æ•°è¯­ä¹‰"<br>âœ… åŠ å…¥å›æ»šè„šæœ¬ä¸DSTæŠ½æ ·æ ¡éªŒï¼ˆåˆ‡æ¢æ—¥å‰/å½“æ—¥/åï¼‰<br>âœ… å…ˆåº“åä»£ç ç­–ç•¥ |
| **é˜Ÿåˆ—æ¨¡å‹** | ä½é£é™©ã€å¯è¡Œ | âœ… åˆ›å»ºCustomerServiceQueueæ¨¡å‹<br>âœ… è¡Œçº§é”/ä¹è§‚é”ä¸å¤åˆç´¢å¼•(status, queued_at)<br>âœ… é¿å…åŒåˆ†é…/N+1 |
| **å‰ç«¯ç»Ÿä¸€** | ä½é£é™©ã€å¯è¡Œ | âœ… åç«¯è¿”å›ISO-8601 + Zçš„UTC<br>âœ… å‰ç«¯ç”¨formatInTimeZoneè½¬æ¢æ˜¾ç¤º |

---

## ğŸ” æœ€åæŠŠå…³æ¸…å•ï¼ˆCI/grepï¼Œä¸€è·‘å°±çŸ¥é“ï¼‰

### ç¦æ­¢é¡¹æ£€æŸ¥

1. **ç¦æ­¢ `datetime.utcnow()`**
   ```bash
   grep -r "datetime.utcnow()" backend/
   # åº”è¿”å›ç©ºï¼Œæˆ–ä»…åœ¨è¿ç§»è„šæœ¬ç›®å½•ä¸­ï¼ˆéœ€æ ‡æ³¨ä¸ºä¸´æ—¶ä½¿ç”¨ï¼‰
   ```

2. **ç¦æ­¢æ­£æ–‡ä½¿ç”¨ `pytz`**
   ```bash
   grep -r "import pytz\|from pytz" backend/ --exclude-dir=migrations
   # åº”è¿”å›ç©ºï¼Œæˆ–ä»…åœ¨è¿ç§»è„šæœ¬ä¸­ï¼ˆéœ€æ ‡æ³¨ä¸ºä¸´æ—¶ä½¿ç”¨ï¼‰
   ```

3. **ç¦æ­¢æ— æ—¶åŒº `DateTime`**
   ```bash
   grep -r "Column(DateTime[^(])" backend/app/models.py
   # æ‰€æœ‰æ—¶é—´åˆ—å¿…é¡»ä¸º DateTime(timezone=True)
   ```

4. **ç¦æ­¢å…¬å¼€çš„å®šæ—¶ä»»åŠ¡HTTPè§¦å‘**
   ```bash
   grep -r "@router.post.*auto.*end\|@router.post.*timeout\|@router.post.*queue" backend/
   # å®šæ—¶ä»»åŠ¡ä¸åº”æš´éœ²ä¸ºHTTPç«¯ç‚¹
   ```

5. **ç¦æ­¢301é‡å®šå‘**
   ```bash
   grep -r "status_code=301" backend/
   # GETè¯·æ±‚åªå…è®¸308ï¼Œå†™æ“ä½œåªå…è®¸åŒæ³¨å†Œ
   ```

6. **ç¦æ­¢å†…è”ç­‰å¾…æ—¶é—´ä¼°ç®—**
   ```bash
   grep -r "wait.*time.*position\|queue.*position.*wait" backend/
   # æ‰€æœ‰ç­‰å¾…æ—¶é—´ä¼°ç®—å¿…é¡»è°ƒç”¨ç»Ÿä¸€å‡½æ•°
   ```

### è¦æ±‚é¡¹æ£€æŸ¥

1. **æ‰€æœ‰æ—¶é—´åˆ—å¿…é¡» `timezone=True`**
   ```bash
   grep -r "DateTime(timezone=True)" backend/app/models.py
   # åº”è¦†ç›–æ‰€æœ‰æ—¶é—´å­—æ®µ
   ```

2. **æ‰€æœ‰æ—¶é—´å‡½æ•°ç»Ÿä¸€ä½¿ç”¨ `get_utc_time()`**
   ```bash
   grep -r "get_utc_time()" backend/ | wc -l
   # åº”è¦†ç›–æ‰€æœ‰æ—¶é—´ç”Ÿæˆè°ƒç”¨
   ```

3. **æ‰€æœ‰APIè¿”å›ISO-8601 UTCæ ¼å¼**
   ```bash
   grep -r "\.isoformat()" backend/app/routers.py
   # åº”ç»Ÿä¸€è¿”å›UTCæ—¶é—´
   ```

---

## ğŸ‡¬ğŸ‡§ è‹±å›½DSTåœºæ™¯é˜²å‘è¦ç‚¹

### æ ¸å¿ƒåŸåˆ™ï¼ˆè®°ç‰¢è¿™ä¸‰æ¡ï¼‰

1. **å­˜å‚¨ä¸è®¡ç®—ä¸€å¾‹UTC**ï¼›å­—æ®µå¿…é¡»å¸¦æ—¶åŒºï¼ˆTIMESTAMPTZ / timezone-awareï¼‰
2. **å±•ç¤ºä¸è¥ä¸šè§„åˆ™è‹¥éœ€è¦"å½“åœ°æ—¶é—´"**ï¼Œåªåœ¨å…¥/å‡ºè¾¹ç•Œä½¿ç”¨Europe/Londonï¼ˆzoneinfoï¼‰ï¼Œä¸è¦åœ¨ä¸­é—´è¿‡ç¨‹æ··å…¥æœ¬åœ°æ—¶é—´
3. **è°ƒåº¦ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ç”¨UTCè§¦å‘**ï¼›å¦‚éœ€"æ¯å¤©8:00è‹±å›½æ—¶é—´"ï¼Œç”¨"croné€»è¾‘+Europe/London"è€Œä¸æ˜¯æŠŠUTCå½“æœ¬åœ°

### è‹±å›½DSTä¼šæ€ä¹ˆå‘ä½ 

1. **é‡å¤å°æ—¶ï¼ˆç§‹å›æ‹¨ï¼‰**: å¦‚2025-10-26çš„01:30åœ¨è‹±å›½å‡ºç°ä¸¤æ¬¡ï¼›"æŒ‰æœ¬åœ°æ—¶é—´æ’åº/å·®å€¼"å¯èƒ½é‡å¤æˆ–ä¸ºè´Ÿ
2. **ç¼ºå¤±å°æ—¶ï¼ˆæ˜¥å‰æ‹¨ï¼‰**: å¦‚2025-03-30çš„01:00â€“01:59ä¸å­˜åœ¨ï¼›è§£æ"1:30"ä¼šæŠ›é”™æˆ–è¢«åº“çº æ­£åˆ°02:30
3. **é˜Ÿåˆ—/è¶…æ—¶è¯¯åˆ¤**: æ··ç”¨now()ï¼ˆæœ¬åœ°ï¼‰ä¸utcnow()å¯¼è‡´ç­‰å¾…åˆ†é’Ÿæ•°çªç„¶è·³å˜Â±60
4. **è®¡åˆ’ä»»åŠ¡æ¼‚ç§»**: ç”¨ç³»ç»Ÿæœ¬åœ°æ—¶åŒºè·‘cronï¼Œåˆ‡æ¢æ—¥ä»»åŠ¡ä¼šåŒè·‘/æ¼è·‘

### æ­£ç¡®åšæ³•ï¼ˆè½åœ°èŒƒå¼ï¼‰

#### 1) åç«¯æ—¶é—´

```python
from datetime import datetime, timezone
from zoneinfo import ZoneInfo

def utc_now():
    """è·å–å½“å‰UTCæ—¶é—´ï¼ˆå¸¦æ—¶åŒºï¼‰"""
    return datetime.now(timezone.utc)

def to_london(dt_utc):
    """å°†UTCæ—¶é—´è½¬æ¢ä¸ºä¼¦æ•¦æ—¶åŒºï¼ˆä»…ç”¨äºæ˜¾ç¤º/è§£æï¼‰"""
    return dt_utc.astimezone(ZoneInfo("Europe/London"))
```

- æ¯”è¾ƒ/è¶…æ—¶/æ’åºä¸€å¾‹ç”¨UTC
- åªæœ‰åœ¨è¿”å›ç»™å‰ç«¯æˆ–è§£æç”¨æˆ·è¾“å…¥æ—¶æ‰è½¬Europe/London

#### 2) æ˜¾ç¤ºä¸è¥ä¸šæ—¶é—´

- "å®¢æœè¥ä¸šæ—¶é—´08:00â€“18:00ï¼ˆè‹±å›½ï¼‰"ï¼šå­˜é…ç½®=æœ¬åœ°è§„åˆ™+æ—¶åŒºæ ‡è¯†ï¼ˆEurope/Londonï¼‰
- è®¡ç®—æ—¶æŠŠ"å½“å¤©è‹±å›½08:00"è½¬æ¢åˆ°UTCï¼Œå†æ¯”è¾ƒ
- å‰ç«¯ç»Ÿä¸€å±•ç¤ºï¼šåç«¯è¿”å›ISO-8601 UTCï¼ˆå¸¦Zï¼‰ï¼Œå‰ç«¯ç”¨Intl.DateTimeFormatæˆ–date-fns-tzåœ¨å®¢æˆ·ç«¯æŒ‰Europe/Londonæ¸²æŸ“

#### 3) è®¡åˆ’ä»»åŠ¡/å®šæ—¶å™¨

- è°ƒåº¦ç”¨UTCï¼›å¦‚æœä¸šåŠ¡è¦æ±‚"æ¯å¤©è‹±å›½18:00è‡ªåŠ¨ç»“æŸè¶…æ—¶ä¼šè¯"ï¼Œè®©è°ƒåº¦å™¨ä»¥Europe/Londonè®¡ç®—ä¸‹ä¸€æ¬¡è§¦å‘ç‚¹ï¼Œå†è½¬æ¢åˆ°UTCå­˜å‚¨/æ³¨å†Œ
- Celery beatï¼šè®¾ç½®`timezone="Europe/London"`å¯ä»¥æŒ‰è‹±å›½æœ¬åœ°æ—¶é—´è§¦å‘ï¼›ä½†ä»»åŠ¡å†…éƒ¨ä¾ç„¶ç”¨UTCè®¡ç®—ä¸šåŠ¡

#### 4) å…¥å‚è§£æï¼ˆéå¸¸å…³é”®ï¼‰

- ç”¨æˆ·è¾“å…¥"2025-03-30 01:30 è‹±å›½æ—¶é—´"ï¼šè¿™ä¸ªæ—¶é—´ä¸å­˜åœ¨ï¼ˆæ˜¥å‰æ‹¨ï¼‰ï¼›åº”è¿”å›400æˆ–æç¤ºç”¨æˆ·æ”¹åˆ°02:30
- ç”¨æˆ·è¾“å…¥"2025-10-26 01:30 è‹±å›½æ—¶é—´"ï¼šäºŒä¹‰æ€§ï¼ˆæœ‰ä¸¤æ¬¡01:30ï¼‰ï¼›å¦‚æœå¿…é¡»æ”¯æŒï¼Œè¦æ±‚æºå¸¦foldæˆ–æç¤º"é€‰æ‹©å¤ä»¤/å†¬ä»¤åé‚£æ¬¡"ã€‚é€šå¸¸ä¸šåŠ¡ä¸Šé¿å…00:30â€“02:30è¿™ä¸ªçª—å£

#### 5) é˜Ÿåˆ—ä¸è¶…æ—¶

```python
# ç­‰å¾…/è¶…æ—¶è®¡ç®—
wait_min = int((utc_now() - queued_at_utc).total_seconds() / 60)
```

- ç¡®ä¿`queued_at_utc`æœ¬èº«æ˜¯UTCï¼›ä¸è¦æŠŠä¼¦æ•¦æœ¬åœ°æ—¶é—´ç›´æ¥ç›¸å‡
- SLAç»Ÿè®¡/æŠ¥è¡¨ï¼šå…¨ç¨‹UTCç»Ÿè®¡ï¼›éœ€è¦"æŒ‰è‹±å›½è‡ªç„¶æ—¥"æŠ¥è¡¨æ—¶ï¼ŒæŠŠèšåˆçª—å£ä»¥Europe/Londonåˆ‡ç‰‡å³å¯

#### 6) å¿«é€Ÿè‡ªæ£€ï¼ˆä¸ŠCIï¼‰

- **ç¦æ­¢**: `datetime.utcnow`ã€æ— æ—¶åŒº`DateTime`ã€æ­£æ–‡`pytz`
- **è¦æ±‚**: æ‰€æœ‰æ—¶é—´åˆ—`timezone=True`/`TIMESTAMPTZ`ï¼›æ‰€æœ‰å¯¹å¤–APIè¿”å›Zç»“å°¾çš„ISO-8601
- **å•æµ‹è¦†ç›–**: ä¸¤ä¸ªå…³é”®æ—¥ï¼ˆæ˜¥å‰æ‹¨æ—¥ä¸ç§‹å›æ‹¨æ—¥ï¼‰

```python
def test_bst_spring_forward_gap():
    """æµ‹è¯•æ˜¥å‰æ‹¨ï¼š2025-03-30 01:30 æœ¬åœ°æ—¶é—´ä¸å­˜åœ¨"""
    from zoneinfo import ZoneInfo
    z = ZoneInfo("Europe/London")
    # 2025-03-30 01:30 æœ¬åœ°æ—¶é—´ä¸å­˜åœ¨
    with pytest.raises(Exception):
        datetime(2025, 3, 30, 1, 30, tzinfo=z).timestamp()

def test_gmt_fall_back_fold():
    """æµ‹è¯•ç§‹å›æ‹¨ï¼šä¸¤ä¸ª01:30ï¼Œåº”èƒ½åŒºåˆ†fold=0/1"""
    from zoneinfo import ZoneInfo
    z = ZoneInfo("Europe/London")
    # ä¸¤ä¸ª01:30ï¼Œåº”èƒ½åŒºåˆ†fold=0/1
    pass  # å®ç°æµ‹è¯•é€»è¾‘
```

### ä¸€å¥è¯æ€»ç»“

**è‹±å›½åœºæ™¯ä¸‹DSTæœ¬èº«ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯æŠŠ"æœ¬åœ°æ—¶é—´"æ··è¿›å­˜å‚¨/è®¡ç®—ã€‚**

ç”¨UTCå­˜&ç®— + Europe/Londonå±•ç¤º/è§£æï¼Œå†åŠ ä¸Šè°ƒåº¦ä¸å…¥å‚çš„DSTè§„åˆ™ï¼Œå¹³å°åœ¨è‹±å›½å…¨å¹´éƒ½èƒ½ç¨³å®šè¿è¡Œã€‚

---

**æœ€åæ›´æ–°**: 2024-12-28  
**è¯„ä¼°äºº**: AI Assistant  
**çŠ¶æ€**: âœ… å¯å®æ–½ï¼Œå»ºè®®åˆ†é˜¶æ®µè¿›è¡Œï¼ˆå·²çº æ­£å…³é”®é”™è¯¯ï¼‰

