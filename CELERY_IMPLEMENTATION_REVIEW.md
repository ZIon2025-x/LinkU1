# Celery å®ç°æ·±åº¦æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ—¥æœŸ
2025-01-XX

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. äº‹åŠ¡ç®¡ç†ä¸ä¸€è‡´é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- `check_expired_coupons`, `check_expired_invitation_codes`, `check_expired_points` å‡½æ•°å†…éƒ¨æœ‰ `db.commit()`ï¼Œä½†ç¼ºå°‘é”™è¯¯å¤„ç†å’Œ `rollback`
- Celery åŒ…è£…å±‚æ·»åŠ äº† `rollback`ï¼Œä½†å¦‚æœå‡½æ•°å†…éƒ¨å·²ç» `commit`ï¼Œå¤–å±‚çš„ `rollback` å¯èƒ½ä¼šå¤±è´¥

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åœ¨ `scheduled_tasks.py` ä¸­ä¸ºè¿™äº›å‡½æ•°æ·»åŠ äº†å®Œæ•´çš„ try-except å’Œ rollback é€»è¾‘
- åœ¨ Celery åŒ…è£…å±‚æ·»åŠ äº†æ³¨é‡Šè¯´æ˜ï¼Œå¹¶ç¡®ä¿ rollback å¤±è´¥æ—¶ä¸ä¼šå½±å“ä»»åŠ¡æ‰§è¡Œ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `backend/app/scheduled_tasks.py`
- `backend/app/celery_tasks.py`

### 2. ä»»åŠ¡é‡å¤å®šä¹‰é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- `cleanup_long_inactive_chats_task` åœ¨ä¸¤ä¸ªæ–‡ä»¶ä¸­éƒ½å®šä¹‰äº†
- `customer_service_tasks.py` å’Œ `celery_tasks.py` ä¸­éƒ½æœ‰å®šä¹‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åˆ é™¤äº† `customer_service_tasks.py` ä¸­çš„é‡å¤å®šä¹‰
- ç»Ÿä¸€ä½¿ç”¨ `celery_tasks.py` ä¸­çš„å®šä¹‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `backend/app/customer_service_tasks.py`

### 3. é”™è¯¯å¤„ç†ä¸å®Œå–„

**é—®é¢˜æè¿°**ï¼š
- éƒ¨åˆ†ä»»åŠ¡ç¼ºå°‘é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- é‡è¯•æœºåˆ¶æœªå®ç°

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¸ºæ‰€æœ‰ä»»åŠ¡æ·»åŠ äº† `bind=True`ï¼Œæ”¯æŒé‡è¯•æœºåˆ¶
- æ·»åŠ äº†å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- é…ç½®äº†åˆç†çš„é‡è¯•å‚æ•°

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `backend/app/celery_tasks.py`
- `backend/app/customer_service_tasks.py`
- `backend/app/celery_app.py`

### 4. æ—¶é—´æ£€æŸ¥å†—ä½™

**é—®é¢˜æè¿°**ï¼š
- `cleanup_long_inactive_chats_task` å’Œ `update_featured_task_experts_response_time_task` å†…éƒ¨æœ‰æ—¶é—´æ£€æŸ¥
- Celery Beat çš„ crontab å·²ç»å¤„ç†äº†æ—¶é—´è°ƒåº¦ï¼Œå†…éƒ¨æ£€æŸ¥æ˜¯å†—ä½™çš„

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ç§»é™¤äº†ä»»åŠ¡å†…éƒ¨çš„æ—¶é—´æ£€æŸ¥
- æ·»åŠ äº†æ³¨é‡Šè¯´æ˜æ—¶é—´æ£€æŸ¥ç”± Celery Beat çš„ crontab å®Œæˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `backend/app/celery_tasks.py`

## ğŸ” ä»£ç è´¨é‡è¯„ä¼°

### ä¼˜ç§€æ–¹é¢

1. **æ•°æ®åº“ä¼šè¯ç®¡ç†**
   - âœ… æ¯ä¸ªä»»åŠ¡æ­£ç¡®åˆ›å»ºå’Œå…³é—­æ•°æ®åº“ä¼šè¯
   - âœ… ä½¿ç”¨ try-finally ç¡®ä¿èµ„æºæ¸…ç†
   - âœ… é”™è¯¯æ—¶æ­£ç¡® rollback

2. **ä»»åŠ¡è°ƒåº¦é…ç½®**
   - âœ… æ‰€æœ‰ä»»åŠ¡éƒ½æ­£ç¡®é…ç½®åœ¨ `beat_schedule` ä¸­
   - âœ… ä»»åŠ¡åç§°å”¯ä¸€ä¸”è§„èŒƒ
   - âœ… è°ƒåº¦é¢‘ç‡åˆç†

3. **é”™è¯¯å¤„ç†å’Œæ—¥å¿—**
   - âœ… æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
   - âœ… ä½¿ç”¨ `exc_info=True` è®°å½•å®Œæ•´å †æ ˆä¿¡æ¯
   - âœ… é‡è¯•æ—¶è®°å½•é‡è¯•æ¬¡æ•°

4. **èµ„æºæ¸…ç†**
   - âœ… `shutdown_event` ä¸­æ­£ç¡®å…³é—­ Celery Worker
   - âœ… æ•°æ®åº“è¿æ¥æ± æ­£ç¡®å…³é—­
   - âœ… WebSocket è¿æ¥æ­£ç¡®å…³é—­

### æ”¹è¿›å»ºè®®

1. **ä»»åŠ¡ä¼˜å…ˆçº§**ï¼ˆå¯é€‰ï¼‰
   - å½“å‰æœªé…ç½®ä»»åŠ¡ä¼˜å…ˆçº§
   - å»ºè®®ï¼šä¸ºç´§æ€¥ä»»åŠ¡ï¼ˆå¦‚å®¢æœé˜Ÿåˆ—å¤„ç†ï¼‰è®¾ç½®æ›´é«˜ä¼˜å…ˆçº§
   - å®ç°æ–¹å¼ï¼šåœ¨ `celery_app.py` ä¸­æ·»åŠ  `task_routes` é…ç½®

2. **ä»»åŠ¡è·¯ç”±**ï¼ˆå¯é€‰ï¼‰
   - å½“å‰æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨é»˜è®¤è·¯ç”±
   - å»ºè®®ï¼šå¦‚æœéœ€è¦åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¯ä»¥é…ç½®ä»»åŠ¡è·¯ç”±
   - å®ç°æ–¹å¼ï¼šåœ¨ `celery_app.py` ä¸­æ·»åŠ  `task_routes` é…ç½®

3. **ç›‘æ§å’Œå‘Šè­¦**ï¼ˆå¯é€‰ï¼‰
   - å½“å‰åªæœ‰æ—¥å¿—è®°å½•
   - å»ºè®®ï¼šé›†æˆ Prometheus æŒ‡æ ‡ï¼ˆå·²åœ¨ `metrics.py` ä¸­å®šä¹‰ï¼‰
   - å®ç°æ–¹å¼ï¼šåœ¨ä»»åŠ¡æ‰§è¡Œå‰åè®°å½•æŒ‡æ ‡

## ğŸ“Š ä»»åŠ¡åˆ—è¡¨å’Œé…ç½®

### é«˜é¢‘ä»»åŠ¡ï¼ˆ30ç§’-1åˆ†é’Ÿï¼‰

| ä»»åŠ¡åç§° | é¢‘ç‡ | é‡è¯•æ¬¡æ•° | é‡è¯•å»¶è¿Ÿ | çŠ¶æ€ |
|---------|------|---------|---------|------|
| `process-customer-service-queue` | 30ç§’ | 3æ¬¡ | 30ç§’ | âœ… |
| `auto-end-timeout-chats` | 30ç§’ | 3æ¬¡ | 30ç§’ | âœ… |
| `send-timeout-warnings` | 30ç§’ | 3æ¬¡ | 30ç§’ | âœ… |
| `cancel-expired-tasks` | 1åˆ†é’Ÿ | 3æ¬¡ | 60ç§’ | âœ… |

### ä¸­é¢‘ä»»åŠ¡ï¼ˆ5åˆ†é’Ÿï¼‰

| ä»»åŠ¡åç§° | é¢‘ç‡ | é‡è¯•æ¬¡æ•° | é‡è¯•å»¶è¿Ÿ | çŠ¶æ€ |
|---------|------|---------|---------|------|
| `check-expired-coupons` | 5åˆ†é’Ÿ | 3æ¬¡ | 60ç§’ | âœ… |
| `check-expired-invitation-codes` | 5åˆ†é’Ÿ | 3æ¬¡ | 60ç§’ | âœ… |
| `check-expired-points` | 5åˆ†é’Ÿ | 3æ¬¡ | 60ç§’ | âœ… |
| `check-and-end-activities` | 5åˆ†é’Ÿ | 2æ¬¡ | 120ç§’ | âœ… |

### ä½é¢‘ä»»åŠ¡ï¼ˆ10åˆ†é’Ÿï¼‰

| ä»»åŠ¡åç§° | é¢‘ç‡ | é‡è¯•æ¬¡æ•° | é‡è¯•å»¶è¿Ÿ | çŠ¶æ€ |
|---------|------|---------|---------|------|
| `update-all-users-statistics` | 10åˆ†é’Ÿ | 2æ¬¡ | 300ç§’ | âœ… |

### æ¯æ—¥ä»»åŠ¡

| ä»»åŠ¡åç§° | æ‰§è¡Œæ—¶é—´ | é‡è¯•æ¬¡æ•° | é‡è¯•å»¶è¿Ÿ | çŠ¶æ€ |
|---------|---------|---------|---------|------|
| `cleanup-long-inactive-chats` | æ¯å¤©å‡Œæ™¨2ç‚¹ | 2æ¬¡ | 300ç§’ | âœ… |
| `update-featured-task-experts-response-time` | æ¯å¤©å‡Œæ™¨3ç‚¹ | 2æ¬¡ | 300ç§’ | âœ… |
## ğŸ”§ Celery é…ç½®

### æ ¸å¿ƒé…ç½®

```python
task_serializer='json'
accept_content=['json']
result_serializer='json'
timezone='UTC'
enable_utc=True
task_track_started=True
task_time_limit=30 * 60  # 30åˆ†é’Ÿè¶…æ—¶
task_soft_time_limit=25 * 60  # 25åˆ†é’Ÿè½¯è¶…æ—¶
worker_prefetch_multiplier=1
worker_max_tasks_per_child=1000
task_acks_late=True  # ä»»åŠ¡å®Œæˆåæ‰ç¡®è®¤ï¼Œé˜²æ­¢ä»»åŠ¡ä¸¢å¤±
task_reject_on_worker_lost=True  # Worker ä¸¢å¤±æ—¶æ‹’ç»ä»»åŠ¡
task_default_retry_delay=60  # é»˜è®¤é‡è¯•å»¶è¿Ÿ60ç§’
task_max_retries=3  # é»˜è®¤æœ€å¤§é‡è¯•3æ¬¡
```

### å›é€€æœºåˆ¶

- âœ… å¦‚æœ Redis ä¸å¯ç”¨ï¼Œè‡ªåŠ¨å›é€€åˆ° TaskScheduler
- âœ… å¦‚æœ Celery æœªå®‰è£…ï¼Œè‡ªåŠ¨å›é€€åˆ° TaskScheduler
- âœ… å›é€€è¿‡ç¨‹å¯¹ç”¨æˆ·é€æ˜

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ•°æ®åº“ä¼šè¯ç®¡ç†

```python
db = SessionLocal()
try:
    # æ‰§è¡Œä»»åŠ¡é€»è¾‘
    result = task_function(db)
    return result
except Exception as e:
    logger.error(f"ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {e}", exc_info=True)
    try:
        db.rollback()
    except Exception:
        pass  # å¦‚æœå·²ç» commit æˆ–è¿æ¥å·²å…³é—­ï¼Œå¿½ç•¥ rollback é”™è¯¯
    raise
finally:
    db.close()
```

### 2. ä»»åŠ¡é‡è¯•æœºåˆ¶

```python
@celery_app.task(
    name='app.celery_tasks.my_task',
    bind=True,
    max_retries=3,
    default_retry_delay=60
)
def my_task(self):
    try:
        # ä»»åŠ¡é€»è¾‘
        return {"status": "success"}
    except Exception as e:
        if self.request.retries < self.max_retries:
            logger.info(f"ä»»åŠ¡å°†é‡è¯• ({self.request.retries + 1}/{self.max_retries})")
            raise self.retry(exc=e)
        raise
```

### 3. é”™è¯¯å¤„ç†

- âœ… æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰ try-except å—
- âœ… è®°å½•å®Œæ•´çš„é”™è¯¯å †æ ˆä¿¡æ¯
- âœ… åœ¨é€‚å½“çš„æ—¶å€™è¿›è¡Œ rollback
- âœ… é‡è¯•æœºåˆ¶å¤„ç†ä¸´æ—¶é”™è¯¯

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒ

1. **Redis é…ç½®**
   - ä½¿ç”¨ Redis Sentinel æˆ– Redis Cluster æé«˜å¯ç”¨æ€§
   - é…ç½® Redis æŒä¹…åŒ–ï¼ˆAOF + RDBï¼‰
   - ç›‘æ§ Redis å†…å­˜ä½¿ç”¨

2. **Celery Worker**
   - ä½¿ç”¨å¤šä¸ª Worker è¿›ç¨‹ï¼ˆ`--concurrency`ï¼‰
   - é…ç½® Worker è‡ªåŠ¨é‡å¯ï¼ˆ`--max-tasks-per-child`ï¼‰
   - ç›‘æ§ Worker å¥åº·çŠ¶æ€

3. **Celery Beat**
   - ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼ˆé¿å…å¤šä¸ª Beat å®ä¾‹ï¼‰
   - é…ç½® Beat è°ƒåº¦æ•°æ®åº“æŒä¹…åŒ–
   - ç›‘æ§ Beat è°ƒåº¦çŠ¶æ€

4. **ç›‘æ§å’Œå‘Šè­¦**
   - é›†æˆ Prometheus æŒ‡æ ‡
   - é…ç½®ä»»åŠ¡å¤±è´¥å‘Šè­¦
   - ç›‘æ§ä»»åŠ¡æ‰§è¡Œæ—¶é—´

## âœ… æ€»ç»“

Celery å®ç°è´¨é‡**ä¼˜ç§€**ï¼Œä¸»è¦åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼š

- âœ… ä»»åŠ¡å®šä¹‰å®Œæ•´ä¸”æ­£ç¡®
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… é‡è¯•æœºåˆ¶å·²æ·»åŠ 
- âœ… èµ„æºæ¸…ç†æ­£ç¡®
- âœ… é…ç½®åˆç†
- âœ… äº‹åŠ¡ç®¡ç†ç»Ÿä¸€

ä»£ç å·²é€šè¿‡ lint æ£€æŸ¥ï¼Œå¯ä»¥å®‰å…¨æŠ•å…¥ä½¿ç”¨ã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Celery è®¾ç½®æŒ‡å—](./CELERY_SETUP_GUIDE.md)
- [æ—¥å¿—åˆ†æä¸ä¼˜åŒ–æ–‡æ¡£](./LOG_ANALYSIS_AND_OPTIMIZATION.md)

